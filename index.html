<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delente ERP - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</title>
    <!-- Global Error Handler for Mobile Debugging -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            try {
                const fullMsg = msg + '\n\nFile: ' + url + '\nLine: ' + line + ':' + col;
                const errorText = (error && error.stack) ? error.stack : fullMsg;
                
                // Show alert with error details
                alert('ğŸš¨ Mobile Error Detected:\n\n' + fullMsg + '\n\n' + (error && error.stack ? error.stack.substring(0, 200) : ''));
                
                // Replace page with error display
                document.body.innerHTML = '<div style="color:red; background:white; font-size:18px; padding:20px; font-family:monospace; white-space:pre-wrap; direction:ltr; text-align:left;"><strong>âš ï¸ ERROR DETECTED:</strong>\n\n' + fullMsg + '\n\n<strong>Stack:</strong>\n' + (error && error.stack ? error.stack : 'No stack trace') + '</div>';
                document.body.style.margin = '0';
                document.body.style.height = '100vh';
            } catch(e) {
                document.body.innerHTML = '<div style="color:red; background:white; padding:20px;">Critical Error Handler Failed</div>';
            }
            return true; // Suppress default error handling
        };
    </script>
    <style id="fallback-hidden-css">
        /* Fallback: ensure elements with class 'hidden' are actually hidden
           even if Tailwind fails to load on some devices/browsers */
        .hidden { display: none !important; }
    </style>
    <script>
                // Ø³Ø§Ø¹Ø© Ø±Ù‚Ù…ÙŠØ© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ØªØ¸Ù‡Ø± ÙÙŠ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                function updateGlobalClock() {
                    const clockEl = document.getElementById('global-clock-time');
                    if (!clockEl) return;
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const dateStr = now.toLocaleDateString('ar-EG');
                    clockEl.textContent = `${dateStr} - ${timeStr}`;
                }
                setInterval(updateGlobalClock, 1000);
                document.addEventListener('DOMContentLoaded', updateGlobalClock);
                // raw/pack grids
                document.addEventListener('DOMContentLoaded', function(){
                    try {
                        window._rawGridState = JSON.parse(localStorage.getItem('raw_materials_grid') || '{}');
                    } catch(e){ window._rawGridState = {}; }
                    try {
                        window._packGridState = JSON.parse(localStorage.getItem('packaging_grid') || '{}');
                    } catch(e){ window._packGridState = {}; }
                    console.debug('Loaded State:', { raw: window._rawGridState, pack: window._packGridState });
                    if (!window.saveRawGridStateNow){
                        window.saveRawGridStateNow = async function(){ try { localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState || {})); } catch(e){} try { if (window.db) await db.collection('settings').doc('costLists').set({ rawMaterials: window._rawGridState, updatedAt: serverTs() }, { merge:true }); } catch(e){} };
                        window.debouncedRawSave = function(){ clearTimeout(window._rawGridSaveTimer); window._rawGridSaveTimer = setTimeout(window.saveRawGridStateNow, 700); };
                        window.savePackGridStateNow = async function(){ try { localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState || {})); } catch(e){} try { if (window.db) await db.collection('settings').doc('costLists').set({ packaging: window._packGridState, updatedAt: serverTs() }, { merge:true }); } catch(e){} };
                        window.debouncedPackSave = function(){ clearTimeout(window._packGridSaveTimer); window._packGridSaveTimer = setTimeout(window.savePackGridStateNow, 700); };
                    }
                });
        window.addEventListener('load', function() {
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
            }
            var dashboard = document.getElementById('page-dashboard');
            if (dashboard) dashboard.classList.add('active');
            var navItems = document.getElementsByClassName('bottom-nav-item');
            for (var j = 0; j < navItems.length; j++) {
                navItems[j].classList.remove('active');
                if (navItems[j].getAttribute('data-page') === 'dashboard') {
                    navItems[j].classList.add('active');
                }
            }
        });
    </script>
        <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas for converting receipts to images for thermal printers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Note: Using the Tailwind CDN is fine for development only. For production install Tailwind as a PostCSS plugin
         or use the Tailwind CLI per https://tailwindcss.com/docs/installation -->
    <script>
        // Safe fallback for updateIcons to avoid ReferenceError if other scripts call it before icon library loads.
        // If you use Lucide or a similar icon replacer, it will call its replace/scan method when available.
        window.updateIcons = (function(){
            let scheduled = false;
            return function(){
                if (scheduled) return; // debounce rapid calls
                scheduled = true;
                requestAnimationFrame(() => {
                    try {
                        if (window.lucide && typeof window.lucide.replace === 'function') {
                            window.lucide.replace();
                        } else if (window.Lucide && typeof window.Lucide.replace === 'function') {
                            window.Lucide.replace();
                        }
                    } catch(e) { /* silent */ }
                    scheduled = false;
                });
            };
        })();

        
    </script>
    <script>
        // Global safe guards to prevent early crashes
        // ===== Render Scheduler (performance) =====
        (function(){
            const scheduled = new Map();
            const lastRun = new Map();
            const MIN_INTERVAL = 80; // ms between same-key renders
            function runTask(key, fn){
                scheduled.delete(key);
                try {
                    const start = performance.now();
                    fn();
                    lastRun.set(key, start);
                } catch(e){ console.warn('render task failed', key, e); }
            }
            window.scheduleRender = function(key, fn){
                try {
                    if (typeof key !== 'string') key = 'anon';
                    const now = performance.now();
                    const prev = lastRun.get(key) || 0;
                    if (scheduled.has(key)) return; // already queued
                    if ((now - prev) < MIN_INTERVAL) { // defer a bit more to batch
                        const handle = setTimeout(()=>{ scheduled.delete(key); window.requestIdleCallback ? requestIdleCallback(()=>runTask(key, fn), { timeout: 300 }) : requestAnimationFrame(()=>runTask(key, fn)); }, MIN_INTERVAL);
                        scheduled.set(key, handle);
                        return;
                    }
                    const handle = window.requestIdleCallback ? requestIdleCallback(()=>runTask(key, fn), { timeout: 300 }) : requestAnimationFrame(()=>runTask(key, fn));
                    scheduled.set(key, handle);
                } catch(e){ try { fn(); } catch(_){} }
            };
        })();
        (function(){
            try { window.state = window.state || {}; } catch(e) { window.state = {}; }
            if (typeof window.formatCurrency !== 'function') {
                window.formatCurrency = function(n){ try { return new Intl.NumberFormat('ar-EG',{style:'currency',currency:'EGP',maximumFractionDigits:2}).format(Number(n||0)); } catch(e){ return (Number(n||0)).toFixed(2)+' Ø¬.Ù…'; } };
            }
            if (typeof window.findCustomer !== 'function') {
                window.findCustomer = function(id){ try { return (state.customers||[]).find(c => (c.id||c._id) === id) || null; } catch(e){ return null; } };
            }
            if (typeof window.updateCustomerList !== 'function') {
                window.updateCustomerList = function(){ /* noop safety */ };
            }
            if (typeof window.DEFAULT_PRODUCTS === 'undefined') {
                window.DEFAULT_PRODUCTS = [];
            }
            // Default company logo URL (used when no custom URL is saved)
            if (typeof window.DEFAULT_COMPANY_LOGO_URL === 'undefined') {
                window.DEFAULT_COMPANY_LOGO_URL = 'https://i.ibb.co/YT4114YW/image.jpg';
            }
        })();
    </script>
    <!-- Library to convert HTML to Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- NEW: Include Chart.js library for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Lucide Icons (before other scripts) -->

    <!-- Global error overlay to surface runtime issues to the user -->
    <script>
        (function(){
            function showOverlay(msg, stack){
                try {
                    var ov = document.getElementById('error-overlay');
                    if (!ov) {
                        ov = document.createElement('div');
                        ov.id = 'error-overlay';
                        ov.style.position = 'fixed';
                        ov.style.top = '0';
                        ov.style.left = '0';
                        ov.style.right = '0';
                        ov.style.zIndex = '99999';
                        ov.style.background = 'rgba(220,38,38,0.95)';
                        ov.style.color = '#fff';
                        ov.style.fontFamily = 'Cairo, sans-serif';
                        ov.style.direction = 'rtl';
                        ov.style.padding = '8px 12px';
                        ov.style.fontSize = '12px';
                        ov.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">'
                                     + '<div><strong>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:</strong> <span id="err-msg"></span><div id="err-stack" style="white-space:pre-wrap;opacity:.9;margin-top:4px"></div></div>'
                                     + '<button id="err-close" style="background:#111;border:0;color:#fff;padding:6px 10px;border-radius:6px">Ø¥ØºÙ„Ø§Ù‚</button>'
                                     + '</div>';
                        document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(ov); });
                        if (document.readyState === 'complete' || document.readyState === 'interactive') { try { document.body.appendChild(ov); } catch(_){} }
                        document.addEventListener('click', function(e){ if (e.target && e.target.id === 'err-close'){ try { ov.remove(); } catch(_){} } });
                    }
                    var m = ov.querySelector('#err-msg'); if (m) m.textContent = msg || '';
                    var s = ov.querySelector('#err-stack'); if (s) s.textContent = stack || '';
                } catch(e){}
            }
            window.addEventListener('error', function(e){
                try {
                    showOverlay(String(e && e.message) || 'Runtime error', (e && e.error && e.error.stack) || e.stack || '');
                } catch(_){}
            });

        // ===== Bluetooth printer helpers (robust connect + per-invoice print) =====
        (function(){
            // Known UUIDs for XPrinter and generic ESC/POS
            const PRINTER_CONFIG = {
                services: [
                    '000018f0-0000-1000-8000-00805f9b34fb',
                    'e7810a71-73ae-499d-8c15-faa9aef0c3f2',
                    '49535343-fe7d-4ae5-8fa9-9fafd205e455'
                ],
                characteristics: [
                    '00002af1-0000-1000-8000-00805f9b34fb',
                    'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f',
                    '49535343-8841-43f4-a8d4-ecbe34729bb3'
                ]
            };
            window.printDevice = null;
            window.printCharacteristic = null;

            window.connectToPrinter = async function(){
                try {
                    if (!('bluetooth' in navigator)) throw new Error('Web Bluetooth not supported in this browser');
                    console.log('Searching for XPrinter...');
                    const device = await navigator.bluetooth.requestDevice({ filters: [{ services: PRINTER_CONFIG.services }], optionalServices: PRINTER_CONFIG.services });
                    const server = await device.gatt.connect();
                    console.log('Connected to GATT');

                    // Find a service that exists on the device
                    let service = null;
                    for (const uuid of PRINTER_CONFIG.services){
                        try { service = await server.getPrimaryService(uuid); console.log('Found Service:', uuid); break; } catch(e) { /* continue */ }
                    }
                    if (!service) throw new Error('No matching service found.');

                    // Try known characteristic UUIDs first
                    let char = null;
                    try {
                        for (const uuid of PRINTER_CONFIG.characteristics){
                            try { char = await service.getCharacteristic(uuid); if (char) break; } catch(e) {}
                        }
                    } catch(e){ /* ignore */ }

                    // If still not found, inspect any characteristic and pick a writable one
                    if (!char){
                        const potentialChars = await service.getCharacteristics();
                        char = potentialChars.find(c => c.properties && (c.properties.write || c.properties.writeWithoutResponse));
                    }

                    if (!char) throw new Error('Write Characteristic NOT found!');

                    window.printCharacteristic = char;
                    window.printDevice = device;
                    alert('âœ… Connected to XPrinter successfully!');
                    return { device, characteristic: char };
                } catch (error){
                    console.error('connectToPrinter failed', error);
                    throw error;
                }
            };

            window.printInvoiceBluetooth = async function(sale){
                try {
                    if (!sale) { alert('Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
                    // Build payload using existing helper if present
                    const payload = (typeof buildEscPosReceipt === 'function') ? buildEscPosReceipt(sale) : (function(){
                        // fallback simple text
                        const enc = new TextEncoder();
                        return enc.encode('Invoice #'+(sale.invoiceNumber||sale.id)+'\nTotal: '+(sale.total||0)+'\n');
                    })();

                    if (!window.printCharacteristic){
                        try { await window.connectToPrinter(); } catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©: '+(e&&e.message)); return; }
                    }

                    const char = window.printCharacteristic;
                    if (!char) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø§ØµÙŠØ© ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø©'); return; }

                    // Write in chunks
                    const CHUNK = 180; // larger chunk for modern devices
                    for (let i=0;i<payload.length;i+=CHUNK){
                        const slice = payload.slice(i, i+CHUNK);
                        try {
                            if (char.properties.writeWithoutResponse) await char.writeValueWithoutResponse(slice);
                            else await char.writeValue(slice);
                        } catch(e){
                            // try writeValue as fallback
                            try { await char.writeValue(slice); } catch(er){ throw er; }
                        }
                        await new Promise(r=>setTimeout(r, 30));
                    }
                    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«.');
                } catch(e){ console.error('printInvoiceBluetooth failed', e); alert('ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«: '+(e&&e.message)); }
            };
        })();
            window.addEventListener('unhandledrejection', function(e){
                try {
                    var reason = e && e.reason; var msg = '';
                    if (typeof reason === 'string') msg = reason; else if (reason && reason.message) msg = reason.message; else msg = 'Unhandled rejection';
                    var stack = reason && reason.stack ? reason.stack : '';
                    showOverlay(msg, stack);
                } catch(_){}
            });
        })();
    </script>

    <!-- Leaflet for interactive maps (CDN) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

        <!-- ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (shared/public_app_state) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ -->

        <!-- Firebase SDK (compat build for simple global usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

        <!-- Firebase Config injected from user-provided settings (modular snippet adapted) -->
        <script>
            window.FIREBASE_CONFIG = {
                apiKey: "AIzaSyDLmZPE9teCYf2rMXd1AwT5yq4xlRSHcSk",
                authDomain: "delente-business.firebaseapp.com",
                projectId: "delente-business",
                // âœ… ØªØµØ­ÙŠØ­ Ø§Ø³Ù… Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ®Ø²ÙŠÙ†: Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØµØ­ÙŠØ­ ÙŠÙƒÙˆÙ† <project-id>.appspot.com
                // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© "delente-business.firebasestorage.app" ØªØ³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ CORS ÙˆØ±ÙØ¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
                storageBucket: "delente-business.appspot.com",
                messagingSenderId: "646706509650",
                appId: "1:646706509650:web:1eaa4b94d2990b6be9ac8b"
            };
        </script>

    <!-- Firebase Configuration & Authentication System -->
    <script>
        // Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Firebase
        // (Firebase Config Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù - DOMContentLoaded)
        const AuthSystem = {
            // Ù…ÙØªØ§Ø­ ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            USERS_KEY: 'app_users',
            CURRENT_USER_KEY: 'app_current_user',
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
            getAllUsers() {
                try {
                    const data = localStorage.getItem(this.USERS_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.warn('Error loading users:', e);
                    return [];
                }
            },
            
            // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            saveUsers(users) {
                try {
                    localStorage.setItem(this.USERS_KEY, JSON.stringify(users));
                } catch (e) {
                    console.error('Error saving users:', e);
                }
            },
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            findUserByEmail(email) {
                const users = this.getAllUsers();
                return users.find(u => u.email === email.toLowerCase());
            },
            
            // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯)
            async register(email, password, name) {
                if (!window.auth) return { success: false, message: 'Firebase Auth ØºÙŠØ± Ø¬Ø§Ù‡Ø²' };
                try {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    try { await cred.user.updateProfile({ displayName: name }); } catch(e) {}
                    try {
                        if (window.db) {
                            await db.collection('users').doc(cred.user.uid).set({
                                email: email.toLowerCase(),
                                name: name,
                                createdAt: new Date().toISOString()
                            }, { merge: true });
                        }
                    } catch(e) { console.warn('ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ Ø­ÙØ¸ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore', e); }
                    const newUser = { id: cred.user.uid, email: email.toLowerCase(), name, firebase: true, createdAt: new Date().toISOString(), data: {} };
                    this.setCurrentUser(newUser);
                    return { success: true, message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', user: newUser };
                } catch (err) {
                    let msg = 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                    if (err.code === 'auth/email-already-in-use') msg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
                    else if (err.code === 'auth/weak-password') msg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©';
                    else if (err.code === 'auth/invalid-email') msg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­';
                    return { success: false, message: msg };
                }
            },
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            async login(email, password) {
                if (!window.auth) return { success: false, message: 'Firebase Auth ØºÙŠØ± Ø¬Ø§Ù‡Ø²' };
                try {
                    const cred = await auth.signInWithEmailAndPassword(email, password);
                    const displayName = cred.user.displayName || (cred.user.email ? cred.user.email.split('@')[0] : 'Ù…Ø³ØªØ®Ø¯Ù…');
                    const currentUser = { id: cred.user.uid, email: cred.user.email.toLowerCase(), name: displayName, firebase: true, data: {} };
                    this.setCurrentUser(currentUser);
                    return { success: true, message: 'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', user: currentUser };
                } catch (err) {
                    let msg = 'ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                    if (err.code === 'auth/wrong-password') msg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                    else if (err.code === 'auth/user-not-found') msg = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                    else if (err.code === 'auth/invalid-email') msg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­';
                    else if (err.code === 'auth/too-many-requests') msg = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹';
                    return { success: false, message: msg };
                }
            },
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            setCurrentUser(user) {
                try {
                    localStorage.setItem(this.CURRENT_USER_KEY, JSON.stringify(user));
                } catch (e) {
                    console.error('Error saving current user:', e);
                }
            },
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            getCurrentUser() {
                try {
                    const data = localStorage.getItem(this.CURRENT_USER_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.warn('Error loading current user:', e);
                    return null;
                }
            },
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            logout() {
                try {
                    localStorage.removeItem(this.CURRENT_USER_KEY);
                } catch (e) {
                    console.error('Error logging out:', e);
                }
            },
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateUserData(userId, newData) {
                const users = this.getAllUsers();
                const user = users.find(u => u.id === userId);
                
                if (!user) return false;
                
                user.data = { ...user.data, ...newData };
                this.saveUsers(users);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯
                const currentUser = this.getCurrentUser();
                if (currentUser && currentUser.id === userId) {
                    this.setCurrentUser(user);
                }
                
                return true;
            }
        };
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ù‡ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (ÙŠØ­ØªØ§Ø¬ Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ ÙŠØ­Ù‚Ù† userRoles Ø¯Ø§Ø®Ù„ state.shared.public_app_state)
        // Ù‚ÙˆØ§Ø¦Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© users Ø¹Ù„Ù‰ Firestore)
        window.FORCED_ADMINS = (window.FORCED_ADMINS || [ 'omarsakr1222@gmail.com', 'yousefsakr1222@gmail.com' ]);
        window.FORCED_REVIEWERS = (window.FORCED_REVIEWERS || [
            'yasserhassan1222@gmail.com',
            'belalhatem1222@gmail.com',
            'mohamedhossein1222@gmail.com'
        ]);
        function getUserRole() {
            try {
                const user = AuthSystem.getCurrentUser();
                if (!user) return 'guest';
                // Ø£ÙˆÙ„ÙˆÙŠØ© 1: Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ± Ù„Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¶Ù…Ù† FORCED_ADMINS
                if (window.FORCED_ADMINS.includes((user.email||'').toLowerCase())) return 'admin';
                // Ø£ÙˆÙ„ÙˆÙŠØ© 2: Ù…Ø±Ø§Ø¬ÙØ¹ Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
                if (window.FORCED_REVIEWERS.includes((user.email||'').toLowerCase())) return 'reviewer';
                // Ø£ÙˆÙ„ÙˆÙŠØ© 3: Ù…Ù† Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© roles
                if (window.__rolesMap && window.__rolesMap[user.id]) return window.__rolesMap[user.id];
                // Ø£ÙˆÙ„ÙˆÙŠØ© 2: Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© users Ø§Ù„ØªÙŠ ÙŠØªÙ… ØªØ²Ø§Ù…Ù†Ù‡Ø§ Ù„Ø­Ø¸ÙŠØ§Ù‹ (Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ø¢Ù†)
                if (window.state && Array.isArray(state.users)) {
                    const byId = state.users.find(u => u._id === user.id);
                    if (byId && byId.role) return byId.role;
                    const byEmail = state.users.find(u => (u.email||'').toLowerCase() === (user.email||'').toLowerCase());
                    if (byEmail && byEmail.role) return byEmail.role;
                }
            } catch(e) { /* ignore */ }
            // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ ÙˆÙ„ÙŠØ³ Ø¶Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø®Ø§ØµØ© ÙŠÙØ¹Ø§Ù…Ù„ ÙƒÙ…Ù†Ø¯ÙˆØ¨
            return 'rep';
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯
        document.addEventListener('DOMContentLoaded', () => {
            if (AuthSystem.getAllUsers().length === 0) {
                AuthSystem.register('test@example.com', 'test123', 'Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ');
            }
        });
    </script>

    <!-- ===== CustomersService: Cache-First Customer Data Management ===== -->
    <script>
        /**
         * CustomersService - Inline Implementation
         * Cache-first customer data loading for offline support
         * CRITICAL: Ensures name, phone, address, balance, id fields exist for legacy code
         */
        window.CustomersService = {
            // Cache the service dependencies once they're ready
            _storageService: null,
            _firestoreService: null,
            _errorHandler: null,

            // Initialize with dependencies (called by firebase-init or manually)
            setDependencies(storageService, firestoreService, errorHandler) {
                window.CustomersService._storageService = storageService;
                window.CustomersService._firestoreService = firestoreService;
                window.CustomersService._errorHandler = errorHandler;
                console.log('âœ“ CustomersService dependencies injected');
            },

            // Map Firestore doc to legacy shape
            mapToLegacy(doc) {
                if (!doc) return null;
                const id = doc.id || doc._id || ('cust_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                
                return {
                    id,
                    name: doc.name || doc.customerName || '',
                    phone: doc.phone || doc.phoneNumber || '', // CRITICAL for search
                    address: doc.address || '',
                    balance: typeof doc.balance === 'number' ? doc.balance : 0,
                    email: doc.email || '',
                    taxNumber: doc.taxNumber || '',
                    category: doc.category || 'normal',
                    notes: doc.notes || '',
                    createdAt: doc.createdAt || null,
                    updatedAt: doc.updatedAt || null,
                    isActive: doc.isActive !== false,
                    ...doc
                };
            },

            // Check if cache is fresh
            isCacheFresh(maxAgeMs) {
                maxAgeMs = maxAgeMs || (6 * 60 * 60 * 1000); // 6 hours default
                const cached = this.readCache();
                if (!cached || !cached.length) return false;
                
                // For inline version, check localStorage directly
                try {
                    const data = localStorage.getItem('CUSTOMERS');
                    if (!data) return false;
                    const parsed = JSON.parse(data);
                    if (!parsed.timestamp) return false;
                    const age = Date.now() - parsed.timestamp;
                    return age < maxAgeMs;
                } catch(e) {
                    return false;
                }
            },

            // Read cache
            readCache() {
                try {
                    const data = localStorage.getItem('CUSTOMERS');
                    if (!data) return [];
                    const parsed = JSON.parse(data);
                    return parsed.data || [];
                } catch(e) {
                    console.warn('CustomersService: Cache read failed:', e);
                    return [];
                }
            },

            // Write cache
            writeCache(customers) {
                try {
                    localStorage.setItem('CUSTOMERS', JSON.stringify({
                        data: customers,
                        timestamp: Date.now()
                    }));
                } catch(e) {
                    console.warn('CustomersService: Cache write failed:', e);
                }
            },

            // Fetch from Firestore
            async fetchFromServer() {
                try {
                    if (!window.db) {
                        console.warn('CustomersService: Firestore not ready');
                        return [];
                    }

                    console.log('CustomersService: Fetching from Firestore...');
                    const snapshot = await window.db.collection('customers')
                        .where('isActive', '==', true)
                        .orderBy('name')
                        .limit(10000)
                        .get();

                    const customers = snapshot.docs
                        .map(doc => window.CustomersService.mapToLegacy(doc.data() ? { id: doc.id, ...doc.data() } : { id: doc.id }))
                        .filter(c => c && c.id);

                    console.log(`CustomersService: Fetched ${customers.length} customers from server`);
                    return customers;
                } catch(e) {
                    console.error('CustomersService: Server fetch failed:', e.message);
                    return [];
                }
            },

            // Main: Get customers with cache-first
            async getCustomers(opts) {
                opts = opts || {};
                const forceRefresh = opts.forceRefresh || false;
                const maxAgeMs = opts.maxAgeMs || (6 * 60 * 60 * 1000);

                try {
                    // Try cache if not forced refresh
                    if (!forceRefresh && this.isCacheFresh(maxAgeMs)) {
                        console.log('CustomersService: Using cached customers');
                        return this.readCache();
                    }

                    // Fetch from server
                    const customers = await this.fetchFromServer();

                    // Write to cache
                    if (Array.isArray(customers) && customers.length > 0) {
                        this.writeCache(customers);
                        return customers;
                    }

                    // Fallback to cache
                    const cached = this.readCache();
                    if (Array.isArray(cached) && cached.length > 0) {
                        console.log('CustomersService: Server returned empty, using cached data');
                        return cached;
                    }

                    return customers; // Empty array
                } catch(e) {
                    console.error('CustomersService: getCustomers failed:', e);
                    // Graceful fallback to cache on error
                    return this.readCache();
                }
            },

            // Clear cache (for testing)
            clearCache() {
                try {
                    localStorage.removeItem('CUSTOMERS');
                } catch(e) {
                    console.warn('CustomersService: Cache clear failed:', e);
                }
            }
        };

        console.log('âœ“ CustomersService defined (inline)');
    </script>

    <!-- ===== SalesService: Sales & Invoices with Offline Queue ===== -->
    <script>
        /**
         * SalesService - Inline Implementation
         * Smart invoice saving with offline queue + auto-sync
         * 
         * KEY FEATURES:
         * - Read: Limited recent sales (50-100 invoices)
         * - Write Online: Direct save to Firestore
         * - Write Offline: Add to pending_invoices queue
         * - Auto-Sync: syncPendingInvoices() when connection restored
         */
        window.SalesService = {
            _storageService: null,
            _firestoreService: null,
            _errorHandler: null,

            setDependencies(storageService, firestoreService, errorHandler) {
                window.SalesService._storageService = storageService;
                window.SalesService._firestoreService = firestoreService;
                window.SalesService._errorHandler = errorHandler;
                console.log('âœ“ SalesService dependencies injected');
            },

            // Map Firestore doc to legacy shape
            mapToLegacy(doc) {
                if (!doc) return null;
                const id = doc.id || doc._id || ('inv_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                
                return {
                    id,
                    invoiceNumber: doc.invoiceNumber || id,
                    customerId: doc.customerId || '',
                    customerName: doc.customerName || '',
                    items: Array.isArray(doc.items) ? doc.items : [],
                    subtotal: typeof doc.subtotal === 'number' ? doc.subtotal : 0,
                    tax: typeof doc.tax === 'number' ? doc.tax : 0,
                    total: typeof doc.total === 'number' ? doc.total : 0,
                    date: doc.date || new Date().toISOString(),
                    period: doc.period || '',
                    userId: doc.userId || '',
                    userName: doc.userName || '',
                    status: doc.status || 'completed',
                    paymentMethod: doc.paymentMethod || 'cash',
                    notes: doc.notes || '',
                    createdAt: doc.createdAt || null,
                    updatedAt: doc.updatedAt || null,
                    ...doc
                };
            },

            // Get recent sales (limited query)
            async getRecentSales(opts) {
                opts = opts || {};
                const limit = opts.limit || 100;
                const forUserId = opts.forUserId || null;
                const cacheKey = forUserId ? ('SALES_USER_' + forUserId) : 'SALES_RECENT';
                
                try {
                    // Try cache first (30 min TTL for sales)
                    const cached = localStorage.getItem(cacheKey);
                    if (cached && !opts.forceRefresh) {
                        const parsed = JSON.parse(cached);
                        if (parsed.timestamp && (Date.now() - parsed.timestamp) < 30 * 60 * 1000) {
                            console.log('SalesService: Using cached recent sales');
                            return parsed.data || [];
                        }
                    }

                    // Fetch from Firestore
                    if (!window.db) {
                        console.warn('SalesService: Firestore not ready, using cache');
                        return cached ? (JSON.parse(cached).data || []) : [];
                    }

                    console.log('SalesService: Fetching recent ' + limit + ' sales...');
                    let query = window.db.collection('sales')
                        .orderBy('createdAt', 'desc')
                        .limit(limit);

                    if (forUserId) {
                        query = query.where('userId', '==', forUserId);
                    }

                    const snapshot = await query.get();
                    const sales = snapshot.docs
                        .map(doc => window.SalesService.mapToLegacy({ id: doc.id, ...doc.data() }))
                        .filter(s => s && s.id);

                    // Cache results
                    localStorage.setItem(cacheKey, JSON.stringify({
                        data: sales,
                        timestamp: Date.now()
                    }));

                    console.log('SalesService: Fetched ' + sales.length + ' sales');
                    return sales;
                } catch (e) {
                    console.error('SalesService: getRecentSales failed:', e);
                    // Fallback to cache
                    const cached = localStorage.getItem(cacheKey);
                    return cached ? (JSON.parse(cached).data || []) : [];
                }
            },

            // CRITICAL: Save invoice with offline queue
            async saveInvoice(invoiceData) {
                try {
                    if (!invoiceData) {
                        throw new Error('Invalid invoice data');
                    }

                    const invoice = {
                        ...invoiceData,
                        createdAt: invoiceData.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    // Try Firestore first if online
                    if (window.db && navigator.onLine !== false) {
                        try {
                            const docId = invoice.id || ('inv_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                            await window.db.collection('sales').doc(docId).set(invoice);
                            console.log('âœ… SalesService: Invoice ' + docId + ' saved to Firestore');
                            return { ok: true, id: docId, queued: false };
                        } catch (serverError) {
                            console.warn('SalesService: Firestore save failed, queuing:', serverError.message);
                            // Fall through to queue
                        }
                    }

                    // Add to queue
                    console.log('SalesService: Adding invoice to offline queue');
                    const queueId = this.addToQueue(invoice);
                    return { ok: true, id: queueId, queued: true, message: 'Queued for sync' };
                } catch (e) {
                    console.error('SalesService: saveInvoice failed:', e);
                    return { ok: false, error: e.message };
                }
            },

            // Add to pending queue
            addToQueue(invoice) {
                const queue = this.getPendingQueue();
                const queueId = invoice.id || ('inv_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                
                queue.push({
                    ...invoice,
                    id: queueId,
                    _queuedAt: Date.now()
                });

                localStorage.setItem('pending_invoices', JSON.stringify(queue));
                console.log('SalesService: Invoice ' + queueId + ' queued (' + queue.length + ' pending)');
                return queueId;
            },

            // Get pending queue
            getPendingQueue() {
                try {
                    const data = localStorage.getItem('pending_invoices');
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    return [];
                }
            },

            // Get pending count
            getPendingCount() {
                return this.getPendingQueue().length;
            },

            // Sync pending invoices
            async syncPendingInvoices() {
                const queue = this.getPendingQueue();
                
                if (queue.length === 0) {
                    console.log('SalesService: No pending invoices');
                    return { synced: 0, failed: 0, errors: [] };
                }

                console.log('SalesService: Syncing ' + queue.length + ' pending invoices...');
                
                const results = { synced: 0, failed: 0, errors: [] };
                const remaining = [];

                for (let i = 0; i < queue.length; i++) {
                    const invoice = queue[i];
                    try {
                        if (!window.db) {
                            throw new Error('Firestore not available');
                        }

                        // Clean queue metadata
                        const clean = { ...invoice };
                        delete clean._queuedAt;
                        delete clean._localTimestamp;

                        await window.db.collection('sales').doc(invoice.id).set(clean);
                        console.log('âœ… Synced invoice ' + invoice.id);
                        results.synced++;
                    } catch (e) {
                        console.error('âŒ Failed to sync ' + invoice.id + ':', e.message);
                        results.failed++;
                        results.errors.push({ id: invoice.id, error: e.message });
                        remaining.push(invoice);
                    }
                }

                // Update queue
                localStorage.setItem('pending_invoices', JSON.stringify(remaining));
                console.log('SalesService: Sync complete - ' + results.synced + ' synced, ' + results.failed + ' failed');
                return results;
            },

            // Clear queue
            clearQueue() {
                localStorage.removeItem('pending_invoices');
                console.log('SalesService: Queue cleared');
            }
        };

        console.log('âœ“ SalesService defined (inline)');
        
        // Auto-sync on connection restore
        if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
            window.addEventListener('online', function() {
                console.log('ğŸŒ Connection restored - auto-syncing pending invoices...');
                setTimeout(function() {
                    if (window.SalesService && typeof window.SalesService.syncPendingInvoices === 'function') {
                        window.SalesService.syncPendingInvoices().then(function(result) {
                            if (result.synced > 0) {
                                console.log('âœ… Auto-sync: ' + result.synced + ' invoices synced');
                                try {
                                    if (typeof customDialog === 'function') {
                                        customDialog({
                                            title: 'ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©',
                                            message: 'ØªÙ… Ø±ÙØ¹ ' + result.synced + ' ÙØ§ØªÙˆØ±Ø© Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­'
                                        });
                                    } else {
                                        alert('ØªÙ… Ø±ÙØ¹ ' + result.synced + ' ÙØ§ØªÙˆØ±Ø© Ù…Ø¹Ù„Ù‚Ø©');
                                    }
                                } catch(e) {}
                            }
                        }).catch(function(e) {
                            console.error('Auto-sync failed:', e);
                        });
                    }
                }, 2000); // Wait 2s after connection restore
            });
        }
    </script>

    <!-- Firebase initialization + sync helpers -->
    <script>
        /**
         * Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù…Ù’ Ø£Ø¶Ø¹ Ù‡Ù†Ø§ Ø£ÙŠ firebaseConfig Ù…ÙØ¯Ù…Ø¬ â€” Ø§Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø§Ù„ÙƒÙˆØ¯.
         * Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Firebase Ø¬Ø¯ÙŠØ¯ Ø¶Ø¹ ØªÙƒÙˆÙŠÙ† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŒ
         * Ù…Ø«Ù„Ø§Ù‹ ÙÙŠ Ù…Ù„Ù Ù…Ù†ÙØµÙ„ Ø£Ùˆ Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© HTML Ù‚Ø¨Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª:
         *
         * <script> (example) â€” if you include this inline, escape the closing tag like `<\/script>`
         *   window.firebaseConfig = {
         *     apiKey: "...",
         *     authDomain: "...",
         *     projectId: "...",
         *     storageBucket: "...",
         *     messagingSenderId: "...",
         *     appId: "..."
         *   };
         *
         * Ù‡Ø°Ø§ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù…Ù„Ù Ù†Ø¸ÙŠÙØ§Ù‹ Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙˆØ³ÙŠØ¨Ù‚Ù‰ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„ÙƒÙˆÙ†ÙØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø³ØªÙˆÙÙ‘Ø±Ù‡.
         */

        // If you want to embed the config for local use, provide it here.
        // For safety this only assigns when no config already exists on the page.
        try {
            if (!window.firebaseConfig && window.FIREBASE_CONFIG) {
                window.firebaseConfig = window.FIREBASE_CONFIG;
            }
        } catch(e) { /* ignore */ }

        // If you want me to embed the config you pasted, it will be applied
        // below only if no other `window.firebaseConfig` is present.
        if (!window.firebaseConfig) {
            window.firebaseConfig = {
                apiKey: "AIzaSyDLmZPE9teCYf2rMXd1AwT5yq4xlRSHcSk",
                authDomain: "delente-business.firebaseapp.com",
                projectId: "delente-business",
                // âœ… FIX: ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ù„ØªÙØ§Ø¯ÙŠ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙˆØµÙˆÙ„
                storageBucket: "delente-business.appspot.com",
                messagingSenderId: "646706509650",
                appId: "1:646706509650:web:1eaa4b94d2990b6be9ac8b"
            };
            // NOTE: This embeds your Firebase config into the local file. It's
            // safe for local use but if this file will be public, consider
            // removing the literal config and instead set `window.FIREBASE_CONFIG`
            // at runtime or restrict your API key in the Firebase console.
        }

        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ·ÙˆÙŠØ± Ù„ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø¬Ù…ÙŠØ¹
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ø¹Ø¯Ù‡Ø§ Ø¥Ù„Ù‰ false Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ù„Ùˆ Ø£Ø±Ø¯Øª Ù…Ù†Ø¹ Ø§Ù„Ø¶ÙŠÙˆÙ
        window.ALLOW_ANON = true;

        // === Reviewer (Read-Only) helpers ===
        function isReviewer() {
            try { return typeof getUserRole === 'function' && getUserRole() === 'reviewer'; } catch(e){ return false; }
        }
        // Treat 'manager' as a read-only viewer as well (can view all pages but not modify)
        function isReadOnly(){
            try {
                if (typeof getUserRole !== 'function') return false;
                const r = getUserRole();
                return r === 'reviewer' || r === 'manager';
            } catch(e){ return false; }
        }
        function notifyReadOnly(message) {
            const msg = message || 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·).';
            try { customDialog({ title: 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', message: msg }); } catch(e) { try { alert(msg); } catch(_){} }
        }
        function installReviewerReadOnlyGuards() {
            if (!window.db || window.__REVIEWER_GUARDS_INSTALLED) return;
            window.__REVIEWER_GUARDS_INSTALLED = true;
            try {
                const origCollection = db.collection.bind(db);
                const origDoc = db.doc.bind(db);
                const origBatch = db.batch ? db.batch.bind(db) : null;
                const origRunTx = db.runTransaction ? db.runTransaction.bind(db) : null;

                function wrapDocRef(ref){
                    if (!ref || ref.__wrappedReviewer) return ref;
                    const w = Object.create(ref);
                    ['set','update','delete'].forEach(fn => {
                        if (typeof ref[fn] === 'function') {
                            w[fn] = function(){
                                                if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); }
                                return ref[fn].apply(ref, arguments);
                            };
                        }
                    });
                    w.__wrappedReviewer = true;
                    return w;
                }

                function wrapCollectionRef(col){
                    if (!col || col.__wrappedReviewer) return col;
                    const w = Object.create(col);
                    if (typeof col.add === 'function') {
                        w.add = function(){
                            if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); }
                            return col.add.apply(col, arguments);
                        };
                    }
                    if (typeof col.doc === 'function') {
                        w.doc = function(){
                            const d = col.doc.apply(col, arguments);
                            return wrapDocRef(d);
                        };
                    }
                    w.__wrappedReviewer = true;
                    return w;
                }

                db.collection = function(path){
                    const col = origCollection(path);
                    return wrapCollectionRef(col);
                };
                db.doc = function(path){
                    const d = origDoc(path);
                    return wrapDocRef(d);
                };
                if (origBatch) {
                    db.batch = function(){
                        const b = origBatch();
                        const wrapper = {
                            set(){ if (isReadOnly()) { notifyReadOnly(); return wrapper; } b.set.apply(b, arguments); return wrapper; },
                            update(){ if (isReadOnly()) { notifyReadOnly(); return wrapper; } b.update.apply(b, arguments); return wrapper; },
                            delete(){ if (isReadOnly()) { notifyReadOnly(); return wrapper; } b.delete.apply(b, arguments); return wrapper; },
                            commit(){ if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); } return b.commit(); }
                        };
                        return wrapper;
                    };
                }
                if (origRunTx) {
                    db.runTransaction = function(updateFn){
                        if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); }
                        return origRunTx(updateFn);
                    };
                }
            } catch(e) { console.warn('Reviewer guards setup failed', e); }
        }
        function applyReviewerModeUI(){
            const badge = document.getElementById('reviewer-badge');
            if (badge) badge.classList.toggle('hidden', !isReadOnly());
        }

        // Auto-restore sales from cloud when local cache is empty (runs on login)
        window.autoRestoreSalesIfEmpty = async function(){
            try {
                if (!window.auth || !auth.currentUser) return;
                // if local cache exists and non-empty, skip
                const raw = localStorage.getItem('cache_sales');
                if (raw && raw.length > 2) return; // not empty ("[]" length 2)
                if (window.state && Array.isArray(state.sales) && state.sales.length > 0) return;
                const email = (auth.currentUser.email||'').toLowerCase();
                if (!email) return;
                if (!window.db) { console.warn('autoRestoreSalesIfEmpty: Firestore not ready'); return; }
                try {
                    const snap = await db.collection('sales').where('repEmail','==', email).get();
                    const arr = [];
                    snap.forEach(doc => {
                        const s = doc.data() || {};
                        s._id = doc.id; if (!s.id) s.id = doc.id;
                        arr.push(s);
                    });
                    if (arr.length > 0) {
                        try { localStorage.setItem('cache_sales', JSON.stringify(arr)); } catch(e){}
                        try { localStorage.setItem('reps_local_ts', new Date().toISOString()); } catch(e){}
                        window.state = window.state || {};
                        state.sales = arr.slice(0,500);
                        try { if (typeof renderAllSales === 'function') renderAllSales('', '', 'all'); } catch(e){}
                        try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                        console.log('autoRestoreSalesIfEmpty: restored', arr.length, 'sales for', email);
                    } else {
                        console.log('autoRestoreSalesIfEmpty: no sales found for', email);
                    }
                } catch(e){ console.warn('autoRestoreSalesIfEmpty: query failed', e); }
            } catch(e){ console.warn('autoRestoreSalesIfEmpty failed', e); }
        };
        function initFirebase() {
            try {
                if (!window.firebase) {
                    console.warn('Firebase SDK not loaded');
                    return false;
                }
                if (window.__FIREBASE_INIT_DONE) return true;
                // initialize using compat SDK (we included -compat scripts)
                // accept either global name (FIREBASE_CONFIG) or legacy firebaseConfig
                var cfg = window.firebaseConfig || window.FIREBASE_CONFIG || null;
                if (!cfg) {
                    console.warn('No firebaseConfig found on window.firebaseConfig or window.FIREBASE_CONFIG â€” provide it before loading this file');
                    return false;
                }
                firebase.initializeApp(cfg);
                // expose common helpers and mark cloud-only mode
                try {
                    window.auth = firebase.auth();
                    window.db = firebase.firestore();
                    window.storage = firebase.storage();
                } catch (e) {
                    console.warn('Firebase services not available after init', e);
                }
                window.__FIREBASE_INIT_DONE = true;
                // When Firebase is initialized we enable CLOUD_ONLY mode so localStorage writes are suppressed
                window.CLOUD_ONLY = true;
                console.log('Firebase initialized (compat) â€” CLOUD_ONLY enabled');

                // Install read-only guards for reviewers (after db is ready)
                try { installReviewerReadOnlyGuards(); } catch(e){ console.warn('installReviewerReadOnlyGuards failed', e); }

                // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚
                try {
                    auth.onAuthStateChanged(async function(u){
                        if (u) {
                            window.currentUser = u;
                            // Force refresh auth token to prevent 403 permission errors
                            try {
                                await u.getIdToken(true);
                                console.log('âœ… Auth Token Refreshed - Write Access Granted');
                            } catch(e){ console.warn('Token refresh failed:', e); }
                            
                            const unified = { id: u.uid, email: (u.email||'').toLowerCase(), name: (u.displayName || (u.email ? u.email.split('@')[0] : 'Ù…Ø³ØªØ®Ø¯Ù…')), firebase: true, data: {} };
                            AuthSystem.setCurrentUser(unified);
                            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© roles ÙˆØªØ­Ø¯ÙŠØ« Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
                            try {
                                window.__rolesMap = window.__rolesMap || {};
                                db.collection('roles').doc(u.uid).onSnapshot(snap => {
                                    if (snap.exists) {
                                        window.__rolesMap[u.uid] = snap.data().role || 'user';
                                        document.dispatchEvent(new Event('role-ready'));
                                    }
                                }, err => console.warn('role doc snapshot error', err));
                            } catch(e){ console.warn('setup role listener failed', e); }
                            try { UIController.showApp(); } catch(e){ console.error('showApp error:', e); }
                            try { initializeAppForUser(); } catch(e){ console.error('initializeAppForUser error:', e); }
                            try { setupRealtimeListeners(); } catch(e){ console.error('setupRealtimeListeners error:', e); }
                            try { if (typeof autoRestoreSalesIfEmpty === 'function') autoRestoreSalesIfEmpty(); } catch(e){ console.error('autoRestoreSalesIfEmpty error:', e); }
                            
                            // === ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø«Ù‚ÙŠÙ„Ø© Ù„ØªØ¬Ù†Ø¨ blocking UI Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ===
                            // Start real-time sync for cost lists
                            setTimeout(() => {
                                try { if (typeof initRealtimeSync === 'function') initRealtimeSync(); } catch(e){ console.error('initRealtimeSync error:', e); }
                            }, 500);
                            
                            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ Ù…Ø±Ø©
                            setTimeout(() => {
                                try { if (typeof initRealtimeRecovery === 'function') initRealtimeRecovery(); } catch(e){ console.error('initRealtimeRecovery error:', e); }
                            }, 800);
                            
                            try { setPresenceOnline(); } catch(e){ console.error('setPresenceOnline error:', e); }
                            
                            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ appState Ø§Ù„Ù‚Ø¯ÙŠÙ…
                            setTimeout(() => {
                                try { if (typeof seedDefaultsIfEmpty === 'function') seedDefaultsIfEmpty(); } catch(e){ console.error('seedDefaultsIfEmpty error:', e); }
                            }, 1000);
                            
                            // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¨Ø°Ø± Ù„Ù… ÙŠØ¬Ø¯ Ø´ÙŠØ¦Ø§Ù‹ ÙˆØ¸Ù‡Ø±Øª Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
                            setTimeout(() => {
                                try { if (typeof initLegacyCollectionsIfEmpty === 'function') initLegacyCollectionsIfEmpty(); } catch(e){ console.error('initLegacyCollectionsIfEmpty error:', e); }
                            }, 1200);
                            
                            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                            setTimeout(() => {
                                try { if (typeof scheduleEnsureCoreData === 'function') scheduleEnsureCoreData(); } catch(e){ console.error('scheduleEnsureCoreData error:', e); }
                            }, 1500);
                            
                            // Ø¶Ø¨Ø· Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            setTimeout(() => {
                                try { if (typeof maybeAutoClosePreviousMonth === 'function') maybeAutoClosePreviousMonth(); } catch(e){ console.error('maybeAutoClosePreviousMonth error:', e); }
                                try { if (typeof ensureDefaultActivePeriod === 'function') ensureDefaultActivePeriod(); } catch(e){ console.error('ensureDefaultActivePeriod error:', e); }
                            }, 1800);
                            
                            // Auto-resume GPS sharing if previously enabled
                            setTimeout(() => {
                                try {
                                    if (localStorage.getItem('gps_sharing_enabled') === '1') {
                                        if (typeof startLocationSharing === 'function') startLocationSharing();
                                    }
                                    if (typeof window.__gpsHeaderSync === 'function') window.__gpsHeaderSync();
                                } catch(e){ console.error('GPS sharing error:', e); }
                            }, 2000);
                            
                            // ØªØ´ØºÙŠÙ„ Ø¥ØµÙ„Ø§Ø­ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            setTimeout(() => {
                                try { if (typeof autoFixChocolateVatOnce === 'function') autoFixChocolateVatOnce(); } catch(e){ console.error('autoFixChocolateVatOnce error:', e); }
                            }, 2500);
                            
                            // Reviewer mode UI updates
                            try { applyReviewerModeUI(); } catch(e){ console.error('applyReviewerModeUI error:', e); }
                            
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙˆØ± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±
                            try { applyRoleNavRestrictions(); } catch(e){ console.error('applyRoleNavRestrictions error:', e); }
                            
                            // Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ù„Ø§Ù„ Ø£ÙˆÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                            let tries = 0; const tmr = setInterval(()=>{ tries++; try { applyRoleNavRestrictions(); } catch(e){ console.error('roleNavRestrictions retry error:', e); } if (tries>10) clearInterval(tmr); },1000);
                        } else {
                            try { AuthSystem.logout(); } catch(e){}
                            try { UIController.showLoginPage(); } catch(e){}
                            try { setPresenceOffline(); } catch(e){}
                        }
                        try { UIController.updateCurrentUserDisplay(); } catch(e){}
                    });
                } catch(e) { console.warn('onAuthStateChanged setup failed', e); }

                return true;
            } catch (e) {
                console.warn('initFirebase error', e);
                return false;
            }
        }

        // Try to initialize automatically if a config exists
        try { initFirebase(); } catch(e) { /* ignore */ }

        // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ø­Ø¸ÙŠØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ù†Ø¬Ø§Ø­ ØªÙˆØ«ÙŠÙ‚ (ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ù† onAuthStateChanged Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
        function setupRealtimeListeners(){
            if (!window.db) { console.warn('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯'); return; }
            window.state = window.state || {};
            // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Admin/Reviewer: ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±Ø› Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ÙÙˆØ§ØªÙŠØ±Ù‡ ÙÙ‚Ø·)
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = AuthSystem.getCurrentUser();
                const applySnap = function(snap){
                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    arr.sort((a,b)=>{
                        const ta = new Date(a.date || a.createdAt || 0).getTime();
                        const tb = new Date(b.date || b.createdAt || 0).getTime();
                        return tb - ta;
                    });
                    state.sales = arr.slice(0,500);
                    try { localStorage.setItem('cache_sales', JSON.stringify(state.sales)); } catch(e){}
                    try {
                        const textFilter = document.getElementById('search-sales-text')?.value || '';
                        const dateFilter = document.getElementById('search-sales-date')?.value || '';
                        const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                        if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                        else if (typeof renderSalesList === 'function') renderSalesList();
                        if (typeof renderDashboard === 'function') renderDashboard();
                    } catch(e){}
                };
                const onErr = function(err){
                    console.warn('sales snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('sales'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_sales');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.sales || state.sales.length === 0) && Array.isArray(cached) && cached.length) {
                            state.sales = cached;
                            const textFilter = document.getElementById('search-sales-text')?.value || '';
                            const dateFilter = document.getElementById('search-sales-date')?.value || '';
                            const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                            if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                            if (typeof renderDashboard === 'function') renderDashboard();
                        }
                    } catch(e){}
                };

                if (role === 'admin' || role === 'reviewer' || role === 'manager') {
                    db.collection('sales').onSnapshot(applySnap, onErr);
                    } else if ((role === 'rep' || role === 'user') && current && current.id) {
                    const uid = String(current.id);
                    const email = (current.email||'').toLowerCase();
                    const byId = new Map();
                    let salesErrCount = 0;
                    const mergeAndRender = () => {
                        const arr = Array.from(byId.values());
                        arr.sort((a,b)=>{
                            const ta = new Date(a.date || a.createdAt || 0).getTime();
                            const tb = new Date(b.date || b.createdAt || 0).getTime();
                            return tb - ta;
                        });
                        state.sales = arr.slice(0,500);
                        try { localStorage.setItem('cache_sales', JSON.stringify(state.sales)); } catch(e){}
                        try { if (typeof renderAllSales === 'function') renderAllSales('', '', 'all'); } catch(e){}
                        try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                    };
                    // CRITICAL FIX: Listen to the rep's personal invoices subcollection
                    // This ensures admin-created invoices appear on the rep's screen
                    db.collection('users').doc(uid).collection('invoices').onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    // Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø¯Ø¹Ù… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø­Ù‚ÙˆÙ„
                    db.collection('sales').where('createdBy','==', uid).onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ /* fallback to full snapshot */ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    db.collection('sales').where('repId','==', uid).onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    // Legacy support: Ø¨Ø¹Ø¶ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªØ³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† uid
                    // Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…
                    try {
                        const currentRepDoc = (state.reps||[]).find(r => (r.email||'').toLowerCase() === email) || (state.reps||[]).find(r => (r.name||'') === (current && current.name));
                        const repDocId = currentRepDoc && currentRepDoc.id ? String(currentRepDoc.id) : null;
                        if (repDocId && repDocId !== uid) {
                            db.collection('sales').where('repId','==', repDocId).onSnapshot(snap => {
                                try {
                                    snap.docChanges().forEach(change => {
                                        if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                        const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                                    });
                                } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                                mergeAndRender();
                            }, onErr);
                            // attach error-only listener to surface failures
                            db.collection('sales').where('repId','==', repDocId).onSnapshot(()=>{}, err => console.warn('sales repDocId query error', err));
                        }
                    } catch(e){ console.warn('setupRealtimeListeners: repDocId mapping failed', e); }
                    db.collection('sales').where('createdByEmail','==', email).onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    // â­ CRITICAL: Listen by repName - wait for state.reps to be ready
                    const setupRepNameListener = () => {
                        try {
                            const currentRepDoc = (state.reps||[]).find(r => (r.email||'').toLowerCase() === email);
                            const repName = currentRepDoc ? currentRepDoc.name : null;
                            if (repName) {
                                console.log('âœ… Rep listener: watching sales where repName ==', repName);
                                db.collection('sales').where('repName','==', repName).onSnapshot(snap => {
                                    console.log('ğŸ“Š Rep sales snapshot received:', snap.size, 'invoices for', repName);
                                    try {
                                        snap.docChanges().forEach(change => {
                                            if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                            const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; 
                                            console.log('  - Invoice:', d.invoiceNumber, 'repName:', d.repName, 'total:', d.total);
                                            byId.set(change.doc.id, d);
                                        });
                                    } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                                    mergeAndRender();
                                }, err => console.warn('sales repName query error', err));
                            } else {
                                console.warn('âš ï¸ Could not find rep name for email:', email, '- retrying in 2 seconds');
                                setTimeout(setupRepNameListener, 2000);
                            }
                        } catch(e){ 
                            console.warn('setupRealtimeListeners: repName listener failed', e);
                            setTimeout(setupRepNameListener, 2000);
                        }
                    };
                    // Try immediately, but retry if reps not ready
                    setupRepNameListener();
                    const salesErrorHandler = err => { salesErrCount++; console.warn('sales legacy query error', err); if (salesErrCount >= 3) { tryBroadSalesFallback(); } };
                    // reattach with dedicated handlers (original above kept minimal)
                    db.collection('sales').where('createdBy','==', uid).onSnapshot(()=>{}, salesErrorHandler);
                    db.collection('sales').where('repId','==', uid).onSnapshot(()=>{}, salesErrorHandler);
                    db.collection('sales').where('createdByEmail','==', email).onSnapshot(()=>{}, salesErrorHandler);
                    try {
                        const currentRepDoc = (state.reps||[]).find(r => (r.email||'').toLowerCase() === email) || (state.reps||[]).find(r => (r.name||'') === (current && current.name));
                        const repDocId = currentRepDoc && currentRepDoc.id ? String(currentRepDoc.id) : null;
                        if (repDocId && repDocId !== uid) {
                            db.collection('sales').where('repId','==', repDocId).onSnapshot(()=>{}, salesErrorHandler);
                        }
                    } catch(e){ /* ignore */ }
                    db.collection('users').doc(uid).collection('invoices').onSnapshot(()=>{}, err => console.warn('user-invoices subcollection error', err));
                    function tryBroadSalesFallback(){
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø§Ù…Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù‚ÙˆØ§Ø¹Ø³
                        db.collection('sales').limit(500).onSnapshot(snap => {
                            snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); });
                            mergeAndRender();
                        }, err => console.warn('broad sales fallback failed', err));
                    }
                    // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø±ÙØ¶ ÙƒÙ„Ù‡ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ
                    setTimeout(()=>{
                        if ((!state.sales || state.sales.length===0)) {
                            try {
                                const raw = localStorage.getItem('cache_sales');
                                const cached = raw ? JSON.parse(raw): [];
                                if (Array.isArray(cached) && cached.length) {
                                    state.sales = cached;
                                    if (typeof renderDashboard === 'function') renderDashboard();
                                }
                            } catch(e){}
                        }
                    }, 2000);
                } else {
                    db.collection('sales').onSnapshot(applySnap, onErr);
                }
            } catch(e){ console.warn('sales listener init failed', e); }
            // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (ØªØµÙÙŠØ© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯: ÙŠØ±Ù‰ Ø¹Ù…Ù„Ø§Ø¡Ù‡ ÙÙ‚Ø· + ØºÙŠØ± Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†ÙŠÙ†)
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = AuthSystem.getCurrentUser();
                if (role === 'admin') {
                    db.collection('customers').onSnapshot(function(snap){
                        // If there are pending writes from this client, only apply the overlay
                        // when the cloud snapshot contains newer data than local cache.
                        if (snap.metadata && snap.metadata.hasPendingWrites) {
                            try {
                                let maxTs = null;
                                snap.forEach(doc => {
                                    const d = doc.data()||{};
                                    const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null;
                                    if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs;
                                });
                                const localTs = localStorage.getItem('customers_local_ts') || null;
                                if (maxTs && localTs) {
                                    if (new Date(maxTs) <= new Date(localTs)) {
                                        console.log('ğŸ”„ customers listener: ignoring pending write (local) â€” cloud not newer', {maxTs, localTs});
                                        return;
                                    }
                                    console.log('ğŸ”„ customers listener: pendingWrites but cloud newer â€” applying overlay', {maxTs, localTs});
                                } else {
                                    console.log('ğŸ”„ customers listener: ignoring pending write (local) â€” missing timestamps', {maxTs, localTs});
                                    return;
                                }
                            } catch(_) { console.log('ğŸ”„ customers listener: timestamp compare failed'); return; }
                        }

                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); localStorage.setItem('customers_local_ts', new Date().toISOString()); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                        try { attemptDeleteSpecificCustomersOnce(); } catch(e){}
                    }, err => {
                        console.warn('customers snapshot error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                    });
                } else if ((role === 'rep' || role === 'user') && current && current.id) {
                    const uid = String(current.id);
                    const byId = new Map();
                    let custErrCount = 0;
                    const applyAndRender = () => {
                        const arr = Array.from(byId.values());
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                    };

                    const shouldApplySnapshot = (snap, localKey) => {
                        try {
                            if (!snap.metadata || !snap.metadata.hasPendingWrites) return true;
                            let maxTs = null;
                            snap.forEach(doc => {
                                const d = doc.data() || {};
                                const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null;
                                if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs;
                            });
                            const localTs = localStorage.getItem(localKey) || null;
                            if (!maxTs || !localTs) return false;
                            return new Date(maxTs) > new Date(localTs);
                        } catch(e){ console.log('listener: timestamp compare failed', e); return false; }
                    };

                    // 1) Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ - assignedRepId
                    db.collection('customers').where('assignedRepId','==', uid).onSnapshot(function(snap){
                        if (!shouldApplySnapshot(snap, 'customers_local_ts')) { console.log('ğŸ”„ customers(rep) listener: skipping (local newer or missing ts)'); return; }
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => {
                        console.warn('customers snapshot (rep-owned) error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                        custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback();
                    });

                    // legacy queries: repId and ownerId
                    db.collection('customers').where('repId','==', uid).onSnapshot(function(snap){
                        if (!shouldApplySnapshot(snap, 'customers_local_ts')) { console.log('ğŸ”„ customers(legacy) listener: skipping (local newer or missing ts)'); return; }
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => { console.warn('customers snapshot (legacy repId) error', err); custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback(); });

                    db.collection('customers').where('ownerId','==', uid).onSnapshot(function(snap){
                        if (!shouldApplySnapshot(snap, 'customers_local_ts')) { console.log('ğŸ”„ customers(owner) listener: skipping (local newer or missing ts)'); return; }
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => { console.warn('customers snapshot (legacy ownerId) error', err); custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback(); });
                    function tryBroadCustomersFallback(){
                        db.collection('customers').limit(500).onSnapshot(snap => {
                            snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id,d); });
                            applyAndRender();
                        }, err => console.warn('broad customers fallback failed', err));
                    }
                } else {
                    // Ø£Ø¯ÙˆØ§Ø± Ø£Ø®Ø±Ù‰: Ø­Ø§ÙˆÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ ÙˆØ¥Ù† Ø±ÙÙØ¶Øª Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    db.collection('customers').onSnapshot(function(snap){
                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                    }, err => {
                        console.warn('customers snapshot (other role) error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                    });
                }
            } catch(e){ console.warn('customers listener init failed', e); }
            // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            try {
                db.collection('products').onSnapshot(function(snap){
                    if (snap.metadata && snap.metadata.hasPendingWrites) {
                        try {
                            let maxTs = null;
                            snap.forEach(doc => { const d = doc.data()||{}; const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null; if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs; });
                            const localTs = localStorage.getItem('products_local_ts') || null;
                            if (maxTs && localTs) {
                                if (new Date(maxTs) <= new Date(localTs)) { console.log('ğŸ”„ products listener: ignoring pending write (local) â€” cloud not newer', {maxTs, localTs}); return; }
                                console.log('ğŸ”„ products listener: pendingWrites but cloud newer â€” applying overlay', {maxTs, localTs});
                            } else { console.log('ğŸ”„ products listener: missing timestamps; ignoring pending write', {maxTs, localTs}); return; }
                        } catch(_) { console.log('ğŸ”„ products listener: ts compare failed; ignoring'); return; }
                    }
                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚Ù„ id Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆÙ‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¹Ø± Ù„ÙƒÙ† ÙŠÙˆØ¬Ø¯ productPrices Ù…Ù†ÙØµÙ„Ø© Ø£Ùˆ Ø­Ù‚Ù„ price Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
                        arr.push(d);
                    });
                    state.products = arr;
                    try { localStorage.setItem('cache_products', JSON.stringify(arr)); localStorage.setItem('products_local_ts', new Date().toISOString()); } catch(e){}
                    try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                }, err => {
                    console.warn('products snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('products'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_products');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.products || state.products.length === 0) && Array.isArray(cached) && cached.length) {
                            state.products = cached;
                            if (typeof renderProductList === 'function') renderProductList('');
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('products listener init failed', e); }
            // Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
            try {
                db.collection('priceLists').onSnapshot(function(snap){
                    if (snap.metadata && snap.metadata.hasPendingWrites) {
                        try {
                            let maxTs = null;
                            snap.forEach(doc => { const d = doc.data()||{}; const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null; if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs; });
                            const localTs = localStorage.getItem('priceLists_local_ts') || null;
                            if (maxTs && localTs) {
                                if (new Date(maxTs) <= new Date(localTs)) { console.log('ğŸ”„ priceLists listener: ignoring pending write (local) â€” cloud not newer', {maxTs, localTs}); return; }
                                console.log('ğŸ”„ priceLists listener: pendingWrites but cloud newer â€” applying overlay', {maxTs, localTs});
                            } else { console.log('ğŸ”„ priceLists listener: missing timestamps; ignoring pending write', {maxTs, localTs}); return; }
                        } catch(_) { console.log('ğŸ”„ priceLists listener: ts compare failed; ignoring'); return; }
                    }

                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        const pl = { id: doc.id, name: d.name || d.title || doc.id, productPrices: {} };
                        if (d.productPrices && typeof d.productPrices === 'object') {
                            pl.productPrices = d.productPrices;
                        } else if (d.prices && typeof d.prices === 'object') {
                            pl.productPrices = d.prices;
                        } else if (d.map && typeof d.map === 'object') {
                            pl.productPrices = d.map;
                        } else {
                            // Ø¯Ø¹Ù… Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø®Ø§Ø·Ø¦: Ù…ÙØ§ØªÙŠØ­ Ø±Ù‚Ù…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¹Ù„Ù‰
                            const pp = {};
                            Object.keys(d).forEach(k => {
                                if (/^\d+$/.test(k) && typeof d[k] === 'number') pp[k] = d[k];
                            });
                            pl.productPrices = pp;
                        }
                        arr.push(pl);
                    });
                    // Ù„Ø§ ØªÙ…Ø³Ø­ Ø§Ù„Ø³Ø¹Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙØ§Ø±ØºØ©Ø› Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† appState/Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                    if (arr.length > 0) {
                        state.priceLists = arr;
                        try { localStorage.setItem('cache_priceLists', JSON.stringify(arr)); localStorage.setItem('priceLists_local_ts', new Date().toISOString()); } catch(e){}
                        try { if (typeof renderSettings === 'function') renderSettings(document.getElementById('search-products')?.value || ''); } catch(e){}
                        try { updateAllPriceListDropdowns(); } catch(e){}
                        try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                        // IMPORTANT: Ø£Ø¹ÙØ¯Ù‘ Ø±Ø³Ù… ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙˆØ± ØªÙˆÙØ± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø­ØªÙ‰ Ù„Ø§ ØªØ¸Ù‡Ø± "Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±"
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                    }
                }, err => {
                    console.warn('priceLists snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('priceLists'); } catch(e){} }
                    // Fallback Ø¹Ù†Ø¯ Ù…Ù†Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                    if (err && err.code === 'permission-denied') {
                        if ((!state.priceLists || !state.priceLists.length) && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025)) {
                            state.priceLists = window.EMBEDDED_PRICE_LISTS_BACKUP_2025.map(pl => ({ id: pl.id, name: pl.name, productPrices: pl.productPrices || {} }));
                            console.log('âš ï¸ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
                            try { updateAllPriceListDropdowns(); } catch(e){}
                            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                            try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                        }
                    }
                    // Fallback Ø¥Ø¶Ø§ÙÙŠ: Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø¨Ø£Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
                    try {
                        const raw = localStorage.getItem('cache_priceLists');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.priceLists || state.priceLists.length === 0) && Array.isArray(cached) && cached.length) {
                            state.priceLists = cached;
                            try { updateAllPriceListDropdowns(); } catch(e){}
                            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                            try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('priceLists listener init failed', e); }
            // Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨
            try {
                db.collection('reps').onSnapshot(function(snap){
                    if (snap.metadata && snap.metadata.hasPendingWrites) {
                        try {
                            let maxTs = null;
                            snap.forEach(doc => { const d = doc.data()||{}; const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null; if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs; });
                            const localTs = localStorage.getItem('reps_local_ts') || null;
                            if (maxTs && localTs) {
                                if (new Date(maxTs) <= new Date(localTs)) { console.log('ğŸ”„ reps listener: ignoring pending write (local) â€” cloud not newer', {maxTs, localTs}); return; }
                                console.log('ğŸ”„ reps listener: pendingWrites but cloud newer â€” applying overlay', {maxTs, localTs});
                            } else { console.log('ğŸ”„ reps listener: missing timestamps; ignoring pending write', {maxTs, localTs}); return; }
                        } catch(_) { console.log('ğŸ”„ reps listener: ts compare failed; ignoring'); return; }
                    }

                    const arr = [];
                    snap.forEach(doc => { const d = doc.data(); d.id = doc.id; arr.push(d); });
                    state.reps = arr;
                    try { localStorage.setItem('reps_local_ts', new Date().toISOString()); } catch(e){}
                    try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
                    try {
                        const simpleIds = ['sale-rep','customer-rep','new-dispatch-rep','spreadsheet-rep','debt-rep-filter','dashboard-rep-filter'];
                        simpleIds.forEach(id => { const el = document.getElementById(id); if (el && typeof populateRepDropdown === 'function') populateRepDropdown(el); });
                        const reportIds = ['daily-report-rep','range-report-rep','monthly-report-rep','recon-report-rep'];
                        reportIds.forEach(id => { const el = document.getElementById(id); if (el && typeof populateRepDropdownReports === 'function') populateRepDropdownReports(el); });
                    } catch(e){}
                }, err => console.warn('reps snapshot error', err));
                // (Optional) could add permission handler for reps/users/presence if needed
            } catch(e){ console.warn('reps listener init failed', e); }
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† (Ù„Ù„Ø£Ø¯ÙˆØ§Ø±) â€” Admin only
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') {
                    db.collection('users').onSnapshot(function(snap){
                        const usersArr = [];
                        snap.forEach(doc => {
                            const d = doc.data();
                            d._id = doc.id;
                            if (!d.uid) d.uid = doc.id;
                            if (d.email) { try { d.email = String(d.email).toLowerCase(); } catch(_){} }
                            usersArr.push(d);
                        });
                        state.users = usersArr;
                        try {
                            UIController.updateCurrentUserDisplay();
                            if (typeof renderUsersTable === 'function') renderUsersTable();
                        } catch(e){}
                    }, err => console.warn('users snapshot error', err));
                }
            } catch(e){ console.warn('users listener init failed', e); }

            // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… shared/public_app_state Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹Ø› Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ø¢Ù† Ù‡Ùˆ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©

            // Ø§Ù„Ø­Ø¶ÙˆØ± (presence) â€” Admin only
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') {
                    db.collection('presence').onSnapshot(function(snap){
                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; arr.push(d); });
                        state.presence = arr;
                        try {
                            if (Array.isArray(state.users) && state.users.length) {
                                const byId = new Map(arr.map(p => [String(p.uid||p._id||''), p]));
                                state.users = state.users.map(u => {
                                    const p = byId.get(String(u._id||u.uid||''));
                                    const merged = Object.assign({}, u);
                                    if (p) {
                                        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ÙˆØ¬ÙˆØ¯ ÙÙŠ presence
                                        if ((!merged.email || merged.email==='') && p.email) merged.email = String(p.email).toLowerCase();
                                        merged.online = (p.online !== false); // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© true Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                                        try {
                                            if ((!u.email || u.email==='') && p.email && db) {
                                                db.collection('users').doc(String(u._id)).set({ email: String(p.email).toLowerCase() }, { merge: true }).catch(()=>{});
                                            }
                                        } catch(_e){}
                                    } else {
                                        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ presence Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â€” Ø§ÙØ±Ø¶ Ø£Ù†Ù‡ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
                                        merged.online = (typeof u.online !== 'undefined') ? !!u.online : false; // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ false (ØºÙŠØ± Ù…ØªØµÙ„) 
                                    }
                                    return merged;
                                });
                            }
                        } catch(_){ }
                        try { renderRepLocations(); } catch(e){}
                        try { renderRepMap(); } catch(e){}
                        try { if (typeof renderUsersTable === 'function') renderUsersTable(); } catch(e){}
                    }, err => console.warn('presence snapshot error', err));
                }
            } catch(e){ console.warn('presence listener init failed', e); }

            // Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ (dispatchNotes)
            try {
                db.collection('dispatchNotes').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                    // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
                    arr.sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
                    state.dispatchNotes = arr;
                    try { localStorage.setItem('cache_dispatchNotes', JSON.stringify(arr)); } catch(e){}
                    try { if (typeof renderDispatchPage === 'function') renderDispatchPage(); } catch(e){}
                }, err => {
                    console.warn('dispatchNotes snapshot error', err);
                    if (err && err.code === 'permission-denied') {
                        try {
                            const raw = localStorage.getItem('cache_dispatchNotes');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.dispatchNotes || state.dispatchNotes.length===0) && cached.length){
                                state.dispatchNotes = cached; if (typeof renderDispatchPage === 'function') renderDispatchPage();
                            }
                        } catch(e){}
                    }
                });
            } catch(e){ console.warn('dispatchNotes listener init failed', e); }

            // Daily collections (rep expenses + daily collection sheet)
            try {
                db.collection('daily_collections').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.dailyCollections = arr;
                    try { localStorage.setItem('cache_daily_collections', JSON.stringify(arr)); } catch(e){}
                }, err => {
                    console.warn('daily_collections snapshot error', err);
                    try {
                        const raw = localStorage.getItem('cache_daily_collections');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.dailyCollections || state.dailyCollections.length===0) && cached.length){
                            state.dailyCollections = cached;
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('daily_collections listener init failed', e); }

            // Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ© (promotions)
            try {
                db.collection('promotions').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.promotions = arr;
                    try { localStorage.setItem('cache_promotions', JSON.stringify(arr)); } catch(e){}
                    try { if (typeof renderPromotions === 'function') renderPromotions(); } catch(e){}
                    try { if (typeof updateAllSalePrices === 'function') updateAllSalePrices(); } catch(e){}
                }, err => {
                    console.warn('promotions snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('promotions'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_promotions');
                        if (raw) state.promotions = JSON.parse(raw);
                    } catch(e){}
                });
            } catch(e){ console.warn('promotions listener init failed', e); }

            // Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ© (openingBalances) â€” ØªÙØ³ØªØ®Ø¯Ù… Ù„Ù„ØªØ±Ø­ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ù‡ÙˆØ±
            try {
                db.collection('openingBalances').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.openingBalances = arr;
                    try { localStorage.setItem('cache_openingBalances', JSON.stringify(arr)); } catch(e){}
                }, err => {
                    console.warn('openingBalances snapshot error', err);
                    try {
                        const raw = localStorage.getItem('cache_openingBalances');
                        if (raw) state.openingBalances = JSON.parse(raw);
                    } catch(e){}
                });
            } catch(e){ console.warn('openingBalances listener init failed', e); }

            // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (settings) â€” Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            try {
                db.collection('settings').doc('global-settings').onSnapshot(function(snap){
                    if (snap.exists) {
                        const settings = snap.data() || {};
                        state.settings = state.settings || {};
                        if (settings.salesTarget !== undefined) {
                            state.settings.salesTarget = settings.salesTarget;
                            // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙƒÙ† Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø©)
                            try {
                                const input = document.getElementById('sales-target-input');
                                if (input) {
                                    input.value = settings.salesTarget;
                                }
                            } catch(e){}
                            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ù‡Ø¯Ù
                            try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                        }
                        console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', settings);
                    }
                }, err => {
                    console.warn('settings snapshot error', err);
                });
            } catch(e){ console.warn('settings listener init failed', e); }
        }

        // ===== GPS Tracking (Presence Location) =====
        (function(){
            const LS_GPS = 'gps_sharing_enabled';
            window.__gpsWatchId = null;
            window.__repsMap = null;
            window.__repMarkers = {};
            window.__gpsHeaderSync = function(){
                try {
                    const btn = document.getElementById('gps-toggle-btn');
                    if (!btn) return;
                    // Remove any neutral/old classes to avoid conflicts
                    btn.classList.remove('bg-gray-200','hover:bg-gray-300','text-gray-800');
                    const enabled = localStorage.getItem(LS_GPS) === '1';
                    btn.textContent = enabled ? 'GPS ON' : 'GPS OFF';
                    btn.classList.toggle('bg-green-500', enabled);
                    btn.classList.toggle('hover:bg-green-600', enabled);
                    btn.classList.toggle('text-white', enabled);
                    // OFF state as red for clear visual cue
                    btn.classList.toggle('bg-red-500', !enabled);
                    btn.classList.toggle('hover:bg-red-600', !enabled);
                    btn.classList.toggle('text-white', !enabled);
                } catch(e){}
            };

            window.startLocationSharing = function(){
                try {
                    const statusEl = document.getElementById('gps-share-status');
                    if (!navigator.geolocation) { if (statusEl) statusEl.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹'; return; }
                    if (!auth || !auth.currentUser) { if (statusEl) statusEl.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'; return; }
                    if (window.__gpsWatchId != null) return; // already running
                    const opts = { enableHighAccuracy: true, maximumAge: 15000, timeout: 15000 };
                    window.__gpsWatchId = navigator.geolocation.watchPosition(async function(pos){
                        try {
                            const { latitude:lat, longitude:lng, accuracy } = pos.coords || {};
                            const uid = auth.currentUser.uid;
                            await db.collection('presence').doc(uid).set({
                                uid,
                                email: (auth.currentUser.email||'').toLowerCase(),
                                online: true,
                                location: { lat, lng, accuracy },
                                locationUpdatedAt: serverTs(),
                                sharing: true
                            }, { merge:true });
                            const s = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}`;
                            if (statusEl) statusEl.textContent = s;
                        } catch(e){ /* ignore */ }
                    }, function(err){ if (statusEl) statusEl.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'; console.warn('GPS error', err); }, opts);
                    try { localStorage.setItem(LS_GPS, '1'); } catch(e){}
                    try { window.__gpsHeaderSync(); } catch(e){}
                } catch(e){ console.warn('startLocationSharing failed', e); }
            };

            window.stopLocationSharing = function(){
                try {
                    const statusEl = document.getElementById('gps-share-status');
                    if (window.__gpsWatchId != null) { try { navigator.geolocation.clearWatch(window.__gpsWatchId); } catch(e){} window.__gpsWatchId = null; }
                    try { localStorage.removeItem(LS_GPS); } catch(e){}
                    if (statusEl) statusEl.textContent = 'Ù…ØªÙˆÙ‚Ù';
                    if (auth && auth.currentUser && db) {
                        const uid = auth.currentUser.uid;
                        db.collection('presence').doc(uid).set({ sharing:false }, { merge:true }).catch(()=>{});
                    }
                    try { window.__gpsHeaderSync(); } catch(e){}
                } catch(e){ console.warn('stopLocationSharing failed', e); }
            };

            window.setupGpsSharingControls = function(){
                try {
                    const toggle = document.getElementById('gps-share-toggle');
                    const statusEl = document.getElementById('gps-share-status');
                    const adminBox = document.getElementById('admin-gps-list');
                    if (!toggle) return; // settings page not in DOM
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (adminBox) adminBox.classList.toggle('hidden', role !== 'admin');
                    const enabled = localStorage.getItem(LS_GPS) === '1';
                    toggle.checked = enabled;
                    if (enabled) { statusEl && (statusEl.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©...'); startLocationSharing(); }
                    toggle.addEventListener('change', function(){
                        if (toggle.checked) { statusEl && (statusEl.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©...'); startLocationSharing(); }
                        else { stopLocationSharing(); }
                    });
                    // Ø¹Ø±Ø¶ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    try { window.renderRepLocations(); } catch(e){}
                    // Ø£ÙŠØ¶Ø§Ù‹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ renderRepMap Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…ÙØªÙˆØ­Ø©
                    try { window.renderRepMap(); } catch(e){}
                    // Also wire header button now that DOM is ready
                    try {
                        const hdrBtn = document.getElementById('gps-toggle-btn');
                        if (hdrBtn) {
                            window.__gpsHeaderSync();
                            hdrBtn.addEventListener('click', function(){
                                const isOn = localStorage.getItem(LS_GPS) === '1';
                                if (isOn) {
                                    stopLocationSharing();
                                } else {
                                    statusEl && (statusEl.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©...');
                                    startLocationSharing();
                                }
                                // Immediately refresh text to reflect Delente ON/OFF without waiting for async
                                try { window.__gpsHeaderSync(); } catch(e){}
                            });
                        }
                    } catch(e){}
                } catch(e){ console.warn('setupGpsSharingControls failed', e); }
            };

            window.renderRepLocations = function(){
                try {
                    const listEl = document.getElementById('rep-locations-list');
                    const adminBox = document.getElementById('admin-gps-list');
                    if (!listEl || !adminBox || adminBox.classList.contains('hidden')) return;
                    const rows = (state.presence||[])
                        .map(p => {
                            try {
                                if (!p || !p.location) return null;
                                const latRaw = p.location.lat;
                                const lngRaw = p.location.lng;
                                const lat = Number(latRaw);
                                const lng = Number(lngRaw);
                                if (!isFinite(lat) || !isFinite(lng)) return null;
                                const name = (state.users||[]).find(u=>u.uid===p.uid)?.name || (state.reps||[]).find(r=>r.email && p.email && r.email.toLowerCase()===p.email.toLowerCase())?.name || p.email || p.uid;
                                const acc = p.location.accuracy;
                                const when = p.locationUpdatedAt && p.locationUpdatedAt.toDate ? p.locationUpdatedAt.toDate() : (p.locationUpdatedAt || null);
                                const timeStr = when ? new Date(when).toLocaleString('ar-EG') : '';
                                const link = `https://www.google.com/maps?q=${lat},${lng}`;
                                return `<div class="flex items-center gap-2 p-2 bg-gray-50 rounded">
                                    <span class="font-semibold">${(name||'Ù…Ù†Ø¯ÙˆØ¨')}</span>
                                    <span class="text-gray-600">(${lat.toFixed(5)}, ${lng.toFixed(5)}${acc?` â€¢ Â±${Math.round(acc)}Ù…`:''})</span>
                                    <a class="text-blue-600 underline ml-auto" target="_blank" href="${link}">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                                    <span class="text-xs text-gray-500">${timeStr}</span>
                                </div>`;
                            } catch(e){ return null; }
                        }).filter(Boolean).join('');
                    listEl.innerHTML = rows || '<div class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ù…ÙØ¨Ù„Ù‘Øº Ø¹Ù†Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
                } catch(e){ /* ignore */ }
            };

            // Interactive map: initialize and update markers
            window.openRepsMap = function(){
                try {
                    const modal = document.getElementById('reps-map-modal');
                    if (!modal) return;
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    setTimeout(()=>{
                        if (!window.__repsMap) {
                            window.__repsMap = L.map('reps-map', { zoomControl: true });
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: '&copy; OpenStreetMap'
                            }).addTo(window.__repsMap);
                        }
                        renderRepMap();
                    }, 50);
                } catch(e){ console.warn('openRepsMap failed', e); }
            };

            window.closeRepsMap = function(){
                try {
                    const modal = document.getElementById('reps-map-modal');
                    if (!modal) return;
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                } catch(e){}
            };

            window.renderRepMap = function(){
                try {
                    if (!window.__repsMap) return;
                    const presence = (state.presence||[]).map(p => {
                        if (!p || !p.location) return null;
                        const lat = Number(p.location.lat);
                        const lng = Number(p.location.lng);
                        if (!isFinite(lat) || !isFinite(lng)) return null;
                        p._lat = lat; p._lng = lng; return p;
                    }).filter(p => p && p.sharing !== false);
                    const bounds = [];
                    // Diagnostic: log presence summary to help debug missing markers
                    try { console.debug('renderRepMap presence:', presence.map(x=>({uid: x.uid||x._id||x.email, email: x.email, lat: x._lat, lng: x._lng, sharing: x.sharing}))); } catch(e){}
                    // Remove markers that are no longer present (use stable key including email fallback)
                    const currentUids = new Set(presence.map(p => String(p.uid||p._id||p.email||'')));
                    Object.keys(window.__repMarkers).forEach(key => {
                        if (!currentUids.has(key)) {
                            try { window.__repsMap.removeLayer(window.__repMarkers[key]); } catch(e){}
                            delete window.__repMarkers[key];
                        }
                    });
                    presence.forEach(p => {
                        const key = String(p.uid || p._id || p.email || '');
                        const lat = p._lat, lng = p._lng;
                        const name = (state.users||[]).find(u=>u.uid===p.uid)?.name || (state.reps||[]).find(r=>r.email && p.email && r.email.toLowerCase()===p.email.toLowerCase())?.name || p.email || 'Ù…Ù†Ø¯ÙˆØ¨';
                        const when = p.locationUpdatedAt && p.locationUpdatedAt.toDate ? p.locationUpdatedAt.toDate() : (p.locationUpdatedAt || null);
                        const timeStr = when ? new Date(when).toLocaleString('ar-EG') : '';
                        const popupHtml = `<div style="min-width:160px"><div style="font-weight:700">${name}</div><div style="font-size:12px;color:#555">${lat.toFixed(5)}, ${lng.toFixed(5)}</div><div style="font-size:11px;color:#777">${timeStr}</div><a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color:#2563eb;text-decoration:underline">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></div>`;
                        if (!window.__repMarkers[key]) {
                            window.__repMarkers[key] = L.marker([lat, lng]).addTo(window.__repsMap).bindPopup(popupHtml);
                        } else {
                            window.__repMarkers[key].setLatLng([lat, lng]);
                            window.__repMarkers[key].setPopupContent(popupHtml);
                        }
                        bounds.push([lat, lng]);
                    });
                    if (bounds.length) {
                        try { window.__repsMap.fitBounds(bounds, { padding: [30,30] }); } catch(e){}
                    }
                } catch(e){ console.warn('renderRepMap failed', e); }
            };

            // Wire header map button and modal close
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const openBtn = document.getElementById('open-map-btn');
                    const closeBtn = document.getElementById('close-map-btn');
                    if (openBtn) openBtn.addEventListener('click', openRepsMap);
                    if (closeBtn) closeBtn.addEventListener('click', closeRepsMap);
                    // Wire header GPS toggle regardless of settings page
                    const hdrBtn = document.getElementById('gps-toggle-btn');
                    if (hdrBtn) {
                        try { window.__gpsHeaderSync(); } catch(e){}
                        hdrBtn.addEventListener('click', function(){
                            try {
                                const isOn = localStorage.getItem('gps_sharing_enabled') === '1';
                                if (isOn) stopLocationSharing(); else startLocationSharing();
                            } catch(e){}
                        });
                    }
                } catch(e){}
            });
        })();

        // ===== ØªØ¹Ø§ÙÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØªÙ… Ù…Ù„Ø¡ state Ø®Ù„Ø§Ù„ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„Ø£ÙˆÙ„Ù‰ =====
        function initRealtimeRecovery(){
            let attempts = 0;
            const maxAttempts = 5; // Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ù„Ø§Ù…ØªÙ†Ø§Ù‡ÙŠ
            const intervalMs = 3000;
            if (window.__REALTIME_RECOVERY_STARTED) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
            window.__REALTIME_RECOVERY_STARTED = true;
            const iv = setInterval(()=>{
                attempts++;
                try {
                    const salesOk = Array.isArray(state.sales) && state.sales.length > 0;
                    const customersOk = Array.isArray(state.customers) && state.customers.length > 0;
                    const productsOk = Array.isArray(state.products) && state.products.length > 0;
                    // Ø¥Ø°Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¸Ù‡Ø±ØªØŒ Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ¹Ø§ÙÙŠ
                    if (salesOk || (customersOk && productsOk)) {
                        clearInterval(iv);
                        return;
                    }
                    // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª
                    console.warn('Realtime recovery attempt', attempts, 'â€” Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ setupRealtimeListeners');
                    setupRealtimeListeners();
                    // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒØ¯Ø¹Ù… Ù…Ø¤Ù‚Øª
                    try { preloadCachedCollections(); ensureCachedDataRendered(); } catch(e){}
                } catch(e){ console.warn('initRealtimeRecovery loop error', e); }
                if (attempts >= maxAttempts) {
                    clearInterval(iv);
                    console.warn('Realtime recovery stopped Ø¨Ø¹Ø¯ Ø¨Ù„ÙˆØº Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                }
            }, intervalMs);
        }

        /* ================================================================
           ğŸ“¦ Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Schema) Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ ÙÙŠ Firestore (ØªØ¯Ø±ÙŠØ¬ÙŠ)
           ---------------------------------------------------------------
           users: {
             uid (doc id), email, name, role, createdAt, lastLoginAt
           }
           customers: {
             id (doc id), name, phone, taxNumber, requiresTaxFiling, priceListId,
             balance (Ø§Ø®ØªÙŠØ§Ø±ÙŠ), createdAt, updatedAt
           }
           products: {
             id (doc id), name, sku, price, cost, unit, active, createdAt, updatedAt
           }
           sales: {
             id (doc id), invoiceNumber, customerId, repId/repName, items:[{productId, qty, price}],
             total, paidAmount, status (paid|partial|due|return), discountPercent,
             taxFilingStatus, date (ISO), createdAt, updatedAt
           }
           presence (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹): {
             uid (doc id), email, lastActive: serverTimestamp(), online: true
           }
           ---------------------------------------------------------------
           Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ CRUD Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
           Ø¯Ø§Ø®Ù„ state. Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø³ØªØµÙ„ Ù„Ø­Ø¸ÙŠØ§Ù‹ Ø¹Ø¨Ø± onSnapshot.
        ================================================================ */

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        function serverTs(){
            try { return firebase.firestore.FieldValue.serverTimestamp(); } catch(e){ return new Date(); }
        }

        // ===== CRUD: Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª =====
        async function addProduct(data){
            const obj = {
                name: data.name || '',
                sku: data.sku || data.id || Date.now().toString(),
                price: Number(data.price||0),
                vat_rate: Number(data.vat_rate||0),
                cost: Number(data.cost||0),
                unit: data.unit || 'ÙˆØ­Ø¯Ø©',
                active: data.active !== false,
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            return db.collection('products').add(obj);
        }
        async function updateProduct(id, partial){
            // ensure vat_rate is numeric if provided
            const patched = Object.assign({}, partial);
            if (patched.vat_rate !== undefined) patched.vat_rate = Number(patched.vat_rate) || 0;
            return db.collection('products').doc(id).set({ ...patched, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteProduct(id){ return db.collection('products').doc(id).delete(); }

        // ===== CRUD: Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =====
        async function addCustomer(data){
            // Local-first persistence: Ø§Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø£ÙŠ Ø§ØªØµØ§Ù„ Ø³Ø­Ø§Ø¨ÙŠ
            // Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ CLOUD_ONLY Ø£Ùˆ ÙØ´Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©
            const obj = {
                name: data.name || '',
                phone: data.phone || '',
                taxNumber: data.taxNumber || '',
                address: data.address || '',
                repName: data.repName || '',
                requiresTaxFiling: !!data.requiresTaxFiling,
                priceListId: data.priceListId || '',
                balance: Number(data.balance||0),
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ). Ø¥Ù† Ù„Ù… ÙŠÙØ­Ø¯Ù‘Ø¯ ÙŠØ¨Ù‚Ù‰ Ù…ØªØ§Ø­Ø§Ù‹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨.
                assignedRepId: (function(){
                    try {
                        if (data.assignedRepId) return data.assignedRepId;
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯ÙˆØ± Ù…Ù†Ø¯ÙˆØ¨ Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„Ù†ÙØ³Ù‡ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                        const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                        if (role === 'rep' && window.auth && auth.currentUser) return auth.currentUser.uid;
                        if (data.repName) {
                            const r = window.findRep ? window.findRep(data.repName) : null;
                            return r ? r.id : '';
                        }
                    } catch(e){}
                    return '';
                })(),
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            try {
                // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹
                if (!window.state) window.state = {};
                if (!Array.isArray(window.state.customers)) window.state.customers = [];
                const localId = obj.id || obj._id || (Date.now()+''+Math.random().toString(16).slice(2));
                const localObj = Object.assign({}, obj, { _id: localId });
                window.state.customers.push(localObj);
                // Ø­ÙØ¸ Ù‚Ø³Ø±ÙŠ ÙÙŠ LocalStorage Ù‚Ø¨Ù„ Ø£ÙŠ Ù†Ø¯Ø§Ø¡ Ø³Ø­Ø§Ø¨ÙŠ
                try { localStorage.setItem('customers', JSON.stringify(window.state.customers)); } catch(_){ /* ignore localStorage errors */ }
            } catch(e){ /* ignore state update errors */ }

            // Ø«Ù… Ù†ÙÙ‘Ø° Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯
            return db.collection('customers').add(obj);
        }
        async function updateCustomer(id, partial){
            const obj = { ...partial };
            try {
                if (!obj.assignedRepId && obj.repName) {
                    const r = window.findRep ? window.findRep(obj.repName) : null;
                    if (r) obj.assignedRepId = r.id;
                }
            } catch(e){}
            return db.collection('customers').doc(id).set({ ...obj, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteCustomer(id){ return db.collection('customers').doc(id).delete(); }

        // ===== CRUD: Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± =====
        async function addPriceListDoc(id, data){
            const ref = id ? db.collection('priceLists').doc(String(id)) : db.collection('priceLists').doc();
            const obj = {
                id: id || ref.id,
                name: data.name || '',
                productPrices: data.productPrices || {},
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            await ref.set(obj, { merge:false });
            return ref;
        }
        async function updatePriceListDoc(id, partial){
            return db.collection('priceLists').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
        }
        async function deletePriceListDoc(id){ return db.collection('priceLists').doc(String(id)).delete(); }

        // ===== CRUD: Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ =====
        async function addRepDoc(id, data){
            const ref = id ? db.collection('reps').doc(String(id)) : db.collection('reps').doc();
            const obj = {
                id: id || ref.id,
                name: data.name || '',
                serial: data.serial || '',
                target: Number(data.target||0),
                nextInvoiceNumber: data.nextInvoiceNumber || null,
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            await ref.set(obj, { merge:false });
            return ref;
        }
        async function updateRepDoc(id, partial){
            return db.collection('reps').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteRepDoc(id){ return db.collection('reps').doc(String(id)).delete(); }

        // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙŠØ±Ù‰ ÙˆÙŠØ¹Ø¯Ù‘Ù„ ÙÙ‚Ø· Ø¹Ù…Ù„Ø§Ø¤Ù‡ Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†ÙŠÙ†
        function canManageCustomer(c){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') return true;
                if (role === 'rep') {
                    if (!c) return false;
                    const assigned = c.assignedRepId || '';
                    if (!assigned) return true; // ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù† => Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹
                    const current = AuthSystem.getCurrentUser();
                    if (current && current.id === assigned) return true;
                    return false;
                }
                // Ø£Ø¯ÙˆØ§Ø± Ø£Ø®Ø±Ù‰ (viewer/user) Ù„ÙŠØ³ Ù„Ù‡Ø§ ØªØ¹Ø¯ÙŠÙ„ Ù„ÙƒÙ† Ù„Ø§ Ù†Ø­Ø¬Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹
                return true;
            } catch(e){ return true; }
        }
        // Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·. ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø§ ÙŠÙ‚Ø±Ø£ Ø£Ùˆ ÙŠØ¹Ø¯Ù‘Ù„ Ø¥Ù„Ø§ Ø¹Ù…Ù„Ø§Ø¡Ù‡.

        // ===== CRUD: Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª =====
        async function addSale(data){
                const obj = {
                id: data.id || undefined,
                invoiceNumber: data.invoiceNumber || null,
                customerId: data.customerId || null,
                repName: data.repName || data.repId || '',
                items: Array.isArray(data.items) ? data.items : [],
                // subtotal, taxAmount and withholdingAmount are optional but preferred for reporting
                // Ensure numeric fields are sanitized to avoid Firestore `undefined` errors
                subtotal: Number(data.subtotal) || 0,
                taxAmount: (data.taxAmount !== undefined) ? Number(data.taxAmount) : (data.vatAmount !== undefined ? Number(data.vatAmount) : 0),
                withholdingAmount: (data.withholdingAmount !== undefined) ? Number(data.withholdingAmount) : 0,
                total: Number(data.total) || 0,
                paidAmount: Number(data.paidAmount||0),
                status: data.status || 'due',
                discountPercent: Number(data.discountPercent||0),
                taxFilingStatus: data.taxFilingStatus || '',
                date: data.date || new Date().toISOString(),
                repEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
                repId: data.repId || null,
                createdBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
                // Admin-entry metadata (if saving on behalf of a rep)
                isAdminEntry: data.isAdminEntry === true,
                recordedByName: data.recordedByName || null,
                originalCreatorId: data.originalCreatorId || null,
                adminEntry: data.adminEntry === true,
                adminEnteredBy: data.adminEnteredBy || null,
                // Backwards-compatible admin flags for easy querying & UI
                created_by_admin: (data.created_by_admin === true) || (data.adminEntry === true) || (data.isAdminEntry === true),
                entry_source: (data.entry_source) ? data.entry_source : (data.adminEntry === true || data.isAdminEntry === true ? 'admin' : (data.entry_source || null)),
                createdAt: serverTs(),
                updatedAt: serverTs(),
                updatedBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null
            };
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // Ø§ÙØªØ±Ø§Ø¶: Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨/Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª => ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ ØºÙŠØ± Ø°Ù„Ùƒ ØªÙØ¹ØªØ¨Ø± Ù…ÙØ±Ø§Ø¬ÙØ¹Ø©
                if (role === 'sales' || role === 'rep') obj.reviewStatus = 'pending';
                else obj.reviewStatus = 'reviewed';
            } catch(_) { obj.reviewStatus = 'pending'; }

            // Ensure each item includes a `vat_rate` and then detect adjusted prices
            try {
                let anyAdjusted = false;
                obj.items = Array.isArray(obj.items) ? obj.items : [];
                // normalize vat_rate on each item from product master if missing
                obj.items = obj.items.map(it => {
                    try {
                        const item = Object.assign({}, it);
                        const prod = findProduct(item.productId) || {};
                        item.vat_rate = (item.vat_rate !== undefined && item.vat_rate !== null) ? Number(item.vat_rate) : (prod && prod.vat_rate ? Number(prod.vat_rate) : 0);
                        return item;
                    } catch(e){ return it; }
                });
                obj.items = obj.items.map(it => {
                    try {
                        const item = Object.assign({}, it);
                        const prod = findProduct(item.productId) || {};
                        let expectedPrice = (prod.price != null) ? Number(prod.price) : 0;
                        try {
                            const customer = findCustomer(obj.customerId);
                            if (customer && customer.priceListId) {
                                const pl = findPriceList(customer.priceListId);
                                if (pl && pl.productPrices && pl.productPrices[item.productId] !== undefined) expectedPrice = Number(pl.productPrices[item.productId]);
                            }
                        } catch(_){ }
                        try {
                            const promo = getActivePromotionPrice(item.productId, obj.customerId);
                            if (promo !== null && promo !== undefined) expectedPrice = Number(promo);
                        } catch(_){ }
                        const entered = Number(item.price) || 0;
                        const diff = Math.abs(entered - (Number(expectedPrice) || 0));
                        if (diff > 0.005) {
                            item.adjusted = true;
                            anyAdjusted = true;
                        } else {
                            item.adjusted = item.adjusted === true;
                        }
                        item.expectedPrice = expectedPrice;
                        return item;
                    } catch(e){ return it; }
                });
                if (anyAdjusted) {
                    obj.reviewReason = 'adjusted';
                    obj.reviewStatus = 'pending';
                    try { obj.reviewRequestedBy = (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : null; } catch(_){ }
                    obj.reviewRequestedAt = new Date().toISOString();
                    console.log('addSale: detected adjusted prices, marking reviewReason=adjusted', { id: obj.id, invoiceNumber: obj.invoiceNumber });
                }
            } catch(e){ console.warn('addSale: adjusted-detection failed', e); }
            const ref = data && data.id
                ? db.collection('sales').doc(String(data.id))
                : db.collection('sales').doc();
            if (!data.id) obj.id = ref.id;
            try {
                console.log('addSale: writing doc', obj.id, 'invoice:', obj.invoiceNumber);
                await ref.set(obj, { merge: false });
                console.log('addSale: write success', obj.id);
            } catch (e) {
                console.warn('addSale: write failed', e);
                // If this is a permission error and the user is an admin, try fallback paths
                const msg = (e && e.message) ? String(e.message).toLowerCase() : '';
                const code = e && e.code ? e.code : null;
                const isPerm = (code === 'permission-denied' || (typeof code === 'string' && code.toLowerCase().includes('permission'))) || msg.includes('permission') || msg.includes('insufficient');
                if (isPerm) {
                    try {
                        // Try writing to a project-level `invoices` collection as fallback
                        const invoicesRef = db.collection('invoices').doc(obj.id);
                        await invoicesRef.set(obj, { merge: false });
                        console.log('addSale: fallback write success to invoices/', obj.id);
                        // update local ref variable so callers receive a docref-like value
                        ref = invoicesRef;
                    } catch (e2) {
                        console.warn('addSale: fallback to invoices failed', e2);
                        // Try per-user invoices subcollection if repId exists
                        if (obj.repId) {
                            try {
                                const userInvRef = db.collection('users').doc(String(obj.repId)).collection('invoices').doc(obj.id);
                                await userInvRef.set(obj, { merge: false });
                                console.log('addSale: fallback write success to users/{repId}/invoices/', obj.id);
                                ref = userInvRef;
                            } catch (e3) {
                                console.warn('addSale: fallback to users/{repId}/invoices failed', e3);
                                // All fallbacks failed â€” rethrow the original permission error for upstream handling
                                throw e;
                            }
                        } else {
                            // No repId to try per-user path â€” rethrow original
                            throw e;
                        }
                    }
                } else {
                    throw e;
                }
            }
            // Update local cache immediately to survive refresh when reads are blocked
            try { upsertCachedSale(Object.assign({}, obj, { _id: obj.id })); } catch(e){}
            // Optional: update UI quickly if snapshots are blocked
            try {
                if (!window.state) window.state = {};
                if (!Array.isArray(state.sales)) state.sales = [];
                const exists = state.sales.some(s => (s.id||s._id) === obj.id);
                if (!exists) state.sales.unshift(Object.assign({}, obj));
                const textFilter = document.getElementById('search-sales-text')?.value || '';
                const dateFilter = document.getElementById('search-sales-date')?.value || '';
                const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                if (typeof renderDashboard === 'function') renderDashboard();
            } catch(e){}
            return ref;
        }
        // ===== CRUD: Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ (dispatchNotes) =====
        async function addDispatchNote(data){
            const base = {
                noteNumber: data.noteNumber || null,
                repName: data.repName || '',
                date: data.date || new Date().toISOString(),
                items: Array.isArray(data.items) ? data.items : [],
                createdAt: serverTs(),
                updatedAt: serverTs(),
                createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null
            };
            const ref = data && data.id ? db.collection('dispatchNotes').doc(String(data.id)) : db.collection('dispatchNotes').doc();
            if (!data.id) base.id = ref.id; else base.id = data.id;
            await ref.set(base, { merge:false });
            // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠØµÙ„ Ø§Ù„Ø³napshot Ø¨Ø¹Ø¯
            try {
                if (!state.dispatchNotes) state.dispatchNotes = [];
                const exists = state.dispatchNotes.some(n => (n.id||n._id) === base.id);
                if (!exists) state.dispatchNotes.unshift(Object.assign({}, base));
                if (typeof renderDispatchPage === 'function') renderDispatchPage();
            } catch(e){}
            return ref;
        }
        async function updateDispatchNote(id, partial){
            const meta = { updatedAt: serverTs() };
            await db.collection('dispatchNotes').doc(id).set({ ...partial, ...meta }, { merge:true });
            try {
                if (Array.isArray(state.dispatchNotes)){
                    const i = state.dispatchNotes.findIndex(n => (n.id||n._id) === id);
                    if (i>=0) state.dispatchNotes[i] = Object.assign({}, state.dispatchNotes[i], partial, { id });
                    if (typeof renderDispatchPage === 'function') renderDispatchPage();
                }
            } catch(e){}
        }
        async function deleteDispatchNote(id){
            await db.collection('dispatchNotes').doc(id).delete();
            try {
                state.dispatchNotes = (state.dispatchNotes||[]).filter(n => (n.id||n._id) !== id);
                if (typeof renderDispatchPage === 'function') renderDispatchPage();
            } catch(e){}
        }
        async function updateSale(id, partial){
            // Ù…Ù†Ø¹ ØªØ¹Ø¯ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø¶Ù…Ù† Ø´Ù‡Ø± Ù…Ù‚ÙÙˆÙ„
            try {
                if (Array.isArray(state.sales)){
                    const s = state.sales.find(x => (x.id||x._id) === id);
                    if (s && (s.locked === true || (s.lockPeriod && String(s.lockPeriod).length))) {
                        alert('Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¶Ù…Ù† Ø´Ù‡Ø± Ù…Ù‚ÙÙˆÙ„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§');
                        throw new Error('sale-locked');
                    }
                }
            } catch(e){}
            const meta = { updatedAt: serverTs() };
            try { if (window.auth && auth.currentUser) meta.updatedBy = auth.currentUser.uid; } catch(e){}
            await db.collection('sales').doc(id).set({ ...partial, ...meta }, { merge:true });
            // Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§Ù†Ø³Ø®/Ø§ÙƒØªØ¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = (typeof AuthSystem !== 'undefined' && AuthSystem.getCurrentUser) ? AuthSystem.getCurrentUser() : null;
                // Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
                let targetRepName = null;
                try {
                    const existing = Array.isArray(state.sales) ? state.sales.find(x => (x.id||x._id) === id) : null;
                    targetRepName = (partial && partial.repName) ? String(partial.repName) : (existing && existing.repName ? String(existing.repName) : null);
                } catch(_){}
                if (role === 'admin' && current && targetRepName) {
                    // Find rep's actual Firebase Auth UID from state.users by matching email
                    let repUid = null;
                    try {
                        const rep = (state.reps||[]).find(r => r.name === targetRepName);
                        const repEmail = rep && rep.email ? String(rep.email).toLowerCase() : null;
                        if (repEmail && Array.isArray(state.users)) {
                            const userDoc = state.users.find(u => (u.email || '').toLowerCase() === repEmail);
                            repUid = userDoc ? (userDoc.uid || userDoc._id || userDoc.id) : null;
                        }
                    } catch(e){ console.warn('Failed to find rep uid in updateSale:', e); }
                    
                    if (repUid && String(current.id) !== String(repUid)) {
                        const docDataSnap = await db.collection('sales').doc(id).get();
                        const mergedData = Object.assign({}, (docDataSnap.exists ? (docDataSnap.data()||{}) : {}), partial, meta, { id });
                        // ÙƒØªØ§Ø¨Ø©/Ù†Ø³Ø® Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ù‡
                        await db.collection('users').doc(String(repUid)).collection('invoices').doc(String(id)).set(mergedData, { merge: true });
                        try { console.log('ğŸ” Admin updated sale copied to user subcollection:', { repName: targetRepName, repUid, id }); } catch(_){ }
                    }
                }
            } catch(e){ console.warn('updateSale: admin sync to users/{repId}/invoices failed', e); }
            try {
                const list = getCachedSales();
                const idx = list.findIndex(s => (s.id||s._id) === id);
                if (idx >= 0) {
                    list[idx] = Object.assign({}, list[idx], partial, { id, _id: id });
                    setCachedSales(list);
                }
            } catch(e){}
            // Soft update UI if snapshots are blocked
            try {
                if (Array.isArray(state.sales)){
                    const i = state.sales.findIndex(s => (s.id||s._id) === id);
                    if (i >= 0) state.sales[i] = Object.assign({}, state.sales[i], partial, { id });
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    if (typeof renderDashboard === 'function') renderDashboard();
                }
            } catch(e){}
        }
        async function deleteSale(id){
            await db.collection('sales').doc(id).delete();
            try { removeCachedSale(id); } catch(e){}
            try {
                if (Array.isArray(state.sales)){
                    state.sales = state.sales.filter(s => (s.id||s._id) !== id);
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    if (typeof renderDashboard === 'function') renderDashboard();
                }
            } catch(e){}
        }

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„ØªØ±Ù‚ÙŠØ§Øª ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ state.*.push ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„.

        // ===== Seeding: Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Admin/First-time) =====
        async function seedDefaultsIfEmpty(){
            try {
                if (!window.db) return;
                // ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª: Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø²Ø±Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯ÙˆØ± 'admin' Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹ (ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„)
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const [custSnap, plSnap] = await Promise.all([
                    db.collection('customers').limit(1).get(),
                    db.collection('priceLists').limit(1).get()
                ]);
                // Ø¥Ø°Ø§ Ù„ÙŠØ³ Admin ÙˆØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¡
                if (custSnap && !custSnap.empty && plSnap && !plSnap.empty) return;
                if (role !== 'admin' && !(custSnap.empty && plSnap.empty)) return;

                console.log('Seeding default data: customers, products, priceLists');

                const batch = db.batch();

                // Ù…Ù†ØªØ¬Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ù…Ø¹Ø±Ù‘ÙØ§Øª Ø«Ø§Ø¨ØªØ© Ù„Ø¶Ø¨Ø· Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¹Ù„ÙŠÙ‡Ø§
                const products = [
                    { id: 'P001', name: 'Ù…Ù†ØªØ¬ 1', sku: 'SKU-001', price: 100, cost: 70, unit: 'Ù‚Ø·Ø¹Ø©' },
                    { id: 'P002', name: 'Ù…Ù†ØªØ¬ 2', sku: 'SKU-002', price: 150, cost: 110, unit: 'Ù‚Ø·Ø¹Ø©' },
                    { id: 'P003', name: 'Ù…Ù†ØªØ¬ 3', sku: 'SKU-003', price: 200, cost: 140, unit: 'Ù‚Ø·Ø¹Ø©' }
                ];
                products.forEach(p => {
                    const ref = db.collection('products').doc(p.id);
                    batch.set(ref, {
                        name: p.name,
                        sku: p.sku,
                        price: Number(p.price||0),
                        cost: Number(p.cost||0),
                        unit: p.unit || 'ÙˆØ­Ø¯Ø©',
                        active: true,
                        createdAt: serverTs(),
                        updatedAt: serverTs()
                    }, { merge: true });
                });

                // Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± Ø¨Ù…Ø¹Ø±Ù‘ÙØ§Øª Ù…ÙÙ‡ÙˆÙ…Ø© (retail / wholesale) Ù…Ø¹ Ø®Ø±ÙŠØ·Ø© Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ø¹Ù„Ø§Ù‡
                const retailPrices = { P001: 100, P002: 150, P003: 200 };
                const wholesalePrices = { P001: 90, P002: 135, P003: 180 };

                const plRetailRef = db.collection('priceLists').doc('retail');
                batch.set(plRetailRef, {
                    name: 'Ù‚Ø·Ø§Ø¹ÙŠ (retail)',
                    productPrices: retailPrices,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });

                const plWholesaleRef = db.collection('priceLists').doc('wholesale');
                batch.set(plWholesaleRef, {
                    name: 'Ø¬Ù…Ù„Ø© (wholesale)',
                    productPrices: wholesalePrices,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });

                // Ø¹Ù…Ù„Ø§Ø¡ Ø§ÙØªØ±Ø§Ø¶ÙŠÙˆÙ† Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                const customers = [
                    { id: 'CUST001', name: 'Ø¹Ù…ÙŠÙ„ Ù‚Ø·Ø§Ø¹ÙŠ 1', phone: '01000000001', priceListId: 'retail', requiresTaxFiling: false },
                    { id: 'CUST002', name: 'Ø¹Ù…ÙŠÙ„ Ø¬Ù…Ù„Ø© 1',  phone: '01000000002', priceListId: 'wholesale', requiresTaxFiling: true },
                    { id: 'CUST003', name: 'Ø¹Ù…ÙŠÙ„ Ù‚Ø·Ø§Ø¹ÙŠ 2', phone: '01000000003', priceListId: 'retail', requiresTaxFiling: false }
                ];
                customers.forEach(c => {
                    const ref = db.collection('customers').doc(c.id);
                    batch.set(ref, {
                        name: c.name,
                        phone: c.phone || '',
                        taxNumber: '',
                        requiresTaxFiling: !!c.requiresTaxFiling,
                        priceListId: c.priceListId,
                        balance: 0,
                        createdAt: serverTs(),
                        updatedAt: serverTs()
                    }, { merge: true });
                });

                await batch.commit();
                console.log('âœ… Seeding complete');
                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                // Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø°Ø± Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                try { initLegacyCollectionsIfEmpty(); } catch(e){}
            } catch (e) {
                console.warn('Seeding failed', e);
            }
        }

        // ===== ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø­ØªÙ…Ù„Ø© (Customers / PriceLists / price_lists) =====
        async function initLegacyCollectionsIfEmpty(){
            if (!window.db) return;
            const needCustomers = !state.customers || state.customers.length === 0;
            const needPriceLists = !state.priceLists || state.priceLists.length === 0;
            if (!needCustomers && !needPriceLists) return;
            console.log('Checking legacy collection names for data...');
            const tasks = [];
            if (needCustomers) tasks.push(db.collection('Customers').get().catch(()=>null));
            if (needCustomers) tasks.push(db.collection('customers_old').get().catch(()=>null));
            if (needPriceLists) tasks.push(db.collection('PriceLists').get().catch(()=>null));
            if (needPriceLists) tasks.push(db.collection('price_lists').get().catch(()=>null));
            const results = await Promise.all(tasks);
            results.forEach(snapshot => {
                if (!snapshot || snapshot.empty) return;
                const firstDoc = snapshot.docs[0];
                const collName = firstDoc && firstDoc.ref && firstDoc.ref.parent && firstDoc.ref.parent.id;
                if (!collName) return;
                if (['Customers','customers_old'].includes(collName)) {
                    const arr = []; snapshot.forEach(doc=>{ const d = doc.data(); d._legacy = true; d._id = doc.id; arr.push(d); });
                    if (arr.length > 0 && (!state.customers || state.customers.length === 0)) {
                        state.customers = arr;
                        console.log('Imported legacy customers from', collName, 'count=', arr.length);
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                    }
                }
                if (['PriceLists','price_lists'].includes(collName)) {
                    const arr = []; snapshot.forEach(doc=>{ const d = doc.data(); d._legacy = true; d.id = doc.id; arr.push(d); });
                    if (arr.length > 0 && (!state.priceLists || state.priceLists.length === 0)) {
                        state.priceLists = arr;
                        console.log('Imported legacy priceLists from', collName, 'count=', arr.length);
                        try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                    }
                }
            });
        }

        // ===== Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ + Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±) Ù…Ø¹ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© =====
        async function ensureCoreData(){
            if (!db) return;
            if (window.__coreDataEnsured) return;
            const needCustomers = !state.customers || state.customers.length === 0;
            const needPriceLists = !state.priceLists || state.priceLists.length === 0;
            const needProducts = !state.products || state.products.length === 0;
            const needReps = !state.reps || state.reps.length === 0;
            if (!needCustomers && !needPriceLists && !needProducts && !needReps) { window.__coreDataEnsured = true; return; }
            console.log('ensureCoreData: Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©');
            try {
                // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ø£ÙˆÙ„Ø§Ù‹ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙØ§Ø±ØºØ© ÙØ¹Ù„Ø§Ù‹) Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
                try { await importEmbeddedBackupIfNeeded(); } catch(e){ console.warn('importEmbeddedBackupIfNeeded early call failed', e); }
                const [custSnap, plSnap, prodSnap, repsSnap] = await Promise.all([
                    needCustomers ? db.collection('customers').get() : Promise.resolve(null),
                    needPriceLists ? db.collection('priceLists').get() : Promise.resolve(null),
                    needProducts ? db.collection('products').get() : Promise.resolve(null),
                    needReps ? db.collection('reps').get() : Promise.resolve(null)
                ]);
                if (custSnap && !custSnap.empty) {
                    const arr = [];
                    custSnap.forEach(doc => {
                        const d = doc.data();
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    state.customers = arr; console.log('ensureCoreData: customers fetched =', arr.length);
                    try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                    try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                }
                if (plSnap && !plSnap.empty) {
                    const arr = []; plSnap.forEach(doc => {
                        const d = doc.data() || {};
                        const pl = { id: doc.id, name: d.name || d.title || doc.id, productPrices: {} };
                        if (d.productPrices && typeof d.productPrices === 'object') pl.productPrices = d.productPrices;
                        else if (d.prices && typeof d.prices === 'object') pl.productPrices = d.prices;
                        else if (d.map && typeof d.map === 'object') pl.productPrices = d.map;
                        else {
                            const pp = {}; Object.keys(d).forEach(k => { if (/^\d+$/.test(k) && typeof d[k] === 'number') pp[k] = d[k]; });
                            pl.productPrices = pp;
                        }
                        arr.push(pl);
                    });
                    state.priceLists = arr; console.log('ensureCoreData: priceLists fetched =', arr.length);
                    try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                    try { updateAllPriceListDropdowns(); } catch(e){}
                    // Ø£Ø¹ÙØ¯Ù‘ Ø±Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø£Ù† Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ priceListId
                    try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                }
                if (prodSnap && !prodSnap.empty) {
                    const arr = [];
                    prodSnap.forEach(doc => {
                        const d = doc.data();
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    state.products = arr; console.log('ensureCoreData: products fetched =', arr.length);
                    try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                }
                if (repsSnap && !repsSnap.empty) {
                    const arr = []; repsSnap.forEach(doc => { const d = doc.data(); d.id = doc.id; arr.push(d); });
                    state.reps = arr; console.log('ensureCoreData: reps fetched =', arr.length);
                    try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
                }
            } catch(e){ console.warn('ensureCoreData: ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©', e); }

            // Ø¥Ø°Ø§ Ù„Ø§ ØªØ²Ø§Ù„ ÙØ§Ø±ØºØ© Ù†Ø­Ø§ÙˆÙ„ Ø£Ø³Ù…Ø§Ø¡ Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆÙ†Ù†Ø³Ø® Ù„Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Ù†Ø§Ù‡Ø§
            const stillNeedCust = !state.customers || state.customers.length === 0;
            const stillNeedPL = !state.priceLists || state.priceLists.length === 0;
            if (stillNeedCust || stillNeedPL) {
                console.log('ensureCoreData: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø¨Ø± Ø£Ø³Ù…Ø§Ø¡ Legacy Ù…Ø¨Ø§Ø´Ø±Ø©');
                try {
                    if (stillNeedCust) {
                        const legacyCustNames = ['Customers','customers_old'];
                        for (const cname of legacyCustNames) {
                            try {
                                const snap = await db.collection(cname).get();
                                if (!snap.empty) {
                                    const batch = db.batch(); const arr=[];
                                    snap.forEach(doc => { const d=doc.data(); d._legacy=true; d._id=doc.id; arr.push(d); const ref=db.collection('customers').doc(doc.id); batch.set(ref, { name:d.name||'', phone:d.phone||'', taxNumber:d.taxNumber||'', requiresTaxFiling:!!d.requiresTaxFiling, priceListId:d.priceListId||'', balance:Number(d.balance||0), createdAt: d.createdAt||serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                    await batch.commit();
                                    state.customers = arr; console.log('ensureCoreData: imported legacy customers from', cname, 'count=', arr.length);
                                    try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                                    break;
                                }
                            } catch(err){ /* ignore */ }
                        }
                    }
                    if (stillNeedPL) {
                        const legacyPLNames = ['PriceLists','price_lists'];
                        for (const cname of legacyPLNames) {
                            try {
                                const snap = await db.collection(cname).get();
                                if (!snap.empty) {
                                    const batch = db.batch(); const arr=[];
                                    snap.forEach(doc => { const d=doc.data(); d._legacy=true; d.id=doc.id; arr.push(d); const ref=db.collection('priceLists').doc(doc.id); batch.set(ref, { name: d.name||d.title||'Ù‚Ø§Ø¦Ù…Ø©', productPrices: d.productPrices||d.prices||{}, createdAt: d.createdAt||serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                    await batch.commit();
                                    state.priceLists = arr; console.log('ensureCoreData: imported legacy priceLists from', cname, 'count=', arr.length);
                                    try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                    try { updateAllPriceListDropdowns(); } catch(e){}
                                    break;
                                }
                            } catch(err){ /* ignore */ }
                        }
                    }
                } catch(e){ console.warn('ensureCoreData legacy phase error', e); }
            }

            // Ù…Ø±Ø­Ù„Ø© Ø£Ø®ÙŠØ±Ø©: Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ù† Ù…Ø§ Ø²Ø§Ù„ ÙØ§Ø±Øº
            const finalNeedCust = !state.customers || state.customers.length === 0;
            const finalNeedPL = !state.priceLists || state.priceLists.length === 0;
            const finalNeedProd = !state.products || state.products.length === 0;
            if (finalNeedCust || finalNeedPL || finalNeedProd) {
                console.log('ensureCoreData: Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                try {
                    const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('app_state_backup_')).sort();
                    if (backupKeys.length) {
                        const latest = localStorage.getItem(backupKeys[backupKeys.length-1]);
                        if (latest) {
                            const parsed = JSON.parse(latest);
                            const batch = db.batch();
                            if (finalNeedCust && Array.isArray(parsed.customers) && parsed.customers.length) {
                                parsed.customers.forEach(c => { if (!c || !c.name) return; const id = c.id || c._id || c.name.replace(/\s+/g,'_'); const ref=db.collection('customers').doc(id); batch.set(ref,{ name:c.name, phone:c.phone||'', taxNumber:c.taxNumber||'', requiresTaxFiling:!!c.requiresTaxFiling, priceListId:c.priceListId||'', balance:Number(c.balance||0), createdAt: serverTs(), updatedAt: serverTs() },{ merge:true}); });
                                state.customers = parsed.customers.map(c => ({...c, _id: c.id||c._id||c.name.replace(/\s+/g,'_')}));
                            }
                            if (finalNeedPL && Array.isArray(parsed.priceLists) && parsed.priceLists.length) {
                                parsed.priceLists.forEach(pl => { if (!pl || !pl.name) return; const id = pl.id || pl.name.replace(/\s+/g,'_'); const ref=db.collection('priceLists').doc(id); batch.set(ref,{ name: pl.name, productPrices: pl.productPrices||{}, createdAt: serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                state.priceLists = parsed.priceLists.map(pl => ({...pl, id: pl.id||pl.name.replace(/\s+/g,'_')}));
                            }
                            if (finalNeedProd && Array.isArray(parsed.products) && parsed.products.length) {
                                parsed.products.forEach(p => { if (!p || !p.name) return; const id = p.id || p._id || p.sku || p.name.replace(/\s+/g,'_'); const ref=db.collection('products').doc(id); batch.set(ref,{ name:p.name, sku:p.sku||id, price:Number(p.price||0), cost:Number(p.cost||p.price||0), unit:p.unit||'ÙˆØ­Ø¯Ø©', active:p.active!==false, createdAt: serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                state.products = parsed.products.map(p => ({...p, _id: p.id||p._id||p.sku||p.name.replace(/\s+/g,'_')}));
                            }
                            if (!batch._ops || batch._ops.length) { await batch.commit(); }
                            if (state.customers && state.customers.length) { try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){} }
                            if (state.priceLists && state.priceLists.length) { try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){} try { updateAllPriceListDropdowns(); } catch(e){} }
                            if (state.products && state.products.length) { try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){} }
                            console.log('ensureCoreData: Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…ÙƒØªÙ…Ù„');
                        }
                    }
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ©: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø­ØªÙ…Ù„Ø© Ø¥Ø°Ø§ Ù„Ø§ Ø²Ø§Ù„ Ù†Ø§Ù‚Øµ
                    const stillNeedAfterBackupCust = !state.customers || state.customers.length === 0;
                    const stillNeedAfterBackupPL = !state.priceLists || state.priceLists.length === 0;
                    const stillNeedAfterBackupProd = !state.products || state.products.length === 0;
                    if (stillNeedAfterBackupCust || stillNeedAfterBackupPL || stillNeedAfterBackupProd){
                        const legacyRecovered = recoverLegacyLocalData();
                        const batch2 = db.batch();
                        if (stillNeedAfterBackupProd && legacyRecovered.products.length){
                            legacyRecovered.products.forEach(p => {
                                if (!p || !p.name) return; const id = p.id || p._id || p.sku || slugId(p.name);
                                batch2.set(db.collection('products').doc(id), {
                                    name: p.name || p.title || 'Ù…Ù†ØªØ¬',
                                    sku: p.sku || p.code || id,
                                    price: Number(p.price || p.unitPrice || 0),
                                    cost: Number(p.cost || p.purchaseCost || p.price || 0),
                                    unit: p.unit || 'ÙˆØ­Ø¯Ø©',
                                    active: p.active !== false,
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.products = legacyRecovered.products.map(p => ({
                                _id: p.id || p._id || p.sku || slugId(p.name),
                                name: p.name || p.title || 'Ù…Ù†ØªØ¬',
                                sku: p.sku || p.code || (p.id || ''),
                                price: Number(p.price || p.unitPrice || 0),
                                cost: Number(p.cost || p.purchaseCost || p.price || 0),
                                unit: p.unit || 'ÙˆØ­Ø¯Ø©',
                                active: p.active !== false
                            }));
                        }
                        if (stillNeedAfterBackupPL && legacyRecovered.priceLists.length){
                            legacyRecovered.priceLists.forEach(pl => {
                                const id = pl.id || pl.code || slugId(pl.name,'pl_'+Date.now());
                                batch2.set(db.collection('priceLists').doc(id), {
                                    name: pl.name || pl.title || 'Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±',
                                    productPrices: pl.productPrices || pl.prices || pl.map || {},
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.priceLists = legacyRecovered.priceLists.map(pl => ({
                                id: pl.id || pl.code || slugId(pl.name),
                                name: pl.name || pl.title || 'Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±',
                                productPrices: pl.productPrices || pl.prices || pl.map || {}
                            }));
                        }
                        const hasCustNow = state.customers && state.customers.length;
                        if (stillNeedAfterBackupCust && !hasCustNow && legacyRecovered.customers && legacyRecovered.customers.length){
                            legacyRecovered.customers.forEach(c => {
                                if (!c || !c.name) return; const id = c.id || c._id || slugId(c.name);
                                batch2.set(db.collection('customers').doc(id), {
                                    name: c.name,
                                    phone: c.phone || '',
                                    taxNumber: c.taxNumber || '',
                                    requiresTaxFiling: !!c.requiresTaxFiling,
                                    priceListId: c.priceListId || '',
                                    balance: Number(c.balance || 0),
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.customers = legacyRecovered.customers.map(c => ({...c, _id: c.id || c._id || slugId(c.name)}));
                        }
                        if (batch2._mutations && batch2._mutations.length){
                            await batch2.commit();
                            console.log('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Ù…Ø­Ù„ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©');
                        }
                        if (state.products && state.products.length){ try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){} }
                        if (state.priceLists && state.priceLists.length){ try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){} try { updateAllPriceListDropdowns(); } catch(e){} }
                        if (state.customers && state.customers.length){ try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){} }
                    }
                    // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù (Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©)
                    let needAfterAllPL = !state.priceLists || state.priceLists.length === 0;
                    if (needAfterAllPL && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025) && window.EMBEDDED_PRICE_LISTS_BACKUP_2025.length){
                        try {
                            const res = await importBackupObject({ priceLists: window.EMBEDDED_PRICE_LISTS_BACKUP_2025 }, {
                                importCustomers:false, importProducts:false, importPriceLists:true,
                                importSales:false, importReps:false, importPromotions:false,
                                importSettings:false, importDispatchNotes:false, importStockEntries:false, importNotifications:false
                            });
                            if (res && res.ok && res.counts && res.counts.priceLists > 0){
                                console.log('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©:', res.counts.priceLists);
                                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                try { updateAllPriceListDropdowns(); } catch(e){}
                            }
                        } catch(e){ console.warn('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©', e); }
                        needAfterAllPL = !state.priceLists || state.priceLists.length === 0;
                    }

                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ø¬Ù„Ø¨ Ù…Ù† Ù…Ù„Ù HTML Ù‚Ø¯ÙŠÙ… ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ (1458.html)
                    if (needAfterAllPL) {
                        try {
                            const imported = await importPriceListsFromLegacyHtmlFile('1458.html');
                            if (imported > 0) {
                                console.log('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† 1458.html:', imported);
                                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                try { updateAllPriceListDropdowns(); } catch(e){}
                            } else {
                                console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± Ø¯Ø§Ø®Ù„ 1458.htmlØ› ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ window.importPriceListsFromLocalFile() Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§');
                            }
                        } catch(e){ console.warn('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† 1458.html', e); }
                    }
                } catch(e){ console.warn('ensureCoreData local backup phase error', e); }
            }
            if (state.customers && state.customers.length && state.priceLists && state.priceLists.length && state.products && state.products.length && state.reps && state.reps.length) window.__coreDataEnsured = true;
        }
        function scheduleEnsureCoreData(){
            setTimeout(ensureCoreData, 1500);
            // ØªØ´ØºÙŠÙ„ Ù‡Ø¬Ø±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù† ÙˆÙØ¬Ø¯Øª) Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù‚Ù„ÙŠÙ„
            setTimeout(function(){ try { migrateSalesFromUserDocIfFound(); } catch(e){} }, 3000);
            // Ø­Ù…Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø´ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
            setTimeout(function(){ try { if (typeof window.loadCashFromCloud === 'function') window.loadCashFromCloud(); } catch(e){ console.warn('loadCashFromCloud on startup failed', e); } }, 2500);
            setTimeout(ensureCoreData, 5000);
            setTimeout(ensureCoreData, 12000);
        }

        // ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† shared/public_app_state.appState Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª) =====
        function slugId(name, fallback){
            try { return (name||'').toString().trim().toLowerCase().replace(/[^a-z0-9\u0600-\u06FF]+/gi,'_').replace(/^_+|_+$/g,'') || fallback || (Date.now()+'');} catch(e){ return fallback || (Date.now()+''); }
        }
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø´Ø§Ù…Ù„ Ù…Ù† Ù…ÙØ§ØªÙŠØ­ localStorage Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© (Ù…Ù†ØªØ¬Ø§Øª / Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± / Ø¹Ù…Ù„Ø§Ø¡)
        function recoverLegacyLocalData(){
            const possibleProductKeys = [ 'products','product_list','app_products','products_data','finished_products','cost_finished' ];
            const possiblePriceListKeys = [ 'priceLists','price_lists','app_priceLists','priceListsData','price_lists_data','pricing_tables' ];
            const possibleCustomerKeys = [ 'customers','customer_list','app_customers','customers_data' ];
            const products = [];
            const priceLists = [];
            const customers = [];
            function tryParse(key){
                try { const raw = localStorage.getItem(key); if (!raw) return null; return JSON.parse(raw); } catch(e){ return null; }
            }
            possibleProductKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(p => { if (p && (p.name||p.title)) products.push(p); }); }
                else if (typeof val === 'object') { Object.keys(val).forEach(id => { const p=val[id]; if (p && (p.name||p.title)) products.push(Object.assign({ id }, p)); }); }
            });
            possiblePriceListKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(pl => { if (pl && (pl.name||pl.title)) priceLists.push(pl); }); }
                else if (typeof val === 'object') {
                    const looksMap = Object.values(val).every(v => typeof v === 'number');
                    if (looksMap) priceLists.push({ name: 'Legacy List', productPrices: val });
                    else Object.keys(val).forEach(id => { const pl=val[id]; if (pl && (pl.name||pl.title)) priceLists.push(Object.assign({ id }, pl)); else if (pl && typeof pl==='object' && Object.values(pl).every(v=>typeof v==='number')) priceLists.push({ id, name:id, productPrices: pl }); });
                }
            });
            possibleCustomerKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(c => { if (c && c.name) customers.push(c); }); }
                else if (typeof val === 'object') { Object.keys(val).forEach(id => { const c=val[id]; if (c && c.name) customers.push(Object.assign({ id }, c)); }); }
            });
            console.log('recoverLegacyLocalData: products=', products.length, 'priceLists=', priceLists.length, 'customers=', customers.length);
            return { products, priceLists, customers };
        }
        // ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ù…Ù„Ù HTML Ù‚Ø¯ÙŠÙ… (Ù…Ø«Ù„Ø§Ù‹ 1458.html) =====
        function normalizePriceListsArray(arr){
            try {
                if (!Array.isArray(arr)) return [];
                return arr.map(pl => ({
                    id: pl.id || pl.code || slugId(pl.name, undefined),
                    name: pl.name || pl.title || 'Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±',
                    productPrices: pl.productPrices || pl.prices || pl.map || {}
                })).filter(pl => pl && pl.name && pl.productPrices && typeof pl.productPrices === 'object');
            } catch(e){ return []; }
        }

        function tryParseJsonLoose(text){
            try { return JSON.parse(text); } catch(e) {}
            try { return JSON.parse(text.replace(/\,\s*}/g,'}').replace(/\,\s*]/g,']')); } catch(e) {}
            try {
                // replace single quotes cautiously (only around keys/strings)
                const t = text.replace(/"/g,'\"').replace(/'([^']*)'/g,'"$1"');
                return JSON.parse(t);
            } catch(e) { return null; }
        }

        // ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        window.EMBEDDED_PRICE_LISTS_BACKUP_2025 = [];
        window.EMBEDDED_FULL_BACKUP = { customers:[], products:[], priceLists:[], reps:[], promotions:[], sales:[] };
        async function importEmbeddedBackupIfNeeded(){ return { ok:true, disabled:true }; }
        // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨.

        // ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© (JSON) Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© =====
        async function importBackupObject(backup, options){
            const opts = Object.assign({
                importCustomers: true,
                importProducts: true,
                importPriceLists: true,
                importSales: true,
                importReps: true,
                importPromotions: true,
                importSettings: true,
                importDispatchNotes: true,
                importStockEntries: true,
                importNotifications: true
            }, options||{});
            if (!db) { console.warn('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø²'); return { ok:false, reason:'no-db' }; }
            const counts = { customers:0, products:0, priceLists:0, sales:0, reps:0, promotions:0, settings:0, dispatchNotes:0, stockEntries:0, notifications:0 };
            let batch = db.batch();
            let pending = 0;
            async function commitIfNeeded(force){ if (force || pending >= 450) { await batch.commit(); batch = db.batch(); pending = 0; } }

            try {
                if (opts.importCustomers && Array.isArray(backup.customers)){
                    for (const c of backup.customers){
                        const id = c.id || slugId(c.name);
                        const ref = db.collection('customers').doc(id);
                        batch.set(ref, {
                            name: c.name || '',
                            phone: c.phone || '',
                            taxNumber: c.taxNumber || '',
                            requiresTaxFiling: !!c.requiresTaxFiling,
                            priceListId: c.priceListId || '',
                            repName: c.repName || '',
                            address: c.address || '',
                            createdAt: c.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.customers++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importProducts && Array.isArray(backup.products)){
                    for (const p of backup.products){
                        const id = (p.id || slugId(p.name)).toString();
                        const ref = db.collection('products').doc(id);
                        batch.set(ref, {
                            name: p.name || '',
                            sku: p.sku || id,
                            price: Number(p.price||0),
                            cost: Number(p.cost||0),
                            unit: p.unit || 'ÙˆØ­Ø¯Ø©',
                            active: p.active !== false,
                            createdAt: p.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.products++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importPriceLists && Array.isArray(backup.priceLists)){
                    for (const pl of backup.priceLists){
                        const id = pl.id || slugId(pl.name);
                        const ref = db.collection('priceLists').doc(id);
                        batch.set(ref, {
                            name: pl.name || id,
                            productPrices: pl.productPrices || pl.prices || {},
                            createdAt: pl.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.priceLists++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importReps && Array.isArray(backup.reps)){
                    for (const r of backup.reps){
                        const id = r.id || slugId(r.name);
                        const ref = db.collection('reps').doc(id);
                        batch.set(ref, {
                            name: r.name || '',
                            serial: r.serial || '',
                            target: Number(r.target||0),
                            nextInvoiceNumber: (r.nextInvoiceNumber==null? null : r.nextInvoiceNumber),
                            createdAt: r.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.reps++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importSales && Array.isArray(backup.sales)){
                    for (const s of backup.sales){
                        const sid = (s.id || '').toString() || undefined;
                        const ref = sid ? db.collection('sales').doc(sid) : db.collection('sales').doc();
                        const items = Array.isArray(s.items) ? s.items.map(it => ({
                            productId: it.productId || it.code || '',
                            qty: Number(it.qty!=null ? it.qty : (it.quantity||0)),
                            price: Number(it.price||0)
                        })) : [];
                        batch.set(ref, {
                            invoiceNumber: s.invoiceNumber || null,
                            customerId: s.customerId || null,
                            repName: s.repName || s.repId || '',
                            items,
                            total: Number(s.total||0),
                            paidAmount: Number(s.paidAmount||0),
                            status: s.status || 'due',
                            discountPercent: Number(s.discountPercent||s.discount||0),
                            taxFilingStatus: s.taxFilingStatus || '',
                            date: s.date || new Date().toISOString(),
                            notes: s.notes || '',
                            includeInCash: !!s.includeInCash,
                            collectionReportCreated: !!s.collectionReportCreated,
                            paidToSafe: !!s.paidToSafe,
                            firstPayment: s.firstPayment!=null ? Number(s.firstPayment) : undefined,
                            secondPayment: s.secondPayment!=null ? Number(s.secondPayment) : undefined,
                            collectionDiscount: s.collectionDiscount!=null ? Number(s.collectionDiscount) : undefined,
                            collectionNumber: s.collectionNumber!=null ? s.collectionNumber : undefined,
                            createdAt: s.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.sales++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importPromotions && Array.isArray(backup.promotions)){
                    for (const pr of backup.promotions){
                        const id = pr.id || slugId(pr.name);
                        const ref = db.collection('promotions').doc(id);
                        batch.set(ref, Object.assign({}, pr, { updatedAt: serverTs() }), { merge:true });
                        counts.promotions++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importSettings && backup.settings){
                    const sid = backup.settings.id || 'global-settings';
                    const ref = db.collection('settings').doc(sid);
                    batch.set(ref, Object.assign({}, backup.settings, { updatedAt: serverTs() }), { merge:true });
                    counts.settings++; pending++; await commitIfNeeded(false);
                }

                if (opts.importDispatchNotes && Array.isArray(backup.dispatchNotes)){
                    for (const dn of backup.dispatchNotes){
                        const did = (dn.id || '').toString() || undefined;
                        const ref = did ? db.collection('dispatchNotes').doc(did) : db.collection('dispatchNotes').doc();
                        batch.set(ref, Object.assign({}, dn, { updatedAt: serverTs() }), { merge:true });
                        counts.dispatchNotes++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importStockEntries && backup.stockEntries && typeof backup.stockEntries === 'object'){
                    for (const d of Object.keys(backup.stockEntries)){
                        const ref = db.collection('stockEntries').doc(d);
                        batch.set(ref, { date: d, entries: backup.stockEntries[d], updatedAt: serverTs() }, { merge:true });
                        counts.stockEntries++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importNotifications && Array.isArray(backup.notifications)){
                    for (const n of backup.notifications){
                        const idn = n.id || (Date.now()+Math.random()).toString(36);
                        const ref = db.collection('notifications').doc(idn);
                        batch.set(ref, Object.assign({}, n), { merge:true });
                        counts.notifications++; pending++; await commitIfNeeded(false);
                    }
                }

                await commitIfNeeded(true);
            } catch(e){ console.warn('importBackupObject error', e); return { ok:false, error:e, counts }; }

            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
            try { updateAllPriceListDropdowns(); } catch(e){}
            try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
            return { ok:true, counts };
        }

        function parseBackupText(text){
            try { return JSON.parse(text); } catch(e){
                try { return tryParseJsonLoose(text); } catch(e2){ return null; }
            }
        }

        window.importBackupJson = async function(input, options){
            try {
                const backup = (typeof input === 'string') ? parseBackupText(input) : input;
                if (!backup || typeof backup !== 'object') { alert('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'); return false; }
                const res = await importBackupObject(backup, options);
                if (res && res.ok) { alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­'); return true; }
                alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); return false;
            } catch(e){ console.warn('importBackupJson failed', e); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); return false; }
        };

        window.importBackupFromLocalFile = function(){
            try {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json,.txt,.html';
                input.onchange = async function(){
                    const f = this.files && this.files[0]; if (!f) return;
                    const reader = new FileReader();
                    reader.onload = async function(){
                        const txt = reader.result;
                        const ok = await window.importBackupJson(txt);
                        if (ok) console.log('Backup imported successfully');
                    };
                    reader.readAsText(f, 'utf-8');
                };
                input.click();
            } catch(e){ console.warn('importBackupFromLocalFile failed', e); }
        };
        async function importFromSharedAppState(options){
            const opts = Object.assign({ force: true, cleanupDefaults: true }, options||{});
            if (!db) { console.warn('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø²'); return false; }
            const doc = await db.collection('shared').doc('public_app_state').get().catch(()=>null);
            if (!doc || !doc.exists) { console.log('shared/public_app_state ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return false; }
            const data = doc.data() || {}; const as = data.appState || {};
            const custArr = Array.isArray(as.customers) ? as.customers : [];
            const plArr = Array.isArray(as.priceLists) ? as.priceLists : [];
            const repsArr = Array.isArray(as.reps) ? as.reps : [];
            if (custArr.length === 0 && plArr.length === 0 && repsArr.length === 0) { console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ customers/priceLists/reps Ø¯Ø§Ø®Ù„ appState'); return false; }

            // Ø§Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø³Ù†Ù†Ø¸Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª
            const [currCustSnap, currPlSnap, currRepsSnap] = await Promise.all([
                db.collection('customers').get(), db.collection('priceLists').get(), db.collection('reps').get()
            ]);
            const existingCustIds = new Set(currCustSnap.docs.map(d=>d.id));
            const existingPlIds = new Set(currPlSnap.docs.map(d=>d.id));
            const existingRepIds = new Set(currRepsSnap.docs.map(d=>d.id));

            const batch = db.batch();
            const targetCustIds = new Set();
            const targetPlIds = new Set();
            const targetRepIds = new Set();

            custArr.forEach(c => {
                const id = c.id || c._id || slugId(c.name, undefined);
                if (!id) return;
                targetCustIds.add(id);
                batch.set(db.collection('customers').doc(id), {
                    name: c.name || '',
                    phone: c.phone || '',
                    taxNumber: c.taxNumber || '',
                    requiresTaxFiling: !!c.requiresTaxFiling,
                    priceListId: c.priceListId || '',
                    balance: Number(c.balance||0),
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            plArr.forEach(pl => {
                const id = pl.id || slugId(pl.name, undefined);
                if (!id) return;
                targetPlIds.add(id);
                batch.set(db.collection('priceLists').doc(id), {
                    name: pl.name || 'Ù‚Ø§Ø¦Ù…Ø©',
                    productPrices: pl.productPrices || {},
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            repsArr.forEach(r => {
                const id = r.id || slugId(r.name, undefined);
                if (!id) return;
                targetRepIds.add(id);
                batch.set(db.collection('reps').doc(id), {
                    name: r.name || '',
                    serial: r.serial || r.code || '',
                    target: Number(r.target||0),
                    nextInvoice: Number(r.nextInvoice||r.next_invoice||0),
                    active: r.active !== false,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙŠ Ø£Ø¶ÙÙ†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¶Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©
            if (opts.cleanupDefaults) {
                const defaultCustIds = ['CUST001','CUST002','CUST003'];
                defaultCustIds.forEach(id => { if (existingCustIds.has(id) && !targetCustIds.has(id)) batch.delete(db.collection('customers').doc(id)); });
                const defaultPlIds = ['retail','wholesale'];
                defaultPlIds.forEach(id => { if (existingPlIds.has(id) && !targetPlIds.has(id)) batch.delete(db.collection('priceLists').doc(id)); });
                ['REP1','REP2','REP3'].forEach(id => { if (existingRepIds.has(id) && !targetRepIds.has(id)) batch.delete(db.collection('reps').doc(id)); });
            }

            await batch.commit();
            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ±ÙŠ
            state.customers = custArr.map(c => ({...c, _id: c.id || c._id || slugId(c.name)}));
            state.priceLists = plArr.map(pl => ({...pl, id: pl.id || slugId(pl.name)}));
            state.reps = repsArr.map(r => ({...r, id: r.id || slugId(r.name)}));
            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
            try { updateAllPriceListDropdowns(); } catch(e){}
            try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
            console.log('Ø§Ø³ØªÙŠØ±Ø§Ø¯ appState -> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§ÙƒØªÙ…Ù„');
            return true;
        }
        window.importFromSharedAppState = importFromSharedAppState;

        // ===== Ù‡Ø¬Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©) =====
        async function migrateLegacyCollections(){
            if (!db) { console.warn('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø²'); return; }
            const role = getUserRole();
            if (role !== 'admin') { alert('Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); return; }
            console.log('Ø¨Ø¯Ø¡ Ù‡Ø¬Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©');
            const legacySets = [
                { src: 'Customers', dest: 'customers', map: d => ({
                    name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
                    priceListId: d.priceListId || d.pricelist || d.price_list_id || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'customers_old', dest: 'customers', map: d => ({
                    name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
                    priceListId: d.priceListId || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'PriceLists', dest: 'priceLists', map: d => ({
                    name: d.name||d.title||'Ù‚Ø§Ø¦Ù…Ø©', productPrices: d.productPrices || d.prices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'price_lists', dest: 'priceLists', map: d => ({
                    name: d.name||'Ù‚Ø§Ø¦Ù…Ø©', productPrices: d.productPrices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })}
            ];
            let migratedCustomers = 0, migratedPriceLists = 0;
            for (const set of legacySets) {
                try {
                    const snap = await db.collection(set.src).get();
                    if (snap.empty) continue;
                    for (const doc of snap.docs) {
                        const data = doc.data() || {};
                        const destRef = db.collection(set.dest).doc(doc.id);
                        const exists = await destRef.get();
                        if (exists.exists) continue; // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
                        await destRef.set(set.map(data), { merge: true });
                        if (set.dest === 'customers') migratedCustomers++; else if (set.dest === 'priceLists') migratedPriceLists++;
                    }
                } catch(e){ console.warn('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©', set.src, e); }
            }
            console.log(`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‡Ø¬Ø±Ø©: Ø¹Ù…Ù„Ø§Ø¡ +=${migratedCustomers}, Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± +=${migratedPriceLists}`);
            alert(`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‡Ø¬Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­\nØ¹Ù…Ù„Ø§Ø¡ ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ù…: ${migratedCustomers}\nÙ‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§: ${migratedPriceLists}`);
            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
        }
        window.migrateLegacyCollections = migrateLegacyCollections; // Ø¥ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„

        // ===== Ø§Ù„Ø­Ø¶ÙˆØ± Presence ÙƒØªØ§Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ« =====
        function setPresenceOnline(){
            try {
                if (!db || !auth || !auth.currentUser) return;
                // Ù„Ø§ ØªÙƒØªØ¨ Ø­Ø¶ÙˆØ±Ø§Ù‹ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø§Ø¬ÙØ¹/Ù…Ø¯ÙŠØ± (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
                try { if (isReadOnly()) return; } catch(_){ }
                const u = auth.currentUser;
                db.collection('presence').doc(u.uid).set({
                    uid: u.uid,
                    email: (u.email||'').toLowerCase(),
                    online: true,
                    lastActive: serverTs()
                }, { merge: true }).catch(e=>console.warn('presence set error', e));
            } catch(e){ console.warn('setPresenceOnline failed', e); }
        }
        function setPresenceOffline(){
            try {
                if (!db || !auth || !auth.currentUser) return;
                try { if (isReadOnly()) return; } catch(_){ }
                const u = auth.currentUser;
                db.collection('presence').doc(u.uid).set({
                    online: false,
                    lastActive: serverTs()
                }, { merge: true }).catch(e=>console.warn('presence unset error', e));
            } catch(e){ console.warn('setPresenceOffline failed', e); }
        }
        window.addEventListener('beforeunload', function(){ try { setPresenceOffline(); } catch(e){} });


        // Firebase save/load helpers for cloud sync are defined later in the file
        // (they are implemented with Firebase Auth + Firestore where available).

        // LocalStorage access helpers â€” these suppress local reads/writes when CLOUD_ONLY is enabled.
        function lsGet(key) {
            try {
                if (window.CLOUD_ONLY) return null;
                return localStorage.getItem(key);
            } catch (e) { return null; }
        }
        function lsSet(key, value) {
            try {
                if (window.CLOUD_ONLY) {
                    console.debug('CLOUD_ONLY: suppressed localStorage.setItem', key);
                    return;
                }
                localStorage.setItem(key, value);
            } catch (e) { /* ignore */ }
        }
        function lsRemove(key) {
            try {
                if (window.CLOUD_ONLY) {
                    console.debug('CLOUD_ONLY: suppressed localStorage.removeItem', key);
                    return;
                }
                localStorage.removeItem(key);
            } catch (e) { /* ignore */ }
        }

        // Ensure grid states are loaded as early as possible to avoid race conditions
        document.addEventListener('DOMContentLoaded', function () {
            try { window._rawGridState = JSON.parse(localStorage.getItem('raw_materials_grid') || '{}'); } catch (e) { window._rawGridState = {}; }
            try { window._packGridState = JSON.parse(localStorage.getItem('packaging_grid') || '{}'); } catch (e) { window._packGridState = {}; }
            try { window._finishedGridState = JSON.parse(localStorage.getItem('finished_products_grid') || '{}'); } catch (e) { window._finishedGridState = {}; }
            // CRITICAL: Also load stock entries from localStorage
            try { if (!window.state) window.state = {}; window.state.stockEntries = JSON.parse(localStorage.getItem('stock_entries') || '{}'); } catch (e) { if (!window.state) window.state = {}; window.state.stockEntries = {}; }
            console.log('Loaded State:', window._rawGridState);
            console.log('Loaded Packaging State:', window._packGridState);
            console.log('Loaded Finished State:', window._finishedGridState);
            console.log('Loaded Stock Entries:', window.state.stockEntries);
            // create lightweight save helpers if they aren't present yet
                if (!window._gridHelpersInstalled) {
                window._gridHelpersInstalled = true;
                window._rawGridSaveTimer = null;
                window._packGridSaveTimer = null;
                window._finishedGridSaveTimer = null;
                window.isUpdatingFromCloud = false;
                window._lastSavedCostListsJson = '';

                (function(){
                    try {
                        var ind = document.getElementById('cloud-save-indicator');
                        if (!ind) {
                            ind = document.createElement('div');
                            ind.id = 'cloud-save-indicator';
                            ind.style.position = 'fixed';
                            ind.style.bottom = '12px';
                            ind.style.left = '12px';
                            ind.style.background = 'rgba(0,0,0,0.75)';
                            ind.style.color = '#fff';
                            ind.style.padding = '6px 10px';
                            ind.style.borderRadius = '6px';
                            ind.style.zIndex = 99999;
                            ind.style.fontFamily = 'Cairo, sans-serif';
                            ind.style.display = 'none';
                            ind.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                            document.body.appendChild(ind);
                        }
                        window._toggleSaveIndicator = function(on){ try { ind.style.display = on ? 'block' : 'none'; } catch(e){} };
                    } catch(e){ window._toggleSaveIndicator = function(){}; }
                })();

                function sanitizeForSave(obj){
                    try {
                        if (obj == null) return obj;
                        if (Array.isArray(obj)) return obj.map(sanitizeForSave);
                        if (typeof obj === 'object'){
                            var out = {};
                            for (var k in obj){
                                if (!Object.prototype.hasOwnProperty.call(obj,k)) continue;
                                if (k && k.charAt(0) === '_' ) continue; // strip internal keys
                                if (k === 'ui' || k === 'editing') continue;
                                var v = obj[k];
                                if (typeof v === 'string'){
                                    var n = v.trim();
                                    if (/^-?\d+(?:\.\d+)?$/.test(n)) out[k] = Number(n);
                                    else out[k] = n;
                                } else if (typeof v === 'object') out[k] = sanitizeForSave(v);
                                else out[k] = v;
                            }
                            return out;
                        }
                        if (typeof obj === 'string' && /^-?\d+(?:\.\d+)?$/.test(obj.trim())) return Number(obj.trim());
                        return obj;
                    } catch(e){ console.warn('sanitizeForSave failed', e); return obj; }
                }

                async function saveCostListsPayload(payload){
                    try {
                        window._toggleSaveIndicator(true);
                        if (!window.db) {
                            try { localStorage.setItem('costLists_local', JSON.stringify(payload)); } catch(e){ console.warn('local backup failed', e); }
                            return;
                        }
                        var s = JSON.stringify(payload);
                        if (s === window._lastSavedCostListsJson) return;
                        try {
                            await db.collection('settings').doc('costLists').set(payload, { merge: true });
                            window._lastSavedCostListsJson = s;
                        } catch(e){ console.error('saveCostListsPayload write failed', e); }
                    } catch(e){ console.error('saveCostListsPayload failed', e); }
                    finally { try { window._toggleSaveIndicator(false); } catch(_){} }
                }

                window.saveRawGridStateNow = async function(){
                    try {
                        try { localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState || {})); } catch(e){ console.warn('localStorage raw save failed', e); }
                        var payload = { rawMaterials: sanitizeForSave(window._rawGridState || {}), timestamp: new Date().toISOString() };
                        await saveCostListsPayload(payload);
                    } catch(e){ console.error('saveRawGridStateNow failed', e); }
                };

                window.debouncedRawSave = function(){ clearTimeout(window._rawGridSaveTimer); window._rawGridSaveTimer = setTimeout(window.saveRawGridStateNow, 1500); };

                window.savePackGridStateNow = async function(){
                    try {
                        try { localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState || {})); } catch(e){ console.warn('localStorage pack save failed', e); }
                        var payload = { packaging: sanitizeForSave(window._packGridState || {}), timestamp: new Date().toISOString() };
                        await saveCostListsPayload(payload);
                    } catch(e){ console.error('savePackGridStateNow failed', e); }
                };

                window.debouncedPackSave = function(){ clearTimeout(window._packGridSaveTimer); window._packGridSaveTimer = setTimeout(window.savePackGridStateNow, 1500); };

                window.saveFinishedGridStateNow = async function(){
                    try {
                        try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(e){ console.warn('localStorage finished save failed', e); }
                        try { localStorage.setItem('stock_entries', JSON.stringify(window.state?.stockEntries || {})); } catch(e){ console.warn('localStorage stock_entries save failed', e); }
                        var payload = { 
                            finishedProducts: sanitizeForSave(window._finishedGridState || {}),
                            stockEntries: sanitizeForSave(window.state?.stockEntries || {}),
                            timestamp: new Date().toISOString() 
                        };
                        await saveCostListsPayload(payload);
                    } catch(e){ console.error('saveFinishedGridStateNow failed', e); }
                };

                window.debouncedFinishedSave = function(){ clearTimeout(window._finishedGridSaveTimer); window._finishedGridSaveTimer = setTimeout(window.saveFinishedGridStateNow, 1500); };
            }
            
            // Force Sync to Cloud function
            window.forceFullCloudSync = async function(){
                try {
                    if (!window.firebase || !window.firebase.firestore) { alert('âŒ Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø²'); return; }
                    if (!window.db) { alert('âŒ Database ØºÙŠØ± Ù…ØªØµÙ„'); return; }
                    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ø¢Ù†ØŸ')) return;
                    
                    const payload = {
                        costRaw: window.costLists?.costRaw || [],
                        costPack: window.costLists?.costPack || [],
                        // FIXED: Remove costFinished array (using finishedProducts object)
                        rawGridState: window._rawGridState || {},
                        packGridState: window._packGridState || {},
                        finishedProducts: window._finishedGridState || {}, // FIXED: Use finishedProducts
                        stockEntries: window.state?.stockEntries || {}, // FIXED: Add stock_entries
                        timestamp: new Date().toISOString()
                    };
                    await db.collection('settings').doc('costLists').set(payload, { merge: true });
                    alert('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ÙØªØ­Ù‡Ø§ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.');
                } catch (e) {
                    console.error('forceFullCloudSync error:', e);
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + (e && e.message ? e.message : e));
                }
            };
            
            // Dynamic force-sync button removed for local-only workflow
        });

        // ===== Install costLists cloud listener (real-time sync) =====
        window.__costDocUnsub = window.__costDocUnsub || null;
        window.installCostListsListener = function(){
            try {
                if (!window.db || window.__costDocUnsub) return;
                var ref = db.collection('settings').doc('costLists');
                window.__costDocUnsub = ref.onSnapshot(function(snap){
                    try {
                        if (!snap || !snap.exists) return;
                        window.isUpdatingFromCloud = true;
                        var data = snap.data() || {};
                        try { if (data.rawMaterials) { window._rawGridState = data.rawMaterials; localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState||{})); } } catch(e){ console.warn('apply raw failed', e); }
                        try { if (data.packaging) { window._packGridState = data.packaging; localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState||{})); } } catch(e){ console.warn('apply pack failed', e); }
                        try { if (data.finishedProducts) { window._finishedGridState = data.finishedProducts; localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState||{})); } } catch(e){ console.warn('apply finished failed', e); }
                        // FIXED: Restore stock_entries from cloud (avoid wiping local when cloud empty)
                        try {
                            if (data.stockEntries && typeof data.stockEntries === 'object' && Object.keys(data.stockEntries||{}).length > 0 && window.state) {
                                window.state.stockEntries = data.stockEntries;
                                try { localStorage.setItem('stock_entries', JSON.stringify(data.stockEntries||{})); } catch(_){ }
                            } else {
                                console.log('â­ï¸ costLists RT: skipped stockEntries overlay (cloud empty)');
                            }
                        } catch(e){ console.warn('apply stockEntries failed', e); }
                        try { if (data.costRaw) { window.costLists = window.costLists || {}; window.costLists.costRaw = data.costRaw; } } catch(e){ console.warn('apply costRaw failed', e); }
                        try { if (data.costPack) { window.costLists = window.costLists || {}; window.costLists.costPack = data.costPack; } } catch(e){ console.warn('apply costPack failed', e); }
                        try { if (data.costFinished) { window.costLists = window.costLists || {}; window.costLists.costFinished = data.costFinished; } } catch(e){ console.warn('apply costFinished failed', e); }
                        try {
                            window._lastSavedCostListsJson = JSON.stringify({ rawMaterials: window._rawGridState, packaging: window._packGridState, finishedProducts: window._finishedGridState, costRaw: (window.costLists&&window.costLists.costRaw)||[], costPack: (window.costLists&&window.costLists.costPack)||[], costFinished: (window.costLists&&window.costLists.costFinished)||[] });
                        } catch(e){}
                    } catch(e){ console.warn('costLists snapshot handler failed', e); }
                    finally { setTimeout(function(){ window.isUpdatingFromCloud = false; }, 50); }
                });
            } catch(e){ console.warn('installCostListsListener failed', e); }
        };

        document.addEventListener('DOMContentLoaded', function(){ setTimeout(function(){ try { if (typeof window.installCostListsListener === 'function') window.installCostListsListener(); } catch(e){} }, 1200); });

        // ===== Helpers: Sales cache (used when reads are blocked) =====
        function getCachedSales(){
            try { const raw = localStorage.getItem('cache_sales'); return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
        }
        function setCachedSales(arr){
            try { localStorage.setItem('cache_sales', JSON.stringify(Array.isArray(arr)? arr : [])); } catch(e){}
        }
        function upsertCachedSale(sale){
            try {
                if (!sale || !sale.id) return;
                const list = getCachedSales();
                const idx = list.findIndex(s => s && (s.id === sale.id || s._id === sale.id));
                if (idx >= 0) list[idx] = sale; else list.unshift(sale);
                if (list.length > 500) list.length = 500;
                setCachedSales(list);
            } catch(e){}
        }
        function removeCachedSale(id){
            try {
                const list = getCachedSales().filter(s => s && s.id !== id && s._id !== id);
                setCachedSales(list);
            } catch(e){}
        }

        // ===== Permission-denied resilience =====
        window.__permissionErrorCounts = window.__permissionErrorCounts || {};
        function handlePermissionDenied(coll){
            try {
                const c = window.__permissionErrorCounts;
                c[coll] = (c[coll] || 0) + 1;
                const core = ['sales','customers','products','priceLists'];
                const coreFailures = core.filter(x => c[x] && c[x] > 0).length;
                // If all core collections failed at least once, render cached data immediately
                if (coreFailures === core.length) {
                    ensureCachedDataRendered();
                    showPermissionBanner();
                } else if (c[coll] >= 2) {
                    // After 2 failures of same coll, still show banner
                    showPermissionBanner();
                }
            } catch(e){ /* ignore */ }
        }
        function preloadCachedCollections(){
            try {
                if (!window.state) window.state = {};
                // Load cached customers/products/priceLists if empty
                if (!state.customers || !state.customers.length){
                    const raw = localStorage.getItem('cache_customers');
                    if (raw){ try { state.customers = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.products || !state.products.length){
                    const raw = localStorage.getItem('cache_products');
                    if (raw){ try { state.products = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.priceLists || !state.priceLists.length){
                    const raw = localStorage.getItem('cache_priceLists');
                    if (raw){ try { state.priceLists = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.sales || !state.sales.length){
                    const s = getCachedSales();
                    if (s && s.length) state.sales = s;
                }
                // Render quickly if we hydrated anything
                try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                try {
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                } catch(e){}
            } catch(e){ /* ignore */ }
        }
        function ensureCachedDataRendered(){
            preloadCachedCollections();
        }
        function showPermissionBanner(){
            try {
                let bn = document.getElementById('permission-banner');
                if (!bn){
                    bn = document.createElement('div');
                    bn.id = 'permission-banner';
                    bn.style.cssText = 'position:fixed;top:72px;left:0;right:0;z-index:120;background:#fee;border:1px solid #f99;padding:6px 10px;font-size:14px;text-align:center;font-weight:600;color:#b00000';
                    bn.innerHTML = 'âš ï¸ Ù…Ø´ÙƒÙ„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Firestore: ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·. Ø­Ø¯Ø« Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„.';
                    document.body.appendChild(bn);
                }
            } catch(e){ /* ignore */ }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ø¦Ù… Ø§Ø®ØªÙŠØ§Ø± Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function updateAllPriceListDropdowns(){
            try {
                const els = [
                    document.getElementById('customer-price-list')
                ].filter(Boolean);
                els.forEach(el => { if (typeof populatePriceListDropdown === 'function') populatePriceListDropdown(el, el.value || ''); });
            } catch(e){ /* ignore */ }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ø¦Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function updateAllCustomerDropdowns(){
            try {
                const els = [
                    document.getElementById('sale-customer'),
                    document.getElementById('spreadsheet-customer') || document.getElementById('spreadsheet-customer-select') || document.getElementById('spreadsheetCustomerSelect')
                ].filter(Boolean);
                els.forEach(el => {
                    const current = el.value || '';
                    if (typeof populateCustomerDropdown === 'function') populateCustomerDropdown(el, current);
                });
            } catch(e){ /* ignore */ }
        }

        // ===== Ø¥Ù‚ÙØ§Ù„ Ø´Ù‡Ø± ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† =====
        function __formatPeriod(dateObj){
            const y = dateObj.getFullYear();
            const m = (dateObj.getMonth()+1).toString().padStart(2,'0');
            return `${y}-${m}`;
        }
        function defaultPrevMonthPeriod(){
            const d = new Date(); d.setDate(1); d.setMonth(d.getMonth()-1);
            return __formatPeriod(d);
        }
        function periodToRange(period){
            // period: 'YYYY-MM'
            try {
                const [y,m] = period.split('-').map(Number);
                const start = new Date(y, m-1, 1, 0,0,0,0);
                const end = new Date(y, m, 0, 23,59,59,999); // last day of month
                return { startISO: start.toISOString(), endISO: end.toISOString() };
            } catch(e){
                const d = new Date();
                return { startISO: new Date(d.getFullYear(), d.getMonth(), 1).toISOString(), endISO: new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999).toISOString() };
            }
        }
        function nextPeriod(period){
            try {
                const [y,m] = period.split('-').map(Number);
                const d = new Date(y, m-1, 1); d.setMonth(d.getMonth()+1);
                return __formatPeriod(d);
            } catch(e){ return defaultPrevMonthPeriod(); }
        }

        async function computeClosingBalances(period){
            if (!db) throw new Error('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø²');
            const { endISO } = periodToRange(period);
            const snap = await db.collection('sales').where('date','<=', endISO).get();
            const byCustomer = new Map();
            snap.forEach(doc => {
                const s = doc.data() || {};
                const cid = s.customerId || 'UNKNOWN';
                if (s.status === 'return') return;
                const total = Number(s.total||0);
                const paid = Number(s.paidAmount||0);
                const out = Math.max(total - paid, 0);
                if (!byCustomer.has(cid)) byCustomer.set(cid, 0);
                byCustomer.set(cid, byCustomer.get(cid) + out);
            });
            const result = [];
            let totalOutstanding = 0;
            byCustomer.forEach((amt, cid) => {
                const rounded = Math.round(amt*100)/100;
                totalOutstanding += rounded;
                const cu = (state.customers||[]).find(c => (c.id||c._id) === cid) || {};
                result.push({ customerId: cid, customerName: cu.name || cid, closing: rounded });
            });
            result.sort((a,b)=> (b.closing - a.closing));
            return { period, endISO, customers: result, totalOutstanding: Math.round(totalOutstanding*100)/100 };
        }

        async function lockMonthSales(period){
            const { startISO, endISO } = periodToRange(period);
            // Ù‚ÙÙ„ ÙÙˆØ§ØªÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø· (Ù„ÙŠØ³ ÙƒÙ„ Ù…Ø§ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±)
            const snap = await db.collection('sales').where('date','>=', startISO).where('date','<=', endISO).get();
            let batch = db.batch(); let pending = 0; const BATCH_LIMIT = 450;
            for (const doc of snap.docs){
                batch.set(doc.ref, { locked: true, lockPeriod: period, lockedAt: serverTs(), lockedBy: (auth&&auth.currentUser)?auth.currentUser.uid:null }, { merge:true });
                pending++; if (pending >= BATCH_LIMIT){ await batch.commit(); batch = db.batch(); pending = 0; }
            }
            if (pending>0) await batch.commit();
        }

        async function performMonthClose(period){
            const role = getUserRole();
            if (role !== 'admin') { alert('Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø´Ù‡Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); return { ok:false, reason:'not-admin' }; }
            const summary = await computeClosingBalances(period);
            const next = nextPeriod(period);
            // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ù…ÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©
            const existing = await db.collection('monthlyClosings').doc(period).get().catch(()=>null);
            if (existing && existing.exists) { alert('ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return { ok:false, reason:'already-closed' }; }

            // ÙƒØªØ§Ø¨Ø© Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙƒØªØµÙ†ÙŠÙ ÙØ±Ø¹ÙŠ
            await db.collection('monthlyClosings').doc(period).set({
                period,
                closedAt: serverTs(),
                closedBy: (auth&&auth.currentUser)? auth.currentUser.uid : null,
                totalCustomers: summary.customers.length,
                totalOutstanding: summary.totalOutstanding
            }, { merge:true });
            // ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            {
                let batch = db.batch(); let pending = 0; const LIM = 450;
                for (const row of summary.customers){
                    const ref = db.collection('monthlyClosings').doc(period).collection('customers').doc(row.customerId || slugId(row.customerName));
                    batch.set(ref, { customerId: row.customerId, customerName: row.customerName, closing: row.closing }, { merge:true });
                    pending++; if (pending>=LIM){ await batch.commit(); batch = db.batch(); pending = 0; }
                }
                if (pending>0) await batch.commit();
            }
            // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø±ØµØ¯Ø© Ø§ÙØªØªØ§Ø­ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ
            {
                let batch = db.batch(); let pending = 0; const LIM = 450;
                for (const row of summary.customers){
                    const amount = Math.round(Number(row.closing||0)*100)/100;
                    if (!amount) continue;
                    const oid = `${row.customerId||slugId(row.customerName)}_${next}`;
                    const ref = db.collection('openingBalances').doc(oid);
                    batch.set(ref, {
                        customerId: row.customerId,
                        customerName: row.customerName,
                        period: next,
                        sourcePeriod: period,
                        amount,
                        createdAt: serverTs(),
                        createdBy: (auth&&auth.currentUser)?auth.currentUser.uid:null
                    }, { merge:true });
                    pending++; if (pending>=LIM){ await batch.commit(); batch = db.batch(); pending = 0; }
                }
                if (pending>0) await batch.commit();
            }

            // Ù‚ÙÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ù‡Ø±
            await lockMonthSales(period);
            if (!arguments[1] || !arguments[1].silent) {
                alert('ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ');
            }
            return { ok:true, summary };
        }

        // Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Admin ÙÙ‚Ø·)
        async function maybeAutoClosePreviousMonth(){
            try {
                // Ensure the server recognises this user as admin (check roles/users on Firestore)
                try {
                    if (!auth || !auth.currentUser) return;
                    const uid = auth.currentUser.uid;
                    let serverRole = null;
                    try {
                        const rdoc = await db.collection('roles').doc(uid).get();
                        if (rdoc.exists && rdoc.data() && rdoc.data().role) serverRole = rdoc.data().role;
                    } catch(_){ /* ignore */ }
                    if (!serverRole) {
                        try {
                            const udoc = await db.collection('users').doc(uid).get();
                            if (udoc.exists && udoc.data() && udoc.data().role) serverRole = udoc.data().role;
                        } catch(_){ /* ignore */ }
                    }
                    if (serverRole !== 'admin') {
                        // Not an admin according to server-side data â€” skip auto-close to avoid permission errors
                        console.warn('maybeAutoClosePreviousMonth: skipping auto-close because server role != admin', { serverRole });
                        return;
                    }
                } catch(e){ console.warn('maybeAutoClosePreviousMonth: role check failed, skipping', e); return; }
                const now = new Date();
                const currentPeriod = __formatPeriod(now);
                const prevPeriod = defaultPrevMonthPeriod();
                // Ù„Ø§ ØªÙØºÙ„Ù‚ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ ÙˆÙ„Ù… ØªÙØ³Ø¬Ù‘Ù„ Ø£ÙŠ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ø³Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯ Ø¥Ù‚ÙØ§Ù„
                const docRef = db.collection('monthlyClosings').doc(prevPeriod);
                const doc = await docRef.get();
                if (!doc.exists) {
                    await performMonthClose(prevPeriod, { silent: true });
                }
            } catch(e){ console.warn('maybeAutoClosePreviousMonth failed', e); }
        }

        // Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: ÙŠØ­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙŠØ¶Ø¨Ø· ÙÙ„Ø§ØªØ± Ø§Ù„ØµÙØ­Ø§Øª (Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)
        function setActivePeriod(period){
            try {
                window.state = window.state || {};
                state.activePeriod = period;
                try { localStorage.setItem('active_period', String(period)); } catch(e){}
                
                // Ø§Ø¶Ø¨Ø· ÙÙ„ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                const salesDateInput = document.getElementById('search-sales-date');
                if (salesDateInput) {
                    salesDateInput.value = `${period}-01`;
                    try { salesDateInput.dispatchEvent(new Event('change')); } catch(e){}
                }
                
                // Ø£Ø¹Ø¯ Ø±Ø³Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
                try {
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    if (typeof renderAllSales === 'function') {
                        renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    }
                    if (typeof renderDashboard === 'function') renderDashboard();
                    if (typeof renderDebts === 'function') renderDebts();
                    if (typeof renderRepDebts === 'function') renderRepDebts();
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                    console.log(`Active period changed to: ${period}`);
                } catch(e){ 
                    console.warn('Error while rendering after period change', e);
                }
            } catch(e){ console.warn('setActivePeriod error', e); }
        }
        function ensureDefaultActivePeriod(){
            try {
                const saved = localStorage.getItem('active_period');
                const now = new Date();
                const current = __formatPeriod(now);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† state.activePeriod Ø£ÙŠØ¶Ø§Ù‹
                const stateActive = (window.state && state.activePeriod) ? String(state.activePeriod) : '';
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£ÙŠ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ© â†’ Ø­Ø¯Ù‘Ø« Ø§Ù„ÙƒÙ„
                if (!saved || saved !== current || stateActive !== current) { 
                    console.log(`ensureDefaultActivePeriod: Updating from saved=${saved}, stateActive=${stateActive} to ${current}`);
                    setActivePeriod(current); 
                }
            } catch(e){ console.warn('ensureDefaultActivePeriod error', e); }
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø©
        window.resetActivePeriod = function() {
            try {
                const current = __formatPeriod(new Date());
                localStorage.setItem('active_period', current);
                if (window.state) window.state.activePeriod = current;
                console.log(`Reset active period to: ${current}`);
                if (typeof ensureDefaultActivePeriod === 'function') ensureDefaultActivePeriod();
                return current;
            } catch(e) {
                console.error('resetActivePeriod error', e);
                return null;
            }
        };

        // === PERIODIC ACTIVE PERIOD CHECK (Every hour) ===
        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© ÙƒÙ„ Ø³Ø§Ø¹Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        (function(){
            const CHECK_INTERVAL = 3600000; // 1 hour in ms
            setInterval(()=>{
                try {
                    ensureDefaultActivePeriod();
                } catch(e){ console.warn('Periodic active period check failed', e); }
            }, CHECK_INTERVAL);
            // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            try {
                ensureDefaultActivePeriod();
                console.log('Initial activePeriod check executed');
            } catch(e){ console.warn('Initial active period check failed', e); }
        })();

        // === PERIODIC SALE PRICES REFRESH (Every 30 seconds) ===
        // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¯ÙˆØ±ÙŠØ§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø®ÙØ¶Ø© ØªÙØ³ØªØ¹Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙØªØ±Ø© Ø§Ù„Ø¹Ø±Ø¶
        (function(){
            const REFRESH_INTERVAL = 30000; // 30 seconds in ms
            setInterval(()=>{
                try {
                    if (typeof updateAllSalePrices === 'function') {
                        updateAllSalePrices();
                    }
                } catch(e){ console.warn('Periodic sale prices refresh failed', e); }
            }, REFRESH_INTERVAL);
        })();

        // (manual month close UI removed â€” handled automatically and via settings calendar)

        // ==========================================
        // ğŸ–¨ï¸ BLUETOOTH PRINT - CANDIDATE LIST STRATEGY ğŸ–¨ï¸
        // ==========================================

        // Define Known Printer Configurations (from previous success)
        const PRINTER_CANDIDATES = [
            { 
                name: "Standard BLE", 
                service: "000018f0-0000-1000-8000-00805f9b34fb", 
                char: "00002af1-0000-1000-8000-00805f9b34fb" 
            },
            { 
                name: "ISSC / Chinese Generic", 
                service: "49535343-fe7d-4ae5-8fa9-9fafd205e455", 
                char: "49535343-8841-43f4-a8d4-ecbe34729bb3" 
            },
            { 
                name: "Generic Variant 1 (AF30)", 
                service: "0000af30-0000-1000-8000-00805f9b34fb", 
                char: "0000af31-0000-1000-8000-00805f9b34fb" 
            },
            { 
                name: "Generic Variant 2 (FF00)", 
                service: "0000ff00-0000-1000-8000-00805f9b34fb", 
                char: "0000ff02-0000-1000-8000-00805f9b34fb" 
            }
        ];

        let btCharacteristic = null;
        let btDevice = null;

        async function connectToBluetoothPrinter() {
            try {
                console.log("Starting Candidate Search...");
                
                // 1. Request Device with ALL candidate services in 'optionalServices'
                // This is CRITICAL for permissions.
                const allServices = PRINTER_CANDIDATES.map(c => c.service);
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, // Try to find everything
                    optionalServices: allServices 
                });

                const server = await device.gatt.connect();
                console.log("Connected to GATT. Scanning candidates...");

                // 2. Iterate through candidates to find the first match
                for (const candidate of PRINTER_CANDIDATES) {
                    try {
                        const service = await server.getPrimaryService(candidate.service);
                        const characteristic = await service.getCharacteristic(candidate.char);
                        
                        // If we are here, we found a match!
                        btCharacteristic = characteristic;
                        btDevice = device;
                        console.log(`âœ… MATCH FOUND: ${candidate.name}`);
                        alert(`ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! (${candidate.name})`);
                        
                        // Add disconnect listener
                        device.addEventListener('gattserverdisconnected', () => {
                            alert("âš ï¸ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©");
                            btCharacteristic = null;
                        });
                        
                        return true;
                    } catch (error) {
                        console.log(`âŒ Failed candidate: ${candidate.name}`);
                    }
                }
                
                throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø¯Ù…Ø© Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¯Ø¹ÙˆÙ…Ø© (No matching UUID found).");

            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message);
                return false;
            }
        }

        async function printInvoiceBluetooth(invoice) {
            // Show processing message first
            const processingMsg = document.createElement('div');
            processingMsg.style.position = 'fixed';
            processingMsg.style.top = '50%';
            processingMsg.style.left = '50%';
            processingMsg.style.transform = 'translate(-50%, -50%)';
            processingMsg.style.background = '#fff';
            processingMsg.style.padding = '30px';
            processingMsg.style.borderRadius = '10px';
            processingMsg.style.zIndex = '50001';
            processingMsg.style.boxShadow = '0 4px 6px rgba(0,0,0,0.2)';
            processingMsg.style.textAlign = 'center';
            processingMsg.innerHTML = `
                <div style="font-size:18px;font-weight:bold;margin-bottom:15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ±...</div>
                <div style="font-size:14px;color:#666;margin-bottom:15px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ± ÙˆØ§Ù„Ø¨Ù„ÙˆØªÙˆØ«</div>
                <div style="animation:spin 1s linear infinite;font-size:24px;" id="spinner">â³</div>
            `;
            
            const backdrop = document.createElement('div');
            backdrop.style.position = 'fixed';
            backdrop.style.inset = '0';
            backdrop.style.background = 'rgba(0,0,0,0.3)';
            backdrop.style.zIndex = '50000';
            
            document.body.appendChild(backdrop);
            document.body.appendChild(processingMsg);
            
            // Add spinner animation
            const style = document.createElement('style');
            style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
            document.head.appendChild(style);
            
            try {
                // 1. Connection Check
                if (!btCharacteristic) {
                    const success = await connectToBluetoothPrinter();
                    if (!success) {
                        backdrop.remove();
                        processingMsg.remove();
                        alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«');
                        return;
                    }
                }

                // Update message to indicate printing
                processingMsg.innerHTML = `
                    <div style="font-size:18px;font-weight:bold;margin-bottom:15px;">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø©...</div>
                    <div style="font-size:14px;color:#666;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                `;

                try {
                    const encoder = new TextEncoder();
                    
                    // ESC/POS commands for Xprinter 80mm
                    const ESC = 0x1B;
                    const GS = 0x1D;
                    
                    const customer = findCustomer(invoice.customerId);
                    const customerName = customer ? customer.name : (invoice.customerName || 'Ø¹Ù…ÙŠÙ„');
                    const taxNumber = customer ? (customer.taxNumber || '') : '';
                    
                    let commands = [];
                    
                    // Initialize printer
                    commands.push(ESC, 0x40);
                    
                    // Company header - Center aligned, large text
                    commands.push(ESC, 0x61, 0x01); // Center align
                    commands.push(ESC, 0x21, 0x30); // Double height + width
                    commands.push(...encoder.encode("ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª\n"));
                    commands.push(ESC, 0x21, 0x00); // Normal size
                    
                    // Separator
                    commands.push(...encoder.encode("================================\n"));
                    
                    // Left align for details
                    commands.push(ESC, 0x61, 0x00);
                    
                    // Invoice details
                    const now = new Date();
                    const dateStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
                    const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
                    
                    commands.push(...encoder.encode(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr} ${timeStr}\n`));
                    commands.push(...encoder.encode(`Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${invoice.invoiceNumber || invoice.id}\n`));
                    commands.push(...encoder.encode(`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customerName}\n`));
                    if (taxNumber) {
                        commands.push(...encoder.encode(`Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: ${taxNumber}\n`));
                    }
                    commands.push(...encoder.encode(`Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${invoice.repName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`));
                    
                    commands.push(...encoder.encode("--------------------------------\n"));
                    
                    // Table header - Bold
                    commands.push(ESC, 0x45, 0x01); // Bold ON
                    const header = String("Ø§Ù„ØµÙ†Ù").padEnd(16) + 
                                  String("Ø§Ù„ÙƒÙ…ÙŠØ©").padStart(6) + 
                                  String("Ø§Ù„Ø³Ø¹Ø±").padStart(8) + 
                                  String("Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ").padStart(10);
                    commands.push(...encoder.encode(header + "\n"));
                    commands.push(ESC, 0x45, 0x00); // Bold OFF
                    
                    commands.push(...encoder.encode("--------------------------------\n"));
                    
                    // Items
                    let subtotal = 0;
                    if (invoice.items && Array.isArray(invoice.items)) {
                        invoice.items.forEach(item => {
                            const product = findProduct(item.productId);
                            const itemName = (product?.name || item.name || item.productName || 'Ù…Ù†ØªØ¬').substring(0, 15);
                            const qty = item.quantity || 0;
                            const price = item.price || 0;
                            const itemTotal = qty * price;
                            subtotal += itemTotal;
                            
                            // Item name on first line
                            commands.push(...encoder.encode(itemName + "\n"));
                            
                            // Qty, price, total on second line aligned
                            const itemLine = String(qty).padStart(6) + 
                                           String(price.toFixed(2)).padStart(14) + 
                                           String(itemTotal.toFixed(2)).padStart(10);
                            commands.push(...encoder.encode(itemLine + "\n"));
                        });
                    }
                    
                    commands.push(...encoder.encode("================================\n"));
                    
                    // Totals - Bold and larger
                    commands.push(ESC, 0x45, 0x01); // Bold ON
                    commands.push(ESC, 0x21, 0x10); // Double height
                    
                    const totalLine = String("Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ:").padEnd(20) + String((invoice.total || 0).toFixed(2)).padStart(12) + " Ø¬.Ù…";
                    commands.push(...encoder.encode(totalLine + "\n"));
                    
                    commands.push(ESC, 0x21, 0x00); // Normal size
                    commands.push(ESC, 0x45, 0x00); // Bold OFF
                    
                    commands.push(...encoder.encode("================================\n"));
                    
                    // Footer - Center
                    commands.push(ESC, 0x61, 0x01);
                    commands.push(...encoder.encode("Ø´ÙƒØ±Ø§ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§\n"));
                    commands.push(ESC, 0x61, 0x00);
                    
                    // Feed lines
                    commands.push(0x0A, 0x0A, 0x0A, 0x0A);
                    
                    // Cut paper
                    commands.push(GS, 0x56, 0x00);
                    
                    const data = new Uint8Array(commands);
                    
                    // Send in small chunks
                    const CHUNK_SIZE = 20;
                    for (let i = 0; i < data.length; i += CHUNK_SIZE) {
                        const chunk = data.slice(i, i + CHUNK_SIZE);
                        await btCharacteristic.writeValue(chunk);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Wait for printer to finish
                    await new Promise(r => setTimeout(r, 2000));

                    processingMsg.innerHTML = `
                        <div style="font-size:18px;font-weight:bold;margin-bottom:15px;color:#059669;">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­</div>
                        <div style="font-size:14px;color:#666;">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ± Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙˆØ±Ù‚Ø©</div>
                        <div style="font-size:12px;color:#999;margin-top:10px;">Ø§Ù„Ø§ØªØµØ§Ù„ Ø³ÙŠØ¨Ù‚Ù‰ Ù…ÙØªÙˆØ­ Ù„Ù„Ø·Ø§Ø¨Ø¹Ø©</div>
                    `;
                    setTimeout(() => {
                        backdrop.remove();
                        processingMsg.remove();
                    }, 4000);

                } catch (error) {
                    throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + error.message);
                }
            } catch (error) {
                console.error('Bluetooth print error:', error);
                // Don't reset connection on error - may just be temporary
                
                processingMsg.innerHTML = `
                    <div style="font-size:18px;font-weight:bold;margin-bottom:15px;color:#dc2626;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
                    <div style="font-size:14px;color:#666;margin-bottom:15px;">${error.message}</div>
                    <button id="close-error-msg" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
                `;
                document.getElementById('close-error-msg').onclick = () => {
                    backdrop.remove();
                    processingMsg.remove();
                };
            }
        }

        // Make globally available
        window.printInvoiceBluetooth = printInvoiceBluetooth;

        // ==========================================
        // ğŸ“± RAWBT INTENT PRINT (Android Direct API)
        // ==========================================
        function printViaRawBT(invoice) {
            // 1. Construct a Clean, Simple Receipt Text (ESC/POS style layout)
            // We use plain text with special formatting characters for RawBT to interpret.
            let text = "";
            
            // Header
            text += "[C]<b><font size='big'>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</font></b>\n";
            text += "[C]================================\n";
            text += `[L]<b>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</b>[R]${invoice.id || 'N/A'}\n`;
            text += `[L]<b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b>[R]${invoice.date ? new Date(invoice.date).toLocaleDateString('ar-EG') : 'Ø§Ù„ÙŠÙˆÙ…'}\n`;
            text += "[C]--------------------------------\n";
            
            // Items
            if (invoice.items && Array.isArray(invoice.items)) {
                invoice.items.forEach(item => {
                    const itemName = item.name || item.productId || 'Ù…Ù†ØªØ¬';
                    const qty = item.quantity || item.qty || 0;
                    const price = item.price || 0;
                    const total = item.total || (qty * price);
                    text += `[L]<b>${itemName}</b>\n`;
                    text += `[L]${qty} x ${formatCurrency(price)}[R]${formatCurrency(total)}\n`;
                });
            }
            
            text += "[C]--------------------------------\n";
            text += `[R]<b><font size='big'>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(invoice.total || 0)}</font></b>\n`;
            text += "[C]================================\n";
            text += "[C]Ø´ÙƒØ±Ø§ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§\n";
            text += "\n\n"; // Feed

            // 2. Encode and Trigger RawBT Intent
            // This opens the RawBT app directly with the data
            const encodedData = encodeURIComponent(text);
            window.location.href = "rawbt:" + encodedData;
        }
        window.printViaRawBT = printViaRawBT;
    </script>

    <style>
        
        /* watermark removed - body::before deleted per user request */

        #app-container {
            background-color: #ffffff !important; /* reset to white after watermark removal */
            padding-bottom: 120px; /* Ensure content doesn't hide behind bottom nav */
            padding-top: 72px; /* Offset for fixed header height so content is visible */
        }
        /* Extra safety: ensure pages have at least header offset if used outside app-container */
        .page { padding-top: 8px; }
        /* Fix main header to top so it doesn't scroll away */
        header {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            z-index: 70;
        }
        
        .page { display: none; }
        .page.active { display: block; }

        /* Main Bottom Nav Styling */
        .bottom-nav {
            position: fixed !important;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60; /* Ensure main nav is above other content */
            background: #ffffff;
        }
        .bottom-nav-item { 
            width: 7.69%; /* Adjusted for 13 items */
            transition: all 0.2s ease;
            color: #6b7280; /* Gray-500 default */
            padding: 8px 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
        } 
        
        /* Simple Active State (Default blue on click/active page) */
        .bottom-nav-item.active {
            color: #2563eb; /* Blue-600 */
            font-weight: 600;
        }

        /* Icon styling - Improved specificity and defaults */
        .lucide-icon {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
        }

        /* Bottom nav specific icon styling */
        .bottom-nav-item svg {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
            margin: 0 auto !important;
        }

        .bottom-nav-item.active svg {
            color: #2563eb !important; 
        }

        /* Ensure all Lucide icons have consistent styling */
        [data-lucide] {
            display: inline-block !important;
            vertical-align: middle !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
        }

        /* Additional size variations */
        [data-lucide].icon-sm {
            width: 16px !important;
            height: 16px !important;
        }
        
        /* Debts Table Styling to match screenshot */
        #debts-detail-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-family: Arial, sans-serif !important;
            direction: rtl !important;
        }
        
        #debts-detail-table th {
            background: #5c3317 !important;
            color: white !important;
            font-weight: bold !important;
            padding: 8px !important;
            border: 1px solid #3e2211 !important;
            text-align: center !important;
        }
        
        #debts-detail-table td {
            padding: 8px !important;
            border: 1px solid #ddd !important;
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            text-align: center !important;
            color: black !important;
            font-weight: bold !important;
        }
        
        #debts-detail-table td:first-child {
            text-align: right !important;
        }
        
        /* Force visibility of table elements */
        #debts-detail-table, #debts-detail-table thead, #debts-detail-table tbody,
        #debts-detail-table tr, #debts-detail-table th, #debts-detail-table td {
            display: revert !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        [data-lucide].icon-lg {
            width: 32px !important;
            height: 32px !important;
        }

        /* Allow specific size overrides through classes */
        [data-lucide].w-4 { width: 16px; height: 16px; }
        [data-lucide].w-5 { width: 20px; height: 20px; }
        [data-lucide].w-6 { width: 24px; height: 24px; }

        /* (removed) Floating action button for Month Close */

        /* ØªÙƒØ¨ÙŠØ± Ø®Ø§Øµ Ù„Ù„ØªØµØ¯ÙŠØ± ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© */
        .recon-export-scale { width:1800px !important; }
        .recon-export-scale table { width:100% !important; }
        .recon-export-scale th, .recon-export-scale td { padding:10px !important; font-size:16px !important; }

        /* Inquiry page table styling */
        #inq-report-table th { background:#041635;color:#fff;padding:6px 8px;text-align:center;font-weight:700; }
        #inq-report-table td { padding:5px 6px;text-align:center;border-bottom:1px solid #e0e7ef; }
        #inq-report-table td.prod-name { text-align:right;font-weight:600;background:#f8fafc; }
        #inq-report-table tr:nth-child(even) td { background:#ffffff; }
        #inq-report-table tr:nth-child(odd) td { background:#f3f6fa; }
        #inq-report-table .qty-cell { font-weight:600;color:#0b3d91; }
        #inq-report-table .total-cell { font-weight:600;color:#064e3b; }
        #inq-summary .card { background:#041a3f;color:#fff;padding:12px 10px;border-radius:8px;display:flex;flex-direction:column;gap:4px; }
        #inq-summary .card span.val { font-size:16px;font-weight:700; }

        /* Price list sheet (match Excel-like style) */
        .price-sheet { width:100%; border-collapse:collapse; direction:rtl; font-size:12px; }
        .price-sheet thead th { background:#efefef; border:1px solid #c1c1d0; padding:6px 8px; text-align:center; font-weight:800; }
        .price-sheet tbody td { border:1px solid #d4d4e0; padding:6px 8px; text-align:center; }
        .price-sheet tbody tr:nth-child(odd) td { background:#f9f9fb; }
        .price-sheet tbody tr:nth-child(even) td { background:#ffffff; }
        .price-sheet td.name { text-align:right; font-weight:600; }
        .sheet-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .sheet-title { font-weight:800; font-size:16px; border:2px solid #888; padding:4px 10px; border-radius:4px; }
        .sheet-meta { display:flex; gap:12px; color:#374151; font-size:12px; }
        .pl-controls .label { font-weight:700; font-size:12px; }

        /* Column filter menu (Debts / Cash tables) */
        .column-filter-menu { position:absolute; background:#ffffff; border:1px solid #c4a300; box-shadow:0 4px 10px rgba(0,0,0,0.12); border-radius:6px; padding:8px; width:220px; max-height:340px; overflow:auto; font-size:12px; z-index:9999; direction:rtl; }
        .column-filter-menu .filter-search { width:100%; padding:4px 6px; border:1px solid #ddd; border-radius:4px; margin-bottom:6px; font-size:12px; }
        .column-filter-menu .filter-list label { cursor:pointer; line-height:1.4; }
        .column-filter-menu .filter-list input { vertical-align:middle; }
        .column-filter-menu .filter-actions { display:flex; gap:6px; margin-top:8px; }
        .column-filter-menu .filter-actions button { flex:1; background:linear-gradient(180deg,#ffd700,#daa520); color:#000; font-weight:600; padding:6px 4px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
        .column-filter-menu .filter-actions button:hover { filter:brightness(1.05); }
        .column-filter-btn { position:relative; }
        .column-filter-btn.filtered { color:#1d4ed8 !important; font-weight:700; }
        .column-filter-btn.filtered::after { content:''; position:absolute; top:2px; inset-inline-end:2px; width:7px; height:7px; background:#1d4ed8; border-radius:50%; box-shadow:0 0 0 1px #ffffff; }
        


        /* Reports SubNav Styling - positioned in lower white space area below bottom nav */
        /* Reports subnav is hidden by default and only shown when .active is added by navigation */
        #reports-subnav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: -450px; /* Positioned further down in the lower white space area */
            height: 64px; /* Taller area for icons/labels */
            background-color: #f3f4f6; /* Gray-100 */
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -1px 8px rgba(0,0,0,0.04);
            display: none;
            justify-content: space-around;
            align-items: center;
            padding: 0 6px;
            z-index: 50; /* below bottom nav */
        }

        #reports-subnav.active {
            display: flex !important;
        }
        
        .reports-subnav-item {
            width: 25%; /* 4 items */
            padding: 0.5rem 0.25rem; /* Equivalent to p-2 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-600 */
            font-size: 0.75rem; /* text-xs */
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        /* Style for Lucide icons inside subnav buttons */
        .reports-subnav-item svg {
            color: #4b5563; /* Default icon color */
            width: 16px;
            height: 16px;
        }
        .reports-subnav-item.active svg,
        .reports-subnav-item.active span {
            color: #dc2626; /* red-600 */
            font-weight: 600; /* font-semibold */
        }


    .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            visibility: hidden;
        }
        .modal-visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            visibility: visible;
        }
        .hidden {
            display: none !important;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        #backup-data-textarea, #restore-data-textarea {
            resize: none;
            height: 150px;
            font-family: monospace;
            font-size: 12px;
            direction: ltr;
            text-align: left;
        }

        .only-print {
            display: none;
        }

        #sale-modal.modal-visible {
            transform: none; /* Override for full screen modal */
        }
        
        /* Spreadsheet Entry Styles (Matching user request image and color theme) */
        #spreadsheet-entry-table input,
        #spreadsheet-entry-table select {
            width: 100%;
            padding: 4px;
            font-size: 0.875rem; /* text-sm */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            min-width: 60px; /* Ensure minimum width */
            text-align: center;
            transition: background-color 0.1s ease;
        }
        
        /* Style for read-only fields */
        #spreadsheet-entry-table input[readonly], 
        #spreadsheet-entry-table .spreadsheet-product-name {
            background-color: #f3f4f6; /* gray-100 */
            cursor: default;
        }
        
        /* Highlighting specific input fields (No alternating rows, only cell colors) */
        .spreadsheet-invoice-number {
            background-color: #e0f2fe; /* Light Blue 100 */
            font-weight: 600;
        }
        .spreadsheet-product-code, 
        .spreadsheet-product-name {
            background-color: #d1fae5; /* Light Green 100 */
            font-weight: 500;
        }
        /* Style for required select fields in spreadsheet row */
        .spreadsheet-collection {
            background-color: #e5e7eb; /* Gray-200 slightly darker background */
        }
        .spreadsheet-total {
            background-color: #fce7f3; /* Pink-100 for totals */
            font-weight: 700;
            color: #9d174d; /* Rose-700 */
        }


        #spreadsheet-entry-table .spreadsheet-product-name,
        #spreadsheet-entry-table .spreadsheet-collection {
            text-align: right;
            padding-right: 8px; /* Give some space for Arabic text */
        }
        #spreadsheet-entry-table th,
        #spreadsheet-entry-table td {
            padding: 4px 6px;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        /* New styles for Promotion Price Highlight */
        #spreadsheet-entry-table .spreadsheet-price.promotion-price-applied {
            background-color: #fef3c7 !important; /* Yellow-100 */
            color: #b91c1c !important; /* Red-700 */
            font-weight: 800;
            border: 2px solid #f59e0b; /* Amber-500 */
        }
        /* Style for Tax Filing Status field */
        .spreadsheet-tax-status-input {
            background-color: #fef2f2; /* Red-50 */
            text-align: center;
        }
        /* Style for Sales List Not Filed Tax Status */
        .tax-not-filed-badge {
            background-color: #fef2f2; /* Red-50 */
            color: #991b1b; /* Red-800 */
            font-weight: 700;
            border: 2px solid #dc2626; /* Red-600 */
            padding: 2px 8px;
        }

        /* NEW: Styling for Detailed Sales Table View */
        .sale-detail-grid {
            grid-template-columns: 1fr 3fr 1fr; /* Total | Details | Actions */
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sale-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 10px;
        }
        /* Ensure table header and rows use identical grid columns for perfect alignment */
        .sale-items-table thead tr,
        .sale-items-table tbody tr {
            display: grid;
            grid-template-columns: 2fr 0.5fr 0.5fr 0.5fr auto;
            align-items: center;
        }
        .sale-items-table th,
        .sale-items-table td {
            display: block; /* allow grid children sizing */
            padding-left: .75rem; padding-right: .75rem; padding-top: .5rem; padding-bottom: .5rem;
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        /* constrain numeric inputs to the column width and center them */
        .sale-item-quantity, .sale-item-price {
            width: 100%;
            max-width: 4.5rem;
            margin: 0 auto;
            text-align: center;
        }

        /* Make sure the sale modal content clears any fixed page header */
        #sale-modal main {
            margin-top: 80px !important; /* clear the fixed top navigation */
        }

        /* Force table/thead/tbody to block so grid rows align correctly */
        .sale-items-table,
        .sale-items-table thead,
        .sale-items-table tbody {
            display: block;
            width: 100%;
        }
        .sale-items-table th, .sale-items-table td {
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        .sale-items-table th {
            font-weight: 600;
            color: #4b5563;
            background-color: #f9fafb;
        }

        /* --- NEW SALES LIST CELL COLORS (Matching Spreadsheet) --- */
        .sale-item-name-cell, .sale-item-code-cell {
            background-color: #d1fae5; /* Green-100 */
        }
        .sale-item-total-cell {
            background-color: #fce7f3; /* Pink-100 */
            color: #9d174d; /* Pink-700 for high contrast */
        }
        .sale-item-qty-cell, .sale-item-price-cell {
            background-color: #e0f2fe; /* Blue-100 */
        }
        /* -------------------------------------------------------- */


        /* NEW: Styles for dedicated printing */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }

        /* Invoice quick-search fixed sidebar (only on Sales page, desktop) */
        /* Make the invoice quick-search visible and fixed inside Sales page by default
           (always visible so user can test easily). Change media query later if you want
           to hide on small screens. */
        #page-sales #invoice-quick-search {
            display: block !important;
            position: fixed;
            left: 12px; /* position at left side like the screenshot */
            top: 96px; /* a bit lower under the sticky header */
            width: 190px;
            height: calc(100vh - 120px);
            overflow: auto;
            z-index: 9; /* stay below header (header uses z-10) */
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            background: #ffffff;
        }
        
        /* Dispatch Item Inputs Styling */
        #dispatch-items-table input {
            padding: 2px 4px !important;
            font-size: 0.75rem !important;
        }

        /* Stock Control Column Colors */
        .stock-col-initial { background-color: #e0f2fe; } /* Light Blue */
        .stock-col-inward { background-color: #dcfce7; } /* Light Green */
        .stock-col-production { background-color: #f3e8ff; } /* Light Purple */
        .stock-col-outbound { background-color: #fef9c3; } /* Light Yellow */
        .stock-col-book { background-color: #e5e7eb; } /* Gray */
        .stock-col-actual { background-color: #fee2e2; } /* Light Red */
        .stock-col-diff { background-color: #ffedd5; } /* Light Orange */
        
        /* NEW: Custom Highlight Colors for Manual Review */
        .invoice-cell {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 8px;
            display: inline-block;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 700;
        }
        .invoice-cell.highlight-blue {
            background-color: #93c5fd !important; /* Blue-300 */
            color: #1e3a8a !important; /* Blue-900 */
        }
        .invoice-cell.highlight-green {
            background-color: #86efac !important; /* Green-300 */
            color: #14532d !important; /* Green-900 */
        }
        .invoice-cell.highlight-purple {
            background-color: #c4b5fd !important; /* Violet-300 */
            color: #4c1d95 !important; /* Violet-900 */
        }
        .invoice-cell.highlight-orange {
            background-color: #fed7aa !important; /* Orange-300 */
            color: #7c2d12 !important; /* Orange-900 */
        }
        .invoice-cell.highlight-teal {
            background-color: #99f6e4 !important; /* Teal-300 */
            color: #0f766e !important; /* Teal-800 */
        }
        /* ===== Debts page custom layout (matches provided screenshot) ===== */
        #debts-detail-table th {
    background: linear-gradient(180deg,#ffd700,#daa520) !important;
    color: black !important;
    font-weight: bold !important;
    padding: 8px !important;
    border: 1px solid #c4a300 !important;
    text-align: center !important;
}

.debts-container {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        .debts-sidebar {
            width: 320px; /* fixed left column */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .debts-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }
        .debt-card {
            border-radius: 10px;
            padding: 22px 16px;
            margin-bottom: 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
            background: linear-gradient(180deg, #fff7ed, #fef3c7);
        }
        .debt-card .title {
            font-weight: 700;
            color: #7c4a00;
            margin-bottom: 6px;
        }
        .debt-card .value {
            font-size: 28px;
            font-weight: 800;
            color: #3b2a0d;
        }
        .debt-card.big {
            background: linear-gradient(180deg,#7a4300,#3b2300);
            color: #fff;
            padding: 26px 18px;
        }

        /* Make the debts table header gold gradient */
        .gold-header th {
            background: linear-gradient(180deg,#f6d06a,#d59d00);
            color: #3b2a04;
            font-weight: 800;
            padding: 14px;
            border-right: 1px solid rgba(255,255,255,0.15);
        }
        /* Adjust table to take remaining space */
        .debts-main {
            flex: 1 1 auto;
        }
        /* Small adjustments for date inputs and filters to match screenshot */
        .filter-input { height:44px; padding:10px 12px; }
        
        /* Fix for debts table visibility: ensure table elements use proper table display types
           and prevent parent overflow from clipping rows when rendering under some environments. */
          #debts-detail-table { display: table !important; width: 100% !important; table-layout: auto !important; position: relative !important; z-index: 5 !important; }
        #debts-detail-table thead { display: table-header-group !important; }
        #debts-detail-table tbody { display: table-row-group !important; }
        #debts-detail-table tr { display: table-row !important; visibility: visible !important; opacity: 1 !important; }
        #debts-detail-table td, #debts-detail-table th { display: table-cell !important; color: inherit !important; }
        .debts-main .overflow-x-auto { overflow: auto !important; }

        /* Stronger visibility rules for debts rows in case theme/global CSS hides them */
        #debts-detail-table tbody tr td {
            color: #111 !important;
            background: transparent !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: table-cell !important;
            font-size: 14px !important;
        }
        #debts-detail-table tbody {
            min-height: 120px !important;
        }
        /* Allow JS filtering to hide rows even with the base !important rules */
        #debts-detail-table tr.hidden-by-filter { display: none !important; }
        /* Ensure debts main content sits above any large background watermark */
        .debts-main { position: relative !important; z-index: 6 !important; }

        /* Column filter UI removed (restored original header behavior) */
        /* Re-introduced column filter UI styles */
        .column-filter-btn {
            display:inline-block;
            background:transparent;
            border:0;
            cursor:pointer;
            padding:2px 6px;
            margin-inline-start:6px;
            border-radius:4px;
            font-size:14px;
        }
        .column-filter-btn:hover { background: rgba(0,0,0,0.04); }
        .column-filter-menu {
            position: absolute;
            z-index: 99999;
            background: #fff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            padding: 8px;
            width: 260px;
            max-height: 340px;
            overflow: hidden;
            direction: rtl;
            display: none;
            border-radius: 6px;
        }
        .column-filter-menu .filter-search { width:100%; padding:8px; border:1px solid #e5e7eb; margin-bottom:6px; border-radius:4px; }
        .column-filter-menu .filter-list { max-height:200px; overflow:auto; padding-right:6px; }
        .column-filter-menu .filter-list label { display:block; padding:4px 2px; font-size:13px; }
        .column-filter-menu .filter-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
        .column-filter-menu .filter-actions button { padding:6px 10px; border-radius:6px; border:0; cursor:pointer; }
        .column-filter-menu .apply-btn { background:#f97316; color:white; }
        .column-filter-menu .clear-btn { background:#f3f4f6; color:#111; }

        /* Alternating row colors to match the screenshot */
        /* Even rows - lighter gold */
        #debts-detail-table tbody tr:nth-child(even) td {
            background: linear-gradient(180deg, #fff5d5, #ffd868) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }
        
        /* Odd rows - darker gold */
        #debts-detail-table tbody tr:nth-child(odd) td {
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }

        /* Money columns - all centered */
        #debts-detail-table tbody tr td.total,
        #debts-detail-table tbody tr td.paid,
        #debts-detail-table tbody tr td.remaining {
            text-align: center !important;
        }

        /* Text alignment */
        #debts-detail-table tbody tr td {
            text-align: center !important;
        }
        #debts-detail-table tbody tr td.customer-name {
            text-align: right !important;
        }

        /* Header styling (legacy) - replaced by Cool Gradient theme below */
        #debts-detail-table thead th {
            /* legacy fallback kept intentionally */
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: bold !important;
            padding: 8px !important;
            text-align: center !important;
        }

        /* ===== Cool Gradient Theme for Debts Table ===== */
        /* Table shell */
        #debts-detail-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-family: Arial, sans-serif !important;
            direction: rtl !important;
            border: 1px solid #a5b4fc !important; /* cool cyan border */
            color: #0f172a !important;
        }

        /* Glossy linear gradient header: right (dark purple) â†’ royal blue â†’ teal (left) */
        #debts-detail-table thead th {
            background: linear-gradient(to left, #2c0f5b 0%, #2b6cb0 50%, #06b6d4 100%) !important;
            color: #ffffff !important;
            font-weight: 800 !important;
            padding: 10px 12px !important;
            text-align: center !important;
            border-bottom: 1px solid rgba(0,0,0,0.12) !important;
            border-top: 2px solid rgba(255,255,255,0.35) !important; /* slight white top-border for glossy effect */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
        }

        /* First column (right-most) - Date/Day */
        #debts-detail-table tbody td:first-child,
        #debts-detail-table tbody th:first-child {
            background: #2c0f5b !important; /* dark purple */
            color: #ffffff !important;
            font-weight: 700 !important;
            text-align: right !important;
            border-right: 1px solid #a5b4fc !important;
        }

        /* Data column tints (3-column repeating pattern) */
        /* Pattern: (3n+1) soft blue, (3n+2) light lavender, (3n+3) pale cyan */
        #debts-detail-table tbody td:nth-child(3n+1) {
            background: rgba(230,240,255,0.85) !important; /* soft blue */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }
        #debts-detail-table tbody td:nth-child(3n+2) {
            background: rgba(243,229,255,0.88) !important; /* light lavender */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }
        #debts-detail-table tbody td:nth-child(3n+3) {
            background: rgba(224,247,250,0.88) !important; /* pale cyan */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }

        /* Zebra-striping overlay: slightly adjust tint on even rows */
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+1) { background: rgba(216,230,255,0.9) !important; }
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+2) { background: rgba(236,228,255,0.9) !important; }
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+3) { background: rgba(206,244,246,0.9) !important; }

        /* Money/total cells highlight */
        #debts-detail-table tbody tr td.total,
        #debts-detail-table tbody tr td.paid,
        #debts-detail-table tbody tr td.remaining {
            background: #06b6d4 !important; /* bright cyan/teal */
            color: #ffffff !important;
            font-weight: 800 !important;
            border: 1px solid #7dd3fc !important;
        }

        /* Hover accent */
        #debts-detail-table tbody tr:hover td {
            transform: translateY(0);
            box-shadow: inset 0 0 0 9999px rgba(255,255,255,0.02);
            transition: background-color 120ms ease;
        }

        /* Footer */
        #debts-detail-table tfoot td {
            background: linear-gradient(to left, #0f172a, #1e293b) !important; /* dark indigo/navy */
            color: #ffffff !important;
            font-weight: 700 !important;
            padding: 10px !important;
            border-top: 2px solid #a5b4fc !important;
        }

        /* Ensure cells have visible cool-blue borders */
        #debts-detail-table td, #debts-detail-table th {
            border: 1px solid #a5b4fc !important;
            padding: 8px !important;
        }

        /* Keep customer name right-aligned for Arabic */
        #debts-detail-table tbody tr td.customer-name { text-align: right !important; }

        /* Small responsive fix: allow table to scroll horizontally */
        .debts-main .overflow-x-auto { overflow-x: auto !important; }

        /* End Cool Gradient Theme */

        /* Summary boxes styling - different gold gradients */
        .debt-card {
            padding: 20px !important;
            border-radius: 8px !important;
            margin: 8px !important;
        }

        /* Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± */
        .debt-card:nth-child(1) {
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            color: black !important;
        }

        /* Ø§Ù„Ù…Ø³Ø¯Ø¯ */
        .debt-card:nth-child(2) {
            background: linear-gradient(180deg, #f0c233, #cc9900) !important;
            color: black !important;
        }

        /* SUB TOTAL */
        .debt-card:nth-child(3) {
            background: linear-gradient(180deg, #ffdb4d, #e6b800) !important;
            color: black !important;
        }

        /* Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª - lighter brown */
        .debt-card.big {
            background: linear-gradient(180deg, #8b6914, #654b0f) !important;
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        }

        /* Hover effect - lighter gold for both odd and even rows */
        #debts-detail-table tbody tr:hover td {
            background: linear-gradient(180deg, #fff7e6, #ffe180) !important;
        }

    </style>
</head>
<body class="bg-gray-100">
    <script>
        // Ensure a safe updateIcons exists early to prevent ReferenceError when other scripts call it.
        if (!window.updateIcons) {
            window.updateIcons = function(){
                try {
                    if (window.lucide && typeof window.lucide.replace === 'function') {
                        window.lucide.replace();
                        return;
                    }
                    if (window.Lucide && typeof window.Lucide.replace === 'function') {
                        window.Lucide.replace();
                        return;
                    }
                } catch(e) {
                    // ignore
                }
            };
        }

        // Debug helper: reveal invoice sidebar (type manually in Console if needed)
        window.showInvoiceQuickSearch = function(){
            try {
                var el = document.getElementById('invoice-quick-search-panel') || document.getElementById('invoice-quick-search-global');
                if (el) el.style.display = '';
                return !!el;
            } catch(e){ return false; }
        };
    </script>
    <style>
        /* Targets table grid: soft horizontal lines + clear vertical separators */
        .targets-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .targets-table th, .targets-table td { padding: 6px 8px; font-size: 12px; text-align: center; }
        .targets-table tbody td { border-bottom: 1px solid rgba(17,24,39,0.06); }
        .targets-table td + td, .targets-table th + th { border-left: 2px solid rgba(59,130,246,0.25); }
        .targets-col-day { background:#e8f2ff; color:#0b1b34; }
        .targets-col-total { background:#ffe4e6; color:#0b1b34; font-weight:700; }
        /* Customer targets visual style (approximate to provided Excel screenshot) */
        .customer-targets-table { border-collapse: separate; border-spacing:0; width:100%; font-size:12px; }
        .customer-targets-table th { padding:6px 6px; font-weight:700; color:#fff; text-align:center; }
        .cth-name { background:#2f2f34; }
        .cth-multi-target, .cth-dairy-target { background:#b66a00; }
        .cth-multi-ach, .cth-dairy-ach { background:#0f2d64; }
        .cth-total-target { background:#004d40; }
        .cth-total-ach { background:#003366; }
        .cth-rem, .cth-rem-total { background:#5a3d00; }
        .cth-pct, .cth-pct-total { background:#2c3e50; }
        .customer-targets-table tbody tr:nth-child(even) td { background:#f9fafb; }
        .customer-targets-table tbody tr:nth-child(odd) td { background:#fff; }
        .customer-targets-table td { padding:5px 6px; text-align:center; border-bottom:1px solid #e5e7eb; }
        .customer-targets-table td.name { text-align:right; font-weight:600; }
        .customer-targets-table input.cust-target-input { background:#fff; font-size:11px; }
        .customer-targets-table .ach-cell { font-weight:600; color:#0d47a1; }
        .customer-targets-table .rem-pos { color:#b45309; font-weight:600; }
        .customer-targets-table .rem-zero { color:#059669; font-weight:600; }
        .customer-targets-table .pct-ok { color:#047857; font-weight:600; }
        .customer-targets-table .pct-low { color:#374151; font-weight:600; }
        .ghost-zero::before { content:'0'; opacity:0.35; }
    </style>
    <style>
        /* Hide accidental visible code blocks that may appear at top of page */
        body > pre, body > code, .top-debug-text { display: none !important; }
    </style>
    <!-- Removed duplicate global quick-search; using page-local panel inside #page-sales -->
    <script>
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø· - ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒÙˆØ¯
        function showDashboardPage() {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
                pages[i].style.display = 'none';
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            var dashboard = document.getElementById('page-dashboard');
            if (dashboard) {
                dashboard.classList.add('active');
                dashboard.style.display = 'block';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„
            var navItems = document.getElementsByClassName('bottom-nav-item');
            for (var i = 0; i < navItems.length; i++) {
                navItems[i].classList.remove('active');
                if (navItems[i].getAttribute('data-page') === 'dashboard') {
                    // Ø¶Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                    navItems[i].classList.add('active');
                }
            }

            // ØªØ¹Ø§Ù…Ù„ Ø¯ÙØ§Ø¹ÙŠ Ù…Ø¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨ÙŠØ§Ù† (Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ø¹Ù†Ø§ØµØ± DOM Ù…Ø¹Ø±ÙØ© Ø¹Ù†Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø©)
            var statementCustomerListEl = document.getElementById('statement-customer-list');
            var statementCustomerSearchEl = document.getElementById('statement-customer-search');
            if (statementCustomerListEl && statementCustomerSearchEl) {
                statementCustomerSearchEl.value = '';
                try { updateCustomerList(''); } catch (e) { console.warn('updateCustomerList failed during dashboard init', e); }
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
            try { updateIcons(); } catch (e) { console.warn('updateIcons failed', e); }

            // Keep the Cash page synchronized whenever main UI re-renders (e.g., after save/delete)
            try { if (typeof renderCash === 'function') renderCash(); } catch (e) { console.warn('renderCash failed from renderAll', e); }
        }

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
        document.addEventListener('DOMContentLoaded', showDashboardPage);
        
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        window.addEventListener('load', showDashboardPage);
        
        // ØªÙ†ÙÙŠØ° ÙÙˆØ±ÙŠ Ù„Ù„ØªØ£ÙƒØ¯
        showDashboardPage();
    </script>

    <!-- UI Navigation & Authentication Handler -->
    <script>
        const UIController = {
            // Ø¹Ø±Ø¶ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            showLoginPage() {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('register-page').classList.add('hidden');
                document.getElementById('app-container').classList.add('hidden');
            },

            // Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            showRegisterPage() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('register-page').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            },

            // Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            showApp() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('register-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                this.updateCurrentUserDisplay();
            },

            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            updateCurrentUserDisplay() {
                const user = AuthSystem.getCurrentUser();
                const userDisplay = document.getElementById('current-user-display');
                if (user && userDisplay) {
                    const role = getUserRole();
                    userDisplay.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.name} (${role})`;
                    try {
                        // Toggle admin map button visibility based on role
                        const mapBtn = document.getElementById('open-map-btn');
                        if (mapBtn) mapBtn.classList.toggle('hidden', role !== 'admin');
                    } catch(e){}
                }
            },

            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ø«Ù… Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            showPage(pageId) {
                const pages = document.querySelectorAll('.page');
                pages.forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                const page = document.getElementById(pageId);
                if (page) {
                    page.classList.add('active');
                    page.style.display = 'block';
                }
            }
        };

        // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ù†Ù…Ø§Ø°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.addEventListener('DOMContentLoaded', () => {
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            try {
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-target');
                        const input = document.getElementById(id);
                        if (!input) return;
                        input.type = input.type === 'password' ? 'text' : 'password';
                        btn.textContent = input.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
                    });
                });
            } catch(e) { /* ignore */ }
            // Ù…Ø¹Ø§Ù„Ø¬ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø©)
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const rememberEl = document.getElementById('login-remember');
                    const remember = rememberEl ? rememberEl.checked : false;
                    
                    // Use new service-based login (hybrid mode)
                    const result = await (typeof window.loginUsingServices === 'function'
                        ? window.loginUsingServices(email, password, { showAlertOnError: false })
                        : AuthSystem.login(email, password));
                    
                    if (result.ok || result.success) {
                        if (remember) {
                            localStorage.setItem('app_remember_email', email);
                        }
                        loginForm.reset();
                        // onAuthStateChanged Ø³ÙŠÙƒÙ…Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                    } else {
                        alert('âŒ Ø®Ø·Ø£: ' + (result.error || result.message));
                    }
                });
            }

            // Ù…Ø¹Ø§Ù„Ø¬ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ù…ÙˆØ¯Ø§Ù„)
            const loginFormModal = document.getElementById('login-modal-form');
            if (loginFormModal) {
                loginFormModal.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailEl = document.getElementById('login-email-modal');
                    const passEl = document.getElementById('login-password-modal');
                    const email = emailEl ? emailEl.value : '';
                    const password = passEl ? passEl.value : '';
                    // Use new service-based login (hybrid mode)
                    const result = await (typeof window.loginUsingServices === 'function'
                        ? window.loginUsingServices(email, password, { showAlertOnError: false })
                        : AuthSystem.login(email, password));
                    if (result.ok || result.success) {
                        loginFormModal.reset();
                        try { closeModal(document.getElementById('login-modal')); } catch(_){}
                    } else {
                        alert('âŒ Ø®Ø·Ø£: ' + (result.error || result.message));
                    }
                });
            }

            // Ù…Ø¹Ø§Ù„Ø¬ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const confirmPassword = document.getElementById('register-password-confirm').value;
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
                    if (password !== confirmPassword) {
                        alert('âŒ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
                        return;
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                    if (password.length < 6) {
                        alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                        return;
                    }
                    
                    const result = await AuthSystem.register(email, password, name);
                    
                    if (result.success) {
                        alert('âœ… ' + result.message + '\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                        
                        // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                        registerForm.reset();
                        
                        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        UIController.showLoginPage();
                    } else {
                        alert('âŒ Ø®Ø·Ø£: ' + result.message);
                    }
                });
            }

            // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØµÙØ­Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
            const goToRegisterBtn = document.getElementById('go-to-register-btn');
            if (goToRegisterBtn) {
                goToRegisterBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    UIController.showRegisterPage();
                });
            }

            const goToLoginBtn = document.getElementById('go-to-login-btn');
            if (goToLoginBtn) {
                goToLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    UIController.showLoginPage();
                });
            }

            // Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                        // Use new service-based logout (hybrid mode)
                        await (typeof window.logoutUsingServices === 'function'
                            ? window.logoutUsingServices({ showAlertOnError: false })
                            : AuthSystem.logout());
                        localStorage.removeItem('app_remember_email');
                        UIController.showLoginPage();
                    }
                });
            }

            // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„
            // Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ onAuthStateChanged ÙÙ‚Ø·ØŒ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ù† ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸Ø§Ù‹
            const rememberEmail = localStorage.getItem('app_remember_email');
            if (rememberEmail) {
                const pageEmail = document.getElementById('login-email');
                if (pageEmail) pageEmail.value = rememberEmail;
                const modalEmail = document.getElementById('login-email-modal');
                if (modalEmail) modalEmail.value = rememberEmail;
            }
            UIController.showLoginPage();
        });

        // Ø¯Ø§Ù„Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        async function initializeAppForUser() {
            // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¨Ø³Ø·Ø©: Ù†Ø¹ØªÙ…Ø¯ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠØ© Ø§Ù„ØªÙŠ Ø³ØªÙ…Ù„Ø£ state.
            // ØªØ­Ø¯ÙŠØ¯ activePeriod: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ localStorage Ø§Ù„Ù…Ø­ÙÙˆØ¸
            const currentPeriod = __formatPeriod(new Date());
            if (!window.state) {
                window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], productions: [], settings: { salesTarget: 10000 }, stockEntries: {}, activePeriod: currentPeriod };
                // CRITICAL: Load stockEntries from localStorage on init
                try {
                    const saved = localStorage.getItem('stock_entries');
                    if (saved) window.state.stockEntries = JSON.parse(saved);
                } catch(e){ console.warn('Failed to restore stockEntries during init', e); }
            }
            else {
                // tØ­Ø¯ÙŠØ« activePeriod Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
                window.state.activePeriod = currentPeriod;
                // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ productions array
                if (!Array.isArray(window.state.productions)) window.state.productions = [];
                // CRITICAL: Preserve stockEntries from localStorage if available
                try {
                    if (!window.state.stockEntries || Object.keys(window.state.stockEntries).length === 0) {
                        const saved = localStorage.getItem('stock_entries');
                        if (saved) window.state.stockEntries = JSON.parse(saved);
                    }
                } catch(e){ console.warn('Failed to restore stockEntries during re-init', e); }
            }
            // Ø­ÙØ¸ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ localStorage
            try { localStorage.setItem('active_period', currentPeriod); } catch(e){}
            console.log(`initializeAppForUser: Set activePeriod to ${currentPeriod}`);
            try { UIController.updateCurrentUserDisplay(); } catch(e){}
            
            // === PHASE 4: Load Products with Cache-First Strategy ===
            try {
                if (typeof window.ProductsService === 'object' && typeof window.ProductsService.getProducts === 'function') {
                    console.log('Loading products with Cache-First strategy...');
                    const products = await window.ProductsService.getProducts({ maxAgeMs: 6 * 60 * 60 * 1000 });
                    if (Array.isArray(products) && products.length > 0) {
                        window.state.products = products;
                        console.log(`âœ… Loaded ${products.length} products from cache/server`);
                    } else {
                        console.warn('No products loaded, using empty array');
                        window.state.products = [];
                    }
                } else {
                    console.warn('ProductsService not available, using empty products array');
                    window.state.products = [];
                }
            } catch(e) {
                console.error('Failed to load products:', e);
                window.state.products = [];
            }
            
            // === PHASE 5: Load Customers with Cache-First Strategy ===
            try {
                if (typeof window.CustomersService === 'object' && typeof window.CustomersService.getCustomers === 'function') {
                    console.log('Loading customers with Cache-First strategy...');
                    const customers = await window.CustomersService.getCustomers({ maxAgeMs: 6 * 60 * 60 * 1000 });
                    if (Array.isArray(customers) && customers.length > 0) {
                        window.state.customers = customers;
                        console.log(`âœ… Loaded ${customers.length} customers from cache/server`);
                    } else {
                        console.warn('No customers loaded, using empty array');
                        window.state.customers = [];
                    }
                } else {
                    console.warn('CustomersService not available, using empty customers array');
                    window.state.customers = [];
                }
            } catch(e) {
                console.error('Failed to load customers:', e);
                window.state.customers = [];
            }
            
            // Ø¥Ø¬Ø¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¨Ø¹Ø¯ Ù‚ØµÙŠØ± Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            setTimeout(()=>{
                try { 
                    ensureDefaultActivePeriod();
                    console.log(`Forced activePeriod check: current=${currentPeriod}, saved=${localStorage.getItem('active_period')}`);
                } catch(e){}
            }, 500);
        }

        // Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯ (ÙŠØ­ÙØ¸ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø±Ø¨Ø·Ù‡ Ø¨Ù€ Firebase)
        const DataManager = {
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            saveAppState(stateObj) {
                const user = AuthSystem.getCurrentUser();
                if (!user) {
                    console.warn('Cannot save state: no current user logged in');
                    return false;
                }
                
                try {
                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¢Ù†
                    localStorage.setItem('app_state', JSON.stringify(stateObj));
                    
                    // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    user.data.lastAppState = stateObj;
                    AuthSystem.setCurrentUser(user);

                    // Ø­Ø§ÙˆÙ„ Ø£ÙŠØ¶Ø§Ù‹ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Firebase (Ø¥Ù† ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡)
                    try {
                        if (typeof saveStateToFirebase === 'function') {
                            saveStateToFirebase(stateObj).then(ok => {
                                if (ok) console.log('âœ… saved state to Firebase');
                            }).catch(e => console.warn('Failed to save state to Firebase', e));
                        }
                    } catch(e) { console.warn('saveStateToFirebase error', e); }

                    return true;
                } catch (e) {
                    console.error('Error saving app state:', e);
                    return false;
                }
            },

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            loadAppState() {
                const user = AuthSystem.getCurrentUser();
                
                try {
                    // Ø¬Ø±Ø¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    const localData = localStorage.getItem('app_state');
                    if (localData) {
                        return JSON.parse(localData);
                    }
                    
                    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ Ø¬Ø±Ø¨ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    if (user && user.data && user.data.lastAppState) {
                        return user.data.lastAppState;
                    }
                    
                    return null;
                } catch (e) {
                    console.error('Error loading app state:', e);
                    return null;
                }
            },

            // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            clearUserData() {
                const user = AuthSystem.getCurrentUser();
                if (!user) return false;
                
                try {
                    user.data = {};
                    AuthSystem.setCurrentUser(user);
                    localStorage.removeItem('app_state');
                    return true;
                } catch (e) {
                    console.error('Error clearing user data:', e);
                    return false;
                }
            }
        };

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø± (ÙˆØ§Ø¬Ù‡Ø© + Ø±Ø¨Ø· Firestore)
        function canManageUsers(){ try { return getUserRole() === 'admin'; } catch(e){ return false; } }

        function updateUserManagementVisibility(){
            const sec = document.getElementById('user-management-section');
            if (!sec) return;
            if (canManageUsers()) {
                sec.classList.remove('hidden');
                try { renderUsersTable(); } catch(e){}
            } else {
                sec.classList.add('hidden');
            }
        }

        function renderUsersTable(){
            const tbody = document.getElementById('users-table-body');
            const warn = document.getElementById('user-role-warning');
            if (!tbody) return;
            if (!canManageUsers()) { if (warn){ warn.textContent = 'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·.'; warn.classList.remove('hidden'); } return; }
            if (warn) warn.classList.add('hidden');
            const list = Array.isArray(window.state && state.users) ? state.users : [];
            if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="px-2 py-3 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¨Ø¹Ø¯.</td></tr>'; return; }
            const current = AuthSystem.getCurrentUser();
            tbody.innerHTML = list.map(u => {
                const role = (u.role || 'user');
                const disabled = (current && current.id === u._id) ? 'data-self="1"' : '';
                const pres = (window.state && Array.isArray(state.presence)) ? state.presence.find(p => (p._id===u._id) || (p.uid===u._id) || ((p.email||'').toLowerCase() === (u.email||'').toLowerCase())) : null;
                const online = (typeof u.online !== 'undefined') ? !!u.online : !!(pres && pres.online === true); // ÙÙ‚Ø· trueØŒ Ù„ÙŠØ³ !== false
                const emailStr = ((u.email||'').toLowerCase()) || ((pres && pres.email) ? (pres.email||'').toLowerCase() : '');
                return `<tr>
                    <td class="px-2 py-2">${u.name || '-'}</td>
                    <td class="px-2 py-2 flex items-center gap-2">
                        <span class="inline-block w-2.5 h-2.5 rounded-full ${online ? 'bg-green-500' : 'bg-gray-400'}" title="${online ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªØµÙ„'}"></span>
                        <span>${emailStr}</span>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <select class="user-role-select p-1 border rounded" data-uid="${u._id}" ${disabled}>
                            <option value="admin" ${role==='admin'?'selected':''}>admin</option>
                            <option value="rep" ${role==='rep'?'selected':''}>rep</option>
                            <option value="viewer" ${role==='viewer'?'selected':''}>viewer</option>
                            <option value="user" ${role==='user'?'selected':''}>user</option>
                        </select>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="apply-role-btn bg-blue-600 text-white px-3 py-1 rounded text-xs" data-uid="${u._id}">ØªØ·Ø¨ÙŠÙ‚</button>
                            ${emailStr ? '' : `<button class="set-user-email-btn bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs" title="Ø¥Ø¶Ø§ÙØ© Ø¨Ø±ÙŠØ¯" data-uid="${u._id}">Ø¥Ø¶Ø§ÙØ© Ø¨Ø±ÙŠØ¯</button>`}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØºÙŠÙŠØ± ÙˆØ§Ù„Ø­ÙØ¸
        document.addEventListener('click', async function(e){
            const btn = e.target && e.target.closest ? e.target.closest('.apply-role-btn') : null;
            if (!btn) return;
            if (!canManageUsers()) { alert('Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); return; }
            const uid = btn.getAttribute('data-uid');
            const sel = document.querySelector(`select.user-role-select[data-uid="${uid}"]`);
            if (!uid || !sel) return;
            const role = sel.value;
            const current = AuthSystem.getCurrentUser();
            if (current && current.id === uid && role !== 'admin') {
                if (!confirm('Ø£Ù†Øª ØªØ­Ø§ÙˆÙ„ Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø´Ø±Ù Ø¹Ù† Ù†ÙØ³ÙƒØŒ Ù‚Ø¯ ØªÙÙ‚Ø¯ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            }
            try {
                // ØªØ­Ø¯ÙŠØ« users/{uid}.role
                await db.collection('users').doc(uid).set({ role: role }, { merge: true });
                // ØªØ­Ø¯ÙŠØ« roles/{uid}.role Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
                try { await db.collection('roles').doc(uid).set({ role: role }, { merge: true }); } catch(_e){}
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
            } catch (err) {
                console.warn('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±', err);
                alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
            }
        });

        document.addEventListener('click', function(e){
            const r = e.target && e.target.id === 'refresh-users-btn';
            if (!r) return;
            try { renderUsersTable(); } catch(e){}
        });

        // Auto-save when the new-price input changes (so user doesn't have to press the button)
        document.addEventListener('change', function(e){
            const inp = e.target && e.target.classList && e.target.classList.contains('unified-new-price') ? e.target : null;
            if(!inp) return;
            const id = inp.getAttribute('data-id');
            const typeLabel = inp.getAttribute('data-type');
            const rawVal = (inp.value||'').trim(); if(rawVal==='' ) return;
            const num = parseFloat(rawVal); if(isNaN(num)) { alert('Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
            const mapType = t => t==='Ø®Ø§Ù…Ø©'?'raw': (t==='ØªØºÙ„ÙŠÙ'?'pack': (t==='ØªØ´ØºÙŠÙ„'?'ops': (t==='Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠ'?'finished':'raw')));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); if(!it){ alert('Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
            const now = new Date().toISOString();
            it.lastPrice = num; it.lastPriceDate = now; it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; it.priceHistory.unshift({ price: num, date: now, note: 'Ø´Ø¨ÙƒØ© Ù…ÙˆØ­Ø¯Ø©' });
            saveLists();
            // update current price span
            const currentSpan = document.querySelector(`.unified-current-price[data-id="${CSS.escape(id)}"][data-type="${CSS.escape(typeLabel)}"]`);
            if(currentSpan) currentSpan.textContent = Number(num).toFixed(2);
            showSavedIndicator(inp);
            // keep input value as-is or clear depending on UX; here we clear to indicate completion
            inp.value = '';
            console.log('âœ… unified-new-price change saved');
        });

        // Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
        document.addEventListener('click', async function(e){
            const btn = e.target && e.target.closest ? e.target.closest('.set-user-email-btn') : null;
            if (!btn) return;
            if (!canManageUsers()) { alert('Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); return; }
            const uid = btn.getAttribute('data-uid');
            const currentEmail = (state.users||[]).find(u=>String(u._id)===String(uid))?.email || '';
            const val = prompt('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', currentEmail || '');
            if (!val) return;
            const email = String(val).trim().toLowerCase();
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('ØµÙŠØºØ© Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
            try {
                await db.collection('users').doc(uid).set({ email }, { merge: true });
                // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ£Ø¹Ø¯ Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
                try {
                    const i = (state.users||[]).findIndex(u=>String(u._id)===String(uid));
                    if (i>=0) { state.users[i] = Object.assign({}, state.users[i], { email }); }
                } catch(_){ }
                renderUsersTable();
            } catch(err){
                alert('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙŠØ¯');
                console.warn('set email failed', err);
            }
        });

        // Ø²Ø± ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        document.addEventListener('click', function(e){
            const openBtn = e.target && (e.target.id === 'open-user-management-btn' || (e.target.closest && e.target.closest('#open-user-management-btn')));
            if (!openBtn) return;
            if (!canManageUsers()) { alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·'); return; }
            const sec = document.getElementById('user-management-section');
            if (sec) {
                sec.classList.remove('hidden');
                try { sec.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e){}
            }
        });

        // Ø£Ø¸Ù‡Ø±/Ø£Ø®ÙÙ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        document.addEventListener('DOMContentLoaded', updateUserManagementVisibility);
        try { UIController.updateCurrentUserDisplay = (function(orig){ return function(){ try { orig.call(UIController); } catch(e){}; try { updateUserManagementVisibility(); } catch(e){}; }; })(UIController.updateCurrentUserDisplay); } catch(e){}
    </script>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Ù…Ø±Ø­Ø¨Ø§Ù‹</h1>
                <p class="text-gray-600 mt-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">
                            ğŸ‘ï¸
                        </button>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="login-remember" class="h-4 w-4 text-blue-600 rounded">
                    <label for="login-remember" class="mr-2 text-sm text-gray-600">ØªØ°ÙƒØ±Ù†ÙŠ</label>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">Ø¯Ø®ÙˆÙ„</button>

                <div class="text-center text-sm text-gray-600">
                    <p>Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ <button type="button" id="go-to-register-btn" class="text-blue-600 hover:underline font-semibold">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button></p>
                </div>
            </form>

            <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                <p><strong>Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹:</strong></p>
                <p>Ø§Ù„Ø¨Ø±ÙŠØ¯: test@example.com</p>
                <p>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: test123</p>
            </div>
        </div>
    </div>

    <!-- REGISTER PAGE -->
    <div id="register-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
                <p class="text-gray-600 mt-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
            </div>
            
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="register-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" required>
                </div>

                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                </div>

                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©" required>
                </div>

                <div>
                    <label for="register-password-confirm" class="block text-sm font-medium text-gray-700 mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="register-password-confirm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>

                <div class="text-center text-sm text-gray-600">
                    <p>Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <button type="button" id="go-to-login-btn" class="text-blue-600 hover:underline font-semibold">Ø¯Ø®ÙˆÙ„</button></p>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="mx-auto bg-white shadow-lg min-h-screen hidden">
        
        <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 no-print flex justify-between items-center">
            <div class="flex items-center">
                <img id="company-logo-img" src="" alt="Ø´Ø¹Ø§Ø±" style="height:40px;display:none;margin-left:10px;border-radius:6px;background:white;padding:2px;" />
                <h1 id="header-title" class="text-xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h1>
            </div>
            <!-- Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
            <div class="flex-1 flex justify-center">
                <div id="digital-clock" class="text-2xl font-mono font-bold text-white tracking-widest" style="letter-spacing:0.1em;">00:00:00</div>
            </div>
            <div class="flex items-center gap-4">
                <!-- GPS quick toggle for reps (no need to open settings) -->
                <button id="gps-toggle-btn" class="px-2 py-1 rounded text-xs font-semibold bg-red-500 text-white hover:bg-red-600" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹">GPS OFF</button>
                <!-- Admin-only: open interactive map modal for all reps -->
                <button id="open-map-btn" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-xs font-semibold flex items-center gap-1" title="Ø¹Ø±Ø¶ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨">
                    <span>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</span>
                </button>
                <span id="reviewer-badge" class="hidden bg-amber-500 text-white px-2 py-1 rounded text-xs font-semibold" title="ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                <span id="current-user-display" class="text-white text-sm"></span>
                <!-- Cloud sync UI removed: using Local Storage for stock/costing -->
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <main class="p-4">
            <!-- Admin Map Modal -->
            <div id="reps-map-modal" class="hidden fixed inset-0 z-40 bg-black bg-opacity-50 items-center justify-center" style="display:none;">
                <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                        <h3 class="font-bold text-gray-800">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
                        <button id="close-map-btn" class="text-gray-600 hover:text-black">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                    <div class="p-0">
                        <div id="reps-map" style="height:70vh; width:100%;"></div>
                    </div>
                </div>
            </div>
            <div id="page-dashboard" class="page active">
                <div class="mb-4 grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div>
                        <label for="dashboard-rep-filter" class="block text-sm font-medium text-gray-700">Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                        <select id="dashboard-rep-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-green-800 font-semibold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø§Ù„Ø´Ù‡Ø±)</h3>
                        <p id="total-sales" class="text-2xl font-bold text-green-900 mt-1">0 Ø¬.Ù…</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-blue-800 font-semibold">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø©</h3>
                        <p id="total-collected" class="text-2xl font-bold text-blue-900 mt-1">0 Ø¬.Ù…</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-orange-800 font-semibold">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</h3>
                        <p id="total-due" class="text-2xl font-bold text-orange-900 mt-1">0 Ø¬.Ù…</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-purple-800 font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
                        <p id="sales-count" class="text-2xl font-bold text-purple-900 mt-1">0</p>
                    </div>
                </div>

                <!-- Target Progress -->
                <div class="mb-6">
                    <h3 id="target-title" class="font-bold text-gray-800 mb-2">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ:</h3>
                    <h4 id="target-amount-display" class="text-blue-600 font-bold text-lg mb-2"></h4>
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="target-progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill text-xs text-white text-center" style="width: 0%;">
                            <span id="target-progress-text">0%</span>
                        </div>
                    </div>
                </div>

                <!-- CHART / GRAPHS SECTION (Kept charts in Dashboard for dual purpose) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <!-- Daily Sales Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                        <div class="h-64">
                            <canvas id="sales-7-days-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Reps Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (Ù…Ø¨ÙŠØ¹Ø§Øª)</h3>
                        <div class="h-64">
                            <canvas id="top-reps-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Products (Quantity/Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ÙƒÙ…ÙŠØ©)</h3>
                         <div class="h-64">
                            <canvas id="top-products-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top Customers (Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ù‚ÙŠÙ…Ø©)</h3>
                         <div class="h-64">
                            <canvas id="top-customers-chart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- END CHART / GRAPHS SECTION -->
                
                <!-- The Reports button is no longer needed in the Dashboard -->
                <div class="mb-6 hidden">
                    <button id="view-reports-btn" class="w-full bg-blue-700 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-blue-800 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        <span>Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</span>
                    </button>
                </div>
                
                <div class="mb-6">
                    <button id="manual-statement-btn" class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-gray-700 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="file-text"></i>
                        <span>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙŠØ¯ÙˆÙŠ</span>
                    </button>
                </div>

                

                <div>
                    <h3 class="font-bold text-gray-800 mb-3">Ø£Ø­Ø¯Ø« Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹</h3>
                    <div id="recent-sales-list" class="space-y-3">
                        <p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨ÙŠØ¹ Ø¨Ø¹Ø¯.</p>
                    </div>
                </div>
            </div>

            <div id="page-sales" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="receipt" class="w-6 h-6 text-blue-600"></i>
                        <span>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                    </h2>
                    <!-- Ø³Ù‡Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£Ø³ÙÙ„ -->
                    <button id="scroll-to-bottom-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center gap-1 transition" title="Ø§Ù†Ø²Ù„ Ù„Ø¢Ø®Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ±">
                        <i data-lucide="arrow-down" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <button id="sales-quick-print-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠØ© (ØµÙˆØ±Ø©)">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                            <span>Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠØ©</span>
                        </button>
                        <button id="sales-bt-print-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù„ÙˆØªÙˆØ« (ØªØ¬Ø±ÙŠØ¨ÙŠØ©)">
                            <i data-lucide="bluetooth" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Ø¨Ù„ÙˆØªÙˆØ«</span>
                        </button>
                        <button id="sales-bt-test-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù„ÙˆØªÙˆØ« Ø¨Ø³ÙŠØ·">
                            <i data-lucide="zap" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Ø§Ø®ØªØ¨Ø§Ø±</span>
                        </button>
                        <button id="sales-html-print-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ø¯ÙŠØ©">
                            <i data-lucide="file" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ø¯ÙŠØ©</span>
                        </button>
                    </div>
                    <!-- FAB is used for adding sales now -->
                </div>
                <!-- Sales filters bar (restored) -->
                <div id="sales-filters-bar" class="flex flex-col sm:flex-row gap-2 mb-4" style="position:sticky; top:72px; z-index:20; background:#ffffff; padding:8px 0;">
                    <input id="search-sales-text" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ..." class="w-full p-2 border rounded-md">
                    <div class="flex items-center w-full sm:w-auto relative">
                        <input id="search-sales-date" type="date" class="w-full p-2 border border-gray-300 rounded-md appearance-none">
                        <button id="clear-sales-date-btn" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-600 hidden font-bold text-xl leading-none p-1">&times;</button>
                    </div>
                    <input type="month" id="sales-month-selector" class="w-full sm:w-auto p-2 border rounded-md">
                    <select id="tax-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">ÙÙ„ØªØ±Ø© Ø¨Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹</option>
                        <option value="filed">ØªÙ… Ø§Ù„Ø±ÙØ¹</option>
                        <option value="not-filed">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹</option>
                    </select>
                    <select id="review-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                        <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙ‚Ø·</option>
                        <option value="reviewed">Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙ‚Ø·</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div id="daily-total-container" class="bg-blue-100 border-r-4 border-blue-500 p-3 rounded-lg text-center hidden shadow-md">
                        <span class="font-semibold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯:</span>
                        <span id="daily-total-amount" class="font-bold text-blue-800">0 Ø¬.Ù…</span>
                    </div>
                    <!-- Right column: filtered total only (quick-search moved to side drawer) -->
                    <div style="display:flex;gap:12px;align-items:flex-start;">
                        <div id="filtered-total-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg text-center shadow-md" style="flex:1;">
                            <div>
                                <span class="font-semibold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©:</span>
                                <span id="filtered-total-amount" class="font-bold text-green-800">0 Ø¬.Ù…</span>
                            </div>
                            <div class="mt-1 text-sm text-green-900">
                                <span class="font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</span>
                                <span id="filtered-total-count" class="font-bold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Left slide-in drawer for Invoice Quick Search -->
                <div id="invoice-quick-search-wrap" class="fixed z-40 left-0" style="top:120px;width:220px;">
                    <div id="invoice-quick-search-content" class="relative transition-transform duration-200 ease-out">
                        <div id="invoice-quick-search-panel" class="bg-white p-2 rounded-r-lg shadow-lg border border-gray-200" style="width:220px;">
                            <div style="display:flex;flex-direction:column;gap:6px;align-items:stretch;">
                                <div style="background:#111027;color:#fff;padding:6px 8px;border-radius:4px;text-align:center;font-weight:700;">Number<br><div id="invoice-val-number" style="font-size:14px;margin-top:4px;">--</div></div>
                                <div style="background:#f6d8bf;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Total<br><div id="invoice-val-total" style="font-weight:700;">--</div></div>
                                <div style="background:#f4cfa9;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Return<br><div id="invoice-val-return">--</div></div>
                                <div style="background:#eee2d6;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Net amount<br><div id="invoice-val-net">--</div></div>
                                <div style="background:#e6f3e9;color:#0b6b2d;padding:6px 6px;border-radius:4px;text-align:center;">C - Name<br><div id="invoice-val-cname">--</div></div>
                                <div style="background:#2b2b2b;color:#fff;padding:6px 6px;border-radius:4px;text-align:center;">Date<br><div id="invoice-val-date" style="font-size:14px;margin-top:4px;" dir="ltr" lang="ar">--</div></div>
                                <div style="text-align:center;margin-top:6px;">
                                    <input id="invoice-search-input" type="text" inputmode="numeric" placeholder="Ø±Ù‚Ù…" class="w-full p-1 border rounded-md text-center text-sm" />
                                </div>
                                <div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">
                                    <button id="invoice-search-btn" class="bg-blue-600 text-white px-2 py-1 rounded-md text-sm">Ø¨Ø­Ø«</button>
                                    <button id="invoice-clear-btn" class="bg-gray-200 text-gray-700 px-2 py-1 rounded-md text-sm">Ù…Ø³Ø­</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Lens handle (outside the sliding content so it remains visible) -->
                    <button id="invoice-quick-search-toggle" class="fixed left-0 bg-white border border-gray-300 rounded-full w-9 h-9 shadow flex items-center justify-center z-50" style="top:220px" title="Ø¨Ø­Ø«">
                        <i data-lucide="search" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>

                <!-- Hidden thermal print root -->
                <div id="thermal-print-root" style="display:none"></div>
                <div id="sales-list" class="space-y-3"></div>
            </div>
            <!-- ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ -->

            <!-- Inquiry / Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (ÙØªØ±Ø© Ù…Ø­Ø¯Ø¯Ø© + Ø¹Ù…Ù„Ø§Ø¡ Ù…ØªØ¹Ø¯Ø¯ÙŠÙ†) -->
            <div id="page-inquiry" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="search" class="w-6 h-6 text-blue-600"></i>
                        <span>Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
                    </h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4 text-sm items-start">
                    <div>
                        <label class="block font-semibold mb-1">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input id="inq-date-from" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                        <input id="inq-date-to" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</label>
                        <input id="inq-customer-filter" type="text" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù…" class="w-full p-2 border rounded" />
                        <p class="text-[11px] text-gray-500 mt-1">Ø§Ø³ØªØ®Ø¯Ù… Ctrl Ø£Ùˆ Shift Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±ÙˆÙ†</label>
                        <select id="inq-customers" multiple size="8" class="w-full p-2 border rounded"></select>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button id="inq-generate-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2 text-sm"><i data-lucide="play"></i> ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</button>
                    <button id="inq-print-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 flex items-center gap-2 text-sm"><i data-lucide="printer"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button id="inq-image-btn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2 text-sm"><i data-lucide="image"></i> ØµÙˆØ±Ø©</button>
                </div>
                <div id="inq-summary" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 text-sm"></div>
                <div id="inq-report-wrapper" class="bg-white rounded-lg shadow p-3 overflow-auto">
                    <table id="inq-report-table" class="w-full text-xs border-collapse" style="direction:rtl;min-width:820px;">
                        <thead id="inq-report-head"></thead>
                        <tbody id="inq-report-body"></tbody>
                    </table>
                    <div class="mt-6" id="inq-customers-breakdown"></div>
                </div>
            </div>

            <!-- Price Lists / Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± -->
            <div id="page-price-lists" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="badge-dollar-sign" class="w-6 h-6 text-amber-600"></i>
                        <span>Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span>
                    </h2>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-3">
                    <div class="pl-controls grid grid-cols-1 md:grid-cols-7 gap-3 mb-4 text-sm items-end">
                        <div>
                            <label class="label block mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</label>
                            <select id="pl-filter-mode" class="w-full p-2 border rounded">
                                <option value="customer">Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                                <option value="priceList">Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="label block mb-1">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</label>
                            <select id="pl-selector" class="w-full p-2 border rounded"></select>
                        </div>
                        <div>
                            <label class="label block mb-1">Ø®ØµÙ… % Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</label>
                            <input id="pl-global-discount" type="number" min="0" max="100" step="0.01" value="0" class="w-full p-2 border rounded" />
                        </div>
                        <div class="flex items-end gap-2">
                            <button id="pl-print" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button id="pl-image" class="bg-indigo-600 text-white px-3 py-2 rounded text-sm">ØµÙˆØ±Ø©</button>
                        </div>
                    </div>

                    <div class="sheet-header">
                        <div class="sheet-meta">
                            <span id="pl-date"></span>
                        </div>
                        <div class="sheet-title">Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                        <div class="sheet-meta">
                            <span id="pl-customer-name"></span>
                        </div>
                    </div>

                    <div id="pl-sheet-container" class="overflow-auto"></div>

                    <!-- Ù‚Ø¯ÙŠÙ…Ø©: Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ù„Ù… ÙŠØ¹Ø¯ ÙŠØ³ØªØ®Ø¯Ù…ØŒ Ø£Ø¨Ù‚ÙŠØªÙ‡ Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©) -->
                    <div id="all-price-lists-container" class="grid md:grid-cols-2 gap-4" style="display:none"></div>
                </div>
            </div>

            

            <script>
                // ===== Thermal HTML Fallback Print =====
                (function(){
                    const CSS_ID = 'thermal-print-style';
                    function ensurePrintCss(){
                        if (document.getElementById(CSS_ID)) return;
                        const style = document.createElement('style');
                        style.id = CSS_ID;
                        style.textContent = `@media print {
  body * { visibility: hidden !important; }
  #thermal-print-root, #thermal-print-root * { visibility: visible !important; }
  #thermal-print-root { position: absolute; left:0; top:0; width:80mm; padding:4px 2px; font-family: 'Cairo', Arial, sans-serif; font-size:12px; line-height:1.25; direction:rtl; }
  #thermal-print-root .row { display:flex; justify-content:space-between; }
  #thermal-print-root .center { text-align:center; }
  #thermal-print-root hr { border:0; border-top:1px dashed #000; margin:4px 0; }
}
@page { margin:2mm; size:80mm auto; }`;
                        document.head.appendChild(style);
                    }
                    
                    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø§Ù„ØµÙŠÙ†ÙŠØ©
                    // Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø­Ø³Ù‘Ù†Ø© - Ø£Ø³Ø±Ø¹ ÙˆØ£Ø®Ù)
                    async function printAsImageForThermal(saleArg){                        try {
                            // Ø¥Ø°Ø§ ØªÙ… ØªÙ…Ø±ÙŠØ± saleØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯Ø« ÙØ§ØªÙˆØ±Ø©
                            let sale = saleArg;
                            if (!sale) {
                                sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                            }
                            if (!sale) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
                            
                            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª Ù„Ù„ÙØ§ØªÙˆØ±Ø© (ØªØµÙ…ÙŠÙ… Ù…Ø¨Ø³Ø· ÙˆØ£Ø³Ø±Ø¹)
                            const tempDiv = document.createElement('div');
                            tempDiv.style.cssText = 'position:fixed;left:-9999px;top:0;width:280px;background:white;padding:8px;font-family:Cairo,Arial;direction:rtl;';
                            
                            const customer = findCustomer(sale.customerId);
                            const dateStr = formatArabicDate(sale.date);
                            const custName = customer ? customer.name : 'Ø¹Ù…ÙŠÙ„';
                            
                            let itemsHtml = '';
                            (sale.items||[]).forEach(it => {
                                const p = findProduct(it.productId);
                                const name = (p ? p.name : (it.name || 'Ù…Ù†ØªØ¬')).substring(0, 20);
                                const qty = it.quantity || it.qty || 0;
                                const price = Number(it.price||0);
                                const total = qty * price * (1 - (it.discountPercent||0)/100);
                                itemsHtml += `<div style="display:flex;justify-content:space-between;padding:1px 0;font-size:10px;"><span style="flex:1;">${name}</span><span style="width:30px;text-align:center;">${qty}</span><span style="width:60px;text-align:left;">${formatCurrency(total)}</span></div>`;
                            });
                            
                            tempDiv.innerHTML = `<div style="text-align:center;border:2px solid #000;padding:6px;background:white;">
                                <div style="font-size:16px;font-weight:800;margin-bottom:2px;">Delente</div>
                                <div style="font-size:12px;font-weight:700;margin-bottom:6px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                                <div style="border-top:1px dashed #000;margin:4px 0;"></div>
                                <div style="font-size:10px;text-align:right;line-height:1.4;">
                                    <div style="display:flex;justify-content:space-between;"><span style="font-weight:600;">${sale.invoiceNumber || sale.id}</span><span>: Ø±Ù‚Ù…</span></div>
                                    <div style="display:flex;justify-content:space-between;"><span>${dateStr}</span><span>: Ø§Ù„ØªØ§Ø±ÙŠØ®</span></div>
                                    <div style="display:flex;justify-content:space-between;"><span>${custName.substring(0,20)}</span><span>: Ø§Ù„Ø¹Ù…ÙŠÙ„</span></div>
                                </div>
                                <div style="border-top:1px dashed #000;margin:4px 0;"></div>
                                ${itemsHtml}
                                <div style="border-top:2px solid #000;margin:6px 0;"></div>
                                <div style="font-size:13px;font-weight:800;display:flex;justify-content:space-between;">
                                    <span>${formatCurrency(sale.total||0)} Ø¬.Ù…</span><span>: Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                </div>
                                <div style="font-size:10px;display:flex;justify-content:space-between;margin:2px 0;">
                                    <span>${formatCurrency(sale.paidAmount||0)} Ø¬.Ù…</span><span>: Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span>
                                </div>
                                <div style="font-size:10px;display:flex;justify-content:space-between;">
                                    <span>${formatCurrency((sale.total||0)-(sale.paidAmount||0))} Ø¬.Ù…</span><span>: Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
                                </div>
                                <div style="border-top:1px dashed #000;margin:6px 0;"></div>
                                <div style="font-size:9px;text-align:center;">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</div>
                            </div>`;
                            
                            document.body.appendChild(tempDiv);
                            
                            // ØªØ­ÙˆÙŠÙ„ Ù„ØµÙˆØ±Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± html2canvas Ù„Ùˆ Ù…Ø´ Ù…ØªØ§Ø­)
                            if (typeof html2canvas === 'undefined') {
                                document.body.removeChild(tempDiv);
                                throw new Error('Ù…ÙƒØªØ¨Ø© html2canvas ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©');
                            }
                            
                            const canvas = await html2canvas(tempDiv, {
                                backgroundColor: '#ffffff',
                                scale: 2,
                                logging: false,
                                width: 280
                            });
                            
                            document.body.removeChild(tempDiv);
                            
                            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø©
                            const w = window.open('', '', 'width=300,height=500');
                            if (!w) throw new Error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©');
                            
                            w.document.open();
                            w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Ø·Ø¨Ø§Ø¹Ø©</title><style>@page{size:80mm auto;margin:0;}body{margin:0;padding:0;}img{width:100%;display:block;}</style></head><body><img src="${canvas.toDataURL('image/png')}"/></body></html>`);
                            w.document.close();
                            
                            setTimeout(() => { try{w.focus();w.print();}catch(_){} }, 300);
                            if('onafterprint' in w) w.onafterprint = () => { try{w.close();}catch(_){} };
                            
                        } catch(e) { 
                            console.error('Print failed:', e);
                            alert('ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: '+ (e.message || e)); 
                        }
                    }
                    
                    async function printHtmlReceiptLatest(){
                        try {
                            const sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                            if (!sale) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
                            const html = (typeof buildReceiptHtml58mm === 'function') ? buildReceiptHtml58mm(sale) : '';
                            const w = window.open('', '', 'width=500,height=700');
                            if (!w) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
                            w.document.open();
                            w.document.write(html);
                            w.document.close();
                            const doPrint = ()=>{ try{ w.focus(); }catch(_){} try{ w.print(); }catch(_){} };
                            if ('onload' in w) { w.onload = ()=> setTimeout(doPrint, 100); } else { setTimeout(doPrint, 300); }
                            if ('onafterprint' in w) { w.onafterprint = ()=>{ try{ w.close(); }catch(_){} }; }
                        } catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: '+ e.message); }
                    }
                    
                    window.printAsImageForThermal = printAsImageForThermal;
                    window.printHtmlReceiptLatest = printHtmlReceiptLatest;
                })();

                // ===== Thermal Receipt Builder (simplified ESC/POS) =====
                // NOTE: This encodes a very basic Arabic receipt; adjust per printer specs.
                function buildEscPosReceipt(sale){
                    const enc = new TextEncoder();
                    const lines = [];
                    const center = (t)=>"\x1B\x61\x01"+t+"\n"; // ESC a 1 (center)
                    const left = (t)=>"\x1B\x61\x00"+t+"\n";  // ESC a 0 (left)
                    lines.push(center("*** ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ ***"));
                    if (sale && sale.invoiceNumber) lines.push(center("Ø±Ù‚Ù…: "+sale.invoiceNumber));
                    if (sale && sale.date) lines.push(left("Ø§Ù„ØªØ§Ø±ÙŠØ®: "+(sale.date.split('T')[0])));
                    if (sale && sale.customerName) lines.push(left("Ø§Ù„Ø¹Ù…ÙŠÙ„: "+sale.customerName));
                    lines.push(left("------------------------------"));
                    if (sale && Array.isArray(sale.items)){
                        sale.items.forEach(it=>{
                            const name = (it.name||it.productName||it.productId||"ØµÙ†Ù").slice(0,12);
                            const qty = it.qty || it.quantity || 0;
                            const price = it.price || it.unitPrice || 0;
                            const total = (qty*price).toFixed(2);
                            lines.push(left(name+" "+qty+"x"+price+"="+total));
                        });
                    }
                    lines.push(left("------------------------------"));
                    const totalAmt = sale ? (sale.total || sale.net || sale.amount || 0) : 0;
                    lines.push(center("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+Number(totalAmt).toFixed(2)+" Ø¬.Ù…"));
                    lines.push(center("Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ…"));
                    // Feed & cut (if supported) \x1D V 0
                    lines.push("\n\n\x1D\x56\x00");
                    const all = lines.join("");
                    return enc.encode(all);
                }

                async function bluetoothPrintLatest(){
                    if (!('bluetooth' in navigator)){
                        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Bluetooth (Ø¬Ø±Ø¨ Chrome Ø£Ùˆ Edge Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯).');
                        return;
                    }
                    // Ø£Ø­Ø¯Ø« ÙØ§ØªÙˆØ±Ø©
                    const sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                    const payload = buildEscPosReceipt(sale);
                    // UUIDs Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø·Ø§Ø¨Ø¹Ø§Øª Ø­Ø±Ø§Ø±ÙŠØ© BLE Ø´Ø§Ø¦Ø¹Ø© (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„)
                    const SERVICE_UUIDS = [0xFFE0,'0000ffe0-0000-1000-8000-00805f9b34fb','0000ff00-0000-1000-8000-00805f9b34fb'];
                    const CHAR_UUIDS = ['ffe1','0000ffe1-0000-1000-8000-00805f9b34fb','0000ff01-0000-1000-8000-00805f9b34fb'];
                    let device;
                    try {
                        // Ù†Ø³ØªØ®Ø¯Ù… acceptAllDevices Ù„ØªÙØ§Ø¯ÙŠ Ø®Ø·Ø£ Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© Ø«Ù… Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
                        device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices: SERVICE_UUIDS });
                    } catch(e){
                        alert('ØªØ¹Ø°Ø± Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Ø² Ø¨Ù„ÙˆØªÙˆØ«: '+ e.message);
                        return;
                    }
                    let gatt;
                    try { gatt = await device.gatt.connect(); } catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©: '+e.message); return; }
                    let characteristic = null;
                    for (const su of SERVICE_UUIDS){
                        try {
                            const service = await gatt.getPrimaryService(su);
                            for (const cu of CHAR_UUIDS){
                                try {
                                    characteristic = await service.getCharacteristic(cu);
                                    if (characteristic) break;
                                } catch(_){ }
                            }
                            if (characteristic) break;
                        } catch(_){ }
                    }
                    if (!characteristic){
                        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®Ø§ØµÙŠØ© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© (Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© UUID Ø£Ùˆ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© BLE).');
                        try { gatt.disconnect(); } catch(_){ }
                        return;
                    }
                    try {
                        const CHUNK = 20;
                        for (let i=0;i<payload.length;i+=CHUNK){
                            const slice = payload.slice(i,i+CHUNK);
                            await characteristic.writeValue(slice);
                            await new Promise(r=>setTimeout(r,12));
                        }
                        alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© (Ø¨Ù„ÙˆØªÙˆØ«).');
                    } catch(e){
                        console.error('Bluetooth write failed', e);
                        alert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø§Ø¨Ø¹Ø©: '+ e.message);
                    } finally {
                        try { gatt.disconnect(); } catch(_){ }
                    }
                }

                document.addEventListener('DOMContentLoaded', ()=>{
                    const btBtn = document.getElementById('sales-bt-print-btn');
                    if (btBtn) btBtn.addEventListener('click', bluetoothPrintLatest);
                    
                    // Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)
                    const quickPrintBtn = document.getElementById('sales-quick-print-btn');
                    if (quickPrintBtn) quickPrintBtn.addEventListener('click', async () => {
                        const latestSale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                        if (!latestSale) {
                            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
                            return;
                        }
                        if (typeof printInvoiceViaBluetooth === 'function') {
                            await printInvoiceViaBluetooth(latestSale);
                        } else {
                            alert('Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                        }
                    });
                    
                    const htmlBtn = document.getElementById('sales-html-print-btn');
                    if (htmlBtn) htmlBtn.addEventListener('click', window.printHtmlReceiptLatest);
                    
                    // Ø²Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£Ø³ÙÙ„
                    const scrollBtn = document.getElementById('scroll-to-bottom-btn');
                    if (scrollBtn) {
                        scrollBtn.addEventListener('click', () => {
                            const salesList = document.getElementById('sales-list');
                            if (salesList) {
                                // ØªÙ…Ø±ÙŠØ± Ø³Ù„Ø³ Ù„Ù„Ø£Ø³ÙÙ„
                                window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
                            }
                        });
                    }
                });

                // ===== END Bluetooth Print Section =====

                // Invoice quick-search: slide-in/out from left wall with lens handle
                document.addEventListener('DOMContentLoaded', function(){
                    const wrap = document.getElementById('invoice-quick-search-wrap');
                    const content = document.getElementById('invoice-quick-search-content');
                    const toggle = document.getElementById('invoice-quick-search-toggle');
                    if (!wrap || !content || !toggle) return;
                    let open = false; // start hidden in the wall
                    function apply(){
                        // Hide completely: translate by full width
                        content.style.transform = open ? 'translateX(0%)' : 'translateX(-100%)';
                    }
                    toggle.addEventListener('click', function(){ open = !open; apply(); try { updateIcons(); } catch(_){} });
                    apply();
                    // Keep the handle visible above content
                    try { wrap.style.zIndex = '50'; } catch(_){}
                });

                // Invoice quick-search wiring (searches `state.sales` for invoice number)
                document.addEventListener('DOMContentLoaded', function(){
                    const input = document.getElementById('invoice-search-input');
                    const btn = document.getElementById('invoice-search-btn');
                    const clearBtn = document.getElementById('invoice-clear-btn');

                    function formatMoney(n){
                        try{ if (typeof formatCurrency === 'function') return formatCurrency(n); }catch(e){}
                        if (n == null) return '0';
                        return (Number(n) || 0).toLocaleString();
                    }

                    // Return a short date string (YYYY-MM-DD) for a variety of input shapes
                    function formatShortDate(val){
                        if (!val && val !== 0) return '';
                        try {
                            // If already an ISO-like string with time, take the date portion
                            if (typeof val === 'string'){
                                if (val.indexOf('T') !== -1) return val.split('T')[0];
                                if (/^\d{4}-\d{2}-\d{2}/.test(val)) return val.slice(0,10);
                                // common DD/MM/YYYY or D/M/YYYY -> parse accordingly
                                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
                                    const parts = val.split('/').map(p=>Number(p));
                                    // assume DD/MM/YYYY
                                    const d = new Date(parts[2], parts[1]-1, parts[0]);
                                    if (!isNaN(d)) return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                                }
                            }
                            // If already a Date
                            if (val instanceof Date) {
                                const d = val;
                                return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                            }
                            // Try constructing Date from value
                            const dd = new Date(val);
                            if (!isNaN(dd) && dd.getFullYear() > 1900) return dd.getFullYear() + '-' + String(dd.getMonth()+1).padStart(2,'0') + '-' + String(dd.getDate()).padStart(2,'0');
                        } catch(e) {}
                        // fallback to original string representation
                        return String(val);
                    }

                    function findInvoice(num){
                        if (!num) return null;
                        if (!window.state || !Array.isArray(state.sales)) return null;
                        // match invoiceNumber, nested invoice.number, id, number, ref, etc.
                        const s = state.sales.find(item => {
                            const candidates = [
                                item.invoiceNumber,
                                (item.invoice && item.invoice.number),
                                (item.invoice && item.invoice.id),
                                item.invoice,
                                item.id,
                                item.number,
                                item.ref,
                                item.invoice_no,
                                item.invoiceNumberString
                            ];
                            return candidates.some(c => c != null && String(c) === String(num));
                        });
                        return s || null;
                    }

                    function renderResult(sale){
                        const dateEl = document.getElementById('invoice-result-date');
                        const custEl = document.getElementById('invoice-result-customer');
                        const totalEl = document.getElementById('invoice-result-total');
                        const typeEl = document.getElementById('invoice-result-type');
                        const noData = document.getElementById('invoice-no-data');
                        // New compact panel fields
                        const vNumber = document.getElementById('invoice-val-number');
                        const vTotal = document.getElementById('invoice-val-total');
                        const vReturn = document.getElementById('invoice-val-return');
                        const vNet = document.getElementById('invoice-val-net');
                        const vCname = document.getElementById('invoice-val-cname');
                        const vDate = document.getElementById('invoice-val-date');

                        if(!sale){
                            if (dateEl) dateEl.textContent = '--';
                            if (custEl) custEl.textContent = '--';
                            if (totalEl) totalEl.textContent = '--';
                            if (typeEl) typeEl.textContent = '--';
                            if (vNumber) vNumber.textContent = '--';
                            if (vTotal) vTotal.textContent = '--';
                            if (vReturn) vReturn.textContent = '--';
                            if (vNet) vNet.textContent = '--';
                            if (vCname) vCname.textContent = '--';
                            if (vDate) vDate.textContent = '--';
                            return;
                        }
                            var cname = '--';
                            try {
                                // Direct string-ish fields (many possible names)
                                cname = sale.customerName || sale.clientName || sale.cname || sale.customer_name || sale.customer_fullname || sale.customerNameAr || sale.customer_name_ar || sale.partyName || sale.contactName || sale.contact_name || sale.buyerName || sale.customerDisplay || sale.customer || sale.client || sale.client_name || sale.clientName || cname;

                                // If sale.customer is an object, extract its name-like fields
                                if (cname && typeof cname === 'object') {
                                    var co = cname;
                                    cname = co.name || co.fullName || co.displayName || co.title || (co.company && co.company.name) || co.customerName || co.customer_name || co.label || co.customerDisplay || '--';
                                }

                                // Check nested well-known objects
                                if ((cname === '--' || cname == null || typeof cname === 'number')) {
                                    if (sale.customerObj && typeof sale.customerObj === 'object') cname = sale.customerObj.name || sale.customerObj.fullName || sale.customerObj.displayName || cname;
                                    if ((cname === '--' || cname == null || typeof cname === 'number') && sale.client && typeof sale.client === 'object') cname = sale.client.name || sale.client.displayName || cname;
                                    if ((cname === '--' || cname == null || typeof cname === 'number') && sale.account && typeof sale.account === 'object') cname = sale.account.name || sale.account.title || cname;
                                }

                                // If sale contains phone/tax fields, try to find matching customer by those
                                if ((cname === '--' || cname == null || typeof cname === 'number') && window.state && Array.isArray(window.state.customers)) {
                                    var possibleIds = [sale.customerId, sale.customer_id, sale.clientId, sale.client_id, sale.customer_ref, sale.customerRef, sale.accountId, sale.account_id, sale.partyId, sale.party_id, sale.customerCode, sale.clientCode, sale.ref, sale.customerMobile, sale.customerPhone, sale.mobile, sale.phone, sale.taxNumber, sale.tax_number];
                                    // flatten and remove nulls
                                    possibleIds = possibleIds.filter(x=> x != null && x !== '');
                                    var found = null;
                                    if (possibleIds.length > 0) {
                                        found = window.state.customers.find(function(c){
                                            var keys = [c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode, c.mobile, c.phone, c.taxNumber, c.tax_number, c.phoneNumber, c.msisdn];
                                            return possibleIds.some(function(pid){
                                                return keys.some(function(k){ return k != null && String(k) === String(pid); });
                                            });
                                        });
                                    }
                                    // If none by ids, try fuzzy match by mobile/tax if sale has those
                                    if (!found && sale.customerPhone) {
                                        found = window.state.customers.find(function(c){ return String(c.mobile) === String(sale.customerPhone) || String(c.phone) === String(sale.customerPhone); });
                                    }
                                    if (!found && sale.customerMobile) {
                                        found = window.state.customers.find(function(c){ return String(c.mobile) === String(sale.customerMobile) || String(c.phone) === String(sale.customerMobile); });
                                    }
                                    if (!found && sale.taxNumber) {
                                        found = window.state.customers.find(function(c){ return String(c.taxNumber) === String(sale.taxNumber) || String(c.tax_number) === String(sale.taxNumber); });
                                    }
                                    if (found) {
                                        cname = found.name || found.customerName || found.fullName || found.displayName || found.title || (found.company && found.company.name) || found.customer_name || cname;
                                    }
                                }

                                // If sale.customerId is present, attempt a direct lookup using helper or by id
                                try {
                                    if ((cname === '--' || cname == null || typeof cname === 'number' || cname === 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') && sale && (sale.customerId || sale.customer_id)) {
                                        var cidVal = sale.customerId || sale.customer_id;
                                        // try central helper first
                                        try {
                                            if (typeof findCustomer === 'function') {
                                                var f = findCustomer(cidVal);
                                                if (f && (f.name || f.customerName || f.displayName)) {
                                                    cname = f.name || f.customerName || f.fullName || f.displayName || cname;
                                                }
                                            }
                                        } catch(e) { /* ignore */ }
                                        // fallback: lookup in state.customers by id-like fields
                                        if ((cname === '--' || cname == null || cname === 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' || typeof cname === 'number') && window.state && Array.isArray(window.state.customers)) {
                                            var found2 = window.state.customers.find(function(c){
                                                return [c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode].some(function(k){ return k != null && String(k) === String(cidVal); });
                                            });
                                            if (found2) cname = found2.name || found2.customerName || found2.displayName || found2.fullName || cname;
                                        }
                                    }
                                } catch (e) { /* ignore */ }

                                // final fallback: if cname is still an object or null, stringify a safe field or use 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                                if (cname && typeof cname === 'object') {
                                    cname = cname.name || cname.displayName || JSON.stringify(cname).slice(0,60) || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                }
                                if (!cname || cname === '--') cname = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            } catch (e) { cname = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'; }
                            vCname.textContent = (cname == null ? 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' : cname);
                        if (vDate) {
                            var rawDate = sale.date || sale.createdAt || sale.timestamp || '';
                            vDate.textContent = rawDate ? formatShortDate(rawDate) : '--';
                        }
                    }

                    if (btn) btn.addEventListener('click', function(){
                        const v = input ? input.value.trim() : '';
                        if (!v) { renderResult(null); return; }
                        const res = findInvoice(v);
                        renderResult(res);
                    });

                    if (input) input.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); btn && btn.click(); } });

                    if (clearBtn) clearBtn.addEventListener('click', function(){ if (input) input.value = ''; renderResult(null); });

                    // initialize with empty view
                    renderResult(null);

                    // Ensure there is at least one sample sale so the quick-search can be tested
                    try {
                        if (!window.state) window.state = {};
                        if (!Array.isArray(window.state.sales)) window.state.sales = [];
                        if (window.state.sales.length === 0) {
                            window.state.sales.push({
                                id: '148556',
                                invoiceNumber: '148556',
                                customerName: 'Ù…Ø§Ø±ÙƒØª Ø³ÙÙŠØ±',
                                total: 21252,
                                net: 21252,
                                isReturn: false,
                                date: '12/11/2025'
                            });
                        }
                    } catch (e) { console.warn('sample sale init failed', e); }
                    
                    // Wire the export button to show the sale object in a textarea for easy copy
                    try {
                        const exportBtn = document.getElementById('invoice-export-btn');
                        const exportModal = document.getElementById('invoice-export-modal');
                        const exportTextarea = document.getElementById('invoice-export-textarea');
                        const exportClose = document.getElementById('invoice-export-close-btn');
                        const exportCopy = document.getElementById('invoice-export-copy-btn');

                        function showSaleObjectForCurrentInput(){
                            try{
                                const user = AuthSystem.getCurrentUser(); if (!user) return 'guest';
                                if (!num) {
                                    exportTextarea.value = 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©.';
                                } else {
                        // ===== Cost Lists: Force Cloud Sync on Edit (Raw & Packaging) =====
                        (function(){
                            // Helper to bump timestamp and trigger cloud save
                            function bumpAndSave(){
                                try {
                                    if (window.isUpdatingFromCloud) return; // avoid echoing cloud updates
                                } catch(_){}
                                try {
                                    if (!window.costLists) window.costLists = {};
                                    window.costLists.timestamp = new Date().toISOString();
                                } catch(_){ }
                                try {
                                    if (typeof window.saveCostListsToFirebase === 'function') {
                                        // Prefer immediate save to avoid logout loss
                                        window.saveCostListsToFirebase(window.costLists);
                                    } else if (typeof window.saveCostListsDebounced === 'function') {
                                        window.saveCostListsDebounced();
                                    }
                                } catch(e){ console.warn('bumpAndSave failed', e); }
                            }

                            // Monkey-patch updateRawGridState to enforce cloud sync
                            try {
                                if (typeof window.updateRawGridState === 'function' && !window.__patched_updateRawGridState){
                                    const __orig = window.updateRawGridState;
                                    window.updateRawGridState = function(){
                                        try { __orig.apply(this, arguments); } catch(e){ console.warn('updateRawGridState orig failed', e); }
                                        // After local updates, force timestamp and cloud save
                                        bumpAndSave();
                                    };
                                    window.__patched_updateRawGridState = true;
                                }
                            } catch(e){ /* ignore */ }

                            // Monkey-patch updatePackagingGridState to enforce cloud sync
                            try {
                                if (typeof window.updatePackagingGridState === 'function' && !window.__patched_updatePackagingGridState){
                                    const __orig = window.updatePackagingGridState;
                                    window.updatePackagingGridState = function(){
                                        try { __orig.apply(this, arguments); } catch(e){ console.warn('updatePackagingGridState orig failed', e); }
                                        bumpAndSave();
                                    };
                                    window.__patched_updatePackagingGridState = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();

                        // ===== Cost Lists: Prefer Cloud on Fresh Sessions =====
                        (function(){
                            try {
                                if (typeof window.tryLoadCostListsFromCloud === 'function' && !window.__patched_tryLoadCostListsFromCloud){
                                    const __origLoadCloud = window.tryLoadCostListsFromCloud;
                                    window.tryLoadCostListsFromCloud = async function(){
                                        // Always attempt cloud fetch; if local missing or older, overlay cloud
                                        const localTs = (window.costLists && window.costLists.timestamp) || null;
                                        try {
                                            const res = await __origLoadCloud.apply(this, arguments);
                                            // If original loader refuses due to timestamp, enforce preference for cloud when session looks fresh
                                            const justLoggedIn = !!(window.auth && auth.currentUser); // heuristic: logged-in state
                                            const localEmpty = !window.costLists || (!Array.isArray(window.costLists.raw) && !Array.isArray(window.costLists.pack));
                                            if (localEmpty || !localTs || justLoggedIn) {
                                                // Trigger another save to align local with cloud timestamp
                                                try {
                                                    if (typeof window.ensureRawAndPackFromState === 'function') window.ensureRawAndPackFromState();
                                                } catch(_){}
                                            }
                                            return res;
                                        } catch(e){
                                            console.warn('tryLoadCostListsFromCloud patched load failed; falling back to original behavior', e);
                                            return __origLoadCloud.apply(this, arguments);
                                        }
                                    };
                                    window.__patched_tryLoadCostListsFromCloud = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();

                        // ===== Finished Products: Enforce Local Persistence in renderFinishedProducts =====
                        (function(){
                            try {
                                if (typeof window.renderFinishedProducts === 'function' && !window.__patched_renderFinishedProducts){
                                    const __origRenderFinished = window.renderFinishedProducts;
                                    window.renderFinishedProducts = function(){
                                        // Always load latest local state at start
                                        try { window._finishedGridState = JSON.parse(localStorage.getItem('finished_products_grid')||'{}') || {}; } catch(e){ if (!window._finishedGridState) window._finishedGridState = {}; }
                                        const result = __origRenderFinished.apply(this, arguments);
                                        // Attach input handler for finished grid cells
                                        try {
                                            const container = document.getElementById('finished-products-grid') || document;
                                            container.removeEventListener && container.removeEventListener('__fp_input_dummy', function(){});
                                            container.addEventListener('input', function(e){
                                                const el = e.target;
                                                if (!el || !el.dataset) return;
                                                if (el.dataset.grid === 'finished' && el.dataset.id && el.dataset.field){
                                                    const productId = el.dataset.id;
                                                    const field = el.dataset.field;
                                                    const value = parseFloat(el.value) || 0;
                                                    if (!window._finishedGridState[productId]) window._finishedGridState[productId] = {};
                                                    window._finishedGridState[productId][field] = value;
                                                    try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){ }
                                                    try { if (typeof window.saveFinishedProductsDebounced === 'function') window.saveFinishedProductsDebounced(); } catch(_){ }
                                                }
                                            });
                                        } catch(e){ /* ignore wiring errors */ }
                                        return result;
                                    };
                                    window.__patched_renderFinishedProducts = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();

                        // ===== Price Sync: Force Immediate Cloud Save on unitPrice changes =====
                        (function(){
                            function forcePriceSave(itemName, value, listKey){
                                try {
                                    if (!window.costLists) window.costLists = {};
                                    const arr = (listKey === 'pack') ? (window.costLists.costPack || []) : (window.costLists.costRaw || []);
                                    const costItem = Array.isArray(arr) ? arr.find(i => i && i.name === itemName) : null;
                                    if (costItem){
                                        costItem.price = parseFloat(value) || 0;
                                        costItem.lastPriceDate = new Date().toISOString();
                                        window.costLists.timestamp = costItem.lastPriceDate;
                                        try {
                                            if (typeof window.forceFullCloudSync === 'function') window.forceFullCloudSync();
                                            else if (typeof window.saveCostListsToFirebase === 'function') window.saveCostListsToFirebase(window.costLists);
                                        } catch(_){ }
                                        try { console.log('ğŸ’° Forced Price Save for:', itemName); } catch(_){ }
                                    }
                                } catch(e){ console.warn('forcePriceSave failed', e); }
                            }

                            // Patch renderRawMaterials to hook unitPrice changes
                            try {
                                if (typeof window.renderRawMaterials === 'function' && !window.__patched_renderRawMaterials){
                                    const __origRenderRaw = window.renderRawMaterials;
                                    window.renderRawMaterials = function(){
                                        const res = __origRenderRaw.apply(this, arguments);
                                        try {
                                            const container = document.getElementById('raw-materials-grid') || document;
                                            container.addEventListener('input', function(e){
                                                const el = e.target;
                                                if (!el || !el.dataset) return;
                                                if (el.dataset.grid === 'raw' && el.dataset.field === 'unitPrice' && el.dataset.name){
                                                    forcePriceSave(el.dataset.name, el.value, 'raw');
                                                }
                                            });
                                        } catch(_){}
                                        return res;
                                    };
                                    window.__patched_renderRawMaterials = true;
                                }
                            } catch(e){ /* ignore */ }

                            // Patch renderPackaging similarly
                            try {
                                if (typeof window.renderPackaging === 'function' && !window.__patched_renderPackaging){
                                    const __origRenderPack = window.renderPackaging;
                                    window.renderPackaging = function(){
                                        const res = __origRenderPack.apply(this, arguments);
                                        try {
                                            const container = document.getElementById('packaging-grid') || document;
                                            container.addEventListener('input', function(e){
                                                const el = e.target;
                                                if (!el || !el.dataset) return;
                                                if (el.dataset.grid === 'pack' && el.dataset.field === 'unitPrice' && el.dataset.name){
                                                    forcePriceSave(el.dataset.name, el.value, 'pack');
                                                }
                                            });
                                        } catch(_){}
                                        return res;
                                    };
                                    window.__patched_renderPackaging = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();
                        // ===== Finished Products: Force Local Save + Debounced Cloud Sync =====
                        (function(){
                            try {
                                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¯Ø§Ù„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø¤Ø¬Ù„Ø© Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                                if (typeof window.saveFinishedProductsDebounced !== 'function'){
                                    let __fpTimer = null; const DEBOUNCE_MS = 800;
                                    window.saveFinishedProductsDebounced = function(){
                                        try { if (__fpTimer) clearTimeout(__fpTimer); } catch(_){ }
                                        __fpTimer = setTimeout(async function(){
                                            try {
                                                if (window.db && typeof window.syncFinishedProductsToCloud === 'function') {
                                                    await window.syncFinishedProductsToCloud(window._finishedGridState || {});
                                                }
                                            } catch(e){ console.warn('saveFinishedProductsDebounced sync failed', e); }
                                        }, DEBOUNCE_MS);
                                    };
                                }

                                // Ù…Ø³ØªÙ…Ø¹ Ø¹Ø§Ù… Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù…Ø©
                                document.addEventListener('input', function(e){
                                    try {
                                        const el = e.target;
                                        if (!el || !el.dataset) return;
                                        // Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ data-grid="finished" Ùˆ data-id Ùˆ data-field ÙÙŠ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø¨ÙƒØ©
                                        if (el.dataset.grid === 'finished' && el.dataset.id && el.dataset.field){
                                            const productId = el.dataset.id;
                                            const field = el.dataset.field;
                                            const val = parseFloat(el.value) || 0;

                                            if (!window._finishedGridState) window._finishedGridState = {};
                                            if (!window._finishedGridState[productId]) window._finishedGridState[productId] = {};
                                            window._finishedGridState[productId][field] = val;

                                            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ù‚Ø³Ø±ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ CLOUD_ONLY Ù…ÙØ¹Ù„Ø©
                                            try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){ }

                                            // Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø¤Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                                            try { if (typeof window.saveFinishedProductsDebounced === 'function') window.saveFinishedProductsDebounced(); } catch(_){ }
                                        }
                                    } catch(err){ /* ignore */ }
                                });
                            } catch(e){ /* ignore top-level */ }
                        })();
                                    const sale = findInvoice(num) || null;
                                    exportTextarea.value = sale ? JSON.stringify(sale, null, 2) : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ø±Ù‚Ù…: ' + num;
                                }
                                exportModal.style.display = 'block';
                                exportTextarea.select();
                            }catch(e){ exportTextarea.value = 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ§Ø¦Ù†:\n'+String(e); exportModal.style.display='block'; }
                        }

                        if (exportBtn) exportBtn.addEventListener('click', function(){ showSaleObjectForCurrentInput(); });
                        if (exportClose) exportClose.addEventListener('click', function(){ exportModal.style.display = 'none'; });
                        if (exportCopy) exportCopy.addEventListener('click', function(){ try{ exportTextarea.select(); document.execCommand('copy'); exportCopy.textContent = 'ØªÙ… Ø§Ù„Ù†Ø³Ø®'; setTimeout(()=> exportCopy.textContent = 'Ù†Ø³Ø®', 1200); }catch(e){ alert('Ù†Ø³Ø® Ù„Ù… ÙŠÙ†Ø¬Ø­ØŒ Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹.'); } });
                    } catch (e) { console.warn('invoice export wiring failed', e); }
                });
            </script>
            <script>
                // Anchor the invoice quick-search panel as a fixed element next to the totals card
                (function(){
                    // Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ø£Ø³ÙÙ„ Ù‚Ù„ÙŠÙ„Ù‹Ø§
                    if (typeof window.INVOICE_PANEL_OFFSET_TOP === 'undefined') {
                        window.INVOICE_PANEL_OFFSET_TOP = 48; // Ø¨ÙƒØ³Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø®ÙØ¶ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
                    }
                        function positionInvoicePanel(){
                            try{
                            // Resolve DOM nodes locally to avoid referencing undefined globals
                            const totalEl = document.getElementById('invoice-result-total');
                            const panel = document.getElementById('invoice-quick-search-panel') || document.getElementById('invoice-quick-search-global') || document.getElementById('invoice-quick-search-wrap');
                            // Safety: if required elements are missing, bail out to avoid ReferenceError
                            if (!totalEl || !panel) return;

                            // Try to get bounding rect if available
                            let rect = null;
                            try { rect = totalEl.getBoundingClientRect(); } catch(e){ rect = null; }

                            // set fixed positioning
                            panel.style.position = 'fixed';
                            panel.style.zIndex = '2147483646';
                            panel.style.maxHeight = 'calc(100vh - 120px)';

                            // vertical: try to sit under the header (if present) or align with totals card
                            try {
                                var headerEl = document.querySelector('header');
                                var headerBottom = headerEl ? headerEl.getBoundingClientRect().bottom : 56;
                                var topFromTotals = rect ? rect.top : (headerBottom + 8);
                                var topVal = Math.max((headerBottom + 8), topFromTotals + 0) + (window.INVOICE_PANEL_OFFSET_TOP||0);
                                panel.style.top = (Math.round(topVal) || 64) + 'px';
                            } catch(e) { panel.style.top = '64px'; }

                            // horizontal: keep panel at a fixed left offset to avoid covering invoice rows
                            try {
                                panel.style.left = '12px';
                                panel.style.right = 'auto';
                            } catch(e) {
                                try { panel.style.left = '12px'; } catch(_){}
                            }
                        }catch(e){ console.warn('positionInvoicePanel failed', e); }
                    }
                    window.addEventListener('load', function(){ setTimeout(positionInvoicePanel, 50); });
                    window.addEventListener('resize', function(){ setTimeout(positionInvoicePanel, 60); });
                    // keep panel fixed; still recalc occasionally when scrolling
                    window.addEventListener('scroll', function(){ setTimeout(positionInvoicePanel, 120); });
                    // expose helper
                    window.positionInvoicePanel = positionInvoicePanel;
                })();
            </script>
            
            <div id="page-dispatch" class="page">
                <!-- Local tabs inside dispatch page -->
                <div class="mb-4 flex gap-2 no-print" style="display:flex;gap:8px;margin-bottom:16px;">
                    <button id="dispatch-notes-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#3b82f6;color:white;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</button>
                    <button id="receipt-local-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#d1d5db;color:#374151;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                </div>

                <!-- Tab content: Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª -->
                <div id="dispatch-notes-tab-content" class="dispatch-local-tab-content" style="display:block;">
                <div id="new-dispatch-note-section" class="bg-gray-100 p-4 rounded-lg border mb-6">
                    <h3 class="text-lg font-bold mb-3">Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="new-dispatch-note-number" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù† (ÙŠØ¯ÙˆÙŠ)</label>
                            <input type="number" id="new-dispatch-note-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="new-dispatch-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
                            <select id="new-dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="new-dispatch-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø°Ù†</label>
                            <input type="date" id="new-dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>

                    <div class="overflow-x-auto bg-white rounded-lg shadow mt-4 border">
                        <table id="new-dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø³ØªÙ„Ù… (ÙƒÙ…ÙŠØ©)</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø±ØªØ¬Ø¹ Ø³Ù„ÙŠÙ…</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø±ØªØ¬Ø¹ ØªØ§Ù„Ù</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø¬Ø§Ù†ÙŠ</th>
                                    <th class="px-2 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="new-dispatch-items-container" class="divide-y divide-gray-200">
                                <!-- New item rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                         <button type="button" id="add-new-dispatch-item-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
                        </button>
                        <button type="button" id="save-new-dispatch-note-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <hr class="my-6 border-t-2 border-dashed">

                <!-- Existing Dispatch Notes List -->
                <h3 class="text-lg font-bold mb-3">Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
                <div id="dispatch-notes-list" class="space-y-4"></div>
                <!-- Ù…Ù„Ø®Øµ Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ø¹Ø±Ø¶ ÙÙ‚Ø·) -->
                <div id="rep-dispatch-summary" class="hidden mt-8 bg-white border rounded-lg p-4">
                    <h4 class="font-bold mb-3 flex items-center gap-2 text-indigo-700"><i data-lucide="clipboard-list" class="w-5 h-5"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
                    <div id="rep-dispatch-summary-content" class="text-sm"></div>
                </div>
                </div> <!-- end dispatch-notes-tab-content -->

                <!-- Tab content: ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„ -->
                <div id="receipt-local-tab-content" class="dispatch-local-tab-content" style="display:none;">
                    <h2 class="text-xl font-bold mb-4">ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Left: Receipt List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-4 rounded shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                                        <input type="date" id="receipt-from-date-local" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                                        <input type="date" id="receipt-to-date-local" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2"></label>
                                        <button id="receipt-filter-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto bg-white rounded-lg shadow">
                                    <table class="w-full border-collapse border border-gray-300">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="border p-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                <th class="border p-2 text-right">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                <th class="border p-2 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                                <th class="border p-2 text-right">Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                                                <th class="border p-2 text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                <th class="border p-2 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receipt-table-body-local" class="text-sm"></tbody>
                                    </table>
                                </div>
                                <div class="mt-4 p-4 bg-gray-50 rounded border">
                                    <div class="grid grid-cols-3 gap-4 text-lg font-bold">
                                        <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="receipt-total-local" class="text-green-600">0</span></div>
                                        <div>Ø§Ù„Ø¹Ø¯Ø¯: <span id="receipt-count-local" class="text-blue-600">0</span></div>
                                        <div>Ø§Ù„Ù…ØªÙˆØ³Ø·: <span id="receipt-avg-local" class="text-purple-600">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Rep Receipt Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-4 rounded shadow-md sticky top-20">
                                <h3 class="text-lg font-bold mb-4 text-right">Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                                    <select id="receipt-rep-dropdown-local" class="w-full p-2 border rounded text-right">
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ --</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª:</label>
                                    <input type="number" id="rep-credit-transactions-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</label>
                                    <input type="number" id="rep-expenses-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                                    <textarea id="rep-notes-local" class="w-full p-2 border rounded text-right" rows="4" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button id="receipt-print-btn-local" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold">Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                                    <button id="receipt-save-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- end receipt-local-tab-content -->
            </div>
            
            <!-- RE-ACTIVATED REPORTS PAGE -->
            <div id="page-reports" class="page" style="padding-bottom: 50px;">
                <h2 class="text-xl font-bold mb-4 no-print">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h2>
                
                <div id="report-filter-container" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                    <!-- Daily Report Content -->
                    <div data-report-content="daily" class="space-y-4 active">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="daily-report-date" class="block text-sm font-medium text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="daily-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="daily-report-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                                <select id="daily-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="daily-report-chain" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø³Ù„Ø³Ù„Ø©:</label>
                                <select id="daily-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ø§Ø³Ù„</option></select>
                            </div>
                        </div>
                        <button id="generate-daily-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
                    </div>

                    <!-- Date Range Report Content (Hidden by default) -->
                    <div data-report-content="range" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ©</h3>
                         <!-- Reuse date range form logic but simplified -->
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="range-start-date" class="block text-sm font-medium text-gray-700">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="range-start-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-end-date" class="block text-sm font-medium text-gray-700">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="range-end-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-report-chain" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø³Ù„Ø³Ù„Ø©:</label>
                                <select id="range-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ø§Ø³Ù„</option></select>
                            </div>
                        </div>
                        <div>
                             <label for="range-report-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                             <select id="range-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <button id="generate-range-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØªØ±Ø©</button>
                    </div>

                    <!-- Monthly Report Content (Hidden by default) -->
                    <div data-report-content="monthly" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="monthly-report-month" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø´Ù‡Ø±:</label>
                                <input type="month" id="monthly-report-month" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="monthly-report-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                                <select id="monthly-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="monthly-report-chain" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø³Ù„Ø³Ù„Ø©:</label>
                                <select id="monthly-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ø§Ø³Ù„</option></select>
                            </div>
                        </div>
                        <button id="generate-monthly-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
                    </div>

                    <!-- Reconciliation Report Content (Hidden by default) -->
                    <div data-report-content="reconciliation" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ© (Ø§Ù„Ø¹Ø¬Ø² ÙˆØ§Ù„Ø²ÙŠØ§Ø¯Ø©)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="recon-report-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø¥Ø°Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
                                <input type="date" id="recon-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="recon-report-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                                <select id="recon-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="recon-report-chain" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø³Ù„Ø³Ù„Ø©:</label>
                                <select id="recon-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ø§Ø³Ù„</option></select>
                            </div>
                        </div>
                        <button id="generate-recon-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ©</button>
                    </div>

                    <div data-report-content="targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">ØªÙ‚Ø±ÙŠØ± ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ØªØ§Ø±Ø¬Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„ÙƒÙ„ Ù…Ù†Ø¯ÙˆØ¨</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="targets-month" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø´Ù‡Ø±:</label>
                                <input type="month" id="targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="targets-rep-filter" class="block text-sm font-medium text-gray-700">Ø¨Ø­Ø« Ù…Ù†Ø¯ÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                                <select id="targets-rep-filter" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="all">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</option>
                                </select>
                            </div>
                            <div>
                                <label for="targets-chain-filter" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø³Ù„Ø³Ù„Ø©:</label>
                                <select id="targets-chain-filter" class="mt-1 block w-full p-2 border rounded-md"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ø§Ø³Ù„</option></select>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600">ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„ÙƒÙ„ Ù…Ù†Ø¯ÙˆØ¨ØŒ ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ØªØ§Ø±Ø¬Øª Ù…Ø¹ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ÙØªØ±Ø¶Ø© Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©.</p>
                    </div>

                    <div data-report-content="customer-targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">ØªØ§Ø±Ø¬Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§ÙƒØ³Ø¨Ø´Ù† / Ø³ÙÙŠØ± / Ø§Ù„Ø¶Ø­Ù‰)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="customer-targets-month" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø´Ù‡Ø±:</label>
                                <input type="month" id="customer-targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="customer-targets-category" class="block text-sm font-medium text-gray-700">Ø§Ù„ÙØ¦Ø©:</label>
                                <select id="customer-targets-category" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="multi">Ù…Ø§Ù„ØªÙŠ</option>
                                    <option value="dairy">Ø§Ù„Ø¨Ø§Ù†</option>
                                    <option value="both" selected>Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…Ø¹Ø§Ù‹</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex items-end gap-3">
                                <button id="save-customer-targets-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±Ø¬Øª</button>
                                <button id="refresh-customer-targets-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600">Ø¹Ø¯Ù„ Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ø±Ø¬Øª ÙÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸. Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ­Ø³Ø¨ Ø§Ù„Ù…Ø­Ù‚Ù‚ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.</p>
                        <div id="customer-targets-report-output" class="mt-2"></div>
                    </div>

                </div>

                <div id="report-output-area" class="mt-6">
                    <p class="text-center text-gray-500 mt-8">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ø¶ØºØ· "Ø¹Ø±Ø¶" Ù„Ù„Ø¨Ø¯Ø¡.</p>
                </div>
            </div>
            <!-- END RE-ACTIVATED REPORTS PAGE -->


            <!-- ########## PROMOTIONS PAGE ########## -->
            <div id="page-promotions" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©</h2>
                    <div class="flex items-center gap-2">
                        <!-- Notify dropdown (Ø§Ø®Ø·Ø§Ø±) -->
                        <div class="relative" id="promotions-notify-root">
                            <button id="promotions-notify-btn" class="bg-white border px-3 py-1 rounded-md text-sm flex items-center gap-2" aria-haspopup="true" aria-expanded="false">
                                <span class="text-sm font-semibold">Ø§Ø®Ø·Ø§Ø±</span>
                                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
                            </button>
                            <div id="promotions-notify-menu" class="hidden absolute right-0 mt-2 w-52 bg-white border rounded shadow-lg z-50">
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="prices">Ø§Ø®Ø·Ø§Ø± Ø¨Ø§Ø³Ø¹Ø§Ø± Ø§ØµÙ†Ø§Ù</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="new-item">Ø§Ø®Ø·Ø§Ø± Ø¨ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="promotions">Ø§Ø®Ø·Ø§Ø± Ø¨Ø¹Ø±ÙˆØ¶</button>
                            </div>
                        </div>

                        <button id="add-promotion-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 flex items-center gap-2">
                            <i data-lucide="percent"></i>
                            <span>Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</span>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <button id="promotions-view-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm">Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
                    <button id="notifications-view-btn" class="px-3 py-1 bg-white text-gray-700 rounded-md text-sm border">Ø§Ù„Ø§Ø®Ø·Ø§Ø±Ø§Øª</button>
                </div>

                <!-- Batch Promotions Editor (Create many rows exactly like screenshot) -->
                <div class="bg-white border rounded-md p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <label class="text-sm">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <select id="batch-promo-customer" class="p-2 border rounded-md min-w-[220px]"></select>
                            <label class="text-sm">Ù…Ù†</label>
                            <input id="batch-promo-from" type="date" class="p-2 border rounded-md">
                            <label class="text-sm">Ø¥Ù„Ù‰</label>
                            <input id="batch-promo-to" type="date" class="p-2 border rounded-md">
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="batch-promo-add-row" class="px-3 py-1 bg-amber-600 text-white rounded-md text-sm">Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
                            <button id="batch-promo-save" class="px-3 py-1 bg-green-600 text-white rounded-md text-sm">Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full" id="batch-promo-table" style="border-collapse:separate;border-spacing:0 6px;">
                            <thead>
                                <tr>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Price</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">To</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">From</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Item Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Code</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Customer Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="batch-promo-rows"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„Ø³Ø¹Ø±Ø› Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø«Ù… ÙŠØ¹ÙˆØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡Ø§.</p>
                </div>

                <div id="promotions-list" class="space-y-3">
                    <p class="text-gray-500 text-center mt-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                </div>

                <div id="notifications-list" class="space-y-3 hidden">
                    <p class="text-gray-500 text-center mt-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®Ø·Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø§Ø®Ø·Ø§Ø±" Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯.</p>
                </div>
            </div>
            <!-- ########## END PROMOTIONS PAGE ########## -->


            <div id="page-customers" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                    <div class="flex items-center gap-2">
                        <button id="add-chain-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg shadow hover:bg-gray-300 flex items-center gap-2 text-sm">
                            <i data-lucide="layers"></i>
                            <span>Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø³Ù„Ø©</span>
                        </button>
                        <button id="add-customer-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                            <i data-lucide="user-plus"></i>
                            <span>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</span>
                        </button>
                    </div>
                </div>
                <div id="chains-display" class="mb-4"></div>
                <input id="search-customers" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„..." class="w-full p-2 border rounded-md mb-4">
                <div id="customers-list" class="space-y-3"></div>
            </div>

            <div id="page-reps" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h2>
                    <button id="add-rep-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="user-plus"></i>
                        <span>Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨</span>
                    </button>
                </div>
                <div id="reps-list" class="space-y-3"></div>
            </div>

            <!-- ########## SPREADSHEET ENTRY PAGE (Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹) ########## -->
            <div id="page-spreadsheet-entry" class="page">
                <h2 class="text-lg font-bold mb-4">Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹</h2>
                <div class="bg-gray-100 p-3 rounded-lg border mb-4">
                    <!-- Modified grid layout to accommodate the new field -->
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <div>
                            <label for="spreadsheet-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
                            <select id="spreadsheet-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-customer" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <select id="spreadsheet-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙÙˆØ§ØªÙŠØ±</label>
                            <input type="date" id="spreadsheet-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <!-- NEW: Unified Invoice Number Field -->
                        <div>
                            <label for="unified-invoice-number" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…ÙˆØ­Ø¯)</label>
                            <input type="number" id="unified-invoice-number" class="mt-1 block w-full p-2 border border-blue-400 bg-blue-50 rounded-md font-bold" placeholder="ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ">
                        </div>
                        <!-- END NEW -->
                    </div>
                </div>

                <div class="overflow-x-auto shadow rounded-lg border">
                    <table id="spreadsheet-entry-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">Ø§Ù„ÙƒÙˆØ¯</th> <!-- NEW CODE COLUMN -->
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 uppercase min-w-[150px]">Ø§Ù„ØµÙ†Ù</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">Ø³Ø¹Ø± Ù…Ø¹Ø¯Ù„</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">Ø®ØµÙ… %</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù‚Ø³Ù…</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[100px]">Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px] spreadsheet-tax-header" style="display: none;">Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©</th> <!-- NEW TAX FILING COLUMN -->
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[80px]">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase"></th> <!-- Delete button -->
                            </tr>
                        </thead>
                        <tbody id="spreadsheet-entry-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be added by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-between items-center flex-wrap gap-3">
                    <button id="spreadsheet-add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-1 text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</span>
                    </button>
                    <button id="spreadsheet-save-all-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold flex items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span>Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</span>
                    </button>
                </div>

            </div>
             <!-- ########## END SPREADSHEET ENTRY PAGE ########## -->
            
            <!-- ########## DEBTS PAGE (Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª) ########## -->
            <div id="page-debts" class="page" style="display: none;">
                <!-- Tabs for Debts and Collection Receipt -->
                <div class="mb-4 flex gap-2 no-print" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button id="debts-tab-btn" class="debts-tab-button active" style="padding: 8px 16px; background-color: #3b82f6; color: white; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; border: none;">Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</button>
                    <button id="receipt-debts-tab-btn" class="debts-tab-button" style="padding: 8px 16px; background-color: #d1d5db; color: #374151; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; border: none;">ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                </div>

                <!-- Debts Tab Content -->
                <div id="debts-tab-content" class="debts-tab-content active">
                <div class="mb-4 flex flex-col items-end">
                    <h1 class="text-2xl font-bold text-right flex items-center gap-2">
                        <i data-lucide="file-warning" class="w-7 h-7 text-amber-600"></i>
                        <span>Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</span>
                    </h1>
                    <p class="text-sm text-gray-600 text-right flex items-center gap-1">
                        <span>Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</span>
                    </p>
                </div>

                <!-- debug banner removed -->

                <div class="debts-container mb-6">
                    <!-- Left sidebar: actions + stacked summary cards -->
                    <aside class="debts-sidebar">
                        <div class="debts-actions">
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-print-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">Ø·Ø¨Ø§Ø¹Ø©</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-csv-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">ØªØ­Ù…ÙŠÙ„ CSV</span>
                            </button>
                            <!-- Quick navigation: show reps/customers directly from debts page -->
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-reps-btn" title="Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11c1.657 0 3-1.343 3-3S17.657 5 16 5s-3 1.343-3 3 1.343 3 3 3zM8 11c1.657 0 3-1.343 3-3S9.657 5 8 5 5 6.343 5 8s1.343 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zM16 13c-.29 0-.62.02-.97.05C15.7 13.35 17 14.5 17 16v3h5v-2.5C22 14.17 17.33 13 16 13z"/></svg>
                                <span class="ml-1">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-customers-btn" title="Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.62 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0zM19.938 7.124A4 4 0 1116 3a4 4 0 013.938 4.124z"/></svg>
                                <span class="ml-1">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-refresh-btn" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M20 4v6h-6M4 20v-6h6"/></svg>
                                <span class="ml-1">ØªØ­Ø¯ÙŠØ«</span>
                            </button>
                        </div>

                        <!-- Debug banner removed as per user request -->

                        <div class="debt-card">
                            <div class="title">SUB TOTAL</div>
                            <div id="debts-subtotal" class="value">91,295 Ø¬.Ù…</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">Ø§Ù„Ù…Ø³Ø¯Ø¯</div>
                            <div id="debts-paid" class="value">76,336 Ø¬.Ù…</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
                            <div id="debts-invoices-count" class="value">14,959</div>
                        </div>

                        <div class="debt-card big">
                            <div class="title">Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</div>
                            <div id="debts-total-debt" class="value">2,025 Ø¬.Ù…</div>
                        </div>
                    </aside>

                    <!-- Right main area: filters + table -->
                    <section class="debts-main">
                        <!-- Search Filters -->
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block mb-1 text-sm">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <!-- Show only customers who have invoices (either paid or due) -->
                                <select id="debt-customer-filter" class="w-full p-2 border rounded-md text-sm filter-input">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
                                <select id="debt-rep-filter" class="w-full p-2 border rounded-md text-sm bg-white filter-input">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</option>
                                    <option value="5/11/25">5/11/25</option>
                                    <option value="7/11/25">7/11/25</option>
                                    <option value="">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="debt-start-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="debt-end-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                        </div>

                        <div class="mb-4 flex items-center gap-4">
                            <button id="apply-debts-filters-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hide-paid-debts" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="text-sm font-semibold text-gray-700">Ø¹Ø±Ø¶ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¯Ø¯ ÙÙ‚Ø·</span>
                            </label>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto bg-white rounded-lg shadow-sm" style="background: #fafafa !important;">
                            <table class="min-w-full" id="debts-detail-table" style="border-collapse: collapse !important;">
                                <thead>
                                            <tr>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:right">
                                                    <span>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                                                    <button class="column-filter-btn" data-col="customer" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                                                    <button class="column-filter-btn" data-col="date" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span>
                                                    <button class="column-filter-btn" data-col="invoice" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>Ø§Ø¬Ù…Ø§Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span>
                                                    <button class="column-filter-btn" data-col="total" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>Ø§Ù„Ù…Ø³Ø¯Ø¯</span>
                                                    <button class="column-filter-btn" data-col="paid" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>Ø§Ù„Ù…ØªØ¨Ù‚Ù‰</span>
                                                    <button class="column-filter-btn" data-col="remaining" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</span>
                                                    <button class="column-filter-btn" data-col="rep" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button>
                                                </th>
                                            </tr>
                                </thead>
                                <tbody id="debts-detail-body" class="divide-y divide-gray-200">
                                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                                </tbody>
                            </table>
                            <div id="debts-empty-message" class="text-center text-gray-500 p-6 hidden">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ±
                            </div>
                        </div>
                    </section>
                </div>
                </div> <!-- End of debts-tab-content -->

                <!-- Collection Receipt Tab Content -->
                <div id="receipt-debts-tab-content" class="debts-tab-content" style="display:none;">
                    <h2 class="text-xl font-bold mb-4">ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Left: Receipt List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-4 rounded shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                                        <input type="date" id="receipt-from-date" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                                        <input type="date" id="receipt-to-date" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2"></label>
                                        <button id="receipt-filter-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto bg-white rounded-lg shadow">
                                    <table class="w-full border-collapse border border-gray-300">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="border p-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                <th class="border p-2 text-right">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                <th class="border p-2 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                                <th class="border p-2 text-right">Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                                                <th class="border p-2 text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                <th class="border p-2 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receipt-table-body" class="text-sm">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 p-4 bg-gray-50 rounded border">
                                    <div class="grid grid-cols-3 gap-4 text-lg font-bold">
                                        <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="receipt-total" class="text-green-600">0</span></div>
                                        <div>Ø§Ù„Ø¹Ø¯Ø¯: <span id="receipt-count" class="text-blue-600">0</span></div>
                                        <div>Ø§Ù„Ù…ØªÙˆØ³Ø·: <span id="receipt-avg" class="text-purple-600">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Rep Receipt Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-4 rounded shadow-md sticky top-20">
                                <h3 class="text-lg font-bold mb-4 text-right">Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                                    <select id="receipt-rep-dropdown" class="w-full p-2 border rounded text-right">
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ --</option>
                                    </select>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª:</label>
                                    <input type="number" id="rep-credit-transactions" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</label>
                                    <input type="number" id="rep-expenses" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                                    <textarea id="rep-notes" class="w-full p-2 border rounded text-right" rows="4" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <button id="receipt-print-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold">Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                                    <button id="receipt-save-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End of receipt-debts-tab-content -->
            </div>
            <!-- ########## END DEBTS PAGE ########## -->
            
            <!-- ########## CASH PAGE (Ø§Ù„ÙƒØ§Ø´) ########## -->
            <div id="page-cash" class="page" style="display:none;">
                <div id="cash-content-wrapper">
                        <h2 class="text-xl font-bold mb-4">Ø§Ù„ÙƒØ§Ø´ - ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</h2>

                        <div class="mb-4 flex gap-2 items-center no-print">
                            <div class="ml-auto text-sm text-gray-600">Ø§Ø®ØªØ± ØµÙ Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ ÙƒÙ„ ØµÙ Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</div>
                        </div>

                        <!-- Main grid: table (left) + summary (right) -->
                        <div class="cash-grid flex gap-4 items-start">
                            <div class="cash-table-area flex-1 overflow-x-auto bg-white rounded-lg shadow">
                                <table id="cash-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 text-center">#</th>
                                            <th class="p-2 text-center">Ø§Ù„ØªØ§Ø±ÙŠØ® <button class="cash-column-filter-btn" data-col="date" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button></th>
                                            <th class="p-2 text-center">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© <button class="cash-column-filter-btn" data-col="invoice" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button></th>
                                            <th class="p-2 text-right">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ <button class="cash-column-filter-btn" data-col="customer" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button></th>
                                            <th class="p-2 text-right">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ <button class="cash-column-filter-btn" data-col="rep" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button></th>
                                            <th class="p-2 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© <button class="cash-column-filter-btn" data-col="total" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button></th>
                                            <th class="p-2 text-center">Ø®ØµÙ…</th>
                                            <th class="p-2 text-center">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</th>
                                            <th class="p-2 text-center">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</th>
                                            <th class="p-2 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th>
                                            <th class="p-2 text-center">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ <button class="cash-column-filter-btn" data-col="remaining" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button></th>
                                            <th class="p-2 text-center">ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„ <button class="cash-column-filter-btn" data-col="collection" aria-label="ÙÙ„ØªØ±" title="ÙÙ„ØªØ±" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">â–¾</button></th>
                                            <th class="p-2 text-center">Ø±Ù‚Ù… ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                                            <th class="p-2 text-center">Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th>
                                            <th class="p-2 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cash-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows created by renderCash() -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Cash summary panel (totals) - right column -->
                            <aside id="cash-summary-panel" class="w-60 p-2 bg-gray-50 rounded-lg shadow-sm text-right">
                                    <table style="width:100%;border-collapse:collapse;font-size:14px;">
                                        <tbody>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</td>
                                                                <td id="cash-summary-total" style="padding:6px;font-weight:700;text-align:left">0 Ø¬.Ù…</td>
                                                            </tr>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</td>
                                                                <td id="cash-summary-count" style="padding:6px;font-weight:600;text-align:left">0</td>
                                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</td>
                                                <td id="cash-summary-paid" style="padding:6px;font-weight:600;color:#047857;text-align:left">0 Ø¬.Ù…</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">Ø®ØµÙ… Ø®Ø§Øµ</td>
                                                <td id="cash-summary-discount" style="padding:6px;font-weight:600;color:#b91c1c;text-align:left">0 Ø¬.Ù…</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</td>
                                                <td id="cash-summary-remaining" style="padding:6px;font-weight:700;text-align:left">0 Ø¬.Ù…</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="pt-2 no-print">
                                        <button id="cash-print-btn" class="w-full bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                                        <button id="cash-include-all-btn" class="w-full mt-2 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">Ø´Ù…Ù„ ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„ÙƒØ§Ø´</button>
                                    </div>
                                </aside>
                        </div>
                    </div>
            </div>

            <!-- ########## END CASH PAGE ########## -->
            <script>
                (function(){
                    function injectCashStyles(){
                        if(document.getElementById('cash-page-styles')) return;
                        const css = `
                            /* Row states */
                            .cash-row-due { background: rgba(254, 226, 226, 0.6); }
                            .cash-row-paid { background: rgba(220, 253, 231, 0.9); }
                            .cash-row-collected { background: rgba(219, 234, 254, 0.95); }
                            .cash-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; display:inline-block; }
                            .cash-action-btn { display:inline-block; padding:4px 6px; border-radius:6px; border:none; cursor:pointer; margin:2px 6px; color:#fff; font-size:13px; }
                            .cash-action-create { background:#2563eb; }
                            .cash-action-safe { background:#059669; }

                            /* Tab styling */
                            .cash-tab-button { transition: all 0.3s ease; }
                            .cash-tab-button.active { background-color: #3b82f6; color: white; }
                            .cash-tab-content { display:none; }
                            .cash-tab-content.active { display:block; }

                            /* Layout: table left, summary right */
                            .cash-grid { display:flex; gap:16px; align-items:flex-start; }
                            .cash-table-area { flex:1 1 auto; max-width: calc(100% - 300px); }
                            #cash-summary-panel { width: 220px; min-width: 160px; max-width: 260px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
                            #cash-summary-panel .text-2xl { line-height:1.1; }

                            /* Make table scroll horizontally but keep summary visible */
                            .cash-table-area table { width:100%; border-collapse:collapse; }

                            /* Responsive: stack on small screens */
                            @media (max-width: 900px) {
                                .cash-grid { display:block; }
                                .cash-table-area { max-width: 100%; }
                                #cash-summary-panel { width: 100%; margin-top: 12px; }
                            }
                            /* Ensure header stays above content so pages scroll under the blue header */
                            header.sticky { z-index: 9999 !important; }

                            /* Debts Tab Styling */
                            .debts-tab-button { transition: all 0.3s ease; }
                            .debts-tab-button.active { background-color: #3b82f6; color: white; }
                            .debts-tab-content { display:none; }
                            .debts-tab-content.active { display:block; }
                        `;
                        const s = document.createElement('style'); s.id = 'cash-page-styles'; s.appendChild(document.createTextNode(css)); document.head.appendChild(s);
                    }

                    function renderCashSummary(sales){
                        try{
                            const total = sales.reduce((sum,s)=> sum + Number(s.total || 0), 0);
                            const paid = sales.reduce((sum,s)=> sum + (Number(s.paidAmount || 0) || ((Number(s.firstPayment||0)+Number(s.secondPayment||0)) || 0)), 0);
                            // Discount should be entered manually when creating a collection report (sale.collectionDiscount)
                            const discount = sales.reduce((sum,s)=> sum + (Number(s.collectionDiscount || 0)), 0);
                            // Remaining should account for manual discounts applied at collection
                            const remaining = total - paid - discount;
                            const elTotal = document.getElementById('cash-summary-total');
                            const elPaid = document.getElementById('cash-summary-paid');
                            const elDiscount = document.getElementById('cash-summary-discount');
                            const elRemaining = document.getElementById('cash-summary-remaining');
                            if(elTotal) elTotal.textContent = formatCurrency(total);
                            if(elPaid) elPaid.textContent = formatCurrency(paid);
                            if(elDiscount) elDiscount.textContent = formatCurrency(discount);
                            if(elRemaining) elRemaining.textContent = formatCurrency(remaining);
                            // show count if element exists
                            const elCount = document.getElementById('cash-summary-count');
                            if(elCount) elCount.textContent = String(Array.isArray(sales) ? sales.length : 0);
                        } catch(e){ console.warn('renderCashSummary error', e); }
                    }

                    // Save Cash data to Firestore
                    window.saveCashToCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.warn('ğŸ’¾ saveCashToCloud: DB not ready'); return; }
                            if (!window.state || !window.state.sales) { console.warn('ğŸ’¾ saveCashToCloud: no sales'); return; }
                            const payload = {
                                sales: Array.isArray(window.state.sales) ? window.state.sales : [],
                                timestamp: new Date().toISOString(),
                                updatedAt: (typeof serverTs === 'function') ? serverTs() : { _type: 'ServerValue', value: 'TIMESTAMP' }
                            };
                            await db.collection('settings').doc('cashData').set(payload, { merge: true });
                            console.log('âœ… saveCashToCloud: saved', payload.sales.length, 'sales');
                        } catch(e) { console.error('âŒ saveCashToCloud failed', e); }
                    };
                    window.debouncedSaveCash = function(){
                        clearTimeout(window._cashSaveTimer);
                        window._cashSaveTimer = setTimeout(window.saveCashToCloud, 1500);
                    };

                    // Load Cash data from Firestore on startup
                    window.loadCashFromCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.warn('ğŸ’¾ loadCashFromCloud: DB not ready'); return false; }
                            const doc = await db.collection('settings').doc('cashData').get();
                            if (!doc.exists) { console.log('ğŸ’¾ loadCashFromCloud: no doc found'); return false; }
                            const data = doc.data() || {};
                            if (Array.isArray(data.sales) && data.sales.length > 0) {
                                window.state = window.state || {};
                                window.state.sales = data.sales;
                                try { localStorage.setItem('cache_sales', JSON.stringify(data.sales)); } catch(_){ }
                                console.log('âœ… loadCashFromCloud: restored', data.sales.length, 'sales');
                                return true;
                            }
                        } catch(e) { console.error('âŒ loadCashFromCloud failed', e); }
                        return false;
                    };

                    function renderCash(){
                        try {
                            injectCashStyles();
                            const tbody = document.getElementById('cash-table-body');
                            if(!tbody) return;
                            // Diagnostic: log sales length + invoice numbers to help locate missing invoice
                            try {
                                console.debug('renderCash called', { stateSalesLength: Array.isArray(state.sales) ? state.sales.length : state.sales, invoiceNumbers: Array.isArray(state.sales) ? state.sales.map(s => ({id: s.id, invoiceNumber: s.invoiceNumber, includeInCash: s.includeInCash})) : [] });
                            } catch(e) { /* ignore */ }
                            tbody.innerHTML = '';
                            // Show all sales by default so Cash mirrors Sales automatically
                            const sales = Array.isArray(state.sales) ? state.sales.slice() : [];
                            // Expose the currently rendered sales for the filter menus
                            window._cashFiltersOriginalRenderedSales = sales.slice();
                            window._lastRenderedCashSales = sales.slice();

                            renderCashSummary(sales);

                            if(sales.length === 0){
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td colspan="15" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ ÙÙŠ Ø§Ù„ÙƒØ§Ø´.</td>`;
                                tbody.appendChild(tr);
                                return;
                            }

                            // Sort oldest first (old above, new below)
                            sales.sort((a,b)=> new Date(a.date || a.createdAt) - new Date(b.date || b.createdAt));
                            sales.forEach((s, idx) => {
                                const first = Number(s.firstPayment || 0);
                                const second = Number(s.secondPayment || 0);
                                const paidSum = (first + second) || Number(s.paidAmount || 0) || 0;
                                const total = Number(s.total || 0);
                                // Use explicit invoice discount and a manual collection discount (editable)
                                const invoiceDiscount = Number(s.discount || 0);
                                const collectionDiscount = Number(s.collectionDiscount || 0);
                                // Collected after discount = collected payments minus any collection discount applied
                                const collectedAfter = Math.max(0, Math.round(((first + second) - collectionDiscount) * 100) / 100);
                                // Remaining = total - collected payments - collection discount
                                const remainingAmount = Math.round((total - (first + second) - collectionDiscount) * 100) / 100;
                                const customerName = (findCustomer(s.customerId) || {}).name || s.customerName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                const rep = s.repName || s.rep || '';
                                const tr = document.createElement('tr');
                                // Decide row color: fully paid (remaining <= 0) -> blue, collected flag -> blue, paidToSafe -> green, due -> red
                                let rowClass = '';
                                if (typeof remainingAmount !== 'undefined' && remainingAmount <= 0) rowClass = 'cash-row-collected';
                                else if (s.collectionReportCreated) rowClass = 'cash-row-collected';
                                else if (s.paidToSafe) rowClass = 'cash-row-paid';
                                else if (s.status === 'due') rowClass = 'cash-row-due';
                                tr.className = rowClass;
                                // visibly mark rows explicitly excluded from cash (legacy flag)
                                if (s.includeInCash === false) {
                                    tr.style.opacity = '0.6';
                                    tr.dataset.excludedFromCash = 'true';
                                }
                                tr.dataset.saleId = s.id;
                                // dataset fields for filtering
                                try {
                                    tr.dataset.date = (s.date || s.createdAt || '').split('T')[0] || '';
                                    tr.dataset.invoice = String(s.invoiceNumber || '');
                                    tr.dataset.customer = String(customerName || '');
                                    tr.dataset.rep = String(rep || '');
                                    tr.dataset.total = String(total || 0);
                                    tr.dataset.paid = String(paidSum || Number(s.paidAmount || 0) || 0);
                                    tr.dataset.remaining = String(remainingAmount || 0);
                                } catch(e) { /* ignore */ }

                                tr.innerHTML = `
                                    <td class="p-2 text-center">${idx + 1}</td>
                                    <td class="p-2 text-center">${formatArabicDate(s.date || s.createdAt || new Date().toISOString())}</td>
                                    <td class="p-2 text-center">${s.invoiceNumber || ''}</td>
                                    <td class="p-2 text-right">${customerName}</td>
                                    <td class="p-2 text-right">${rep}</td>
                                    <td class="p-2 text-center">${formatCurrency(total)}</td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-discount" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(collectionDiscount))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-first-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(first))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-second-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(second))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center">${formatCurrency(collectedAfter)}</td>
                                    <td class="p-2 text-center"><span class="cash-remaining" data-id="${s.id}" style="${remainingAmount > 0 ? 'background:#fee2e2;color:#991b1b;font-weight:700;padding:6px;border-radius:6px;display:inline-block;' : 'background:#dcfce7;color:#065f46;font-weight:700;padding:6px;border-radius:6px;display:inline-block;'}">${formatCurrency(remainingAmount)}</span></td>
                                    <td class="p-2 text-center">${s.collectionReportCreated ? '<span class="cash-badge" style="background:#dbeafe;color:#1e40af">ØªÙ…</span>' : '<span class="cash-badge" style="background:#fef3c7;color:#92400e">Ù„Ù… ÙŠØªÙ…</span>'}</td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-number" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(s.collectionNumber || ''))}" placeholder="Ø±Ù‚Ù…"></td>
                                    <td class="p-2 text-center">${s.paidToSafe ? '<span class="cash-badge" style="background:#dcfce7;color:#065f46">Ø¯Ø®Ù„</span>' : '<span class="cash-badge" style="background:#fef2f2;color:#991b1b">Ù„Ù… ÙŠØ¯Ø®Ù„</span>'}</td>
                                    <td class="p-2 text-center">
                                        <button class="cash-action-btn cash-action-create" data-id="${s.id}">${s.collectionReportCreated ? 'Ø¥Ù„ØºØ§Ø¡ ÙƒØ´Ù' : 'Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù'}</button>
                                        <button class="cash-action-btn cash-action-safe" data-id="${s.id}">${s.paidToSafe ? 'Ø¥Ù„ØºØ§Ø¡ Ø®Ø²ÙŠÙ†Ø©' : 'Ø¯Ø®Ù„ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©'}</button>
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            });

                            // Attach collection number handlers
                            tbody.querySelectorAll('.cash-collection-number').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    sale.collectionNumber = input.value.trim();
                                    saveState();
                                    // just update summary/rows without full reload to keep cursor stable
                                });
                            });

                            // Attach collection discount handlers (editable in table)
                            tbody.querySelectorAll('.cash-collection-discount').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    const val = parseFloat(input.value.toString().replace(/,/g, '')) || 0;
                                    sale.collectionDiscount = Math.round(val * 100) / 100;
                                    saveState();
                                    try { if (typeof window.debouncedSaveCash === 'function') window.debouncedSaveCash(); } catch(e){}
                                    renderCash();
                                });
                            });

                            // Attach first/second payment handlers (editable in-cash)
                            spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                                const invoiceNumberInput = row.querySelector('.spreadsheet-invoice-number');
                                const productCodeInput = row.querySelector('.spreadsheet-product-code');
                                const productNameInput = row.querySelector('.spreadsheet-product-name');
                                const taxStatusInput = row.querySelector('.spreadsheet-tax-status-input');
                                const rawInvoiceNumber = invoiceNumberInput.value.trim();
                                const invoiceNumber = rawInvoiceNumber ? parseInt(rawInvoiceNumber) : null;
                                const productId = row.dataset.productId;
                                const productNameValue = productNameInput ? productNameInput.value.trim() : '';
                                const quantity = parseInt(row.querySelector('.spreadsheet-quantity').value) || 0;
                                const originalPrice = parseFloat(row.querySelector('.spreadsheet-price').value);
                                const modifiedPrice = parseFloat(row.querySelector('.spreadsheet-modified-price').value);
                                const safeOriginalPrice = (!isNaN(originalPrice) ? originalPrice : 0);
                                const safeModifiedPrice = (!isNaN(modifiedPrice) ? modifiedPrice : 0);
                                const price = (safeModifiedPrice > 0) ? safeModifiedPrice : safeOriginalPrice;
                                const discount = parseFloat(row.querySelector('.spreadsheet-discount').value);
                                const safeDiscount = (!isNaN(discount) ? discount : 0);
                                const collection = row.querySelector('.spreadsheet-collection').value;
                                const partialAmount = parseFloat(row.querySelector('.spreadsheet-partial-amount')?.value);
                                const safePartialAmount = (!isNaN(partialAmount) ? partialAmount : 0);
                                const taxFilingStatus = taxStatusInput ? taxStatusInput.value.trim() : '';

                                // Track if user manually edited the invoice number for this row
                                const rowManual = invoiceNumberInput && invoiceNumberInput.dataset && invoiceNumberInput.dataset.userEntered === '1';
                                let rowIsValidLocal = true;

                                [invoiceNumberInput, productCodeInput, row.querySelector('.spreadsheet-quantity'), row.querySelector('.spreadsheet-price'), row.querySelector('.spreadsheet-discount')].forEach(el => el.classList.remove('border-red-500', 'border-2'));
                                if (productNameInput) productNameInput.classList.remove('border-red-500', 'border-2');
                                if (taxStatusInput) taxStatusInput.classList.remove('border-red-500', 'border-2');

                                // Special-case: product code '100' is used as a cancelled-invoice placeholder
                                const codeValue = (productCodeInput && productCodeInput.value) ? productCodeInput.value.trim() : '';
                                const isCanceledCode = (codeValue === '100') || (productId === '100');

                                if (isCanceledCode) {
                                    // allow saving a cancelled invoice row even without price/quantity
                                    dataFound = true;

                                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0) {
                                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    }

                                    if (invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).collectionStatus !== collection) {
                                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    }

                                    if (!rowIsValidLocal) {
                                        if (rowManual) {
                                            // accept manual entry and clear visual error
                                            invoiceNumberInput.classList.remove('border-red-500', 'border-2');
                                            rowIsValidLocal = true;
                                        } else {
                                            isValid = false;
                                            return;
                                        }
                                    }

                                    if (!invoicesToSave.has(invoiceNumber)) {
                                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? safePartialAmount : 0, isCanceled: true });
                                    } else {
                                        invoicesToSave.get(invoiceNumber).isCanceled = true;
                                    }

                                    // skip normal item validation for this row
                                    return;
                                }

                                if (productId || productNameValue) {
                                    dataFound = true;
                    
                                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹
                                    const product = getProductDetailsByCode(productId);
                                    if (!product) {
                                        if (productNameInput) {
                                            productNameInput.classList.add('border-red-500', 'border-2');
                                        }
                                        if (productCodeInput) {
                                            productCodeInput.classList.add('border-red-500', 'border-2');
                                        }
                                        rowIsValidLocal = false;
                                        if (!rowManual) { isValid = false; return; } else { rowIsValidLocal = true; invoiceNumberInput.classList.remove('border-red-500','border-2'); }
                                    }
                    
                                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0) {
                                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    }

                                    // Validation continues below...

                                    // Quantity cannot be zero (but can be negative)
                                    if (!quantity || quantity === 0) { row.querySelector('.spreadsheet-quantity').classList.add('border-red-500', 'border-2'); rowIsValidLocal = false; }

                                    if (isNaN(price) || price <= 0) { row.querySelector('.spreadsheet-price').classList.add('border-red-500', 'border-2'); rowIsValidLocal = false; }
                                    if (isNaN(discount) || discount < 0 || discount > 100) { row.querySelector('.spreadsheet-discount').classList.add('border-red-500', 'border-2'); rowIsValidLocal = false; }

                                    if (!rowIsValidLocal) {
                                        if (rowManual) {
                                            // Accept manual entry despite row-level validation failures
                                            invoiceNumberInput.classList.remove('border-red-500','border-2');
                                            row.querySelector('.spreadsheet-quantity')?.classList.remove('border-red-500','border-2');
                                            row.querySelector('.spreadsheet-price')?.classList.remove('border-red-500','border-2');
                                            row.querySelector('.spreadsheet-discount')?.classList.remove('border-red-500','border-2');
                                            if (taxStatusInput) taxStatusInput.classList.remove('border-red-500','border-2');
                                            rowIsValidLocal = true;
                                        } else {
                                            isValid = false;
                                            return;
                                        }
                                    }

                                    if (!invoicesToSave.has(invoiceNumber)) {
                                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? safePartialAmount : 0 });
                                    }

                                    const itemSubtotal = price * quantity;
                                    const itemFinalPrice = itemSubtotal * (1 - safeDiscount / 100);
                                    const invoiceData = invoicesToSave.get(invoiceNumber);
                                    invoiceData.items.push({ productId, quantity, price, discountPercent: safeDiscount, itemFinalPrice });
                                    invoiceData.totalSales += itemFinalPrice;
                                    invoiceData.taxFilingStatus = taxFilingStatus;
                                    if (collection === 'partial') invoiceData.partialAmount = safePartialAmount;
                                } else if (productCodeInput.value.trim()) {
                                    productCodeInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    if (!rowManual) { isValid = false; } else { productCodeInput.classList.remove('border-red-500','border-2'); rowIsValidLocal = true; }
                                }
                
                            });
                        } catch(e) { console.warn('renderCash error', e); }
                    }
                    
                    // Safe stub to avoid ReferenceError if attachCashListeners isn't defined on this page
                    if (typeof window.attachCashListeners !== 'function') {
                        window.attachCashListeners = function(){};
                    }
                    document.addEventListener('DOMContentLoaded', ()=>{
                        try{ if (typeof attachCashListeners === 'function') attachCashListeners(); }
                        catch(e){ console.warn('attachCashListeners error', e); }
                    });

                    // Save Cash data to Firestore
                    window.saveCashToCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.warn('ğŸ’¾ saveCashToCloud: DB not ready'); return; }
                            if (!window.state || !window.state.sales) { console.warn('ğŸ’¾ saveCashToCloud: no sales'); return; }
                            const payload = {
                                sales: Array.isArray(window.state.sales) ? window.state.sales : [],
                                timestamp: new Date().toISOString(),
                                updatedAt: (typeof serverTs === 'function') ? serverTs() : firebase.firestore.FieldValue.serverTimestamp()
                            };
                            await db.collection('settings').doc('cashData').set(payload, { merge: true });
                            console.log('âœ… saveCashToCloud: saved', payload.sales.length, 'sales to cloud');
                        } catch(e) { console.error('âŒ saveCashToCloud failed', e); }
                    };
                    window.debouncedSaveCash = function(){
                        clearTimeout(window._cashSaveTimer);
                        window._cashSaveTimer = setTimeout(window.saveCashToCloud, 1500);
                    };

                    // Load Cash data from Firestore on startup
                    window.loadCashFromCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.log('ğŸ’¾ loadCashFromCloud: DB not ready'); return false; }
                            const doc = await db.collection('settings').doc('cashData').get();
                            if (!doc.exists) { console.log('ğŸ’¾ loadCashFromCloud: no doc found'); return false; }
                            const data = doc.data() || {};
                            if (Array.isArray(data.sales) && data.sales.length > 0) {
                                window.state = window.state || {};
                                window.state.sales = data.sales;
                                try { localStorage.setItem('cache_sales', JSON.stringify(data.sales)); } catch(_){ }
                                console.log('âœ… loadCashFromCloud: restored', data.sales.length, 'sales from cloud');
                                return true;
                            }
                        } catch(e) { console.warn('ğŸ’¾ loadCashFromCloud failed', e); }
                        return false;
                    };

                    // expose for manual calls / debugging
                    window.renderCash = renderCash;

                    // ========== TAB SWITCHING AND RECEIPT FUNCTIONALITY ==========
                    // Collection Receipt functionality
                    window.renderCollectionReceipt = function() {
                        try {
                            const fromDate = document.getElementById('receipt-from-date')?.value;
                            const toDate = document.getElementById('receipt-to-date')?.value;
                            const repFilter = document.getElementById('receipt-rep-dropdown')?.value;
                            const tbody = document.getElementById('receipt-table-body');
                            if (!tbody) return;
                            
                            tbody.innerHTML = '';
                            let receipts = [];
                            let totalAmount = 0;
                            let totalCount = 0;
                            
                            // Ø¬Ù…Ø¹ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ù…Ù† ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                            if (Array.isArray(state.sales)) {
                                state.sales.forEach(sale => {
                                    const saleDate = sale.date ? new Date(sale.date).toISOString().split('T')[0] : null;
                                    if (!saleDate) return;
                                    
                                    // ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
                                    if (fromDate && saleDate < fromDate) return;
                                    if (toDate && saleDate > toDate) return;
                                    
                                    // ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
                                    if (repFilter && sale.repName !== repFilter) return;
                                    
                                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒØ§Ø´ (Cash)
                                    if (sale.status === 'cash') {
                                        const amount = sale.total || sale.totalAfterDiscount || 0;
                                        receipts.push({
                                            date: saleDate,
                                            invoiceNumber: sale.invoiceNumber,
                                            customer: sale.customerName || findCustomer(sale.customerId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                                            type: 'ÙƒØ§Ø´',
                                            amount: amount,
                                            status: 'Ù…Ø³Ø¯Ø¯Ø©'
                                        });
                                        totalAmount += amount;
                                    }
                                    
                                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¯ÙØ¹ Ø¬Ø²Ø¡ (Partial)
                                    if (sale.status === 'partial') {
                                        if (sale.firstPayment && sale.firstPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber + ' (Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰)',
                                                customer: sale.customerName || findCustomer(sale.customerId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                                                type: 'Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰',
                                                amount: sale.firstPayment,
                                                status: 'Ù…Ø³Ø¯Ø¯Ø©'
                                            });
                                            totalAmount += sale.firstPayment;
                                        }
                                        if (sale.secondPayment && sale.secondPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber + ' (Ø¯ÙØ¹Ø© Ø«Ø§Ù†ÙŠØ©)',
                                                customer: sale.customerName || findCustomer(sale.customerId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                                                type: 'Ø¯ÙØ¹Ø© Ø«Ø§Ù†ÙŠØ©',
                                                amount: sale.secondPayment,
                                                status: 'Ù…Ø³Ø¯Ø¯Ø©'
                                            });
                                            totalAmount += sale.secondPayment;
                                        }
                                    }
                                });
                            }
                            
                            // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
                            receipts.sort((a, b) => new Date(a.date) - new Date(b.date));
                            
                            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙÙˆÙ
                            if (receipts.length === 0) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = '<td colspan="6" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­ØµÙŠÙ„Ø§Øª</td>';
                                tbody.appendChild(tr);
                            } else {
                                receipts.forEach((receipt, idx) => {
                                    const tr = document.createElement('tr');
                                    tr.classList.add(idx % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                                    tr.innerHTML = `
                                        <td class="border p-2 text-right">${receipt.date}</td>
                                        <td class="border p-2 text-right">${receipt.invoiceNumber}</td>
                                        <td class="border p-2 text-right">${receipt.customer}</td>
                                        <td class="border p-2 text-right">${receipt.type}</td>
                                        <td class="border p-2 text-right font-semibold">${formatCurrency(receipt.amount)}</td>
                                        <td class="border p-2 text-right"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${receipt.status}</span></td>
                                    `;
                                    tbody.appendChild(tr);
                                });
                                totalCount = receipts.length;
                            }
                            
                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                            const totalEl = document.getElementById('receipt-total');
                            const countEl = document.getElementById('receipt-count');
                            const avgEl = document.getElementById('receipt-avg');
                            if (totalEl) totalEl.textContent = formatCurrency(totalAmount);
                            if (countEl) countEl.textContent = totalCount;
                            if (avgEl) avgEl.textContent = formatCurrency(totalCount > 0 ? totalAmount / totalCount : 0);
                            
                        } catch(e) { console.error('renderCollectionReceipt error', e); }
                    };

                    window.populateReceiptRepDropdown = function() {
                        const select = document.getElementById('receipt-rep-dropdown');
                        if (!select) return;
                        const reps = Array.from(new Set((state.sales || []).map(s => s.repName).filter(Boolean)));
                        select.innerHTML = '<option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ --</option>';
                        reps.forEach(rep => {
                            const option = document.createElement('option');
                            option.value = rep;
                            option.textContent = rep;
                            select.appendChild(option);
                        });
                    };

                    // Initialize receipt page
                    window.initReceiptPage = function() {
                        const today = new Date().toISOString().split('T')[0];
                        const fromInput = document.getElementById('receipt-from-date');
                        const toInput = document.getElementById('receipt-to-date');
                        if (fromInput && !fromInput.value) fromInput.value = today;
                        if (toInput && !toInput.value) toInput.value = today;
                        window.populateReceiptRepDropdown();
                    };

                    // Receipt filter and print buttons
                    document.addEventListener('DOMContentLoaded', function() {
                        const filterBtn = document.getElementById('receipt-filter-btn');
                        const printBtn = document.getElementById('receipt-print-btn');
                        const saveBtn = document.getElementById('receipt-save-btn');
                        
                        if (filterBtn) {
                            filterBtn.addEventListener('click', () => {
                                window.renderCollectionReceipt();
                            });
                        }
                        
                        if (printBtn) {
                            printBtn.addEventListener('click', () => {
                                // Print only the receipt section
                                const printWindow = window.open('', '', 'height=600,width=800');
                                const repName = document.getElementById('receipt-rep-dropdown')?.value || 'Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯';
                                const credits = document.getElementById('rep-credit-transactions')?.value || '0';
                                const expenses = document.getElementById('rep-expenses')?.value || '0';
                                const notes = document.getElementById('rep-notes')?.value || '';
                                const totalEl = document.getElementById('receipt-total');
                                const total = totalEl?.textContent || '0';
                                
                                const contentToPrint = `
                                    <html dir="rtl">
                                    <head>
                                        <style>
                                            body { font-family: Arial, sans-serif; text-align: right; margin: 20px; }
                                            h2 { text-align: center; font-size: 18px; margin-bottom: 20px; }
                                            .receipt-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
                                            .receipt-item { margin: 10px 0; padding: 5px 0; border-bottom: 1px solid #ccc; }
                                            .receipt-item label { font-weight: bold; width: 150px; display: inline-block; }
                                            .receipt-item value { margin-right: 10px; }
                                            .receipt-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 16px; }
                                        </style>
                                    </head>
                                    <body>
                                        <h2>ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</h2>
                                        <div class="receipt-header">
                                            <div class="receipt-item"><label>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label> <span>${repName}</span></div>
                                            <div class="receipt-item"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label> <span>${new Date().toLocaleDateString('ar-EG')}</span></div>
                                        </div>
                                        <div class="receipt-item"><label>Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª:</label> <span>${credits}</span></div>
                                        <div class="receipt-item"><label>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</label> <span>${expenses}</span></div>
                                        <div class="receipt-item"><label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label> <span>${notes}</span></div>
                                        <div class="receipt-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: ${total}</div>
                                    </body>
                                    </html>`;
                                printWindow.document.write(contentToPrint);
                                printWindow.document.close();
                                printWindow.print();
                            });
                        }
                        
                        if (saveBtn) {
                            saveBtn.addEventListener('click', () => {
                                try {
                                    const repName = document.getElementById('receipt-rep-dropdown')?.value;
                                    const credits = document.getElementById('rep-credit-transactions')?.value;
                                    const expenses = document.getElementById('rep-expenses')?.value;
                                    const notes = document.getElementById('rep-notes')?.value;
                                    
                                    if (!repName) {
                                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹');
                                        return;
                                    }
                                    
                                    const receiptData = {
                                        repName,
                                        credits: parseFloat(credits) || 0,
                                        expenses: parseFloat(expenses) || 0,
                                        notes,
                                        timestamp: new Date().toISOString(),
                                        date: new Date().toISOString().split('T')[0]
                                    };
                                    
                                    // Save to localStorage
                                    localStorage.setItem(`rep_receipt_${repName}_${receiptData.date}`, JSON.stringify(receiptData));
                                    
                                    // Save to cloud
                                    if (window.db && typeof db !== 'undefined') {
                                        db.collection('settings').doc('repReceipts').collection(receiptData.date).doc(repName).set(receiptData, { merge: true })
                                            .then(() => {
                                                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                                            })
                                            .catch(e => console.warn('Failed to save to cloud', e));
                                    }
                                } catch(e) {
                                    console.error('Error saving receipt data', e);
                                    alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                                }
                            });
                        }

                        // Setup tab switching for Debts page
                        const debtsTabBtn = document.getElementById('debts-tab-btn');
                        const receiptDebtsTabBtn = document.getElementById('receipt-debts-tab-btn');
                        const debtsTabContent = document.getElementById('debts-tab-content');
                        const receiptDebtsTabContent = document.getElementById('receipt-debts-tab-content');
                        
                        if (debtsTabBtn && receiptDebtsTabBtn && debtsTabContent && receiptDebtsTabContent) {
                            debtsTabBtn.addEventListener('click', () => {
                                debtsTabBtn.style.backgroundColor = '#3b82f6';
                                debtsTabBtn.style.color = 'white';
                                receiptDebtsTabBtn.style.backgroundColor = '#d1d5db';
                                receiptDebtsTabBtn.style.color = '#374151';
                                debtsTabContent.style.display = '';
                                debtsTabContent.classList.add('active');
                                receiptDebtsTabContent.style.display = 'none';
                                receiptDebtsTabContent.classList.remove('active');
                            });
                            
                            receiptDebtsTabBtn.addEventListener('click', () => {
                                receiptDebtsTabBtn.style.backgroundColor = '#3b82f6';
                                receiptDebtsTabBtn.style.color = 'white';
                                debtsTabBtn.style.backgroundColor = '#d1d5db';
                                debtsTabBtn.style.color = '#374151';
                                receiptDebtsTabContent.style.display = '';
                                receiptDebtsTabContent.classList.add('active');
                                debtsTabContent.style.display = 'none';
                                debtsTabContent.classList.remove('active');
                                window.initReceiptPage();
                                window.renderCollectionReceipt();
                            });
                        }

                        // Local tab switching inside dispatch page
                        const dispatchNotesTabBtn = document.getElementById('dispatch-notes-tab-btn');
                        const receiptLocalTabBtn = document.getElementById('receipt-local-tab-btn');
                        const dispatchNotesTabContent = document.getElementById('dispatch-notes-tab-content');
                        const receiptLocalTabContent = document.getElementById('receipt-local-tab-content');
                        
                        if (dispatchNotesTabBtn && receiptLocalTabBtn && dispatchNotesTabContent && receiptLocalTabContent) {
                            dispatchNotesTabBtn.addEventListener('click', () => {
                                dispatchNotesTabBtn.style.backgroundColor = '#3b82f6';
                                dispatchNotesTabBtn.style.color = 'white';
                                receiptLocalTabBtn.style.backgroundColor = '#d1d5db';
                                receiptLocalTabBtn.style.color = '#374151';
                                dispatchNotesTabContent.style.display = 'block';
                                receiptLocalTabContent.style.display = 'none';
                            });
                            
                            receiptLocalTabBtn.addEventListener('click', () => {
                                receiptLocalTabBtn.style.backgroundColor = '#3b82f6';
                                receiptLocalTabBtn.style.color = 'white';
                                dispatchNotesTabBtn.style.backgroundColor = '#d1d5db';
                                dispatchNotesTabBtn.style.color = '#374151';
                                receiptLocalTabContent.style.display = 'block';
                                dispatchNotesTabContent.style.display = 'none';
                                // Initialize receipt page with local IDs
                                try {
                                    const today = new Date().toISOString().split('T')[0];
                                    const fromInput = document.getElementById('receipt-from-date-local');
                                    const toInput = document.getElementById('receipt-to-date-local');
                                    if (fromInput && !fromInput.value) fromInput.value = today;
                                    if (toInput && !toInput.value) toInput.value = today;
                                    const repDropdown = document.getElementById('receipt-rep-dropdown-local');
                                    if (repDropdown) {
                                        const reps = Array.from(new Set((state.sales || []).map(s => s.repName).filter(Boolean)));
                                        repDropdown.innerHTML = '<option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ --</option>';
                                        reps.forEach(rep => {
                                            const option = document.createElement('option');
                                            option.value = rep;
                                            option.textContent = rep;
                                            repDropdown.appendChild(option);
                                        });
                                    }
                                    // Render receipt with local IDs
                                    if (typeof renderCollectionReceiptLocal === 'function') renderCollectionReceiptLocal();
                                } catch(e) { console.warn('receipt init failed', e); }
                            });
                        }
                        
                        // Filter button for local receipt
                        const filterBtnLocal = document.getElementById('receipt-filter-btn-local');
                        if (filterBtnLocal) {
                            filterBtnLocal.addEventListener('click', () => {
                                if (typeof renderCollectionReceiptLocal === 'function') renderCollectionReceiptLocal();
                            });
                        }
                        
                        // Print button for local receipt
                        const printBtnLocal = document.getElementById('receipt-print-btn-local');
                        if (printBtnLocal) {
                            printBtnLocal.addEventListener('click', () => {
                                const repName = document.getElementById('receipt-rep-dropdown-local')?.value || 'Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯';
                                const credits = document.getElementById('rep-credit-transactions-local')?.value || '0';
                                const expenses = document.getElementById('rep-expenses-local')?.value || '0';
                                const notes = document.getElementById('rep-notes-local')?.value || '';
                                const totalEl = document.getElementById('receipt-total-local');
                                const total = totalEl?.textContent || '0';
                                
                                const contentToPrint = `
                                    <html dir="rtl">
                                    <head>
                                        <style>
                                            body { font-family: Arial, sans-serif; text-align: right; margin: 20px; }
                                            h2 { text-align: center; font-size: 18px; margin-bottom: 20px; }
                                            .receipt-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
                                            .receipt-item { margin: 10px 0; padding: 5px 0; border-bottom: 1px solid #ccc; }
                                            .receipt-item label { font-weight: bold; width: 150px; display: inline-block; }
                                            .receipt-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 16px; }
                                        </style>
                                    </head>
                                    <body>
                                        <h2>ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</h2>
                                        <div class="receipt-header">
                                            <div class="receipt-item"><label>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label> <span>${repName}</span></div>
                                            <div class="receipt-item"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label> <span>${new Date().toLocaleDateString('ar-EG')}</span></div>
                                        </div>
                                        <div class="receipt-item"><label>Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª:</label> <span>${credits}</span></div>
                                        <div class="receipt-item"><label>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</label> <span>${expenses}</span></div>
                                        <div class="receipt-item"><label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label> <span>${notes}</span></div>
                                        <div class="receipt-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª: ${total}</div>
                                    </body>
                                    </html>`;
                                const printWindow = window.open('', '', 'height=600,width=800');
                                printWindow.document.write(contentToPrint);
                                printWindow.document.close();
                                printWindow.print();
                            });
                        }
                        
                        // Save button for local receipt
                        const saveBtnLocal = document.getElementById('receipt-save-btn-local');
                        if (saveBtnLocal) {
                            saveBtnLocal.addEventListener('click', () => {
                                try {
                                    const repName = document.getElementById('receipt-rep-dropdown-local')?.value;
                                    const credits = document.getElementById('rep-credit-transactions-local')?.value;
                                    const expenses = document.getElementById('rep-expenses-local')?.value;
                                    const notes = document.getElementById('rep-notes-local')?.value;
                                    
                                    if (!repName) {
                                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹');
                                        return;
                                    }
                                    
                                    const receiptData = {
                                        repName,
                                        credits: parseFloat(credits) || 0,
                                        expenses: parseFloat(expenses) || 0,
                                        notes,
                                        timestamp: new Date().toISOString(),
                                        date: new Date().toISOString().split('T')[0]
                                    };
                                    
                                    localStorage.setItem(`rep_receipt_${repName}_${receiptData.date}`, JSON.stringify(receiptData));
                                    
                                    if (window.db && typeof db !== 'undefined') {
                                        db.collection('settings').doc('repReceipts').collection(receiptData.date).doc(repName).set(receiptData, { merge: true })
                                            .then(() => { alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­'); })
                                            .catch(e => console.warn('Failed to save to cloud', e));
                                    }
                                } catch(e) {
                                    console.error('Error saving receipt data', e);
                                    alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                                }
                            });
                        }
                        
                        // Render function for local receipt
                        window.renderCollectionReceiptLocal = function() {
                            try {
                                const tbody = document.getElementById('receipt-table-body-local');
                                if (!tbody) return;
                                tbody.innerHTML = '';
                                
                                const fromDate = document.getElementById('receipt-from-date-local')?.value;
                                const toDate = document.getElementById('receipt-to-date-local')?.value;
                                const selectedRep = document.getElementById('receipt-rep-dropdown-local')?.value;
                                
                                let receipts = [];
                                let totalAmount = 0;
                                let totalCount = 0;
                                
                                if (Array.isArray(state.sales)) {
                                    state.sales.forEach(sale => {
                                        const saleDate = (sale.date || sale.createdAt || '').split('T')[0];
                                        if (fromDate && saleDate < fromDate) return;
                                        if (toDate && saleDate > toDate) return;
                                        if (selectedRep && sale.repName !== selectedRep) return;
                                        
                                        const customer = (typeof findCustomer === 'function' ? findCustomer(sale.customerId) : null) || {};
                                        const customerName = customer.name || sale.customerName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                        
                                        if (sale.firstPayment && sale.firstPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber || '',
                                                customer: customerName,
                                                type: 'Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰',
                                                amount: sale.firstPayment,
                                                status: 'Ù…Ø³Ø¯Ø¯Ø©'
                                            });
                                            totalAmount += sale.firstPayment;
                                        }
                                        if (sale.secondPayment && sale.secondPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber || '',
                                                customer: customerName,
                                                type: 'Ø¯ÙØ¹Ø© Ø«Ø§Ù†ÙŠØ©',
                                                amount: sale.secondPayment,
                                                status: 'Ù…Ø³Ø¯Ø¯Ø©'
                                            });
                                            totalAmount += sale.secondPayment;
                                        }
                                    });
                                }
                                
                                receipts.sort((a, b) => new Date(a.date) - new Date(b.date));
                                
                                if (receipts.length === 0) {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = '<td colspan="6" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­ØµÙŠÙ„Ø§Øª</td>';
                                    tbody.appendChild(tr);
                                } else {
                                    receipts.forEach((receipt, idx) => {
                                        const tr = document.createElement('tr');
                                        tr.classList.add(idx % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                                        tr.innerHTML = `
                                            <td class="border p-2 text-right">${receipt.date}</td>
                                            <td class="border p-2 text-right">${receipt.invoiceNumber}</td>
                                            <td class="border p-2 text-right">${receipt.customer}</td>
                                            <td class="border p-2 text-right">${receipt.type}</td>
                                            <td class="border p-2 text-right font-semibold">${formatCurrency(receipt.amount)}</td>
                                            <td class="border p-2 text-right"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${receipt.status}</span></td>
                                        `;
                                        tbody.appendChild(tr);
                                    });
                                    totalCount = receipts.length;
                                }
                                
                                const totalEl = document.getElementById('receipt-total-local');
                                const countEl = document.getElementById('receipt-count-local');
                                const avgEl = document.getElementById('receipt-avg-local');
                                if (totalEl) totalEl.textContent = formatCurrency(totalAmount);
                                if (countEl) countEl.textContent = totalCount;
                                if (avgEl) avgEl.textContent = formatCurrency(totalCount > 0 ? totalAmount / totalCount : 0);
                                
                            } catch(e) { console.error('renderCollectionReceiptLocal error', e); }
                        }
                    });
                })();
            </script>

            <!-- Rep Debts Page removed per user request -->

            <!-- removed separate sub-pages; their markup is embedded as subviews inside stock-control -->

            <div id="page-stock-control" class="page">
                <style>
                    .inv-tab-btn { transition: all 0.3s ease; border-bottom: 2px solid transparent; cursor: pointer; }
                    .inv-tab-btn.active { background-color: #ebf8ff; color: #2563eb; border-bottom-color: #2563eb; }
                    .fade-in { animation: fadeIn 0.3s ease-in-out; }
                    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
                    
                    /* Item Card Modal */
                    #itemCardModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
                    .modal-content-inv { margin: 5% auto; background: white; border-radius: 12px; overflow: hidden; animation: slideDown 0.3s ease-out; max-width: 600px; }
                    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                </style>

                <div id="warehouse-section" class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 mb-8">
                    <!-- Header -->
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h2 class="text-xl font-bold text-gray-800">ğŸ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù† (Cloud Synced)</h2>
                        <div class="flex gap-2">
                            <button onclick="if(window.migrateInventoryToCloud) window.migrateInventoryToCloud()" class="bg-purple-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow hover:bg-purple-700">â˜ï¸ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            <button onclick="if(window.inventorySystem && window.inventorySystem.showAddItemModal) window.inventorySystem.showAddItemModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700">+ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200">
                        <div onclick="switchInvTab('finished')" id="btn-finished" class="inv-tab-btn active flex-1 py-3 text-center font-bold text-gray-600 hover:bg-gray-50">ğŸ“¦ Ù…Ù†ØªØ¬ ØªØ§Ù…</div>
                        <div onclick="switchInvTab('raw')" id="btn-raw" class="inv-tab-btn flex-1 py-3 text-center font-bold text-gray-600 hover:bg-gray-50">ğŸ¥› Ø®Ø§Ù…Ø§Øª</div>
                        <div onclick="switchInvTab('packing')" id="btn-packing" class="inv-tab-btn flex-1 py-3 text-center font-bold text-gray-600 hover:bg-gray-50">ğŸ¥¡ ØªØºÙ„ÙŠÙ</div>
                    </div>

                    <!-- Tables Container -->
                    <div class="p-4 min-h-[400px]">
                        <div id="tab-finished-content" class="fade-in">
                            <table class="w-full text-right border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-sm">
                                    <tr><th class="p-3">Ø§Ù„ØµÙ†Ù</th><th class="p-3">Ø§Ù„Ø±ØµÙŠØ¯</th><th class="p-3">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="p-3">Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr>
                                </thead>
                                <tbody id="table-finished" class="divide-y text-gray-700"></tbody>
                            </table>
                        </div>
                        <div id="tab-raw-content" class="hidden fade-in">
                            <table class="w-full text-right border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-sm">
                                    <tr><th class="p-3">Ø§Ù„ØµÙ†Ù</th><th class="p-3">Ø§Ù„Ø±ØµÙŠØ¯</th><th class="p-3">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="p-3">Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr>
                                </thead>
                                <tbody id="table-raw" class="divide-y text-gray-700"></tbody>
                            </table>
                        </div>
                        <div id="tab-packing-content" class="hidden fade-in">
                            <table class="w-full text-right border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-sm">
                                    <tr><th class="p-3">Ø§Ù„ØµÙ†Ù</th><th class="p-3">Ø§Ù„Ø±ØµÙŠØ¯</th><th class="p-3">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="p-3">Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr>
                                </thead>
                                <tbody id="table-packing" class="divide-y text-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Item Modal -->
                <div id="itemCardModal">
                    <div class="modal-content-inv w-11/12 md:w-1/2">
                        <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                            <h3 id="modal-title" class="text-lg font-bold">ØªÙØ§ØµÙŠÙ„</h3>
                            <button onclick="document.getElementById('itemCardModal').style.display='none'" class="text-2xl hover:text-red-400">&times;</button>
                        </div>
                        <div class="p-6 text-center">
                            <div class="mb-2 text-sm text-gray-500">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                            <h2 id="modal-stock" class="text-4xl font-bold text-blue-600 mb-4">0</h2>
                            <div class="mb-4 text-sm text-gray-500">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="modal-cost" class="font-bold text-gray-700">0</span> Ø¬.Ù…</div>
                            <div class="flex gap-2">
                                <button onclick="if(window.inventorySystem) window.inventorySystem.adjustStock('add')" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">Ø¥Ø¶Ø§ÙØ© (+)</button>
                                <button onclick="if(window.inventorySystem) window.inventorySystem.adjustStock('subtract')" class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700">ØµØ±Ù (-)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Item Modal -->
                <div id="addItemModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); overflow: auto;">
                    <div class="modal-content-inv w-11/12 md:w-1/2 mt-10">
                        <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                            <h3 class="text-lg font-bold">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>
                            <button onclick="document.getElementById('addItemModal').style.display='none'" class="text-2xl hover:text-red-400">&times;</button>
                        </div>
                        <div class="p-6 bg-white">
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
                                <input type="text" id="addItemName" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„ÙŠØ¨ Ù…Ø¬ÙÙ" class="w-full border border-gray-300 rounded-md p-2 text-right" dir="rtl">
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</label>
                                    <input type="number" id="addItemStock" value="0" class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
                                    <input type="number" id="addItemCost" value="0" step="0.01" class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                    <input type="text" id="addItemUnit" value="Ù‚Ø·Ø¹Ø©" class="w-full border border-gray-300 rounded-md p-2 text-right" dir="rtl">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ø§Ù„ÙØ¦Ø©</label>
                                    <select id="addItemCategory" class="w-full border border-gray-300 rounded-md p-2 text-right" dir="rtl">
                                        <option value="finished">ğŸ“¦ Ù…Ù†ØªØ¬ ØªØ§Ù…</option>
                                        <option value="raw">ğŸ¥› Ø®Ø§Ù…Ø§Øª</option>
                                        <option value="packing">ğŸ¥¡ ØªØºÙ„ÙŠÙ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="if(window.inventorySystem) window.inventorySystem.saveNewItem()" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 font-semibold">âœ… Ø­ÙØ¸</button>
                                <button onclick="document.getElementById('addItemModal').style.display='none'" class="flex-1 bg-gray-400 text-white py-2 rounded hover:bg-gray-500 font-semibold">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    function switchInvTab(tab) {
                        ['finished', 'raw', 'packing'].forEach(t => {
                            document.getElementById('btn-'+t).classList.remove('active', 'bg-blue-50', 'text-blue-600');
                            document.getElementById('tab-'+t+'-content').classList.add('hidden');
                        });
                        document.getElementById('btn-'+tab).classList.add('active', 'bg-blue-50', 'text-blue-600');
                        document.getElementById('tab-'+tab+'-content').classList.remove('hidden');
                        
                        // Load data when switching tabs
                        if (window.inventorySystem && window.inventorySystem.loadInventoryData) {
                            window.inventorySystem.loadInventoryData(tab);
                        }
                    }
                </script>
            </div>

            <!-- PAGE: PRODUCTION RUNS / Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª -->
            <div id="page-production" class="page" style="padding-bottom: 80px;">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="settings" class="w-6 h-6 text-green-600"></i>
                        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª (Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬)
                    </h3>
                    <button id="create-production-btn" onclick="window.openCreateProductionModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> ØªØ´ØºÙŠÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>

                <div class="p-4 rounded-lg bg-green-50 border border-green-200 text-sm leading-relaxed mb-6">
                    Ø¥Ù†Ø´Ø§Ø¡ ØªØ´ØºÙŠÙ„Ø§Øª Ø¥Ù†ØªØ§Ø¬ Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙØ§Øª. ÙƒÙ„ ØªØ´ØºÙŠÙ„Ø© ØªÙØªØ¨Ø¹ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø¡ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
                </div>

                <!-- Tabs for viewing productions -->
                <div class="flex gap-2 mb-4 border-b">
                    <button id="tab-active-productions" class="px-4 py-2 font-semibold text-green-600 border-b-2 border-green-600">Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</button>
                    <button id="tab-completed-productions" class="px-4 py-2 font-semibold text-gray-600 hover:text-gray-800">Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</button>
                </div>

                <!-- Active Productions Table -->
                <div id="active-productions-section" class="mb-6">
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø©</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø§Ù„ÙˆØµÙØ©</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="active-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="no-active-productions" class="text-center py-6 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ´ØºÙŠÙ„Ø§Øª Ø¬Ø§Ø±ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                </div>

                <!-- Completed Productions Table -->
                <div id="completed-productions-section" class="mb-6 hidden">
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø©</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="completed-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="no-completed-productions" class="text-center py-6 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ´ØºÙŠÙ„Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                </div>
            </div>

            <div id="page-total-bills" class="page">
                <div id="total-bills-content-wrapper">
                    <h2 class="text-xl font-bold mb-4">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>

                    <!-- Filter Controls -->
                    <div id="total-bills-filters" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label for="filter-from-date" class="block text-sm font-medium text-gray-700">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="filter-from-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-to-date" class="block text-sm font-medium text-gray-700">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="filter-to-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-customer-name" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <input type="text" id="filter-customer-name" placeholder="Ø¨Ø­Ø«..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-invoice-number" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                                <input type="number" id="filter-invoice-number" placeholder="Ø¨Ø­Ø«..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="flex flex-col gap-1">
                                <button id="reset-to-current-month-btn" class="bg-gray-500 text-white py-1 px-2 rounded-lg hover:bg-gray-600 text-sm">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                                <button id="apply-filters-btn" class="bg-blue-600 text-white py-1 px-2 rounded-lg hover:bg-blue-700">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
                            </div>
                        </div>
                    </div>

                    <!-- Total Display -->
                    <div id="total-bills-summary-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg mb-4 text-center shadow-md flex items-center justify-center gap-4">
                        <div>
                            <span class="font-semibold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©:</span>
                            <span id="total-bills-summary-amount" class="font-bold text-green-800">0 Ø¬.Ù…</span>
                        </div>
                        <div class="flex items-center border-r-2 border-green-300 pr-4">
                            <input type="checkbox" id="include-total-in-export" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                            <label for="include-total-in-export" class="mr-2 text-sm font-medium text-green-900">ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
                        </div>
                    </div>

                    <!-- Bills Table -->
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table id="total-bills-table" class="min-w-full divide-y divide-gray-200">
                                                                            <thead class="bg-gray-50">
                                                                                <tr>
                                                                                    <th class="p-4"><input type="checkbox" id="select-all-total-bills"></th>
                                                                                    <th data-sort="date" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>                                                            <th data-sort="invoiceNumber" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                            <th data-sort="customerName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                                            <th data-sort="repName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                                            <th data-sort="total" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                            <th data-sort="status" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                            <th data-sort="category" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„ØµÙ†Ù</th>
                                                        </tr>
                                                    </thead>                            <tbody id="total-bills-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be injected by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('total-bills-content-wrapper')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
                    <button onclick="generateReportImage('total-bills-content-wrapper')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> Ù†Ø³Ø® Ø§Ù„ÙƒÙ„ ÙƒØµÙˆØ±Ø©</button>
                </div>
                <div class="mt-2 p-3 border-t-2 border-dashed no-print">
                    <div class="flex gap-2">
                        <button onclick="exportSelectedRows('print')" class="w-1/2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                        <button onclick="exportSelectedRows('image')" class="w-1/2 bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙƒØµÙˆØ±Ø©</button>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="space-y-6">
                    <!-- Ø´Ø±ÙŠØ· ØªØ­ÙƒÙ… Ø³Ø±ÙŠØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                    <!-- Ø§Ù„Ø²Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ø¥ØµÙ„Ø§Ø­ Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ© ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡ ÙˆØ¬ÙØ¹Ù„ Ø§Ù„Ø¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
                    <div class="flex items-center justify-end gap-2 no-print">
                        <button id="open-user-management-btn" class="bg-purple-600 text-white px-3 py-2 rounded-md text-sm hover:bg-purple-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        </button>
                    </div>
                    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø± (Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·) -->
                    <div id="user-management-section" class="p-4 border rounded-lg bg-white hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                            <button id="refresh-users-btn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-gray-300">ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… (admin, rep, viewer). Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªÙØ­ÙØ¸ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Firestore.</p>
                        <div id="user-role-warning" class="p-2 mb-2 rounded border border-yellow-300 bg-yellow-50 text-yellow-800 hidden"></div>
                        <div class="mb-3 flex flex-wrap gap-2 items-center">
                            <button id="seed-missing-roles-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-plus"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M9 12h6"/><path d="M12 9v6"/></svg>
                                ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù†Ø§Ù‚ØµØ©
                            </button>
                            <span id="seed-roles-status" class="text-xs text-gray-600"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-right">Ø§Ù„Ø§Ø³Ù…</th>
                                        <th class="px-2 py-2 text-right">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                                        <th class="px-2 py-2 text-center">Ø§Ù„Ø¯ÙˆØ±</th>
                                        <th class="px-2 py-2 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="bg-white divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø´Ù‡Ø±: Ø§Ø®ØªÙŠØ§Ø± ÙØªØ±Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
                    <div>
                        <h3 class="text-lg font-bold mb-1">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</h3>
                        <p class="text-xs text-gray-500 mb-2">Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù„Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡. ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ø£ÙŠ Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚ Ù…Ù† Ù‡Ù†Ø§.</p>
                        <div class="flex items-center gap-2">
                            <input type="month" id="active-period-input" class="p-2 border rounded-md" />
                            <button id="active-period-today-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-300">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                            <span id="active-period-indicator" class="text-sm text-gray-600 ml-auto"></span>
                        </div>
                    </div>

                    <!-- ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (GPS) -->
                    <div id="gps-settings" class="p-4 border rounded-lg bg-white">
                        <h3 class="text-lg font-bold mb-2">ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (GPS)</h3>
                        <div class="flex items-center gap-2 mb-1">
                            <input type="checkbox" id="gps-share-toggle" class="w-4 h-4">
                            <label for="gps-share-toggle" class="text-sm">Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
                            <span id="gps-share-status" class="text-xs text-gray-600 ml-auto"></span>
                        </div>
                        <p class="text-xs text-gray-500">Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ØŒ Ø³ÙŠØ·Ù„Ø¨ Ø§Ù„Ù…ØªØµÙØ­ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¯ÙˆØ±ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.</p>
                        <div id="admin-gps-list" class="mt-3 hidden">
                            <h4 class="font-semibold mb-1">Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø§Ù„Ø¢Ù†</h4>
                            <div id="rep-locations-list" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                        <p class="text-xs text-gray-500 mb-2">Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø­Ø¯Ø¯ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª).</p>
                        <div class="flex items-center gap-2">
                            <input type="number" id="sales-target-input" class="w-full p-2 border rounded-md" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ">
                            <button id="save-target-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Ø­ÙØ¸</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold">Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©</h3>
                        <p class="text-xs text-gray-500 mb-2">Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (URL) Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ù…Ø­Ù„ÙŠ Ø¨ØµÙŠØºØ© file:///C:/... Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø£Ùˆ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ø³ØªØ¶Ø§ÙØ© Ø«Ù… ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§.</p>
                        <div class="flex items-center gap-2">
                            <input type="text" id="company-logo-input" class="w-full p-2 border rounded-md" placeholder="https://example.com/logo.jpg Ø£Ùˆ file:///C:/Users/.../logo.jpg">
                            <button id="save-company-logo-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ø­ÙØ¸</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Ù†ØµÙŠØ­Ø©: Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨ Ø¨Ø³Ø±Ø¹Ø© Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø§Øª Ù…Ø«Ù„ imgur.com Ø£Ùˆ GitHub (repo Ø£Ùˆ gist) Ø£Ùˆ Ø£ÙŠ Ø§Ø³ØªØ¶Ø§ÙØ© ØµÙˆØ± Ù„Ø¯ÙŠÙƒ.</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                            <button id="add-product-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
                        </div>
                        <input id="search-products" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." class="w-full p-2 border rounded-md mb-2">
                        <div id="products-list" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>
                    
                    <!-- Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ù…ÙØ±ØªØ¬Ø¹Ø© Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙƒÙ…Ø§ ÙƒØ§Ù†Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
                            <button id="add-price-list-btn" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø©</button>
                        </div>
                        <div id="price-lists-container" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-2">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</h3>
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-4">
                            <div>
                                <h4 class="font-semibold mb-2">1. Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Backup) </h4>
                                <p class="text-xs text-gray-600 mb-2">Ø§Ø¶ØºØ· Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (Ø¹Ù…Ù„Ø§Ø¡ØŒ ÙÙˆØ§ØªÙŠØ±ØŒ Ù…Ù†ØªØ¬Ø§ØªØŒ Ù…Ù†Ø§Ø¯ÙŠØ¨). Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ø­ØªÙØ¸ Ø¨Ù‡ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†.</p>
                                <button id="backup-data-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-2">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†</button>
                                <textarea id="backup-data-textarea" class="w-full p-2 border rounded-md bg-gray-200" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± ÙƒÙˆØ¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‡Ù†Ø§..."></textarea>
                                <button id="copy-backup-btn" class="w-full mt-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 hidden">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-2">2. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Restore)</h4>
                                <p class="text-xs text-gray-600 mb-2">Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù‡Ù†Ø§ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ. <strong class="text-red-600">ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</strong></p>
                                <textarea id="restore-data-textarea" class="w-full p-2 border rounded-md" style="height: 100px;" placeholder="Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‡Ù†Ø§..."></textarea>
                                <button id="restore-data-btn" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            </div>
                        </div>
                    </div>

                    <!-- Ø£Ø¯Ø§Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Firestore) - Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· -->
                    <div id="admin-cloud-import-section" class="p-4 border-2 border-yellow-300 rounded-lg bg-yellow-50 space-y-3 no-print hidden">
                        <h3 class="text-lg font-bold">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Firestore)</h3>
                        <p class="text-xs text-gray-700">Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© ØªØ±ÙØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ… (JSON Ø£Ùˆ TXT) Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¥Ù„Ù‰ Ø¬Ø¯Ø§ÙˆÙ„ Firestore (customers, products, priceLists, reps, sales...). ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø°ÙˆÙŠ ØµÙ„Ø§Ø­ÙŠØ© admin.</p>
                        <div class="flex items-center gap-2">
                            <input id="admin-import-file" type="file" accept=".json,.txt,application/json,text/plain" class="flex-1 p-2 border rounded-md bg-white" />
                            <button id="admin-start-import-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                        </div>
                        <div id="admin-import-status" class="text-sm text-gray-700"></div>
                    </div>
                </div>
            <!-- (Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¢Ù† Ù…ÙØ¯Ø§Ø±Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù†Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) -->
        </main>

        <!-- Reports Subnav (Moved functionality to Dashboard, kept hidden nav item for consistency) -->
        <nav id="reports-subnav" class="fixed left-0 right-0 mx-auto justify-around p-2 no-print">
            <button data-report-section="daily" class="reports-subnav-item active">
                <i data-lucide="calendar"></i><span>ÙŠÙˆÙ…ÙŠ</span>
            </button>
            <button data-report-section="range" class="reports-subnav-item">
                <i data-lucide="calendar-range"></i><span>ÙØªØ±Ø©</span>
            </button>
            <button data-report-section="monthly" class="reports-subnav-item">
                <i data-lucide="calendar"></i><span>Ø´Ù‡Ø±ÙŠ</span>
            </button>
            <button data-report-section="reconciliation" class="reports-subnav-item">
                <i data-lucide="scale"></i><span>Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</span>
            </button>
            <button data-report-section="targets" class="reports-subnav-item">
                <i data-lucide="target"></i><span>ØªØ§Ø±Ø¬Øª Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</span>
            </button>
            <button data-report-section="customer-targets" class="reports-subnav-item">
                <i data-lucide="users"></i><span>ØªØ§Ø±Ø¬Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
            </button>
        </nav>

        <!-- Costs Page: Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ (Ù…Ø¨Ø³Ø·Ø©) -->
            <div id="page-costs" class="page" style="display:none; padding-bottom: 80px;">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="flask-conical" class="w-6 h-6 text-blue-600"></i>
                        Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬
                    </h3>
                    <div class="flex items-center gap-2">
                    <button id="add-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                    </button>
                    <button id="save-and-produce-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1" style="display:none;">
                        <i data-lucide="check" class="w-4 h-4"></i> Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ ØªØ´ØºÙŠÙ„Ø©
                    </button>
                    <!-- Ø£Ø²Ù„Ù†Ø§ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø²Ø¯Ø­Ø§Ù…. Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø§Ø²Ø§Ù„ Ù…ØªØ§Ø­Ø§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© Ø¥Ù† Ù„Ø²Ù…. -->
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm leading-relaxed mb-6">
                    Ø£Ø¯Ø®Ù„ Ù…ÙƒÙˆÙ‘Ù†Ø§Øª (Ø®Ø§Ù…Ø§Øª)ØŒ Ù…ÙˆØ§Ø¯ ØªØ¹Ø¨Ø¦Ø©ØŒ ÙˆÙ…ØµØ§Ø±ÙŠÙ ØªØ´ØºÙŠÙ„ Ù„ÙƒÙ„ <span class="font-bold">Ø¯ÙØ¹Ø© Ø¥Ù†ØªØ§Ø¬</span>. ÙŠØ­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ÙˆØªÙƒÙ„ÙØ© Ø§Ù„ÙƒÙŠÙ„Ùˆ/Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.
                    Ù…Ø«Ø§Ù„: Ù…Ù†ØªØ¬ "Ø¬Ø¨Ù†Ø© Ù‚Ø±ÙŠØ´" ÙŠØ®Ø±Ø¬ 50 ÙƒØ¬Ù… ÙÙŠ Ø¯ÙØ¹Ø©Ø› ØªØ¶ÙŠÙ Ø§Ù„Ù„Ø¨Ù† (ÙƒÙ…ÙŠØ© ÙƒØ¬Ù… ÙˆØ³Ø¹Ø± Ù„Ù„ÙƒØ¬Ù…)ØŒ Ø§Ù„Ù…Ù†ÙØ­Ø©ØŒ Ø§Ù„Ù…Ù„Ø­ØŒ Ø«Ù… Ø§Ù„ØªØºÙ„ÙŠÙ (Ø£ÙƒÙŠØ§Ø³ØŒ ØµÙ†Ø§Ø¯ÙŠÙ‚)ØŒ Ø«Ù… Ù…ØµØ±ÙˆÙ Ø§Ù„ØªØ´ØºÙŠÙ„ (ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ø£Ø¬ÙˆØ±) Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©.
                </div>
                <!-- Price Manager (Raw, Pack, Ops) -->

                <!-- Unified Price Grid (Printable Overview) -->
                <details id="unified-price-grid-block" class="mb-6 bg-white rounded-lg border">
                    <summary class="cursor-pointer select-none px-4 py-3 flex items-center gap-2 text-sm font-semibold">
                        <i data-lucide="table" class="w-4 h-4 text-indigo-600"></i>
                        Ø´Ø¨ÙƒØ© Ù…ÙˆØ­Ø¯Ø© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                        <span id="unified-grid-summary" class="ml-auto text-gray-500 text-xs"></span>
                    </summary>
                    <div class="px-4 pb-4 pt-2 space-y-3">
                        <div class="flex flex-wrap gap-2 text-xs">
                            <button type="button" id="unified-refresh-btn" class="px-3 py-1 rounded bg-indigo-600 text-white">ØªØ­Ø¯ÙŠØ«</button>
                            <button type="button" id="unified-print-btn" class="px-3 py-1 rounded bg-gray-200 text-gray-800">Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button type="button" id="unified-export-json-btn" class="px-3 py-1 rounded bg-green-600 text-white">ØªØµØ¯ÙŠØ± JSON</button>
                            <button type="button" id="unified-export-csv-btn" class="px-3 py-1 rounded bg-emerald-500 text-white">ØªØµØ¯ÙŠØ± CSV</button>
                        </div>
                        <div class="overflow-x-auto border rounded">
                            <table id="unified-price-grid" class="min-w-full divide-y divide-gray-200 text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-right px-2 py-1">Ø§Ù„Ø§Ø³Ù…</th>
                                        <th class="text-center px-2 py-1">Ø§Ù„ÙƒÙˆØ¯</th>
                                        <th class="text-center px-2 py-1">Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th class="text-center px-2 py-1">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                        <th class="text-center px-2 py-1">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                        <th class="text-center px-2 py-1">Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯</th>
                                        <th class="text-center px-2 py-1">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="text-[11px] text-gray-500">Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨ Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØªÙƒÙ„ÙØ©. Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø£Ø³Ø¹Ø§Ø± ÙŠØªÙ… Ù…Ù† Ø®Ù„Ø§Ù„ Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡.</div>
                    </div>
                </details>
                <div id="recipes-list" class="space-y-6"></div>
            </div>

            <!-- Taxes Page -->
            <div id="page-taxes" class="page" style="display:none; padding-bottom:80px;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="percent" class="w-6 h-6 text-blue-600"></i>
                        <span>Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨</span>
                    </h2>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-medium">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</label>
                        <input id="tax-month-input" type="month" class="p-2 border rounded-md">
                        <button id="tax-refresh-btn" class="bg-blue-600 text-white px-3 py-2 rounded-md">Ø¹Ø±Ø¶</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex gap-2 mb-3">
                        <button id="tax-tab-report" class="px-3 py-2 bg-gray-100 rounded">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</button>
                        <button id="tax-tab-einvoices" class="px-3 py-2 bg-white rounded">Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
                    </div>

                    <div id="tax-tab-content">
                        <!-- Report Tab -->
                        <div id="tax-report-tab">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø®Ø§Ø¶Ø¹Ø©</div>
                                    <div id="tax-total-sales" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø®Ø§Ø±Ø¬Ø© (Output VAT)</div>
                                    <div id="tax-output-vat" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ø§Ø®Ù„Ø© (Input VAT)</div>
                                    <div id="tax-input-vat" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚</div>
                                    <div id="tax-net-payable" class="text-2xl font-bold">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- E-Invoice Log Tab -->
                        <div id="tax-einvoices-tab" style="display:none;">
                            <div class="overflow-x-auto mt-3">
                                <table class="w-full table-auto border-collapse">
                                    <thead>
                                        <tr class="text-sm text-gray-600">
                                            <th class="p-2 text-left">Invoice #</th>
                                            <th class="p-2 text-left">Date</th>
                                            <th class="p-2 text-left">Customer</th>
                                            <th class="p-2 text-right">Total</th>
                                            <th class="p-2 text-left">UUID</th>
                                            <th class="p-2 text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="einvoice-log-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Main Bottom Nav - Adjusted buttons after moving reports -->
        <nav id="main-nav-bar" class="bottom-nav fixed bottom-0 left-0 right-0 mx-auto bg-white border-t shadow-t p-2 flex justify-around no-print">
            <button data-page="dashboard" class="bottom-nav-item active flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                <span class="text-xs">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </button>
            <button data-page="spreadsheet-entry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-table"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                <span class="text-xs">Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹</span>
            </button>
            <!-- BUTTON FOR SALES PAGE (Search, view all invoices) -->
            <button data-page="sales" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6"/><path d="M16 12h-6"/><path d="M16 16h-6"/></svg>
                <span class="text-xs">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
            </button>
            <button data-page="dispatch" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>
                <span class="text-xs">Ø§Ù„Ø§Ø°ÙˆÙ†Ø§Øª</span>
            </button>
            <!-- REPORTS BUTTON RETAINED, NOW GOES TO DEDICATED REPORTS PAGE -->
            <button data-page="reports" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                <span class="text-xs">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
            </button>
            <!-- TAXES Button -->
            <button data-page="taxes" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><path d="M21 12A9 9 0 1 1 3 12 9 9 0 0 1 21 12z"/><path d="M9 9h.01"/><path d="M15 15h.01"/><path d="M7 17l10-10"/></svg>
                <span class="text-xs">Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨</span>
            </button>
            <!-- COSTS / Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Button -->
            <button id="costs-nav-btn" data-page="costs" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layers"><path d="M12 2 1 7l11 5 11-5L12 2z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                <span class="text-xs">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</span>
            </button>
            <!-- NEW: Production / Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª Button -->
            <button id="production-nav-btn" data-page="production" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.08 5.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08-5.08l4.24-4.24"/></svg>
                <span class="text-xs">Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª</span>
            </button>
            <button data-page="promotions" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
                <span class="text-xs">Ø§Ù„Ø¹Ø±ÙˆØ¶</span>
            </button>
            <button data-page="customers" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span class="text-xs">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
            </button>
            <button data-page="reps" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2"><path d="M14 19a6 6 0 0 0-12 0"/><circle cx="8" cy="9" r="4"/><path d="M22 19a6 6 0 0 0-6-6 4 4 0 1 0 0-8"/></svg>
                <span class="text-xs">Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</span>
            </button>
            <!-- NEW: Cash (Ø§Ù„ÙƒØ§Ø´) Button -->
            <button id="cash-nav-btn" data-page="cash" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                <span class="text-xs">Ø§Ù„ÙƒØ§Ø´</span>
            </button>

            <!-- NEW: Debts (Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª) Button -->
            <button id="debts-nav-btn" data-page="debts" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <!-- Using a simple wallet/credit icon similar to design -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M21 12v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h14"/><path d="M16 3v4"/><path d="M8 12h.01"/></svg>
                <span class="text-xs">Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</span>
            </button>
            <button data-page="stock-control" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                <span class="text-xs">Ø³ØªÙˆÙƒ ÙƒÙ†ØªØ±ÙˆÙ„</span>
            </button>
            <button data-page="total-bills" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                <span class="text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span>
            </button>
            <!-- NEW: Inquiry (Ø§Ø³ØªØ¹Ù„Ø§Ù…) Button -->
            <button data-page="inquiry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-xs">Ø§Ø³ØªØ¹Ù„Ø§Ù…</span>
            </button>
            <!-- NEW: Price Lists (Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±) Button -->
            <button data-page="price-lists" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-dollar-sign"><path d="M7 21h10"/><path d="M12 17v-6"/><path d="M9 14h6"/><path d="M12 9h.01"/><path d="M12 3 2 9l10 6 10-6Z"/></svg>
                <span class="text-xs">Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span>
            </button>
            <button data-page="settings" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                <span class="text-xs">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </button>
        </nav>
    </div>

    <!-- ########## MODALS ########## -->

    <!-- CUSTOM CONFIRMATION/ALERT DIALOG -->
    <div id="custom-confirm-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 id="dialog-title" class="text-xl font-bold mb-4">Ø¥Ø´Ø¹Ø§Ø±</h2>
            <p id="dialog-message" class="text-gray-700 mb-6"></p>
            <div id="dialog-actions" class="flex justify-end gap-3">
                <button id="dialog-cancel-btn" type="button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 hidden">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="dialog-confirm-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <!-- PRICE HISTORY MODAL -->
    <div id="price-history-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="ph-title" class="text-xl font-bold">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h2>
                <button id="ph-close-btn" type="button" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="text-center px-2 py-1">Ø§Ù„Ø³Ø¹Ø±</th>
                            <th class="text-center px-2 py-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="text-right px-2 py-1">Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="ph-body"></tbody>
                </table>
            </div>
            <div class="flex items-end gap-2">
                <div class="flex-1">
                    <label class="block text-xs text-gray-600 mb-1">Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯</label>
                    <input id="ph-new-price" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="0.00" />
                </div>
                <div class="flex-[2]">
                    <label class="block text-xs text-gray-600 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="ph-new-note" class="w-full p-2 border rounded" placeholder="Ù…ÙˆØ±Ø¯/ØªÙØ§ØµÙŠÙ„" />
                </div>
                <button id="ph-add-btn" class="bg-blue-600 text-white px-3 py-2 rounded h-[42px]">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
    </div>
    
    <!-- LOADING MODAL -->
    <div id="loading-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4">
            <div class="loader"></div>
            <p id="loading-message" class="text-lg font-semibold text-gray-700">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 class="text-xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form id="login-modal-form">
                <div class="mb-4">
                    <label for="login-email-modal" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="login-email-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="login-password-modal" class="block text-sm font-medium text-gray-700">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="relative">
                        <input type="password" id="login-password-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md pr-10" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password-modal" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">ğŸ‘ï¸</button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <!-- DEBTS SUMMARY MODAL (Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª) -->
    <div id="debts-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right" style="display:none !important">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</h2>
                <button type="button" onclick="closeModal(document.getElementById('debts-summary-modal'))" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>

            <div id="debts-summary-content" class="space-y-4">
                <div>
                    <h3 class="font-bold">Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-customer" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th class="text-center px-2 py-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                    <th class="text-center px-2 py-1">Ø§Ù„Ù…Ø³Ø¯Ø¯</th>
                                    <th class="text-center px-2 py-1">Ø§Ù„Ù…ØªØ¨Ù‚Ù‰</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
    
                    <!-- MANAGE LISTS MODAL -->
                    <div id="manage-lists-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</h2>
                                <button type="button" onclick="closeManageListsModal()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
                            </div>

                            <!-- progress area: updated while chunked rendering proceeds -->
                            <div id="manage-lists-progress" class="mb-3 text-sm text-gray-600" style="display:none">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±...</div>

                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-bold">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù…Ø©</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-finished-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">Ø§Ù„Ø§Ø³Ù…</th><th class="text-center px-2 py-1">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="text-center px-2 py-1">Ø³Ø¹Ø±</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">Ø§Ù„Ø®Ø§Ù…Ø§Øª (Ù…ÙˆØ§Ø¯ Ø¥Ù†ØªØ§Ø¬)</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-raw-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">Ø§Ù„Ø§Ø³Ù…</th><th class="text-center px-2 py-1">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="text-center px-2 py-1">ØªÙƒÙ„ÙØ©</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">Ø§Ù„ØªØºÙ„ÙŠÙ/Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-pack-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">Ø§Ù„Ø§Ø³Ù…</th><th class="text-center px-2 py-1">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="text-center px-2 py-1">ØªÙƒÙ„ÙØ©</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="pt-3 border-t flex justify-between items-center">
                                    <div class="text-sm text-gray-600">ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£ÙŠ Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø£Ùˆ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„Ø¹ÙˆØ¯Ø©.</div>
                                    <div>
                                        <button id="manage-export-btn" class="bg-green-600 text-white px-3 py-1 rounded">ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <div>
                    <h3 class="font-bold">Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-rep" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                    <th class="text-center px-2 py-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                    <th class="text-center px-2 py-1">Ø§Ù„Ù…Ø³Ø¯Ø¯</th>
                                    <th class="text-center px-2 py-1">Ø§Ù„Ù…ØªØ¨Ù‚Ù‰</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="pt-3 border-t">
                    <div class="flex justify-between items-center">
                        <div class="font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)</div>
                        <div id="debts-summary-total" class="font-extrabold text-lg">0 Ø¬.Ù…</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW FULL-SCREEN SALE MODAL (for detailed single entry) -->
    <div id="sale-modal" class="modal modal-hidden fixed inset-0 bg-gray-100 z-30 flex flex-col">
        <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center no-print">
            <h2 id="sale-modal-title" class="text-xl font-bold">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</h2>
            <button id="cancel-sale-btn" class="p-2 hover:bg-blue-700 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        </header>

        <main class="flex-grow p-4 overflow-y-auto">
            <form id="sale-form">
                <input type="hidden" id="sale-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="sale-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
                        <select id="sale-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        <input type="text" id="sale-rep-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
                    </div>
                    <div>
                        <label for="sale-customer" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <select id="sale-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        <input type="text" id="sale-customer-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
                    </div>
                    <div>
                        <label for="sale-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                        <input type="date" id="sale-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="sale-invoice-number" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ÙŠØ¯ÙˆÙŠ)</label>
                        <input type="number" id="sale-invoice-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¯ÙØªØ±">
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="sale-items-table min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase w-2/5">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="sale-items-container" class="bg-white divide-y divide-gray-200">
                            <!-- Sale item rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-sale-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¢Ø®Ø±
                </button>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="sale-notes" class="block text-sm font-medium text-gray-700">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea id="sale-notes" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="sale-status" class="block text-sm font-medium text-gray-700">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                                <select id="sale-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="paid">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
                                    <option value="due">Ø¢Ø¬Ù„</option>
                                    <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                                </select>
                            </div>
                            <div id="paid-amount-container" class="hidden">
                                <label for="sale-paid-amount" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                                <input type="number" id="sale-paid-amount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            </div>
                        </div>
                        <div>
                            <label for="sale-discount" class="block text-sm font-medium text-gray-700">Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (%)</label>
                            <input type="number" id="sale-discount" placeholder="Ù…Ø«Ø§Ù„: 2 Ø£Ùˆ 3.5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                        </div>
                        <div>
                            <label for="sale-addition" class="block text-sm font-medium text-gray-700">Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (%)</label>
                            <input type="number" id="sale-addition" placeholder="Ù…Ø«Ø§Ù„: 14" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            <p class="text-xs text-gray-500 mt-1">ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡Ø§ ÙƒØ²ÙŠØ§Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…).</p>
                        </div>
                    </div>
                </div>
            </form>
        </main>

        <footer class="p-4 bg-white border-t no-print">
            <div id="sale-summary" class="max-w-md ml-auto text-lg space-y-2">
                <div class="flex justify-between"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ:</span><span id="sale-subtotal-text">0 Ø¬.Ù…</span></div>
                <div class="flex justify-between text-red-600"><span>Ø§Ù„Ø®ØµÙ…:</span><span id="sale-discount-text">0 Ø¬.Ù…</span></div>
                <div class="flex justify-between"><span>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (VAT):</span><span id="sale-vat-text">0 Ø¬.Ù…</span></div>
                <div class="flex justify-between"><span>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ (1% Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¬Ù‡Ø© Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø¶Ø±ÙŠØ¨Ø©):</span><span id="sale-withholding-text">0 Ø¬.Ù…</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold text-2xl"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ ÙˆØ§Ù„Ø§Ù‚ØªØ·Ø§Ø¹Ø§Øª:</span><span id="sale-final-text">0 Ø¬.Ù…</span></div>
                <div class="flex justify-between font-bold text-2xl"><span style="opacity:0.75">Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¹Ø±Ø¶ Ù‚Ø¯ÙŠÙ…)</span><span id="sale-total-text" style="opacity:0.6">0 Ø¬.Ù…</span></div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="eta-upload-from-modal-btn" class="hidden bg-purple-700 text-white px-6 py-3 rounded-lg hover:bg-purple-800 font-bold text-lg flex items-center gap-2">
                    <i data-lucide="cloud-upload" class="w-5 h-5"></i>
                    Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¶Ø±Ø§Ø¦Ø¨
                </button>
                <button type="submit" form="sale-form" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg">Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            </div>
        </footer>
    </div>
    
    <!-- CUSTOMER MODAL -->
    <div id="customer-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="customer-modal-title" class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="mb-4">
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input type="text" id="customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <!-- NEW: Tax Number Input -->
                <div class="mb-4">
                    <label for="customer-tax-number" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
                    <input type="text" id="customer-tax-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ">
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-phone" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="customer-address" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„)</label>
                    <input type="text" id="customer-address" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„ Ù‡Ù†Ø§..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <!-- NEW: Requires Tax Filing Checkbox -->
                <div class="mb-4 flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <input type="checkbox" id="customer-requires-tax" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 ml-2">
                    <label for="customer-requires-tax" class="block text-sm font-medium text-orange-800">Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØªØ·Ù„Ø¨ Ø±ÙØ¹ ÙÙˆØ§ØªÙŠØ±Ù‡ Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨</label>
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-price-list" class="block text-sm font-medium text-gray-700">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</label>
                    <select id="customer-price-list" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="mb-4">
                    <label for="customer-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                    <select id="customer-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-customer-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PLACEHOLDER MODALS -->
    <div id="rep-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="rep-modal-title" class="text-xl font-bold mb-4">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†Ø¯ÙˆØ¨</h2>
            <form id="rep-form">
                <input type="hidden" id="rep-id">
                <div class="mb-4"><label for="rep-name" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label><input type="text" id="rep-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="rep-email" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</label><input type="email" id="rep-email" class="mt-1 block w-full p-2 border rounded-md" placeholder="example@email.com" required></div>
                <div class="mb-4"><label for="rep-serial" class="block text-sm font-medium text-gray-700">ÙƒÙˆØ¯/Ø³ÙŠØ±ÙŠØ§Ù„</label><input type="text" id="rep-serial" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="mb-4"><label for="rep-target" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ</label><input type="number" id="rep-target" class="mt-1 block w-full p-2 border rounded-md" value="0"></div>
                <div class="mb-4"><label for="rep-next-invoice" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label><input type="number" id="rep-next-invoice" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-rep-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</button></div>
            </form>
        </div>
    </div>

    <div id="product-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="product-modal-title" class="text-xl font-bold mb-4">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="mb-4"><label for="product-code" class="block text-sm font-medium text-gray-700">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="product-code" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="product-name" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="product-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="product-price" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label><input type="number" id="product-price" class="mt-1 block w-full p-2 border rounded-md" step="any" required></div>
                <div class="mb-4"><label for="product-category" class="block text-sm font-medium text-gray-700">Ø§Ù„ÙØ¦Ø© (Ù„Ù„ØªØµÙÙŠØ©)</label><input type="text" id="product-category" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="mb-4"><label for="product-vat-rate" class="block text-sm font-medium text-gray-700">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© (%)</label><input type="number" id="product-vat-rate" class="mt-1 block w-full p-2 border rounded-md" step="0.01" value="0"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-product-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button></div>
            </form>
        </div>
    </div>
    
    <div id="price-list-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-4 modal-body">
            <h2 id="price-list-modal-title" class="text-xl font-bold mb-2">Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±</h2>
            <!-- Quick discount box (editable) -->
            <div class="flex items-center justify-start gap-3 mb-3">
                <label for="price-list-discount" class="text-sm text-gray-700">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø³Ø±ÙŠØ¹</label>
                <input id="price-list-discount" type="text" value="5%" class="w-16 p-1 border rounded text-center font-bold bg-white" title="Ø§ÙƒØªØ¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ù…Ø«Ù„ 5% Ø£Ùˆ 10%" />
                <span class="text-xs text-gray-500">(Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø®ÙŠØ±)</span>
            </div>
            <form id="price-list-form">
                <input type="hidden" id="price-list-id">
                <div class="mb-4"><label for="price-list-name" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</label><input type="text" id="price-list-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <!-- Replaced products list with an Excel-like table view (keeps same id to preserve JS bindings) -->
                <div id="price-list-products" class="overflow-x-auto max-h-[60vh] border rounded-lg bg-white">
                    <table id="price-list-products-table" class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-right">Ù…</th>
                                <th class="px-3 py-2 text-center">Ø§Ù„ÙƒÙˆØ¯</th>
                                <th class="px-3 py-2 text-right">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                                <th class="px-3 py-2 text-center">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th class="px-3 py-2 text-center">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                                <th class="px-3 py-2 text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th class="px-3 py-2 text-center">Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th>
                            </tr>
                        </thead>
                        <tbody id="price-list-products-body" class="bg-white">
                            <tr>
                                <td colspan="7" class="text-center text-gray-500 p-6">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-price-list-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button></div>
            </form>
        </div>
    </div>

    <!-- NEW PROMOTION MODAL -->
    <div id="promotion-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="promotion-modal-title" class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</h2>
            <form id="promotion-form">
                <input type="hidden" id="promotion-id">
                <div class="mb-4">
                    <label for="promotion-name" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</label>
                    <input type="text" id="promotion-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="promotion-product" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <select id="promotion-product" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                </div>
                <div id="original-price-display" class="mb-2 text-sm text-gray-600 hidden">
                    Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ù†ØªØ¬: <span id="current-product-price" class="font-bold"></span>
                </div>
                 <div class="mb-4">
                    <label for="promotion-price" class="block text-sm font-medium text-gray-700">Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶</label>
                    <input type="number" id="promotion-price" class="mt-1 block w-full p-2 border border-red-400 bg-red-50 rounded-md font-bold" required step="any" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ÙØ¶">
                </div>
                <div class="mb-4">
                    <label for="promotion-customer-id" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <select id="promotion-customer-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    <p class="text-xs text-gray-500 mt-1">Ø¥Ø°Ø§ Ù„Ù… ØªØ®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ØŒ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ **Ø¬Ù…ÙŠØ¹** Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="promotion-start-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                        <input type="date" id="promotion-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="promotion-end-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                        <input type="date" id="promotion-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-promotion-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END PROMOTION MODAL -->

    <!-- NOTIFICATION (Ø§Ø®Ø·Ø§Ø±) MODAL -->
    <div id="notify-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="notify-modal-title" class="text-xl font-bold">Ø§Ø®Ø·Ø§Ø±</h2>
                <button type="button" onclick="closeNotifyModal()" class="p-2 hover:bg-gray-100 rounded-md">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <form id="notify-form">
                <input type="hidden" id="notify-type" value="">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-sm font-medium">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø®Ø·Ø§Ø± (ÙƒÙ„Ù…ØªÙŠÙ†)</label>
                        <input id="notify-title" type="text" maxlength="40" placeholder="Ù…Ø«Ø§Ù„: ØªØºÙŠÙŠØ± Ø³Ø¹Ø±" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="text-sm font-medium">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select id="notify-type-select" class="mt-1 block w-full p-2 border rounded-md">
                            <option value="prices">ØªØºÙŠÙŠØ± Ø³Ø¹Ø±</option>
                            <option value="new-item">ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</option>
                            <option value="promotions">Ø¹Ø±Ø¶</option>
                        </select>
                    </div>
                </div>

                <div id="notify-product-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">Ø§Ø®ØªØ± ØµÙ†Ù</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-product"></select>
                </div>

                <div id="notify-promo-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">Ø§Ø®ØªØ± Ø¹Ø±Ø¶</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-promo"></select>
                </div>

                <div id="notify-new-item-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                    <input type="text" id="notify-new-item-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± (ØµÙÙˆÙ Ù…Ø«Ù„ Excel)</label>
                    <div class="mt-2 mb-2 grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-500">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <select id="notify-customer" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Ø®ØµÙ… Ø¹Ø§Ù… % (ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ)</label>
                            <input id="notify-global-discount" type="number" min="0" max="100" step="0.01" placeholder="0" class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <div class="mt-2 mb-2 flex gap-2">
                        <button type="button" id="notify-add-row-btn" class="bg-gray-100 px-3 py-1 rounded-md">Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
                        <button type="button" id="notify-paste-btn" class="bg-gray-100 px-3 py-1 rounded-md">Ù„ØµÙ‚ Ù…Ù† Excel</button>
                    </div>
                    <div class="overflow-x-auto border rounded">
                        <table class="min-w-full text-sm" id="notify-rows-table">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-right">ÙƒÙˆØ¯</th>
                                <th class="px-2 py-2 text-right">ØµÙ†Ù</th>
                                <th class="px-2 py-2 text-center">Ø³Ø¹Ø±</th>
                                <th class="px-2 py-2 text-center">Ø®ØµÙ… %</th>
                                <th class="px-2 py-2 text-center">Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th>
                                <th class="px-2 py-2"></th>
                            </tr></thead>
                            <tbody id="notify-rows-body"><tr><td colspan="6" class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ Ø¨Ø¹Ø¯.</td></tr></tbody>
                        </table>
                    </div>
                    <textarea id="notify-paste-area" placeholder="Ø§Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Excel Ù‡Ù†Ø§ (ÙƒÙˆØ¯\tØ§Ø³Ù…\tØ³Ø¹Ø±\tØ®ØµÙ…%)" class="w-full mt-2 p-2 border rounded-md" style="display:none;min-height:80px"></textarea>
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">Ù†Øµ Ù…ÙˆØ¬Ø² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="notify-short-text" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ø³Ø·Ø± Ù‚ØµÙŠØ± ÙŠØ¸Ù‡Ø± Ù…Ø¹ Ø§Ù„Ø¥Ø®Ø·Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„">
                </div>
                <div class="mb-3">
                    <label class="text-sm font-medium">Ø±Ø§Ø¨Ø· Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="notify-logo-url" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="https://example.com/logo.png - Ø³ÙŠØ¶Ø§Ù ÙƒØ±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©">
                    <p class="text-xs text-gray-500 mt-1">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© ÙØ¹Ù„ÙŠØ§Ù‹ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ØªØ­ØªØ§Ø¬ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ URL Ù…ØªØ§Ø­ Ø«Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…ÙŠØ¯ÙŠØ§. Ù‡Ù†Ø§ Ø³Ù†Ø¶ÙŠÙ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ.</p>
                </div>

                <div class="flex justify-between items-center gap-2">
                    <div class="flex gap-2">
                        <button type="button" id="notify-share-wa-btn" class="bg-green-600 text-white px-4 py-2 rounded-md">Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button type="button" onclick="closeNotifyModal()" class="bg-gray-300 px-4 py-2 rounded-md">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                    <div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Ø­ÙØ¸ Ø§Ù„Ø¥Ø®Ø·Ø§Ø±</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Safety: force a debts render and make rows visible when the page finishes loading.
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setTimeout(() => {
                    try {
                        if (typeof renderDebts === 'function') {
                            try { renderDebts(); } catch (e) { console.warn('renderDebts call failed', e); }
                        }
                        const tbody = document.getElementById('debts-detail-body');
                        if (tbody) {
                            Array.from(tbody.children).forEach(tr => {
                                try {
                                    tr.style.display = 'table-row';
                                    tr.style.visibility = 'visible';
                                    tr.style.opacity = '1';
                                    Array.from(tr.children).forEach(td => {
                                        td.style.display = 'table-cell';
                                        td.style.color = '#111';
                                        td.style.opacity = '1';
                                        td.style.visibility = 'visible';
                                        td.style.fontSize = '14px';
                                    });
                                } catch (e) {}
                            });
                            console.log('Force-styled debts rows, count=', tbody.children.length);
                        }
                    } catch (e) { console.warn('Debts force-render failed', e); }
                }, 150);
            } catch (e) { console.warn('Debts DOMContentLoaded handler failed', e); }
        });
    </script>

    <!-- Modals for Reports/Dispatch/Statements (Keeping placeholders for compatibility) -->
    <div id="statement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4"></div>
    <div id="date-range-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        	<!-- Date Range Form / Statement Customer List -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-xl font-bold mb-4">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙŠØ¯ÙˆÙŠ</h2>
            <form id="date-range-form">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                        <input type="date" id="start-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                        <input type="date" id="end-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ØªØµÙÙŠØ© Ø­Ø³Ø¨ ØµÙ†Ù:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center"><input type="radio" name="product-category" value="all" checked class="text-blue-600 focus:ring-blue-500 ml-1"> Ø§Ù„ÙƒÙ„</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="dairy" class="text-blue-600 focus:ring-blue-500 ml-1"> Ø£Ù„Ø¨Ø§Ù†</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="multi" class="text-blue-600 focus:ring-blue-500 ml-1"> Ù…Ø§Ù„ØªÙŠ</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="supermarket-chain-filter" class="block text-sm font-medium text-gray-700">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ù„Ø³Ù„Ø©</label>
                    <select id="supermarket-chain-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                        <option value="exception">Ø§ÙƒØ³Ø¨Ø´Ù† Ù…Ø§Ø±ÙƒØª</option>
                        <option value="awladragab">Ø§ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨</option>
                        <option value="samysalama">Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ù‡</option>
                        <option value="gomlamarket">Ø¬Ù…Ù„Ø© Ù…Ø§Ø±ÙƒØª</option>
                        <option value="dreams">Ø¯Ø±ÙŠÙ…Ø²</option>
                    </select>
                </div>
                <h3 class="text-lg font-bold mb-3 border-t pt-4">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†:</h3>
                <input type="text" id="statement-customer-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." class="w-full p-2 border rounded-md mb-3">
                <div id="statement-customer-list" class="space-y-1 max-h-48 overflow-y-auto border p-2 rounded-md bg-gray-50">
                    <!-- Customers will be injected here -->
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-date-range-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                </div>
            </form>
        </div>
    </div>
    <div id="dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <h2 id="dispatch-modal-title" class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø¶Ø§Ø¹Ø©</h2>
            <form id="dispatch-note-form">
                <input type="hidden" id="dispatch-note-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="dispatch-rep" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
                        <select id="dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="dispatch-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø°Ù†</label>
                        <input type="date" id="dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>

                <div class="overflow-x-auto bg-gray-50 rounded-lg shadow mt-4 border">
                    <table id="dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø³ØªÙ„Ù… (ÙƒÙ…ÙŠØ©)</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø±ØªØ¬Ø¹ Ø³Ù„ÙŠÙ…</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø±ØªØ¬Ø¹ ØªØ§Ù„Ù</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø¬Ø§Ù†ÙŠ</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="dispatch-items-container" class="divide-y divide-gray-200">
                            <!-- Dispatch item rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-dispatch-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¢Ø®Ø± Ù„Ù„Ø¥Ø°Ù†
                </button>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-dispatch-note-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ù†</button>
                </div>
            </form>
        </div>
    </div>
    <div id="view-dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Content injected dynamically -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <div id="dispatch-note-view-content">
                <!-- Report details will be injected here -->
            </div>
            <div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
                <button id="close-view-dispatch-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
                <button id="print-dispatch-btn" onclick="printSection('dispatch-note-view-content')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                    <span>Ø·Ø¨Ø§Ø¹Ø© (Ctrl+P)</span>
                </button>
            </div>
        </div>
    </div>
    <div id="settlement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Adding main content div inside modal placeholder for consistency -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6">
            <h2 id="settlement-modal-title" class="text-xl font-bold mb-4">ØªØ³ÙˆÙŠØ© Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø¥Ø°Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h2>
            <div id="settlement-content">
                <!-- Settlement report will be generated here -->
                <p class="text-center text-gray-500 mt-2">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ©...</p>
            </div>
            <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('settlement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
    <div id="reconciliation-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"></div>
    <div id="rep-sales-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body">
             <h2 id="rep-sales-summary-title" class="text-xl font-bold mb-4">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h2>
             <div id="rep-sales-summary-content">
                 <!-- Rep Statement content injected dynamically -->
             </div>
             <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('rep-sales-summary-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
    <div id="daily-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="customer-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="ai-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>

    <!-- NEW: Image Preview Modal -->
    <div id="image-preview-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <h2 class="text-xl font-bold mb-4">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©</h2>
            <p class="text-sm text-gray-600 mb-4">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù†Ø³Ø® Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù† (Ø£Ùˆ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„) ÙˆØ§Ø®ØªÙŠØ§Ø± "Ù†Ø³Ø® Ø§Ù„ØµÙˆØ±Ø©"ØŒ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
            <div id="image-preview-container" class="mb-4 border p-2 bg-gray-100 max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal(document.getElementById('image-preview-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
                <button id="download-image-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
            </div>
        </div>
    </div>


    <!-- Removed duplicate Firebase SDK (9.6.10) to avoid double init -->

    <script>
        // ===== Role-based page guard =====
        const ROLE_PAGE_ALLOW = {
            admin: 'ALL',
            // Allow reviewers and managers to view all pages (they remain read-only by DB/UI guards)
            reviewer: 'ALL',
            manager: 'ALL',
            // ØªÙ… ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©: Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹ØŒ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØŒ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…ØŒ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
            rep: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch']),
            user: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch'])
        };
        let lastRequestedPage = null; // Ù„ØªØªØ¨Ø¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØªØ­Ù‡Ø§ ÙØ¹Ù„ÙŠØ§Ù‹
        function canAccessPage(pageName){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // Ø§Ù„Ø³Ù…Ø§Ø­ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¶ÙŠÙ (Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) Ø¨ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ù…Ø²Ø¹Ø¬Ø©
                if (role === 'guest') {
                    return pageName === 'dashboard';
                }
                if (role === 'admin') return true;
                const set = ROLE_PAGE_ALLOW[role];
                if (!set) return false;
                if (set === 'ALL') return true;
                return set.has(pageName);
            } catch(_) { return false; }
        }

        // Global observer: prevent unauthorized page activation even if toggled elsewhere
        (function(){
            try {
                const obs = new MutationObserver((mutations)=>{
                    try {
                        const actives = Array.from(document.querySelectorAll('.page.active'));
                        actives.forEach(el => {
                            const id = el.id || '';
                            const page = id.startsWith('page-') ? id.slice(5) : null;
                            if (!page) return;
                            if (!canAccessPage(page)) {
                                el.classList.remove('active');
                                el.style.display = 'none';
                                // Ù„Ø§ Ù†Ø¸Ù‡Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ù…Ù† Ø·Ù„Ø¨ Ø§Ù„ØµÙØ­Ø©
                                if (lastRequestedPage === page) {
                                    try { customDialog({ title:'ØºÙŠØ± Ù…ØµØ±Ø­', message:'ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ù„Ø§ ØªØ³Ù…Ø­ Ø¨ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.' }); } catch(_) { alert('ØºÙŠØ± Ù…ØµØ±Ø­'); }
                                }
                                try { navigateTo('dashboard'); } catch(_) { }
                            }
                        });
                    } catch(e){}
                });
                obs.observe(document.documentElement, { subtree:true, attributes:true, attributeFilter:['class','style'] });
            } catch(e){}
        })();

        // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª (ØªÙÙˆÙŠØ¶ ÙƒØ§Ù…Ù„ Ø¥Ù„Ù‰ navigateTo)
        function switchPage(pageName) {
            try { lastRequestedPage = pageName; } catch(_){}
            if (typeof navigateTo === 'function') { navigateTo(pageName); return; }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ù…Ø­Ø¯Ø¯Ø© (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† onclick)
        function navigateToPage(pageName) {
            switchPage(pageName);
        }

        // Ø±Ø¨Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¨ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ†Ù‚Ù„
        document.addEventListener('DOMContentLoaded', function() {
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù„ÙƒÙ„ Ø²Ø± ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pageName = this.getAttribute('data-page');
                    if (pageName) {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                        if (pageName === 'sales' || pageName === 'reports' || pageName === 'debts') {
                            try { ensureDefaultActivePeriod(); } catch(e){}
                        }
                        switchPage(pageName);
                    }
                });
            });
            // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„ÙƒÙ† Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙ†Ù‚Ù„ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ switchPage
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø¨Ø§Ùƒ Ø§Ù„Ø¨ØµØ±ÙŠ
            setTimeout(()=>{
                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role && role !== 'admin' && ROLE_PAGE_ALLOW[role] && ROLE_PAGE_ALLOW[role] !== 'ALL') {
                        const allowed = ROLE_PAGE_ALLOW[role];
                        document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                            const pg = btn.getAttribute('data-page');
                            if (pg && !allowed.has(pg)) {
                                btn.style.display = 'none';
                            }
                        });
                    }
                } catch(e){}
            }, 400);
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
            switchPage('dashboard');

            // Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¨Ø¹Ø¯ ØªÙØ­ÙØ¯ÙÙ‘Ø« Ø§Ù„Ø¯ÙˆØ± (Ù…Ù† guest Ø¥Ù„Ù‰ Ø¯ÙˆØ± ÙØ¹Ù„ÙŠ) Ø£ÙˆÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
            let roleCheckCount = 0;
            const roleCheckInterval = setInterval(()=>{
                roleCheckCount++;
                const currentRole = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (currentRole && currentRole !== 'guest') {
                    try {
                        if (currentRole !== 'admin' && ROLE_PAGE_ALLOW[currentRole] && ROLE_PAGE_ALLOW[currentRole] !== 'ALL') {
                            const allowed = ROLE_PAGE_ALLOW[currentRole];
                            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                                const pg = btn.getAttribute('data-page');
                                if (pg && !allowed.has(pg)) btn.style.display = 'none';
                            });
                        }
                    } catch(e){}
                    clearInterval(roleCheckInterval);
                } else if (roleCheckCount > 120) { // ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ø¯Ù‚ÙŠÙ‚ØªØ§Ù† (120 * 1Ø«)
                    clearInterval(roleCheckInterval);
                }
            }, 1000);
        });

        // Ø£Ù„ØºÙŠÙ†Ø§ Ø§Ù„ØªÙˆÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠÙØ±Ø¶ Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø£Ø³Ù„ÙˆØ¨ inline
        // Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ navigateTo + CSS (.page/.active) ÙÙ‚Ø·
    </script>


    <!-- Lucide Icons - Direct CDN Link -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        // debug: avoid blocking alerts during load
        console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯');

        let observer;

        const initIcons = () => {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                // Disconnect the observer before making changes to the DOM to prevent infinite loops.
                if (observer) {
                    observer.disconnect();
                }

                window.lucide.createIcons();

                // Reconnect the observer after changes are made.
                if (observer) {
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                    });
                }
            }
        };

        // Create an observer instance to watch for dynamically added icons.
        observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    // Check if any added nodes need icons.
                    const hasLucideIcons = Array.from(mutation.addedNodes).some(
                        (node) =>
                            node.nodeType === Node.ELEMENT_NODE &&
                            (node.hasAttribute('data-lucide') || node.querySelector('[data-lucide]'))
                    );
                    if (hasLucideIcons) {
                        initIcons();
                        // Once icons are initialized for this batch of mutations, we can stop.
                        break;
                    }
                }
            }
        });

        // Initial icon creation and start of observation.
        document.addEventListener('DOMContentLoaded', () => {
            initIcons();
            observer.observe(document.body, {
                childList: true,
                subtree: true,
            });
        });

        // A fallback for any icons that might have been missed.
        window.addEventListener('load', initIcons);
        // Ø²Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù†Ø§Ù‚ØµØ© (Ø¥Ø¯Ø§Ø±ÙŠ ÙÙ‚Ø·)
        document.addEventListener('click', function(e){
            const btn = e.target.closest('#seed-missing-roles-btn');
            if (!btn) return;
            try {
                const role = (typeof getUserRole==='function')? getUserRole(): 'user';
                if (role !== 'admin') { alert('Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); return; }
                const statusEl = document.getElementById('seed-roles-status');
                if (statusEl) statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...';
                if (!window.db) { if (statusEl) statusEl.textContent='Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø²'; return; }
                const users = (window.state && Array.isArray(state.users)) ? window.state.users : [];
                const forcedAdmins = new Set((window.FORCED_ADMINS||[]).map(e=>String(e).toLowerCase()));
                const forcedReviewers = new Set((window.FORCED_REVIEWERS||[]).map(e=>String(e).toLowerCase()));
                const missing = [];
                users.forEach(u => {
                    const uid = u._id || u.uid || u.id; const email = (u.email||'').toLowerCase();
                    if (!uid) return;
                    if (u.role) return; // Ù„Ø¯ÙŠÙ‡ Ø¯ÙˆØ± Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ users
                    if (forcedAdmins.has(email) || forcedReviewers.has(email)) return; // Ø£Ø¯ÙˆØ§Ø± Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
                    missing.push({ uid, email });
                });
                if (missing.length === 0) { if (statusEl) statusEl.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆØ§Ø± Ù†Ø§Ù‚ØµØ©.'; return; }
                if (statusEl) statusEl.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ '+missing.length+' Ù…Ø³ØªÙ†Ø¯ Ø¯ÙˆØ±...';
                const ops = missing.map(m => window.db.collection('roles').doc(m.uid).set({ role: 'rep', email: m.email, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                Promise.allSettled(ops).then(results => {
                    const ok = results.filter(r=>r.status==='fulfilled').length;
                    const fail = results.length - ok;
                    if (statusEl) statusEl.textContent = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ '+ok+' / '+results.length+'Ø› ÙØ´Ù„ '+fail+'.';
                    document.dispatchEvent(new Event('role-ready'));
                }).catch(err => { if (statusEl) statusEl.textContent='Ø®Ø·Ø£: '+err.message; });
            } catch(err){ console.warn('seed-missing-roles error', err); }
        });

        // Ensure constants and utility functions are defined at the top level
        const DEFAULT_PRODUCTS = [
             {id: '1', name: 'Ù„Ø¨Ù† Ø¬Ø§Ù…ÙˆØ³Ù‰', price: 44.00, category: 'dairy'}, {id: '3', name: 'Ø²Ø¨Ø§Ø¯Ù‰ Ø¨Ù„Ø¯Ù‰', price: 9.00, category: 'multi'}, {id: '4', name: 'Ø§Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù†', price: 17.50, category: 'multi'}, {id: '18', name: 'Ù‚Ø±ÙŠØ´ ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ø¯Ø³Ù…', price: 100.00, category: 'dairy'}, {id: '11', name: 'Ù‚Ø±ÙŠØ´ Ø®Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ø³Ù…', price: 95.00, category: 'dairy'}, {id: '14', name: 'Ø°Ø¨Ø¯Ø© Ø¬Ø§Ù…ÙˆØ³ÙŠ 900 Ø¬Ù…', price: 315.00, category: 'multi'}, {id: '13', name: 'Ø°Ø¨Ø¯Ø© Ø¨Ù‚Ø±Ù‰ 900', price: 280.00, category: 'multi'}, {id: '30', name: 'Ù…Ø´ Ù‚Ø·Ø¹', price: 150.00, category: 'dairy'}, {id: '32', name: 'Ù…Ø´ ÙƒØ±ÙŠÙ…Ù‰', price: 120.00, category: 'dairy'}, {id: '200', name: 'ØµÙˆØµ Ø´ÙŠØ¯Ø±', price: 200.00, category: 'dairy'}, {id: '201', name: 'Ù†Ø³ØªÙˆ', price: 190.00, category: 'dairy'}, {id: '56', name: 'ÙÙŠØªØ§ Ø³Ø§Ø¯Ø© Ù†Ø¨Ø§ØªÙ‰', price: 110.00, category: 'dairy'}, {id: '57', name: 'ÙÙŠØªØ§ ÙÙ„ÙÙ„ Ù†Ø¨Ø§ØªÙ‰', price: 110.00, category: 'dairy'}, {id: '53', name: 'Ù…Ù„Ø­ Ø®ÙÙŠÙ Ù†Ø¨Ø§ØªÙ‰', price: 110.00, category: 'dairy'}, {id: '153', name: 'Ù…Ù„Ø­ Ø®ÙÙŠÙ Ø·Ø¨ÙŠØ¹Ù‰', price: 170.00, category: 'dairy'}, {id: '156', name: 'ÙÙŠØªØ§ Ø³Ø§Ø¯Ø© Ø·Ø¨ÙŠØ¹Ù‰', price: 170.00, category: 'dairy'}, {id: '157', name: 'ÙÙŠØªØ§ ÙÙ„ÙÙ„ Ø·Ø¨ÙŠØ¹Ù‰', price: 170.00, category: 'dairy'}, {id: '59', name: 'Ø³Ù…Ù†Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰ 200 Ø¬Ù…', price: 100.00, category: 'multi'}, {id: '60', name: 'Ø³Ù…Ù†Ø© Ø¨Ù‚Ø±Ù‰ 200 Ø¬Ù…', price: 90.00, category: 'multi'}, {id: '154', name: 'Ø¬Ø¨Ù†Ø© ÙƒÙŠØ±ÙŠ Ø·Ø¨ÙŠØ¹Ù‰', price: 150.00, category: 'dairy'}, {id: '12', name: 'Ù‚Ø´Ø·Ø© Ø¨Ù„Ø¯Ù‰', price: 200.00, category: 'dairy'}, {id: '42', name: 'Ù…ÙˆØ±ØªØ© ÙˆØ²Ù†', price: 150.00, category: 'dairy'}, {id: '52', name: 'Ù…ÙˆØ±ØªØ© 300 Ø¬Ù…', price: 65.00, category: 'multi'}, {id: '41', name: 'Ø³Ù…Ù†Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰ 800 Ø¬Ù…', price: 360.00, category: 'multi'}, {id: '43', name: 'Ø³Ù…Ù†Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰ 500 Ø¬Ù…', price: 230.00, category: 'multi'}, {id: '44', name: 'Ø³Ù…Ù†Ø© Ø¨Ù‚Ø±Ù‰ 800 Ø¬Ù…', price: 340.00, category: 'multi'}, {id: '45', name: 'Ø³Ù…Ù†Ø©Ø© Ø¨Ù‚Ø±Ù‰ 500 Ø¬Ù…', price: 220.00, category: 'multi'}, {id: '20', name: 'Ù…ÙˆØ²ÙˆØ±ÙŠÙ„Ø§ 900 Ø¬Ù… Ø·Ø¨ÙŠØ¹Ù‰', price: 190.00, category: 'multi'}, {id: '21', name: 'Ù…ÙˆØ²ÙˆØ±ÙŠÙ„Ø§ 350 Ø¬Ù… Ø·Ø¨ÙŠØ¹Ù‰', price: 80.00, category: 'multi'}, {id: '61', name: 'Ù…ÙˆØ²ÙˆØ±ÙŠÙ„Ø§ ÙˆØ²Ù† Ø·Ø¨ÙŠØ¹Ù‰', price: 170.00, category: 'multi'}, {id: '39', name: 'Ø§Ø±Ø² ÙØ®Ø§Ø±', price: 25.00, category: 'multi'}, {id: '40', name: 'Ø²Ø¨Ø§Ø¯Ù‰ ÙØ®Ø§Ø±', price: 17.50, category: 'multi'}, {id: '98', name: 'Ù„Ø¨Ù†Ø© ØªØ±ÙƒÙ‰', price: 150.00, category: 'dairy'}
        ];
        
        let state = { 
            customers: [], 
            products: [], 
            sales: [], 
            priceLists: [], 
            dispatchNotes: [], 
            reps: [], 
            promotions: [],
            settings: { salesTarget: 10000 },
            stockEntries: {},
            lastSyncTimestamp: null,
            invoiceHighlights: {},
            highlightCounter: 0 
        };

        // DOM Elements (defined here for wider scope access)
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.bottom-nav-item');
        const headerTitle = document.getElementById('header-title');
        const reportsSubnav = document.getElementById('reports-subnav');
        const loadingModal = document.getElementById('loading-modal');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const dialogTitle = document.getElementById('dialog-title');
        const dialogMessage = document.getElementById('dialog-message');
        const dialogActions = document.getElementById('dialog-actions');
        const dialogConfirmBtn = document.getElementById('dialog-confirm-btn');
        const dialogCancelBtn = document.getElementById('dialog-cancel-btn');

        // Forms (defined here for wider scope access)
        const saleModal = document.getElementById('sale-modal');
        const customerModal = document.getElementById('customer-modal');
        const repModal = document.getElementById('rep-modal'); 
        const productModal = document.getElementById('product-modal');
        const priceListModal = document.getElementById('price-list-modal');
        const promotionModal = document.getElementById('promotion-modal');
        const dateRangeModal = document.getElementById('date-range-modal');
        const dispatchNoteModal = document.getElementById('dispatch-note-modal');
        const viewDispatchNoteModal = document.getElementById('view-dispatch-note-modal');
        const settlementModal = document.getElementById('settlement-modal'); 
        const reconciliationModal = document.getElementById('reconciliation-modal');
        const repSalesSummaryModal = document.getElementById('rep-sales-summary-modal');
        const dailySalesReportModal = document.getElementById('daily-sales-report-modal');
        const customerSalesReportModal = document.getElementById('customer-sales-report-modal');
        const aiModal = document.getElementById('ai-modal'); 
        const loginModal = document.getElementById('login-modal'); // NEW

        // Forms References
        const saleForm = document.getElementById('sale-form');
        const customerForm = document.getElementById('customer-form');
        const repForm = document.getElementById('rep-form'); 
        const productForm = document.getElementById('product-form');
        const priceListForm = document.getElementById('price-list-form');
        const promotionForm = document.getElementById('promotion-form');
        const dateRangeForm = document.getElementById('date-range-form');
        const dispatchNoteForm = document.getElementById('dispatch-note-form');
        // const settlementForm = document.getElementById('settlement-form'); // settlement form might not exist

        // NEW Authentication Elements
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const logoutBtn = document.getElementById('logout-btn');

        // Spreadsheet Entry Elements (defined here for wider scope access)
        const spreadsheetRepSelect = document.getElementById('spreadsheet-rep');
        const spreadsheetCustomerSelect = document.getElementById('spreadsheet-customer');
        const spreadsheetDateInput = document.getElementById('spreadsheet-date');
        const spreadsheetEntryBody = document.getElementById('spreadsheet-entry-body');
        const spreadsheetAddRowBtn = document.getElementById('spreadsheet-add-row-btn');
        const spreadsheetSaveAllBtn = document.getElementById('spreadsheet-save-all-btn');
        const unifiedInvoiceNumberInput = document.getElementById('unified-invoice-number'); // Reference to the unified input
        const reportsSubnavItems = document.querySelectorAll('.reports-subnav-item');
        const dispatchItemsContainer = document.getElementById('dispatch-items-container');
        
        // Report Page Elements
        const reportContentAreas = document.querySelectorAll('#page-reports [data-report-content]');
        const dailyReportDateInput = document.getElementById('daily-report-date');
        const dailyReportRepSelect = document.getElementById('daily-report-rep');
        const rangeStartDateInput = document.getElementById('range-start-date');
        const rangeEndDateInput = document.getElementById('range-end-date');
        const rangeReportRepSelect = document.getElementById('range-report-rep');
        const monthlyReportMonthInput = document.getElementById('monthly-report-month');
        const monthlyReportRepSelect = document.getElementById('monthly-report-rep');
        const reportOutputArea = document.getElementById('report-output-area');

        // Chart instances
        let sales7DaysChart;
        let topRepsChart;
        let topProductsChart;
        let topCustomersChart;

        // Utility Functions
        const arabicMonths = [
            "ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ",
            "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"
        ];

        function formatArabicDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatArabicDateTime(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            return `${day}/${month}/${year} ${hour}:${minute}`;
        }

        const formatCurrency = (num) => new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(num || 0);
        const findCustomer = (id) => {
            const sid = id != null ? String(id) : '';
            return state.customers.find(c => String(c.id) === sid || String(c._id) === sid);
        };
        const findProduct = (id) => {
            const sid = id != null ? String(id) : '';
            return state.products.find(p => String(p.id) === sid) ||
                   state.products.find(p => String(p._id) === sid) ||
                   state.products.find(p => String(p.sku) === sid);
        };
        const findPriceList = (id) => state.priceLists.find(pl => pl.id === id);
        const findRep = (name) => state.reps.find(r => r.name === name);
        const openModal = (modal) => {
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            if (modal.id === 'date-range-modal') {
                // Ensure customers are loaded and then update the list
                // Assuming state.customers is already populated by this point
                updateCustomerList();
            }
        }
        const closeModal = (modal) => { modal.classList.add('modal-hidden'); modal.classList.remove('modal-visible'); }

        // Company logo helpers
        function getCompanyLogoUrl() {
            try {
                if (state.settings && state.settings.companyLogo) return state.settings.companyLogo;
                return window.DEFAULT_COMPANY_LOGO_URL || '';
            } catch (e) { return window.DEFAULT_COMPANY_LOGO_URL || ''; }
        }
        function renderCompanyLogo() {
            try {
                const url = getCompanyLogoUrl();
                const img = document.getElementById('company-logo-img');
                if (!img) return;
                if (url) {
                    img.src = url;
                    img.style.display = '';
                    // also apply watermark for the app using this url
                    try { applyWatermark(url); } catch(e) { console.warn('applyWatermark from renderCompanyLogo failed', e); }
                } else {
                    img.src = '';
                    img.style.display = 'none';
                    // remove watermark if exists
                    try { applyWatermark(''); } catch(e) { console.warn('remove watermark failed', e); }
                }
            } catch (e) { console.warn('renderCompanyLogo error', e); }
        }
        // Watermark helper: inject CSS that places the logo as a centered watermark
        function applyWatermark(url) {
            try {
                const head = document.head || document.getElementsByTagName('head')[0];
                let style = document.getElementById('company-watermark-style');
                // if no URL provided, remove existing watermark style and return
                if (!url) {
                    if (style && style.parentNode) style.parentNode.removeChild(style);
                    return;
                }
                const safeUrl = url.replace(/\)/g, '%29');
                const css = `
                    #app-container { position: relative; }
                    /* Full-screen centered faint watermark covering the viewport */
                    #app-container::before {
                        content: "";
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 140vmin;
                        height: 140vmin;
                        background-image: url("${safeUrl}");
                        background-repeat: no-repeat;
                        background-position: center;
                        background-size: contain;
                        opacity: 0.12;
                        pointer-events: none;
                        z-index: 0;
                        filter: saturate(0%) brightness(1.1);
                    }
                    /* Ensure content stacks above watermark */
                    #app-container > * { position: relative; z-index: 1; }
                    /* Print: slightly darker watermark and full-page */
                    @media print {
                        #app-container::before { opacity: 0.15; width: 220vmin; height: 220vmin; background-size: contain; position: fixed; }
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                `;
                if (!style) {
                    style = document.createElement('style');
                    style.id = 'company-watermark-style';
                    style.type = 'text/css';
                    style.appendChild(document.createTextNode(css));
                    head.appendChild(style);
                } else {
                    style.textContent = css;
                }
            } catch (e) {
                console.warn('applyWatermark error', e);
            }
        }

        // --- Debts Summary Utilities ---
        function computeDebtsSummary() {
            // Try state.sales first; fallback to table rows if empty
            const rows = [];
            if (Array.isArray(state.sales) && state.sales.length) {
                state.sales.forEach(s => {
                    // Expecting fields: customerName, repName, total, paid, remaining
                    const total = Number(s.total || 0);
                    const paid = Number(s.paid || 0);
                    const remaining = Number(s.remaining != null ? s.remaining : (total - paid));
                    rows.push({ customer: s.customerName || s.customer || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', rep: s.repName || s.rep || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', total, paid, remaining });
                });
            } else {
                // Parse any existing rows in the debts table
                const tbody = document.getElementById('debts-detail-body');
                if (tbody) {
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                        const tds = tr.querySelectorAll('td');
                        if (!tds || tds.length < 7) return;
                        const customer = tds[0].textContent.trim();
                        const date = tds[1].textContent.trim();
                        const invoice = tds[2].textContent.trim();
                        const total = Number((tds[3].textContent || '').replace(/[^0-9.-]+/g, '')) || 0;
                        const paid = Number((tds[4].textContent || '').replace(/[^0-9.-]+/g, '')) || 0;
                        const remaining = Number((tds[5].textContent || '').replace(/[^0-9.-]+/g, '')) || (total - paid);
                        const rep = tds[6].textContent.trim() || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        rows.push({ customer, rep, total, paid, remaining });
                    });
                }
            }

            // Aggregate by customer and by rep
            const byCustomer = {};
            const byRep = {};
            let totalRemaining = 0;
            rows.forEach(r => {
                if (!byCustomer[r.customer]) byCustomer[r.customer] = { total:0, paid:0, remaining:0 };
                if (!byRep[r.rep]) byRep[r.rep] = { total:0, paid:0, remaining:0 };
                byCustomer[r.customer].total += r.total;
                byCustomer[r.customer].paid += r.paid;
                byCustomer[r.customer].remaining += r.remaining;
                byRep[r.rep].total += r.total;
                byRep[r.rep].paid += r.paid;
                byRep[r.rep].remaining += r.remaining;
                totalRemaining += r.remaining;
            });

            return { byCustomer, byRep, totalRemaining };
        }

        function showDebtsSummaryModal(e) {
            // If called from nav click, allow navigation behavior to occur then open modal after a short delay
            if (e && e.preventDefault) {
                // let normal nav happen (switchPage) but also show modal
            }
            const summary = computeDebtsSummary();

            const custTbody = document.querySelector('#debts-by-customer tbody');
            const repTbody = document.querySelector('#debts-by-rep tbody');
            custTbody.innerHTML = '';
            repTbody.innerHTML = '';

            Object.keys(summary.byCustomer).sort().forEach(name => {
                const item = summary.byCustomer[name];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-right px-2 py-1">${name}</td><td class="text-center px-2 py-1">${formatCurrency(item.total)}</td><td class="text-center px-2 py-1">${formatCurrency(item.paid)}</td><td class="text-center px-2 py-1">${formatCurrency(item.remaining)}</td>`;
                custTbody.appendChild(tr);
            });

            Object.keys(summary.byRep).sort().forEach(name => {
                const item = summary.byRep[name];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-right px-2 py-1">${name}</td><td class="text-center px-2 py-1">${formatCurrency(item.total)}</td><td class="text-center px-2 py-1">${formatCurrency(item.paid)}</td><td class="text-center px-2 py-1">${formatCurrency(item.remaining)}</td>`;
                repTbody.appendChild(tr);
            });

            const totalEl = document.getElementById('debts-summary-total');
            if (totalEl) totalEl.textContent = formatCurrency(summary.totalRemaining);

            openModal(document.getElementById('debts-summary-modal'));
        }

        // Remove auto-popup behavior per user request
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('debts-nav-btn');
            if (btn) {
                // Only handle navigation, no auto-popup
                btn.addEventListener('click', function(ev) {
                    // Default navigation behavior only
                });
            }
        });

        // --- NEW: Manual Review Highlighting Functions ---
        const REVIEW_COLORS = ['highlight-blue', 'highlight-green', 'highlight-purple', 'highlight-orange', 'highlight-teal'];
        const LOCAL_REVIEW_KEY = 'mandoobi_review_state';

        function loadReviewState() {
            try {
                const savedState = localStorage.getItem(LOCAL_REVIEW_KEY);
                return savedState ? JSON.parse(savedState) : {};
            } catch (e) {
                console.error("Failed to load review state:", e);
                return {};
            }
        }

        function saveReviewState(reviewState) {
            try {
                localStorage.setItem(LOCAL_REVIEW_KEY, JSON.stringify(reviewState));
            } catch (e) {
                console.error("Failed to save review state:", e);
            }
        }

        function toggleReviewColor(saleId, element) {
            const reviewState = loadReviewState();
            const existingColor = reviewState[saleId];

            // Remove all palette colors from the element to start fresh.
            element.classList.remove(...REVIEW_COLORS);

            if (existingColor) {
                // If it was already colored, just remove it from the state.
                delete reviewState[saleId];
            } else {
                // If it's a new item to color, use the global counter.
                // Ensure the counter is a number.
                if (typeof state.highlightCounter !== 'number') {
                    state.highlightCounter = 0;
                }
                
                const colorIndex = state.highlightCounter % REVIEW_COLORS.length;
                const nextColor = REVIEW_COLORS[colorIndex];
                
                // Store the class name in the review state.
                reviewState[saleId] = nextColor;
                element.classList.add(nextColor);
                
                // Increment the main state's counter for the next new item.
                state.highlightCounter++;
            }
            
            saveReviewState(reviewState); // Saves the color mapping {saleId: 'class-name'}
            saveState(); // Saves the main state, including the incremented counter
        }


        // --- All Function Definitions START ---
        
        function updateIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function customDialog({ message, title = 'Ø¥Ø´Ø¹Ø§Ø±', isConfirm = false, confirmText = 'ØªØ£ÙƒÙŠØ¯', confirmClass = 'bg-blue-600 hover:bg-blue-700' }) {
             return new Promise(resolve => {
                let confirmBtn = document.getElementById('dialog-confirm-btn');
                let cancelBtn = document.getElementById('dialog-cancel-btn');

                if (!dialogTitle || !dialogMessage || !confirmBtn || !cancelBtn) {
                    console.error("Custom dialog elements are missing in the DOM.");
                    setTimeout(() => resolve(isConfirm ? false : true), 10);
                    return;
                }
                
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                
                confirmBtn.textContent = confirmText;
                confirmBtn.className = `flex-1 text-white px-4 py-2 rounded-lg font-semibold ${confirmClass}`;
                
                dialogActions.classList.toggle('justify-between', isConfirm);
                dialogActions.classList.toggle('justify-center', !isConfirm);
                cancelBtn.classList.toggle('hidden', !isConfirm);
                cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';

                const oldConfirmBtn = confirmBtn;
                const newConfirmBtn = oldConfirmBtn.cloneNode(true);
                if (oldConfirmBtn.parentNode) {
                    oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
                }
                
                const oldCancelBtn = cancelBtn;
                const newCancelBtn = oldCancelBtn.cloneNode(true);
                if (oldCancelBtn.parentNode) {
                    oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
                }
                
                newConfirmBtn.addEventListener('click', () => {
                    closeModal(customConfirmModal);
                    resolve(true);
                }, { once: true });

                if (isConfirm) {
                    newCancelBtn.addEventListener('click', () => {
                        closeModal(customConfirmModal);
                        resolve(false);
                    }, { once: true });
                }
                
                openModal(customConfirmModal);
            });
        }
        
        function populateRepDropdown(selectEl, selectedRepName = '') {
            if (!selectEl) return;
            let repNames = (state.reps||[]).map(r => r.name).filter(n => !!n);
            const prev = selectedRepName || selectEl.value;
            // ØªØ®ØµÙŠØµ Ø²Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø£Ø¯Ù…Ù†
            if (selectEl.id === 'spreadsheet-rep') {
                let role = typeof getUserRole === 'function' ? getUserRole() : 'rep';
                let currentEmail = (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null;
                if (role === 'rep' && currentEmail) {
                    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                    const currentRep = (state.reps||[]).find(r => (r.email||'').toLowerCase() === currentEmail);
                    if (currentRep) {
                        repNames = [currentRep.name];
                    } else {
                        repNames = [];
                    }
                }
            }
            let html = '<option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ --</option>';
            html += repNames.map(name => `<option value="${name}" ${name === prev ? 'selected' : ''}>${name}</option>`).join('');
            selectEl.innerHTML = html;
            // Restore previous selection if still present
            if (prev && repNames.includes(prev)) selectEl.value = prev;
        }
        
        function populateRepDropdownReports(selectEl, selectedRepName = '') {
            const repNames = state.reps.map(r => r.name);
            selectEl.innerHTML = '<option value="all">-- ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ --</option>' + repNames.map(name => 
                `<option value="${name}" ${name === selectedRepName ? 'selected' : ''}>${name}</option>`
            ).join('');
        }

        // Helper: Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù (ØªØ¬Ù†Ù‘Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ¹Ø±ÙŠÙ)
        if (typeof window.findRep !== 'function') {
            window.findRep = function(name){
                try { return (state.reps||[]).find(r => r.name === name || r.id === name) || null; } catch(e){ return null; }
            };
        }

        // ===== ØªØµØ­ÙŠØ­ Ù…Ø´Ø§ÙƒÙ„ ØªÙˆÙ‚Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø³Ø¨Ø¨ Ø¯ÙˆØ§Ù„ Ù†Ø§Ù‚ØµØ© Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… =====
        // ØªÙ‡ÙŠØ¦Ø© Ø¢Ù…Ù†Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        window.state = window.state || {};

        // ØªØ¹Ø±ÙŠÙ DEFAULT_PRODUCTS ÙØ§Ø±Øº Ù„ØªÙØ§Ø¯ÙŠ Ø£Ø®Ø·Ø§Ø¡ ensureFinishedFromState
        if (typeof window.DEFAULT_PRODUCTS === 'undefined') window.DEFAULT_PRODUCTS = [];

        // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù…Ù„Ø© Ø¨Ø³ÙŠØ·Ø© (Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ Ø£Ùˆ Ø±Ù‚Ù… Ù…Ø¬Ø±Ø¯)
        if (typeof window.formatCurrency !== 'function') {
            window.formatCurrency = function(v){
                try { return Number(v||0).toLocaleString('ar-EG', { minimumFractionDigits: 0 }); } catch(e){ return String(v||'0'); }
            };
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù
        if (typeof window.findCustomer !== 'function') {
            window.findCustomer = function(id){
                try { return (state.customers||[]).find(c => (c.id||c._id) === id) || null; } catch(e){ return null; }
            };
        }

        // Ø¯Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù‚Ø¯ÙŠÙ…Ø© ÙƒØ§Ù†Øª ØªØ³ØªØ¹Ù…Ù„ Ù„Ù„Ø§Ø³Ù… updateCustomerList â€” Ù†Ø¬Ø¹Ù„Ù‡Ø§ ØªØ³ØªØ¯Ø¹ÙŠ renderCustomerList
        if (typeof window.updateCustomerList !== 'function') {
            window.updateCustomerList = function(filter, chain){
                try { if (typeof renderCustomerList === 'function') renderCustomerList(filter||''); } catch(e){ console.warn('updateCustomerList stub failed', e); }
            };
        }

        function updatePromotionOriginalPriceDisplay(productId) {
             const product = findProduct(productId);
             const displayEl = document.getElementById('original-price-display');
             const priceEl = document.getElementById('current-product-price');
             if (product) {
                 priceEl.textContent = formatCurrency(product.price);
                 displayEl.classList.remove('hidden');
             } else {
                 displayEl.classList.add('hidden');
             }
        }



        function getActivePromotionPrice(productId, customerId = null) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const relevantOffers = state.promotions.filter(p => p.productId === productId);
            let activeOffer = relevantOffers.find(p => {
                const isTargetingThisCustomer = p.customerId === customerId;
                if (!isTargetingThisCustomer) return false;
                const startDate = new Date(p.startDate);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(p.endDate);
                endDate.setHours(23, 59, 59, 999);
                return today >= startDate && today <= endDate;
            });
            if (!activeOffer) {
                activeOffer = relevantOffers.find(p => {
                    const isTargetingAll = !p.customerId;
                    if (!isTargetingAll) return false;
                    const startDate = new Date(p.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(p.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    return today >= startDate && today <= endDate;
                });
            }
            return activeOffer ? activeOffer.price : null;
        }

        const supermarketChains = {
            exception: ["Ø§ÙƒØ³Ø¨Ø´Ù† Ù…Ø§Ø±ÙƒØª"],
            awladragab: ["Ø§ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨"],
            samysalama: ["Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ù‡"],
            gomlamarket: ["Ø¬Ù…Ù„Ø© Ù…Ø§Ø±ÙƒØª"],
            dreams: ["Ø¯Ø±ÙŠÙ…Ø² ÙØ±Ø¹ 1", "Ø¯Ø±ÙŠÙ…Ø² ÙØ±Ø¹ 2"]
        };

        const updateCustomerList = (filter = '', chain = 'all') => {
             const statementCustomerList = document.getElementById('statement-customer-list');
             if (!statementCustomerList) return;
             statementCustomerList.innerHTML = '';

             console.log('updateCustomerList called with:', { filter, chain });
             console.log('Initial state.customers:', state.customers);

             let filteredCustomers = state.customers;
             const allChains = loadChains();

             if (chain !== 'all' && supermarketChains[chain]) {
                 const branches = supermarketChains[chain];
                 console.log('Filtering by chain. Branches:', branches);
                 filteredCustomers = filteredCustomers.filter(c => {
                     const match = branches.some(branch => c.name.toLowerCase().includes(branch.toLowerCase()));
                     // console.log(`Customer: ${c.name}, Branch: ${branches}, Match: ${match}`);
                     return match;
                 });
                 console.log('Customers after chain filter:', filteredCustomers);
             }

             if (filter) {
                 filteredCustomers = filteredCustomers.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                 console.log('Customers after text filter:', filteredCustomers);
             }

             if (filteredCustomers.length === 0) {
                 const el = document.createElement('label');
                 el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                 el.innerHTML = `
                      <span class="text-sm text-red-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</span>
                 `;
                 statementCustomerList.appendChild(el);
             } else {
                 filteredCustomers.forEach(customer => {
                     const el = document.createElement('label');
                     el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                     el.innerHTML = `
                          <input type="checkbox" value="${customer.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                          <span class="text-sm">${customer.name}</span>
                     `;
                     statementCustomerList.appendChild(el);
                 });
                 
                 // Add chains as options
                 if (allChains.length > 0) {
                     allChains.forEach(chain => {
                         const el = document.createElement('label');
                         el.className = 'flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
                         el.innerHTML = `
                              <input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                              <span class="text-sm font-medium">[Ø³Ù„Ø³Ù„Ø©] ${chain.name}</span>
                         `;
                         statementCustomerList.appendChild(el);
                     });
                 }
             }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Event listener for the new select
            const supermarketChainFilter = document.getElementById('supermarket-chain-filter');
            if(supermarketChainFilter) {
                supermarketChainFilter.addEventListener('change', (e) => {
                    const chain = e.target.value;
                    const filter = document.getElementById('statement-customer-search').value;
                    updateCustomerList(filter, chain);
                });
            }

            // Modify the existing event listener for the search input
            const statementCustomerSearch = document.getElementById('statement-customer-search');
            if(statementCustomerSearch){
                statementCustomerSearch.addEventListener('input', (e) => {
                    const filter = e.target.value;
                    const chain = document.getElementById('supermarket-chain-filter') ? document.getElementById('supermarket-chain-filter').value : 'all';
                    
                    // Also filter chains by search text
                    const statementCustomerList = document.getElementById('statement-customer-list');
                    if (!statementCustomerList) return;
                    
                    // Re-build list with search filter for chains too
                    let filteredCustomers = state.customers;
                    const allChains = loadChains();
                    
                    if (chain !== 'all' && supermarketChains[chain]) {
                        const branches = supermarketChains[chain];
                        filteredCustomers = filteredCustomers.filter(c => {
                            const match = branches.some(branch => c.name.toLowerCase().includes(branch.toLowerCase()));
                            return match;
                        });
                    }
                    
                    if (filter) {
                        filteredCustomers = filteredCustomers.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                    }
                    
                    statementCustomerList.innerHTML = '';
                    
                    if (filteredCustomers.length === 0 && (!filter || filter.length === 0)) {
                        const el = document.createElement('label');
                        el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                        el.innerHTML = '<span class="text-sm text-red-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</span>';
                        statementCustomerList.appendChild(el);
                    } else {
                        filteredCustomers.forEach(customer => {
                            const el = document.createElement('label');
                            el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                            el.innerHTML = `
                                 <input type="checkbox" value="${customer.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                                 <span class="text-sm">${customer.name}</span>
                            `;
                            statementCustomerList.appendChild(el);
                        });
                        
                        // Add filtered chains
                        if (allChains.length > 0 && (!filter || filter.length === 0)) {
                            allChains.forEach(chain => {
                                const el = document.createElement('label');
                                el.className = 'flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
                                el.innerHTML = `
                                     <input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                                     <span class="text-sm font-medium">[Ø³Ù„Ø³Ù„Ø©] ${chain.name}</span>
                                `;
                                statementCustomerList.appendChild(el);
                            });
                        } else if (allChains.length > 0 && filter) {
                            // Show chains that match the search
                            const filteredChains = allChains.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                            filteredChains.forEach(chain => {
                                const el = document.createElement('label');
                                el.className = 'flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
                                el.innerHTML = `
                                     <input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                                     <span class="text-sm font-medium">[Ø³Ù„Ø³Ù„Ø©] ${chain.name}</span>
                                `;
                                statementCustomerList.appendChild(el);
                            });
                        }
                    }
                });
            }
        });

        // +++ NEW FUNCTIONS FOR DETAILED SALE MODAL +++

        function populateProductDropdown(selectEl, selectedId = '') {
            selectEl.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ --</option>' + state.products.map(p => 
                `<option value="${p.id}" ${p.id === selectedId ? 'selected' : ''}>${p.name} (${p.id})</option>`
            ).join('');
        }

        // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙØªØ±Ø© Ø§Ù„Ø¹Ø±Ø¶)
        function updateAllSalePrices() {
            const container = document.getElementById('sale-items-container');
            if (!container) return;
            
            container.querySelectorAll('.sale-item-row').forEach(row => {
                const productSelect = row.querySelector('.sale-item-product');
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value) || 0;
                const priceInput = row.querySelector('.sale-item-price');
                const totalDisplay = row.querySelector('.sale-item-total-display');
                
                const productId = productSelect.value;
                const customerId = document.getElementById('sale-customer')?.value || '';
                let price = 0;

                if (productId) {
                    const product = findProduct(productId);
                    let basePrice = product ? product.price : 0;

                    // Check price list
                    if (customerId) {
                        const customer = findCustomer(customerId);
                        if (customer && customer.priceListId) {
                            const priceList = findPriceList(customer.priceListId);
                            if (priceList && priceList.productPrices[productId] !== undefined) {
                                basePrice = priceList.productPrices[productId];
                            }
                        }
                    }
                    
                    // Check promotion - Ù‡Ø°Ø§ Ø³ÙŠØ¹ÙŠØ¯ null Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„Ø¹Ø±Ø¶
                    const promotionPrice = getActivePromotionPrice(productId, customerId);
                    price = (promotionPrice !== null) ? promotionPrice : basePrice;
                }

                priceInput.value = price.toFixed(2);
                const itemTotal = quantity * price;
                totalDisplay.textContent = formatCurrency(itemTotal);
            });
            
            updateSaleSummary();
        }

        function addSaleItemRow(item = {}) {
            const container = document.getElementById('sale-items-container');
            const row = document.createElement('tr');
            row.className = 'sale-item-row';
            row.innerHTML = `
                <td class="px-4 py-2"><select class="sale-item-product w-full p-2 border rounded-md" required>${state.products.length > 0 ? '' : '<option>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</option>'}</select></td>
                <td class="px-4 py-2"><input class="sale-item-quantity p-2 border rounded-md text-center" type="number" value="${(item.quantity != null && item.quantity !== undefined && item.quantity !== '') ? item.quantity : ''}" placeholder="0"></td>
                <td class="px-4 py-2"><input class="sale-item-price p-2 border rounded-md text-center bg-gray-100" type="number" value="${item.price || 0}" readonly></td>
                <td class="px-4 py-2"><span class="sale-item-total-display font-semibold">0 Ø¬.Ù…</span></td>
                <td class="px-2 py-2 text-center"><button type="button" class="delete-sale-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
            `;

            const productSelect = row.querySelector('.sale-item-product');
            populateProductDropdown(productSelect, item.productId || '');
            
            container.appendChild(row);
            updateIcons();

            // Function to update row price and total
            const updateRow = () => {
                const productId = productSelect.value;
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value) || 0;
                const priceInput = row.querySelector('.sale-item-price');
                const totalDisplay = row.querySelector('.sale-item-total-display');
                
                const customerId = document.getElementById('sale-customer').value;
                let price = 0;

                if (productId) {
                    const product = findProduct(productId);
                    let basePrice = product ? product.price : 0;

                    // Check price list
                    if (customerId) {
                        const customer = findCustomer(customerId);
                        if (customer && customer.priceListId) {
                            const priceList = findPriceList(customer.priceListId);
                            if (priceList && priceList.productPrices[productId] !== undefined) {
                                basePrice = priceList.productPrices[productId];
                            }
                        }
                    }
                    
                    // Check promotion
                    const promotionPrice = getActivePromotionPrice(productId, customerId);
                    price = (promotionPrice !== null) ? promotionPrice : basePrice;
                    try {
                        if (product && /Ù‚Ø±ÙŠØ´|Ù‚Ø±ÙŠØ´/i.test(product.name)) {
                            const customer = customerId ? findCustomer(customerId) : null;
                            const priceList = (customer && customer.priceListId) ? findPriceList(customer.priceListId) : null;
                            const listOverride = priceList ? priceList.productPrices[productId] : undefined;
                            console.debug('DEBUG Pricing (sale modal row)', {
                                productId,
                                productName: product ? product.name : '',
                                basePrice: (product ? product.price : 0),
                                priceListId: customer ? customer.priceListId : '',
                                priceListOverride: listOverride,
                                promotionPrice,
                                finalPrice: price
                            });
                        }
                    } catch(_){ }
                }

                priceInput.value = price.toFixed(2);
                const itemTotal = quantity * price;
                totalDisplay.textContent = formatCurrency(itemTotal);
                updateSaleSummary(); // Update grand total
            };

            // Add event listeners
            productSelect.addEventListener('change', updateRow);
            row.querySelector('.sale-item-quantity').addEventListener('input', updateRow);
            row.querySelector('.delete-sale-item-btn').addEventListener('click', () => {
                row.remove();
                updateSaleSummary();
            });

            // Add listener to customer dropdown to update all item prices if customer changes
            document.getElementById('sale-customer').addEventListener('change', updateRow);

            updateRow(); // Initial call to set price/total
        }

        function updateSaleSummary() {
            // Subtotal (sum of line price * qty)
            let subtotal = 0;
            const rows = Array.from(document.querySelectorAll('#sale-items-container .sale-item-row'));
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.sale-item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.sale-item-price').value) || 0;
                subtotal += quantity * price;
            });

            const discountPercent = parseFloat(document.getElementById('sale-discount').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const additionPercent = parseFloat(document.getElementById('sale-addition')?.value) || 0;
            const additionAmount = subtotal * (additionPercent / 100);

            // Taxable base after discount and addition (addition is applied as in UI)
            const taxableSubtotal = subtotal - discountAmount + additionAmount;

            // Compute VAT per line using each product's vat_rate (percentage expressed as fraction)
            let vatTotal = 0;
            try {
                rows.forEach(row => {
                    const productId = row.querySelector('.sale-item-product')?.value;
                    const quantity = parseFloat(row.querySelector('.sale-item-quantity').value) || 0;
                    const price = parseFloat(row.querySelector('.sale-item-price').value) || 0;
                    const product = productId ? findProduct(productId) : null;
                    const vatRate = (product && product.vat_rate) ? Number(product.vat_rate) / 100 : 0;
                    // apply global discount proportionally on each line for VAT base
                    const lineBaseAfterDiscount = quantity * price * (1 - (discountPercent/100));
                    const lineVat = lineBaseAfterDiscount * vatRate;
                    vatTotal += lineVat;
                });
            } catch(e){ console.warn('VAT calc error', e); }

            // Withholding: 1% of taxable subtotal if customer has taxNumber
            let withholding = 0;
            try {
                const customerId = document.getElementById('sale-customer')?.value;
                const customer = customerId ? findCustomer(customerId) : null;
                if (customer && (customer.taxNumber || customer.taxNumber === 0 || customer.taxNumber === '')) {
                    // treat non-empty taxNumber as tax-entity
                    if (customer.taxNumber && String(customer.taxNumber).trim().length) {
                        withholding = round2(taxableSubtotal * 0.01);
                    }
                }
            } catch(e){ console.warn('withholding calc error', e); }

            const totalBeforeWithholding = round2(taxableSubtotal + round2(vatTotal));
            const finalPayable = round2(totalBeforeWithholding - withholding);

            // Update UI
            document.getElementById('sale-subtotal-text').textContent = formatCurrency(round2(subtotal));
            document.getElementById('sale-discount-text').textContent = formatCurrency(round2(discountAmount));
            // add/update addition line
            let additionLine = document.getElementById('sale-addition-line');
            if (!additionLine) {
                const summary = document.getElementById('sale-summary');
                if (summary) {
                    additionLine = document.createElement('div');
                    additionLine.id = 'sale-addition-line';
                    additionLine.className = 'flex justify-between text-green-600';
                    additionLine.innerHTML = '<span>Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</span><span id="sale-addition-text">0 Ø¬.Ù…</span>';
                    const discountLine = document.getElementById('sale-discount-text')?.parentElement;
                    if (discountLine) discountLine.insertAdjacentElement('afterend', additionLine);
                    else summary.insertBefore(additionLine, summary.querySelector('hr'));
                }
            }
            const additionTextEl = document.getElementById('sale-addition-text');
            if (additionTextEl) additionTextEl.textContent = formatCurrency(round2(additionAmount));

            const vatEl = document.getElementById('sale-vat-text'); if (vatEl) vatEl.textContent = formatCurrency(round2(vatTotal));
            const withEl = document.getElementById('sale-withholding-text'); if (withEl) withEl.textContent = formatCurrency(round2(withholding));
            const finalEl = document.getElementById('sale-final-text'); if (finalEl) finalEl.textContent = formatCurrency(finalPayable);
            // keep legacy total display (before withholding) for compatibility
            document.getElementById('sale-total-text').textContent = formatCurrency(totalBeforeWithholding);

            // Update paid amount based on status
            const statusSelect = document.getElementById('sale-status');
            const paidAmountContainer = document.getElementById('paid-amount-container');
            const paidAmountInput = document.getElementById('sale-paid-amount');
            
            if (statusSelect.value === 'paid') {
                paidAmountInput.value = finalPayable.toFixed(2);
                paidAmountContainer.classList.add('hidden');
            } else if (statusSelect.value === 'due') {
                paidAmountInput.value = 0;
                paidAmountContainer.classList.add('hidden');
            } else { // partial
                paidAmountContainer.classList.remove('hidden');
            }
        }

        function openSaleModal(id = null) {
            saleForm.reset();
            document.getElementById('sale-items-container').innerHTML = '';
            populateRepDropdown(document.getElementById('sale-rep'));
            populateCustomerDropdown(document.getElementById('sale-customer'));
            // elements for toggling editable selects vs readonly displays
            const repSelectEl = document.getElementById('sale-rep');
            const custSelectEl = document.getElementById('sale-customer');
            const repDisplayEl = document.getElementById('sale-rep-display');
            const custDisplayEl = document.getElementById('sale-customer-display');
            
            const paidAmountContainer = document.getElementById('paid-amount-container');
            const statusSelect = document.getElementById('sale-status');
            const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';

            if (id) {
                // Edit Mode
                const sale = state.sales.find(s => s.id === id);
                if (!sale) {
                    customDialog({ message: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.', title: 'Ø®Ø·Ø£' });
                    return;
                }
                document.getElementById('sale-modal-title').textContent = `ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: ${sale.invoiceNumber}`;
                document.getElementById('sale-id').value = sale.id;
                // keep selects populated for internal logic but show readonly displays to prevent edits
                try { if (repSelectEl) repSelectEl.value = sale.repName; } catch(e){}
                try { if (custSelectEl) custSelectEl.value = sale.customerId; } catch(e){}
                try { if (repDisplayEl) { repDisplayEl.value = sale.repName || ''; repDisplayEl.style.display = 'block'; } } catch(e){}
                try { if (custDisplayEl) { custDisplayEl.value = (typeof findCustomer === 'function' ? (findCustomer(sale.customerId)?.name || '') : (sale.customerName || '')) ; custDisplayEl.style.display = 'block'; } } catch(e){}
                try { if (repSelectEl) repSelectEl.style.display = 'none'; } catch(e){}
                try { if (custSelectEl) custSelectEl.style.display = 'none'; } catch(e){}
                document.getElementById('sale-date').value = new Date(sale.date).toISOString().split('T')[0];
                document.getElementById('sale-invoice-number').value = sale.invoiceNumber;
                document.getElementById('sale-notes').value = sale.notes || '';
                document.getElementById('sale-discount').value = sale.discount || 0;
                document.getElementById('sale-addition').value = sale.additionPercent || sale.addition || 0;
                
                statusSelect.value = sale.status;
                if (sale.status === 'partial') {
                    paidAmountContainer.classList.remove('hidden');
                    document.getElementById('sale-paid-amount').value = sale.paidAmount;
                } else {
                    paidAmountContainer.classList.add('hidden');
                }

                sale.items.forEach(item => addSaleItemRow(item));

                // Show ETA upload button for admin only in edit mode
                try {
                    const etaBtn = document.getElementById('eta-upload-from-modal-btn');
                    if (etaBtn) {
                        if (role === 'admin') {
                            etaBtn.classList.remove('hidden');
                            etaBtn.dataset.id = sale.id;
                            // Remove previous listener if any
                            const newBtn = etaBtn.cloneNode(true);
                            etaBtn.parentNode.replaceChild(newBtn, etaBtn);
                            newBtn.addEventListener('click', async ()=>{
                                try { await window.uploadSaleToEta(sale.id); } catch(e){ console.warn('modal eta upload failed', e); }
                            });
                            updateIcons();
                        } else {
                            etaBtn.classList.add('hidden');
                        }
                    }
                } catch(_){ }

                // Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù†Ø¯ÙˆØ¨Ø§Ù‹ØŒ ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                if (role === 'rep') {
                    try {
                        // Ø­Ø³Ø§Ø¨ Ø¹Ù…Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                        let createdTime = null;
                        if (sale && sale.createdAt) {
                            if (typeof sale.createdAt.toDate === 'function') {
                                createdTime = sale.createdAt.toDate();
                            } else {
                                createdTime = new Date(sale.createdAt);
                            }
                        }
                        
                        const ageMs = createdTime ? (Date.now() - createdTime.getTime()) : Infinity;
                        const EDIT_WINDOW_MS = 15 * 60 * 1000; // 15 Ø¯Ù‚ÙŠÙ‚Ø©
                        const isWithinEditWindow = ageMs <= EDIT_WINDOW_MS;
                        
                        const form = document.getElementById('sale-form');
                        const title = document.getElementById('sale-modal-title');
                        
                        if (isWithinEditWindow) {
                            // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
                            const remainingMinutes = Math.ceil((EDIT_WINDOW_MS - ageMs) / 60000);
                            if (title) {
                                title.textContent = `${title.textContent} (Ù…ØªØ¨Ù‚ÙŠ: ${remainingMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)`;
                            }
                            
                            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
                            form.querySelectorAll('input, select, textarea').forEach(el => {
                                el.disabled = false;
                                el.classList.remove('opacity-70', 'cursor-not-allowed', 'bg-gray-100');
                            });
                            
                            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø¥Ø¶Ø§ÙØ©ØŒ Ø­Ø°ÙØŒ Ø­ÙØ¸)
                            form.querySelectorAll('button').forEach(el => {
                                if (el.id === 'add-sale-item-btn') {
                                    el.style.display = 'inline-block';
                                    el.disabled = false;
                                    return;
                                }
                                if (el.className.includes('remove-item-btn')) {
                                    el.style.display = 'inline-block';
                                    el.disabled = false;
                                    return;
                                }
                                if (el.id === 'cancel-sale-btn') {
                                    el.disabled = false;
                                    return;
                                }
                                if (el.type === 'submit') {
                                    el.disabled = false;
                                    el.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                            });
                            
                            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ footer
                            const submitBtn = document.querySelector('footer [type="submit"][form="sale-form"]');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            }
                        } else {
                            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø© (Ø¹Ø±Ø¶ ÙÙ‚Ø·)
                            if (title) {
                                title.textContent = `[Ø¹Ø±Ø¶ ÙÙ‚Ø· - Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©] ${title.textContent}`;
                            }
                            
                            // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
                            form.querySelectorAll('input, select, textarea').forEach(el => {
                                el.disabled = true;
                                el.classList.add('opacity-70', 'cursor-not-allowed', 'bg-gray-100');
                            });
                            
                            // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
                            form.querySelectorAll('button').forEach(el => {
                                if (el.id === 'cancel-sale-btn') {
                                    el.disabled = false;
                                    return;
                                }
                                if (el.id === 'add-sale-item-btn') {
                                    el.style.display = 'none';
                                    return;
                                }
                                if (el.className.includes('remove-item-btn')) {
                                    el.style.display = 'none';
                                    return;
                                }
                                el.disabled = true;
                                el.classList.add('opacity-50', 'cursor-not-allowed');
                            });
                            
                            // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸
                            const submitBtn = document.querySelector('footer [type="submit"][form="sale-form"]');
                            if (submitBtn) {
                                submitBtn.disabled = true;
                                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            }
                        }
                    } catch(err) {
                        console.warn('Error handling rep edit window:', err);
                    }
                }
                
            } else {
                // Add Mode (User doesn't want this, but the function needs to support it)
                document.getElementById('sale-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹';
                document.getElementById('sale-id').value = '';
                document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
                // ensure selects are visible for creating a new sale
                try { if (repSelectEl) repSelectEl.style.display = 'block'; } catch(e){}
                try { if (custSelectEl) custSelectEl.style.display = 'block'; } catch(e){}
                try { if (repDisplayEl) repDisplayEl.style.display = 'none'; } catch(e){}
                try { if (custDisplayEl) custDisplayEl.style.display = 'none'; } catch(e){}
                statusSelect.value = 'paid';
                paidAmountContainer.classList.add('hidden');
                addSaleItemRow(); // Add one empty row
                try { const etaBtn = document.getElementById('eta-upload-from-modal-btn'); if (etaBtn) etaBtn.classList.add('hidden'); } catch(_){ }
            }
            
            updateSaleSummary();
            openModal(saleModal);
        }

        async function saveSale(e) {
            e.preventDefault();
            const id = document.getElementById('sale-id').value;
            const repName = document.getElementById('sale-rep').value;
            const customerId = document.getElementById('sale-customer').value;
            const date = document.getElementById('sale-date').value;
            const invoiceNumber = document.getElementById('sale-invoice-number').value;

            if (!repName || !customerId || !date || !invoiceNumber) {
                await customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }

            const items = [];
            let subtotal = 0;
            const itemRows = document.querySelectorAll('#sale-items-container .sale-item-row');
            if (itemRows.length === 0) {
                await customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ÙØ§ØªÙˆØ±Ø©.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }
            
            let saleNeedsReview = false;
            for (const row of itemRows) {
                const productId = row.querySelector('.sale-item-product').value;
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value);
                const price = parseFloat(row.querySelector('.sale-item-price').value);
                
                // Check quantity for zero, but allow negative for returns
                if (!productId || isNaN(quantity) || quantity === 0 || isNaN(price)) {
                    await customDialog({ message: 'Ø£Ø­Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© (Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù… ØºÙŠØ± ØµÙØ±ÙŠ).', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                    return;
                }
                
                const itemTotal = quantity * price;
                // Determine expected/base price for this product (consider customer-specific price lists and promotions)
                try {
                    const prod = findProduct(productId) || {};
                    let expectedPrice = (prod.price != null) ? Number(prod.price) : 0;
                    try {
                        const customer = findCustomer(customerId);
                        if (customer && customer.priceListId) {
                            const pl = findPriceList(customer.priceListId);
                            if (pl && pl.productPrices && pl.productPrices[productId] !== undefined) expectedPrice = Number(pl.productPrices[productId]);
                        }
                    } catch(_){ }
                    try {
                        const promoPrice = getActivePromotionPrice(productId, customerId);
                        if (promoPrice !== null && promoPrice !== undefined) expectedPrice = Number(promoPrice);
                    } catch(_){ }

                    const isAdjusted = Math.abs((Number(price) || 0) - (Number(expectedPrice) || 0)) > 0.005;
                    if (isAdjusted) saleNeedsReview = true;
                    items.push({ productId, quantity, price, itemTotal, adjusted: isAdjusted, expectedPrice }); // store adjusted flag and expected price
                } catch(e){
                    items.push({ productId, quantity, price, itemTotal, adjusted: false });
                }
                subtotal += itemTotal;
            }
            
            const discountPercent = parseFloat(document.getElementById('sale-discount').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const additionPercent = parseFloat(document.getElementById('sale-addition').value) || 0;
            const additionAmount = subtotal * (additionPercent / 100);
            const finalTotal = subtotal - discountAmount + additionAmount;

            // Compute VAT and withholding so they are persisted with the sale
            const taxableSubtotal = subtotal - discountAmount + additionAmount;
            let vatTotal = 0;
            try {
                items.forEach(i => {
                    try {
                        const prod = findProduct(i.productId) || {};
                        const vatRate = (prod && prod.vat_rate) ? Number(prod.vat_rate) / 100 : 0;
                        const lineBaseAfterDiscount = (Number(i.quantity) || 0) * (Number(i.price) || 0) * (1 - (discountPercent/100));
                        vatTotal += lineBaseAfterDiscount * vatRate;
                    } catch(e){ /* ignore line errors */ }
                });
            } catch(e){ console.warn('VAT compute failed', e); }
            vatTotal = round2(vatTotal);

            let withholding = 0;
            try {
                const customer = customerId ? findCustomer(customerId) : null;
                if (customer && customer.taxNumber && String(customer.taxNumber).trim().length) {
                    withholding = round2(taxableSubtotal * 0.01);
                }
            } catch(e){ console.warn('withholding compute failed', e); }
            
            let status = document.getElementById('sale-status').value;
            let paidAmount = 0;
            
            // If it's a return, paid amount calculation is irrelevant/complex, stick to zero unless manually entered for simplicity
            if (finalTotal < 0) {
                status = 'due'; // Returns are usually 'due' (company owes customer) or simply tracked as returns
                paidAmount = 0;
            } else if (status === 'paid') {
                paidAmount = finalTotal;
            } else if (status === 'due') {
                paidAmount = 0;
            } else { // partial
                paidAmount = parseFloat(document.getElementById('sale-paid-amount').value) || 0;
                if (paidAmount >= finalTotal) {
                    await customDialog({ message: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹ ÙŠØ³Ø§ÙˆÙŠ Ø£Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ. Ø³ÙŠØªÙ… Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© "Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„".', title: 'ØªÙ†Ø¨ÙŠÙ‡' });
                    status = 'paid';
                    paidAmount = finalTotal;
                }
            }

            const saleData = {
                id: id || db.collection('sales').doc().id, // Generate Firestore ID if new
                date: new Date(date + 'T12:00:00Z').toISOString(),
                createdAt: id ? (state.sales.find(s=>s.id === id).createdAt || new Date().toISOString()) : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                repName: repName,
                customerId: customerId,
                invoiceNumber: parseInt(invoiceNumber),
                items: items.map(i => ({...i, discountPercent: 0})), // Simplified, spreadsheet saves discount per item
                subtotal: round2(subtotal),
                total: finalTotal,
                taxAmount: vatTotal,
                withholdingAmount: withholding,
                status: status,
                paidAmount: paidAmount,
                discount: discountPercent,
                additionPercent: additionPercent,
                notes: document.getElementById('sale-notes').value.trim(),
                taxFilingStatus: id ? (state.sales.find(s=>s.id === id).taxFilingStatus || '') : '' // Preserve tax status on edit
            };

            // If any item was marked adjusted, set reviewStatus to 'pending' so admin/reviewer can approve.
            try {
                if (saleNeedsReview) {
                    saleData.reviewStatus = 'pending';
                    saleData.reviewReason = 'adjusted';
                    try { saleData.reviewRequestedBy = (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : null; } catch(_){ }
                    saleData.reviewRequestedAt = new Date().toISOString();
                } else {
                    // preserve existing reviewStatus if editing
                    if (id) {
                        const existing = state.sales.find(s=>s.id===id);
                        if (existing && existing.reviewStatus) saleData.reviewStatus = existing.reviewStatus;
                    }
                }
            } catch(e){ console.warn('Setting review flag failed', e); }

            try {
                showLoading('Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©...');

                // Ø­ÙØ¸ Ø¹Ø¨Ø± Firestore Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† push Ù…Ø­Ù„ÙŠ
                saleData.includeInCash = true;
                saleData.collectionReportCreated = saleData.collectionReportCreated || false;
                saleData.paidToSafe = saleData.paidToSafe || false;

                if (id) {
                    await updateSale(id, saleData);
                } else {
                    await addSale(saleData);
                }

                hideLoading();
                closeModal(saleModal);
                // onSnapshot Ø³ÙŠØ¹ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                // Also sync cash data to cloud
                try {
                    if (typeof window.debouncedSaveCash === 'function') {
                        window.debouncedSaveCash();
                    }
                } catch(e){ console.warn('Cash cloud sync after sale save failed', e); }
                await customDialog({ message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.', title: 'Ù†Ø¬Ø§Ø­', confirmClass: 'bg-green-600 hover:bg-green-700' });
            } catch (error) {
                hideLoading(); // Hide loading indicator on error
                console.error('Error saving sale locally:', error);
                await customDialog({ message: 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + (error && error.message ? error.message : String(error)), title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', confirmClass: 'bg-red-600 hover:bg-red-700' });
            }
        }

        // --- END NEW FUNCTIONS ---

        function loadState() {
            // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„. Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙ‚Ø· Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©.
            if (!window.state) {
                window.state = { customers: [], products: [], sales: [], priceLists: [], dispatchNotes: [], reps: [], promotions: [], settings: { salesTarget: 10000 }, stockEntries: {}, invoiceHighlights: {}, highlightCounter: 0 };
            }
            // CRITICAL: Load stockEntries from localStorage if not already loaded
            try {
                if (!window.state.stockEntries || Object.keys(window.state.stockEntries).length === 0) {
                    const saved = localStorage.getItem('stock_entries');
                    if (saved) {
                        window.state.stockEntries = JSON.parse(saved);
                        console.log('âœ… Restored stockEntries from localStorage');
                    }
                }
            } catch(e){ console.warn('loadState: failed to restore stockEntries', e); }
            return window.state;
        }

        // If we detect an empty sales list but local backups exist, offer to restore the latest one.
        // Previously this immediately prompted the user to restore a local backup
        // when no sales were found. That caused an intrusive modal on startup.
        // We'll skip the interactive restore prompt and instead silently log
        // that backups exist (so the app doesn't interrupt the user).
        (function() {
            try {
                if ((!state.sales || state.sales.length === 0)) {
                    const backupsRaw = localStorage.getItem('mandoobiAppState_backups');
                    const backups = backupsRaw ? JSON.parse(backupsRaw) : [];
                    if (backups && backups.length > 0) {
                        // Do NOT prompt the user automatically. Keep backups available for manual restore.
                        console.info(`Found ${backups.length} local backups; automatic restore prompt suppressed.`);
                    }
                }
            } catch (e) {
                console.warn('Auto-restore check failed', e);
            }
        })();

        function saveState() {
            try {
                // If CLOUD_ONLY is enabled (Firebase initialized and user requested cloud-only), skip all local writes
                if (!window.CLOUD_ONLY) {
                    try {
                        localStorage.setItem('mandoobiAppState', JSON.stringify(state));
                    } catch (e) {
                        console.error('Failed to save main state to localStorage', e);
                    }

                    // Also keep a short rolling history of backups to help recovery
                    try {
                        const key = 'mandoobiAppState_backups';
                        const raw = localStorage.getItem(key);
                        const backups = raw ? JSON.parse(raw) : [];
                        // push latest snapshot (keep small to avoid huge localStorage)
                        backups.unshift({ ts: new Date().toISOString(), data: state });
                        // limit to 12 entries
                        while (backups.length > 12) backups.pop();
                        localStorage.setItem(key, JSON.stringify(backups));
                    } catch (e) {
                        // non-fatal
                        console.warn('Failed to save state backup', e);
                    }
                } else {
                    // In cloud-only mode we intentionally avoid persisting locally.
                    console.debug('CLOUD_ONLY: skipping local save and scheduling cloud save');
                }
            } catch (e) {
                console.warn('saveState wrapper error', e);
            }

            // Schedule a debounced cloud save if Firebase is available
            try {
                if (window.db && window.auth) {
                    scheduleCloudSave();
                } else if (window.CLOUD_ONLY) {
                    console.warn('CLOUD_ONLY enabled but Firebase not initialized; state will not be persisted to cloud yet.');
                }
            } catch (e) { console.warn('Failed to schedule cloud save', e); }
        }

        // Debounced cloud-save scheduler.
        // Ensures auth is available (attempts anonymous sign-in if needed), coalesces rapid saves,
        // and retries once on transient failure with simple backoff.
        function scheduleCloudSave(delayMs = 900) {
            // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù… ÙŠØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹Ø› Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ù„Ù„ØªÙˆØ§ÙÙ‚ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„.
            if (!window.db || !window.auth || !auth.currentUser) return;
            if (window.__cloudSaveTimer) clearTimeout(window.__cloudSaveTimer);
            window.__cloudSaveTimer = setTimeout(async ()=>{
                window.__cloudSaveTimer = null;
                try { await saveStateToFirebase(); } catch(e){ console.warn('Deprecated cloud save failed', e); }
            }, delayMs);
        }

        // Function to save state to Firebase
        async function saveStateToFirebase() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    console.log('No user logged in, skipping Firebase save');
                    return;
                }

                // Sanitize state Ø¥Ù„Ù‰ JSON Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¯ÙˆØ§Ù„ / Ø¹Ù‚Ø¯ DOM) Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ invalid nested entity
                function safeSerialize(val, depth=0){
                    if (depth > 6) return undefined; // Ø­Ø§Ø¬Ø² Ø­Ù…Ø§ÙŠØ©
                    if (val === null) return null;
                    const t = typeof val;
                    if (t === 'string' || t === 'number' || t === 'boolean') return val;
                    if (Array.isArray(val)) return val.map(v => safeSerialize(v, depth+1)).filter(v => v !== undefined);
                    if (t === 'object') {
                        if (val instanceof Date) return val.toISOString();
                        if (val.nodeType || (val.ownerDocument && val.defaultView)) return undefined; // DOM Node
                        const out = {}; Object.keys(val).forEach(k => {
                            const v = val[k];
                            if (typeof v === 'function') return;
                            const sv = safeSerialize(v, depth+1);
                            if (sv !== undefined) out[k] = sv;
                        });
                        return out;
                    }
                    return undefined; // ØªØ®Ø·ÙŠ Ø±Ù…ÙˆØ² ÙˆØ¯ÙˆØ§Ù„ ÙˆØ£Ø´ÙŠØ§Ø¡ Ø®Ø§ØµØ©
                }
                const cleanState = safeSerialize(state) || {};
                const userData = {
                    appState: cleanState,
                    lastUpdated: new Date().toISOString(),
                    email: currentUser.email
                };

                await db.collection('users').doc(currentUser.uid).set(userData, { merge: true });
                console.log('âœ… State saved to Firebase successfully');
            } catch (error) {
                console.warn('âš ï¸ Failed to save state to Firebase:', error);
                // Don't block the app if Firebase fails
            }
        }

        // Function to load state from Firebase
        async function loadStateFromFirebase() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    console.log('No user logged in, skipping Firebase load');
                    return null;
                }

                const docSnapshot = await db.collection('users').doc(currentUser.uid).get();
                if (docSnapshot.exists && docSnapshot.data().appState) {
                    console.log('âœ… State loaded from Firebase successfully');
                    return docSnapshot.data().appState;
                } else {
                    console.log('No data found in Firebase for this user');
                    return null;
                }
            } catch (error) {
                console.warn('âš ï¸ Failed to load state from Firebase:', error);
                return null;
            }
        }

        // Ù…Ù‡Ø§Ø¬Ø±Ù‡ Ø·Ø§Ø±Ø¦Ø©: Ù„Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ø© sales ÙØ§Ø¶ÙŠØ© Ù„ÙƒÙ† ÙÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø®Ø²Ù‘Ù†Ø© Ø¯Ø§Ø®Ù„ users/{uid}.appState.sales
        // Ù†Ø³ØªÙˆØ±Ø¯Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© sales Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©.
        async function migrateSalesFromUserDocIfFound(){
            try {
                if (!window.db || !window.auth) return;
                const u = auth.currentUser; if (!u) return;
                // Ù„Ø§ ØªÙƒØ±Ø± Ø§Ù„Ù‡Ø¬Ø±Ø© Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
                const MIG_KEY = 'migrated_sales_from_userdoc_v1';
                if (localStorage.getItem(MIG_KEY) === 'done') return;

                // Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø£Ùˆ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ Ù„Ø§ Ù†Ø¹Ù…Ù„ Ù‡Ø¬Ø±Ø©
                if (Array.isArray(window.state?.sales) && window.state.sales.length > 0) return;
                const salesSnap = await db.collection('sales').limit(1).get().catch(()=>null);
                if (salesSnap && !salesSnap.empty) return;

                const userDoc = await db.collection('users').doc(u.uid).get();
                const appState = userDoc.exists ? (userDoc.data() || {}).appState : null;
                const legacySales = Array.isArray(appState?.sales) ? appState.sales : [];
                if (!legacySales.length) return;

                console.warn('Migrating sales from users/' + u.uid + '.appState.sales -> sales collection. Count=', legacySales.length);
                let batch = db.batch(); let pending = 0;
                function commitIfNeeded(force){ return force || pending >= 450 ? batch.commit().then(()=>{ batch = db.batch(); pending = 0; }) : Promise.resolve(); }

                for (const s of legacySales){
                    try {
                        const sid = String(s.id || s.invoiceNumber || db.collection('sales').doc().id);
                        const items = Array.isArray(s.items) ? s.items.map(it => ({
                            productId: it.productId || it.id || it.code || '',
                            qty: Number(it.qty || it.quantity || it.q || 0),
                            price: Number(it.price || it.p || 0)
                        })) : [];
                        const total = Number(s.total || s.finalTotal || s.amount || 0);
                        const paidAmount = Number(s.paidAmount || s.paid || 0);
                        const discountPercent = Number(s.discountPercent || s.discount || 0);
                        const dateIso = s.date ? new Date(s.date).toISOString() : new Date().toISOString();
                        const docRef = db.collection('sales').doc(sid);
                        batch.set(docRef, {
                            id: sid,
                            invoiceNumber: s.invoiceNumber || null,
                            customerId: s.customerId || (s.customer && (s.customer.id || s.customerId)) || null,
                            repName: s.repName || s.repId || '',
                            items,
                            total,
                            paidAmount,
                            status: s.status || 'due',
                            discountPercent,
                            taxFilingStatus: s.taxFilingStatus || '',
                            date: dateIso,
                            createdAt: serverTs(),
                            updatedAt: serverTs()
                        }, { merge: true });
                        pending++; await commitIfNeeded(false);
                    } catch(e){ console.warn('migrate sale record failed', e); }
                }
                await commitIfNeeded(true);
                localStorage.setItem(MIG_KEY, 'done');
                console.log('âœ… Migration of legacy sales complete');
            } catch(e){ console.warn('migrateSalesFromUserDocIfFound error', e); }
        }

        function getStatusBadge(status) {
            let text, color; if (status === 'paid') { text = 'Ù…Ø¯ÙÙˆØ¹'; color = 'bg-green-100 text-green-800'; } else if (status === 'due') { text = 'Ø¢Ø¬Ù„'; color = 'bg-red-100 text-red-800'; } else if (status === 'partial') { text = 'Ø¬Ø²Ø¦ÙŠ'; color = 'bg-yellow-100 text-yellow-800'; } else { text = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; color = 'bg-gray-100 text-gray-800'; } return `<span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${color}">${text}</span>`;
        }
        
        function getTaxStatusBadge(sale) {
            const customer = findCustomer(sale.customerId); 
            // FIX: Use `requiresTaxFiling` which is correctly set in loadState
            const requiresFiling = customer?.requiresTaxFiling;

            if (!requiresFiling) { return ''; } // No badge if not required
            
            const taxStatus = sale.taxFilingStatus;
            const isFiled = taxStatus && taxStatus.trim().toLowerCase() === 'ØªÙ…';

            if (isFiled) {
                // Blue "Filed" button (to differentiate from 'Paid' green badge)
                return `
                    <button 
                        class="tax-status-toggle-btn text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 flex items-center gap-1"
                        data-id="${sale.id}"
                    >
                        <i data-lucide="check" class="w-3 h-3"></i> ØªÙ… Ø§Ù„Ø±ÙØ¹
                    </button>
                `;
            } else {
                // Red "Not Filed" button
                const statusText = taxStatus && taxStatus.trim() !== '' ? taxStatus : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹';
                return `
                    <button 
                        class="tax-status-toggle-btn text-xs font-medium px-2.5 py-0.5 rounded-full tax-not-filed-badge flex items-center gap-1"
                        data-id="${sale.id}"
                    >
                        <i data-lucide="x" class="w-3 h-3"></i> ${statusText}
                    </button>
                `;
            }
        }
        
        function populatePriceListDropdown(selectEl, selectedPriceListId = '') {
            selectEl.innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© --</option>' + state.priceLists.map(pl => `<option value="${pl.id}" ${pl.id === selectedPriceListId ? 'selected' : ''}>${pl.name}</option>`).join('');
        }

        function populateCustomerDropdown(selectEl, selectedCustomerId = '') {
            selectEl.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option>' + state.customers.map(c => `<option value="${c.id}" ${c.id === selectedCustomerId ? 'selected' : ''}>${c.name}</option>`).join('');
        }

        function checkAndShowAutoStatement() {
             const today = new Date(); const day = today.getDate(); const year = today.getFullYear(); const month = today.getMonth(); const lastDayOfMonth = new Date(year, month + 1, 0).getDate(); const isStatementDay = [10, 20, lastDayOfMonth].includes(day); if (!isStatementDay) return; const periodIdentifier = `${year}-${month}-${day}`; const lastShownIdentifier = localStorage.getItem('lastStatementShown'); if (lastShownIdentifier === periodIdentifier) return; let startDate, endDate; endDate = new Date(year, month, day); if (day <= 10) startDate = new Date(year, month, 1); else if (day <= 20) startDate = new Date(year, month, 11); else startDate = new Date(year, month, 21); const exceptionCustomerIds = state.customers.filter(c => c.name.includes("Ø§ÙƒØ³Ø¨Ø´Ù† Ù…Ø§Ø±ÙƒØª")).map(c => c.id); if (exceptionCustomerIds.length === 0) return; const endDateForCheck = new Date(endDate); endDateForCheck.setHours(23,59,59,999); const hasRelevantSales = state.sales.some(sale => { const saleDate = new Date(sale.date); return exceptionCustomerIds.includes(sale.customerId) && saleDate >= startDate && saleDate <= endDateForCheck; }); if (hasRelevantSales) { localStorage.setItem('lastStatementShown', periodIdentifier); generateAndShowStatement(startDate, endDate, exceptionCustomerIds, 'ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ', 'Ø§ÙƒØ³Ø¨Ø´Ù† Ù…Ø§Ø±ÙƒØª (Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹)'); }
        }
        
        function renderPriceListsPage() {
            const container = document.getElementById('all-price-lists-container');
            if (!container) return;
            // Render only when price-lists page is active/visible to avoid heavy work during background updates
            try {
                const page = document.getElementById('page-price-lists');
                const hiddenByDisplay = page && (page.style.display === 'none' || !page.classList.contains('active'));
                if (!page || hiddenByDisplay) { return; }
            } catch(_){}
            // Defensive: make sure container is visible and cleared
            try { container.style.display = ''; } catch(e) {}
            container.innerHTML = '';
            // Debug log
            try { console.log('renderPriceListsPage called â€” priceLists:', (state.priceLists || []).length, 'products:', (state.products || []).length); } catch(e) {}

            // 1. Find and display customers without a price list
            const customersWithoutPriceList = state.customers.filter(c => !c.priceListId);
            if (customersWithoutPriceList.length > 0) {
                const noListEl = document.createElement('div');
                noListEl.className = 'bg-yellow-50 p-4 rounded-lg border border-yellow-200 shadow-sm mb-6';
                const customerNames = customersWithoutPriceList.map(c => `<span class="bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full">${c.name}</span>`).join('');
                noListEl.innerHTML = `
                    <h3 class="font-bold text-lg text-yellow-800 mb-3">Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ù…Ø­Ø¯Ø¯Ø©</h3>
                    <p class="text-sm text-gray-600 mb-3">Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙŠØ³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹ÙŠÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ù„Ù‡Ù… Ù…Ù† ØµÙØ­Ø© "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡".</p>
                    <div class="flex flex-wrap gap-2">
                        ${customerNames}
                    </div>
                `;
                container.appendChild(noListEl);
            }

            if (!state.priceLists || state.priceLists.length === 0) {
                container.innerHTML += '<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹Ø±ÙØ©.</p>';
                return;
            }

            // Create a mapping of which customers use which price list
            const customersByPriceList = {};
            state.customers.forEach(customer => {
                if (customer.priceListId) {
                    if (!customersByPriceList[customer.priceListId]) {
                        customersByPriceList[customer.priceListId] = [];
                    }
                    customersByPriceList[customer.priceListId].push(customer.name);
                }
            });

            state.priceLists.sort((a, b) => a.name.localeCompare(b.name)).forEach(priceList => {
                const productPrices = priceList.productPrices || {};
                const productItems = Object.keys(productPrices).map(productId => {
                    const product = findProduct(productId);
                    const price = productPrices[productId];
                    if (!product) return ''; // Skip if product not found
                    return `
                        <li class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 text-sm">
                            <span>${product.name} <span class="text-xs text-gray-400">(${product.id})</span></span>
                            <span class="font-bold text-blue-600">${formatCurrency(price)}</span>
                        </li>
                    `;
                }).join('');

                // Get customers associated with this price list
                const associatedCustomers = customersByPriceList[priceList.id] || [];
                const customersHtml = associatedCustomers.length > 0
                    ? `<div class="mt-4 pt-3 border-t border-gray-100">
                           <h4 class="font-semibold text-sm text-gray-700 mb-2">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø·Ø¨Ù‚ Ø¹Ù„ÙŠÙ‡Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:</h4>
                           <div class="flex flex-wrap gap-2">
                               ${associatedCustomers.map(name => `<span class="bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full">${name}</span>`).join('')}
                           </div>
                       </div>`
                    : '<p class="text-xs text-gray-400 mt-4 pt-3 border-t border-gray-100">Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ù…Ø·Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…ÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';

                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm mb-4';
                el.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">${priceList.name}</h3>
                    <div class="max-h-60 overflow-y-auto mt-3 pr-2">
                        ${productItems.length > 0 ? `<ul class="divide-y divide-gray-200">${productItems}</ul>` : '<p class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø± Ø®Ø§ØµØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</p>'}
                    </div>
                    ${customersHtml}
                `;
                container.appendChild(el);
            });
            updateIcons();
        }

        // ===== Price Lists Page (single selection) =====
        function normalizeSpaces(s){ return (s||'').toString().replace(/\s+/g,' ').trim(); }
        function initPriceListsPage(){
            try {
                const modeSel = document.getElementById('pl-filter-mode');
                const sel = document.getElementById('pl-selector');
                const printBtn = document.getElementById('pl-print');
                const imageBtn = document.getElementById('pl-image');
                const discountInput = document.getElementById('pl-global-discount');
                if (!modeSel || !sel) return;
                populatePlSelector();
                modeSel.onchange = () => populatePlSelector();
                sel.onchange = () => renderSelectedPriceList();
                if (printBtn) printBtn.onclick = () => printSection('pl-sheet-container');
                if (imageBtn) imageBtn.onclick = () => generateReportImage('pl-sheet-container');
                if (discountInput){
                    discountInput.addEventListener('input', () => renderSelectedPriceList());
                }
                renderSelectedPriceList();
            } catch(e){ console.warn('initPriceListsPage error', e); }
        }
        function populatePlSelector(){
            const modeSel = document.getElementById('pl-filter-mode');
            const sel = document.getElementById('pl-selector');
            if (!modeSel || !sel) return;
            const mode = modeSel.value || 'customer';
            if (mode === 'customer'){
                // Exclude specific customers per request
                const excluded = new Set(['Ø¹Ù…ÙŠÙ„ Ø¬Ù…Ù„Ù‡ ÙˆØ§Ø­Ø¯','Ø¹Ù…ÙŠÙ„ Ù‚Ø·Ø§Ø¹ÙŠ Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù…ÙŠÙ„  Ù‚Ø·Ø§Ø¹ÙŠ Ø§Ø«Ù†ÙŠÙ†'].map(normalizeSpaces));
                const options = [];
                
                // Add customers
                const list = (state.customers||[])
                  .filter(c => !excluded.has(normalizeSpaces(c.name)))
                  .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                options.push(...list.map(c => `<option value="cust:${c.id}">${escapeHtml(c.name||'')}</option>`));
                
                // Add chains
                const chains = loadChains();
                if (chains.length > 0) {
                    options.push('<optgroup label="Ø§Ù„Ø³Ù„Ø§Ø³Ù„">');
                    chains.forEach(chain => {
                        options.push(`<option value="chain:${chain.id}">[Ø³Ù„Ø³Ù„Ø©] ${escapeHtml(chain.name||'')}</option>`);
                    });
                    options.push('</optgroup>');
                }
                
                sel.innerHTML = options.join('');
            } else {
                const list = (state.priceLists||[]).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                sel.innerHTML = list.map(pl => `<option value="pl:${pl.id}">${escapeHtml(pl.name||pl.id)}</option>`).join('');
            }
        }
        function renderSelectedPriceList(){
            const modeSel = document.getElementById('pl-filter-mode');
            const sel = document.getElementById('pl-selector');
            const dateEl = document.getElementById('pl-date');
            const custNameEl = document.getElementById('pl-customer-name');
            if (!sel) return;
            const v = sel.value || '';
            if (dateEl) dateEl.textContent = new Date().toLocaleDateString('ar-EG');
            if (v.startsWith('cust:')){
                const cid = v.slice(5);
                const c = (state.customers||[]).find(x => (x.id||x._id) === cid);
                const plId = c?.priceListId || '';
                if (custNameEl) custNameEl.textContent = c ? (c.name||'') : '';
                renderPriceListSheet(plId, c?.name||'');
            } else if (v.startsWith('chain:')){
                const chainId = v.slice(6);
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (custNameEl) custNameEl.textContent = chain ? '[Ø³Ù„Ø³Ù„Ø©] ' + chain.name : '';
                // For chains, we don't have a single price list, so show a message or show first customer's price list
                if (chain && chain.customerIds.length > 0){
                    const firstCustId = chain.customerIds[0];
                    const firstCust = (state.customers||[]).find(x => (x.id||x._id) === firstCustId);
                    const plId = firstCust?.priceListId || '';
                    renderPriceListSheet(plId, chain.name||'');
                } else {
                    renderPriceListSheet('', chain?.name||'');
                }
            } else if (v.startsWith('pl:')){
                const plId = v.slice(3);
                if (custNameEl) custNameEl.textContent = '';
                renderPriceListSheet(plId, '');
            }
            updateIcons();
        }
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ø±ÙƒÙˆØ¯Ù‡Ø§ (Ø²Ø¨Ø§Ø¯ÙŠ / Ø£Ø±Ø² / Ø³Ù…Ù†Ø© / Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§ / Ø§Ù„Ù…Ø¹Ù„Ø¨Ø§Øª)
        function isBarcodeEditable(name){
            try {
                const n = (name||'').replace(/\s+/g,' ').trim();
                return /(Ø²Ø¨Ø§Ø¯ÙŠ|Ø²Ø¨Ø§Ø¯Ù‰|Ø£Ø±Ø²|Ø±Ø²|Ø³Ù…Ù†Ø©|Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§|Ù…ÙˆØ²Ø±ÙŠÙ„Ø§|Ù…ÙˆØ±ØªØ©|Ø§Ù„Ù…ÙˆØ±ØªØ©|Ù…Ø¹Ù„Ø¨Ø§Øª)/.test(n);
            } catch(e){ return false; }
        }
        function renderPriceListSheet(priceListId, customerName){
            const cont = document.getElementById('pl-sheet-container');
            if (!cont){ return; }
            cont.innerHTML = '';
            const pl = (state.priceLists||[]).find(x => x.id === priceListId) || null;
            if (!pl){
                cont.innerHTML = '<div class="text-center text-gray-500 p-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ù…Ø­Ø¯Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.</div>';
                return;
            }
            const prices = pl.productPrices || {};
            const discountInput = document.getElementById('pl-global-discount');
            const discountPercent = discountInput ? Math.max(0, Number(discountInput.value||0)) : 0;
            const rows = Object.keys(prices).map(pid => {
                const prod = findProduct(pid) || { id: pid, name: pid, unit: '', sku: '' };
                return { pid, name: prod.name||pid, unit: prod.unit||'', barcode: prod.barcode||prod.sku||'', price: Number(prices[pid]||0) };
            }).sort((a,b)=> a.name.localeCompare(b.name));
            const thead = `<thead><tr>
                <th>Ù…</th>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„ØµÙ†Ù</th>
                <th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø¶Ø±ÙŠØ¨Ø©</th>
                <th>Ø®ØµÙ…</th>
                <th>ØµØ§ÙÙŠ Ø§Ù„Ø³Ø¹Ø±</th>
            </tr></thead>`;
            let i = 0; const tbody = rows.map(r => {
                i++;
                const discountAmt = discountPercent ? (r.price * discountPercent / 100) : 0;
                const net = r.price - discountAmt;
                const editable = isBarcodeEditable(r.name);
                const barcodeCell = editable
                    ? `<input type="text" class="barcode-input border rounded px-1 py-0.5 text-sm w-32 focus:outline-none focus:ring-1 focus:ring-blue-400" data-pid="${escapeHtml(r.pid)}" value="${escapeHtml(r.barcode||'')}" placeholder="Ø¨Ø§Ø±ÙƒÙˆØ¯" />`
                    : `${escapeHtml(r.barcode||'')}`;
                return `<tr>
                    <td>${i}</td>
                    <td>${escapeHtml(r.pid)}</td>
                    <td class="name">${escapeHtml(r.name)}</td>
                    <td>${barcodeCell}</td>
                    <td>${escapeHtml(r.unit||'')}</td>
                    <td>${formatCurrency(r.price)}</td>
                    <td></td>
                    <td>${discountPercent ? formatCurrency(discountAmt) : ''}</td>
                    <td>${formatCurrency(net)}</td>
                </tr>`;
            }).join('');
            cont.innerHTML = `<table class="price-sheet">${thead}<tbody>${tbody}</tbody></table>`;

            // Ù…Ø³ØªÙ…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
            function handleBarcodeSave(e){
                const el = e.target;
                if (!el.classList.contains('barcode-input')) return;
                const val = el.value.trim();
                const pid = el.getAttribute('data-pid');
                if (!pid || !window.db) return;
                el.disabled = true;
                updateProduct(pid, { barcode: val }).then(()=>{
                    try {
                        const prod = (state.products||[]).find(p => (p.id||p._id) === pid);
                        if (prod) prod.barcode = val;
                    } catch(e){}
                    el.classList.remove('border-red-400');
                    el.classList.add('border-green-400');
                }).catch(()=>{
                    el.classList.add('border-red-400');
                }).finally(()=>{
                    el.disabled = false;
                });
            }
            cont.querySelectorAll('input.barcode-input').forEach(inp => {
                inp.addEventListener('change', handleBarcodeSave);
                inp.addEventListener('blur', handleBarcodeSave);
            });
        }

        // ===== Remove unwanted customers once (delete from Firestore) =====
        async function attemptDeleteSpecificCustomersOnce(){
            try {
                if (!window.db) return;
                // Ø±ÙØ¹ Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø­ØªÙ‰ ØªÙÙ†ÙÙ‘Ø° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const FLAG_KEY = 'deleted_named_customers_v3';
                if (localStorage.getItem(FLAG_KEY) === 'done') return;
                const variants = [
                    'Ø¹Ù…ÙŠÙ„ Ø¬Ù…Ù„Ù‡ ÙˆØ§Ø­Ø¯','Ø¹Ù…ÙŠÙ„ Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯','Ø¹Ù…ÙŠÙ„  Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯','Ø¹Ù…ÙŠÙ„  Ø¬Ù…Ù„Ù‡ ÙˆØ§Ø­Ø¯',
                    'Ø¹Ù…ÙŠÙ„ Ù‚Ø·Ø§Ø¹ÙŠ Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù…ÙŠÙ„  Ù‚Ø·Ø§Ø¹ÙŠ Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù…ÙŠÙ„ Ù‚Ø·Ø§Ø¹Ù‰ Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù…ÙŠÙ„  Ù‚Ø·Ø§Ø¹Ù‰ Ø§Ø«Ù†ÙŠÙ†'
                ];
                const normSet = new Set(variants.map(v => normalizeSpaces(v)));
                const targets = (state.customers||[]).filter(c => normSet.has(normalizeSpaces(c.name)));
                for (const c of targets){
                    try { await db.collection('customers').doc(c.id||c._id).delete(); } catch(e){ /* ignore */ }
                }
                if (targets.length) localStorage.setItem(FLAG_KEY,'done');
            } catch(e){ /* ignore */ }
        }

        // ===== Inquiry Report Logic (Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: Ù†Ø·Ø§Ù‚ ØªØ§Ø±ÙŠØ® + Ø¹Ù…Ù„Ø§Ø¡ Ù…ØªØ¹Ø¯Ø¯ÙŠÙ†) =====
        function initInquiryDropdown(){
            try {
                const multiSel = document.getElementById('inq-customers');
                if (!multiSel) return;
                const previous = new Set(Array.from(multiSel.selectedOptions).map(o => o.value));
                
                // Build options: customers + chains
                const options = [];
                
                // Add customers
                (state.customers||[])
                    .filter(c => !/Ø§ÙƒØ³Ø¨Ø´Ù†/.test(c.name||'') || !/(Ø­Ù„ÙˆØ§Ù†ÙŠ|Ø­Ù„ÙˆØ§Ù†Ù‰)/.test(c.name||''))
                    .forEach(c => {
                        options.push(`<option value="${c.id||c._id}" ${previous.has(c.id||c._id)?'selected':''}>${escapeHtml(c.name||'')}</option>`);
                    });
                
                // Add chains
                const chains = loadChains();
                if (chains.length > 0) {
                    options.push('<optgroup label="Ø§Ù„Ø³Ù„Ø§Ø³Ù„">');
                    chains.forEach(chain => {
                        options.push(`<option value="chain-${chain.id}" ${previous.has('chain-'+chain.id)?'selected':''}>[Ø³Ù„Ø³Ù„Ø©] ${escapeHtml(chain.name||'')}</option>`);
                    });
                    options.push('</optgroup>');
                }
                
                multiSel.innerHTML = options.join('');
            } catch(e){ console.warn('initInquiryDropdown failed', e); }
        }
        function generateInquiryReport(){
            const fromStr = document.getElementById('inq-date-from')?.value || '';
            const toStr = document.getElementById('inq-date-to')?.value || '';
            const multiSel = document.getElementById('inq-customers');
            const selectedIds = multiSel ? Array.from(multiSel.selectedOptions).map(o=>o.value) : [];
            const headEl = document.getElementById('inq-report-head');
            const bodyEl = document.getElementById('inq-report-body');
            const summaryEl = document.getElementById('inq-summary');
            const breakdownEl = document.getElementById('inq-customers-breakdown');
            if (!headEl || !bodyEl) return;
            if (!fromStr || !toStr){ bodyEl.innerHTML = '<tr><td colspan="5" class="text-center text-red-600">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©.</td></tr>'; return; }
            const start = new Date(fromStr+'T00:00:00');
            const end = new Date(toStr+'T23:59:59');
            if (start > end){ bodyEl.innerHTML = '<tr><td colspan="5" class="text-center text-red-600">Ø§Ù„Ù†Ø·Ø§Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­.</td></tr>'; return; }
            
            // Expand chain IDs to actual customer IDs
            let expandedIds = [];
            const chains = loadChains();
            selectedIds.forEach(id => {
                if (id.startsWith('chain-')) {
                    const chainId = id.substring(6);
                    const chain = chains.find(c => c.id === chainId);
                    if (chain) expandedIds.push(...(chain.customerIds || []));
                } else {
                    expandedIds.push(id);
                }
            });
            
            const includeAll = selectedIds.length === 0;
            const idSet = new Set(expandedIds);
            const prodAgg = {}; // pid -> { name, qty, totalValue, unitPrice }
            const filteredSales = (state.sales||[]).filter(s => {
                const d = new Date(s.date);
                if (isNaN(d)) return false;
                if (d < start || d > end) return false;
                if (!includeAll && !idSet.has(s.customerId)) return false;
                return true;
            });
            filteredSales.forEach(s => {
                (s.items||[]).forEach(it => {
                    const pid = it.productId || it.pid || it.productID; const prod = findProduct(pid); if (!prod) return;
                    const qty = Number(it.quantity||it.qty||0);
                    const price = Number(it.unitPrice||it.price||(prod.price||0));
                    if (!prodAgg[pid]) prodAgg[pid] = { name: prod.name||pid, qty:0, totalValue:0, unitPrice: price };
                    prodAgg[pid].qty += qty;
                    prodAgg[pid].totalValue += qty * price;
                });
            });
            const productIds = Object.keys(prodAgg).sort((a,b)=> (prodAgg[a].name||'').localeCompare(prodAgg[b].name||''));
            headEl.innerHTML = '<tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th><th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>';
            let totalAll = 0, totalQtyAll = 0;
            const rowsHtml = productIds.map(pid => {
                const p = prodAgg[pid];
                totalAll += p.totalValue; totalQtyAll += p.qty;
                return `<tr><td>${escapeHtml(pid)}</td><td class='prod-name'>${escapeHtml(p.name)}</td><td class='qty-cell'>${p.qty}</td><td>${formatCurrency(p.unitPrice)}</td><td class='total-cell'>${formatCurrency(p.totalValue)}</td></tr>`;
            }).join('');
            bodyEl.innerHTML = rowsHtml || '<tr><td colspan="5" class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.</td></tr>';
            const distinctCustomers = new Set(filteredSales.map(s=>s.customerId)).size;
            summaryEl.innerHTML = `
                <div class='card'><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</span><span class='val'>${productIds.length}</span></div>
                <div class='card'><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</span><span class='val'>${totalQtyAll}</span></div>
                <div class='card'><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</span><span class='val'>${formatCurrency(totalAll)}</span></div>
                <div class='card'><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span><span class='val'>${distinctCustomers}</span></div>`;
            // Breakdown per customer
            if (breakdownEl){
                const custAgg = {};
                filteredSales.forEach(s => {
                    if (!custAgg[s.customerId]) custAgg[s.customerId] = { qty:0, value:0 };
                    (s.items||[]).forEach(it => {
                        const q = Number(it.quantity||it.qty||0);
                        const pr = Number(it.unitPrice||it.price||0);
                        custAgg[s.customerId].qty += q;
                        custAgg[s.customerId].value += q * pr;
                    });
                });
                const rowsCust = Object.entries(custAgg).map(([cid, data]) => {
                    const cObj = (state.customers||[]).find(c => (c.id||c._id) === cid);
                    return `<tr><td>${escapeHtml(cObj?.name||cid||'')}</td><td class='text-center'>${data.qty}</td><td class='text-center'>${formatCurrency(data.value)}</td></tr>`;
                }).join('');
                breakdownEl.innerHTML = rowsCust ? `<h3 class='font-bold mb-2 text-sm'>ØªÙØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</h3><table class='text-xs w-full border-collapse'><thead><tr class='bg-gray-700 text-white'><th class='p-1 border'>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class='p-1 border'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</th><th class='p-1 border'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody>${rowsCust}</tbody></table>` : '';
            }
            updateIcons();
        }
        document.addEventListener('DOMContentLoaded', function(){
            try { initPriceListsPage(); } catch(e){}
            try { initInquiryDropdown(); } catch(e){}
            const genBtn = document.getElementById('inq-generate-btn');
            const printBtn = document.getElementById('inq-print-btn');
            const imgBtn = document.getElementById('inq-image-btn');
            if (genBtn) genBtn.addEventListener('click', generateInquiryReport);
            if (printBtn) printBtn.addEventListener('click', ()=> printSection('page-inquiry'));
            if (imgBtn) imgBtn.addEventListener('click', ()=> generateReportImage('page-inquiry'));
            // live filter
            const filterInput = document.getElementById('inq-customer-filter');
            if (filterInput){
                filterInput.addEventListener('input', () => {
                    const term = filterInput.value.trim();
                    const multiSel = document.getElementById('inq-customers');
                    if (!multiSel) return;
                    const selected = new Set(Array.from(multiSel.selectedOptions).map(o=>o.value));
                    multiSel.innerHTML = (state.customers||[])
                        .filter(c => !/Ø§ÙƒØ³Ø¨Ø´Ù†/.test(c.name||'') || !/(Ø­Ù„ÙˆØ§Ù†ÙŠ|Ø­Ù„ÙˆØ§Ù†Ù‰)/.test(c.name||''))
                        .filter(c => !term || (c.name||'').includes(term))
                        .map(c => `<option value="${c.id||c._id}" ${selected.has(c.id||c._id)?'selected':''}>${escapeHtml(c.name||'')}</option>`)
                        .join('');
                });
            }
        });

        // Add quick listeners for debts page action buttons (show reps / show customers)
        document.addEventListener('DOMContentLoaded', () => {
            const showRepsBtn = document.getElementById('debts-show-reps-btn');
            const showCustomersBtn = document.getElementById('debts-show-customers-btn');
            if (showRepsBtn) {
                showRepsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Navigate to rep-debts page which lists all reps and their balances
                    if (typeof navigateTo === 'function') navigateTo('rep-debts');
                });
            }
            if (showCustomersBtn) {
                showCustomersBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Navigate to customers page
                    if (typeof navigateTo === 'function') navigateTo('customers');
                });
            }
        });

        // Refresh button handler: force a re-render of debts table
        document.addEventListener('DOMContentLoaded', () => {
            const refreshBtn = document.getElementById('debts-refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    try {
                        if (typeof renderDebts === 'function') renderDebts();
                    } catch (err) {
                        console.error('Failed to refresh debts:', err);
                    }
                });
            }
        });

        function navigateTo(pageId) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ·Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (pageId === 'sales' || pageId === 'reports' || pageId === 'debts') {
                try { ensureDefaultActivePeriod(); } catch(e){}
            }
            
            // Restrict pages by role (central guard)
            try {
                if (!canAccessPage(pageId)) {
                    if (typeof lastRequestedPage !== 'undefined' && lastRequestedPage === pageId) {
                        try { customDialog({ title:'ØºÙŠØ± Ù…ØµØ±Ø­', message:'ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ù„Ø§ ØªØ³Ù…Ø­ Ø¨ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.' }); } catch(_) { alert('ØºÙŠØ± Ù…ØµØ±Ø­'); }
                    }
                    pageId = 'dashboard';
                }
            } catch(e){}
            // Avoid redundant heavy re-renders when navigating to the same page repeatedly
            try {
                if (window.__currentPage === pageId) { updateIcons(); return; }
                window.__currentPage = pageId;
            } catch(_){}
            // Clear inline display and classes for all pages, rely purely on CSS
            document.querySelectorAll('.page').forEach(p => { p.classList.remove('active'); p.style.display=''; }); 
            const pageEl = document.getElementById(`page-${pageId}`); 
            
            // Handle reports page activation differently
            if (pageId === 'reports') {
                pageEl.classList.add('active');
                reportsSubnav.classList.add('active');
                initializeReportsPage();
            } else {
                 // Deactivate reports subnav for all other pages
                reportsSubnav.classList.remove('active'); 
            }
            
            if (pageEl) { pageEl.classList.add('active'); } else { console.error(`Page element not found for ID: page-${pageId}`); } 
            
            document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active')); 
            const navButton = document.querySelector(`.bottom-nav-item[data-page="${pageId}"]`); 
            if (navButton) navButton.classList.add('active'); 
            
            const titles = { dashboard: 'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', 'spreadsheet-entry': 'Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹', sales: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', dispatch: 'Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', reports: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©', promotions: 'Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©', customers: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', reps: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨', 'rep-debts': 'Ù…Ø¯ÙŠÙˆÙ†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨', 'total-bills': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±', 'price-lists': 'Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±', settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'finished-products': 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ØªØ§Ù…', 'raw-materials': 'Ø§Ù„Ø®Ø§Ù…Ø§Øª', packaging: 'Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ÙˆØ§Ù„ØªØºÙ„ÙŠÙ', 'stock-control': 'Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'collection-receipt': 'ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„', 'cash': 'Ø§Ù„ÙƒØ§Ø´', 'taxes': 'Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨', 'costs': 'Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ' }; 
            headerTitle.textContent = titles[pageId] || 'ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø¯ÙˆØ¨ÙŠ'; 
            // if leaving stock-control, hide internal subviews
            if(pageId !== 'stock-control'){
                try{
                    document.querySelectorAll('.stock-subpage').forEach(s=>s.classList.add('hidden'));
                    ['stock-subbtn-finished-products','stock-subbtn-raw-materials','stock-subbtn-packaging'].forEach(id=>{const b=document.getElementById(id); if(b) b.classList.remove('ring','ring-2');});
                }catch(e){}
            }
            
            if (pageId === 'dashboard') { 
                renderDashboard(); 
                renderSales7DaysChart(); 
                renderTopRepsChart(); 
                renderTopProductsChart(); 
                renderTopCustomersChart(); 
            } else if (pageId === 'sales') {
                // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¹ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø·Ø©
                try { 
                    renderAllSales('', '', 'all');
                    console.log(`Sales page loaded with activePeriod: ${window.state?.activePeriod}`);
                } catch(e){ console.warn('renderAllSales failed', e); }
            } else if (pageId === 'spreadsheet-entry') { 
                initializeSpreadsheetPage(); 
            } else if (pageId === 'promotions') { 
                renderPromotions(); 
            } else if (pageId === 'debts') { 
                renderDebts(); 
            } else if (pageId === 'rep-debts') { 
                renderRepDebts(); 
            } else if (pageId === 'total-bills'){
                initTotalBillsPage();
            } else if (pageId === 'stock-control') {
                try { 
                    if (window.inventorySystem && window.inventorySystem.loadInventoryData) {
                        window.inventorySystem.loadInventoryData('raw');
                    }
                } catch(e){ console.warn('loadInventoryData failed', e); }
            } else if (pageId === 'finished-products') {
                try { renderStockLedgerForFinishedProducts(); } catch(e){ console.warn('renderFinishedProducts failed', e); }
            } else if (pageId === 'dispatch') {
                try { initializeNewDispatchGrid(); } catch(_){}
                try { renderDispatchPage(); } catch(_){}
            } else if (pageId === 'price-lists') {
                initPriceListsPage();
            } else if (pageId === 'production') {
                try { 
                    // First try to load from Firebase to get latest data
                    if (window.loadProductionsFromFirebase) {
                        window.loadProductionsFromFirebase().then(() => {
                            if (window.renderProductionsList) window.renderProductionsList();
                        }).catch(err => {
                            console.warn('Firebase load failed, using local data:', err);
                            if (window.renderProductionsList) window.renderProductionsList();
                        });
                    } else if (window.renderProductionsList) {
                        window.renderProductionsList();
                    }
                } catch(err) { 
                    console.warn('renderProductionsList failed:', err); 
                }
            } else if (pageId === 'cash') {
                try { renderCash(); } catch(e){ console.warn('renderCash failed', e); }
            } else if (pageId === 'taxes') {
                try { renderTaxesPage(); } catch(e){ console.warn('renderTaxesPage failed', e); }
            } else if (pageId === 'costs') {
                try { renderCostsPage(); } catch(e){ console.warn('renderCostsPage failed', e); }
            }
            updateIcons();
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        function applyRoleNavRestrictions(){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const buttons = Array.from(document.querySelectorAll('.bottom-nav .bottom-nav-item'));
                const allow = ROLE_PAGE_ALLOW[role];
                if (!allow || allow === 'ALL') { buttons.forEach(btn => btn.style.display = ''); return; }
                buttons.forEach(btn => {
                    const p = btn.getAttribute('data-page');
                    if (allow.has(p)) btn.style.display = '';
                    else btn.style.display = 'none';
                });
            } catch(_){ }
        }
        document.addEventListener('DOMContentLoaded', applyRoleNavRestrictions);
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¨Ø¹Ø¯ 1 Ùˆ 3 Ø«ÙˆØ§Ù†Ù Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ø¯ÙˆØ± ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡
        setTimeout(applyRoleNavRestrictions, 1000);
        setTimeout(applyRoleNavRestrictions, 3000);



        // Unified local-date formatter -> YYYY-MM-DD (avoids UTC shifts)
        function getISODateString(input){
            try {
                if (!input) return null;
                const d = (input instanceof Date) ? input : new Date(input);
                if (isNaN(d.getTime())) return null;
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return y + '-' + m + '-' + day;
            } catch(_) { return null; }
        }

        function getPreviousDate(dateString) {
            const base = getISODateString(dateString) ? new Date(dateString) : new Date();
            base.setDate(base.getDate() - 1);
            return getISODateString(base);
        }

        function renderStockLedger() {
            // Support pages where the stock-control inputs/table were moved.
            const stockDateEl = document.getElementById('stock-control-date');
            const finishedDateEl = document.getElementById('finished-products-date');
            const date = getISODateString((stockDateEl && stockDateEl.value) ? stockDateEl.value : (finishedDateEl && finishedDateEl.value) ? finishedDateEl.value : new Date());
            const prevDate = getPreviousDate(date);
            // Prefer stock-control table, fallback to finished-products table if moved
            const body = document.getElementById('stock-control-table-body') || document.getElementById('finished-products-table-body');
            if (!body) {
                // Nothing to render here (table moved). Update icons to keep UI consistent and return.
                try { updateStockControlIcons(); } catch(_){}
                return;
            }
            body.innerHTML = '';

            const prevDayBalances = state.stockEntries[prevDate] || {};
            const currentDayEntries = state.stockEntries[date] || {};
            const dispatchesForDate = state.dispatchNotes.filter(d => getISODateString(d && d.date ? d.date : null) === date);

            if (state.products.length === 0) {
                body.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</td></tr>`;
                return;
            }

            state.products.forEach(product => {
                let openingBalanceValue = currentDayEntries[product.id]?.opening;
                if (openingBalanceValue === undefined) {
                    openingBalanceValue = (prevDayBalances[product.id]?.actual !== undefined) ? prevDayBalances[product.id].actual : 0;
                }

                // ===== Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø¬Ø¹Ø§Øª Ø§Ù„Ø¬ÙŠØ¯Ø© Ù…Ù† Dispatch Notes =====
                const totalDispatched = dispatchesForDate.reduce((sum, dispatch) => {
                    const item = dispatch.items.find(i => i.productId === product.id);
                    return sum + (item ? (item.quantity || 0) : 0);
                }, 0);

                const totalGoodReturns = dispatchesForDate.reduce((sum, dispatch) => {
                    const item = dispatch.items.find(i => i.productId === product.id);
                    return sum + (item ? (item.goodReturn || 0) : 0);
                }, 0);

                // ===== Ø§Ù„Ø¥Ù†ØªØ§Ø¬ =====
                const productionQty = currentDayEntries[product.id]?.production || 0;

                // ===== ØµÙŠØºØ© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØªØ±ÙŠ =====
                // Book Balance = Opening Balance + Production - (Total Dispatched - Total Good Returns)
                const netOutbound = totalDispatched - totalGoodReturns;
                
                const row = document.createElement('tr');
                row.dataset.productId = product.id;
                row.innerHTML = `
                    <td class="px-2 py-2 text-sm font-medium text-gray-800 text-right">${product.name}</td>
                    <td class="px-2 py-2 stock-col-initial"><input type="number" class="w-20 p-1 border rounded text-center opening-balance" value="${openingBalanceValue}"></td>
                    <td class="px-2 py-2 text-center text-sm font-semibold text-blue-700 stock-col-production">${productionQty}</td>
                    <td class="px-2 py-2 stock-col-production-input"><input type="number" class="w-20 p-1 border rounded text-center production-qty" value="${productionQty}"></td>
                    <td class="px-2 py-2 text-center text-sm font-semibold text-orange-600 stock-col-dispatched">${totalDispatched}</td>
                    <td class="px-2 py-2 text-center text-sm font-semibold text-green-700 stock-col-good-returns">${totalGoodReturns}</td>
                    <td class="px-2 py-2 text-center text-sm font-bold stock-col-book">0</td>
                    <td class="px-2 py-2 stock-col-actual"><input type="number" class="w-20 p-1 border rounded text-center actual-balance"></td>
                    <td class="px-2 py-2 text-center text-sm font-bold stock-col-diff">0</td>
                    <td class="px-2 py-2 text-center text-sm font-semibold stock-col-diff-text"></td>
                `;
                body.appendChild(row);

                const openingBalanceInput = row.querySelector('.opening-balance');
                const productionInput = row.querySelector('.production-qty');
                const actualBalanceInput = row.querySelector('.actual-balance');
                const bookBalanceCell = row.querySelector('.stock-col-book');
                const diffCell = row.querySelector('.stock-col-diff');
                const diffTextCell = row.querySelector('.stock-col-diff-text');

                function updateRowCalculations() {
                    const openingBalance = parseInt(openingBalanceInput.value) || 0;
                    const productionInputQty = parseInt(productionInput.value) || 0;
                    
                    // Book Balance = Opening Balance + Production - (Total Dispatched - Total Good Returns)
                    const bookBalance = openingBalance + productionInputQty - netOutbound;
                    bookBalanceCell.textContent = bookBalance;

                    const actualBalance = parseInt(actualBalanceInput.value);
                    if (!isNaN(actualBalance)) {
                        const difference = actualBalance - bookBalance;
                        diffCell.textContent = difference;
                        if (difference > 0) {
                            diffTextCell.textContent = 'Ø²ÙŠØ§Ø¯Ø©';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-green-700 stock-col-diff-text';
                        } else if (difference < 0) {
                            diffTextCell.textContent = 'Ø¹Ø¬Ø²';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-red-700 stock-col-diff-text';
                        } else {
                            diffTextCell.textContent = 'Ù…Ø·Ø§Ø¨Ù‚';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-gray-700 stock-col-diff-text';
                        }
                    } else {
                        diffCell.textContent = '-';
                        diffTextCell.textContent = '';
                    }
                }

                openingBalanceInput.addEventListener('focus', (e) => {
                    e.target.dataset.previousValue = e.target.value;
                });

                openingBalanceInput.addEventListener('change', async (e) => {
                    const confirmed = await customDialog({
                        title: 'ØªØ£ÙƒÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯',
                        message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŸ',
                        isConfirm: true,
                        confirmText: 'Ù†Ø¹Ù…ØŒ Ø¹Ø¯Ù„',
                        confirmClass: 'bg-orange-500 hover:bg-orange-600'
                    });

                    if (confirmed) {
                        const newValue = parseInt(e.target.value);
                        if (!isNaN(newValue)) {
                            if (!state.stockEntries[date]) state.stockEntries[date] = {};
                            if (!state.stockEntries[date][product.id]) state.stockEntries[date][product.id] = {};
                            state.stockEntries[date][product.id].opening = newValue;

                            // 1. Update State
                            window._finishedGridState = window._finishedGridState || {};
                            window._finishedGridState[product.id] = Object.assign(window._finishedGridState[product.id]||{}, { opening: newValue });
                            // 2. SAVE LOCALLY IMMEDIATELY (Do not wait for cloud)
                            try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(e){}
                            try { localStorage.setItem('stock_entries', JSON.stringify(state.stockEntries || {})); } catch(e){}
                            // 3. Debounce Cloud Save
                            try { saveFinishedProductsDebounced(); } catch(e){}

                            updateRowCalculations();
                        }
                    } else {
                        e.target.value = e.target.dataset.previousValue;
                    }
                });

                // load saved values (if any) to avoid race/wipe
                const saved = (window._finishedGridState && window._finishedGridState[product.id]) ? window._finishedGridState[product.id] : {};
                if (saved.production !== undefined) productionInput.value = saved.production; else productionInput.value = currentDayEntries[product.id]?.production || 0;
                const bookBalance = parseInt(bookBalanceCell.textContent);
                if (saved.actual !== undefined && saved.actual !== null) actualBalanceInput.value = saved.actual; else actualBalanceInput.value = currentDayEntries[product.id]?.actual ?? bookBalance;
                const saveFinishedProductsDebounced = (typeof window.debouncedFinishedSave === 'function') ? window.debouncedFinishedSave : function(){};

                // persist helper for this row
                function persistFinishedRow() {
                    try {
                        window._finishedGridState = window._finishedGridState || {};
                        window._finishedGridState[product.id] = Object.assign(window._finishedGridState[product.id]||{}, {
                            production: (productionInput && productionInput.value) ? Number(productionInput.value) : 0,
                            actual: (actualBalanceInput && actualBalanceInput.value) ? Number(actualBalanceInput.value) : null,
                            opening: (openingBalanceInput && openingBalanceInput.value) ? Number(openingBalanceInput.value) : 0,
                            updatedAt: new Date().toISOString()
                        });
                        try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(e){}
                        if (typeof window.debouncedFinishedSave === 'function') window.debouncedFinishedSave();
                    } catch(e){ console.warn('persist finished row failed', e); }
                }

                productionInput.addEventListener('input', function(e){
                    updateRowCalculations();
                    window.__finishedTouched = true; // FIXED: Mark as touched for cloud save
                    try { persistFinishedRow(); } catch(e){ console.warn('persistFinishedRow failed', e); }
                    try {
                        // Force local save immediately (ensure no CLOUD_ONLY suppression)
                        const productId = product.id;
                        const value = (productionInput && productionInput.value) ? Number(productionInput.value) : 0;
                        const finishedState = window._finishedGridState || {};
                        finishedState[productId] = Object.assign(finishedState[productId]||{}, { production: value, updatedAt: new Date().toISOString() });
                        try { localStorage.setItem('finished_products_grid', JSON.stringify(finishedState)); } catch(e){}
                        try { localStorage.setItem('stock_entries', JSON.stringify(state.stockEntries || {})); } catch(e){}
                        try { saveFinishedProductsDebounced(); } catch(e){}
                    } catch(e){ console.warn('forced local save (production) failed', e); }
                });

                actualBalanceInput.addEventListener('input', function(e){
                    updateRowCalculations();
                    window.__finishedTouched = true; // FIXED: Mark as touched for cloud save
                    try { persistFinishedRow(); } catch(e){ console.warn('persistFinishedRow failed', e); }
                    try {
                        // Force local save immediately (ensure no CLOUD_ONLY suppression)
                        const productId = product.id;
                        const val = (actualBalanceInput && actualBalanceInput.value) ? Number(actualBalanceInput.value) : null;
                        const finishedState = window._finishedGridState || {};
                        finishedState[productId] = Object.assign(finishedState[productId]||{}, { actual: val, updatedAt: new Date().toISOString() });
                        try { localStorage.setItem('finished_products_grid', JSON.stringify(finishedState)); } catch(e){}
                        try { localStorage.setItem('stock_entries', JSON.stringify(state.stockEntries || {})); } catch(e){}
                        try { saveFinishedProductsDebounced(); } catch(e){}
                    } catch(e){ console.warn('forced local save (actual) failed', e); }
                });

                // Initial calculation
                updateRowCalculations();
                updateRowCalculations();
            });
            updateStockControlIcons();
        }

        function saveStockBalances() {
            const dateEl = document.getElementById('stock-control-date') || document.getElementById('finished-products-date');
            const date = dateEl ? dateEl.value : null;
            if (!date) {
                customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹.' });
                return;
            }

            if (!state.stockEntries[date]) {
                state.stockEntries[date] = {};
            }

            let rows = document.querySelectorAll('#stock-control-table-body tr');
            if (!rows || rows.length === 0) {
                // fallback to finished-products table if stock-control table was moved
                rows = document.querySelectorAll('#finished-products-table-body tr');
            }
            rows.forEach(row => {
                const productId = row.dataset.productId;
                const actualBalanceInput = row.querySelector('.actual-balance');
                const productionInput = row.querySelector('.production-qty');
                if (productId) {
                    if (!state.stockEntries[date][productId]) {
                        state.stockEntries[date][productId] = {};
                    }
                    const actualBalance = parseInt(actualBalanceInput.value);
                    if (!isNaN(actualBalance)) {
                        state.stockEntries[date][productId].actual = actualBalance;
                    }
                    const productionQty = parseInt(productionInput.value);
                    if (!isNaN(productionQty)) {
                        state.stockEntries[date][productId].production = productionQty;
                    }
                }
            });

            // Force local persistence for finished-products regardless of CLOUD_ONLY
            try {
                // persist per-grid quick state
                try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(e){}
                // persist full stock entries snapshot as well so recovery can use it
                try { localStorage.setItem('stock_entries', JSON.stringify(state.stockEntries || {})); } catch(e){}
            } catch(e){ /* ignore */ }

            // then persist overall app state (this may be suppressed for CLOUD_ONLY inside saveState,
            // but we've already written the critical finished-products data locally above)
            saveState();
            customDialog({ title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', message: `ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${formatArabicDate(date)}.` });
            try { alert('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ØªØ§Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…'); } catch(e){}
            updateStockControlIcons();
        }

        function updateStockControlIcons() {
            // Count products by category
            const finishedProductsCount = state.products.filter(p => p.category && p.category.toLowerCase().includes('Ø§Ù†ØªØ§Ø¬|ØªØ§Ù…|Ù…Ù†ØªØ¬')).length;
            const rawMaterialsCount = state.products.filter(p => p.category && p.category.toLowerCase().includes('Ø®Ø§Ù…Ø©|Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…|Ù…Ø§Ø¯Ø© Ø®Ø§Ù…')).length;
            const packagingCount = state.products.filter(p => p.category && (p.category.toLowerCase().includes('ØªØ¹Ø¨Ø¦Ø©') || p.category.toLowerCase().includes('ØªØºÙ„ÙŠÙ') || p.category.toLowerCase().includes('Ø¹Ø¨ÙˆØ©') || p.category.toLowerCase().includes('ÙˆØ±Ù‚') || p.category.toLowerCase().includes('ÙƒÙŠØ³'))).length;

            document.getElementById('stock-finished-products-count').textContent = finishedProductsCount;
            document.getElementById('stock-raw-materials-count').textContent = rawMaterialsCount;
            document.getElementById('stock-packaging-count').textContent = packagingCount;

            updateIcons();
        }

        function scrollToStockTable() {
            const table = document.getElementById('stock-control-table');
            if (table) {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function showStockSubview(name){
            try{
                // Before switching away, flush any pending grid saves for the currently visible subpage
                try {
                    const visible = Array.from(document.querySelectorAll('.stock-subpage')).find(s => !s.classList.contains('hidden'));
                    if (visible) {
                        const id = visible.id || '';
                        if (id.includes('raw') && typeof window.saveRawGridStateNow === 'function') {
                            try { window.saveRawGridStateNow(); } catch(e){ console.warn('flush raw save failed', e); }
                        }
                        if (id.includes('pack') && typeof window.savePackGridStateNow === 'function') {
                            try { window.savePackGridStateNow(); } catch(e){ console.warn('flush pack save failed', e); }
                        }
                        if (id.includes('finished') && typeof window.saveFinishedProductsNow === 'function') {
                            try { window.saveFinishedProductsNow(); } catch(e){ /* best-effort */ }
                        }
                    }
                } catch(e){ /* ignore flush errors */ }

                document.querySelectorAll('.stock-subpage').forEach(s=>s.classList.add('hidden'));
                // deactivate buttons
                ['stock-subbtn-finished-products','stock-subbtn-raw-materials','stock-subbtn-packaging'].forEach(id=>{const b=document.getElementById(id); if(b) b.classList.remove('ring','ring-2');});
                if(!name) return;
                const map = {
                    'finished-products':'subpage-finished-products',
                    'raw-materials':'subpage-raw-materials',
                    'packaging':'subpage-packaging'
                };
                const subId = map[name];
                const subEl = subId ? document.getElementById(subId) : null;
                if(subEl) subEl.classList.remove('hidden');
                // highlight button
                const btn = document.getElementById('stock-subbtn-'+name);
                if(btn) btn.classList.add('ring','ring-2');

                // render content for visible subview
                if(name === 'finished-products') renderStockLedgerForFinishedProducts();
                if(name === 'raw-materials') renderRawMaterials();
                if(name === 'packaging') renderPackaging();
            }catch(e){console.warn('showStockSubview', e)}
        }

        function renderFinishedProducts() {
            // Redirect to the correct render function
            if (typeof renderStockLedgerForFinishedProducts === 'function') {
                renderStockLedgerForFinishedProducts();
            }
        }

        function renderStockLedgerForFinishedProducts() {
            // Ensure we pick up the latest local finished-products grid immediately
            try { window._finishedGridState = Object.assign({}, window._finishedGridState || {}, JSON.parse(localStorage.getItem('finished_products_grid') || '{}')); } catch(e) { window._finishedGridState = window._finishedGridState || {}; }
            // CRITICAL: Ensure stock_entries are loaded from localStorage
            try { if (window.state && !window.state.stockEntries) window.state.stockEntries = JSON.parse(localStorage.getItem('stock_entries') || '{}'); } catch(e){}
            const dateInput = document.getElementById('finished-products-date').value;
            const date = getISODateString(dateInput || new Date());
            const prevDate = getPreviousDate(date);
            const body = document.getElementById('finished-products-table-body');
            body.innerHTML = '';

            // Diagnostics
            try {
                const prodCount = Array.isArray(state.products) ? state.products.length : 0;
                const prevCount = state.stockEntries[prevDate] ? Object.keys(state.stockEntries[prevDate]).length : 0;
                const curCount = state.stockEntries[date] ? Object.keys(state.stockEntries[date]).length : 0;
                console.log('ğŸ§ª Finished Render â†’ date:', date, '| products:', prodCount, '| prev entries:', prevCount, '| today entries:', curCount);
            } catch(_){ }

            const prevDayBalances = state.stockEntries[prevDate] || {};
            const currentDayEntries = state.stockEntries[date] || {};
            const salesForDate = (Array.isArray(state.sales) ? state.sales : []).filter(s => {
                try { return getISODateString(s && s.date ? s.date : null) === date; } catch(_) { return false; }
            });
            const dispatchesForDate = (Array.isArray(state.dispatchNotes) ? state.dispatchNotes : []).filter(d => {
                try { return getISODateString(d && d.date ? d.date : null) === date; } catch(_) { return false; }
            });
            try { console.log('ğŸ§ª Finished Render â†’ sales:', salesForDate.length, '| dispatches:', dispatchesForDate.length); } catch(_){ }

            if (state.products.length === 0) {
                body.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</td></tr>`;
                return;
            }

            state.products.forEach(product => {
                let openingBalanceValue = currentDayEntries[product.id]?.opening;
                if (openingBalanceValue === undefined) {
                    const prevActual = (prevDayBalances[product.id]?.actual !== undefined) ? prevDayBalances[product.id].actual : undefined;
                    openingBalanceValue = (prevActual !== undefined) ? prevActual : 0;
                    // Auto carry-over: write opening from yesterday's actual if missing
                    try {
                        if (!state.stockEntries[date]) state.stockEntries[date] = {};
                        if (!state.stockEntries[date][product.id]) state.stockEntries[date][product.id] = {};
                        if (prevActual !== undefined) {
                            state.stockEntries[date][product.id].opening = prevActual;
                            // Mirror to finished grid state for cloud sync
                            window._finishedGridState = window._finishedGridState || {};
                            window._finishedGridState[product.id] = Object.assign(window._finishedGridState[product.id]||{}, { opening: prevActual, updatedAt: new Date().toISOString() });
                            try { localStorage.setItem('stock_entries', JSON.stringify(state.stockEntries || {})); } catch(_){ }
                            try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(_){ }
                            try { if (typeof window.debouncedFinishedSave === 'function') window.debouncedFinishedSave(); } catch(_){ }
                        }
                    } catch(_){ }
                }

                const totalInward = dispatchesForDate.reduce((sum, dispatch) => {
                    const item = dispatch.items.find(i => i.productId === product.id);
                    return sum + (item ? (item.quantity || 0) : 0);
                }, 0);

                const totalOutbound = salesForDate.reduce((sum, sale) => {
                    const item = sale.items.find(i => i.productId === product.id);
                    return sum + (item ? (item.quantity || 0) : 0);
                }, 0);
                try { console.log('ğŸ§ª Row', product.id, product.name, 'â†’ open:', openingBalanceValue, 'in:', totalInward, 'out:', totalOutbound); } catch(_){ }
                
                const row = document.createElement('tr');
                row.dataset.productId = product.id;
                row.innerHTML = `
                    <td class="px-2 py-2 text-sm font-medium text-gray-800 text-right">${product.name}</td>
                    <td class="px-2 py-2 stock-col-initial"><input type="number" class="w-20 p-1 border rounded text-center opening-balance" value="${openingBalanceValue}"></td>
                    <td class="px-2 py-2 text-center text-sm stock-col-inward">${totalInward}</td>
                    <td class="px-2 py-2 stock-col-production"><input type="number" class="w-20 p-1 border rounded text-center production-qty" value="${currentDayEntries[product.id]?.production || 0}"></td>
                    <td class="px-2 py-2 text-center text-sm stock-col-outbound">${totalOutbound}</td>
                    <td class="px-2 py-2 text-center text-sm font-bold stock-col-book">0</td>
                    <td class="px-2 py-2 stock-col-actual"><input type="number" class="w-20 p-1 border rounded text-center actual-balance"></td>
                    <td class="px-2 py-2 text-center text-sm font-bold stock-col-diff">0</td>
                    <td class="px-2 py-2 text-center text-sm font-semibold stock-col-diff"></td>
                `;
                body.appendChild(row);

                const openingBalanceInput = row.querySelector('.opening-balance');
                const productionInput = row.querySelector('.production-qty');
                const actualBalanceInput = row.querySelector('.actual-balance');
                const bookBalanceCell = row.querySelector('.stock-col-book');
                const diffCell = row.querySelector('.stock-col-diff');
                const diffTextCell = row.querySelectorAll('.stock-col-diff')[1];

                function updateRowCalculations() {
                    const openingBalance = parseInt(openingBalanceInput.value) || 0;
                    const productionQty = parseInt(productionInput.value) || 0;
                    const bookBalance = openingBalance + totalInward + productionQty - totalOutbound;
                    bookBalanceCell.textContent = bookBalance;

                    const actualBalance = parseInt(actualBalanceInput.value);
                    if (!isNaN(actualBalance)) {
                        const difference = actualBalance - bookBalance;
                        diffCell.textContent = difference;
                        if (difference > 0) {
                            diffTextCell.textContent = 'Ø²ÙŠØ§Ø¯Ø©';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-green-700 stock-col-diff';
                        } else if (difference < 0) {
                            diffTextCell.textContent = 'Ø¹Ø¬Ø²';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-red-700 stock-col-diff';
                        } else {
                            diffTextCell.textContent = 'Ù…Ø·Ø§Ø¨Ù‚';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-gray-700 stock-col-diff';
                        }
                    } else {
                        diffCell.textContent = '-';
                        diffTextCell.textContent = '';
                    }
                }

                openingBalanceInput.addEventListener('focus', (e) => {
                    e.target.dataset.previousValue = e.target.value;
                });

                openingBalanceInput.addEventListener('change', async (e) => {
                    const confirmed = await customDialog({
                        title: 'ØªØ£ÙƒÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯',
                        message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŸ',
                        isConfirm: true,
                        confirmText: 'Ù†Ø¹Ù…ØŒ Ø¹Ø¯Ù„',
                        confirmClass: 'bg-orange-500 hover:bg-orange-600'
                    });

                    if (confirmed) {
                        const newValue = parseInt(e.target.value);
                        if (!isNaN(newValue)) {
                            if (!state.stockEntries[date]) state.stockEntries[date] = {};
                            if (!state.stockEntries[date][product.id]) state.stockEntries[date][product.id] = {};
                            state.stockEntries[date][product.id].opening = newValue;

                            // Persist immediately to localStorage (bypass CLOUD_ONLY suppression)
                            try {
                                window.__finishedTouched = true; // FIXED: Mark as touched for cloud save
                                window._finishedGridState = window._finishedGridState || {};
                                window._finishedGridState[product.id] = Object.assign(window._finishedGridState[product.id]||{}, { opening: newValue, updatedAt: new Date().toISOString() });
                                try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(e){}
                                try { localStorage.setItem('stock_entries', JSON.stringify(state.stockEntries || {})); } catch(e){}
                                if (typeof window.debouncedFinishedSave === 'function') window.debouncedFinishedSave();
                            } catch(e){ console.warn('persist finished opening failed', e); }

                            updateRowCalculations();
                        }
                    } else {
                        e.target.value = e.target.dataset.previousValue;
                    }
                });

                productionInput.addEventListener('input', updateRowCalculations);
                actualBalanceInput.addEventListener('input', updateRowCalculations);
                
                // Initial calculation
                updateRowCalculations();
                const bookBalance = parseInt(bookBalanceCell.textContent);
                actualBalanceInput.value = currentDayEntries[product.id]?.actual ?? bookBalance;
                updateRowCalculations();
            });
        }

        function saveStockBalancesForFinishedProducts() {
            const rawDateVal = document.getElementById('finished-products-date').value;
            const date = getISODateString(rawDateVal || new Date());
            if (!date) {
                customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹.' });
                return;
            }

            if (!state.stockEntries[date]) {
                state.stockEntries[date] = {};
            }

            const rows = document.querySelectorAll('#finished-products-table-body tr');
            rows.forEach(row => {
                const productId = row.dataset.productId;
                const actualBalanceInput = row.querySelector('.actual-balance');
                const productionInput = row.querySelector('.production-qty');
                const openingBalanceInput = row.querySelector('.opening-balance');
                if (productId) {
                    if (!state.stockEntries[date][productId]) {
                        state.stockEntries[date][productId] = {};
                    }
                    
                    // CRITICAL: Save actual (including 0, not just if non-NaN)
                    const actualBalance = actualBalanceInput ? parseInt(actualBalanceInput.value) : 0;
                    state.stockEntries[date][productId].actual = !isNaN(actualBalance) ? actualBalance : 0;
                    
                    // CRITICAL: Save production (including 0)
                    const productionQty = productionInput ? parseInt(productionInput.value) : 0;
                    state.stockEntries[date][productId].production = !isNaN(productionQty) ? productionQty : 0;
                    
                    // CRITICAL: Save opening (including 0)
                    const openingVal = openingBalanceInput ? parseInt(openingBalanceInput.value) : 0;
                    state.stockEntries[date][productId].opening = !isNaN(openingVal) ? openingVal : 0;
                    
                    // FIXED: Also save to _finishedGridState for cloud sync
                    try {
                        window._finishedGridState = window._finishedGridState || {};
                        if (!window._finishedGridState[productId]) window._finishedGridState[productId] = {};
                        window._finishedGridState[productId].actual = !isNaN(actualBalance) ? actualBalance : 0;
                        window._finishedGridState[productId].production = !isNaN(productionQty) ? productionQty : 0;
                        window._finishedGridState[productId].opening = !isNaN(openingVal) ? openingVal : 0;
                        window._finishedGridState[productId].updatedAt = new Date().toISOString();
                    } catch(e){ console.warn('Update _finishedGridState failed', e); }
                }
            });

            // Log what we're about to save
            console.log('ğŸ’¾ saveStockBalancesForFinishedProducts â†’ date:', date, '| entries count:', Object.keys(state.stockEntries[date] || {}).length);
            try {
                // Debug: log a few entries to verify values
                const sampleEntries = Object.entries(state.stockEntries[date] || {}).slice(0, 3);
                sampleEntries.forEach(([k, v]) => console.log('  Entry', k, 'â†’', v));
            } catch(_){ }
            
            // SAVE LOCALLY IMMEDIATELY (do not wait for cloud)
            try { localStorage.setItem('stock_entries', JSON.stringify(state.stockEntries)); } catch(e){}
            try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(e){}
            // Mark as touched for cloud save
            window.__finishedTouched = true;
            // Then queue cloud sync
            try { 
                if (typeof window.debouncedFinishedSave === 'function') {
                    window.debouncedFinishedSave();
                } else if (typeof saveFinishedProductsDebounced === 'function') {
                    saveFinishedProductsDebounced();
                }
            } catch(e){ console.warn('Cloud sync failed', e); }

            // Enterprise-grade: persist this day's entries to a dedicated collection (stockEntries/{YYYY-MM-DD})
            try { if (typeof window.saveStockEntriesToCloud === 'function') window.saveStockEntriesToCloud(String(date)); } catch(e){ console.warn('saveStockEntriesToCloud failed', e); }
            customDialog({ title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', message: `ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${formatArabicDate(date)}.` });
            updateStockControlIcons();
        }

        // ===== Enterprise-grade Stock Persistence: per-day Firestore documents =====
        // Writes authoritative stock entries to collection stockEntries/{date}
        (function(){
            // Guard install once
            if (window.__stockEntriesHelpersInstalled) return;
            window.__stockEntriesHelpersInstalled = true;

            window.__stockEntriesUnsub = null;
            window.__stockEntriesDocId = null;

            window.installStockEntriesListenerForDate = function(date){
                try {
                    const dayId = getISODateString(date || new Date());
                    if (!dayId || !window.db) return;
                    if (window.__stockEntriesDocId === dayId && typeof window.__stockEntriesUnsub === 'function') return; // already subscribed
                    try { if (typeof window.__stockEntriesUnsub === 'function') { window.__stockEntriesUnsub(); } } catch(_){ }
                    window.__stockEntriesUnsub = null; window.__stockEntriesDocId = null;
                    const ref = db.collection('stockEntries').doc(String(dayId));
                    window.__stockEntriesUnsub = ref.onSnapshot(function(snap){
                        try {
                            if (!snap || !snap.exists) return;
                            if (snap.metadata && snap.metadata.hasPendingWrites) return; // ignore local echo
                            const d = snap.data() || {};
                            const entries = (d && d.entries && typeof d.entries === 'object') ? d.entries : {};
                            // Merge into state for this day only
                            try {
                                if (!window.state) window.state = {};
                                if (!window.state.stockEntries) window.state.stockEntries = {};
                                window.state.stockEntries[dayId] = entries;
                                // Mirror to localStorage snapshot (all dates)
                                try { localStorage.setItem('stock_entries', JSON.stringify(window.state.stockEntries || {})); } catch(_){ }
                            } catch(e){ console.warn('apply stockEntries/day failed', e); }
                            // If finished-products view is visible for this day, re-render
                            try {
                                const cur = document.getElementById('finished-products-date');
                                const curDay = getISODateString(cur && cur.value ? cur.value : new Date());
                                if (curDay === dayId && typeof renderStockLedgerForFinishedProducts === 'function') {
                                    renderStockLedgerForFinishedProducts();
                                }
                            } catch(_){ }
                        } catch(e){ console.warn('stockEntries onSnapshot failed', e); }
                    }, function(err){ console.warn('stockEntries listener error', err); });
                    window.__stockEntriesDocId = dayId;
                } catch(e){ console.warn('installStockEntriesListenerForDate failed', e); }
            };

            window.saveStockEntriesToCloud = async function(date){
                try {
                    const dayId = getISODateString(date || new Date());
                    if (!dayId) return false;
                    // Build payload from authoritative in-memory state for that day
                    const entries = (window.state && window.state.stockEntries && window.state.stockEntries[dayId]) ? window.state.stockEntries[dayId] : {};
                    // Always mirror to local first
                    try { localStorage.setItem('stock_entries', JSON.stringify(window.state && window.state.stockEntries || {})); } catch(_){ }
                    if (!window.db) { console.warn('saveStockEntriesToCloud: db not ready'); return false; }
                    const meta = { updatedAt: serverTs() };
                    try {
                        const user = (window.auth && auth.currentUser) ? auth.currentUser : null;
                        if (user) { meta.updatedBy = (user.email||user.uid||'user'); }
                    } catch(_){ }
                    // Write per-day doc
                    await db.collection('stockEntries').doc(String(dayId)).set({ date: String(dayId), entries: entries || {}, ...meta }, { merge: true });
                    // Best-effort: keep legacy aggregated snapshot in settings/costLists for backward-compat
                    try {
                        await db.collection('settings').doc('costLists').set({ stockEntries: (window.state && window.state.stockEntries) || {}, updatedAt: serverTs() }, { merge: true });
                    } catch(_){ }
                    console.log('âœ… stockEntries saved to cloud (stockEntries/'+dayId+')', { products: Object.keys(entries||{}).length });
                    return true;
                } catch(e){ console.warn('saveStockEntriesToCloud failed', e); return false; }
            };
        })();

        function renderRawMaterials() {
            // Always rehydrate latest grid snapshot from localStorage (in case a debounced save just flushed)
            try { window._rawGridState = JSON.parse(localStorage.getItem('raw_materials_grid') || '{}'); } catch(e){ window._rawGridState = window._rawGridState || {}; }
            try { window._packGridState = JSON.parse(localStorage.getItem('packaging_grid') || '{}'); } catch(e){ window._packGridState = window._packGridState || {}; }
            // Install shared helpers once to persist grids (localStorage + Firestore)
            if (!window._gridHelpersInstalled) {
                window._gridHelpersInstalled = true;
                window._rawGridSaveTimer = null;
                window._packGridSaveTimer = null;
                window.saveRawGridStateNow = async function(){
                    try { localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState || {})); } catch(e){}
                    try { if (window.db) await db.collection('settings').doc('costLists').set({ rawMaterials: window._rawGridState, updatedAt: serverTs() }, { merge:true }); } catch(e){}
                };
                window.debouncedRawSave = function(){ clearTimeout(window._rawGridSaveTimer); window._rawGridSaveTimer = setTimeout(window.saveRawGridStateNow, 700); };
                window.savePackGridStateNow = async function(){
                    try { localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState || {})); } catch(e){}
                    try { if (window.db) await db.collection('settings').doc('costLists').set({ packaging: window._packGridState, updatedAt: serverTs() }, { merge:true }); } catch(e){}
                };
                window.debouncedPackSave = function(){ clearTimeout(window._packGridSaveTimer); window._packGridSaveTimer = setTimeout(window.savePackGridStateNow, 700); };
            }

            const date = document.getElementById('raw-materials-date').value || new Date().toISOString().split('T')[0];
            const body = document.getElementById('raw-materials-table-body');
            if(!body) return;
            body.innerHTML = '';

            console.log('renderRawMaterials - Loaded State:', window._rawGridState);

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ù‘ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹
            const rawMaterialsList = [
                'Ù„Ø¨Ù† Ø¨ÙˆØ¯Ø±Ø©', 'Ø¨Ø±ÙˆØªÙŠÙ† Ù…Ø±ÙƒØ²', 'Ø¨Ø¯ÙŠÙ„ Ø²Ø¨Ø¯Ø©', 'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 200', 'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 100', 'Ø§Ù†Ø§ØªÙˆ', 'ÙƒÙ„ÙˆØ±ÙÙŠÙ„',
                'S20', 'B3', 'Ù†ÙŠØ§Ø³ÙŠÙ†', 'Ù†ØªØ§Ù…ÙŠØ³ÙŠÙ†', 'Ø³ÙˆØ±Ø¨Ø§Øª Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…', 'ÙƒÙ„ÙˆØ±ÙŠØ¯ ÙƒØ§Ù„Ø³ÙŠÙˆÙ…', 'Ù…Ù†ÙØ­Ø© Ù…ÙŠÙƒØ±ÙˆØ¨ÙŠØ©',
                'GDL', 'Ø¯ÙŠØ±Ù‰ Ø¬ÙŠÙ„ 121', 'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', 'Ø§Ù†ØªÙ‰ ÙÙˆÙ…', 'Ù†Ø´Ø§', 'Ù…ÙŠØ§Ù‡', 'ÙƒØ±ÙŠÙ…Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰', 'ÙƒØ±ÙŠÙ…Ø© Ø¨Ù‚Ø±Ù‰',
                'CR 15', 'ÙØ§Ù†ÙŠÙ„ÙŠØ§', 'Ù…Ø³ØªÙƒØ©', 'Ù…ÙŠØ§Ù‡ ÙˆØ±Ø¯', 'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 21', 'Ù„Ø§ÙƒØªÙ‡ 810', 'Ø§ÙŠØ³ ÙƒØ±ÙŠÙ… Ø¨ÙˆØ¯Ø±Ø©',
                'ÙƒØ±ÙŠÙ… Ø´Ø§Ù†ØªÙŠÙ‡ Ø¨ÙˆØ¯Ø±', 'Ø³ÙƒØ±', 'Ø§Ø±Ø²', 'Ø·Ø¹Ù… Ø§Ù„Ø´ÙŠØ¯Ø±', 'Ø·Ø¹Ù… Ø§Ù„Ø±ÙˆÙ…Ù‰', 'Ø·Ø¹Ù… Ø¬ÙˆØ¯Ø©', 'Ø·Ø¹Ù… Ø§Ù„Ù†Ø³ØªÙˆ',
                'Ù…Ù„Ø­ Ù„ÙŠÙ…ÙˆÙ†', 'Ø®Ø§Ù…Ø§Øª Ø­ÙØ¸ Ø§Ù„Ù…Ø´', 'ØµÙˆØµ Ù…Ø´', 'ØµÙˆØ¯Ø§ ÙƒØ§ÙˆÙŠØ©', 'Ø·Ø¹Ù… Ø²Ø¨Ø¯Ø©', 'Ø·Ø¹Ù… ÙƒØ±ÙŠÙ…Ø©', 'Ù„Ø§ÙƒØªØ© 815',
                'Ù„Ø§ÙƒØªØ© 825', 'Ø§ÙƒØ³Ø¬ÙŠÙ†', 'ÙƒØ±Ø¨ÙˆÙ†Ø§Øª', 'Ø·Ø¹Ù… Ø­Ù„ÙŠØ¨', 'Ø¨Ø§Ø¯Ù‰ Ø²Ø¨Ø§Ø¯Ù‰', 'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 500', 'Ø·Ø¹Ù… Ù‚Ø´Ø·Ø©',
                'Ù„Ø¨Ù† Ø®Ø§Ù„Ù‰ Ø§Ù„Ø¯Ø³Ù…', 'Ø·Ø¹Ù… Ø¬Ø¨Ù†Ø© Ù‚Ø¯ÙŠÙ…Ø©', 'Ø­Ø§Ù…Ø¶', 'Ø³Ù„ÙØ§Øª ØµÙˆØ¯ÙŠÙˆÙ…', 'Ø·Ø¹Ù… Ø§Ù…Ù†ØªØ§Ù„', 'Ø·Ø¹Ù… Ø´ÙŠØ¯Ø± Ø²Ø¨Ø¯Ø©',
                'Ø¨Ø±ÙˆÙƒØ³Ø§ÙŠØ¯', 'Ø´Ø·Ø© Ø­Ù…Ø±Ø§Ø¡', 'Ø¬Ø¨Ù†Ù‡ Ø±ÙˆÙ…Ù‰ Ù…Ø¨Ø´ÙˆØ±', 'ÙƒØ±ÙŠÙ…ÙˆØ³200', 'Ø²ÙŠØª Ø¹Ø¨Ø§Ø¯', 'Ù„Ø§ÙƒØªØ© s33', 'Ø·Ø¹Ù… Ø³Ù…Ù† Ø¨Ù„Ø¯Ù‰',
                'Ø³ØªØ±ÙŠÙƒ Ø§Ø³ÙŠØ¯', 'Ù…Ø¹Ù‚Ù… ÙŠØ¯', 'Ø§Ø³ÙŠØªÙˆÙ†', 'Ù…ÙƒØ³Ø¨ Ø·Ø¹Ù… ÙƒØ±ÙŠÙ…Ø©', 'Ù„ÙˆÙ† Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ© ØºØ§Ù…Ù‚'
            ];

            if (rawMaterialsList.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø§Ù…Ø§Øª Ù…Ø¹Ø±Ù‘ÙØ©.</td></tr>`;
                return;
            }

            rawMaterialsList.forEach((materialName, index) => {
                const row = document.createElement('tr');
                const materialId = 'raw-' + index;
                row.dataset.productId = materialId;

                // load any saved values first to avoid race when setting inputs
                const saved = (window._rawGridState && window._rawGridState[materialName]) ? window._rawGridState[materialName] : {};
                const unitPriceVal = (saved.unitPrice !== undefined) ? saved.unitPrice : 0;
                const openingVal = (saved.opening !== undefined) ? saved.opening : 0;
                const inboundVal = (saved.inbound !== undefined) ? saved.inbound : 0;
                const usageVal = (saved.usage !== undefined) ? saved.usage : 0;
                const actualVal = (saved.actual !== undefined && saved.actual !== null) ? saved.actual : '';

                row.innerHTML = `
                    <td class="px-2 py-2 text-sm font-medium text-gray-800 text-right">${materialName}</td>
                    <td class="px-2 py-2 text-center bg-blue-50"><input type="number" class="w-24 p-1 border rounded text-center unit-price" step="any" value="${unitPriceVal}"></td>
                    <td class="px-2 py-2 text-center bg-blue-50"><input type="number" class="w-20 p-1 border rounded text-center opening-balance" value="${openingVal}"></td>
                    <td class="px-2 py-2 text-center bg-blue-50"><input type="number" class="w-20 p-1 border rounded text-center inbound-qty" value="${inboundVal}"></td>
                    <td class="px-2 py-2 text-center bg-blue-50"><input type="number" class="w-20 p-1 border rounded text-center usage-qty" value="${usageVal}"></td>
                    <td class="px-2 py-2 text-center bg-blue-50 font-bold book-balance">0</td>
                    <td class="px-2 py-2 bg-blue-50"><input type="number" class="w-20 p-1 border rounded text-center actual-balance" value="${actualVal}"></td>
                    <td class="px-2 py-2 text-center font-bold difference">0</td>
                `;
                body.appendChild(row);

                const unitPriceInput = row.querySelector('.unit-price');
                const openingInput = row.querySelector('.opening-balance');
                const inboundInput = row.querySelector('.inbound-qty');
                const usageInput = row.querySelector('.usage-qty');
                const bookBalanceCell = row.querySelector('.book-balance');
                const actualBalanceInput = row.querySelector('.actual-balance');
                const differenceCell = row.querySelector('.difference');

                function updateCalculations() {
                    const opening = parseInt(openingInput.value) || 0;
                    const inbound = parseInt(inboundInput.value) || 0;
                    const usage = parseInt(usageInput.value) || 0;
                    const bookBalance = opening + inbound - usage;
                    bookBalanceCell.textContent = bookBalance;

                    const actual = parseInt(actualBalanceInput.value);
                    if (!isNaN(actual)) {
                        differenceCell.textContent = actual - bookBalance;
                    } else {
                        differenceCell.textContent = '-';
                    }

                    // persist to local state and schedule cloud save
                    try {
                        window._rawGridState = window._rawGridState || {};
                        const newUnitPrice = (unitPriceInput && unitPriceInput.value) ? Number(unitPriceInput.value) : 0;
                        const oldPrice = (window._rawGridState[materialName] && window._rawGridState[materialName].unitPrice) || 0;
                        window._rawGridState[materialName] = {
                            unitPrice: newUnitPrice,
                            opening: opening,
                            inbound: inbound,
                            usage: usage,
                            actual: (!isNaN(actual) ? actual : null),
                            bookBalance: bookBalance,
                            updatedAt: new Date().toISOString()
                        };
                        // mark raw grid as touched so cloud writer knows to include it
                        try { window.__rawTouched = true; } catch(_){}
                        if (typeof window.debouncedRawSave === 'function') window.debouncedRawSave();
                        
                        // === PRICE SYNC: Raw Materials => Costing System ===
                        if (newUnitPrice !== oldPrice && newUnitPrice !== 0) {
                            try {
                                // Primary: Search in window.costRaw
                                let costItem = (Array.isArray(window.costRaw) && window.costRaw.find(i => i && i.name && i.name.toLowerCase() === materialName.toLowerCase()));
                                if (costItem) {
                                    costItem.cost = newUnitPrice;
                                    costItem.lastPrice = newUnitPrice;
                                    costItem.lastPriceDate = new Date().toISOString();
                                    if (typeof window.saveCostListsToFirebase === 'function') window.saveCostListsToFirebase();
                                    console.log(`âœ… Price synced for Raw Material "${materialName}": ${newUnitPrice}`);
                                }
                            } catch(e){ console.warn('Price sync for raw materials failed', e); }
                        }
                    } catch(e){ console.warn('persist raw grid failed', e); }
                }

                openingInput.addEventListener('input', updateCalculations);
                inboundInput.addEventListener('input', updateCalculations);
                usageInput.addEventListener('input', updateCalculations);
                actualBalanceInput.addEventListener('input', updateCalculations);
                if (unitPriceInput) unitPriceInput.addEventListener('input', updateCalculations);

                // initial calculation
                updateCalculations();
            });
        }

        function renderPackaging() {
            // Rehydrate latest grid snapshots from localStorage to pick recent changes
            try { window._rawGridState = JSON.parse(localStorage.getItem('raw_materials_grid') || '{}'); } catch(e){ window._rawGridState = window._rawGridState || {}; }
            try { window._packGridState = JSON.parse(localStorage.getItem('packaging_grid') || '{}'); } catch(e){ window._packGridState = window._packGridState || {}; }
            // relies on helpers installed by renderRawMaterials
            if (!window._gridHelpersInstalled) {
                // ensure helpers exist even if renderRawMaterials hasn't run
                window._rawGridSaveTimer = window._rawGridSaveTimer || null;
                window._packGridSaveTimer = window._packGridSaveTimer || null;
                window.savePackGridStateNow = window.savePackGridStateNow || (async function(){ try { localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState || {})); } catch(e){} try { if (window.db) await db.collection('settings').doc('costLists').set({ packaging: window._packGridState, updatedAt: serverTs() }, { merge:true }); } catch(e){} });
                window.debouncedPackSave = window.debouncedPackSave || function(){ clearTimeout(window._packGridSaveTimer); window._packGridSaveTimer = setTimeout(window.savePackGridStateNow, 700); };
            }

            const dateEl = document.getElementById('packaging-date');
            const date = dateEl ? (dateEl.value || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0];
            const body = document.getElementById('packaging-table-body');
            if(!body) return;
            body.innerHTML = '';

            console.log('renderPackaging - Loaded State:', window._packGridState);

            // Gather packaging items from state.products (if any) and from cost lists (costPack)
            const prodPack = Array.isArray(state.products) ? state.products.filter(p => p && p.category && (p.category.toString().toLowerCase().includes('ØªØ¹Ø¨Ø¦Ø©') || p.category.toString().toLowerCase().includes('ØªØºÙ„ÙŠÙ') || p.category.toString().toLowerCase().includes('Ø¹Ø¨ÙˆØ©') || p.category.toString().toLowerCase().includes('ÙˆØ±Ù‚') || p.category.toString().toLowerCase().includes('ÙƒÙŠØ³'))) : [];
            const costPackArr = Array.isArray(window.costPack) ? window.costPack : [];

            // Combine uniquely by name (case-insensitive)
            const seen = new Set();
            const combined = [];
            prodPack.forEach(p => {
                const name = (p && (p.name||p.title||p.code)) ? String(p.name||p.title||p.code).trim() : '';
                const key = name.toLowerCase();
                if(!name) return;
                if(!seen.has(key)){
                    seen.add(key);
                    combined.push({ id: p.id || ('prod-' + Math.random().toString(36).slice(2,8)), name });
                }
            });
            costPackArr.forEach(cp => {
                const name = (cp && (cp.name||cp.code)) ? String(cp.name||cp.code).trim() : '';
                const key = name.toLowerCase();
                if(!name) return;
                if(!seen.has(key)){
                    seen.add(key);
                    combined.push({ id: cp.id || ('costpack-' + Math.random().toString(36).slice(2,8)), name });
                }
            });

            if (combined.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ØªØ¹Ø¨Ø¦Ø©/ØªØºÙ„ÙŠÙ ÙÙŠ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø£Ùˆ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</td></tr>`;
                return;
            }

            combined.forEach(product => {
                const row = document.createElement('tr');
                row.dataset.productId = product.id;

                // load saved values first
                const saved = (window._packGridState && window._packGridState[product.name]) ? window._packGridState[product.name] : {};
                const unitPriceVal = (saved.unitPrice !== undefined) ? saved.unitPrice : 0;
                const openingVal = (saved.opening !== undefined) ? saved.opening : 0;
                const inboundVal = (saved.inbound !== undefined) ? saved.inbound : 0;
                const usageVal = (saved.usage !== undefined) ? saved.usage : 0;
                const actualVal = (saved.actual !== undefined && saved.actual !== null) ? saved.actual : '';

                row.innerHTML = `
                    <td class="px-2 py-2 text-sm font-medium text-gray-800 text-right">${product.name}</td>
                    <td class="px-2 py-2 text-center bg-orange-50"><input type="number" class="w-24 p-1 border rounded text-center unit-price" step="any" value="${unitPriceVal}"></td>
                    <td class="px-2 py-2 text-center bg-orange-50"><input type="number" class="w-20 p-1 border rounded text-center opening-balance" value="${openingVal}"></td>
                    <td class="px-2 py-2 text-center bg-orange-50"><input type="number" class="w-20 p-1 border rounded text-center inbound-qty" value="${inboundVal}"></td>
                    <td class="px-2 py-2 text-center bg-orange-50"><input type="number" class="w-20 p-1 border rounded text-center usage-qty" value="${usageVal}"></td>
                    <td class="px-2 py-2 text-center bg-orange-50 font-bold book-balance">0</td>
                    <td class="px-2 py-2 bg-orange-50"><input type="number" class="w-20 p-1 border rounded text-center actual-balance" value="${actualVal}"></td>
                    <td class="px-2 py-2 text-center font-bold difference">0</td>
                `;
                body.appendChild(row);

                const unitPriceInput = row.querySelector('.unit-price');
                const openingInput = row.querySelector('.opening-balance');
                const inboundInput = row.querySelector('.inbound-qty');
                const usageInput = row.querySelector('.usage-qty');
                const bookBalanceCell = row.querySelector('.book-balance');
                const actualBalanceInput = row.querySelector('.actual-balance');
                const differenceCell = row.querySelector('.difference');

                function updateCalculations() {
                    const opening = parseInt(openingInput.value) || 0;
                    const inbound = parseInt(inboundInput.value) || 0;
                    const usage = parseInt(usageInput.value) || 0;
                    const bookBalance = opening + inbound - usage;
                    bookBalanceCell.textContent = bookBalance;

                    const actual = parseInt(actualBalanceInput.value);
                    if (!isNaN(actual)) {
                        differenceCell.textContent = actual - bookBalance;
                    } else {
                        differenceCell.textContent = '-';
                    }

                    // persist to local state and schedule cloud save
                    try {
                        window._packGridState = window._packGridState || {};
                        const newUnitPrice = (unitPriceInput && unitPriceInput.value) ? Number(unitPriceInput.value) : 0;
                        const oldPrice = (window._packGridState[product.name] && window._packGridState[product.name].unitPrice) || 0;
                        window._packGridState[product.name] = {
                            unitPrice: newUnitPrice,
                            opening: opening,
                            inbound: inbound,
                            usage: usage,
                            actual: (!isNaN(actual) ? actual : null),
                            bookBalance: bookBalance,
                            updatedAt: new Date().toISOString()
                        };
                        if (typeof window.debouncedPackSave === 'function') window.debouncedPackSave();
                        // mark pack grid as touched so cloud writer knows to include it
                        try { window.__packTouched = true; } catch(_){}
                        
                        // === PRICE SYNC: Packaging => Costing System ===
                        if (newUnitPrice !== oldPrice && newUnitPrice !== 0) {
                            try {
                                const costItem = (Array.isArray(window.costPack) && window.costPack.find(i => i && i.name && i.name.toLowerCase() === product.name.toLowerCase()));
                                if (costItem) {
                                    costItem.cost = newUnitPrice;
                                    costItem.lastPrice = newUnitPrice;
                                    costItem.lastPriceDate = new Date().toISOString();
                                    if (typeof window.saveCostListsToFirebase === 'function') window.saveCostListsToFirebase();
                                    console.log(`âœ… Price synced for Packaging "${product.name}": ${newUnitPrice}`);
                                }
                            } catch(e){ console.warn('Price sync for packaging failed', e); }
                        }
                    } catch(e){ console.warn('persist pack grid failed', e); }
                }

                openingInput.addEventListener('input', updateCalculations);
                inboundInput.addEventListener('input', updateCalculations);
                usageInput.addEventListener('input', updateCalculations);
                actualBalanceInput.addEventListener('input', updateCalculations);
                if (unitPriceInput) unitPriceInput.addEventListener('input', updateCalculations);

                // initial calc
                updateCalculations();
            });
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ¹ÙŠÙŠÙ† ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        function setCurrentMonthDates() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const firstDay = `${year}-${month}-01`;
            const lastDay = new Date(year, now.getMonth() + 1, 0);
            const lastDayStr = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;
            
            const fromDateEl = document.getElementById('filter-from-date');
            const toDateEl = document.getElementById('filter-to-date');
            
            if (fromDateEl) fromDateEl.value = firstDay;
            if (toDateEl) toDateEl.value = lastDayStr;
        }
        
        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
        function initTotalBillsPage() {
            // ØªØ¹ÙŠÙŠÙ† ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            setCurrentMonthDates();
            // Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
            renderTotalBills();
        }

        function renderTotalBills(sortKey, sortDirection) {
            const tableBody = document.getElementById('total-bills-table-body');
            const fromDate = document.getElementById('filter-from-date').value;
            const toDate = document.getElementById('filter-to-date').value;
            const customerName = document.getElementById('filter-customer-name').value.toLowerCase();
            const invoiceNumber = document.getElementById('filter-invoice-number').value;

            let filteredSales = state.sales.filter(sale => {
                // Ø¢Ù…Ù†: ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© Ø¨Ø¯ÙˆÙ† toISOString
                const sd = sale && sale.date ? new Date(sale.date) : null;
                const hasValidDate = sd && !isNaN(sd.getTime());
                const saleDay = hasValidDate ? sd.toISOString().split('T')[0] : null;
                if (fromDate && saleDay && saleDay < fromDate) return false;
                if (toDate && saleDay && saleDay > toDate) return false;
                const customer = findCustomer(sale.customerId);
                if (customerName && customer && !customer.name.toLowerCase().includes(customerName)) return false;
                if (invoiceNumber && String(sale.invoiceNumber || '') !== String(invoiceNumber)) return false;
                // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯ÙˆØ±Ù‡ Ù…Ù†Ø¯ÙˆØ¨
                let role = typeof getUserRole === 'function' ? getUserRole() : 'rep';
                let currentEmail = (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null;
                if (role === 'rep' && currentEmail) {
                    const emailMatch = ((sale.repEmail||'').toLowerCase() === currentEmail);
                    // Ø¯Ø¹Ù… ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø£ÙŠØ¶Ø§Ù‹
                    const currentRep = (state.reps||[]).find(r => (r.email||'').toLowerCase() === currentEmail);
                    const repName = currentRep?.name;
                    const nameMatch = repName && sale.repName === repName;
                    if (!emailMatch && !nameMatch) return false;
                }
                return true;
            });

            // --- NEW: Calculate and display total ---
            const filteredTotal = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const totalAmountEl = document.getElementById('total-bills-summary-amount');
            if (totalAmountEl) {
                totalAmountEl.textContent = formatCurrency(filteredTotal);
            }
            // --- END NEW ---

            if (sortKey && sortDirection) {
                filteredSales.sort((a, b) => {
                    let valA, valB;
                    if (sortKey === 'customerName') {
                        valA = findCustomer(a.customerId)?.name || '';
                        valB = findCustomer(b.customerId)?.name || '';
                    } else {
                        valA = a[sortKey];
                        valB = b[sortKey];
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const reviewState = loadReviewState();
            tableBody.innerHTML = filteredSales.map(sale => {
                const customer = findCustomer(sale.customerId);
                const items = sale.items || [];
                const category = items.length > 0 ? (findProduct(items[0].productId)?.category || 'N/A') : 'N/A';
                const highlightClass = reviewState[sale.id] || '';

                return `
                    <tr>
                        <td class="p-4"><input type="checkbox" class="total-bill-row-checkbox" value="${sale.id}"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-center bg-slate-100">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-bold invoice-cell ${highlightClass}" data-id="${sale.id}">${sale.invoiceNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right bg-purple-100">${customer ? customer.name : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right bg-pink-100">${sale.repName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold bg-cyan-100">${formatCurrency(sale.total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${getStatusBadge(sale.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right bg-orange-100">${category}</td>
                    </tr>
                `;
            }).join('');
        }


        // Populate chains dropdown
        function populateChainsDropdown(selectEl) {
            if (!selectEl) return;
            const chains = loadChains();
            const currentValue = selectEl.value;
            selectEl.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ø§Ø³Ù„</option>';
            chains.forEach(chain => {
                const opt = document.createElement('option');
                opt.value = chain.id;
                opt.textContent = chain.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                selectEl.appendChild(opt);
            });
            selectEl.value = currentValue;
        }

        function renderDashboard() {
             const selectedRepName = (document.getElementById('dashboard-rep-filter') || {}).value || '';
             
             // Helper function Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù†Ø´Ø·
             const getActivePeriodSalesLocal = () => {
                 const activePeriod = state.activePeriod || '';
                 if (!activePeriod) return state.sales || [];
                 
                 return (state.sales || []).filter(sale => {
                     try {
                         const saleDate = sale.date ? new Date(sale.date) : null;
                         if (!saleDate || isNaN(saleDate.getTime())) return false;
                         const saleYearMonth = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
                         return saleYearMonth === activePeriod;
                     } catch (_) {
                         return false;
                     }
                 });
             };
             
             const currentMonthSales = getActivePeriodSalesLocal();
             let filteredMonthSales = currentMonthSales;
            
            // Prefer the global target from settings when no rep is selected. If settings target is missing/zero, fall back to sum of rep targets.
            let currentTarget = Number(state.settings?.salesTarget || 0);
            const targetTitleEl = document.getElementById('target-title');
            if (selectedRepName) {
                filteredMonthSales = currentMonthSales.filter(s => s.repName === selectedRepName);
                const targetRep = findRep(selectedRepName);
                currentTarget = targetRep ? (targetRep.target || 0) : 0;
                if (targetTitleEl) targetTitleEl.innerHTML = `Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù€ <span class="text-blue-600">${selectedRepName}</span>`;
            } else {
                // Use settings.salesTarget as the global monthly target. If it's falsy, fall back to the sum of individual rep targets.
                if (!currentTarget || currentTarget <= 0) {
                    currentTarget = state.reps.reduce((sum, rep) => sum + (rep.target || 0), 0) || 0;
                }
                if (targetTitleEl) targetTitleEl.textContent = `Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ):`;
            }
            
            const totalSales = filteredMonthSales.reduce((sum, s) => sum + s.total, 0);
            const totalCollected = filteredMonthSales.reduce((sum, s) => sum + s.paidAmount, 0);
            const totalDue = totalSales - totalCollected;
            if (document.getElementById('total-sales')) document.getElementById('total-sales').textContent = formatCurrency(totalSales);
            if (document.getElementById('total-collected')) document.getElementById('total-collected').textContent = formatCurrency(totalCollected);
            if (document.getElementById('total-due')) document.getElementById('total-due').textContent = formatCurrency(totalDue);
            if (document.getElementById('sales-count')) document.getElementById('sales-count').textContent = filteredMonthSales.length;
            const progress = currentTarget > 0 ? Math.min((totalSales / currentTarget) * 100, 100) : 0;
            if (document.getElementById('target-amount-display')) document.getElementById('target-amount-display').textContent = formatCurrency(currentTarget);
            const progressBar = document.getElementById('target-progress-bar'); if (progressBar) progressBar.style.width = `${progress}%`;
            if (document.getElementById('target-progress-text')) document.getElementById('target-progress-text').textContent = `${Math.round(progress)}%`;
            const recentSalesList = document.getElementById('recent-sales-list'); if (recentSalesList) recentSalesList.innerHTML = '';
            let recentSales = [...currentMonthSales].reverse();
            if (selectedRepName) { recentSales = recentSales.filter(s => s.repName === selectedRepName); }
            recentSales = recentSales.slice(0, 5);
            if (!recentSalesList) return;
            if (recentSales.length === 0) { recentSalesList.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨ÙŠØ¹ Ø¨Ø¹Ø¯.</p>'; return; }
            recentSales.forEach(sale => { const customer = findCustomer(sale.customerId); 
    // NEW: Return detection for dashboard recent sales
    const isReturn = sale.total < 0;
    const totalAmountClass = isReturn ? 'text-red-700' : 'text-green-700';

    const el = document.createElement('div'); el.className = 'bg-gray-50 p-3 rounded-lg flex justify-between items-center'; 
    el.innerHTML = `<div><p class="font-bold">${customer && customer.name ? customer.name : (sale.customerName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}</p><p class="text-sm text-gray-500"><bdo dir="rtl">${formatArabicDateTime(sale.date)}</bdo></p><p class="text-xs text-blue-600 pt-1">${sale.repName || ''}</p></div><div class="text-left space-y-1"><p class="font-bold ${totalAmountClass}">${formatCurrency(sale.total)}</p>${getStatusBadge(sale.status)}</div>`; recentSalesList.appendChild(el); }); updateIcons();
        }
        
        // --- CHART RENDERING FUNCTIONS ---
        
        // Helper function to filter sales by active period
        function getActivePeriodSales() {
            const activePeriod = state.activePeriod || '';
            if (!activePeriod) return state.sales || [];
            
            return (state.sales || []).filter(sale => {
                try {
                    const saleDate = sale.date ? new Date(sale.date) : null;
                    if (!saleDate || isNaN(saleDate.getTime())) return false;
                    const saleYearMonth = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
                    return saleYearMonth === activePeriod;
                } catch (_) {
                    return false;
                }
            });
        }
        
        function getSalesDataForLast7Days() { 
            // ØªØºÙŠÙŠØ±: Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù†Ø´Ø· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
            const activePeriod = state.activePeriod || '';
            if (!activePeriod) return { labels: [], data: [] };
            
            const [year, month] = activePeriod.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const dataMap = new Map();
            const labels = [];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                labels.push(String(day));
                dataMap.set(dateString, 0);
            }
            
            const monthSales = getActivePeriodSales();
            monthSales.forEach(sale => {
                try {
                    const sd = sale.date ? new Date(sale.date) : null;
                    if (!sd || isNaN(sd.getTime())) return;
                    const saleDateString = sd.toISOString().split('T')[0];
                    if (dataMap.has(saleDateString)) {
                        dataMap.set(saleDateString, dataMap.get(saleDateString) + (Number(sale.total) || 0));
                    }
                } catch (_) { }
            });
            return { labels, data: Array.from(dataMap.values()) }; 
        }
        function getTopRepsData(count = 5) { 
            const monthSales = getActivePeriodSales();
            const repSalesMap = new Map(); 
            monthSales.forEach(sale => { 
                const repName = sale.repName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; 
                repSalesMap.set(repName, (repSalesMap.get(repName) || 0) + sale.total); 
            }); 
            const sortedReps = Array.from(repSalesMap.entries()).sort((a, b) => b[1] - a[1]).slice(0, count); 
            return { labels: sortedReps.map(r => r[0]), data: sortedReps.map(r => r[1]) }; 
        }
        function getTopProductsData(count = 5) {
            const productQtyMap = new Map();
            const monthSales = getActivePeriodSales();
            monthSales.forEach(sale => {
                try {
                    const items = Array.isArray(sale.items) ? sale.items : [];
                    items.forEach(item => {
                        try {
                            const qty = Number(item && item.quantity ? item.quantity : 0) || 0;
                            const product = findProduct(item && item.productId);
                            const productName = product && product.name ? product.name : (item && item.name ? item.name : 'Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ');
                            productQtyMap.set(productName, (productQtyMap.get(productName) || 0) + qty);
                        } catch (_) { /* ignore item */ }
                    });
                } catch (_) { /* ignore sale */ }
            });
            const sortedProducts = Array.from(productQtyMap.entries()).sort((a, b) => b[1] - a[1]).slice(0, count);
            return { labels: sortedProducts.map(p => p[0]), data: sortedProducts.map(p => p[1]) };
        }
        function getTopCustomersData(count = 5) { 
            const monthSales = getActivePeriodSales();
            const customerSalesMap = new Map(); 
            monthSales.forEach(sale => { 
                const customer = findCustomer(sale.customerId); 
                const customerName = customer ? customer.name : 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ'; 
                customerSalesMap.set(customerName, (customerSalesMap.get(customerName) || 0) + sale.total); 
            }); 
            const sortedCustomers = Array.from(customerSalesMap.entries()).sort((a, b) => b[1] - a[1]).slice(0, count); 
            return { labels: sortedCustomers.map(c => c[0]), data: sortedCustomers.map(c => c[1]) }; 
        }
        function createOrUpdateChart(chartInstance, canvasId, type, data, options) { 
             if (chartInstance) { chartInstance.data.labels = data.labels; chartInstance.data.datasets[0].data = data.data; chartInstance.update(); return chartInstance; }
             const ctx = document.getElementById(canvasId)?.getContext('2d'); 
             if (!ctx) return null; // Add check for context
             return new Chart(ctx, { type: type, data: { labels: data.labels, datasets: [{ label: options.label || 'Ø§Ù„Ù‚ÙŠÙ…Ø©', data: data.data, backgroundColor: options.backgroundColor || 'rgba(59, 130, 246, 0.5)', borderColor: options.borderColor || 'rgba(59, 130, 246, 1)', borderWidth: options.borderWidth || 1, tension: 0.3, ...options.datasetOverrides }] }, options: { responsive: true, maintainAspectRatio: false, rtl: true, plugins: { legend: { labels: { font: { family: 'Cairo' } } } }, scales: { x: { reverse: true, ticks: { font: { family: 'Cairo' } }, title: { display: !!options.xTitle, text: options.xTitle, font: { family: 'Cairo' } } }, y: { beginAtZero: true, ticks: { font: { family: 'Cairo' } }, title: { display: !!options.yTitle, text: options.yTitle, font: { family: 'Cairo' } } } }, ...options.overrides } }); 
        }
        function renderSales7DaysChart() { const data = getSalesDataForLast7Days(); sales7DaysChart = createOrUpdateChart(sales7DaysChart, 'sales-7-days-chart', 'line', data, { label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬.Ù…)', backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', yTitle: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬.Ù…)', datasetOverrides: { fill: true } }); }
        function renderTopRepsChart() { const data = getTopRepsData(5); topRepsChart = createOrUpdateChart(topRepsChart, 'top-reps-chart', 'bar', data, { label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬.Ù…)', backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgba(16, 185, 129, 1)', yTitle: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', overrides: { indexAxis: 'y' } }); }
        function renderTopProductsChart() { const data = getTopProductsData(5); topProductsChart = createOrUpdateChart(topProductsChart, 'top-products-chart', 'bar', data, { label: 'Ø§Ù„ÙƒÙ…ÙŠØ© (Ù‚Ø·Ø¹)', backgroundColor: 'rgba(234, 179, 8, 0.7)', borderColor: 'rgba(234, 179, 8, 1)', yTitle: 'Ø§Ù„ÙƒÙ…ÙŠØ©', overrides: { indexAxis: 'y' } }); }
        function renderTopCustomersChart() { const data = getTopCustomersData(5); topCustomersChart = createOrUpdateChart(topCustomersChart, 'top-customers-chart', 'doughnut', data, { label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬.Ù…)', backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'], borderColor: '#fff', overrides: { parsing: { key: 'data' } }, datasetOverrides: { hoverOffset: 4 } }); }
        // --- END CHART FUNCTIONS ---

        async function salesListClickHandler(e) {
            const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
            // --- Manual Review Highlighting ---
            const reviewCell = e.target.closest('.invoice-cell'); 
            if (reviewCell) {
                const invoiceSpan = reviewCell.closest('.invoice-review-span');
                if (invoiceSpan) {
                    const saleId = invoiceSpan.dataset.id;
                    toggleReviewColor(saleId, reviewCell);
                    return; // Stop further execution to prevent other buttons from firing
                }
            }

            const editBtn = e.target.closest('.edit-sale-btn');
            const deleteBtn = e.target.closest('.delete-sale-btn');
            const printBtn = e.target.closest('.print-sale-btn');
            const shareImageBtn = e.target.closest('.share-sale-image-btn');
            const etaUploadBtn = e.target.closest('.eta-upload-btn');
            const approveBtn = e.target.closest('.review-sale-btn');
            const reviewOpenBtn = e.target.closest('.review-open-btn');
            const taxToggleBtn = e.target.closest('.tax-status-toggle-btn');

            if (approveBtn) {
                if (role !== 'admin') { await customDialog({ title:'ØºÙŠØ± Ù…ØµØ±Ø­', message:'Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.' }); return; }
                try {
                    const saleId = approveBtn.getAttribute('data-id');
                    await updateSale(saleId, { reviewStatus: 'reviewed' });
                } catch(err){ console.warn('approve review failed', err); }
                return;
            }

            if (reviewOpenBtn) {
                const saleId = reviewOpenBtn.getAttribute('data-id');
                openSaleModal(saleId);
                // Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ØŒ Ø£Ø¶Ù Ø²Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¯Ø§Ø®Ù„ÙŠ Ø¥Ù† Ù„Ø²Ù…
                setTimeout(() => {
                    try {
                        const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                        const sale = (state.sales||[]).find(s=>s.id===saleId);
                        if (sale && sale.reviewStatus === 'pending' && (role === 'admin')) {
                            const modal = document.getElementById('sale-modal');
                            if (modal && !modal.querySelector('.modal-review-approve-btn')) {
                                const footer = modal.querySelector('form') || modal;
                                const btn = document.createElement('button');
                                btn.type = 'button';
                                btn.className = 'modal-review-approve-btn mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm flex items-center gap-1';
                                btn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
                                footer.appendChild(btn);
                                btn.addEventListener('click', async ()=>{
                                    try { await updateSale(saleId, { reviewStatus: 'reviewed' }); closeModal(modal); } catch(e){ alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯'); }
                                });
                                updateIcons();
                            }
                        }
                    } catch(_){ }
                }, 120);
                return;
            }

            if (editBtn) {
                const saleId = editBtn.dataset.id;
                if (role === 'rep') {
                    try {
                        const current = AuthSystem.getCurrentUser();
                        const sale = (state.sales||[]).find(s=>s.id===saleId);
                        
                        // 1. Ownership Check: Ensure sale belongs to current user
                        const mine = sale && (String(sale.createdBy||'') === String(current?.id||'') || String(sale.repId||'') === String(current?.id||''));
                        if (!mine) {
                            await customDialog({ title:'ØºÙŠØ± Ù…ØµØ±Ø­', message:'Ù„ÙŠØ³Øª Ù‡Ø°Ù‡ ÙØ§ØªÙˆØ±ØªÙƒ.' });
                            return;
                        }
                        
                        // 2. Robust Date Parsing: Handle Firestore Timestamp vs string
                        let createdTime = null;
                        if (sale && sale.createdAt) {
                            if (typeof sale.createdAt.toDate === 'function') {
                                // Firestore Timestamp
                                createdTime = sale.createdAt.toDate();
                            } else {
                                // Try parsing as string/number
                                createdTime = new Date(sale.createdAt);
                            }
                        }
                        
                        // 3. Time Limit: Check if within 15 minutes window
                        const ageMs = createdTime ? (Date.now() - createdTime.getTime()) : Infinity;
                        const EDIT_WINDOW_MS = 15 * 60 * 1000; // 15 minutes
                        if (ageMs > EDIT_WINDOW_MS) {
                            await customDialog({ title:'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', message:'Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (15 Ø¯Ù‚ÙŠÙ‚Ø©). Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ.' });
                            return;
                        }
                        
                        // 4. Review Status: Ensure not already reviewed
                        if (sale.reviewStatus === 'reviewed') {
                            await customDialog({ title:'ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ØªÙ…Ø¯Ø©', message:'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ØªÙ…Ø¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.' });
                            return;
                        }
                        
                        // All checks passed - open the modal
                        openSaleModal(saleId);
                    } catch(err) {
                        console.warn('Edit button error:', err);
                        await customDialog({ title:'Ø®Ø·Ø£', message:'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' });
                    }
                    return;
                }
                openSaleModal(saleId);
            }

            if (deleteBtn) {
                if (role === 'rep') { await customDialog({ title:'ØµÙ„Ø§Ø­ÙŠØ§Øª', message:'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ±.' }); return; }
                const saleId = deleteBtn.dataset.id;
                const confirmed = await customDialog({
                    title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                    message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
                    isConfirm: true,
                    confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                    confirmClass: 'bg-red-600 hover:bg-red-700'
                });

                if (confirmed) {
                    try {
                        await deleteSale(saleId);
                        await customDialog({ message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.' });
                    } catch (err) {
                        console.warn('Delete failed', err);
                        await customDialog({ message: 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª/Ø§Ù„Ø§ØªØµØ§Ù„.' });
                    }
                }
            }

            if (printBtn) {
                const saleId = printBtn.getAttribute('data-id');
                try { await window.printSaleById(saleId); } catch(e){ console.warn('printSaleById failed', e); }
                return;
            }

            if (shareImageBtn) {
                const saleId = shareImageBtn.getAttribute('data-id');
                try { await window.shareSaleReceiptImage(saleId); } catch(e){ console.warn('shareSaleReceiptImage failed', e); }
                return;
            }

            if (etaUploadBtn) {
                const roleNow = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (roleNow !== 'admin') { await customDialog({ title:'ØºÙŠØ± Ù…ØµØ±Ø­', message:'Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø®ØµØµ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.' }); return; }
                const saleId = etaUploadBtn.getAttribute('data-id');
                try { await window.uploadSaleToEta(saleId); } catch(e){ console.warn('uploadSaleToEta failed', e); }
                return;
            }
            
            
            if (taxToggleBtn) {
                const saleId = taxToggleBtn.dataset.id;
                const sale = state.sales.find(s => s.id === saleId);
                if (sale) {
                    const currentStatus = sale.taxFilingStatus || '';
                    const isFiled = currentStatus.trim().toLowerCase() === 'ØªÙ…';
                    
                    const newStatus = isFiled ? '' : 'ØªÙ…'; // Toggle status
                    sale.taxFilingStatus = newStatus;
                    sale.updatedAt = new Date().toISOString();
                    
                    renderAll(); // Re-render to show the change
                    saveState(); // Persist the change
                }
            }
        }

        // Quick print button logic (asks for invoice number then prints AS IMAGE for thermal)
        document.addEventListener('click', async function(e){
            const btn = e.target && (e.target.id === 'sales-quick-print-btn' || (e.target.closest && e.target.closest('#sales-quick-print-btn')));
            if (!btn) return;
            try {
                // Use the image-based thermal printing function
                await window.printAsImageForThermal();
            } catch(err){ 
                console.error('quick print failed', err); 
                alert('ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + (err && err.message ? err.message : err));
            }
        });

        function renderAllSales(textFilter = '', dateFilter = '', taxStatusFilter = 'all', reviewFilterArg = null) {
             const salesList = document.getElementById('sales-list'); 
             salesList.innerHTML = '';
             // Defensive guards & debug to diagnose empty-sales regression
             try {
                 console.debug('renderAllSales called', { textFilter, dateFilter, taxStatusFilter, stateSalesLength: Array.isArray(state.sales) ? state.sales.length : state.sales });
             } catch (e) { /* ignore console errors */ }

             if (!Array.isArray(state.sales)) state.sales = [];
             // Normalize filters
             textFilter = (textFilter || '').toString().trim();
             dateFilter = (dateFilter || '').toString().trim();

             let filteredSales = [...state.sales];
             // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯ÙˆØ±Ù‡ Ù…Ù†Ø¯ÙˆØ¨
             let role = typeof getUserRole === 'function' ? getUserRole() : 'rep';
             let currentEmail = (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null;
             if (role === 'rep' && currentEmail) {
                 // Find current rep's name for matching admin-created invoices
                 const currentRep = (state.reps||[]).find(r => (r.email||'').toLowerCase() === currentEmail);
                 const repName = currentRep?.name;
                 
                 filteredSales = filteredSales.filter(sale => {
                     // Match by email OR by repName (for admin-created invoices)
                     const matchByEmail = (sale.repEmail||'').toLowerCase() === currentEmail;
                     const matchByName = repName && sale.repName === repName;
                     return matchByEmail || matchByName;
                 });
             }
            // Read review filter from DOM if not passed
            const reviewStatusFilter = reviewFilterArg || (document.getElementById('review-status-filter')?.value || 'all');

                 // MONTHLY PERIOD FILTER (activePeriod) overrides single-day filter
                 const activePeriod = (state && state.activePeriod) ? String(state.activePeriod) : '';
                 if (activePeriod) {
                     // Filter by year-month match
                     filteredSales = filteredSales.filter(sale => {
                          try { return new Date(sale.date).toISOString().slice(0,7) === activePeriod; } catch(e){ return false; }
                     });
                     // Hide daily total (could implement monthly total later)
                     try { document.getElementById('daily-total-container').classList.add('hidden'); } catch(e){}
                 } else if (dateFilter) {
                     // Fallback to legacy daily filter only when no activePeriod enforced
                     const dailyFilteredSales = filteredSales.filter(sale => new Date(sale.date).toLocaleDateString('en-CA') === dateFilter);
                     const dailyTotal = dailyFilteredSales.reduce((sum, s) => sum + s.total, 0);
                     try {
                          document.getElementById('daily-total-amount').textContent = formatCurrency(dailyTotal);
                          document.getElementById('daily-total-container').classList.remove('hidden');
                     } catch(e){}
                     filteredSales = dailyFilteredSales;
                 } else {
                     try { document.getElementById('daily-total-container').classList.add('hidden'); } catch(e){}
                 }

             if (textFilter) { 
                const lowerCaseFilter = textFilter.toLowerCase(); 
                filteredSales = filteredSales.filter(sale => { 
                    const customer = findCustomer(sale.customerId); 
                    const customerNameMatch = customer && customer.name.toLowerCase().includes(lowerCaseFilter); 
                    const invoiceNumberMatch = sale.invoiceNumber.toString().includes(lowerCaseFilter); 
                    const totalMatch = sale.total.toString().includes(lowerCaseFilter) || formatCurrency(sale.total).includes(lowerCaseFilter); 
                    return customerNameMatch || invoiceNumberMatch || totalMatch; 
                }); 
            }

            // --- Review status filter ---
            if (reviewStatusFilter === 'pending') {
                filteredSales = filteredSales.filter(s => String(s.reviewStatus||'').toLowerCase() === 'pending');
            } else if (reviewStatusFilter === 'reviewed') {
                filteredSales = filteredSales.filter(s => String(s.reviewStatus||'').toLowerCase() === 'reviewed');
            }
             
             if (taxStatusFilter === 'filed') {
                filteredSales = filteredSales.filter(sale => {
                    const customer = findCustomer(sale.customerId);
                    if (!customer || !customer.requiresTaxFiling) return false;
                    return sale.taxFilingStatus && sale.taxFilingStatus.trim().toLowerCase() === 'ØªÙ…';
                });
            } else if (taxStatusFilter === 'not-filed') {
                filteredSales = filteredSales.filter(sale => {
                    const customer = findCustomer(sale.customerId);
                    if (!customer || !customer.requiresTaxFiling) return false;
                    return !sale.taxFilingStatus || sale.taxFilingStatus.trim().toLowerCase() !== 'ØªÙ…';
                });
            }

            // --- NEW: Calculate and display total of what's being shown ---
            const filteredTotal = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const filteredTotalAmountEl = document.getElementById('filtered-total-amount');
            if (filteredTotalAmountEl) {
                filteredTotalAmountEl.textContent = formatCurrency(filteredTotal);
            }
            const filteredCountEl = document.getElementById('filtered-total-count');
            if (filteredCountEl) {
                filteredCountEl.textContent = String(filteredSales.length);
            }
            // --- END NEW ---

             // ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ: Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ ÙˆØ§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
             try {
                 filteredSales.sort((a,b)=>{
                     const ta = new Date(a.date||0).getTime();
                     const tb = new Date(b.date||0).getTime();
                     return ta - tb;
                 });
             } catch(_){ /* keep original order as fallback */ }

             if (filteredSales.length === 0) { salesList.innerHTML = '<p class="text-gray-500 text-center mt-8">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.</p>'; return; }
             
             const reviewState = loadReviewState();
             filteredSales.forEach((sale, index) => { 
                const customer = findCustomer(sale.customerId); 
                
                // NEW: Return Detection and Styling
                const isReturn = sale.total < 0;
                const badgeText = isReturn ? 'Ù…Ø±ØªØ¬Ø¹' : 'ÙØ§ØªÙˆØ±Ø©';
                const badgeColor = isReturn ? 'bg-red-600 text-white' : 'bg-blue-600 text-white';
                // Avoid using undefined `index` here â€” this function doesn't have a row index.
                // Use a stable default background for sales; UI alternating row coloring is handled elsewhere.
                const saleBgColor = isReturn ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200';
                const totalAmountClass = (String(sale.reviewStatus||'').toLowerCase() === 'pending') ? 'text-red-700' : (isReturn ? 'text-red-700' : 'text-blue-700');
                
                const itemsList = sale.items.map((item, itemIndex) => { 
                    const product = findProduct(item.productId); 
                    const itemName = product ? product.name : 'Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ'; 
                    const itemDiscountFactor = (1 - (item.discountPercent || 0) / 100);
                    const itemBase = (item.quantity || 0) * (item.price || 0) * itemDiscountFactor;
                    const productVatRate = (product && product.vat_rate) ? Number(product.vat_rate) / 100 : 0;
                    const itemTax = round2(itemBase * productVatRate);
                    const itemTotal = round2(itemBase + itemTax);
                    const itemCode = product ? product.id : 'N/A'; 
                    // Use totalAmountClass for item total display color as well if it's a return
                    const itemTotalColorClass = isReturn ? 'text-red-700' : 'text-pink-700';

                    // Determine if this item was adjusted (entered price differs from expected)
                    try {
                        const prodForCheck = findProduct(item.productId) || {};
                        let expectedP = (prodForCheck.price != null) ? Number(prodForCheck.price) : 0;
                        try { const cust = findCustomer(sale.customerId); if (cust && cust.priceListId) { const pl = findPriceList(cust.priceListId); if (pl && pl.productPrices && pl.productPrices[item.productId] !== undefined) expectedP = Number(pl.productPrices[item.productId]); } } catch(_){ }
                        try { const promo = getActivePromotionPrice(item.productId, sale.customerId); if (promo !== null && promo !== undefined) expectedP = Number(promo); } catch(_){ }
                        const priceDiff = Math.abs((Number(item.price) || 0) - (Number(expectedP) || 0));
                        const showAdjusted = (item && item.adjusted === true) || (String(sale.reviewReason||'').toLowerCase() === 'adjusted');
                        const priceCellClass = showAdjusted ? 'text-red-600 font-bold' : '';
                        return `<tr class="text-xs border-b border-gray-100 last:border-b-0"><td class="text-right px-3 py-2 font-semibold sale-item-name-cell">${itemName}</td><td class="text-center px-3 py-2 sale-item-code-cell">${itemCode}</td><td class="text-center px-3 py-2 sale-item-qty-cell font-bold ${item.quantity < 0 ? 'text-red-600' : 'text-gray-800'}">${item.quantity}</td><td class="text-center px-3 py-2 sale-item-price-cell ${priceCellClass}">${formatCurrency(item.price)}</td><td class="text-center px-3 py-2 font-bold sale-item-total-cell ${itemTotalColorClass}">${formatCurrency(itemTotal)}</td></tr>`; 
                    } catch(e) {
                        return `<tr class="text-xs border-b border-gray-100 last:border-b-0"><td class="text-right px-3 py-2 font-semibold sale-item-name-cell">${itemName}</td><td class="text-center px-3 py-2 sale-item-code-cell">${itemCode}</td><td class="text-center px-3 py-2 sale-item-qty-cell font-bold ${item.quantity < 0 ? 'text-red-600' : 'text-gray-800'}">${item.quantity}</td><td class="text-center px-3 py-2 sale-item-price-cell">${formatCurrency(item.price)}</td><td class="text-center px-3 py-2 font-bold sale-item-total-cell ${itemTotalColorClass}">${formatCurrency(itemTotal)}</td></tr>`; 
                    }
                }).join(''); 
                
                const customerRequiresFiling = customer?.requiresTaxFiling; 
                
                // +++ NEW: Get Tax Number HTML +++
                const customerTaxNumber = customer ? (customer.taxNumber || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                const taxNumberHtml = `<div class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-center w-full">\r\n                           <p class="text-xs text-gray-700 font-semibold">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ:</p>\r\n                           <p class="text-sm font-bold text-gray-900">${customerTaxNumber}</p>\r\n                           <a href="https://invoicing.eta.gov.eg/" target="_blank" class="text-xs text-blue-600 hover:underline">Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</a>\r\n\r\n                       </div>`;
                // +++ END NEW +++
                
                const el = document.createElement('div'); 
                
                // Use the calculated background color
                el.className = `${saleBgColor} p-4 rounded-xl border shadow-md mb-6 transition duration-300 hover:shadow-lg`; 
                
                el.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-4">\r\n                    <div class="col-span-3">\r\n                        <p class="font-bold text-lg text-gray-800">\r\n                            ${customer ? customer.name : 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ'} \r\n                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${badgeColor} mr-2">${badgeText}</span>\r\n                            ${sale.isAdminEntry ? `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-purple-600 text-white mr-2" title="ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù…Ø¹Ø±ÙØ©: ${sale.recordedByName || 'Ø¥Ø¯Ø§Ø±Ø©'}"><i data-lucide="shield-check" class="w-3 h-3 inline ml-1"></i> Ø¥Ø¯Ø§Ø±Ø©</span>` : ''}\r\n                            ${customerRequiresFiling ? `<i data-lucide="file-text" class="w-4 h-4 inline text-orange-500 mr-2" title="ÙŠØªØ·Ù„Ø¨ Ø±ÙØ¹ Ø¶Ø±ÙŠØ¨ÙŠ"></i>` : ''}\r\n                        </p>\r\n                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500 mt-1">
                            <span><i data-lucide="calendar" class="w-3 h-3 inline ml-1"></i> ÙØ§ØªÙˆØ±Ø© Ø¨ØªØ§Ø±ÙŠØ®: <span dir="ltr" style="unicode-bidi: bidi-override; display: inline;">${formatArabicDate(sale.date)}</span></span>
                            <span class="invoice-review-span" data-id="${sale.id}" title="Ø§Ø¶ØºØ· Ù„Ù„ØªÙ„ÙˆÙŠÙ†">
                                <i data-lucide="hash" class="w-3 h-3 inline ml-1"></i> Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: 
                                <span class="invoice-cell text-red-600 font-bold ${reviewState[sale.id] || ''}">
                                    ${sale.invoiceNumber || 'N/A'}
                                </span>
                            </span>
                            <span><i data-lucide="user" class="w-3 h-3 inline ml-1"></i> Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: <span class="text-blue-600 font-semibold">${sale.repName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>${sale.isAdminEntry ? ` <span class="text-xs text-purple-600 font-semibold">(Ø³Ø¬Ù„ Ø¨Ù…Ø¹Ø±ÙØ©: ${sale.recordedByName || 'Ø¥Ø¯Ø§Ø±Ø©'})</span>` : ''}</span>
                        </div>\r\n                        <div class="overflow-x-auto mt-4 max-h-48 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">\r\n                            <table class="sale-items-table min-w-full">\r\n                                <thead>\r\n                                    <tr class="text-xs">\r\n                                        <th class="w-2/6 px-3 py-2 text-right">Ø§Ù„ØµÙ†Ù</th>\r\n                                        <th class="w-1/6 px-3 py-2 text-center">Ø§Ù„ÙƒÙˆØ¯</th>\r\n                                        <th class="w-1/6 text-center px-3 py-2">Ø§Ù„ÙƒÙ…ÙŠØ©</th>\r\n                                        <th class="w-1/6 text-center px-3 py-2">Ø§Ù„Ø³Ø¹Ø±</th>\r\n                                        <th class="w-1/6 text-center px-3 py-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>${itemsList}</tbody>\r\n                            </table>\r\n                        </div>\r\n                        <div class="flex gap-4 mt-3 pt-3 border-t">\r\n                            <button data-id="${sale.id}" class="edit-sale-btn text-sm flex items-center gap-1 text-blue-600 hover:text-blue-800"><i data-lucide="edit" class="w-4 h-4"></i> ØªØ¹Ø¯ÙŠÙ„</button>\r\n                            <button data-id="${sale.id}" class="delete-sale-btn text-sm flex items-center gap-1 text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i> Ø­Ø°Ù</button>\r\n                        </div>\r\n                    </div>\r\n                    <div class="col-span-1 border-r pr-4 flex flex-col justify-start items-center text-center pt-2">\r\n                        <h4 class="text-sm font-semibold text-gray-600 mb-1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4>\r\n                        <p class="font-bold text-2xl ${totalAmountClass}">${formatCurrency(sale.total)}</p>\r\n                        <div class="flex flex-col gap-1 items-center mt-3">\r\n                            ${getTaxStatusBadge(sale)}\r\n                            ${getStatusBadge(sale.status)}\r\n                        </div>\r\n                        ${taxNumberHtml} <!-- NEW: Inserted variable here -->\r\n                        ${sale.discount > 0 ? `<div class="mt-2 text-xs text-red-600">Ø®ØµÙ…: ${sale.discount}%</div>` : ''}\r\n                    </div>\r\n                </div>`; 
                try {
                    const sideCol = el.querySelector('.col-span-1.border-r.pr-4.flex.flex-col.justify-start.items-center.text-center.pt-2');
                    const roleSide = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (sideCol) {
                        const printBtnEl = document.createElement('button');
                        printBtnEl.setAttribute('data-id', sale.id);
                        printBtnEl.className = 'print-sale-btn mb-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        printBtnEl.innerHTML = '<i data-lucide="printer" class="w-4 h-4"></i> Ø·Ø¨Ø§Ø¹Ø©';
                        sideCol.insertBefore(printBtnEl, sideCol.firstChild);

                        const shareBtnEl = document.createElement('button');
                        shareBtnEl.setAttribute('data-id', sale.id);
                        shareBtnEl.className = 'share-sale-image-btn mb-2 bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        shareBtnEl.innerHTML = '<i data-lucide="share-2" class="w-4 h-4"></i> ØµÙˆØ±Ø©';
                        sideCol.insertBefore(shareBtnEl, sideCol.firstChild.nextSibling); // after print

                        // USB/Direct Print button (third button)
                        const usbPrintBtnEl = document.createElement('button');
                        usbPrintBtnEl.setAttribute('data-id', sale.id);
                        usbPrintBtnEl.className = 'usb-print-sale-btn mb-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        usbPrintBtnEl.innerHTML = '<i data-lucide="printer" class="w-4 h-4"></i> USB';
                        sideCol.insertBefore(usbPrintBtnEl, sideCol.firstChild.nextSibling.nextSibling); // after share

                        // Bluetooth print button (fourth button)
                        const btPrintBtnEl = document.createElement('button');
                        btPrintBtnEl.setAttribute('data-id', sale.id);
                        btPrintBtnEl.className = 'bt-print-sale-btn mb-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        btPrintBtnEl.innerHTML = '<i class="bi bi-bluetooth"></i> Ø¨Ù„ÙˆØªÙˆØ«';
                        sideCol.insertBefore(btPrintBtnEl, sideCol.firstChild.nextSibling.nextSibling.nextSibling); // after USB

                        // RawBT Android Direct Print button (fifth button)
                        const rawbtPrintBtnEl = document.createElement('button');
                        rawbtPrintBtnEl.setAttribute('data-id', sale.id);
                        rawbtPrintBtnEl.className = 'rawbt-print-sale-btn mb-2 bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        rawbtPrintBtnEl.innerHTML = '<i class="bi bi-phone-vibrate"></i> Ù‡Ø§ØªÙ';
                        sideCol.insertBefore(rawbtPrintBtnEl, sideCol.firstChild.nextSibling.nextSibling.nextSibling.nextSibling); // after bluetooth

                        // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¶Ø±Ø§Ø¦Ø¨ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ› ÙŠØ¨Ù‚Ù‰ ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                    }
                } catch(e){}
                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (sale && String(sale.reviewStatus||'').toLowerCase() === 'pending') {
                        // Determine why it's pending: adjusted-price vs legacy/manual pending
                        const isAdjustedPending = (String(sale.reviewReason||'').toLowerCase() === 'adjusted') || (Array.isArray(sale.items) && sale.items.some(it => it && it.adjusted));

                        if (isAdjustedPending) {
                            // Visual highlight: red border for price-adjusted pending reviews
                            try { el.classList.add('ring-2','ring-red-400'); } catch(_){ }
                        } else {
                            // Legacy pending (non-price-adjust) uses yellow ring as before
                            try { el.classList.add('ring-2','ring-yellow-300'); } catch(_){ }
                        }

                        // Add pending badge inside status area (color depends on reason)
                        const statusArea = el.querySelector('.flex.flex-col.gap-1.items-center.mt-3');
                        if (statusArea) {
                            const pendingTag = document.createElement('span');
                            if (isAdjustedPending) {
                                pendingTag.className = 'text-xs font-semibold bg-red-100 text-red-800 rounded-full px-2 py-0.5';
                                pendingTag.setAttribute('title', 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© â€” Ø³Ø¹Ø± Ù…Ø¹Ø¯Ù„');
                            } else {
                                pendingTag.className = 'text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full px-2 py-0.5';
                                pendingTag.setAttribute('title', 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
                            }
                            pendingTag.innerHTML = '<i data-lucide="clock" class="w-3 h-3 inline ml-1"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                            statusArea.appendChild(pendingTag);
                        }

                        // Add approve button for admin only (reviewer/manager are view-only)
                        if (role === 'admin') {
                            const actions = el.querySelector('.flex.gap-4.mt-3.pt-3.border-t');
                            if (actions) {
                                const approve = document.createElement('button');
                                approve.setAttribute('data-id', sale.id);
                                approve.className = 'review-sale-btn text-sm flex items-center gap-1 text-green-700 hover:text-green-900';
                                approve.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> Ø§Ø¹ØªÙ…Ø§Ø¯';
                                actions.appendChild(approve);
                            }
                        }
                    }
                    // Wire action buttons (print / share / bluetooth)
                    try {
                        const printBtn = el.querySelector('.print-sale-btn');
                        if (printBtn) printBtn.addEventListener('click', async (evt) => { 
                            evt.preventDefault(); 
                            try { 
                                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø£Ø³Ø±Ø¹ ÙˆØ£ÙØ¶Ù„ Ù„Ù„Ø·Ø§Ø¨Ø¹Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©)
                                await window.printAsImageForThermal(sale);
                            } catch(e){ 
                                console.error('print error', e);
                                alert('ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + (e.message || e));
                            }
                        });
                        const shareBtn = el.querySelector('.share-sale-image-btn');
                        if (shareBtn) shareBtn.addEventListener('click', async (evt) => { evt.preventDefault(); try { await window.exportSaleImageById(sale.id); } catch(e){ console.warn('exportSaleImageById error', e);} });
                        
                        // USB/Direct Print button
                        const usbBtn = el.querySelector('.usb-print-sale-btn');
                        if (usbBtn) usbBtn.addEventListener('click', async (evt) => {
                            evt.preventDefault();
                            try {
                                if (typeof printViaUSB === 'function') {
                                    await printViaUSB(sale);
                                } else {
                                    alert('Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± USB ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                                }
                            } catch(e) {
                                console.warn('USB print error', e);
                                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± USB: ' + (e && e.message));
                            }
                        });
                        
                        const btBtn = el.querySelector('.bt-print-sale-btn');
                        if (btBtn) btBtn.addEventListener('click', async (evt) => { 
                            evt.preventDefault(); 
                            try { 
                                showPrintPreviewModal(sale, () => { 
                                    if (typeof performBluetoothPrint === 'function') { 
                                        performBluetoothPrint(sale); 
                                    } else if (typeof printInvoiceBluetooth === 'function') { 
                                        // Fallback to older ESC/POS text printing
                                        printInvoiceBluetooth(sale); 
                                    } else {
                                        alert('Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                                    }
                                }); 
                            } catch(e){ console.warn('bt print error', e); alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«: '+(e&&e.message)); } 
                        });
                        const rawbtBtn = el.querySelector('.rawbt-print-sale-btn');
                        if (rawbtBtn) rawbtBtn.addEventListener('click', async (evt) => { 
                            evt.preventDefault(); 
                            try { 
                                if (typeof printInvoiceViaBluetooth === 'function') {
                                    await printInvoiceViaBluetooth(sale);
                                } else {
                                    alert('Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                                }
                            } catch(e){ 
                                console.warn('bluetooth print error', e); 
                                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«: '+(e&&e.message)); 
                            } 
                        });
                    } catch(e){ console.warn('wiring sale action buttons failed', e); }
                    // Tax upload status badge
                    try {
                        const statusArea2 = el.querySelector('.flex.flex-col.gap-1.items-center.mt-3');
                        if (statusArea2 && sale) {
                            if (sale.taxUploadStatus === 'uploaded') {
                                const uploadedTag = document.createElement('span');
                                uploadedTag.className = 'text-xs font-semibold bg-green-100 text-green-800 rounded-full px-2 py-0.5 flex items-center gap-1';
                                uploadedTag.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Ø±ÙØ¹ Ø¶Ø±ÙŠØ¨ÙŠ Ù†Ø§Ø¬Ø­';
                                statusArea2.appendChild(uploadedTag);
                            } else if (sale.taxUploadStatus === 'error') {
                                const errorTag = document.createElement('span');
                                errorTag.className = 'text-xs font-semibold bg-red-100 text-red-700 rounded-full px-2 py-0.5 flex items-center gap-1';
                                errorTag.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3"></i> ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹';
                                statusArea2.appendChild(errorTag);
                            }
                        }
                    } catch(_){ }
                } catch(_){ }
                salesList.appendChild(el); 
            }); 
            updateIcons();
        }

        function renderCustomers(filter = '') {
            const customersList = document.getElementById('customers-list');
            customersList.innerHTML = '';
            const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
            const currentUser = AuthSystem.getCurrentUser();
            const filteredCustomers = (state.customers||[]).filter(c => {
                if (!c || !c.name) return false;
                if (!c.name.toLowerCase().includes(filter.toLowerCase())) return false;
                if (role === 'admin') return true;
                if (role === 'rep' && currentUser) {
                    const assigned = c.assignedRepId || '';
                    // Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: Ø¹Ø±Ø¶ Ø¹Ù…Ù„Ø§Ø¦Ù‡ Ø£Ùˆ ØºÙŠØ± Ø§Ù„Ù…ÙØ¹ÙŠÙ‘Ù†ÙŠÙ†ØŒ Ø¨Ø¯ÙˆÙ† Ø¥Ø¯Ø§Ø±Ø©
                    return !assigned || assigned === currentUser.id;
                }
                return true; // Ø£Ø¯ÙˆØ§Ø± Ø£Ø®Ø±Ù‰
            });
            if (filteredCustomers.length === 0) {
                customersList.innerHTML = '<p class="text-gray-500 text-center mt-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„" Ù„Ù„Ø¨Ø¯Ø¡.</p>';
                return;
            }
            filteredCustomers.forEach(customer => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm';
                const address = customer.address || '';
                const isLink = address.startsWith('http');
                const priceList = findPriceList(customer.priceListId);
                const repName = customer.repName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const taxRequired = customer.requiresTaxFiling;
                const cid = customer.id || customer._id || '';
                const assignedRepId = customer.assignedRepId || '';
                const isMine = assignedRepId && currentUser && currentUser.id === assignedRepId;
                const assignedBadge = assignedRepId
                    ? (isMine ? '<span class="text-xs font-semibold bg-green-100 text-green-700 rounded-full px-2 py-0.5">Ù…Ø®ØµØµ Ù„Ùƒ</span>' : '<span class="text-xs bg-gray-100 text-gray-600 rounded-full px-2 py-0.5">Ù…Ø®ØµØµ</span>')
                    : '<span class="text-xs bg-yellow-100 text-yellow-700 rounded-full px-2 py-0.5">ØºÙŠØ± Ù…ÙØ¹ÙŠÙ‘Ù†</span>';
                const manageAllowed = (typeof canManageCustomer === 'function') ? canManageCustomer(customer) : true;
                let priceListInfoHTML = `<div class="mt-2"><span class="text-sm text-gray-800 bg-gray-100 rounded-full px-2 py-0.5">Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±</span></div>`;
                if (priceList) {
                    const discountMatch = priceList.name.match(/\(Ø®ØµÙ… (.*?)%\)/);
                    const baseName = discountMatch ? priceList.name.replace(discountMatch[0], '').trim() : priceList.name;
                    let baseTag = `<span class="text-sm text-blue-800 bg-blue-100 rounded-full px-2 py-0.5">${baseName}</span>`;
                    let discountTag = discountMatch ? ` <span class="text-sm text-red-800 bg-red-100 rounded-full px-2 py-0.5">Ø®ØµÙ… ${discountMatch[1]}%</span>` : '';
                    priceListInfoHTML = `<div class="mt-2 flex flex-wrap gap-1 items-center">${baseTag}${discountTag}</div>`;
                }
                const taxTag = taxRequired ? `<span class="text-xs font-semibold bg-orange-100 text-orange-800 rounded-full px-2 py-0.5 flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> ÙŠØªØ·Ù„Ø¨ Ø±ÙØ¹ Ø¶Ø±ÙŠØ¨ÙŠ</span>` : '';
                // Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ù„Ø§ ØªØ¹ÙŠÙŠÙ†/Ù„Ø§ ØªØ¹Ø¯ÙŠÙ„/Ù„Ø§ Ø­Ø°Ù)
                const claimBtnHtml = (role === 'rep') ? '' : (!assignedRepId ? `<button data-id="${cid}" class="claim-customer-btn text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">ØªØ¹ÙŠÙŠÙ† Ù„ÙŠ</button>` : '');
                const actionsHtml = (role !== 'rep' && manageAllowed)
                    ? `<div class="flex"><button data-id="${cid}" class="edit-customer-btn p-2 text-gray-500 hover:text-blue-600" title="ØªØ¹Ø¯ÙŠÙ„"><i data-lucide="edit" class="w-5 h-5"></i></button><button data-id="${cid}" class="delete-customer-btn p-2 text-gray-500 hover:text-red-600" title="Ø­Ø°Ù"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`
                    : `<div class="flex opacity-50 cursor-not-allowed" title="Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„"><button data-id="${cid}" class="p-2 text-gray-400" disabled><i data-lucide="edit" class="w-5 h-5"></i></button><button data-id="${cid}" class="p-2 text-gray-400" disabled><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`;

                el.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-lg">${customer.name} ${taxRequired ? `<i data-lucide=\"file-text\" class=\"w-4 h-4 inline text-orange-500 mr-2\" title=\"ÙŠØªØ·Ù„Ø¨ Ø±ÙØ¹ Ø¶Ø±ÙŠØ¨ÙŠ\"></i>` : ''}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="landmark" class="w-3 h-3"></i> Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: ${customer.taxNumber || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="phone" class="w-3 h-3"></i> ${customer.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${isLink ? `<a href="${address}" target="_blank" class="text-blue-600 hover:underline">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>` : address || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="user" class="w-3 h-3"></i> Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: <span class="font-semibold text-gray-700">${repName}</span> ${assignedBadge}</p>${priceListInfoHTML}</div><div class="flex flex-col items-end gap-2">${taxTag}${claimBtnHtml}${actionsHtml}<button data-id="${cid}" class="ai-followup-btn text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-md flex items-center gap-1 hover:bg-purple-200"><span>âœ¨</span> Ø±Ø³Ø§Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©</button></div></div>`;
                customersList.appendChild(el);
            });
            updateIcons();
        }

        // --- ETA TAX INTEGRATION STUBS & HELPERS ---
        const taxConfig = {
            vatStandardRate: 0.14,
            taxCodes: {
                T1: { description: 'Value Added Tax', subTypes: { V009: 'General Item sales', V003: 'Exempted good or service' } },
                T4: { description: 'Withholding Tax', subTypes: { W004: 'Services' } }
            },
            uom: { EA: 'Each', KGM: 'Kilogram', LTR: 'Liter', BOX: 'Box', DZ: 'Dozen', M: 'Meter', H: 'Hour', MIN: 'Minute' }
        };

        // Chain Management (local-only storage)
        const CHAINS_LS_KEY = 'customerChains';
        function loadChains() { try { const raw = localStorage.getItem(CHAINS_LS_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; } catch(e){ return []; } }
        function saveChains(chains){ try{ localStorage.setItem(CHAINS_LS_KEY, JSON.stringify(chains || [])); } catch(e){ console.warn('saveChains failed', e); } }

        function renderChainsDisplay(){
            const chains = loadChains();
            const container = document.getElementById('chains-display');
            if(!container) return;
            if(chains.length === 0) { container.innerHTML = ''; return; }
            
            container.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded p-3"><div class="text-sm font-semibold mb-2">Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</div><div class="space-y-2"></div></div>';
            const chainList = container.querySelector('.space-y-2');
            chains.forEach(chain => {
                const customerNames = chain.customerIds.map(cid => { const c = findCustomer(cid); return c ? c.name : cid; }).join(', ');
                const badge = document.createElement('div');
                badge.className = 'flex justify-between items-center bg-white p-2 rounded border border-blue-200 text-sm';
                badge.innerHTML = `
                    <div class="cursor-pointer flex-1" data-view-chain-id="${chain.id}"><span class="font-medium text-blue-600 hover:underline">${(chain.name||'').replace(/</g,'&lt;')}</span><br><span class="text-xs text-gray-600">${customerNames || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„Ø§Ø¡'}</span></div>
                    <div class="flex gap-1">
                        <button data-chain-id="${chain.id}" class="edit-chain-btn px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button data-chain-id="${chain.id}" class="delete-chain-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">Ø­Ø°Ù</button>
                    </div>
                `;
                chainList.appendChild(badge);
            });
        }

        function openViewChainModal(chainId){
            const chains = loadChains();
            const chain = chains.find(c => c.id === chainId);
            if(!chain) return;
            
            const modal = document.createElement('div');
            modal.id = 'view-chain-modal';
            modal.style.position = 'fixed'; modal.style.left = '0'; modal.style.top = '0'; modal.style.right = '0'; modal.style.bottom = '0'; modal.style.zIndex = '9999';
            
            const customerNames = chain.customerIds.map(cid => { const c = findCustomer(cid); return c ? c.name : cid; });
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black/40" id="view-chain-backdrop"></div>
                <div class="fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded shadow-lg p-4 z-50">
                    <h3 class="font-semibold mb-3">Ø§Ù„Ø³Ù„Ø³Ù„Ø©: ${(chain.name||'').replace(/</g,'&lt;')}</h3>
                    <div class="mb-4"><label class="block text-sm font-medium mb-2">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©:</label><div class="border rounded p-3 bg-gray-50">${customerNames.length > 0 ? customerNames.map(n => `<div class="py-1 text-sm">â€¢ ${n}</div>`).join('') : '<div class="text-sm text-gray-500">Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„Ø§Ø¡</div>'}</div></div>
                    <div class="flex justify-end gap-2"><button id="view-chain-edit-btn" data-chain-id="${chainId}" class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">ØªØ¹Ø¯ÙŠÙ„</button><button id="view-chain-close-btn" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Ø¥ØºÙ„Ø§Ù‚</button></div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#view-chain-close-btn')?.addEventListener('click', () => modal.remove());
            modal.querySelector('#view-chain-backdrop')?.addEventListener('click', () => modal.remove());
            modal.querySelector('#view-chain-edit-btn')?.addEventListener('click', function(){ 
                modal.remove(); 
                openAddChainModal(chainId); 
            });
        }

        function openAddChainModal(chainId){
            const chains = loadChains();
            const editChain = chainId ? chains.find(c => c.id === chainId) : null;
            const modal = document.createElement('div');
            modal.id = 'add-chain-modal';
            modal.style.position = 'fixed'; modal.style.left = '0'; modal.style.top = '0'; modal.style.right = '0'; modal.style.bottom = '0'; modal.style.zIndex = '9999';
            
            const title = editChain ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black/40" id="add-chain-backdrop"></div>
                <div class="fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded shadow-lg p-4 z-50 max-h-80 overflow-y-auto">
                    <h3 class="font-semibold mb-3">${title}</h3>
                    <div class="mb-3"><label class="block text-sm font-medium mb-1">Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø³Ù„Ø©</label><input id="chain-name-input" class="w-full p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø³Ù„Ø©" value="${editChain ? (editChain.name||'').replace(/"/g,'&quot;') : ''}"></div>
                    <div class="mb-3"><label class="block text-sm font-medium mb-1">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</label><div id="chain-customers-list" class="max-h-48 overflow-y-auto border rounded p-2 bg-gray-50"></div></div>
                    <div class="flex justify-end gap-2"><button id="chain-cancel-btn" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button><button id="chain-save-btn" class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Ø­ÙØ¸</button></div>
                </div>
            `;
            document.body.appendChild(modal);

            // populate customers
            const listWrap = modal.querySelector('#chain-customers-list');
            const customers = Array.isArray(state.customers) ? state.customers : [];
            if (customers.length === 0) listWrap.innerHTML = '<div class="text-sm text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</div>';
            else {
                const selected = editChain ? (editChain.customerIds || []) : [];
                listWrap.innerHTML = customers.map(c => `<label class="flex items-center gap-2 p-2 hover:bg-blue-100 rounded"><input type="checkbox" data-cid="${c.id}" ${selected.includes(c.id) ? 'checked' : ''} /> <span class="text-sm">${(c.name||'').replace(/</g,'&lt;')}</span></label>`).join('');
            }

            // handlers
            modal.querySelector('#chain-cancel-btn').addEventListener('click', closeAddChainModal);
            modal.querySelector('#add-chain-backdrop')?.addEventListener('click', closeAddChainModal);
            modal.querySelector('#chain-save-btn').addEventListener('click', function(){
                const name = (modal.querySelector('#chain-name-input').value||'').trim();
                if (!name) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø³Ù„Ø©'); return; }
                const checked = Array.from(modal.querySelectorAll('input[type=checkbox][data-cid]:checked')).map(cb=>cb.getAttribute('data-cid'));
                const allChains = loadChains();
                if (editChain) {
                    const idx = allChains.findIndex(c => c.id === editChain.id);
                    if(idx >= 0) { allChains[idx].name = name; allChains[idx].customerIds = checked; }
                } else {
                    const id = 'chain-' + Date.now().toString(36);
                    allChains.push({ id, name, customerIds: checked });
                }
                saveChains(allChains);
                closeAddChainModal();
                renderChainsDisplay();
            });
        }
        function closeAddChainModal(){ const m = document.getElementById('add-chain-modal'); if(m) m.remove(); }

        // wire the Add Chain button and edit/delete handlers
        document.addEventListener('click', function(e){
            if (e.target.closest && e.target.closest('#add-chain-btn')) { openAddChainModal(); }
            const viewDiv = e.target.closest('[data-view-chain-id]');
            if(viewDiv) { const chainId = viewDiv.getAttribute('data-view-chain-id'); openViewChainModal(chainId); }
            const editBtn = e.target.closest('.edit-chain-btn');
            if(editBtn) { const chainId = editBtn.getAttribute('data-chain-id'); openAddChainModal(chainId); }
            const delBtn = e.target.closest('.delete-chain-btn');
            if(delBtn) {
                const chainId = delBtn.getAttribute('data-chain-id');
                if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø©ØŸ')) {
                    let chains = loadChains();
                    chains = chains.filter(c => c.id !== chainId);
                    saveChains(chains);
                    renderChainsDisplay();
                }
            }
        });

        // Render chains on page load
        function initializeChainsDisplay() { renderChainsDisplay(); }

        

        // Stable canonicalization per ITIDA rules (alphabetic field ordering, drop null/empty, recurse)
        function stableCanonical(value) {
            if (value === null || value === undefined) return undefined;
            if (typeof value !== 'object') {
                if (value === '') return undefined; // drop empty strings
                return value; // primitive
            }
            if (Array.isArray(value)) {
                const arr = value.map(v => stableCanonical(v)).filter(v => v !== undefined);
                return arr;
            }
            // Object: sort keys alphabetically
            const keys = Object.keys(value).sort();
            const out = {};
            for (const k of keys) {
                const v = stableCanonical(value[k]);
                if (v !== undefined) out[k] = v;
            }
            return out;
        }

        async function sha256Utf8Canonical(obj) {
            const canonicalObj = stableCanonical(obj);
            const json = JSON.stringify(canonicalObj);
            const enc = new TextEncoder();
            const data = enc.encode(json);
            const hashBuf = await crypto.subtle.digest('SHA-256', data);
            const hashArr = Array.from(new Uint8Array(hashBuf));
            return hashArr.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Discount rule placeholder (requires official clarification): beforeVAT or afterVAT
        let discountRule = 'beforeVAT'; // TODO: confirm officially

        function computeLineTotals(item, vatRate) {
            const qty = Number(item.quantity || 0);
            const unitPrice = Number(item.price || 0);
            const discountPercent = Number(item.discountPercent || 0);
            let base = unitPrice * qty;
            if (discountRule === 'beforeVAT') {
                base = base * (1 - discountPercent/100);
            }
            const taxAmount = base * vatRate;
            const total = base + taxAmount;
            return { base: round2(base), taxAmount: round2(taxAmount), total: round2(total) };
        }

        function round2(n){ return Math.round((n + Number.EPSILON)*100)/100; }

        // Transform internal sale to ETA invoice JSON (unsigned)
        function transformSaleToEtaInvoice(sale) {
                const taxId = '762878835'; // Company Tax ID for EGS format
                const customer = findCustomer(sale.customerId);
                // NEW: Return Detection and Styling
                const isReturn = sale.total < 0;
                const badgeText = isReturn ? 'Ù…Ø±ØªØ¬Ø¹' : 'ÙØ§ØªÙˆØ±Ø©';
                const badgeColor = isReturn ? 'bg-red-600 text-white' : 'bg-blue-600 text-white';
                const saleBgColor = isReturn ? 'bg-red-50 border-red-200' : `${(index % 2 === 0) ? 'bg-white' : 'bg-gray-50'} border-gray-200`;
                const totalAmountClass = isReturn ? 'text-red-700' : 'text-blue-700';
                
                // Build lines array with EGS itemCode formatting
                const lines = (sale.items || []).map((item, itemIndex) => {
                    const product = findProduct(item.productId);
                    const itemName = product && product.name ? product.name : (item.productName || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
                    const itemTotal = item.quantity * (item.price || 0) * (1 - (item.discountPercent || 0) / 100);
                    
                    // Transform itemCode to EGS format if needed
                    let itemCodeValue = product ? product.id : (item.productId || 'N/A');
                    let finalItemCode = itemCodeValue;
                    
                    // If code doesn't start with EG- or GS1 prefix (622), assume it's internal and prefix with EGS format
                    if (!finalItemCode.startsWith('EG-') && !finalItemCode.startsWith('622')) {
                      finalItemCode = `EG-${taxId}-${finalItemCode}`;
                    }
                    
                    return {
                        internalCode: item.productId || String(itemIndex + 1),
                        description: itemName,
                        itemCode: finalItemCode,
                        quantity: item.quantity || 0,
                        unitPrice: item.price || 0,
                        taxableAmount: round2(itemBase),
                        taxAmount: itemTax,
                        totalAmount: itemTotal
                    };
                });
                
                const itemsList = lines.map((line, itemIndex) => {
                    const itemTotalColorClass = isReturn ? 'text-red-700' : 'text-pink-700';
                    return `<tr class="text-xs border-b border-gray-100 last:border-b-0"><td class="text-right px-3 py-2 font-semibold sale-item-name-cell">${line.description}</td><td class="text-center px-3 py-2 sale-item-code-cell">${line.itemCode}</td><td class="text-center px-3 py-2 sale-item-qty-cell font-bold ${line.quantity < 0 ? 'text-red-600' : 'text-gray-800'}">${line.quantity}</td><td class="text-center px-3 py-2 sale-item-price-cell">${formatCurrency(line.unitPrice)}</td><td class="text-center px-3 py-2 font-bold sale-item-total-cell ${itemTotalColorClass}">${formatCurrency(line.totalAmount)}</td></tr>`;
                }).join('');
                
                const customerRequiresFiling = customer?.requiresTaxFiling;
                // +++ NEW: Get Tax Number HTML +++
                const customerTaxNumber = customer ? (customer.taxNumber || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            const invoice = {
                invoiceNumber: sale.invoiceNumber || sale.id,
                issueDateTime: new Date(sale.date).toISOString(),
                currency: 'EGP',
                seller: { name: state.companyName || 'Ø§Ù„Ø´Ø±ÙƒØ©', taxNumber: state.companyTaxId || '000000000' },
                buyer: { name: customer.name || 'Ø¹Ù…ÙŠÙ„', taxNumber: customer.taxNumber || '', type: 'B2B' },
                totals: {
                    totalLines: lines.length,
                    totalTaxable: round2(lines.reduce((s,l)=> s + l.taxableAmount,0)),
                    totalTax: round2(lines.reduce((s,l)=> s + l.taxAmount,0)),
                    totalAmount: round2(lines.reduce((s,l)=> s + l.totalAmount,0))
                },
                lines: lines,
                signature: null // to be filled later by CADES-BES
            };
            return invoice;
        }

        // Export selected tax invoices to JSON
        function exportTaxInvoicesToJson(sales) {
            const invoices = sales.map(transformSaleToEtaInvoice);
            const blob = new Blob([JSON.stringify(invoices, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'eta_invoices.json'; a.click();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }

        function exportTaxInvoicesToCsv(sales) {
            const invoices = sales.map(transformSaleToEtaInvoice);
            const header = ['invoiceNumber','issueDateTime','buyerName','buyerTaxNumber','lines','totalTaxable','totalTax','totalAmount'];
            const rows = invoices.map(inv => {
                const lineSummary = inv.lines.map(l=> `${l.itemCode}:${l.quantity}x${l.unitPrice}=${l.totalAmount}`).join('|');
                return [inv.invoiceNumber, inv.issueDateTime, inv.buyer.name, inv.buyer.taxNumber, lineSummary, inv.totals.totalTaxable, inv.totals.totalTax, inv.totals.totalAmount];
            });
            const csv = [header.join(','), ...rows.map(r=> r.map(x=> '"'+String(x).replace(/"/g,'""')+'"').join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'eta_invoices.csv'; a.click();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }

        function getCandidateSalesForTaxExport(){
            // Use current state: filter customers requiring tax filing
            return (state.sales||[]).filter(s => {
                const c = findCustomer(s.customerId);
                return c && c.requiresTaxFiling;
            });
        }

        document.addEventListener('click', function(e){
            if (e.target.closest && e.target.closest('#tax-export-json-btn')) {
                const candidates = getCandidateSalesForTaxExport();
                if (!candidates.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙŠØªØ·Ù„Ø¨ÙˆÙ† Ø±ÙØ¹ Ø¶Ø±ÙŠØ¨ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹.'); return; }
                exportTaxInvoicesToJson(candidates);
            }
            if (e.target.closest && e.target.closest('#tax-export-csv-btn')) {
                const candidates = getCandidateSalesForTaxExport();
                if (!candidates.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙŠØªØ·Ù„Ø¨ÙˆÙ† Ø±ÙØ¹ Ø¶Ø±ÙŠØ¨ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹.'); return; }
                exportTaxInvoicesToCsv(candidates);
            }
        });
        // --- END ETA TAX STUBS ---

        // ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹ ØªÙ†Ø§Ø¯ÙŠ renderCustomerList
        // Ø­Ø§ÙØ¸Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© renderCustomers ÙˆÙ†ÙˆÙÙ‘Ø± ØºÙ„Ø§ÙØ§Ù‹ Ø¨Ø³ÙŠØ·Ø§Ù‹.
        function renderCustomerList(filter = '') {
            try { return renderCustomers(filter); } catch(e){ console.warn('renderCustomerList alias failed', e); }
        }

        function renderReps() {
            const repsList = document.getElementById('reps-list');
            repsList.innerHTML = '';
            if (state.reps.length === 0) {
                repsList.innerHTML = '<p class="text-gray-500 text-center mt-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø§Ø¯ÙŠØ¨. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨" Ù„Ù„Ø¨Ø¯Ø¡.</p>';
                return;
            }
            state.reps.forEach(rep => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm';
                el.innerHTML = `<div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">${rep.name}</p>
                        <p class="text-sm text-gray-500 mt-1">Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„: ${rep.serial || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                        <p class="text-sm text-blue-600 font-semibold mt-1">Ø§Ù„ØªØ§Ø±Ø¬Øª: ${formatCurrency(rep.target)}</p>
                        <div class="text-sm text-red-600 font-semibold mt-1">
                            Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: 
                            <input type="number" class="rep-invoice-input" value="${rep.nextInvoiceNumber || 1}" data-rep-id="${rep.id}" style="width:80px; padding:4px; border: 1px solid #d1d5db; border-radius: 4px; margin-right: 6px;">
                            <button class="rep-invoice-save-btn" data-rep-id="${rep.id}" style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Ø­ÙØ¸</button>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <span class="font-mono text-xs">${rep.email || '-'}</span></p>
                    </div>
                    <div class="flex">
                        <button data-id="${rep.id}" class="edit-rep-btn p-2 text-gray-500 hover:text-blue-600"><i data-lucide="edit" class="w-5 h-5"></i></button>
                        <button data-id="${rep.id}" class="delete-rep-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>`;
                repsList.appendChild(el);
            });
            
            // Ø±Ø¨Ø· Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„
            document.querySelectorAll('.rep-invoice-save-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const repId = btn.dataset.repId;
                    const input = document.querySelector(`.rep-invoice-input[data-rep-id="${repId}"]`);
                    if (!input) return;
                    const newValue = parseInt(input.value);
                    if (isNaN(newValue) || newValue < 1) {
                        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† 0');
                        return;
                    }
                    const rep = state.reps.find(r => r.id === repId);
                    if (!rep) return;
                    rep.nextInvoiceNumber = newValue;
                    try {
                        await db.collection('reps').doc(repId).set({ nextInvoiceNumber: newValue }, { merge: true });
                        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨', rep.name, 'Ø¥Ù„Ù‰', newValue);
                        btn.textContent = 'âœ“';
                        setTimeout(() => { btn.textContent = 'Ø­ÙØ¸'; }, 1500);
                    } catch(err) {
                        alert('ÙØ´Ù„ Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + err.message);
                    }
                });
            });
            
            updateIcons();
        }

        function renderSettings(productFilter = '') {
            // Set sales target input
            const salesTargetInput = document.getElementById('sales-target-input');
            if (salesTargetInput && state.settings) salesTargetInput.value = state.settings.salesTarget || '';
                // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                const saveTargetBtn = document.getElementById('save-target-btn');
                if (saveTargetBtn && salesTargetInput) {
                    saveTargetBtn.onclick = function() {
                        const newTarget = Number(salesTargetInput.value);
                        if (isNaN(newTarget) || newTarget <= 0) {
                            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‡Ø¯Ù Ø´Ù‡Ø±ÙŠ ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
                            return;
                        }
                        if (typeof window.saveSalesTargetToCloud === 'function') {
                            saveTargetBtn.disabled = true;
                            saveTargetBtn.textContent = '...Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸';
                            window.saveSalesTargetToCloud(newTarget)
                                .then(() => {
                                    saveTargetBtn.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
                                    setTimeout(() => {
                                        saveTargetBtn.textContent = 'Ø­ÙØ¸';
                                        saveTargetBtn.disabled = false;
                                    }, 1200);
                                })
                                .catch(() => {
                                    saveTargetBtn.textContent = 'Ø­ÙØ¸';
                                    saveTargetBtn.disabled = false;
                                    alert('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
                                });
                        }
                    };
                }
            // set company logo input
            try {
                const logoInput = document.getElementById('company-logo-input');
                if (logoInput) logoInput.value = (state.settings && state.settings.companyLogo) ? state.settings.companyLogo : (window.DEFAULT_COMPANY_LOGO_URL || '');
            } catch (e) {}

            // Active period controls (month selector)
            try {
                const apInput = document.getElementById('active-period-input');
                const apBtn = document.getElementById('active-period-today-btn');
                const apInd = document.getElementById('active-period-indicator');
                const current = __formatPeriod(new Date());
                const active = (window.state && state.activePeriod) ? state.activePeriod : (localStorage.getItem('active_period') || current);
                if (apInput) {
                    apInput.value = active;
                    apInput.onchange = (e) => {
                        const val = (e && e.target && e.target.value) ? String(e.target.value) : current;
                        setActivePeriod(val);
                        // keep indicator in sync immediately
                        if (apInd) apInd.textContent = `Ø§Ù„Ø´Ù‡Ø±: ${val}`;
                    };
                }
                if (apBtn) {
                    apBtn.onclick = () => {
                        const nowVal = __formatPeriod(new Date());
                        if (apInput) apInput.value = nowVal;
                        setActivePeriod(nowVal);
                        if (apInd) apInd.textContent = `Ø§Ù„Ø´Ù‡Ø±: ${nowVal}`;
                    };
                }
                if (apInd) {
                    apInd.textContent = `Ø§Ù„Ø´Ù‡Ø±: ${active}`;
                }
            } catch (e) { console.warn('renderSettings active-period wiring failed', e); }

            // Products list
            const productsList = document.getElementById('products-list');
            if (productsList) {
                productsList.innerHTML = '';
                const filteredProducts = state.products.filter(p => p.name.toLowerCase().includes((productFilter || '').toLowerCase()));
                if (filteredProducts.length === 0) {
                    productsList.innerHTML = '<p class="text-gray-500 text-center text-sm p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.</p>';
                } else {
                    filteredProducts.forEach(product => {
                        const el = document.createElement('div');
                        el.className = 'bg-white p-2 rounded-md flex justify-between items-center border';
                        el.innerHTML = `
                            <div>
                                <p class="font-semibold">${escapeHtml(product.name)} (<span class="text-xs text-blue-500">${escapeHtml(String(product.id))}</span>)</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">${formatCurrency(product.price)}</span>
                                <button data-id="${product.id}" class="edit-product-btn p-1 text-gray-400 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-id="${product.id}" class="delete-product-btn p-1 text-gray-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        productsList.appendChild(el);
                    });
                }
            }

            // Update the small price-lists container only if it still exists (we moved management to dedicated page)
            const priceListsContainer = document.getElementById('price-lists-container');
            if (priceListsContainer) {
                priceListsContainer.innerHTML = '';
                if (!state.priceLists || state.priceLists.length === 0) {
                    priceListsContainer.innerHTML = '<p class="text-gray-500 text-center text-sm p-4">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± Ø¨Ø¹Ø¯.</p>';
                } else {
                    state.priceLists.forEach(pl => {
                        const el = document.createElement('div');
                        el.className = 'bg-white p-2 rounded-md flex justify-between items-center border';
                        el.innerHTML = `
                            <p class="font-semibold">${escapeHtml(pl.name)}</p>
                            <div class="flex items-center gap-2">
                                <button data-id="${pl.id}" class="edit-price-list-btn p-1 text-gray-400 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-id="${pl.id}" class="delete-price-list-btn p-1 text-gray-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        priceListsContainer.appendChild(el);
                    });
                }
            }

            updateIcons();

            // GPS controls wiring
            try { if (typeof setupGpsSharingControls === 'function') setupGpsSharingControls(); } catch(e){}
            try { if (typeof renderRepLocations === 'function') renderRepLocations(); } catch(e){}
        }

        function renderPromotions() {
            // New: render promotions as a compact table to match requested layout
            const listEl = document.getElementById('promotions-list');
            if (!listEl) return;
            listEl.innerHTML = '';
            // Keep batch editor controls in sync
            try {
                const custSel = document.getElementById('batch-promo-customer');
                if (custSel) {
                    custSel.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>' + (state.customers||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
                }
                const from = document.getElementById('batch-promo-from');
                const to = document.getElementById('batch-promo-to');
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                if (from && !from.value) from.value = todayStr;
                if (to && !to.value) { const d = new Date(); d.setMonth(d.getMonth()+1); to.value = d.toISOString().split('T')[0]; }
            } catch(e){}
            if (!state.promotions || state.promotions.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center mt-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            // Build table HTML
            const headerStyle = 'background:#000;padding:8px;color:#ffd54f;text-align:center;font-weight:700;border-bottom:3px solid #333;font-size:15px;';
            const cellStyle = 'padding:10px;border-bottom:1px solid rgba(0,0,0,0.05);text-align:center;font-size:15px;';
            const codeCellStyle = cellStyle + 'background:linear-gradient(90deg,#e9e8ff,#cbd7ff);font-weight:700;color:#0b3d91;';
            const rows = state.promotions.map(promo => {
                const product = findProduct(promo.productId);
                const customer = promo.customerId ? findCustomer(promo.customerId) : null;
                const name = product ? product.name : 'Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ';
                const code = product ? product.id : '';
                const custName = customer ? customer.name : 'Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡';
                // show start/end dates (when the promo starts/ends)
                const fromVal = promo.startDate ? formatArabicDate(promo.startDate) : (promo.from ?? promo.minQty ?? '');
                const toVal = promo.endDate ? formatArabicDate(promo.endDate) : (promo.to ?? promo.maxQty ?? '');
                const price = formatNumberEN(promo.price);

                // determine expiry - ØªØ­Ù‚Ù‚ ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ ÙƒÙ€ getActivePromotionPrice
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const endDate = new Date(promo.endDate);
                endDate.setHours(23, 59, 59, 999);
                const isExpired = today > endDate;

                // Column accent colors (consistent and visible)
                const priceAccentBg = 'background:linear-gradient(90deg,#fff8e1,#ffe0b2);color:#7a3f00;font-weight:700;';
                const productAccentBg = 'background:linear-gradient(90deg,#e8f7ff,#dbeefd);color:#0b3d91;font-weight:600;';
                const dateAccentBg = 'background:linear-gradient(90deg,#f0fff4,#e6fff0);color:#065f46;font-weight:600;';
                const customerAccentBg = 'background:linear-gradient(90deg,#fffdf6,#fff3e8);color:#3b3b3b;';

                // For visibility add a thin colored stripe on the left of key cells
                const priceCellStyle = `${cellStyle} ${priceAccentBg} border-left:6px solid #f59e0b;`;
                const productCellStyle = `${cellStyle} ${productAccentBg} border-left:6px solid #2563eb;`;
                const dateCellStyle = `${cellStyle} ${dateAccentBg} border-left:6px solid #10b981;`;
                const customerCellStyle = `${cellStyle} ${customerAccentBg}`;

                // expired badge remains but colors apply regardless so the UI looks consistent
                const expiredBadge = isExpired ? `<div style="margin-top:6px;font-size:12px;color:#7a1f1f;font-weight:800">Ù…Ù†ØªÙ‡ÙŠ</div>` : '';
                const priceHtml = `${price}${expiredBadge} <button data-promo-id="${promo.id}" class="edit-promo-btn" style="margin-left:8px;background:#2563eb;color:white;border:none;padding:4px 6px;border-radius:4px;font-size:12px;cursor:pointer">ØªØ¹Ø¯ÙŠÙ„</button>`;

                // subtle alternating row backgrounds for readability
                const rowAltBg = promo.__rowAlt ? 'background:linear-gradient(90deg, rgba(255,255,255,0.9) 0%, rgba(250,250,250,0.9) 100%);' : '';
                const rowBackground = rowAltBg || 'background:linear-gradient(90deg, rgba(249,224,190,1) 0%, rgba(245,183,77,0.08) 100%);';

                // Toggle alternate rows for nicer banding (based on index if present)
                // (we can't access index inside map easily here, but we can use a fallback plain background)
                return `
                    <tr style="${rowBackground}">
                        <td style="${priceCellStyle};width:90px;">${priceHtml}</td>
                        <td style="${dateCellStyle};width:120px;">${toVal}</td>
                        <td style="${dateCellStyle};width:120px;">${fromVal}</td>
                        <td style="${productCellStyle};">${escapeHtml(name)}</td>
                        <td style="${codeCellStyle};width:62px;">${escapeHtml(code)}</td>
                        <td style="${customerCellStyle};width:200px;">${escapeHtml(custName)}</td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                <div style="overflow:auto;"> 
                    <table style="width:100%;border-collapse:separate;border-spacing:0 6px;font-family:Arial, Helvetica, sans-serif;">
                        <thead>
                            <tr>
                                <th style="${headerStyle};width:90px;">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th style="${headerStyle};width:120px;">Ø­ØªÙ‰</th>
                                <th style="${headerStyle};width:120px;">Ù…Ù†</th>
                                <th style="${headerStyle};">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                                <th style="${headerStyle};width:62px;">ÙƒÙˆØ¯</th>
                                <th style="${headerStyle};width:200px;">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;

            listEl.innerHTML = tableHtml;
            updateIcons();

            // Wire edit buttons in promotions table to open the promotion modal
            try {
                listEl.querySelectorAll('.edit-promo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.promoId;
                        if (id) openPromotionModal(id);
                    });
                });
            } catch (e) { console.warn('Failed to wire promotion edit buttons', e); }
        }

        // === Batch Promotions logic ===
        function addBatchPromoRow(prefill) {
            const tbody = document.getElementById('batch-promo-rows');
            if (!tbody) return;
            const tr = document.createElement('tr');
            const rowBg = 'background:linear-gradient(90deg, rgba(249,224,190,1) 0%, rgba(245,183,77,0.08) 100%);';
            const cellBase = 'padding:8px;border-bottom:1px solid rgba(0,0,0,0.05);text-align:center;font-size:14px;';
            tr.innerHTML = `
                <td style="${cellBase};background:linear-gradient(90deg,#fff8e1,#ffe0b2);color:#7a3f00;font-weight:700;${rowBg}"><input type="number" class="bp-price p-1 border rounded w-24 text-center" step="any" placeholder="0"></td>
                <td style="${cellBase};${rowBg}"><input type="date" class="bp-to p-1 border rounded"></td>
                <td style="${cellBase};${rowBg}"><input type="date" class="bp-from p-1 border rounded"></td>
                <td style="${cellBase};background:linear-gradient(90deg,#e8f7ff,#dbeefd);color:#0b3d91;font-weight:600;${rowBg}"><input type="text" class="bp-name p-1 border rounded w-64" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" readonly></td>
                <td style="${cellBase};background:linear-gradient(90deg,#e9e8ff,#cbd7ff);font-weight:700;color:#0b3d91;${rowBg}"><input type="text" class="bp-code p-1 border rounded w-20 text-center" placeholder="ÙƒÙˆØ¯"></td>
                <td style="${cellBase};${rowBg}"><span class="bp-customer-display"></span></td>
                <td style="${cellBase};${rowBg}"><button type="button" class="bp-del px-2 py-1 bg-red-600 text-white rounded">Ø­Ø°Ù</button></td>`;
            tbody.appendChild(tr);

            const fromInput = tr.querySelector('.bp-from');
            const toInput = tr.querySelector('.bp-to');
            const codeInput = tr.querySelector('.bp-code');
            const nameInput = tr.querySelector('.bp-name');
            const priceInput = tr.querySelector('.bp-price');
            const custDisplay = tr.querySelector('.bp-customer-display');
            const custSel = document.getElementById('batch-promo-customer');
            const fromGlobal = document.getElementById('batch-promo-from');
            const toGlobal = document.getElementById('batch-promo-to');
            if (fromGlobal && !fromInput.value) fromInput.value = fromGlobal.value;
            if (toGlobal && !toInput.value) toInput.value = toGlobal.value;
            if (custSel) custDisplay.textContent = custSel.options[custSel.selectedIndex]?.text || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡';

            codeInput.addEventListener('change', () => {
                const p = getProductDetailsByCode(codeInput.value);
                if (p) { nameInput.value = p.name; nameInput.classList.remove('text-red-600'); }
                else { nameInput.value = 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­'; nameInput.classList.add('text-red-600'); }
            });
            document.getElementById('batch-promo-customer')?.addEventListener('change', () => {
                const sel = document.getElementById('batch-promo-customer');
                if (sel) custDisplay.textContent = sel.options[sel.selectedIndex]?.text || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡';
            });
            tr.querySelector('.bp-del').addEventListener('click', ()=> tr.remove());

            if (prefill) {
                if (prefill.code) { codeInput.value = prefill.code; codeInput.dispatchEvent(new Event('change')); }
                if (prefill.price) priceInput.value = prefill.price;
                if (prefill.from) fromInput.value = prefill.from;
                if (prefill.to) toInput.value = prefill.to;
            }
        }

        async function saveBatchPromotions() {
            const custId = document.getElementById('batch-promo-customer')?.value || null;
            const rows = Array.from(document.querySelectorAll('#batch-promo-rows tr'));
            if (!rows.length) { await customDialog({ message:'Ø£Ø¶Ù ØµÙØ§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.', title:'ØªÙ†Ø¨ÙŠÙ‡' }); return; }
            if (!window.db) { console.warn('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø²'); }

            const batch = window.db ? db.batch() : null;
            const toCreateLocal = [];
            let created = 0;
            for (const tr of rows) {
                const code = tr.querySelector('.bp-code').value.trim();
                const nameOk = !tr.querySelector('.bp-name').classList.contains('text-red-600');
                const price = parseFloat(tr.querySelector('.bp-price').value);
                const from = tr.querySelector('.bp-from').value;
                const to = tr.querySelector('.bp-to').value;
                if (!code || !nameOk || !from || !to || isNaN(price) || price <= 0) continue;
                const prod = getProductDetailsByCode(code);
                if (!prod) continue;
                const data = {
                    id: db && db.collection ? db.collection('promotions').doc().id : (Date.now()+''+Math.random()).slice(0,16),
                    name: `Ø¹Ø±Ø¶ ${prod.name}`,
                    productId: String(prod.id),
                    price: Number(price),
                    customerId: custId || null,
                    startDate: from,
                    endDate: to,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                if (batch) {
                    const ref = db.collection('promotions').doc(data.id);
                    batch.set(ref, data, { merge:false });
                } else {
                    toCreateLocal.push(data);
                }
                created++;
            }
            if (!created) { await customDialog({ message:'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© Ù„Ù„Ø­ÙØ¸.', title:'ØªÙ†Ø¨ÙŠÙ‡' }); return; }
            try {
                if (batch) await batch.commit();
                else {
                    // Local fallback
                    state.promotions = (state.promotions||[]).concat(toCreateLocal);
                }
                await customDialog({ message:`ØªÙ… Ø­ÙØ¸ ${created} Ø¹Ø±Ø¶`, title:'ØªÙ…' });
                // Clear grid
                document.getElementById('batch-promo-rows').innerHTML = '';
                renderPromotions();
            } catch (e) {
                console.warn('saveBatchPromotions failed', e);
                await customDialog({ message:'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', title:'Ø®Ø·Ø£' });
            }
        }

        function calculateCustomerBalances() { 
            // Build balances map from sales only so we show only customers who have invoices
            // Normalize keys to strings to avoid mismatches between numeric/string ids
            const map = new Map();
            try {
                (state.sales || []).forEach(sale => {
                    const key = String(sale.customerId === undefined || sale.customerId === null ? 'unknown' : sale.customerId);
                    const existing = map.get(key) || { name: (findCustomer(sale.customerId)?.name) || ('Ø¹Ù…ÙŠÙ„ ' + key), total: 0, paid: 0, balance: 0 };
                    existing.total = (existing.total || 0) + (sale.total || 0);
                    existing.paid = (existing.paid || 0) + ((typeof sale.paidAmount === 'number') ? sale.paidAmount : ((sale.status === 'paid') ? (sale.total || 0) : 0));
                    map.set(key, existing);
                });

                // compute balance for each entry
                map.forEach((v, k) => { v.balance = (v.total || 0) - (v.paid || 0); });
            } catch (e) {
                console.warn('calculateCustomerBalances error', e);
            }
            return map;
        }
        
        // Notification modal flow for Promotions "Ø§Ø®Ø·Ø§Ø±"
        function openNotifyModal(type) {
            const modal = document.getElementById('notify-modal');
            if (!modal) return;
            const title = modal.querySelector('#notify-modal-title');
            const typeInput = modal.querySelector('#notify-type');
            const productSelect = document.getElementById('notify-product');
            const promoSelect = document.getElementById('notify-promo');
            const newItemInput = document.getElementById('notify-new-item-name');
            const messageShort = document.getElementById('notify-short-text');
            const rowsBody = document.getElementById('notify-rows-body');
            const pasteArea = document.getElementById('notify-paste-area');
            const productContainer = document.getElementById('notify-product-container');
            const promoContainer = document.getElementById('notify-promo-container');
            const newItemContainer = document.getElementById('notify-new-item-container');

            // reset UI
            productContainer.style.display = 'none';
            promoContainer.style.display = 'none';
            newItemContainer.style.display = 'none';
            pasteArea.style.display = 'none';
            // clear rows
            rowsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ Ø¨Ø¹Ø¯.</td></tr>';

            // set modal according to type
            if (type === 'prices' || type === 'prices-select') {
                title.textContent = 'Ø§Ø®Ø·Ø§Ø± â€” ØªØºÙŠÙŠØ± Ø³Ø¹Ø±';
                typeInput.value = 'prices';
                productContainer.style.display = '';
                productSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option>' + (state.products || []).map(p => `<option value="${p.id}">${escapeHtml(p.name)} (${escapeHtml(String(p.id))})</option>`).join('');
            } else if (type === 'new-item') {
                title.textContent = 'Ø§Ø®Ø·Ø§Ø± â€” ØµÙ†Ù Ø¬Ø¯ÙŠØ¯';
                typeInput.value = 'new-item';
                newItemContainer.style.display = '';
            } else if (type === 'promotions') {
                title.textContent = 'Ø§Ø®Ø·Ø§Ø± â€” Ø¹Ø±Ø¶';
                typeInput.value = 'promotions';
                promoContainer.style.display = '';
                promoSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø¹Ø±Ø¶ --</option>' + (state.promotions || []).map(pr => `<option value="${pr.id}">${escapeHtml(pr.name || ('Ø¹Ø±Ø¶ ' + pr.id))}</option>`).join('');
            }

            // show modal
            modal.classList.remove('modal-hidden');
            modal.style.display = 'flex';
            // reset customer & global discount
            const notifyCustomer = document.getElementById('notify-customer');
            const notifyGlobal = document.getElementById('notify-global-discount');
            if (notifyCustomer) notifyCustomer.value = '';
            if (notifyGlobal) notifyGlobal.value = '';
            // populate customer select now (ensure it's filled even if state was loaded late)
            try {
                if (notifyCustomer) {
                    notifyCustomer.innerHTML = '<option value="">-- ØºÙŠØ± Ù…Ø­Ø¯Ø¯ --</option>' + (state.customers || []).map(c => `<option value="${c.id}">${escapeHtml(c.name || c.id)}</option>`).join('');
                }
            } catch (e) { console.warn('populate notify-customer failed', e); }
        }

        function closeNotifyModal() {
            const modal = document.getElementById('notify-modal');
            if (!modal) return;
            modal.classList.add('modal-hidden');
            modal.style.display = 'none';
        }

        function sendNotification(e) {
            e.preventDefault();
            const form = document.getElementById('notify-form');
            const type = document.getElementById('notify-type-select')?.value || document.getElementById('notify-type')?.value || 'prices';
            const title = document.getElementById('notify-title')?.value || '';
            const shortText = document.getElementById('notify-short-text')?.value || '';
            const productId = document.getElementById('notify-product')?.value || null;
            const promoId = document.getElementById('notify-promo')?.value || null;
            const newItemName = document.getElementById('notify-new-item-name')?.value || null;
            const customerId = document.getElementById('notify-customer')?.value || null;
            const globalDiscount = parseFloat(document.getElementById('notify-global-discount')?.value) || 0;

            // gather rows from table
            const rows = [];
            const rowsBody = document.getElementById('notify-rows-body');
            if (rowsBody) {
                Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                    const code = tr.querySelector('.nr-code')?.value || '';
                    if (!code) return; // skip empty rows
                    const name = tr.querySelector('.nr-name')?.value || '';
                    const price = parseFloat(tr.querySelector('.nr-price')?.value) || 0;
                    const discount = parseFloat(tr.querySelector('.nr-discount')?.value) || 0;
                    const priceAfter = parseFloat(tr.querySelector('.nr-price-after')?.value) || Math.round((price * (1 - (discount/100))) * 100)/100;
                    rows.push({ code, name, price, discount, priceAfter });
                });
            }

            state.notifications = state.notifications || [];
            const notif = { id: 'n_' + Date.now(), type, title, shortText, productId, promoId, newItemName, customerId, globalDiscount, rows, date: new Date().toISOString() };
            state.notifications.push(notif);
            // persist notifications so they survive reloads
            try { saveState(); } catch (e) { console.warn('saveState failed after creating notification', e); }
            console.log('Notification created:', notif);
            closeNotifyModal();
            try { renderNotifications(); } catch (e) { console.warn('renderNotifications error', e); }
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø®Ø·Ø§Ø± Ù…Ø­Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶Ù‡ Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ø£Ø®Ø·Ø§Ø± Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶.');
        }

        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            if (!container) return;
            container.innerHTML = '';
            const list = (state.notifications || []).slice().reverse();
            if (list.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center mt-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®Ø·Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø§Ø®Ø·Ø§Ø±" Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯.</p>';
                return;
            }
            list.forEach(notif => {
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded-lg border shadow-sm';
                const title = escapeHtml(notif.title || (notif.type || 'Ø§Ø®Ø·Ø§Ø±'));
                const short = escapeHtml(notif.shortText || '');
                const rowsHtml = (notif.rows || []).map(r => `<tr><td class="px-2 py-1 text-right">${escapeHtml(r.code)}</td><td class="px-2 py-1">${escapeHtml(r.name)}</td><td class="px-2 py-1 text-center">${formatCurrency(r.price)}</td><td class="px-2 py-1 text-center">${r.discount || 0}%</td><td class="px-2 py-1 text-center">${formatCurrency(r.priceAfter)}</td></tr>`).join('');
                const tableHtml = notif.rows && notif.rows.length > 0 ? `<div class="overflow-x-auto mt-2"><table class="min-w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-2 py-1 text-right">ÙƒÙˆØ¯</th><th class="px-2 py-1">ØµÙ†Ù</th><th class="px-2 py-1 text-center">Ø³Ø¹Ø±</th><th class="px-2 py-1 text-center">Ø®ØµÙ…</th><th class="px-2 py-1 text-center">Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>` : '';
                el.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="font-semibold">${title}</h4><div class="text-xs text-gray-500">${short}</div></div><div class="text-xs text-gray-500">${new Date(notif.date).toLocaleString()}</div></div>${tableHtml}<div class="flex justify-end gap-2 mt-3"><button data-id="${notif.id}" class="view-notif-btn bg-blue-600 text-white px-3 py-1 rounded-md">Ø¹Ø±Ø¶</button><button data-id="${notif.id}" class="delete-notif-btn bg-red-100 text-red-600 px-3 py-1 rounded-md">Ø­Ø°Ù</button></div>`;
                container.appendChild(el);
            });

            // wire view & delete
            container.querySelectorAll('.view-notif-btn').forEach(b => b.addEventListener('click', (e) => {
                const id = b.dataset.id;
                const n = (state.notifications || []).find(x => x.id === id);
                if (!n) return alert('Ø§Ù„Ø¥Ø®Ø·Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                // open a quick display modal (reuse notify modal in read-only)
                openNotifyModal(n.type);
                // fill fields read-only
                setTimeout(() => {
                    document.getElementById('notify-title').value = n.title || '';
                    document.getElementById('notify-short-text').value = n.shortText || '';
                    // restore customer and global discount if present
                    try { if (document.getElementById('notify-customer')) document.getElementById('notify-customer').value = n.customerId || ''; } catch(e){}
                    try { if (document.getElementById('notify-global-discount')) document.getElementById('notify-global-discount').value = n.globalDiscount || ''; } catch(e){}
                    // fill rows
                    const body = document.getElementById('notify-rows-body'); body.innerHTML = '';
                    (n.rows || []).forEach(r => addRowPreview(r));
                }, 120);
            }));
            container.querySelectorAll('.delete-notif-btn').forEach(b => b.addEventListener('click', (e) => {
                const id = b.dataset.id;
                state.notifications = (state.notifications || []).filter(x => x.id !== id);
                try { saveState(); } catch (e) { console.warn('saveState failed after deleting notification', e); }
                renderNotifications();
            }));
        }

        function addRowPreview(r) {
            const body = document.getElementById('notify-rows-body');
            if (!body) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(r.code||'')}</td><td class="px-2 py-1">${escapeHtml(r.name||'')}</td><td class="px-2 py-1 text-center">${formatCurrency(r.price||0)}</td><td class="px-2 py-1 text-center">${r.discount||0}%</td><td class="px-2 py-1 text-center">${formatCurrency(r.priceAfter||0)}</td><td></td>`;
            body.appendChild(tr);
        }

        // Wire dropdown toggle & options
        document.addEventListener('click', (ev) => {
            const root = document.getElementById('promotions-notify-root');
            if (!root) return;
            const btn = document.getElementById('promotions-notify-btn');
            const menu = document.getElementById('promotions-notify-menu');
            if (!btn || !menu) return;
            if (btn.contains(ev.target)) {
                // toggle
                if (menu.classList.contains('hidden')) menu.classList.remove('hidden'); else menu.classList.add('hidden');
                return;
            }
            // if clicked an option
            if (ev.target && ev.target.classList && ev.target.classList.contains('notify-option')) {
                const t = ev.target.dataset.notifyType;
                menu.classList.add('hidden');
                openNotifyModal(t);
                return;
            }
            // click outside: hide menu
            if (!root.contains(ev.target)) {
                menu.classList.add('hidden');
            }
        });

        // Wire notify form submit
        document.addEventListener('DOMContentLoaded', () => {
            const notifyForm = document.getElementById('notify-form');
            if (notifyForm) notifyForm.addEventListener('submit', sendNotification);
            // Wire UI inside notify modal: add row, paste area, type selector
            const addRowBtn = document.getElementById('notify-add-row-btn');
            const pasteBtn = document.getElementById('notify-paste-btn');
            const pasteArea = document.getElementById('notify-paste-area');
            const rowsBody = document.getElementById('notify-rows-body');
            const typeSelect = document.getElementById('notify-type-select');
            const productContainer = document.getElementById('notify-product-container');
            const promoContainer = document.getElementById('notify-promo-container');
            const newItemContainer = document.getElementById('notify-new-item-container');

            function addNotifyRow(data = {}) {
                if (!rowsBody) return;
                // remove placeholder row
                if (rowsBody.children.length === 1 && rowsBody.children[0].querySelector('td') && rowsBody.children[0].querySelector('td').colSpan == 6) rowsBody.innerHTML = '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-2 py-1"><input class="nr-code w-full p-1 border rounded text-sm" value="${escapeHtml(data.code||'')}"></td>
                    <td class="px-2 py-1"><input class="nr-name w-full p-1 border rounded text-sm" value="${escapeHtml(data.name||'')}"></td>
                    <td class="px-2 py-1 text-center"><input type="number" step="any" class="nr-price w-24 p-1 border rounded text-sm text-center" value="${data.price||''}"></td>
                    <td class="px-2 py-1 text-center"><input type="number" step="any" class="nr-discount w-20 p-1 border rounded text-sm text-center" value="${data.discount||0}"></td>
                    <td class="px-2 py-1 text-center"><input readonly class="nr-price-after w-28 p-1 border rounded text-sm text-center bg-gray-50" value="${data.priceAfter||''}"></td>
                    <td class="px-2 py-1 text-center"><button type="button" class="nr-remove text-red-600 px-2 py-1">Ø­Ø°Ù</button></td>
                `;
                rowsBody.appendChild(tr);
                // attach handlers
                const priceInput = tr.querySelector('.nr-price');
                const discInput = tr.querySelector('.nr-discount');
                const priceAfterInput = tr.querySelector('.nr-price-after');
                const codeInput = tr.querySelector('.nr-code');
                const nameInput = tr.querySelector('.nr-name');
                function recompute() {
                    const p = parseFloat(priceInput.value) || 0;
                    const d = parseFloat(discInput.value) || 0;
                    const after = Math.round((p * (1 - d/100)) * 100) / 100;
                    priceAfterInput.value = after === 0 ? '' : after;
                }
                priceInput.addEventListener('input', recompute);
                discInput.addEventListener('input', recompute);
                // when code changed, try to lookup product name and price (respect customer selection)
                function resolveCodeLookup() {
                    const code = codeInput.value && codeInput.value.trim();
                    if (!code) return;
                    // try find product by id first, fallback to product list search
                    let prod = findProduct(code) || state.products.find(p => String(p.id) === String(code));
                    if (!prod) {
                        // try search by barcode or code property if exists
                        prod = state.products.find(p => p.code && String(p.code) === String(code));
                    }
                    if (prod) {
                        nameInput.value = prod.name || '';
                        // determine base price for selected customer
                        const customerId = document.getElementById('notify-customer')?.value || null;
                        let basePrice = prod.price || 0;
                        if (customerId) {
                            const customer = findCustomer(customerId);
                            if (customer && customer.priceListId) {
                                const pl = findPriceList(customer.priceListId);
                                if (pl && pl.productPrices && pl.productPrices[prod.id] !== undefined) basePrice = pl.productPrices[prod.id];
                            }
                        }
                        // check active promotions
                        const promoPrice = getActivePromotionPrice(prod.id, customerId);
                        let finalPrice = promoPrice !== null ? promoPrice : basePrice;
                        priceInput.value = parseFloat(finalPrice).toFixed(2);
                        recompute();
                    }
                }
                // attach multiple triggers (change, blur, Enter key, and small-debounced input)
                codeInput.addEventListener('change', resolveCodeLookup);
                codeInput.addEventListener('blur', resolveCodeLookup);
                let codeInputTimer = null;
                codeInput.addEventListener('input', () => { clearTimeout(codeInputTimer); codeInputTimer = setTimeout(resolveCodeLookup, 300); });
                codeInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); resolveCodeLookup(); } });
                const removeBtn = tr.querySelector('.nr-remove');
                removeBtn.addEventListener('click', () => { tr.remove(); if (rowsBody.children.length === 0) rowsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ Ø¨Ø¹Ø¯.</td></tr>'; });
            }

            // helper: parse localized number strings (commas, spaces, etc.) to float
            function parseLocalizedNumber(str) {
                if (str === undefined || str === null) return NaN;
                let s = String(str).trim();
                if (s === '') return NaN;
                // remove thousands separators (commas, spaces)
                s = s.replace(/[,\s\u00A0]/g, '');
                // replace comma decimal with dot if user used comma as decimal and dot not present
                // (already removed commas as thousands separators above), but still handle Arabic decimal comma
                s = s.replace(/ØŒ/g, '.');
                // if multiple dots exist, keep last dot as decimal separator
                const parts = s.split('.');
                if (parts.length > 2) {
                    const last = parts.pop();
                    s = parts.join('') + '.' + last;
                }
                const v = parseFloat(s);
                return isNaN(v) ? NaN : v;
            }

            // apply global discount to all rows
            const globalDiscountInput = document.getElementById('notify-global-discount');
            if (globalDiscountInput) {
                globalDiscountInput.addEventListener('input', () => {
                    const v = parseLocalizedNumber(globalDiscountInput.value);
                    Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                        const disc = tr.querySelector('.nr-discount');
                        if (disc) {
                            disc.value = isNaN(v) ? '' : v;
                            // trigger recompute by dispatching input
                            disc.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    });
                });
            }

            // when customer selection changes, re-resolve prices for existing rows
            const notifyCustomerSelect = document.getElementById('notify-customer');
            if (notifyCustomerSelect) {
                // populate options
                notifyCustomerSelect.innerHTML = '<option value="">-- ØºÙŠØ± Ù…Ø­Ø¯Ø¯ --</option>' + (state.customers || []).map(c => `<option value="${c.id}">${escapeHtml(c.name || c.id)}</option>`).join('');
                notifyCustomerSelect.addEventListener('change', () => {
                    const cid = notifyCustomerSelect.value || null;
                    Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                        const code = tr.querySelector('.nr-code')?.value?.trim();
                        const priceInput = tr.querySelector('.nr-price');
                        const nameInput = tr.querySelector('.nr-name');
                        const discInput = tr.querySelector('.nr-discount');
                        const priceAfterInput = tr.querySelector('.nr-price-after');
                        if (!code) return;
                        const prod = findProduct(code) || state.products.find(p => String(p.id) === String(code) || (p.code && String(p.code) === String(code)));
                        if (prod) {
                            nameInput.value = prod.name || '';
                            let basePrice = prod.price || 0;
                            if (cid) {
                                const customer = findCustomer(cid);
                                if (customer && customer.priceListId) {
                                    const pl = findPriceList(customer.priceListId);
                                    if (pl && pl.productPrices && pl.productPrices[prod.id] !== undefined) basePrice = pl.productPrices[prod.id];
                                }
                            }
                            const promoPrice = getActivePromotionPrice(prod.id, cid);
                            const finalPrice = promoPrice !== null ? promoPrice : basePrice;
                            priceInput.value = parseFloat(finalPrice).toFixed(2);
                            // re-apply global discount if exists
                            const g = parseLocalizedNumber(globalDiscountInput?.value || '');
                            if (!isNaN(g) && g !== '') discInput.value = g;
                            // recompute
                            const p = parseFloat(priceInput.value) || 0;
                            const d = parseFloat(discInput.value) || 0;
                            priceAfterInput.value = Math.round((p * (1 - d/100)) * 100) / 100 || '';
                        }
                    });
                });
            }

            if (addRowBtn) addRowBtn.addEventListener('click', () => addNotifyRow({price: '', discount: 0}));
            if (pasteBtn && pasteArea) {
                pasteBtn.addEventListener('click', () => { pasteArea.style.display = pasteArea.style.display === 'none' ? '' : 'none'; });
                pasteArea.addEventListener('paste', (ev) => {
                    ev.preventDefault();
                    const text = (ev.clipboardData || window.clipboardData).getData('text');
                    pasteArea.value = text;
                    // parse lines
                    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                    lines.forEach(line => {
                        // split by tab first, fallback to multiple spaces or comma
                        const cols = line.split(/\t|\s{2,}|,/).map(c => c.trim()).filter(c => c !== '');
                        // assume first column is code, second maybe name, third price, fourth discount
                        const code = cols[0] || '';
                        const name = cols[1] || '';
                        const priceRaw = cols[2] || '';
                        const discRaw = cols[3] || cols[2] || '';
                        const price = parseLocalizedNumber(priceRaw) || 0;
                        const discount = parseLocalizedNumber(discRaw) || 0;
                        const priceAfter = Math.round((price * (1 - discount/100)) * 100) / 100;
                        addNotifyRow({ code, name, price: price === 0 ? '' : price, discount: discount === 0 ? 0 : discount, priceAfter });
                        // after adding row, try to auto-resolve product and per-customer price
                        setTimeout(() => {
                            const last = rowsBody.lastElementChild;
                            if (!last) return;
                            const codeVal = last.querySelector('.nr-code')?.value?.trim();
                            if (codeVal) {
                                const prod = findProduct(codeVal) || state.products.find(p => String(p.id) === String(codeVal) || (p.code && String(p.code) === String(codeVal)));
                                if (prod) {
                                    const nameEl = last.querySelector('.nr-name');
                                    if (nameEl && (!nameEl.value || nameEl.value.trim() === '')) nameEl.value = prod.name || '';
                                    const customerId = document.getElementById('notify-customer')?.value || null;
                                    let basePrice = prod.price || 0;
                                    if (customerId) {
                                        const customer = findCustomer(customerId);
                                        if (customer && customer.priceListId) {
                                            const pl = findPriceList(customer.priceListId);
                                            if (pl && pl.productPrices && pl.productPrices[prod.id] !== undefined) basePrice = pl.productPrices[prod.id];
                                        }
                                    }
                                    const promoPrice = getActivePromotionPrice(prod.id, customerId);
                                    const finalPrice = promoPrice !== null ? promoPrice : basePrice;
                                    const priceEl = last.querySelector('.nr-price');
                                    if (priceEl && (!priceEl.value || parseLocalizedNumber(priceEl.value) === 0)) priceEl.value = parseFloat(finalPrice).toFixed(2);
                                    const discEl = last.querySelector('.nr-discount');
                                    const p = parseFloat((priceEl.value && priceEl.value.trim()) ? parseLocalizedNumber(priceEl.value) : finalPrice) || 0;
                                    const d = parseFloat(discEl?.value) || 0;
                                    const afterEl = last.querySelector('.nr-price-after');
                                    if (afterEl) afterEl.value = Math.round((p * (1 - d/100)) * 100) / 100 || '';
                                }
                            }
                        }, 50);
                    });
                });
            }

            if (typeSelect) {
                typeSelect.addEventListener('change', () => {
                    const v = typeSelect.value;
                    productContainer.style.display = v === 'prices' ? '' : 'none';
                    promoContainer.style.display = v === 'promotions' ? '' : 'none';
                    newItemContainer.style.display = v === 'new-item' ? '' : 'none';
                });
            }

            // Render notifications list when the page loads
            renderNotifications();
            // Wire promotions/notifications toggle
            const promosBtn = document.getElementById('promotions-view-btn');
            const notifsBtn = document.getElementById('notifications-view-btn');
            const promosList = document.getElementById('promotions-list');
            const notifsList = document.getElementById('notifications-list');
                if (promosBtn && notifsBtn && promosList && notifsList) {
                    promosBtn.addEventListener('click', () => {
                        promosList.classList.remove('hidden');
                        notifsList.classList.add('hidden');
                        // active = promos
                        promosBtn.classList.add('bg-blue-600','text-white');
                        promosBtn.classList.remove('bg-white','text-gray-700','border');
                        // deactivate notifs
                        notifsBtn.classList.remove('bg-blue-600','text-white');
                        notifsBtn.classList.add('bg-white','text-gray-700','border');
                    });
                    notifsBtn.addEventListener('click', () => {
                        notifsList.classList.remove('hidden');
                        promosList.classList.add('hidden');
                        // active = notifs
                        notifsBtn.classList.add('bg-blue-600','text-white');
                        notifsBtn.classList.remove('bg-white','text-gray-700','border');
                        // deactivate promos
                        promosBtn.classList.remove('bg-blue-600','text-white');
                        promosBtn.classList.add('bg-white','text-gray-700','border');
                    });
                }
            // Wire saving company logo button
            const saveLogoBtn = document.getElementById('save-company-logo-btn');
            if (saveLogoBtn) {
                saveLogoBtn.addEventListener('click', () => {
                    const val = (document.getElementById('company-logo-input') || {}).value || '';
                    state.settings = state.settings || {};
                    state.settings.companyLogo = val.trim();
                    saveState();
                    renderCompanyLogo();
                    try { applyWatermark(state.settings.companyLogo || ''); } catch(e) { console.warn('applyWatermark failed on save', e); }
                    alert('ØªÙ… Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±. Ø³ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­Ù‹Ø§.');
                });
            }
            // Auto-save logo when user pastes/changes the input (so they don't have to press save each time)
            const logoInput = document.getElementById('company-logo-input');
            if (logoInput) {
                const saveLogoFromInput = () => {
                    const val = (logoInput.value || '').trim();
                    state.settings = state.settings || {};
                    state.settings.companyLogo = val;
                    try { saveState(); } catch(e) { console.warn('saveState failed while auto-saving logo', e); }
                    try { renderCompanyLogo(); } catch(e) {}
                    try { applyWatermark(val || ''); } catch(e) { console.warn('applyWatermark failed while auto-saving logo', e); }
                };
                logoInput.addEventListener('change', saveLogoFromInput);
                logoInput.addEventListener('blur', saveLogoFromInput);
            }
            // render company logo initially
            try { renderCompanyLogo(); } catch(e) {}
            // WhatsApp share button: build message from current modal fields and open wa.me
            const shareBtn = document.getElementById('notify-share-wa-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    // build message from modal
                    const type = document.getElementById('notify-type-select')?.value || document.getElementById('notify-type')?.value || 'prices';
                    const title = document.getElementById('notify-title')?.value || '';
                    const shortText = document.getElementById('notify-short-text')?.value || '';
                    const logoUrl = document.getElementById('notify-logo-url')?.value || '';
                    const customerId = document.getElementById('notify-customer')?.value || '';
                    const customerName = customerId ? (findCustomer(customerId)?.name || customerId) : '';
                    const rows = [];
                    const rowsBody = document.getElementById('notify-rows-body');
                    if (rowsBody) {
                        Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                            const code = tr.querySelector('.nr-code')?.value || '';
                            if (!code) return;
                            const name = tr.querySelector('.nr-name')?.value || '';
                            const price = tr.querySelector('.nr-price')?.value || '';
                            const discount = tr.querySelector('.nr-discount')?.value || '';
                            const after = tr.querySelector('.nr-price-after')?.value || '';
                            rows.push({ code, name, price, discount, after });
                        });
                    }
                    if ((rows || []).length === 0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©. Ø£Ø¶Ù Ø£ØµÙ†Ø§ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.');
                    // header by type
                    let header = 'Delente ERP ØªÙ‚Ø¯Ù… Ù„Ø³ÙŠØ§Ø¯ØªÙƒÙ… '; 
                    if (type === 'prices') header += 'Ø§Ø³Ø¹Ø§Ø± Ø§Ù„Ø§ØµÙ†Ø§Ù Ø§Ù„ØªØ§Ù„ÙŠØ©:'; else if (type === 'promotions') header += 'Ø§Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ§Ù„ÙŠØ©:'; else if (type === 'new-item') header = 'Delente ERP â€” Ø§Ø¹Ù„Ø§Ù† ØµÙ†Ù Ø¬Ø¯ÙŠØ¯:';
                    let msg = header + '\n';
                    if (customerName) msg += 'Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + customerName + '\n';
                    if (title) msg += 'Ø¹Ù†ÙˆØ§Ù†: ' + title + '\n';
                    if (shortText) msg += shortText + '\n';
                    msg += '\n';
                    // rows
                    rows.forEach(r => {
                        // format each row compactly
                        const parts = [];
                        if (r.code) parts.push('ÙƒÙˆØ¯: ' + r.code);
                        if (r.name) parts.push('ØµÙ†Ù: ' + r.name);
                        if (r.price) parts.push('Ø³Ø¹Ø±: ' + r.price);
                        if (r.discount) parts.push('Ø®ØµÙ…: ' + r.discount + '%');
                        if (r.after) parts.push('Ø¨Ø¹Ø¯: ' + r.after);
                        msg += parts.join(' | ') + '\n';
                    });
                    if (logoUrl) msg += '\n' + 'Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©: ' + logoUrl + '\n';
                    msg += '\n' + '-- Ù…Ù† ÙØ±ÙŠÙ‚ Delente ERP';
                    const waUrl = 'https://wa.me/?text=' + encodeURIComponent(msg);
                    window.open(waUrl, '_blank');
                });
            }
        });

    function renderDebts() {
            // Initialize variables
            const customerFilterText = (document.getElementById('debt-customer-filter') || {}).value || '';
            const repFilter = (document.getElementById('debt-rep-filter') || {}).value || '';
            const startDateVal = (document.getElementById('debt-start-date') || {}).value || '';
            const endDateVal = (document.getElementById('debt-end-date') || {}).value || '';

            // Populate rep dropdown
            const repSelect = document.getElementById('debt-rep-filter');
            if (repSelect) {
                repSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</option>';
                [...new Set(state.sales.map(s => s.repName))].filter(name => name).sort().forEach(name => {
                    repSelect.innerHTML += `<option value="${name}" ${name === repFilter ? 'selected' : ''}>${name}</option>`;
                });
            }

            // Populate customer dropdown with only customers that have at least one invoice (paid or due)
            try {
                const custSelect = document.getElementById('debt-customer-filter');
                if (custSelect) {
                    const customerIds = Array.from(new Set((state.sales || []).map(s => s.customerId).filter(id => id !== undefined && id !== null)));
                    // Build options preserving previous selection if any
                    const prevValue = (custSelect.value || '');
                    let options = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>';
                    customerIds.sort((a,b) => {
                        const aName = (findCustomer(a) && findCustomer(a).name) ? findCustomer(a).name.toLowerCase() : String(a);
                        const bName = (findCustomer(b) && findCustomer(b).name) ? findCustomer(b).name.toLowerCase() : String(b);
                        return aName.localeCompare(bName);
                    }).forEach(id => {
                        const name = (findCustomer(id) && findCustomer(id).name) ? findCustomer(id).name : ('Ø¹Ù…ÙŠÙ„ ' + id);
                        options += `<option value="${id}" ${String(id) === String(prevValue) ? 'selected' : ''}>${name}</option>`;
                    });
                    custSelect.innerHTML = options;
                }
            } catch (e) { console.warn('Failed to populate debt customer select', e); }

            // If no filters provided -> show aggregated debts per customer
            const noFilters = !customerFilterText && !repFilter && !startDateVal && !endDateVal;

            // Small debug output: print counts and show on-screen banner to help diagnose invisible/missing data
            try {
                const debugEl = document.getElementById('debts-debug');
                console.log('renderDebts called', { sales: (state.sales || []).length, customers: (state.customers || []).length, noFilters });
                if (debugEl) {
                    debugEl.style.display = 'block';
                    try {
                        const salesPreview = (state.sales || []).slice(0,5).map(s => ({ invoice: s.invoiceNumber || s.id, date: s.date ? s.date.split('T')[0] : '', total: s.total || 0 }));
                        const customersPreview = (state.customers || []).slice(0,5).map(c => ({ id: c.id, name: c.name }));
                        const lines = [
                            `Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${(state.sales || []).length} Ù…Ø¨ÙŠØ¹Ø§ØªØŒ ${(state.customers || []).length} Ø¹Ù…Ù„Ø§Ø¡`,
                            `Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ: ${noFilters ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`,
                            `Ø£Ù…Ø«Ù„Ø© Ù…Ø¨ÙŠØ¹Ø§Øª: ${salesPreview.map(s => `${s.invoice}:${s.total}`).join(' | ') || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}`,
                            `Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„Ø§Ø¡: ${customersPreview.map(c => c.name).join(' | ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}`
                        ];
                        debugEl.textContent = lines.join(' â€” ');
                    } catch (e) {
                        debugEl.textContent = `Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${(state.sales || []).length} Ù…Ø¨ÙŠØ¹Ø§ØªØŒ ${(state.customers || []).length} Ø¹Ù…Ù„Ø§Ø¡ â€” Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ: ${noFilters ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`;
                    }
                }
            } catch (e) { console.warn('Debts debug banner update failed', e); }

            const tbody = document.getElementById('debts-detail-body');
            const emptyMessage = document.getElementById('debts-empty-message');
            if (!tbody) return;
            // Initialize table with empty content and proper styles
            tbody.innerHTML = '';
            const dataCellStyle = 'padding:8px;border:1px solid #ddd;background:white;color:black;font-size:14px;text-align:center;';
            const rightCellStyle = dataCellStyle + 'text-align:right;';
            const centerCellStyle = dataCellStyle + 'text-align:center;';
            const moneyStyle = dataCellStyle + 'font-weight:bold;color:#1d4f91;';

            // Force table styling
            try {
                const table = document.getElementById('debts-detail-table');
                if (table) {
                    table.style.cssText = 'width:100% !important;border-collapse:collapse !important;font-family:Arial,sans-serif !important;direction:rtl !important;';
                }
            } catch (e) {}

            // If no filters provided -> show invoice-level rows (all invoices)
            let filteredSales = [];
            if (noFilters) {
                filteredSales = (state.sales || []).slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            } 

            // Otherwise, apply filters and show invoice-level rows
            const startDate = startDateVal ? new Date(startDateVal + 'T00:00:00') : null;
            const endDate = endDateVal ? new Date(endDateVal + 'T23:59:59') : null;

            if (!filteredSales.length) {
                filteredSales = state.sales.filter(sale => {
                const saleDate = sale.date ? new Date(sale.date) : null;
                if (startDate && saleDate && saleDate < startDate) return false;
                if (endDate && saleDate && saleDate > endDate) return false;
                if (customerFilterText) {
                    // If the filter control is a select we expect an id value -> match by id
                    const custControl = document.getElementById('debt-customer-filter');
                    if (custControl && custControl.tagName === 'SELECT') {
                        if (String(sale.customerId) !== String(customerFilterText)) return false;
                    } else {
                        const custName = (findCustomer(sale.customerId)?.name || '').toLowerCase();
                        if (!custName.includes(customerFilterText.toLowerCase())) return false;
                    }
                }
                if (repFilter) {
                    if (!sale.repName || sale.repName.toLowerCase() !== repFilter.toLowerCase()) return false;
                }
                return true;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
            }

            // Apply "Show Unpaid Only" filter
            const hidePaidCheckbox = document.getElementById('hide-paid-debts');
            const hidePaid = hidePaidCheckbox ? hidePaidCheckbox.checked : true; // Default to true (hide paid)
            
            if (hidePaid) {
                filteredSales = filteredSales.filter(sale => {
                    const paidAmount = sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0);
                    const remainingAmount = (sale.total || 0) - paidAmount;
                    return remainingAmount > 0.01; // Show only if remaining debt > 0
                });
            }

            // Apply column sort state (Excel-style) before computing stats
            try {
                if (window.debtsSortState && window.debtsSortState.column && window.debtsSortState.direction) {
                    const { column, direction } = window.debtsSortState;
                    const dir = direction === 'desc' ? -1 : 1;
                    const getValue = (sale) => {
                        if (column === 'customer') return (findCustomer(sale.customerId)?.name || '').toLowerCase();
                        if (column === 'rep') return (sale.repName || '').toLowerCase();
                        if (column === 'date') return sale.date ? sale.date.split('T')[0] : '';
                        if (column === 'invoice') return String(sale.invoiceNumber || '');
                        if (column === 'total') return Number(sale.total || 0);
                        if (column === 'paid') return Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0));
                        if (column === 'remaining') return Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)));
                        return '';
                    };
                    filteredSales.sort((a,b)=>{
                        const va = getValue(a);
                        const vb = getValue(b);
                        // Numeric compare if both numbers
                        if (typeof va === 'number' && typeof vb === 'number') {
                            return (va - vb) * dir;
                        }
                        return String(va).localeCompare(String(vb), 'ar') * dir;
                    });
                }
            } catch(e){ console.warn('debts sort failed', e); }

            // Compute stats
            const subtotal = filteredSales.reduce((s, r) => s + (r.total || 0), 0);
            const paidSum = filteredSales.reduce((s, r) => s + (r.paidAmount || (r.status === 'paid' ? (r.total || 0) : 0)), 0);
            const invoicesCount = filteredSales.length;
            const debtsTotal = filteredSales.reduce((s, r) => s + ((r.total || 0) - (r.paidAmount || (r.status === 'paid' ? (r.total || 0) : 0))), 0);

            // Preserve original rendered sales for column filters if any active
            // Support both the old `_columnFilterState` (legacy) and the new `debtsColumnFilters` state.
            const hasActiveColumnFilters = (
                (window.debtsColumnFilters && Object.keys(window.debtsColumnFilters).some(c => window.debtsColumnFilters[c] && window.debtsColumnFilters[c].length > 0)) ||
                (window._columnFilterState && Object.keys(window._columnFilterState).some(c => window._columnFilterState[c] && window._columnFilterState[c].length > 0))
            );
            if (hasActiveColumnFilters) {
                try { window._debtsFiltersOriginalRenderedSales = Array.isArray(filteredSales) ? filteredSales.slice() : filteredSales; } catch (e) { window._debtsFiltersOriginalRenderedSales = filteredSales; }
            } else {
                window._debtsFiltersOriginalRenderedSales = null;
            }
            // Save last rendered for CSV/print
            window._lastRenderedDebtsSales = filteredSales;
            window._lastRenderedDebtsStats = { subtotal, paid: paidSum, count: invoicesCount, debts: debtsTotal };

            // Update summary boxes with formatted numbers (without currency symbol)
            const subtotalEl2 = document.getElementById('debts-subtotal');
            const paidEl2 = document.getElementById('debts-paid');
            const countEl2 = document.getElementById('debts-invoices-count');
            const debtsEl2 = document.getElementById('debts-total-debt');
            
            // Format numbers without currency symbol, just the number with commas
            const formatBoxNumber = (num) => Math.abs(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            if (subtotalEl2) subtotalEl2.textContent = formatBoxNumber(subtotal);
            if (paidEl2) paidEl2.textContent = formatBoxNumber(paidSum);
            if (countEl2) countEl2.textContent = formatBoxNumber(invoicesCount);
            if (debtsEl2) debtsEl2.textContent = formatBoxNumber(debtsTotal);

            if (invoicesCount === 0) {
                if (emptyMessage) emptyMessage.classList.remove('hidden');
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ±.</td></tr>`;
                return;
            } else {
                if (emptyMessage) emptyMessage.classList.add('hidden');
            }

            // Render invoice-level rows; use inline styles to be robust against external CSS
            filteredSales.forEach((sale, idx) => {
                const tr = document.createElement('tr');
                try { tr.style.display = 'table-row'; tr.style.visibility = 'visible'; tr.style.opacity = '1'; } catch (e) {}
                const custName = findCustomer(sale.customerId)?.name || 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ';
                const dateText = sale.date ? formatArabicDate(sale.date) : '';
                const invoiceNum = sale.invoiceNumber || '';
                const total = formatCurrency(sale.total || 0);
                const paid = formatCurrency(sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0));
                const remaining = formatCurrency((sale.total || 0) - (sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0)));
                const rep = sale.repName || '';
                // Format numbers without currency symbol for table cells
                const formatTableNumber = (num) => Math.abs(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                const formattedTotal = formatTableNumber(sale.total || 0);
                const formattedPaid = formatTableNumber(sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0));
                const formattedRemaining = formatTableNumber((sale.total || 0) - (sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0)));
                
                const html = `
                    <td style="${rightCellStyle}" class="customer-name">${custName}</td>
                    <td style="${centerCellStyle}" class="date">${dateText}</td>
                    <td style="${centerCellStyle}" class="invoice-number">${invoiceNum}</td>
                    <td style="${moneyStyle}" class="total">${formattedTotal}</td>
                    <td style="${moneyStyle}" class="paid">${formattedPaid}</td>
                    <td style="${moneyStyle}" class="remaining">${formattedRemaining}</td>
                    <td style="${centerCellStyle}" class="rep-name">${rep}</td>
                `;
                tr.innerHTML = html;
                // tag row with sale id for robust mapping
                try {
                    if (sale && (sale.id !== undefined && sale.id !== null)) tr.dataset.saleId = String(sale.id);
                    else if (sale && sale.invoiceNumber) tr.dataset.saleId = String(sale.invoiceNumber);
                    // add raw data attributes for robust filtering
                    if (sale) {
                        try { if (sale.customerId !== undefined && sale.customerId !== null) tr.dataset.customerId = String(sale.customerId); } catch(e){}
                        try { tr.dataset.date = sale.date ? sale.date.split('T')[0] : ''; } catch(e){}
                        try { tr.dataset.invoice = sale.invoiceNumber ? String(sale.invoiceNumber) : ''; } catch(e){}
                        try { tr.dataset.total = String(Number(sale.total || 0)); } catch(e){}
                        try { const paidRaw = Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)); tr.dataset.paid = String(paidRaw); } catch(e){}
                        try { const rem = Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))); tr.dataset.remaining = String(rem); } catch(e){}
                        try { tr.dataset.rep = sale.repName ? String(sale.repName) : ''; } catch(e){}
                    }
                } catch(e){}
                // add alternating classes for gold styling
                // Add visual indicators for balances - using black color now to match screenshot
                const remainingCell = tr.querySelector('.remaining');
                if (remainingCell) {
                    const remainingValue = parseFloat(formattedRemaining.replace(/,/g, ''));
                    remainingCell.style.color = 'black'; // All numbers in black to match screenshot
                }
                tbody.appendChild(tr);
            });

                updateIcons();

            // Re-apply column filters if present (keeps filters working after other filter interactions)
            try {
                if (typeof window.applyDebtsColumnFilters === 'function') {
                    window.applyDebtsColumnFilters();
                }
            } catch (e) { /* ignore */ }
        }
        
        function calculateRepBalances() { 
            const repBalances = new Map(); state.reps.forEach(rep => { repBalances.set(rep.name, { totalSales: 0, totalCollected: 0, balance: 0, repId: rep.id }); }); state.sales.forEach(sale => { const repEntry = repBalances.get(sale.repName); if (repEntry) { repEntry.totalSales += (sale.total || 0); repEntry.totalCollected += (typeof sale.paidAmount === 'number' ? sale.paidAmount : (sale.status === 'paid' ? sale.total : 0)) || 0; } }); repBalances.forEach(entry => { entry.balance = entry.totalSales - entry.totalCollected; }); 
            return repBalances; 
        }

        // --- Debts Column Filters (Excel-style) ---
        (function(){
            const debtsColumnFilters = {};
            let debtsSortState = { column: null, direction: null }; // 'asc' | 'desc'

            function normalizeRaw(v){ return (v === null || typeof v === 'undefined') ? '' : String(v).trim(); }

            function populateMenuList(menu, col){
                const listEl = menu.querySelector('.filter-list');
                listEl.innerHTML = '';
                const rows = window._lastRenderedDebtsSales || [];
                const map = new Map();
                rows.forEach(sale => {
                    let raw = ''; let disp = '';
                    if (col === 'customer') { raw = normalizeRaw(sale.customerId); disp = findCustomer(sale.customerId)?.name || raw; }
                    else if (col === 'date') { raw = sale.date ? sale.date.split('T')[0] : ''; disp = sale.date ? formatArabicDate(sale.date) : ''; }
                    else if (col === 'invoice') { raw = normalizeRaw(sale.invoiceNumber); disp = raw; }
                    else if (col === 'total') { const v = Number(sale.total || 0); raw = normalizeRaw(v); disp = Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'paid') { const v = Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)); raw = normalizeRaw(v); disp = Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'remaining') { const v = Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))); raw = normalizeRaw(v); disp = Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'rep') { raw = normalizeRaw(sale.repName); disp = raw; }
                    if (!map.has(raw)) map.set(raw, disp);
                });
                const items = Array.from(map.entries()).sort((a,b)=> String(a[1]).localeCompare(String(b[1]), 'ar'));
                items.forEach(([raw, disp]) => {
                    const id = 'cf-debts-' + col + '-' + Math.random().toString(36).slice(2,8);
                    const label = document.createElement('label');
                    label.style.display = 'block'; label.style.padding = '4px 2px';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = raw; cb.id = id;
                    if (Array.isArray(debtsColumnFilters[col]) && debtsColumnFilters[col].includes(raw)) cb.checked = true;
                    const txt = document.createTextNode(' ' + String(disp));
                    label.appendChild(cb); label.appendChild(txt);
                    listEl.appendChild(label);
                });
            }

            function syncSelectAll(menu, col){
                const selectAll = menu.querySelector('.select-all-checkbox');
                if (!selectAll) return;
                const boxes = Array.from(menu.querySelectorAll('.filter-list input[type="checkbox"]'));
                const active = debtsColumnFilters[col];
                if (!active || active.length === 0 || active.length === boxes.length) {
                    selectAll.checked = true; boxes.forEach(b => b.checked = true);
                } else {
                    boxes.forEach(b => b.checked = active.includes(b.value));
                    selectAll.checked = active.length === boxes.length;
                }
            }

            function buildMenu(col){
                const btn = document.querySelector(`.column-filter-btn[data-col="${col}"]`);
                if (!btn) return null;
                if (btn._menu) { populateMenuList(btn._menu, col); syncSelectAll(btn._menu, col); return btn._menu; }

                const menu = document.createElement('div');
                menu.className = 'column-filter-menu debts-filter-menu';
                menu.style.display = 'none';
                menu.style.zIndex = '99999';
                menu.style.minWidth = '220px';
                menu.style.paddingTop = '6px';
                menu.innerHTML = `
                    <div style="display:flex;gap:6px;justify-content:space-between;padding:0 8px 6px;">
                        <button type="button" class="sort-asc" style="flex:1;background:#f8fafc;border:1px solid #d1d5db;border-radius:4px;padding:4px 6px;font-size:11px;cursor:pointer;">ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ â†‘</button>
                        <button type="button" class="sort-desc" style="flex:1;background:#f8fafc;border:1px solid #d1d5db;border-radius:4px;padding:4px 6px;font-size:11px;cursor:pointer;">ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ â†“</button>
                    </div>
                    <label class="select-all-label" style="display:block;padding:4px 8px;border-top:1px solid #e2e8f0;margin-top:2px;font-size:12px;font-weight:600;">
                        <input type="checkbox" class="select-all-checkbox" checked style="transform:scale(1.1);margin-left:6px;" /> (ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„)
                    </label>
                    <input class="filter-search" placeholder="Ø¨Ø­Ø«..." style="margin:4px 8px;padding:4px 6px;width:calc(100% - 16px);border:1px solid #cbd5e1;border-radius:4px;font-size:12px;" />
                    <div class="filter-list" style="max-height:200px;overflow:auto;padding:4px 8px;"></div>
                    <div class="filter-actions" style="display:flex;gap:6px;padding:8px 8px 6px;border-top:1px solid #e2e8f0;margin-top:4px;">
                        <button class="ok-btn" style="flex:1;background:#2563eb;color:white;border:none;border-radius:4px;padding:6px 4px;font-size:12px;cursor:pointer;font-weight:600;">Ù…ÙˆØ§ÙÙ‚</button>
                        <button class="cancel-btn" style="flex:1;background:#64748b;color:white;border:none;border-radius:4px;padding:6px 4px;font-size:12px;cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                        <button class="clear-btn" style="flex:1;background:#dc2626;color:white;border:none;border-radius:4px;padding:6px 4px;font-size:12px;cursor:pointer;">Ù…Ø³Ø­</button>
                    </div>
                `;
                document.body.appendChild(menu);

                // Search filter
                menu.querySelector('.filter-search').addEventListener('input', (e)=>{
                    const q = (e.target.value || '').trim().toLowerCase();
                    menu.querySelectorAll('.filter-list label').forEach(lbl=>{
                        lbl.style.display = (lbl.textContent||'').toLowerCase().includes(q) ? '' : 'none';
                    });
                });

                // Sorting controls
                menu.querySelector('.sort-asc').addEventListener('click', ()=>{
                    debtsSortState = { column: col, direction: 'asc' };
                    try { window.debtsSortState = debtsSortState; } catch(e){}
                    renderDebts();
                    try { applyDebtsColumnFilters(); } catch(e){}
                    hideAllMenus();
                });
                menu.querySelector('.sort-desc').addEventListener('click', ()=>{
                    debtsSortState = { column: col, direction: 'desc' };
                    try { window.debtsSortState = debtsSortState; } catch(e){}
                    renderDebts();
                    try { applyDebtsColumnFilters(); } catch(e){}
                    hideAllMenus();
                });

                // Select all checkbox behavior
                menu.querySelector('.select-all-checkbox').addEventListener('change', (e)=>{
                    const checked = e.target.checked;
                    menu.querySelectorAll('.filter-list input[type="checkbox"]').forEach(cb => cb.checked = checked);
                });

                // OK / Cancel / Clear
                menu.querySelector('.ok-btn').addEventListener('click', ()=>{
                    const allBoxes = Array.from(menu.querySelectorAll('.filter-list input[type="checkbox"]'));
                    const checked = allBoxes.filter(cb => cb.checked).map(cb => cb.value);
                    debtsColumnFilters[col] = (checked.length === 0 || checked.length === allBoxes.length) ? [] : checked;
                    applyDebtsColumnFilters();
                    hideAllMenus();
                });
                menu.querySelector('.cancel-btn').addEventListener('click', ()=> hideAllMenus());
                menu.querySelector('.clear-btn').addEventListener('click', ()=>{
                    debtsColumnFilters[col] = [];
                    applyDebtsColumnFilters();
                    hideAllMenus();
                });

                btn._menu = menu;
                populateMenuList(menu, col);
                syncSelectAll(menu, col);
                return menu;
            }

            function showMenu(btn){
                const col = btn.dataset.col; if (!col) return;
                const menu = buildMenu(col); if (!menu) return;
                hideAllMenus();
                const rect = btn.getBoundingClientRect();
                menu.style.display = 'block';
                requestAnimationFrame(()=>{
                    const left = rect.left + window.scrollX - (menu.offsetWidth - rect.width);
                    menu.style.left = (left < 8 ? 8 : left) + 'px';
                    menu.style.top = (rect.bottom + window.scrollY + 4) + 'px';
                });
            }

            function hideAllMenus(){ document.querySelectorAll('.debts-filter-menu').forEach(m=>m.style.display='none'); }

            function updateDebtsFilterIndicators(){
                const cols = ['customer','date','invoice','total','paid','remaining','rep'];
                cols.forEach(col => {
                    const btn = document.querySelector(`.column-filter-btn[data-col="${col}"]`);
                    if (!btn) return;
                    const active = Array.isArray(debtsColumnFilters[col]) && debtsColumnFilters[col].length > 0;
                    if (active) btn.classList.add('filtered'); else btn.classList.remove('filtered');
                });
            }

            function applyDebtsColumnFilters(){
                const tbody = document.getElementById('debts-detail-body'); if (!tbody) return;
                const trs = Array.from(tbody.querySelectorAll('tr'));
                const activeCols = Object.keys(debtsColumnFilters).filter(c => Array.isArray(debtsColumnFilters[c]) && debtsColumnFilters[c].length>0);
                trs.forEach(tr=>{
                    let show = true;
                    for (const col of activeCols) {
                        const sel = debtsColumnFilters[col] || [];
                        let cellRaw = '';
                        try {
                            if (col === 'customer') cellRaw = normalizeRaw(tr.dataset.customerId);
                            else if (col === 'date') cellRaw = normalizeRaw(tr.dataset.date);
                            else if (col === 'invoice') cellRaw = normalizeRaw(tr.dataset.invoice);
                            else if (col === 'total') cellRaw = normalizeRaw(Number(tr.dataset.total||0));
                            else if (col === 'paid') cellRaw = normalizeRaw(Number(tr.dataset.paid||0));
                            else if (col === 'remaining') cellRaw = normalizeRaw(Number(tr.dataset.remaining||0));
                            else if (col === 'rep') cellRaw = normalizeRaw(tr.dataset.rep);
                        } catch(e){ cellRaw = ''; }
                        if (!sel.includes(String(cellRaw))) { show = false; break; }
                    }
                    if (show) { tr.classList.remove('hidden-by-filter'); tr.style.display = 'table-row'; }
                    else { tr.classList.add('hidden-by-filter'); tr.style.display = 'none'; }
                });

                const source = window._debtsFiltersOriginalRenderedSales || window._lastRenderedDebtsSales || [];
                const visibleSales = source.filter(sale => {
                    for (const col of activeCols) {
                        const sel = debtsColumnFilters[col] || [];
                        let raw = '';
                        if (col === 'customer') raw = normalizeRaw(sale.customerId);
                        else if (col === 'date') raw = sale.date ? sale.date.split('T')[0] : '';
                        else if (col === 'invoice') raw = normalizeRaw(sale.invoiceNumber);
                        else if (col === 'total') raw = normalizeRaw(Number(sale.total || 0));
                        else if (col === 'paid') raw = normalizeRaw(Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)));
                        else if (col === 'remaining') raw = normalizeRaw(Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))));
                        else if (col === 'rep') raw = normalizeRaw(sale.repName);
                        if (!sel.includes(String(raw))) return false;
                    }
                    return true;
                });
                window._lastRenderedDebtsSales = visibleSales;
                updateDebtsFilterIndicators();
            }

            // Open/close behavior
            document.addEventListener('click', (e)=>{
                const btn = e.target.closest('.column-filter-btn');
                if (btn) { e.stopPropagation(); showMenu(btn); return; }
                if (!e.target.closest('.debts-filter-menu')) hideAllMenus();
            });

            // Expose
            window.debtsColumnFilters = debtsColumnFilters;
            window.applyDebtsColumnFilters = applyDebtsColumnFilters;
            window.debtsSortState = debtsSortState;
            window.updateDebtsFilterIndicators = updateDebtsFilterIndicators;
            // Initial indicator paint (in case state restored elsewhere)
            try { updateDebtsFilterIndicators(); } catch(e){}
        })();

        function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        // Format numbers using English (en-US) digits with up to 2 decimals
        function formatNumberEN(v){
            const n = Number(v ?? 0);
            if (isNaN(n)) return '0';
            const hasFraction = Math.abs(n - Math.round(n)) > 0;
            return n.toLocaleString('en-US', { minimumFractionDigits: hasFraction ? 2 : 0, maximumFractionDigits: 2 });
        }
        async function loadReps() {
            const repSelect = document.getElementById('debt-rep-filter');
            // If running from file:// (offline) the browser blocks fetch to absolute/relative endpoints due to CORS.
            // In that case, use the local `state.reps` as a fallback.
            const isFileProtocol = window.location && window.location.protocol === 'file:';
            const fallbackPopulate = (reps) => {
                try {
                    if (!repSelect) return;
                    repSelect.innerHTML = `\n                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</option>\n                        ${reps.map(rep => `<option value="${rep.id}">${rep.name}</option>`).join('')}\n                    `;
                } catch (e) { console.warn('populate reps fallback failed', e); }
            };

            if (isFileProtocol) {
                // Offline mode: populate from local state immediately
                try {
                    const reps = Array.isArray(state.reps) ? state.reps : [];
                    fallbackPopulate(reps);
                    return reps;
                } catch (e) {
                    console.warn('loadReps fallback failed', e);
                    return [];
                }
            }

            // Otherwise attempt network fetch but gracefully fall back to local state on any failure
            try {
                const response = await fetch('/api/representatives', { cache: 'no-store' });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const reps = await response.json();
                fallbackPopulate(Array.isArray(reps) ? reps : []);
                return reps;
            } catch (error) {
                console.warn('Error loading representatives from network, falling back to local state:', error);
                const reps = Array.isArray(state.reps) ? state.reps : [];
                fallbackPopulate(reps);
                return reps;
            }
        }

        function renderRepDebts() {
            // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            loadReps();
             const tbody = document.getElementById('rep-debts-list-body'); if (!tbody) return; tbody.innerHTML = ''; const balances = Array.from(calculateRepBalances().entries()).map(([repName, obj]) => ({ repName, ...obj })).filter(r => r.totalSales > 0).sort((a, b) => b.balance - a.balance); if (balances.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø¨Ø¹Ø¯.</td></tr>`; return; } balances.forEach(row => { const balanceClass = row.balance > 0 ? 'text-red-700 font-bold' : (row.balance < 0 ? 'text-green-700 font-bold' : 'text-gray-700'); const balanceText = formatCurrency(row.balance); const tr = document.createElement('tr'); tr.className = 'hover:bg-orange-50'; tr.innerHTML = `<td class="px-4 py-3 text-right font-medium text-gray-800">${row.repName}</td><td class="px-4 py-3 text-center">${formatCurrency(row.totalSales)}</td><td class="px-4 py-3 text-center">${formatCurrency(row.totalCollected)}</td><td class="px-4 py-3 text-center ${balanceClass}">${balanceText}</td><td class="px-4 py-3 text-center"><button data-rep-name="${row.repName}" class="view-rep-summary-btn text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-md hover:bg-orange-200 transition">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button></td>`; tbody.appendChild(tr); }); tbody.querySelectorAll('.view-rep-summary-btn').forEach(button => { button.addEventListener('click', (e) => { const repName = e.currentTarget.dataset.repName; generateAndShowRepSummary(repName); }); }); updateIcons();
        }
        
        function generateAndShowRepSummary(repName) {
            const repSales = state.sales.filter(s => s.repName === repName).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); const repSummaryContent = document.getElementById('rep-sales-summary-content'); const repSummaryTitle = document.getElementById('rep-sales-summary-title'); if (!repSales.length) { repSummaryContent.innerHTML = `<p class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ${repName}.</p>`; repSummaryTitle.textContent = `ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${repName}`; openModal(repSalesSummaryModal); return; } const repBalances = calculateRepBalances().get(repName) || { totalSales: 0, totalCollected: 0, balance: 0 }; let html = `<div class="space-y-4"><div class="bg-orange-50 p-4 rounded-lg shadow-inner border border-orange-200"><p class="font-bold text-xl text-orange-700">${repName}</p><div class="grid grid-cols-3 gap-4 mt-2 text-sm"><p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> <span class="font-semibold text-blue-600">${formatCurrency(repBalances.totalSales)}</span></p><p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„:</strong> <span class="font-semibold text-green-600">${formatCurrency(repBalances.totalCollected)}</span></p><p><strong>Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©/Ø§Ù„Ù…Ø³ØªØ­Ù‚:</strong> <span class="font-bold ${repBalances.balance > 0 ? 'text-red-600' : 'text-gray-600'}">${formatCurrency(repBalances.balance)}</span></p></div></div><h3 class="font-bold text-gray-700 border-b pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="px-4 py-2 text-center">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th class="px-4 py-2 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="px-4 py-2 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th class="px-4 py-2 text-center">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th class="px-4 py-2 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${repSales.map(sale => `<tr><td class="px-4 py-2 whitespace-nowrap"><bdo dir="rtl">${formatArabicDate(sale.date)}</bdo></td><td class="px-4 py-2 text-center font-bold text-red-600">${sale.invoiceNumber}</td><td class="px-4 py-2 text-right">${findCustomer(sale.customerId)?.name || 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ'}</td><td class="px-4 py-2 text-center font-semibold ${sale.total < 0 ? 'text-red-600' : 'text-blue-600'}">${formatCurrency(sale.total)}</td><td class="px-4 py-2 text-center text-green-600">${formatCurrency(sale.paidAmount)}</td><td class="px-4 py-2 text-center">${getStatusBadge(sale.status)}</td></tr>`).join('')}</tbody></table></div></div>`; repSummaryContent.innerHTML = html; repSummaryTitle.textContent = `ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${repName}`; updateIcons(); openModal(repSalesSummaryModal);
        }

        function addRowToNewDispatchGrid(item = {}) {
            const container = document.getElementById('new-dispatch-items-container');
            if (!container) return;
            const row = document.createElement('tr');
            row.className = 'dispatch-item-row';
            
            const productOptions = state.products.map(p => 
                `<option value="${p.id}" ${item.productId === p.id ? 'selected' : ''}>${p.name}</option>`
            ).join('');

            // Removed goodReturn, damagedReturn, freebie inputs, added actualReturn input
            row.innerHTML = `
                <td class="px-2 py-1"><select class="dispatch-item-product w-full p-1 border rounded-md text-sm" required><option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬...</option>${productOptions}</select></td>
                <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="quantity" value="${item.quantity || ''}" placeholder="0" min="0"></td>
                <td><input class="w-full p-1 border rounded-md text-center text-sm actual-return-input" type="number" data-field="actualReturn" value="${item.actualReturn || ''}" placeholder="0" min="0"></td>
                <td class="px-2 py-1 text-center"><button type="button" class="delete-dispatch-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            `;
            
            container.appendChild(row);
            updateIcons();

            row.querySelector('.delete-dispatch-item-btn').addEventListener('click', () => {
                row.remove();
            });
        }

        async function saveNewDispatchNoteFromGrid() {
            const repName = document.getElementById('new-dispatch-rep').value;
            const date = document.getElementById('new-dispatch-date').value;
            const noteNumber = document.getElementById('new-dispatch-note-number').value;

            if (!repName || !date || !noteNumber) {
                await customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù† ÙˆØ§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('#new-dispatch-items-container .dispatch-item-row');
            for (const row of itemRows) {
                const productId = row.querySelector('.dispatch-item-product').value;
                const quantity = parseInt(row.querySelector('[data-field="quantity"]').value) || 0;
                const actualReturn = parseInt(row.querySelector('[data-field="actualReturn"]').value) || 0; // NEW

                if (productId && (quantity > 0 || actualReturn > 0)) { // Modified condition
                    items.push({ productId, quantity, actualReturn }); // Modified item object
                }
            }

            if (items.length === 0) {
                await customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¥Ø°Ù†.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }

            const noteData = {
                id: undefined, // Ø³ÙŠÙÙ†Ø´Ø£ Ù…Ù† Firestore
                noteNumber: parseInt(noteNumber),
                repName,
                date: new Date(date + 'T12:00:00Z').toISOString(),
                items,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null
            };

            try {
                await addDispatchNote(noteData);
                await customDialog({ message: 'ØªÙ… Ø­ÙØ¸ Ø¥Ø°Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­.', title: 'Ù†Ø¬Ø§Ø­' });
            } catch(e){
                console.warn('Failed to add dispatch note', e);
                await customDialog({ message:'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ù†. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.', title:'Ø®Ø·Ø£' });
            }

            initializeNewDispatchGrid();
        }

        function initializeNewDispatchGrid() {
            const repSelect = document.getElementById('new-dispatch-rep');
            const dateInput = document.getElementById('new-dispatch-date');
            const container = document.getElementById('new-dispatch-items-container');

            if (!repSelect || !dateInput || !container) return;

            populateRepDropdown(repSelect);
            dateInput.value = new Date().toISOString().split('T')[0];
            container.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                addRowToNewDispatchGrid();
            }
        }

        function renderDispatchPage() {
            const listEl = document.getElementById('dispatch-notes-list');
            listEl.innerHTML = '';
            const notesArr = Array.isArray(state.dispatchNotes) ? state.dispatchNotes : [];
            const sortedNotes = notesArr.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedNotes.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center mt-8 bg-white p-4 rounded-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ø³ØªÙ„Ø§Ù… Ø³Ø§Ø¨Ù‚Ø©.</p>';
                return;
            }

            sortedNotes.forEach(note => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm dispatch-note-card';
                el.dataset.noteId = note.id;
                el.innerHTML = `
                    <div class="flex justify-between items-start cursor-pointer dispatch-note-header">
                        <div>
                            <p class="font-bold text-lg">${note.repName}</p>
                            <p class="text-sm text-gray-500">Ø¨ØªØ§Ø±ÙŠØ®: ${new Date(note.date).toLocaleDateString('ar-EG')}</p>
                            <p class="text-xs text-gray-500 mt-1">${note.items.length} ØµÙ†Ù</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">ØªØ¹Ø¯ÙŠÙ„</span>
                            <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
                        </div>
                    </div>
                    <div class="dispatch-note-details hidden mt-4 pt-4 border-t">
                        <!-- Editable grid will be injected here -->
                    </div>
                `;
                listEl.appendChild(el);
            });
            updateIcons();
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const createSection = document.getElementById('new-dispatch-note-section');
                const summaryBox = document.getElementById('rep-dispatch-summary');
                if (role === 'rep') {
                    if (createSection) createSection.style.display = 'none';
                    if (summaryBox) { summaryBox.classList.remove('hidden'); renderRepDispatchSummary(); }
                } else {
                    if (createSection) createSection.style.display = '';
                    if (summaryBox) summaryBox.classList.add('hidden');
                }
            } catch(e){ console.warn('dispatch role toggle failed', e); }
        }

        // ØªØ¬Ù…ÙŠØ¹ Ù…Ù„Ø®Øµ Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
        function renderRepDispatchSummary(){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role !== 'rep') return;
                const box = document.getElementById('rep-dispatch-summary-content');
                if (!box) return;
                const user = (typeof AuthSystem !== 'undefined' && AuthSystem.getCurrentUser) ? AuthSystem.getCurrentUser() : null;
                const repName = user ? (user.displayName || user.name || user.email || '').trim() : '';
                const notes = (Array.isArray(state.dispatchNotes) ? state.dispatchNotes : []).filter(n => (n.repName||'').trim() === repName);
                if (notes.length === 0) { box.innerHTML = '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø°ÙˆÙ†Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨Ùƒ.</p>'; return; }
                const agg = new Map();
                notes.forEach(n => (n.items||[]).forEach(it => {
                    const key = String(it.productId || it.name || '').trim();
                    if (!agg.has(key)) agg.set(key, { name: it.name || key, received:0, returnOk:0, returnBad:0, freeQty:0 });
                    const o = agg.get(key);
                    o.received += Number(it.receivedQty || it.quantity || 0);
                    o.returnOk += Number(it.returnedOk || it.actualReturn || 0);
                    o.returnBad += Number(it.returnedDamaged || 0);
                    o.freeQty += Number(it.freeQty || 0);
                }));
                const rows = Array.from(agg.values()).map(o => {
                    const remaining = o.received - (o.returnOk + o.returnBad + o.freeQty);
                    return `<tr>
                        <td class='px-2 py-1 text-right'>${escapeHtml(o.name)}</td>
                        <td class='px-2 py-1 text-center'>${o.received}</td>
                        <td class='px-2 py-1 text-center'>${o.returnOk}</td>
                        <td class='px-2 py-1 text-center'>${o.returnBad}</td>
                        <td class='px-2 py-1 text-center'>${o.freeQty}</td>
                        <td class='px-2 py-1 text-center font-semibold'>${remaining}</td>
                    </tr>`;
                }).join('');
                box.innerHTML = `<div class='overflow-x-auto'><table class='min-w-full border divide-y divide-gray-200 text-xs'>
                    <thead class='bg-gray-50'><tr>
                        <th class='px-2 py-1 text-right'>Ø§Ù„ØµÙ†Ù</th>
                        <th class='px-2 py-1 text-center'>Ù…Ø³ØªÙ„Ù…</th>
                        <th class='px-2 py-1 text-center'>Ù…Ø±ØªØ¬Ø¹ Ø³Ù„ÙŠÙ…</th>
                        <th class='px-2 py-1 text-center'>Ù…Ø±ØªØ¬Ø¹ ØªØ§Ù„Ù</th>
                        <th class='px-2 py-1 text-center'>Ù…Ø¬Ø§Ù†ÙŠ</th>
                        <th class='px-2 py-1 text-center'>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                    </tr></thead><tbody>${rows}</tbody></table></div>`;
            } catch(e){ console.warn('renderRepDispatchSummary failed', e); }
        }
        
        // --- CASH column filter menus (per-column dropdowns) ---
        (function(){
            const cashColumnFilters = {};

            function normalizeRaw(v){ return (v === null || typeof v === 'undefined') ? '' : String(v).toString().replace(/\s+/g,' ').trim(); }

            function populateCashMenuList(menu, col){
                const listEl = menu.querySelector('.filter-list');
                listEl.innerHTML = '';
                const rows = window._lastRenderedCashSales || [];
                const map = new Map();
                rows.forEach(sale => {
                    let raw = '';
                    let disp = '';
                    if (col === 'customer') { raw = normalizeRaw(sale.customerId); disp = findCustomer(sale.customerId)?.name || raw; }
                    else if (col === 'date') { raw = sale.date ? sale.date.split('T')[0] : ''; disp = sale.date ? formatArabicDate(sale.date) : ''; }
                    else if (col === 'invoice') { raw = normalizeRaw(sale.invoiceNumber); disp = raw; }
                    else if (col === 'total') { raw = normalizeRaw(Number(sale.total || 0)); disp = Math.abs(sale.total || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'paid') { const p = Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)); raw = normalizeRaw(p); disp = Math.abs(p).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'remaining') { const r = Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))); raw = normalizeRaw(r); disp = Math.abs(r).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'rep') { raw = normalizeRaw(sale.repName); disp = raw; }
                    else if (col === 'collection') { raw = sale.collectionReportCreated ? 'created' : 'not-created'; disp = raw === 'created' ? 'ØªÙ…' : 'Ù„Ù… ÙŠØªÙ…'; }
                    if (!map.has(raw)) map.set(raw, disp);
                });

                const items = Array.from(map.entries()).sort((a,b)=> String(a[1]).localeCompare(String(b[1]), 'ar'));
                items.forEach(([raw, disp]) => {
                    const id = 'cf-cash-' + col + '-' + Math.random().toString(36).slice(2,8);
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.padding = '4px 2px';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = raw; cb.id = id;
                    if (Array.isArray(cashColumnFilters[col]) && cashColumnFilters[col].includes(raw)) cb.checked = true;
                    const txt = document.createTextNode(' ' + String(disp));
                    label.appendChild(cb); label.appendChild(txt);
                    listEl.appendChild(label);
                });
            }

            function buildCashMenu(col){
                const btn = document.querySelector(`.cash-column-filter-btn[data-col="${col}"]`);
                if (!btn) return null;
                if (btn._menu) { populateCashMenuList(btn._menu, col); return btn._menu; }

                const menu = document.createElement('div');
                menu.className = 'column-filter-menu cash-filter-menu';
                menu.style.display = 'none';
                menu.innerHTML = `
                    <input class="filter-search" placeholder="Ø¨Ø­Ø«..." />
                    <div class="filter-list"></div>
                    <div class="filter-actions">
                        <button class="apply-btn">ØªØ·Ø¨ÙŠÙ‚</button>
                        <button class="clear-btn">Ù…Ø³Ø­</button>
                    </div>
                `;
                document.body.appendChild(menu);

                // wire search
                menu.querySelector('.filter-search').addEventListener('input', (e)=>{
                    const q = (e.target.value || '').trim().toLowerCase();
                    menu.querySelectorAll('.filter-list label').forEach(lbl=>{
                        lbl.style.display = lbl.textContent.toLowerCase().includes(q) ? '' : 'none';
                    });
                });

                // apply
                menu.querySelector('.apply-btn').addEventListener('click', ()=>{
                    const checked = Array.from(menu.querySelectorAll('.filter-list input[type="checkbox"]:checked')).map(i=>i.value);
                    cashColumnFilters[col] = checked;
                    applyCashColumnFilters();
                    hideAllCashMenus();
                });

                // clear
                menu.querySelector('.clear-btn').addEventListener('click', ()=>{
                    cashColumnFilters[col] = [];
                    populateCashMenuList(menu, col);
                    applyCashColumnFilters();
                    hideAllCashMenus();
                });

                btn._menu = menu;
                populateCashMenuList(menu, col);
                return menu;
            }

            function showCashMenu(btn){
                const col = btn.dataset.col;
                if (!col) return;
                const menu = buildCashMenu(col);
                if (!menu) return;
                // hide other menus
                hideAllCashMenus();
                const rect = btn.getBoundingClientRect();
                menu.style.display = 'block';
                const left = rect.right - menu.offsetWidth + window.scrollX;
                menu.style.left = (left < 8 ? 8 : left) + 'px';
                menu.style.top = (rect.bottom + window.scrollY + 6) + 'px';
            }

            function hideAllCashMenus(){ document.querySelectorAll('.cash-filter-menu').forEach(m=>m.style.display='none'); }

            function applyCashColumnFilters(){
                const tbody = document.getElementById('cash-table-body'); if (!tbody) return;
                const trs = Array.from(tbody.querySelectorAll('tr'));
                const activeCols = Object.keys(cashColumnFilters).filter(c => Array.isArray(cashColumnFilters[c]) && cashColumnFilters[c].length>0);
                try { console.debug('applyCashColumnFilters start', { filters: cashColumnFilters, activeCols, rowsRendered: (window._lastRenderedCashSales || []).length }); } catch(e){}

                trs.forEach(tr=>{
                    let show = true;
                    for (const col of activeCols) {
                        const sel = cashColumnFilters[col] || [];
                        let cellRaw = '';
                        try {
                            if (col === 'customer') cellRaw = normalizeRaw(tr.dataset.customer);
                            else if (col === 'date') cellRaw = normalizeRaw(tr.dataset.date);
                            else if (col === 'invoice') cellRaw = normalizeRaw(tr.dataset.invoice);
                            else if (col === 'total') cellRaw = normalizeRaw(Number(tr.dataset.total||0));
                            else if (col === 'paid') cellRaw = normalizeRaw(Number(tr.dataset.paid||0));
                            else if (col === 'remaining') cellRaw = normalizeRaw(Number(tr.dataset.remaining||0));
                            else if (col === 'rep') cellRaw = normalizeRaw(tr.dataset.rep);
                            else if (col === 'collection') cellRaw = tr.querySelector('.cash-action-create') ? (tr.querySelector('.cash-action-create').textContent.includes('Ø¥Ù„ØºØ§Ø¡') ? 'created' : 'not-created') : (tr.dataset.collectionReportCreated ? 'created' : 'not-created');
                        } catch(e){ cellRaw = ''; }
                        if (!sel.includes(String(cellRaw))) { show = false; break; }
                    }
                    tr.style.display = show ? 'table-row' : 'none';
                });

                const source = window._cashFiltersOriginalRenderedSales || window._lastRenderedCashSales || [];
                const visibleSales = source.filter(sale => {
                    for (const col of activeCols) {
                        const sel = cashColumnFilters[col] || [];
                        let raw = '';
                        if (col === 'customer') raw = normalizeRaw(sale.customerId);
                        else if (col === 'date') raw = sale.date ? sale.date.split('T')[0] : '';
                        else if (col === 'invoice') raw = normalizeRaw(sale.invoiceNumber);
                        else if (col === 'total') raw = normalizeRaw(Number(sale.total || 0));
                        else if (col === 'paid') raw = normalizeRaw(Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)));
                        else if (col === 'remaining') raw = normalizeRaw(Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))));
                        else if (col === 'rep') raw = normalizeRaw(sale.repName);
                        else if (col === 'collection') raw = sale.collectionReportCreated ? 'created' : 'not-created';
                        if (!sel.includes(String(raw))) return false;
                    }
                    return true;
                });
                window._lastRenderedCashSales = visibleSales;
            }

            // global click handler to open menus for cash
            document.addEventListener('click', (e)=>{
                const btn = e.target.closest('.cash-column-filter-btn');
                if (btn) { e.stopPropagation(); showCashMenu(btn); return; }
                if (!e.target.closest('.cash-filter-menu')) hideAllCashMenus();
            });

            window.cashColumnFilters = cashColumnFilters;
            window.applyCashColumnFilters = applyCashColumnFilters;
        })();

        function renderEditableDispatchGrid(noteId, container) {
            const note = state.dispatchNotes.find(n => n.id === noteId);
            if (!note) return;

            // 1. Fetch Sales Data for the specific rep and date
            const salesForRepAndDate = state.sales.filter(sale =>
                sale.repName === note.repName &&
                new Date(sale.date).toISOString().split('T')[0] === new Date(note.date).toISOString().split('T')[0]
            );

            // 2. Aggregate Sold Quantities by product
            const soldQuantities = {};
            salesForRepAndDate.forEach(sale => {
                sale.items.forEach(item => {
                    soldQuantities[item.productId] = (soldQuantities[item.productId] || 0) + item.quantity;
                });
            });

            // 3. Compute weighted average prices per product for the sales found.
            //    If there are no sales for a product, fall back to customer's price list -> default price list -> product.base price.
            const avgPriceByProduct = {}; // productId -> averagePrice (number)
            // Build price lookup helper for a sale's customer
            const getPriceForProductForCustomer = (productId, customerId) => {
                // 1. Check the customer's assigned price list
                const customer = state.customers.find(c => c.id === customerId);
                if (customer && customer.priceListId) {
                    const pl = findPriceList(customer.priceListId);
                    if (pl && pl.productPrices && pl.productPrices[productId] !== undefined) return Number(pl.productPrices[productId]);
                }
                // 2. fallback to default retail price list if exists
                const retail = state.priceLists.find(p => p.id && p.id.includes('retail'));
                if (retail && retail.productPrices && retail.productPrices[productId] !== undefined) return Number(retail.productPrices[productId]);
                // 3. fallback to product base price
                const prod = findProduct(productId);
                return prod ? Number(prod.price || 0) : 0;
            };

            // Sum quantities * price per product using the sale items (if any)
            const priceSums = {}; // productId -> { qty: totalQty, value: totalQty*price }
            salesForRepAndDate.forEach(sale => {
                sale.items.forEach(item => {
                    const pid = item.productId;
                    const qty = Number(item.quantity || 0);
                    // prefer explicit item.price if present
                    let price = (item.price !== undefined && item.price !== null) ? Number(item.price) : getPriceForProductForCustomer(pid, sale.customerId);
                    if (!price || isNaN(price)) price = getPriceForProductForCustomer(pid, sale.customerId);
                    if (!priceSums[pid]) priceSums[pid] = { qty: 0, value: 0 };
                    priceSums[pid].qty += qty;
                    priceSums[pid].value += qty * price;
                });
            });

            Object.keys(priceSums).forEach(pid => {
                const entry = priceSums[pid];
                avgPriceByProduct[pid] = entry.qty > 0 ? (entry.value / entry.qty) : 0;
            });

            let itemsHtml = note.items.map(item => {
                const productOptions = state.products.map(p =>
                    `<option value="${p.id}" ${item.productId === p.id ? 'selected' : ''}>${p.name}</option>`
                ).join('');

                const takenOut = item.quantity || 0;
                const sold = soldQuantities[item.productId] || 0;
                const expectedReturn = takenOut - sold;
                const actualReturn = item.goodReturn + item.damagedReturn + item.freebie; // Assuming these are the actual returns
                const difference = actualReturn - expectedReturn;

                let differenceClass = '';
                if (difference < 0) {
                    differenceClass = 'text-red-600 font-bold'; // Deficit
                } else if (difference > 0) {
                    differenceClass = 'text-green-600 font-bold'; // Surplus
                }

                return `
                    <tr class="dispatch-item-row" data-product-id="${item.productId}">
                        <td class="px-2 py-1"><select class="dispatch-item-product w-full p-1 border rounded-md text-sm" required><option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬...</option>${productOptions}</select></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="takenOut" value="${takenOut}" placeholder="0" min="0" readonly></td>
                        <td><span class="w-full p-1 text-center text-sm">${sold}</span></td>
                        <td><span class="w-full p-1 text-center text-sm">${expectedReturn}</span></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm actual-return-input" type="number" data-field="actualReturn" value="${actualReturn}" placeholder="0" min="0"></td>
                        <td><span class="w-full p-1 text-center text-sm ${differenceClass}">${difference}</span></td>
                        <td class="px-2 py-1 text-center"><button type="button" class="delete-dispatch-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-x-auto bg-white rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 editable-dispatch-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase w-2/5">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø³ØªÙ„Ù…</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø¨Ø§Ø¹</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø±ØªØ¬Ø¹ Ù…ØªÙˆÙ‚Ø¹</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ù…Ø±ØªØ¬Ø¹ ÙØ¹Ù„ÙŠ</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">Ø§Ù„ÙØ±Ù‚</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">${itemsHtml}</tbody>
                    </table>
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <button type="button" class="add-editable-dispatch-item-btn text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1" data-note-id="${noteId}">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
                    </button>
                    <div class="flex gap-2">
                        <button type="button" class="copy-dispatch-note-btn bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="image" class="w-5 h-5"></i>
                            Ù†Ø³Ø®
                        </button>
                        <button type="button" class="print-dispatch-note-btn bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="printer" class="w-5 h-5"></i>
                            Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        <button type="button" class="delete-dispatch-note-btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="trash" class="w-5 h-5"></i>
                            Ø­Ø°Ù
                        </button>
                        <button type="button" class="update-dispatch-note-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            Ø­ÙØ¸
                        </button>
                    </div>
                </div>
                <div class="mt-4 text-right">
                    <!-- Compute and display permission total based on average prices and takenOut quantities -->
                    ${(()=>{
                        try {
                            let total = 0;
                            note.items.forEach(it => {
                                const qty = Number(it.quantity || 0);
                                const avg = Number(avgPriceByProduct[it.productId] !== undefined ? avgPriceByProduct[it.productId] : getPriceForProductForCustomer(it.productId, null));
                                total += qty * avg;
                            });
                            return `<div class="font-bold">âˆ‘: ${formatCurrency(total)}</div>`;
                        } catch (e) { return ''; }
                    })()}
                </div>
            `;
            updateIcons();

            // Add event listeners for actual return input to update difference
            container.querySelectorAll('.actual-return-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const row = e.target.closest('.dispatch-item-row');
                    const takenOut = parseInt(row.querySelector('[data-field="takenOut"]').value) || 0;
                    const sold = parseInt(row.children[2].textContent) || 0; // Get sold from the span
                    const expectedReturn = takenOut - sold;
                    const actualReturn = parseInt(e.target.value) || 0;
                    const difference = actualReturn - expectedReturn;

                    const differenceCell = row.children[5]; // The difference span
                    differenceCell.textContent = difference;
                    differenceCell.classList.remove('text-red-600', 'text-green-600', 'font-bold');
                    if (difference < 0) {
                        differenceCell.classList.add('text-red-600', 'font-bold');
                    } else if (difference > 0) {
                        differenceCell.classList.add('text-green-600', 'font-bold');
                    }
                });
            });
        }

        // Read-only render for dispatch note (for reps)
        function renderReadonlyDispatchGrid(noteId, container) {
            const note = state.dispatchNotes.find(n => n.id === noteId);
            if (!note) { container.innerHTML = '<p class="text-sm text-red-600">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø°Ù†.</p>'; return; }
            const rowsHtml = note.items.map(item => {
                const prod = findProduct(item.productId);
                const name = prod ? prod.name : 'Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ';
                const takenOut = item.quantity || 0;
                const good = item.goodReturn || 0;
                const damaged = item.damagedReturn || 0;
                const freebie = item.freebie || 0;
                return `<tr class="text-xs border-b last:border-b-0">\n<td class="px-2 py-1 text-right font-semibold">${name}</td>\n<td class="px-2 py-1 text-center">${takenOut}</td>\n<td class="px-2 py-1 text-center text-green-700">${good}</td>\n<td class="px-2 py-1 text-center text-red-700">${damaged}</td>\n<td class="px-2 py-1 text-center text-blue-700">${freebie}</td></tr>`;
            }).join('');
            container.innerHTML = `
                <div class="flex gap-2 mb-3 justify-end">
                    <button id="tab-stock-${noteId}" class="px-3 py-1 rounded text-xs bg-blue-600 text-white">ğŸ“¦ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
                    <button id="tab-collection-${noteId}" class="px-3 py-1 rounded text-xs bg-gray-200">ğŸ’° ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                </div>

                <div id="dispatch-stock-wrapper-${noteId}" class="overflow-x-auto bg-white rounded-lg">
                    <table class="min-w-full">
                        <thead class="bg-gray-200 text-xs">
                            <tr>
                                <th class="px-2 py-2 text-right">Ø§Ù„ØµÙ†Ù</th>
                                <th class="px-2 py-2 text-center">Ù…Ø³ØªÙ„Ù…</th>
                                <th class="px-2 py-2 text-center">Ù…Ø±ØªØ¬Ø¹ Ø³Ù„ÙŠÙ…</th>
                                <th class="px-2 py-2 text-center">Ù…Ø±ØªØ¬Ø¹ ØªØ§Ù„Ù</th>
                                <th class="px-2 py-2 text-center">Ù…Ø¬Ø§Ù†ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
                <div class="mt-3 flex gap-2 justify-end">
                    <button type="button" class="copy-dispatch-note-btn bg-teal-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1" data-note-id="${noteId}"><i data-lucide="image" class="w-4 h-4"></i> ØµÙˆØ±Ø©</button>
                    <button type="button" class="print-dispatch-note-btn bg-gray-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1" data-note-id="${noteId}"><i data-lucide="printer" class="w-4 h-4"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>`;
            updateIcons();

            // Insert Daily Collection Sheet & Expenses section below the dispatch table
            try {
                try { renderDailyCollectionSection(note, container); } catch(e){ console.warn('renderDailyCollectionSection failed', e); }
            } catch(e){ }

            // Wire tab toggle behaviour (Stock active by default)
            try {
                const tabStock = document.getElementById('tab-stock-' + noteId);
                const tabColl = document.getElementById('tab-collection-' + noteId);
                const stockWrapper = document.getElementById('dispatch-stock-wrapper-' + noteId);
                // Ensure collection section exists (render if missing)
                let collSection = container.querySelector('.daily-collection-section');
                if (!collSection) {
                    try { renderDailyCollectionSection(note, container); } catch(_){}
                    collSection = container.querySelector('.daily-collection-section');
                }

                function setActiveTab(which){
                    if(which === 'stock'){
                        if(stockWrapper) stockWrapper.style.display = '';
                        if(collSection) collSection.style.display = 'none';
                        if(tabStock) { tabStock.classList.add('bg-blue-600'); tabStock.classList.remove('bg-gray-200'); }
                        if(tabColl) { tabColl.classList.remove('bg-blue-600'); tabColl.classList.add('bg-gray-200'); }
                    } else {
                        if(stockWrapper) stockWrapper.style.display = 'none';
                        if(collSection) collSection.style.display = '';
                        if(tabColl) { tabColl.classList.add('bg-blue-600'); tabColl.classList.remove('bg-gray-200'); }
                        if(tabStock) { tabStock.classList.remove('bg-blue-600'); tabStock.classList.add('bg-gray-200'); }
                    }
                }
                if(tabStock) tabStock.addEventListener('click', ()=> setActiveTab('stock'));
                if(tabColl) tabColl.addEventListener('click', ()=> setActiveTab('collection'));

                // default: show Collection tab when there are sales or saved expenses for this rep/date
                try {
                    let showCollection = false;
                    try {
                        const dateId = (new Date(note.date)).toISOString().split('T')[0];
                        const salesForRepAndDate = (state.sales||[]).filter(sale =>
                            (sale.repName === note.repName || sale.rep === note.repName) &&
                            new Date(sale.date).toISOString().split('T')[0] === dateId &&
                            (String(sale.paymentType||'').toLowerCase() === 'cash' || String(sale.paymentType||'').toLowerCase().includes('part'))
                        );
                        if (salesForRepAndDate && salesForRepAndDate.length>0) showCollection = true;
                        // check saved expenses in in-memory state
                        const docId = _dailyDocIdFor(note.repName, note.date);
                        const dailyDoc = (Array.isArray(state.dailyCollections) ? state.dailyCollections.find(d => String(d.id) === String(docId) || (d.repName === note.repName && d.date && new Date(d.date).toISOString().split('T')[0] === dateId)) : null) || {};
                        const expenses = Array.isArray(dailyDoc.expenses) ? dailyDoc.expenses : [];
                        if (expenses.length > 0) showCollection = true;
                    } catch(_){}
                    setActiveTab(showCollection ? 'collection' : 'stock');
                } catch(_) { setActiveTab('stock'); }
            } catch(e){ console.warn('tab wiring failed', e); }
        }

            function generateDispatchNotePrintContent(noteId) {
                    const note = state.dispatchNotes.find(n => n.id === noteId);
                    if (!note) return null;
        
                    // Build average price map (weighted by actual sales prices) for this rep & date
                    const salesForRepAndDate = state.sales.filter(sale =>
                        sale.repName === note.repName &&
                        new Date(sale.date).toISOString().split('T')[0] === new Date(note.date).toISOString().split('T')[0]
                    );

                    const priceSums = {};
                    salesForRepAndDate.forEach(sale => {
                        sale.items.forEach(it => {
                            const pid = it.productId;
                            const qty = Number(it.quantity || 0);
                            const price = (it.price !== undefined && it.price !== null) ? Number(it.price) : (findPriceList(findCustomer(sale.customerId)?.priceListId)?.productPrices?.[pid] ?? findProduct(pid)?.price ?? 0);
                            if (!priceSums[pid]) priceSums[pid] = { qty: 0, value: 0 };
                            priceSums[pid].qty += qty;
                            priceSums[pid].value += qty * price;
                        });
                    });

                    const avgPriceByProduct = {};
                    Object.keys(priceSums).forEach(pid => { const e = priceSums[pid]; avgPriceByProduct[pid] = e.qty > 0 ? (e.value / e.qty) : 0; });

                    let permissionTotal = 0;
                    const itemsHtml = note.items.map(item => {
                        const product = findProduct(item.productId);
                        const avg = Number(avgPriceByProduct[item.productId] !== undefined ? avgPriceByProduct[item.productId] : (findPriceList(findCustomer(null)?.priceListId)?.productPrices?.[item.productId] ?? findProduct(item.productId)?.price ?? 0));
                        const lineValue = (Number(item.quantity || 0) * avg);
                        permissionTotal += lineValue;
                        return `
                            <tr class="border-b">
                                <td class="p-2 text-right">${product ? product.name : 'Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ'}</td>
                                <td class="p-2 text-center">${item.quantity || 0}</td>
                                <td class="p-2 text-center">${item.actualReturn || 0}</td>
                            </tr>
                        `;
                    }).join('');

                    return `
                        <div class="p-6" style="direction: rtl; position: relative;">
                        <div style="position: relative; z-index: 1;">
                                <div class="flex justify-between items-start mb-4 border-b pb-4">
                                    <div class="text-right">
                                        <div class="flex items-center justify-end gap-4">
                                            <div id="dispatch-note-company" class="text-right">
                                                <h1 class="text-xl font-bold">Delente ERP - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</h1>
                                            </div>
                                            <div id="dispatch-note-logo">
                                                ${ (getCompanyLogoUrl && getCompanyLogoUrl()) ? `<img src="${getCompanyLogoUrl()}" style="height:48px;margin-left:8px;border-radius:6px;background:#fff;padding:4px;"/>` : '' }
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold">Ø¥Ø°Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø¶Ø§Ø¹Ø©</h1>
                                        <p><strong>ØªØ§Ø±ÙŠØ®:</strong> ${new Date(note.date).toLocaleDateString('ar-EG')}</p>
                                        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†:</strong> ${note.noteNumber || note.id}</p>
                                    </div>
                                </div>
        
                                <div class="text-center my-6">
                                    <h2 class="text-xl font-bold">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${note.repName}</h2>
                                </div>
        
                                <table class="min-w-full divide-y divide-gray-200 mb-8">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-right font-semibold">Ø§Ù„ØµÙ†Ù</th>
                                            <th class="px-4 py-2 text-center font-semibold">Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                                            <th class="px-4 py-2 text-center font-semibold">Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-100">
                                        ${itemsHtml}
                                    </tbody>
                                </table>
                                <div class="mb-6 text-right font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø°Ù† Ø­Ø³Ø¨ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: ${formatCurrency(permissionTotal)}</div>

                                <!-- Daily Collection & Expenses summary -->
                                ${(() => {
                                    try {
                                        const salesForRepAndDate = (state.sales||[]).filter(sale =>
                                            (sale.repName === note.repName || sale.rep === note.repName) &&
                                            new Date(sale.date).toISOString().split('T')[0] === new Date(note.date).toISOString().split('T')[0] &&
                                            (String(sale.paymentType||'').toLowerCase() === 'cash' || String(sale.paymentType||'').toLowerCase() === 'part change' || String(sale.paymentType||'').toLowerCase() === 'partchange')
                                        );
                                        let collRows = '';
                                        let totalCollected = 0;
                                        salesForRepAndDate.forEach(s => {
                                            const customerName = (findCustomer(s.customerId)||{}).name || s.customerName || '';
                                            const invoiceRef = s.invoiceNumber || s.id || '';
                                            const paymentType = s.paymentType || (s.firstPayment||s.secondPayment? 'Part Change' : 'Cash');
                                            const amount = (String((s.paymentType||'').toLowerCase()) === 'part change') ? (Number(s.paidAmount||0) || Number(s.firstPayment||0) + Number(s.secondPayment||0)) : (Number(s.total||0));
                                            totalCollected += Number(amount || 0);
                                            collRows += `<tr><td class="p-2 text-right">${escapeHtml(customerName)}</td><td class="p-2 text-center">${escapeHtml(paymentType + ' / ' + invoiceRef)}</td><td class="p-2 text-left">${formatCurrency(amount)}</td></tr>`;
                                        });

                                        // Find expenses from in-memory state (listener populates state.dailyCollections)
                                        const dateId = (new Date(note.date)).toISOString().split('T')[0];
                                        const docId = (String(dateId) + '__' + encodeURIComponent(String(note.repName||'')).replace(/\./g,'%2E'));
                                        const dailyDoc = (Array.isArray(state.dailyCollections) ? state.dailyCollections.find(d => String(d.id) === String(docId) || (d.repName === note.repName && d.date && new Date(d.date).toISOString().split('T')[0] === dateId)) : null) || {};
                                        const expenses = Array.isArray(dailyDoc.expenses) ? dailyDoc.expenses : [];
                                        const expensesHtml = expenses.map(ex => `<tr><td class="p-2 text-right">${escapeHtml(ex.description||'')}</td><td class="p-2 text-left">${formatCurrency(Number(ex.amount||0))}</td></tr>`).join('');
                                        const totalExpenses = expenses.reduce((s,e)=> s + (Number(e.amount||0)), 0);
                                        const net = totalCollected - totalExpenses;

                                        return `
                                            <div class="mb-6 border-t pt-4">
                                                <h3 class="text-lg font-semibold text-right">ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                                                <table style="width:100%;border-collapse:collapse;margin-top:8px;" class="mb-2">
                                                    <thead><tr><th class="p-2 text-right">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-2 text-center">Ù†ÙˆØ¹/Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th class="p-2 text-left">Ø§Ù„Ù…Ø­ØµÙ„</th></tr></thead>
                                                    <tbody>${collRows}</tbody>
                                                    <tfoot><tr><td colspan="2" class="p-2 text-right font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</td><td class="p-2 text-left font-bold">${formatCurrency(totalCollected)}</td></tr></tfoot>
                                                </table>

                                                <h4 class="text-sm font-semibold text-right">Ù…ØµØ§Ø±ÙŠÙ Ù†Ø«Ø±ÙŠØ©</h4>
                                                <table style="width:100%;border-collapse:collapse;margin-top:8px;" class="mb-2">
                                                    <thead><tr><th class="p-2 text-right">Ø§Ù„ÙˆØµÙ</th><th class="p-2 text-left">Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                                                    <tbody>${expensesHtml}</tbody>
                                                    <tfoot><tr><td class="p-2 text-right font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</td><td class="p-2 text-left font-bold">${formatCurrency(totalExpenses)}</td></tr></tfoot>
                                                </table>

                                                <div class="mt-2 text-right font-bold">ØµØ§ÙÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯: ${formatCurrency(net)}</div>
                                            </div>
                                        `;
                                    } catch(e){ return ''; }
                                })()}

                                <div style="padding-top: 6rem;">
                                    <div class="flex justify-around items-center text-center">
                                        <p class="border-t-2 pt-2 px-8">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</p>
                                        <p class="border-t-2 pt-2 px-8">ØªÙˆÙ‚ÙŠØ¹ Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø®Ø²Ù†</p>
                                        <p class="border-t-2 pt-2 px-8">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø£Ù…Ù†</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
        async function copyDispatchNoteAsImage(noteId) {
            const content = generateDispatchNotePrintContent(noteId);
            if (!content) return;

            const tempElement = document.createElement('div');
            tempElement.id = 'temp-dispatch-print-area';
            tempElement.style.width = '800px'; // Set a fixed width for consistent image size
            tempElement.style.backgroundColor = 'white';
            tempElement.innerHTML = content;
            
            // Append to body to be rendered, but off-screen
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            document.body.appendChild(tempElement);

            await generateReportImage('temp-dispatch-print-area');

            document.body.removeChild(tempElement);
        }

        function printDispatchNote(noteId) {
            const content = generateDispatchNotePrintContent(noteId);
            if (!content) {
                customDialog({ title: 'Ø®Ø·Ø£', message: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø°Ù† Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡.' });
                return;
            }
            const w = window.open('', '', 'height=800,width=900');
            if (!w) { customDialog({ title: 'ØªÙ†Ø¨ÙŠÙ‡', message: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.' }); return; }
            w.document.open();
            w.document.write('<html><head><title>Ø¥Ø°Ù† ØµØ±Ù</title>');
            w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
            w.document.write('<style>body{font-family: Cairo, sans-serif; direction: rtl; padding: 16px;}</style>');
            w.document.write('</head><body>');
            w.document.write(content);
            w.document.write('</body></html>');
            w.document.close();
            const doPrint = () => { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
            const closeBack = () => { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
            if ('onafterprint' in w) { w.onafterprint = closeBack; } else { setTimeout(closeBack, 1200); }
            if ('onload' in w) { w.onload = () => setTimeout(doPrint, 150); } else { setTimeout(doPrint, 350); }
        }

        async function updateDispatchNote(noteId, tableContainer) {
            const note = state.dispatchNotes.find(n => n.id === noteId);
            if (!note) return;

            const items = [];
            const itemRows = tableContainer.querySelectorAll('.dispatch-item-row');
            for (const row of itemRows) {
                const productId = row.querySelector('.dispatch-item-product').value;
                const quantity = parseInt(row.querySelector('[data-field="quantity"]').value) || 0;
                const actualReturn = parseInt(row.querySelector('[data-field="actualReturn"]').value) || 0; // NEW

                if (productId && (quantity > 0 || actualReturn > 0)) { // Modified condition
                    items.push({ productId, quantity, actualReturn }); // Modified item object
                }
            }

            if (items.length === 0) {
                await customDialog({ message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø¥Ø°Ù† ÙØ§Ø±Øº. Ù„Ø­Ø°ÙÙ‡ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø­Ø°Ù.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }

            note.items = items;
            note.updatedAt = new Date().toISOString();

            renderAll();
            await customDialog({ message: 'ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¥Ø°Ù† Ø¨Ù†Ø¬Ø§Ø­.', title: 'Ù†Ø¬Ø§Ø­' });
        }

        // Helpers for Daily Collection Sheet (UI + persistence)
        function _dailyDocIdFor(repName, dateIso){
            try {
                const dateId = (new Date(dateIso)).toISOString().split('T')[0];
                return String(dateId) + '__' + encodeURIComponent(String(repName||'')).replace(/\./g,'%2E');
            } catch(e){ return String((new Date()).toISOString().split('T')[0]) + '__' + encodeURIComponent(String(repName||'')).replace(/\./g,'%2E'); }
        }

        function renderDailyCollectionSection(note, container){
            try{
                const repName = note.repName || '';
                const dateIso = note.date || new Date().toISOString();
                const dateId = (new Date(dateIso)).toISOString().split('T')[0];
                const docId = _dailyDocIdFor(repName, dateIso);
                // build sales table for this rep & date
                const salesForRepAndDate = (state.sales||[]).filter(sale =>
                    (sale.repName === repName || sale.rep === repName) &&
                    new Date(sale.date).toISOString().split('T')[0] === dateId &&
                    (String(sale.paymentType||'').toLowerCase() === 'cash' || String(sale.paymentType||'').toLowerCase() === 'part change' || String(sale.paymentType||'').toLowerCase() === 'partchange')
                );
                let rows = '';
                let totalCollected = 0;
                salesForRepAndDate.forEach(s => {
                    const customerName = (findCustomer(s.customerId)||{}).name || s.customerName || '';
                    const invoiceRef = s.invoiceNumber || s.id || '';
                    const paymentType = s.paymentType || (s.firstPayment||s.secondPayment? 'Part Change' : 'Cash');
                    const amount = (String((s.paymentType||'').toLowerCase()) === 'part change') ? (Number(s.paidAmount||0) || Number(s.firstPayment||0) + Number(s.secondPayment||0)) : (Number(s.total||0));
                    totalCollected += Number(amount || 0);
                    rows += `<tr class="border-b"><td class="px-2 py-1 text-right">${escapeHtml(customerName)}</td><td class="px-2 py-1 text-center">${escapeHtml(paymentType + ' / ' + invoiceRef)}</td><td class="px-2 py-1 text-left">${formatCurrency(amount)}</td></tr>`;
                });

                // load existing expenses from state.dailyCollections if present
                const dailyDoc = (Array.isArray(state.dailyCollections) ? state.dailyCollections.find(d => String(d.id) === String(docId) || (d.repName === repName && d.date && new Date(d.date).toISOString().split('T')[0] === dateId)) : null) || {};
                const expenses = Array.isArray(dailyDoc.expenses) ? dailyDoc.expenses : [];
                const expensesRows = expenses.map(ex => `<tr class="border-b"><td class="px-2 py-1 text-right">${escapeHtml(ex.description||'')}</td><td class="px-2 py-1 text-left">${formatCurrency(Number(ex.amount||0))}</td><td class="px-2 py-1 text-center"><button class="del-expense-btn text-red-500 text-xs" data-exp-id="${escapeHtml(String(ex.id||''))}">Ø­Ø°Ù</button></td></tr>`).join('');
                const totalExpenses = expenses.reduce((s,e)=> s + (Number(e.amount||0)), 0);
                const net = totalCollected - totalExpenses;

                // Build container area
                const section = document.createElement('div');
                section.className = 'daily-collection-section mt-6 p-4 bg-white rounded-lg shadow';
                section.innerHTML = `
                    <h3 class="text-lg font-semibold text-right">ÙƒØ´Ù Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                    <table style="width:100%;border-collapse:collapse;margin-top:8px;" class="mb-3">
                        <thead><tr><th class="px-2 text-right">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="px-2 text-center">Ù†ÙˆØ¹/Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th class="px-2 text-left">Ø§Ù„Ù…Ø­ØµÙ„</th></tr></thead>
                        <tbody>${rows}</tbody>
                        <tfoot><tr><td colspan="2" class="px-2 text-right font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</td><td class="px-2 text-left font-bold">${formatCurrency(totalCollected)}</td></tr></tfoot>
                    </table>

                    <h4 class="text-sm font-semibold text-right">Ù…ØµØ§Ø±ÙŠÙ Ù†Ø«Ø±ÙŠØ©</h4>
                    <table id="daily-expenses-table-${escapeHtml(docId)}" style="width:100%;border-collapse:collapse;margin-top:8px;" class="mb-3">
                        <thead><tr><th class="px-2 text-right">Ø§Ù„ÙˆØµÙ</th><th class="px-2 text-left">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="px-2 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody>${expensesRows}</tbody>
                        <tfoot><tr><td class="px-2 text-right font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</td><td class="px-2 text-left font-bold">${formatCurrency(totalExpenses)}</td><td></td></tr></tfoot>
                    </table>

                    <div class="flex gap-2 items-center justify-end mb-2 no-print">
                        <input type="number" id="daily-expense-amount-${escapeHtml(docId)}" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="p-2 border rounded w-32" />
                        <input type="text" id="daily-expense-desc-${escapeHtml(docId)}" placeholder="Ø§Ù„ÙˆØµÙ" class="p-2 border rounded w-56" />
                        <button id="daily-add-expense-btn-${escapeHtml(docId)}" class="bg-blue-600 text-white px-3 py-1 rounded">Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ</button>
                    </div>

                    <div class="text-right font-bold">ØµØ§ÙÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯: ${formatCurrency(net)}</div>
                `;

                // Remove previous existing section if present
                try { const prev = container.querySelector('.daily-collection-section'); if(prev) prev.remove(); } catch(_){ }
                container.appendChild(section);

                // Wire add expense button
                try {
                    const addBtn = document.getElementById('daily-add-expense-btn-' + docId);
                    if(addBtn) addBtn.addEventListener('click', async function(){
                        const amtEl = document.getElementById('daily-expense-amount-' + docId);
                        const descEl = document.getElementById('daily-expense-desc-' + docId);
                        const amount = Number(amtEl && (amtEl.value||0)) || 0;
                        const description = descEl && (descEl.value||'').trim();
                        if(!amount || amount <= 0) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­');
                        const expense = { id: 'ex_' + Date.now().toString(36), amount, description, createdAt: serverTs(), createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null };
                        try {
                            const docRef = db.collection('daily_collections').doc(docId);
                            // Merge append
                            await docRef.set({ repName, date: dateIso, expenses: (Array.isArray(dailyDoc.expenses)? dailyDoc.expenses.concat([expense]) : [expense]), updatedAt: serverTs() }, { merge:true });
                            // local update will be reflected by snapshot listener
                            try { amtEl.value=''; descEl.value=''; } catch(_){}
                        } catch(e){ console.warn('save expense failed', e); alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ'); }
                    });
                } catch(e){ console.warn('wire add expense failed', e); }

                // Wire delete buttons (delegated)
                try {
                    section.addEventListener('click', async function(ev){
                        const btn = ev.target && ev.target.closest && ev.target.closest('.del-expense-btn');
                        if(!btn) return;
                        const expId = btn.getAttribute('data-exp-id');
                        if(!expId) return;
                        if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
                        try {
                            // remove by reading current doc and filtering
                            const docRef = db.collection('daily_collections').doc(docId);
                            const snap = await docRef.get();
                            if(!snap.exists) return;
                            const d = snap.data() || {};
                            const newExp = (Array.isArray(d.expenses) ? d.expenses.filter(x=> String(x.id) !== String(expId)) : []);
                            await docRef.set({ expenses: newExp, updatedAt: serverTs() }, { merge:true });
                        } catch(e){ console.warn('delete expense failed', e); alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ'); }
                    });
                } catch(e){ console.warn('wire delete expenses failed', e); }

            }catch(e){ console.warn('renderDailyCollectionSection unexpected', e); }
        }

        async function deleteDispatchNote(noteId) {
            const confirmed = await customDialog({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ',
                isConfirm: true,
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                confirmClass: 'bg-red-600 hover:bg-red-700'
            });

            if (confirmed) {
                state.dispatchNotes = state.dispatchNotes.filter(n => n.id !== noteId);
                renderAll();
                await customDialog({ message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ù† Ø¨Ù†Ø¬Ø§Ø­.' });
            }
        }

        function getProductDetailsByCode(code) { 
            if (!code) return null;
            const scode = String(code);
            // Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨: id Ø«Ù… _id Ø«Ù… sku (Ø¨Ù…Ø·Ø§Ø¨Ù‚Ø© Ù†ØµÙŠØ©)
            const product = state.products.find(p => String(p.id) === scode) || state.products.find(p => String(p._id) === scode) || state.products.find(p => String(p.sku) === scode);
            if (!product) return null;
            const price = Number(product.price || 0);
            const category = product.category === 'multi' ? 'Ù…Ø§Ù„ØªÙŠ' : (product.category === 'dairy' ? 'Ø£Ù„Ø¨Ø§Ù†' : (product.category || ''));
            return { id: product.id || product._id || product.sku, name: product.name || product.title || code, defaultPrice: price, categoryName: category };
        }
        function updateSpreadsheetPriceAndProductInfo(row, productId, customerId) { 
            const priceInput = row.querySelector('.spreadsheet-price'); const nameInput = row.querySelector('.spreadsheet-product-name'); const categoryCell = row.querySelector('.spreadsheet-category'); const productDetails = getProductDetailsByCode(productId); priceInput.classList.remove('promotion-price-applied'); if (row.querySelector('.spreadsheet-tax-status-input')) { row.querySelector('.spreadsheet-tax-status-input').classList.remove('border-red-500', 'border-2'); } if (!productDetails) { nameInput.value = 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­'; nameInput.classList.add('text-red-500'); priceInput.value = 0; categoryCell.textContent = ''; row.dataset.productId = ''; return; } nameInput.value = productDetails.name; nameInput.classList.remove('text-red-500'); categoryCell.textContent = productDetails.categoryName; row.dataset.productId = productDetails.id; let finalPrice; let basePrice; basePrice = productDetails.defaultPrice; if(customerId) { const customer = findCustomer(customerId); if(customer && customer.priceListId) { const priceList = findPriceList(customer.priceListId); if(priceList && priceList.productPrices[productDetails.id] !== undefined) { basePrice = priceList.productPrices[productDetails.id]; } } } finalPrice = basePrice; const promotionPrice = getActivePromotionPrice(productId, customerId); if (promotionPrice !== null) { finalPrice = promotionPrice; priceInput.classList.add('promotion-price-applied'); } priceInput.value = parseFloat(finalPrice).toFixed(2); 
            try {
                if (/Ù‚Ø±ÙŠØ´|Ù‚Ø±ÙŠØ´/i.test(productDetails.name||'')) {
                    const customer = customerId ? findCustomer(customerId) : null;
                    const priceList = (customer && customer.priceListId) ? findPriceList(customer.priceListId) : null;
                    const listOverride = priceList ? priceList.productPrices[productDetails.id] : undefined;
                    console.debug('DEBUG Pricing (spreadsheet row)', {
                        productId: productDetails.id,
                        productName: productDetails.name,
                        basePrice: productDetails.defaultPrice,
                        priceListId: customer ? customer.priceListId : '',
                        priceListOverride: listOverride,
                        promotionPrice,
                        finalPrice
                    });
                }
            } catch(_){ }
        }
        function updateSpreadsheetTaxVisibility(customerId) { 
            const customer = findCustomer(customerId); const requiresFiling = customer && customer.requiresTaxFiling; const taxHeader = document.querySelector('.spreadsheet-tax-header'); if (taxHeader) { taxHeader.style.display = requiresFiling ? 'table-cell' : 'none'; } spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => { const taxCell = row.querySelector('.spreadsheet-tax-cell'); if (taxCell) { taxCell.style.display = requiresFiling ? 'table-cell' : 'none'; if (!requiresFiling) { const taxInput = row.querySelector('.spreadsheet-tax-status-input'); if (taxInput) taxInput.value = ''; } } }); 
        }
        function calculateSpreadsheetRowTotal(row) {
            const quantity = parseInt(row.querySelector('.spreadsheet-quantity').value) || 0;
            const originalPrice = parseFloat(row.querySelector('.spreadsheet-price').value) || 0;
            const modifiedPrice = parseFloat(row.querySelector('.spreadsheet-modified-price').value); // Don't default to 0, check for NaN

            // Use modified price if it's a valid number, otherwise use the original price
            const finalPrice = !isNaN(modifiedPrice) && modifiedPrice > 0 ? modifiedPrice : originalPrice;
            
            const discount = parseFloat(row.querySelector('.spreadsheet-discount').value) || 0;
            const totalCell = row.querySelector('.spreadsheet-total');
            const itemSubtotal = quantity * finalPrice;
            const itemTotal = itemSubtotal * (1 - discount / 100);
            totalCell.textContent = formatCurrency(itemTotal);
        }
        
        function initializeSpreadsheetPage() {
            populateRepDropdown(spreadsheetRepSelect);
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ù…Ù†Ø¯ÙˆØ¨ ÙˆØ§Ø­Ø¯)ØŒ ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if (spreadsheetRepSelect && spreadsheetRepSelect.options.length === 2) {
                // Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ "-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ --"ØŒ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
                spreadsheetRepSelect.selectedIndex = 1;
            }
            populateCustomerDropdown(spreadsheetCustomerSelect);
            spreadsheetDateInput.value = new Date().toISOString().split('T')[0];
            spreadsheetEntryBody.innerHTML = '';
            for(let i = 0; i < 5; i++) { addSpreadsheetRow(); }
            updateSpreadsheetTaxVisibility(null);
            spreadsheetCustomerSelect.removeEventListener('change', handleSpreadsheetCustomerChange);
            spreadsheetCustomerSelect.addEventListener('change', handleSpreadsheetCustomerChange);
            spreadsheetEntryBody.removeEventListener('change', handleSpreadsheetRowChange);
            spreadsheetEntryBody.addEventListener('change', handleSpreadsheetRowChange);
            spreadsheetEntryBody.removeEventListener('input', handleSpreadsheetRowInput);
            spreadsheetEntryBody.addEventListener('input', handleSpreadsheetRowInput);
            spreadsheetEntryBody.removeEventListener('click', handleSpreadsheetRowClick);
            spreadsheetEntryBody.addEventListener('click', handleSpreadsheetRowClick);
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù€ autocomplete Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡
            setupSpreadsheetAutocomplete();
            // Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† FirestoreØŒ Ø£Ø¹Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
            setTimeout(() => {
                if (Array.isArray(state.products) && state.products.length) {
                    spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                        const codeInput = row.querySelector('.spreadsheet-product-code');
                        const customerId = spreadsheetCustomerSelect.value;
                        if (codeInput && codeInput.value.trim()) {
                            updateSpreadsheetPriceAndProductInfo(row, codeInput.value.trim(), customerId);
                            calculateSpreadsheetRowTotal(row);
                        }
                    });
                }
            }, 1200);
             // Clear and reset unified invoice number on page load
             unifiedInvoiceNumberInput.value = '';
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Autocomplete Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡
        function setupSpreadsheetAutocomplete() {
            // Ø£Ø¶ÙŠÙ Ø§Ø³Ù…Ø¹ Ù„Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ
            const customerNameInput = document.querySelector('input[placeholder*="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]') || document.createElement('input');
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù„Ø°Ø§ Ø³Ù†Ø±ØªÙƒØ² Ø¹Ù„Ù‰ select)
            // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ Ø³Ù†Ø¶ÙŠÙ autocomplete Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø¹Ù„Ù‰ ÙƒÙ„ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
            spreadsheetEntryBody.addEventListener('input', function(e) {
                try {
                    if (e.target && e.target.classList && e.target.classList.contains('spreadsheet-product-name')) {
                        showProductAutocomplete(e.target);
                    }
                    // Mark invoice-number inputs as manually-entered when user types into them
                    if (e.target && e.target.classList && e.target.classList.contains('spreadsheet-invoice-number')) {
                        try { e.target.dataset.userEntered = '1'; } catch(_){}
                    }
                } catch(err) { console.warn('spreadsheet input handler error', err); }
            }, true);
            
            // Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ø­Ù‚Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„)
            // Ø³Ù†Ø¬Ø¹Ù„ autocomplete Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
            if (spreadsheetCustomerSelect) {
                // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ selectØŒ Ø³Ù†Ø¶ÙŠÙ Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ù†ØµÙŠ Ø¨Ø¬Ø§Ù†Ø¨Ù‡
                createCustomerSearchField();
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ø¨Ø­Ø« Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ù€ autocomplete
        function createCustomerSearchField() {
            try {
                let existingInput = document.getElementById('spreadsheet-customer-search');
                if (existingInput) return; // Ø¨Ø§Ù„ÙØ¹Ù„ Ù…ÙˆØ¬ÙˆØ¯
                
                const container = spreadsheetCustomerSelect.parentElement;
                const searchDiv = document.createElement('div');
                searchDiv.style.position = 'relative';
                searchDiv.style.marginTop = '4px';
                
                const searchInput = document.createElement('input');
                searchInput.id = 'spreadsheet-customer-search';
                searchInput.type = 'text';
                searchInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙˆÙ„ Ø­Ø±ÙˆÙ Ø§Ù„Ø§Ø³Ù…)...';
                searchInput.className = 'w-full p-2 border border-gray-300 rounded-md text-sm';
                searchInput.style.direction = 'rtl';
                
                const suggestionsList = document.createElement('div');
                suggestionsList.id = 'spreadsheet-customer-suggestions';
                suggestionsList.className = 'absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-48 overflow-y-auto';
                suggestionsList.style.display = 'none';
                suggestionsList.style.direction = 'rtl';
                
                searchDiv.appendChild(searchInput);
                searchDiv.appendChild(suggestionsList);
                container.appendChild(searchDiv);
                
                // Ù…Ø³ØªÙ…Ø¹ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    const suggestions = suggestionsList;
                    
                    if (searchTerm.length === 0) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†
                    const matches = state.customers.filter(c => 
                        c.name && c.name.toLowerCase().includes(searchTerm)
                    ).slice(0, 8); // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 8 Ù†ØªØ§Ø¦Ø¬
                    
                    if (matches.length === 0) {
                        suggestions.innerHTML = '<div class="p-2 text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                        suggestions.style.display = 'block';
                        return;
                    }
                    
                    suggestions.innerHTML = matches.map(customer => `
                        <div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-customer-id="${customer.id}" data-customer-name="${customer.name}">
                            ${customer.name}
                        </div>
                    `).join('');
                    suggestions.style.display = 'block';
                });
                
                // Ù…Ø³ØªÙ…Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
                suggestionsList.addEventListener('click', function(e) {
                    const item = e.target.closest('[data-customer-id]');
                    if (item) {
                        const customerId = item.getAttribute('data-customer-id');
                        const customerName = item.getAttribute('data-customer-name');
                        
                        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ select
                        spreadsheetCustomerSelect.value = customerId;
                        spreadsheetCustomerSelect.dispatchEvent(new Event('change'));
                        
                        // ØªÙ†Ø¸ÙŠÙ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
                        searchInput.value = customerName;
                        suggestionsList.style.display = 'none';
                    }
                });
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡
                document.addEventListener('click', function(e) {
                    if (e.target !== searchInput && e.target !== suggestionsList && !suggestionsList.contains(e.target)) {
                        suggestionsList.style.display = 'none';
                    }
                });
            } catch(err) {
                console.warn('createCustomerSearchField error:', err);
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ autocomplete Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        function showProductAutocomplete(input) {
            try {
                const searchTerm = input.value.trim().toLowerCase();
                const td = input.parentElement;
                let suggestionsDiv = td.querySelector('.product-suggestions');
                
                // Ø¥Ù†Ø´Ø§Ø¡ div Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
                if (!suggestionsDiv) {
                    suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'product-suggestions absolute bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-48 overflow-y-auto';
                    suggestionsDiv.style.display = 'none';
                    suggestionsDiv.style.direction = 'rtl';
                    suggestionsDiv.style.top = '100%';
                    suggestionsDiv.style.right = '0';
                    suggestionsDiv.style.minWidth = '200px';
                    td.style.position = 'relative';
                    td.appendChild(suggestionsDiv);
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØŒ Ø£Ø®ÙÙ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
                if (searchTerm.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© (Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
                const matches = state.products.filter(p => {
                    const productName = p.name ? p.name.toLowerCase() : '';
                    const productCode = p.id ? p.id.toLowerCase() : '';
                    return productName.startsWith(searchTerm) || productCode.startsWith(searchTerm);
                }).slice(0, 8); // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 8 Ù†ØªØ§Ø¦Ø¬
                
                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="p-2 text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
                    suggestionsDiv.style.display = 'block';
                    return;
                }
                
                suggestionsDiv.innerHTML = matches.map(product => `
                    <div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-product-id="${product.id}" data-product-name="${product.name}">
                        <strong>${product.name}</strong> <span class="text-gray-500">(${product.id})</span>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
                
                // Ù…Ø³ØªÙ…Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
                suggestionsDiv.removeEventListener('click', handleProductSuggestionClick);
                suggestionsDiv.addEventListener('click', function(e) {
                    handleProductSuggestionClick(e, input);
                });
                
            } catch(err) {
                console.warn('showProductAutocomplete error:', err);
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
        function handleProductSuggestionClick(e, input) {
            const item = e.target.closest('[data-product-id]');
            if (!item) return;
            
            const productId = item.getAttribute('data-product-id');
            const productName = item.getAttribute('data-product-name');
            const row = input.closest('.spreadsheet-row');
            
            if (!row) return;
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
            input.value = productName;
            row.dataset.productId = productId;
            
            // ØªØ¹Ø¯ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙŠØ¶Ø§Ù‹
            const codeInput = row.querySelector('.spreadsheet-product-code');
            if (codeInput) {
                codeInput.value = productId;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            const customerId = spreadsheetCustomerSelect.value;
            updateSpreadsheetPriceAndProductInfo(row, productId, customerId);
            calculateSpreadsheetRowTotal(row);
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
            const td = input.parentElement;
            const suggestionsDiv = td.querySelector('.product-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            
            // Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ (Ø§Ù„ÙƒÙ…ÙŠØ©)
            const quantityInput = row.querySelector('.spreadsheet-quantity');
            if (quantityInput) {
                quantityInput.focus();
            }
        }
        
        function handleSpreadsheetCustomerChange() { 
            const customerId = spreadsheetCustomerSelect.value; updateSpreadsheetTaxVisibility(customerId); if (!customerId) return; spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => { const productCode = row.querySelector('.spreadsheet-product-code').value.trim(); if (productCode) { updateSpreadsheetPriceAndProductInfo(row, productCode, customerId); } calculateSpreadsheetRowTotal(row); }); 
        }
        function handleSpreadsheetRowChange(e) { 
             if (e.target.classList.contains('spreadsheet-product-code')) { const row = e.target.closest('.spreadsheet-row'); const productCode = e.target.value.trim(); const customerId = spreadsheetCustomerSelect.value; if (!customerId) { customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.', title: 'ØªÙ†Ø¨ÙŠÙ‡' }); e.target.value = ''; return; } if (productCode) { updateSpreadsheetPriceAndProductInfo(row, productCode, customerId); } else { row.querySelector('.spreadsheet-product-name').value = ''; row.querySelector('.spreadsheet-price').value = 0; row.querySelector('.spreadsheet-category').textContent = ''; row.dataset.productId = ''; row.querySelector('.spreadsheet-price').classList.remove('promotion-price-applied'); } calculateSpreadsheetRowTotal(row); } 
            // If collection type changed, show/hide partial amount input
            if (e.target.classList.contains('spreadsheet-collection')) {
                const row = e.target.closest('.spreadsheet-row');
                const partialInput = row.querySelector('.spreadsheet-partial-amount');
                if (partialInput) {
                    partialInput.style.display = (e.target.value === 'partial') ? 'inline-block' : 'none';
                }
            }
        }
        function handleSpreadsheetRowInput(e) { 
            if (e.target.classList.contains('spreadsheet-invoice-number') || e.target.classList.contains('spreadsheet-quantity') || e.target.classList.contains('spreadsheet-price') || e.target.classList.contains('spreadsheet-modified-price') || e.target.classList.contains('spreadsheet-discount')) { const row = e.target.closest('.spreadsheet-row'); calculateSpreadsheetRowTotal(row); } if (e.target.classList.contains('spreadsheet-invoice-number')) { const currentRow = e.target.closest('.spreadsheet-row'); const nextRow = currentRow.nextElementSibling; const nextInvoiceInput = nextRow ? nextRow.querySelector('.spreadsheet-invoice-number') : null; if (nextInvoiceInput && !nextInvoiceInput.value && e.target.value) { nextInvoiceInput.value = e.target.value; } } if (e.target.classList.contains('spreadsheet-tax-status-input')) { const value = e.target.value.trim(); if (value.toLowerCase() === 'ØªÙ…') { e.target.value = 'ØªÙ…'; } } 
        }
        function handleSpreadsheetRowClick(e) { 
            if (e.target.closest('.spreadsheet-delete-row-btn')) { const row = e.target.closest('.spreadsheet-row'); if (spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').length > 1) { row.remove(); updateSpreadsheetTaxVisibility(spreadsheetCustomerSelect.value); } else { customDialog({message: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ø£Ø®ÙŠØ±.", title: "ØªÙ†Ø¨ÙŠÙ‡"}); } } 
        }

                function addSpreadsheetRow() {
            const row = document.createElement('tr'); row.className = 'spreadsheet-row'; const customerId = spreadsheetCustomerSelect.value; const customer = findCustomer(customerId); const requiresFiling = customer && customer.requiresTaxFiling; const unifiedInvoiceNumber = unifiedInvoiceNumberInput.value.trim(); const lastRow = spreadsheetEntryBody.lastElementChild; 
            
            // Ø§Ø³ØªØ®Ù„Ø§Øµ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
            let initialInvoiceNumber = unifiedInvoiceNumber;
            if (!initialInvoiceNumber) {
                // Ø­Ø§ÙˆÙ„ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø£Ø®ÙŠØ±
                initialInvoiceNumber = (lastRow ? lastRow.querySelector('.spreadsheet-invoice-number')?.value || '' : '');
            }
            if (!initialInvoiceNumber) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ù…ÙˆØ­Ø¯ Ø£Ùˆ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø£Ø®ÙŠØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
                const repName = spreadsheetRepSelect.value;
                const rep = findRep(repName);
                if (rep && rep.nextInvoiceNumber != null) {
                    initialInvoiceNumber = String(rep.nextInvoiceNumber);
                }
            }
            
            const taxInputHtml = `<td class="spreadsheet-tax-cell" style="display: ${requiresFiling ? 'table-cell' : 'none'};"><input type="text" class="spreadsheet-tax-status-input" placeholder="ØªÙ… / Ø¹Ù„Ø§Ù…Ø©" value=""></td>`; 
            // NOTE: Removed min="1" from spreadsheet-quantity input
            row.innerHTML = `<td><input type="number" class="spreadsheet-invoice-number" placeholder="Ø±Ù‚Ù…..." value="${initialInvoiceNumber}"></td><td><input type="text" class="spreadsheet-product-code" placeholder="Ø§Ù„ÙƒÙˆØ¯" size="5"></td><td><input type="text" class="spreadsheet-product-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"></td><td><input type="number" class="spreadsheet-quantity" value="" placeholder="0"></td><td><input type="number" class="spreadsheet-price" step="any" placeholder="Ø§Ù„Ø³Ø¹Ø±" readonly></td>
<td><input type="number" class="spreadsheet-modified-price" step="any" placeholder="ØªØ¹Ø¯ÙŠÙ„..."></td><td><input type="number" class="spreadsheet-discount" step="any" placeholder="%" min="0" max="100"></td><td class="spreadsheet-category text-center text-xs"></td><td><select class="spreadsheet-collection"><option value="paid">ÙƒØ§Ø´</option><option value="due">Ø¢Ø¬Ù„</option><option value="partial">Ø¬Ø²Ø¦ÙŠ</option></select><input type="number" class="spreadsheet-partial-amount" step="any" placeholder="Ø¬Ø²Ø¦ÙŠ" style="display:none;width:90px;margin-top:4px;margin-right:6px"></td>${taxInputHtml}<td class="spreadsheet-total text-center font-semibold"></td><td><button type="button" class="spreadsheet-delete-row-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>`; 
            spreadsheetEntryBody.appendChild(row); updateIcons();
        }

        async function saveAllSpreadsheetEntries() {
            const repName = spreadsheetRepSelect.value;
            const customerId = spreadsheetCustomerSelect.value;
            const dateValue = spreadsheetDateInput.value;
            const customer = findCustomer(customerId);
            const requiresTaxFiling = customer?.requiresTaxFiling || false;

            if (!repName || !customerId || !dateValue) {
                await customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', confirmClass: 'bg-red-600 hover:bg-red-700' });
                return;
            }

            const invoicesToSave = new Map();
            const existingInvoiceNumbers = new Set((state.sales||[]).map(s => {
                try { return (s && s.invoiceNumber != null) ? String(s.invoiceNumber) : null; } catch(_) { return null; }
            }).filter(x => x !== null));
            let isValid = true;
            let dataFound = false;

            spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                const invoiceNumberInput = row.querySelector('.spreadsheet-invoice-number');
                const productCodeInput = row.querySelector('.spreadsheet-product-code');
                const productNameInput = row.querySelector('.spreadsheet-product-name');
                const taxStatusInput = row.querySelector('.spreadsheet-tax-status-input');
                const rawInvoiceNumber = invoiceNumberInput.value.trim();
                const invoiceNumber = rawInvoiceNumber ? parseInt(rawInvoiceNumber) : null;
                const productId = row.dataset.productId;
                const productNameValue = productNameInput ? productNameInput.value.trim() : '';
                const quantity = parseInt(row.querySelector('.spreadsheet-quantity').value) || 0;
                const originalPrice = parseFloat(row.querySelector('.spreadsheet-price').value);
                const modifiedPrice = parseFloat(row.querySelector('.spreadsheet-modified-price').value);
                const safeOriginalPrice = (!isNaN(originalPrice) ? originalPrice : 0);
                const safeModifiedPrice = (!isNaN(modifiedPrice) ? modifiedPrice : 0);
                const price = (safeModifiedPrice > 0) ? safeModifiedPrice : safeOriginalPrice;
                const discount = parseFloat(row.querySelector('.spreadsheet-discount').value);
                const safeDiscount = (!isNaN(discount) ? discount : 0);
                const collection = row.querySelector('.spreadsheet-collection').value;
                const partialAmount = parseFloat(row.querySelector('.spreadsheet-partial-amount')?.value);
                const safePartialAmount = (!isNaN(partialAmount) ? partialAmount : 0);
                const taxFilingStatus = taxStatusInput ? taxStatusInput.value.trim() : '';

                [invoiceNumberInput, productCodeInput, row.querySelector('.spreadsheet-quantity'), row.querySelector('.spreadsheet-price'), row.querySelector('.spreadsheet-discount')].forEach(el => el.classList.remove('border-red-500', 'border-2'));
                if (productNameInput) productNameInput.classList.remove('border-red-500', 'border-2');
                if (taxStatusInput) taxStatusInput.classList.remove('border-red-500', 'border-2');

                // Special-case: product code '100' is used as a cancelled-invoice placeholder
                const codeValue = (productCodeInput && productCodeInput.value) ? productCodeInput.value.trim() : '';
                const isCanceledCode = (codeValue === '100') || (productId === '100');

                if (isCanceledCode) {
                    // allow saving a cancelled invoice row even without price/quantity
                    dataFound = true;

                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    if (invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).collectionStatus !== collection) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    if (!isValid) return;

                    if (!invoicesToSave.has(invoiceNumber)) {
                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? safePartialAmount : 0, isCanceled: true });
                    } else {
                        invoicesToSave.get(invoiceNumber).isCanceled = true;
                    }

                    // skip normal item validation for this row
                    return;
                }

                if (productId || productNameValue) {
                    dataFound = true;
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹
                    const product = getProductDetailsByCode(productId);
                    if (!product) {
                        if (productNameInput) {
                            productNameInput.classList.add('border-red-500', 'border-2');
                        }
                        if (productCodeInput) {
                            productCodeInput.classList.add('border-red-500', 'border-2');
                        }
                        isValid = false;
                        return;
                    }
                    
                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    if (invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).collectionStatus !== collection) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    // If collection is partial, ensure partial amount consistency across rows of same invoice
                    if (collection === 'partial' && invoicesToSave.has(invoiceNumber) && typeof invoicesToSave.get(invoiceNumber).partialAmount !== 'undefined' && invoicesToSave.get(invoiceNumber).partialAmount !== safePartialAmount) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    // Quantity cannot be zero (but can be negative)
                    if (!quantity || quantity === 0) { row.querySelector('.spreadsheet-quantity').classList.add('border-red-500', 'border-2'); isValid = false; }

                    if (isNaN(price) || price <= 0) { row.querySelector('.spreadsheet-price').classList.add('border-red-500', 'border-2'); isValid = false; }
                    // Discount is OPTIONAL: empty = 0, must be between 0-100 if provided
                    const discountInput = row.querySelector('.spreadsheet-discount').value.trim();
                    if (discountInput !== '' && (isNaN(discount) || discount < 0 || discount > 100)) { row.querySelector('.spreadsheet-discount').classList.add('border-red-500', 'border-2'); isValid = false; }

                    if (requiresTaxFiling && invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).taxFilingStatus !== taxFilingStatus) {
                        taxStatusInput.classList.add('border-red-500', 'border-2'); isValid = false; return;
                    }

                    if (!isValid) return;

                    if (!invoicesToSave.has(invoiceNumber)) {
                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? safePartialAmount : 0 });
                    }

                    const itemSubtotal = price * quantity;
                    const itemFinalPrice = itemSubtotal * (1 - safeDiscount / 100);
                    const invoiceData = invoicesToSave.get(invoiceNumber);
                    invoiceData.items.push({ productId, quantity, price, discountPercent: safeDiscount, itemFinalPrice });
                    invoiceData.totalSales += itemFinalPrice;
                    invoiceData.taxFilingStatus = taxFilingStatus;
                    if (collection === 'partial') invoiceData.partialAmount = safePartialAmount;
                } else if (productCodeInput.value.trim()) {
                    productCodeInput.classList.add('border-red-500', 'border-2'); isValid = false;
                }
                
            });

            if (!dataFound) {
                await customDialog({ message: 'Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø£ÙˆÙ„Ø§Ù‹.', title: 'ØªÙ†Ø¨ÙŠÙ‡' });
                return;
            }

            // If validation failed, allow save if the user manually entered any invoice number
            if (!isValid) {
                try {
                    const anyManual = Array.from(spreadsheetEntryBody.querySelectorAll('.spreadsheet-invoice-number')).some(i => i.dataset && i.dataset.userEntered === '1');
                    if (anyManual) {
                        console.log('saveAllSpreadsheetEntries: validation failed but manual invoice entry detected â€” proceeding to save.');
                        isValid = true; // force continue (accept manual numbers)
                    } else {
                        await customDialog({ message: 'ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ù…Ù…ÙŠØ²Ø© Ø¨Ø§Ù„Ø£Ø­Ù…Ø±). Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØµØ­ÙŠØ­Ù‡Ø§ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§.', title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', confirmClass: 'bg-red-600 hover:bg-red-700' });
                        return;
                    }
                } catch(e) {
                    await customDialog({ message: 'ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ù…Ù…ÙŠØ²Ø© Ø¨Ø§Ù„Ø£Ø­Ù…Ø±). Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØµØ­ÙŠØ­Ù‡Ø§ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§.', title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', confirmClass: 'bg-red-600 hover:bg-red-700' });
                    return;
                }
            }

            let savedCount = 0;
            const saveErrors = [];
            const dateISO = new Date(dateValue + 'T12:00:00Z').toISOString();
            const now = new Date().toISOString();
            const rep = findRep(repName);

            // Validate invoice sequence against rep.nextInvoiceNumber when available
            try {
                if (rep && rep.nextInvoiceNumber != null) {
                    const invNums = Array.from(invoicesToSave.keys()).map(n => Number(n)).filter(n => !isNaN(n));
                    if (invNums.length > 0) {
                        const minInv = Math.min(...invNums);
                        if (minInv < Number(rep.nextInvoiceNumber)) {
                            await customDialog({ message: `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${minInv} Ø£ØµØºØ± Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ (${rep.nextInvoiceNumber}). Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨Ø¯Ø¡.`, title: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ù„Ø³Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', confirmClass: 'bg-red-600 hover:bg-red-700' });
                            return;
                        }
                    }
                }
            } catch(e) { console.warn('Invoice sequence validation failed', e); }

            // Debug: log invoices to save
            try { console.debug('saveAllSpreadsheetEntries: invoicesToSave', Array.from(invoicesToSave.entries()).map(([k,v])=>({invoiceNumber:k, invoiceData:v}))); } catch(_){}

            // Persist every built invoice to Firestore so it survives refresh
            for (const [invoiceNumber, invoiceData] of invoicesToSave.entries()) {
                // If this invoice was marked cancelled via special code, force canceled status
                let finalTotal = parseFloat((invoiceData.totalSales || 0).toFixed(2));
                let status;
                if (invoiceData.isCanceled) {
                    status = 'canceled';
                    finalTotal = 0;
                } else {
                    status = finalTotal < 0 ? 'due' : invoiceData.collectionStatus;
                }
                const paidAmount = (status === 'paid') ? finalTotal : (status === 'partial' ? (invoiceData.partialAmount || 0) : 0);

                const newSale = {
                    id: Date.now().toString() + savedCount,
                    date: dateISO,
                    createdAt: now,
                    updatedAt: now,
                    repName: repName,
                    repId: rep ? rep.id : null,
                    repEmail: rep ? rep.email : null,
                    customerId: customerId,
                    invoiceNumber: invoiceNumber,
                    items: invoiceData.items.map(i => ({
                        productId: i.productId,
                        quantity: i.quantity,
                        price: i.price,
                        discountPercent: i.discountPercent,
                        itemTotal: i.itemFinalPrice,
                    })),
                    total: finalTotal,
                    status,
                    isCanceled: !!invoiceData.isCanceled,
                    paidAmount: paidAmount,
                    // Persist partial payment into firstPayment for immediate visibility in Cash
                    firstPayment: status === 'partial' ? (invoiceData.partialAmount || 0) : (paidAmount || 0),
                    discount: 0,
                    notes: 'ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹',
                    taxFilingStatus: invoiceData.taxFilingStatus
                };

                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    const current = (typeof AuthSystem !== 'undefined' && AuthSystem.getCurrentUser) ? AuthSystem.getCurrentUser() : null;
                    console.log('ğŸ” Admin metadata check:', { role, currentId: current?.id, repId: rep?.id, isAdmin: role === 'admin', isDifferentUser: current && rep && String(current.id) !== String(rep.id) });
                    if (role === 'admin' && current && rep && String(current.id) !== String(rep.id)) {
                        // ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØªÙŠ ØªØ¯Ø®Ù„Ù‡Ø§ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù†ÙŠØ§Ø¨Ø© Ø¹Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
                        newSale.isAdminEntry = true;
                        newSale.originalCreatorId = current.id;
                        newSale.recordedByName = current.name || 'Ø¥Ø¯Ø§Ø±Ø©';
                        newSale.adminEntry = true;
                        newSale.adminEnteredBy = current.id;
                        newSale.created_by_admin = true;
                        newSale.entry_source = 'admin';
                        // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
                        newSale.notes += ' - (ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)';
                        console.log('âœ… Admin metadata added to invoice:', invoiceNumber, { isAdminEntry: true, recordedByName: newSale.recordedByName });
                    } else {
                        console.log('âŒ Admin metadata NOT added - condition not met');
                    }
                } catch(e) { console.error('Admin metadata error:', e); }

                try {
                    // Just save normally - addSale handles everything
                    await addSale(newSale);
                    savedCount++;
                } catch (e) {
                    console.warn('Bulk save failed for invoice', invoiceNumber, e);
                    const errMsg = (e && e.message) ? e.message : String(e);
                    saveErrors.push({ invoiceNumber, error: errMsg });
                    const msg = (errMsg || '').toLowerCase();
                    const code = e && e.code ? e.code : null;
                    const isPerm = (code === 'permission-denied' || (typeof code === 'string' && code.toLowerCase().includes('permission'))) || msg.includes('permission') || msg.includes('insufficient');
                    if (isPerm) {
                        try {
                            await customDialog({ message: 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø­Ø³Ø§Ø¨Ùƒ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø£Ùˆ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. (ØªÙØ§ØµÙŠÙ„ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…)', title: 'Ø®Ø·Ø£ Ø£Ø°ÙˆÙ†Ø§Øª', confirmClass: 'bg-red-600 hover:bg-red-700' });
                        } catch(_){}
                        return; // stop further saves
                    }
                    // otherwise continue to next invoice
                }
            }

            if (savedCount > 0) {
                const maxInvoiceNumber = Math.max(...Array.from(invoicesToSave.keys()).map(Number));
                if (rep && rep.nextInvoiceNumber <= maxInvoiceNumber) { rep.nextInvoiceNumber = maxInvoiceNumber + 1; }
                
                // Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ Ø§Ù„Ù…Ø­Ø¯Ù‘Ø« ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                try {
                    if (rep && rep.id) {
                        await db.collection('reps').doc(rep.id).set({ nextInvoiceNumber: rep.nextInvoiceNumber }, { merge: true });
                        console.log('âœ… Updated rep nextInvoiceNumber to', rep.nextInvoiceNumber, 'for rep', repName);
                    }
                } catch(e) { console.warn('Failed to update rep nextInvoiceNumber:', e); }
                
                renderAll();
                await customDialog({ message: `ØªÙ… Ø­ÙØ¸ ${savedCount} ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­. ${rep ? `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ${repName} Ù‡Ùˆ ${rep.nextInvoiceNumber}.` : ''}`, title: 'Ø­ÙØ¸ Ù†Ø§Ø¬Ø­', confirmClass: 'bg-green-600 hover:bg-green-700' });
                initializeSpreadsheetPage();
            } else {
                // Provide more info to the user if available
                try {
                    if (saveErrors.length > 0) {
                        const preview = saveErrors.slice(0,3).map(e => `Ø±Ù‚Ù… ${e.invoiceNumber}: ${e.error}`).join('\n');
                        await customDialog({ message: `Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ ÙÙˆØ§ØªÙŠØ±. Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸:\n${preview}\nØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø± ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… (Console).`, title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', confirmClass: 'bg-red-600 hover:bg-red-700' });
                    } else {
                        const hasInline = (typeof spreadsheetEntryBody !== 'undefined' && spreadsheetEntryBody && spreadsheetEntryBody.querySelectorAll('.border-red-500').length > 0)
                            || document.querySelectorAll('.border-red-500').length > 0;
                        if (hasInline) {
                            const firstInvalid = (typeof spreadsheetEntryBody !== 'undefined' && spreadsheetEntryBody)
                                ? spreadsheetEntryBody.querySelector('.border-red-500')
                                : document.querySelector('.border-red-500');
                            try { if (firstInvalid && typeof firstInvalid.focus === 'function') firstInvalid.focus(); } catch(_){ }
                        } else {
                            await customDialog({ message: 'Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ ÙÙˆØ§ØªÙŠØ±. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©.', title: 'ØªÙ†Ø¨ÙŠÙ‡' });
                        }
                    }
                } catch(_) {
                    try {
                        const firstInvalid = (typeof spreadsheetEntryBody !== 'undefined' && spreadsheetEntryBody)
                            ? spreadsheetEntryBody.querySelector('.border-red-500')
                            : document.querySelector('.border-red-500');
                        if (firstInvalid && typeof firstInvalid.focus === 'function') firstInvalid.focus();
                    } catch(_){ }
                }
            }
        }

        function renderAll() {
            state.sales.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); saveState(); const repFilterSelect = document.getElementById('dashboard-rep-filter'); const currentFilter = repFilterSelect.value; populateRepDropdown(repFilterSelect, currentFilter);
            const textFilter = document.getElementById('search-sales-text').value; const dateFilter = document.getElementById('search-sales-date').value; const custFilter = document.getElementById('search-customers').value; const prodFilter = document.getElementById('search-products').value;
            scheduleRender('dashboard-main', ()=>{ try { renderDashboard(); } catch(e){} try { renderDispatchPage(); } catch(e){} });
            scheduleRender('sales-list', ()=>{ try { renderAllSales(textFilter, dateFilter); } catch(e){} });
            scheduleRender('customers-list', ()=>{ try { renderCustomers(custFilter); } catch(e){} });
            scheduleRender('reps-list', ()=>{ try { renderReps(); } catch(e){} });
            scheduleRender('settings-products', ()=>{ try { renderSettings(prodFilter); } catch(e){} });
            scheduleRender('promotions', ()=>{ try { renderPromotions(); } catch(e){} });
            scheduleRender('debts', ()=>{ try { renderDebts(); } catch(e){} });
            scheduleRender('rep-debts', ()=>{ try { renderRepDebts(); } catch(e){} });
            scheduleRender('costs', ()=>{ try { renderUnifiedPriceGrid(); } catch(e){} });
            // RENDER CHARTS ONCE ON DASHBOARD LOAD, not on every renderAll()
            // if (document.getElementById('page-dashboard').classList.contains('active')) { renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); }
            const statementCustomerList = document.getElementById('statement-customer-list'); const statementCustomerSearch = document.getElementById('statement-customer-search'); if (statementCustomerList && statementCustomerSearch) { statementCustomerSearch.value = ''; updateCustomerList(''); } updateIcons(); 
            // Ensure Cash view stays in sync whenever main UI re-renders (e.g., after background sync / saves)
            try { if (typeof renderCash === 'function') renderCash(); } catch (e) { console.warn('renderAll: renderCash failed', e); }
            // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø£ÙŠ Ù„ÙˆØ­Ø© ØªØ´Ø®ÙŠØµ/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            // Ù†Ø¹ØªÙ…Ø¯ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Firestore ÙÙ‚Ø· Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©.
        }
        
        // --- NEW REPORTING FUNCTIONS ---
        function initializeReportsPage() {
            populateRepDropdownReports(dailyReportRepSelect);
            populateRepDropdownReports(rangeReportRepSelect);
            populateRepDropdownReports(monthlyReportRepSelect);
            populateRepDropdownReports(document.getElementById('recon-report-rep'));
            
            // Set default date/month
            const today = new Date().toISOString().split('T')[0];
            dailyReportDateInput.value = today;
            rangeStartDateInput.value = today;
            rangeEndDateInput.value = today;
            
            const currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
            monthlyReportMonthInput.value = currentMonth;
            const targetsMonthInput = document.getElementById('targets-month');
            if (targetsMonthInput) targetsMonthInput.value = currentMonth;
            const customerTargetsMonthInput = document.getElementById('customer-targets-month');
            if (customerTargetsMonthInput) customerTargetsMonthInput.value = currentMonth;
            
            // Set initial content area based on active subnav item
            const activeReportSection = reportsSubnav.querySelector('.reports-subnav-item.active')?.dataset.reportSection || 'daily';
            showReportContent(activeReportSection);
        }

        function showReportContent(section) {
            reportContentAreas.forEach(area => {
                area.classList.add('hidden');
                area.classList.remove('active');
            });
            const activeArea = document.querySelector(`#page-reports [data-report-content="${section}"]`);
            if (activeArea) {
                activeArea.classList.remove('hidden');
                activeArea.classList.add('active');
            }
            // Ø¹Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ§Ø±Ø¬Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            if (section === 'targets') {
                try { generateTargetsReport(); return; } catch(e){}
            }
            if (section === 'customer-targets') {
                try { generateCustomerTargetsReport(); return; } catch(e){}
            }
            reportOutputArea.innerHTML = '<p class="text-center text-gray-500 mt-8">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</p>';
        }

        function printSection(elementId) {
            const printElement = document.getElementById(elementId);
            if (!printElement) return;

            printElement.classList.add('printable-content');
            
            // Use a timeout to ensure styles are applied before the print dialog blocks the main thread
            setTimeout(() => {
                window.print();
                // Another timeout to remove the class after the print dialog has opened
                setTimeout(() => {
                    printElement.classList.remove('printable-content');
                }, 500);
            }, 50);
        }

        // Internal helper: capture element to canvas with high-quality defaults
        async function captureElementCanvas(element, scale = 2) {
            // Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† (ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙŠØ³Ø¨Ø¨ Ø¥Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©)
            const prev = {
                boxShadow: element.style.boxShadow,
                filter: element.style.filter,
                transform: element.style.transform
            };
            element.style.boxShadow = 'none';
            element.style.filter = 'none';
            element.style.transform = 'none';
            try {
                await new Promise(r => requestAnimationFrame(r));
                const canvas = await html2canvas(element, {
                    scale,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    ignoreElements: el => el.classList.contains('no-print')
                });
                return canvas;
            } finally {
                element.style.boxShadow = prev.boxShadow;
                element.style.filter = prev.filter;
                element.style.transform = prev.transform;
            }
        }

        // Upload a Blob to Firebase Storage and return a public URL
        async function uploadImageBlobToStorage(blob, pathPrefix = 'shares/exports') {
            // Fallback Ø³Ø±ÙŠØ¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙŠÙÙØªØ­ Ù…Ù† file:// Ø­ÙŠØ« ÙŠÙ…Ù†Ø¹ Firebase Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† (CORS origin null)
            if (location.protocol === 'file:') {
                console.warn('uploadImageBlobToStorage: ØªØ´ØºÙŠÙ„ Ù…Ù† file:// => Ø§Ù„ØªØ®Ø·ÙŠ ÙˆØ¥Ø±Ø¬Ø§Ø¹ null');
                return null; // ÙŠØ³Ù…Ø­ Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ¯Ø¹ÙŠØ© Ø¨Ø¨Ù†Ø§Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø¯ÙŠÙ„Ø©
            }
            if (!window.storage) throw new Error('Firebase Storage ØºÙŠØ± Ù…Ù‡ÙŠØ£');
            try {
                const uid = (window.auth && auth.currentUser && auth.currentUser.uid) ? auth.currentUser.uid : 'anon';
                const path = `${pathPrefix}/${uid}/${Date.now()}.png`;
                const ref = storage.ref().child(path);
                const metadata = { contentType: 'image/png', cacheControl: 'public, max-age=31536000' };
                const snap = await ref.put(blob, metadata);
                const url = await snap.ref.getDownloadURL();
                return url;
            } catch(e){
                console.warn('uploadImageBlobToStorage: ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø¯ÙŠÙ„Ø©', e);
                return null;
            }
        }

        async function generateReportImage(elementId) {
            const reportElement = document.getElementById(elementId);
            if (!reportElement) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù†Ø³Ø®Ù‡.' });
                return;
            }

            try {
                showLoading('Ø¬Ø§Ø±Ù ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ ØµÙˆØ±Ø©...');
                const isRecon = elementId === 'recon-report-output';
                let canvas;
                if (isRecon){
                    reportElement.classList.add('recon-export-scale');
                    canvas = await captureElementCanvas(reportElement, 4);
                    reportElement.classList.remove('recon-export-scale');
                } else {
                    canvas = await captureElementCanvas(reportElement, 2);
                }
                hideLoading();

                const imageUrl = canvas.toDataURL('image/png');
                const previewContainer = document.getElementById('image-preview-container');
                const downloadBtn = document.getElementById('download-image-btn');
                const imagePreviewModal = document.getElementById('image-preview-modal');

                if (!previewContainer || !downloadBtn || !imagePreviewModal) {
                    await customDialog({title: 'Ø®Ø·Ø£', message: 'Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.'});
                    return;
                }

                previewContainer.innerHTML = '';
                const img = document.createElement('img');
                img.src = imageUrl;
                // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø¨ÙƒØ³Ù„Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙƒØ¨ÙŠØ±Ø§Ù‹)
                if (isRecon) {
                    img.style.width = canvas.width + 'px';
                    img.style.maxWidth = '100%';
                    previewContainer.style.maxWidth = canvas.width + 'px';
                    previewContainer.style.overflow = 'auto';
                } else {
                    img.className = 'w-full h-auto';
                }
                previewContainer.appendChild(img);

                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = imageUrl;
                    a.download = `report-${elementId}.png`;
                    a.click();
                };

                openModal(imagePreviewModal);

            } catch (err) {
                console.error('html2canvas failed:', err);
                hideLoading();
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±.' });
            }
        }

        // Share settlement report to WhatsApp by uploading to Storage and opening wa.me link
        async function shareSettlementWhatsApp(elementId) {
            const el = document.getElementById(elementId);
            if (!el) { await customDialog({title:'Ø®Ø·Ø£', message:'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ©.'}); return; }
            try {
                showLoading('Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨...');
                const canvas = await captureElementCanvas(el, 2);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                if (!blob) throw new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©');
                const url = await uploadImageBlobToStorage(blob, 'shares/settlements');
                hideLoading();

                const date = (window.dailyReportDateInput && dailyReportDateInput.value) ? dailyReportDateInput.value : '';
                const rep = (window.dailyReportRepSelect && dailyReportRepSelect.value && dailyReportRepSelect.value !== 'all') ? dailyReportRepSelect.value : '';
                const msg = `ØªØ³ÙˆÙŠØ© ${rep ? rep + ' - ' : ''}${date ? date : ''}\n${url}`;

                const wa = `https://wa.me/?text=${encodeURIComponent(msg)}`;
                window.open(wa, '_blank');
            } catch (e) {
                console.error('WhatsApp share failed', e);
                hideLoading();
                await customDialog({title:'Ø®Ø·Ø£', message:'ØªØ¹Ø°Ø± Ù…Ø´Ø§Ø±ÙƒØ© ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.'});
            }
        }

        async function exportSelectedRows(exportType) {
            const checkedBoxes = document.querySelectorAll('#total-bills-table-body input.total-bill-row-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                await customDialog({ title: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØµÙ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„ØªØµØ¯ÙŠØ±Ù‡.' });
                return;
            }

            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
            const selectedSales = state.sales.filter(s => selectedIds.includes(s.id));

            // Check if total should be included
            const includeTotalCheckbox = document.getElementById('include-total-in-export');
            let totalHtml = '';
            if (includeTotalCheckbox && includeTotalCheckbox.checked) {
                const totalContainer = document.getElementById('total-bills-summary-container');
                if (totalContainer) {
                    const clonedTotal = totalContainer.cloneNode(true);
                    const checkboxDiv = clonedTotal.querySelector('div:last-child');
                    if (checkboxDiv) checkboxDiv.remove(); // Remove the checkbox from the cloned element
                    clonedTotal.classList.add('mb-4');
                    totalHtml = clonedTotal.outerHTML;
                }
            }

            // Re-create the table header, but without the checkbox column
            const originalThead = document.querySelector('#total-bills-table thead');
            const clonedThead = originalThead.cloneNode(true);
            clonedThead.querySelector('th').remove(); // Remove the first th (checkbox)
            
            // Build the new table rows
            const rowsHtml = selectedSales.map(sale => {
                const customer = findCustomer(sale.customerId);
                const category = sale.items.length > 0 ? (findProduct(sale.items[0].productId)?.category || 'N/A') : 'N/A';
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-bold">${sale.invoiceNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${customer ? customer.name : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${sale.repName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold">${formatCurrency(sale.total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${getStatusBadge(sale.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${category}</td>
                    </tr>
                `;
            }).join('');

            // Create a temporary printable element
            const tempExportElement = document.createElement('div');
            tempExportElement.id = 'temp-export-area';
            tempExportElement.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h2>
                ${totalHtml}
                <table class="min-w-full divide-y divide-gray-200" style="direction: rtl;">
                    ${clonedThead.outerHTML}
                    <tbody class="bg-white divide-y divide-gray-200">${rowsHtml}</tbody>
                </table>
            `;
            tempExportElement.style.position = 'absolute';
            tempExportElement.style.left = '-9999px';
            document.body.appendChild(tempExportElement);

            // Call the appropriate export function
            if (exportType === 'print') {
                await printSection('temp-export-area');
            } else if (exportType === 'image') {
                await generateReportImage('temp-export-area');
            }

            // Clean up
            document.body.removeChild(tempExportElement);
        }

        function generateDailyReport() {
            const date = dailyReportDateInput.value;
            const repName = dailyReportRepSelect.value;
            const chainId = document.getElementById('daily-report-chain').value;
            
            if (!date) {
                customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const salesForDay = state.sales.filter(s => {
                const saleDate = new Date(s.date).toISOString().split('T')[0];
                const matchesDate = saleDate === date;
                const matchesRep = (repName === 'all' || s.repName === repName);
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                return matchesDate && matchesRep && matchesChain;
            }).sort((a, b) => a.invoiceNumber - b.invoiceNumber);

            let totalSales = 0;
            let totalReturns = 0;
            
            const reportRows = salesForDay.map(sale => {
                const customer = findCustomer(sale.customerId);
                const isReturn = sale.total < 0;
                
                if (isReturn) {
                    totalReturns += sale.total;
                } else {
                    totalSales += sale.total;
                }

                const totalClass = isReturn ? 'text-red-600 font-bold' : 'text-green-600 font-bold';

                return `<tr class="border-b ${isReturn ? 'bg-red-100/50' : ''}">
                    <td class="px-4 py-2">${sale.invoiceNumber}</td>
                    <td class="px-4 py-2">${customer?.name || 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ'}</td>
                    <td class="px-4 py-2">${sale.repName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td class="px-4 py-2 text-center ${totalClass}">${formatCurrency(sale.total)}</td>
                    <td class="px-4 py-2 text-center">${getStatusBadge(sale.status)}</td>
                </tr>`;
            }).join('');
            
            const netSales = totalSales + totalReturns; // Returns are already negative
            const chainName = chainId ? document.querySelector('#daily-report-chain option[value="' + chainId + '"]').textContent : '';

            let outputHTML = `
                <div id="daily-report-output" class="bg-white p-4 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold mb-4">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù€: ${date} (${repName === 'all' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨' : repName}${chainId ? ' - Ø§Ù„Ø³Ù„Ø³Ù„Ø©: ' + chainName : ''})</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</p>
                            <p class="text-xl font-bold text-green-800">${formatCurrency(totalSales)}</p>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="text-sm text-red-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</p>
                            <p class="text-xl font-bold text-red-800">${formatCurrency(totalReturns)}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-700">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</p>
                            <p class="text-xl font-bold text-blue-800">${formatCurrency(netSales)}</p>
                        </div>
                    </div>
                    
                    ${salesForDay.length > 0 ? `
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-100">
                                    ${reportRows}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø£Ùˆ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</p>'}
                </div>
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('daily-report-output')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="generateReportImage('daily-report-output')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> Ù†Ø³Ø® ÙƒØµÙˆØ±Ø©</button>
                </div>
            `;
            
            reportOutputArea.innerHTML = outputHTML;
            updateIcons();
        }

        // Placeholder for other reports (to be implemented later if requested)
        function generateRangeReport() {
            const start = rangeStartDateInput.value;
            const end = rangeEndDateInput.value;
            const repName = rangeReportRepSelect.value;
            const chainId = document.getElementById('range-report-chain').value;
            
            if (!start || !end) {
                customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const startDate = new Date(start + 'T00:00:00Z');
            const endDate = new Date(end + 'T23:59:59Z');
            const salesInRange = state.sales.filter(s => {
                const d = new Date(s.date);
                const matchesDate = d >= startDate && d <= endDate;
                const matchesRep = repName === 'all' || s.repName === repName;
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                return matchesDate && matchesRep && matchesChain;
            }).sort((a,b)=> new Date(a.date) - new Date(b.date));

            let totalSales = 0; let totalReturns = 0;
            const rowsHtml = salesInRange.map(sale => {
                const customer = findCustomer(sale.customerId);
                const isReturn = sale.total < 0;
                if (isReturn) totalReturns += sale.total; else totalSales += sale.total;
                const totalClass = isReturn ? 'text-red-600 font-bold' : 'text-green-600 font-bold';
                return `<tr class="border-b ${isReturn ? 'bg-red-50' : ''}">\n                    <td class="px-3 py-1 text-center">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>\n                    <td class="px-3 py-1">${sale.invoiceNumber || ''}</td>\n                    <td class="px-3 py-1">${customer?.name || 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ'}</td>\n                    <td class="px-3 py-1">${sale.repName || ''}</td>\n                    <td class="px-3 py-1 text-center ${totalClass}">${formatCurrency(sale.total)}</td>\n                    <td class="px-3 py-1 text-center">${getStatusBadge(sale.status)}</td>\n                </tr>`;
            }).join('');
            const netSales = totalSales + totalReturns;
            const chainName = chainId ? document.querySelector('#range-report-chain option[value="' + chainId + '"]').textContent : '';

            // ØªØ¬Ù…ÙŠØ¹ ÙŠÙˆÙ…ÙŠ Ù…Ø®ØªØµØ±
            const dailyMap = new Map();
            salesInRange.forEach(s => {
                const dayKey = new Date(s.date).toISOString().split('T')[0];
                const prev = dailyMap.get(dayKey) || { sales:0, returns:0 };
                if (s.total < 0) prev.returns += s.total; else prev.sales += s.total;
                dailyMap.set(dayKey, prev);
            });
            const dailyRows = Array.from(dailyMap.entries()).sort((a,b)=> new Date(a[0]) - new Date(b[0]))
                .map(([day, agg]) => {
                    const net = agg.sales + agg.returns;
                    return `<tr class="border-b">\n                        <td class="px-2 py-1">${day}</td>\n                        <td class="px-2 py-1 text-green-700 font-semibold">${formatCurrency(agg.sales)}</td>\n                        <td class="px-2 py-1 text-red-700 font-semibold">${formatCurrency(agg.returns)}</td>\n                        <td class="px-2 py-1 text-blue-700 font-semibold">${formatCurrency(net)}</td>\n                    </tr>`; }).join('');

            reportOutputArea.innerHTML = `
                <div id="range-report-output" class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${start} Ø¥Ù„Ù‰ ${end} (${repName === 'all' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨' : repName})</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                        <div class="p-2 bg-green-50 rounded"><p class="text-xs text-green-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p><p class="text-lg font-bold text-green-800">${formatCurrency(totalSales)}</p></div>
                        <div class="p-2 bg-red-50 rounded"><p class="text-xs text-red-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</p><p class="text-lg font-bold text-red-800">${formatCurrency(totalReturns)}</p></div>
                        <div class="p-2 bg-blue-50 rounded"><p class="text-xs text-blue-700">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p><p class="text-lg font-bold text-blue-800">${formatCurrency(netSales)}</p></div>
                    </div>
                    <h4 class="font-semibold mb-2">Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ</h4>
                    ${dailyRows ? `<table class="min-w-full mb-4 text-sm"><thead class="bg-gray-50"><tr><th class="px-2 py-1 text-right">Ø§Ù„ÙŠÙˆÙ…</th><th class="px-2 py-1 text-center">Ù…Ø¨ÙŠØ¹Ø§Øª</th><th class="px-2 py-1 text-center">Ù…Ø±ØªØ¬Ø¹Ø§Øª</th><th class="px-2 py-1 text-center">ØµØ§ÙÙŠ</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<p class="text-gray-500">Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</p>'}
                    <h4 class="font-semibold mb-2">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h4>
                    ${rowsHtml ? `<div class="overflow-x-auto border rounded"><table class="min-w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-3 py-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="px-3 py-1">Ø±Ù‚Ù…</th><th class="px-3 py-1">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="px-3 py-1">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th class="px-3 py-1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th class="px-3 py-1">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>` : '<p class="text-gray-500">Ù„Ø§ ÙÙˆØ§ØªÙŠØ± Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚.</p>'}
                </div>
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('range-report-output')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="generateReportImage('range-report-output')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> Ù†Ø³Ø® ÙƒØµÙˆØ±Ø©</button>
                </div>
            `;
            updateIcons();
        }

        function generateMonthlyReport() {
            const month = monthlyReportMonthInput.value; // YYYY-MM
            const repName = monthlyReportRepSelect.value;
            const chainId = document.getElementById('monthly-report-chain').value;
            
            if (!month) { customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø´Ù‡Ø±.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' }); return; }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const [yearStr, monthStr] = month.split('-');
            const year = parseInt(yearStr,10); const m = parseInt(monthStr,10) - 1;
            const startDate = new Date(Date.UTC(year, m, 1));
            const endDate = new Date(Date.UTC(year, m+1, 0, 23,59,59));
            const monthSales = state.sales.filter(s => {
                const d = new Date(s.date);
                const matchesDate = d >= startDate && d <= endDate;
                const matchesRep = repName === 'all' || s.repName === repName;
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                return matchesDate && matchesRep && matchesChain;
            });
            let totalSales = 0; let totalReturns = 0;
            const byRep = new Map();
            monthSales.forEach(s => {
                const key = s.repName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const agg = byRep.get(key) || { sales:0, returns:0 };
                if (s.total < 0) { agg.returns += s.total; totalReturns += s.total; } else { agg.sales += s.total; totalSales += s.total; }
                byRep.set(key, agg);
            });
            const netSales = totalSales + totalReturns;
            const repRows = Array.from(byRep.entries()).map(([rep, agg]) => {
                const net = agg.sales + agg.returns;
                return `<tr class="border-b">\n                    <td class="px-3 py-1">${rep}</td>\n                    <td class="px-3 py-1 text-center text-green-700 font-semibold">${formatCurrency(agg.sales)}</td>\n                    <td class="px-3 py-1 text-center text-red-700 font-semibold">${formatCurrency(agg.returns)}</td>\n                    <td class="px-3 py-1 text-center text-blue-700 font-semibold">${formatCurrency(net)}</td>\n                </tr>`; }).join('');
            // Ø£ÙØ¶Ù„ 5 Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            const customerAgg = new Map();
            monthSales.forEach(s => {
                const cid = s.customerId || 'unknown';
                const ag = customerAgg.get(cid) || { net:0 };
                ag.net += s.total; customerAgg.set(cid, ag);
            });
            const chainName = chainId ? document.querySelector('#monthly-report-chain option[value="' + chainId + '"]').textContent : '';
            const topCustomers = Array.from(customerAgg.entries()).sort((a,b)=> b[1].net - a[1].net).slice(0,5)
                .map(([cid, ag]) => `<tr class="border-b"><td class="px-2 py-1">${findCustomer(cid)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td><td class="px-2 py-1 text-center font-semibold">${formatCurrency(ag.net)}</td></tr>`).join('');

            reportOutputArea.innerHTML = `
                <div id="monthly-report-output" class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ ${month} (${repName === 'all' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨' : repName})</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                        <div class="p-2 bg-green-50 rounded"><p class="text-xs text-green-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p><p class="text-lg font-bold text-green-800">${formatCurrency(totalSales)}</p></div>
                        <div class="p-2 bg-red-50 rounded"><p class="text-xs text-red-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</p><p class="text-lg font-bold text-red-800">${formatCurrency(totalReturns)}</p></div>
                        <div class="p-2 bg-blue-50 rounded"><p class="text-xs text-blue-700">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p><p class="text-lg font-bold text-blue-800">${formatCurrency(netSales)}</p></div>
                    </div>
                    <h4 class="font-semibold mb-2">Ù…Ù„Ø®Øµ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h4>
                    ${repRows ? `<table class="min-w-full text-sm mb-4"><thead class="bg-gray-50"><tr><th class="px-3 py-1 text-right">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th class="px-3 py-1 text-center">Ù…Ø¨ÙŠØ¹Ø§Øª</th><th class="px-3 py-1 text-center">Ù…Ø±ØªØ¬Ø¹Ø§Øª</th><th class="px-3 py-1 text-center">ØµØ§ÙÙŠ</th></tr></thead><tbody>${repRows}</tbody></table>` : '<p class="text-gray-500">Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª.</p>'}
                    <h4 class="font-semibold mb-2">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (ØµØ§ÙÙŠ)</h4>
                    ${topCustomers ? `<table class="text-sm mb-4"><thead class="bg-gray-50"><tr><th class="px-2 py-1 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="px-2 py-1 text-center">Ø§Ù„ØµØ§ÙÙŠ</th></tr></thead><tbody>${topCustomers}</tbody></table>` : '<p class="text-gray-500">Ù„Ø§ Ø¹Ù…Ù„Ø§Ø¡.</p>'}
                </div>
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('monthly-report-output')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="generateReportImage('monthly-report-output')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> Ù†Ø³Ø® ÙƒØµÙˆØ±Ø©</button>
                </div>
            `;
            updateIcons();
        }

        // ===== Targets Report =====
        function generateTargetsReport(){
            const monthVal = (document.getElementById('targets-month')?.value)||'';
            const chainId = (document.getElementById('targets-chain-filter')?.value)||'';
            
            if (!monthVal){ customDialog({title:'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', message:'Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„ØªØ§Ø±Ø¬Øª.'}); return; }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const [yearStr, monthStr] = monthVal.split('-');
            const year = parseInt(yearStr,10); const m = parseInt(monthStr,10)-1;
            const monthStart = new Date(Date.UTC(year,m,1));
            const monthEnd = new Date(Date.UTC(year,m+1,0,23,59,59));
            const today = new Date();
            const daysInMonth = new Date(year,m+1,0).getDate();
            const todayDay = (today.getMonth()===m && today.getFullYear()===year) ? today.getDate() : daysInMonth; // Ø¥Ø°Ø§ Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚ Ø§Ø¹ØªØ¨Ø±Ù‡ Ù…ÙƒØªÙ…Ù„

            // Build reps list and populate filter options
            const repsAll = (state.reps||[]).map(r => ({ id:r.id, name:r.name||r.id, target:Number(r.target||0) }));
            const repFilterEl = document.getElementById('targets-rep-filter');
            if (repFilterEl){
                const selVal = repFilterEl.value || 'all';
                // Rebuild options if counts differ or first time
                if (repFilterEl.dataset.filled !== '1' || repFilterEl.options.length-1 !== repsAll.length){
                    const current = selVal;
                    repFilterEl.innerHTML = '<option value="all">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</option>' + repsAll.map(r=>`<option value="${escapeHtml(r.name)}">${escapeHtml(r.name)}</option>`).join('');
                    repFilterEl.dataset.filled = '1';
                    // try keep previous selection
                    if ([...repFilterEl.options].some(o=>o.value===current)) repFilterEl.value = current;
                }
            }
            const selectedRepName = (repFilterEl && repFilterEl.value && repFilterEl.value!=='all') ? repFilterEl.value : null;
            const reps = selectedRepName ? repsAll.filter(r=>r.name===selectedRepName) : repsAll;
            if (reps.length === 0){ reportOutputArea.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù…Ø³Ø¬Ù„Ø©.</p>'; return; }

            const dayAgg = new Map();
            (state.sales||[]).forEach(s => {
                const d = new Date(s.date);
                if (d < monthStart || d > monthEnd) return;
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                if (!matchesChain) return;
                const dayKey = d.toISOString().split('T')[0];
                const repName = s.repName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const net = s.total;
                const mapForDay = dayAgg.get(dayKey) || new Map();
                mapForDay.set(repName, (mapForDay.get(repName)||0) + net);
                dayAgg.set(dayKey, mapForDay);
            });
            // Soft column colors per rep
            const colBgs = ['#f0f9ff','#eef2ff','#f5f3ff','#fdf2f8','#fff7ed','#fefce8','#ecfccb','#f0fdf4','#fafaf9','#e0f2fe'];
            const colBgsStrong = ['#e0f2fe','#e0e7ff','#ede9fe','#fde2f3','#ffedd5','#fef3c7','#d9f99d','#dcfce7','#e7e5e4','#bae6fd'];
            const rows = [];
            const cumulativeByRep = {}; reps.forEach(r => cumulativeByRep[r.name]=0);
            for (let day=1; day<=daysInMonth; day++){
                const isoDay = `${year}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const mapForDay = dayAgg.get(isoDay) || new Map();
                let totalDay = 0;
                const cells = reps.map((r, idx) => {
                    const val = mapForDay.get(r.name)||0;
                    cumulativeByRep[r.name] += val;
                    totalDay += val;
                    const base = colBgs[idx % colBgs.length];
                    const strong = colBgsStrong[idx % colBgsStrong.length];
                    const bg = val ? strong : base;
                    return `<td style='background:${bg};color:#0b1b34;font-size:12px;font-weight:${val? '600':'400'}'>${val? formatCurrency(val):'0.00'}</td>`;
                }).join('');
                // Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ØŒ ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¢Ø®Ø± Ø¹Ù…ÙˆØ¯
                rows.push(`<tr>
                    <td class='targets-col-day'>${String(day).padStart(2,'0')}/${String(m+1).padStart(2,'0')}/${year}</td>${cells}<td class='targets-col-total'>${totalDay? formatCurrency(totalDay):'0.00'}</td>
                </tr>`);
            }
            const achievedRowCells = reps.map((r,idx) => `<td style='background:${colBgsStrong[idx%colBgsStrong.length]};color:#065f46;font-weight:700'>${formatCurrency(cumulativeByRep[r.name])}</td>`).join('');
            const targetRowCells = reps.map((r,idx) => `<td style='background:${colBgs[idx%colBgs.length]};color:#111827;font-weight:700'>${formatCurrency(r.target)}</td>`).join('');
            const remainingRowCells = reps.map(r => {
                const rem = r.target - cumulativeByRep[r.name];
                return `<td style='background:${rem>0?'#fde68a':'#bbf7d0'};color:#111827;font-weight:700'>${formatCurrency(rem)}</td>`;
            }).join('');
            const expectedPct = todayDay / daysInMonth;
            const expectedRowCells = reps.map((r,idx) => `<td style='background:${idx%2===0?'#e0e7ff':'#e0f2fe'};color:#0b1b34;font-weight:700'>${(expectedPct*100).toFixed(1)}%</td>`).join('');
            const achievedPctCells = reps.map(r => {
                const pct = r.target? (cumulativeByRep[r.name]/r.target):0;
                const good = pct >= expectedPct;
                return `<td style='background:${good?'#bbf7d0':'#fecaca'};color:#065f46;font-weight:700'>${(pct*100).toFixed(1)}%</td>`;
            }).join('');

            const totalAchieved = Object.values(cumulativeByRep).reduce((a,b)=>a+b,0);
            const totalTargets = reps.reduce((a,r)=>a+r.target,0);
            const totalRemaining = totalTargets - totalAchieved;

            const tableHtml = `
            <div id='targets-report-output' style='direction:rtl;font-family:Cairo;'>
                <table class='targets-table'>
                    <thead>
                        <tr style='color:#fff;'>
                            <th style='background:#3b82f6;font-weight:bold'>Ø§Ù„ÙŠÙˆÙ…</th>
                            ${reps.map((r,idx)=>`<th style='background:#2563eb;font-weight:bold'>${r.name}</th>`).join('')}
                            <th style='background:#ef4444;font-weight:bold'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</th>
                        </tr>
                    </thead>
                    <tbody>${rows.join('')}</tbody>
                    <tfoot>
                        <tr><td style='background:#e0f2fe;color:#065f46;font-weight:700'>${(expectedPct*100).toFixed(1)}%</td>${expectedRowCells}<td style='background:#e0f2fe;color:#065f46;font-weight:700'>Ù†Ø³Ø¨Ø© Ù…Ø³ØªÙ‡Ø¯ÙØ© Ø­ØªÙ‰ Ø§Ù„ÙŠÙˆÙ…</td></tr>
                        <tr><td style='background:#bbf7d0;color:#065f46;font-weight:700'>${totalTargets? ((totalAchieved/totalTargets)*100).toFixed(1):'0.0'}%</td>${achievedPctCells}<td style='background:#bbf7d0;color:#065f46;font-weight:700'>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚</td></tr>
                        <tr><td style='background:#fef3c7;color:#111827;font-weight:700'>${formatCurrency(totalTargets)}</td>${targetRowCells}<td style='background:#fef3c7;color:#111827;font-weight:700'>Ø§Ù„ØªØ§Ø±Ø¬Øª</td></tr>
                        <tr><td style='background:${totalRemaining>0?'#fde68a':'#bbf7d0'};color:#111827;font-weight:700'>${formatCurrency(totalRemaining)}</td>${remainingRowCells}<td style='background:${totalRemaining>0?'#fde68a':'#bbf7d0'};color:#111827;font-weight:700'>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</td></tr>
                        <tr><td style='background:#bfdbfe;color:#0b1b34;font-weight:700'>${formatCurrency(totalAchieved)}</td>${achievedRowCells}<td style='background:#bfdbfe;color:#0b1b34;font-weight:700'>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù‚Ù‚</td></tr>
                    </tfoot>
                </table>
                <div style='display:flex;gap:12px;margin-top:12px;' class='no-print'>
                    <button onclick="printSection('targets-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="generateReportImage('targets-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> ØµÙˆØ±Ø©</button>
                </div>
            </div>`;
            reportOutputArea.innerHTML = tableHtml;
            updateIcons();
        }

        // ===== Customer Targets Report (Ø§ÙƒØ³Ø¨Ø´Ù† / Ø³ÙÙŠØ± / Ø§Ù„Ø¶Ø­Ù‰) =====
        function getCustomerTargetsStore(){
            state.customerTargets = state.customerTargets || {}; // month -> { customerId: { multi: number, dairy: number } }
            return state.customerTargets;
        }
        function getCustomerTargetsForMonth(month){
            const store = getCustomerTargetsStore();
            if (!store[month]) store[month] = {};
            return store[month];
        }
        function saveCustomerTargetsFromInputs(){
            const monthVal = document.getElementById('customer-targets-month')?.value;
            if (!monthVal){ customDialog({title:'ØªÙ†Ø¨ÙŠÙ‡', message:'Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹.'}); return; }
            const monthKey = monthVal;
            const targetObj = getCustomerTargetsForMonth(monthKey);
            const inputs = document.querySelectorAll('#customer-targets-report-output .cust-target-input');
            inputs.forEach(inp => {
                const cid = inp.dataset.customerId; const cat = inp.dataset.category; const val = parseFloat(inp.value)||0;
                targetObj[cid] = targetObj[cid] || { multi:0, dairy:0 };
                targetObj[cid][cat] = val;
            });
            saveState();
            customDialog({title:'Ø­ÙØ¸', message:'ØªÙ… Ø­ÙØ¸ Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ø±Ø¬Øª.'});
            generateCustomerTargetsReport();
        }
        function generateCustomerTargetsReport(){
            const monthVal = document.getElementById('customer-targets-month')?.value || '';
            const catVal = document.getElementById('customer-targets-category')?.value || 'both';
            const out = document.getElementById('customer-targets-report-output');
            if (!out) return;
            if (!monthVal){ out.innerHTML = '<p class="text-center text-gray-500">Ø§Ø®ØªØ± Ø´Ù‡Ø±.</p>'; return; }
            const [yStr, mStr] = monthVal.split('-'); const year = parseInt(yStr,10); const m = parseInt(mStr,10)-1;
            const monthStart = new Date(Date.UTC(year,m,1)); const monthEnd = new Date(Date.UTC(year,m+1,0,23,59,59));
            // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙˆÙ† Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const nameKeys = ['Ø§ÙƒØ³Ø¨Ø´Ù†','Ø³ÙÙŠØ±','Ø§Ù„Ø¶Ø­Ù‰'];
            // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø£ÙŠ Ø§Ø³Ù… ÙŠØ­ØªÙˆÙŠ "Ø§ÙƒØ³Ø¨Ø´Ù†" Ùˆ"Ø­Ù„ÙˆØ§Ù†ÙŠ/Ø­Ù„ÙˆØ§Ù†Ù‰" Ù…Ø¹Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§ÙƒØ³Ø¨Ø´Ù† Ø­Ù„ÙˆØ§Ù†ÙŠ)
            const customers = (state.customers||[]).filter(c => {
                const nm = (c.name||'');
                const include = nameKeys.some(k => nm.includes(k));
                const isExcluded = /Ø§ÙƒØ³Ø¨Ø´Ù†/.test(nm) && /(Ø­Ù„ÙˆØ§Ù†ÙŠ|Ø­Ù„ÙˆØ§Ù†Ù‰)/.test(nm);
                return include && !isExcluded;
            });
            if (customers.length === 0){ out.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³ØªÙ‡Ø¯ÙØ©.</p>'; return; }
            const targetsMonthObj = getCustomerTargetsForMonth(monthVal);
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª "Ø´ÙŠÙ„ÙŠ" Ù…Ù† Ø§ÙƒØ³Ø¨Ø´Ù†
            const agg = {}; // cid -> { multiAch: number, dairyAch: number }
            (state.sales||[]).forEach(sale => {
                const d = new Date(sale.date);
                if (d < monthStart || d > monthEnd) return;
                const cid = sale.customerId;
                const cust = customers.find(c => c.id === cid || c._id === cid);
                if (!cust) return;
                sale.items.forEach(item => {
                    const p = findProduct(item.productId); if (!p) return;
                    // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø´ÙŠÙ„ÙŠ Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§ÙƒØ³Ø¨Ø´Ù†
                    const nameLower = (cust.name||'').toLowerCase();
                    const prodLower = (p.name||'').toLowerCase();
                    if (nameLower.includes('Ø§ÙƒØ³Ø¨Ø´Ù†') && prodLower.includes('Ø´ÙŠÙ„ÙŠ')) return;
                    const qty = Number(item.quantity||item.qty||0);
                    const price = Number(p.price||0);
                    const value = qty * price;
                    const cat = String(p.category||'').toLowerCase();
                    const isMulti = cat.includes('Ù…Ø§Ù„Øª') || cat.includes('multi');
                    const isDairy = cat.includes('Ø¨Ø§Ù†') || cat.includes('Ø¬Ø¨Ù†') || cat.includes('cheese') || cat.includes('dairy');
                    agg[cid] = agg[cid] || { multiAch:0, dairyAch:0 };
                    if (isMulti) agg[cid].multiAch += value; else if (isDairy) agg[cid].dairyAch += value;
                });
            });
            function fmt(v){ return formatCurrency(v||0); }
            const rows = customers.map(c => {
                const cid = c.id || c._id; const a = agg[cid] || { multiAch:0, dairyAch:0 };
                const targetData = targetsMonthObj[cid] || {}; // Ù‚Ø¯ ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ© (Ø£Ø´Ø¨Ø§Ø­ Ø£ØµÙØ§Ø±)
                const hasMultiSaved = Object.prototype.hasOwnProperty.call(targetData,'multi');
                const hasDairySaved = Object.prototype.hasOwnProperty.call(targetData,'dairy');
                const multiTarget = hasMultiSaved ? Number(targetData.multi||0) : 0;
                const dairyTarget = hasDairySaved ? Number(targetData.dairy||0) : 0;
                const multiRem = multiTarget - a.multiAch; const dairyRem = dairyTarget - a.dairyAch;
                const multiPct = multiTarget? (a.multiAch/multiTarget)*100:0; const dairyPct = dairyTarget? (a.dairyAch/dairyTarget)*100:0;
                // Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ù‚ÙŠÙ…Ø© ÙØ§Ø±ØºØ© Ù…Ø¹ placeholder ØµÙØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¨Ø¹Ø¯ (Ø´Ø¨Ø­ ØµÙØ±)
                const multiInputVal = hasMultiSaved ? multiTarget : '';
                const dairyInputVal = hasDairySaved ? dairyTarget : '';
                const multiInput = `<input type='number' step='any' class='cust-target-input w-20 p-1 border rounded text-center text-xs' data-category='multi' data-customer-id='${cid}' value='${multiInputVal}' placeholder='0'/>`;
                const dairyInput = `<input type='number' step='any' class='cust-target-input w-20 p-1 border rounded text-center text-xs' data-category='dairy' data-customer-id='${cid}' value='${dairyInputVal}' placeholder='0'/>`;
                if (catVal === 'multi'){
                    return `<tr>
                        <td class='name'>${escapeHtml(c.name)}</td>
                        <td>${multiInput}</td>
                        <td class='ach-cell'>${fmt(a.multiAch)}</td>
                        <td class='${multiRem>0?'rem-pos':'rem-zero'}'>${fmt(multiRem)}</td>
                        <td class='${multiPct>=50?'pct-ok':'pct-low'}'>${multiPct.toFixed(1)}%</td>
                    </tr>`;
                } else if (catVal === 'dairy'){
                    return `<tr>
                        <td class='name'>${escapeHtml(c.name)}</td>
                        <td>${dairyInput}</td>
                        <td class='ach-cell'>${fmt(a.dairyAch)}</td>
                        <td class='${dairyRem>0?'rem-pos':'rem-zero'}'>${fmt(dairyRem)}</td>
                        <td class='${dairyPct>=50?'pct-ok':'pct-low'}'>${dairyPct.toFixed(1)}%</td>
                    </tr>`;
                } else { // both
                    const totalTarget = multiTarget + dairyTarget;
                    const totalAch = a.multiAch + a.dairyAch;
                    const totalRem = totalTarget - totalAch;
                    const totalPct = totalTarget? (totalAch/totalTarget)*100:0;
                    return `<tr>
                        <td class='name'>${escapeHtml(c.name)}</td>
                        <td>${multiInput}</td>
                        <td class='ach-cell'>${fmt(a.multiAch)}</td>
                        <td>${dairyInput}</td>
                        <td class='ach-cell'>${fmt(a.dairyAch)}</td>
                        <td class='ach-cell'>${fmt(totalTarget)}</td>
                        <td class='ach-cell'>${fmt(totalAch)}</td>
                        <td class='${totalRem>0?'rem-pos':'rem-zero'}'>${fmt(totalRem)}</td>
                        <td class='${totalPct>=50?'pct-ok':'pct-low'}'>${totalPct.toFixed(1)}%</td>
                    </tr>`;
                }
            }).join('');
            let thead;
            if (catVal === 'multi'){
                thead = `<tr>
                    <th class='cth-name'>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th class='cth-multi-target'>ØªØ§Ø±Ø¬Øª Ù…Ø§Ù„ØªÙŠ</th>
                    <th class='cth-multi-ach'>Ù…Ø­Ù‚Ù‚ Ù…Ø§Ù„ØªÙŠ</th>
                    <th class='cth-rem'>Ù…ØªØ¨Ù‚ÙŠ</th>
                    <th class='cth-pct'>% Ù…Ø­Ù‚Ù‚</th>
                </tr>`;
            } else if (catVal === 'dairy'){
                thead = `<tr>
                    <th class='cth-name'>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th class='cth-dairy-target'>ØªØ§Ø±Ø¬Øª Ø§Ù„Ø¨Ø§Ù†</th>
                    <th class='cth-dairy-ach'>Ù…Ø­Ù‚Ù‚ Ø§Ù„Ø¨Ø§Ù†</th>
                    <th class='cth-rem'>Ù…ØªØ¨Ù‚ÙŠ</th>
                    <th class='cth-pct'>% Ù…Ø­Ù‚Ù‚</th>
                </tr>`;
            } else {
                thead = `<tr>
                    <th class='cth-name'>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th class='cth-multi-target'>ØªØ§Ø±Ø¬Øª Ù…Ø§Ù„ØªÙŠ</th>
                    <th class='cth-multi-ach'>Ù…Ø­Ù‚Ù‚ Ù…Ø§Ù„ØªÙŠ</th>
                    <th class='cth-dairy-target'>ØªØ§Ø±Ø¬Øª Ø§Ù„Ø¨Ø§Ù†</th>
                    <th class='cth-dairy-ach'>Ù…Ø­Ù‚Ù‚ Ø§Ù„Ø¨Ø§Ù†</th>
                    <th class='cth-total-target'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ§Ø±Ø¬Øª</th>
                    <th class='cth-total-ach'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù‚Ù‚</th>
                    <th class='cth-rem-total'>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th class='cth-pct-total'>% Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>`;
            }
            out.innerHTML = `<div id='customer-targets-report-wrapper' class='bg-white p-3 rounded-lg shadow'>
                <table class='customer-targets-table'>
                    <thead>${thead}</thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class='flex gap-2 mt-3 no-print'>
                    <button onclick="printSection('customer-targets-report-wrapper')" class='bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm flex items-center gap-1'><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="generateReportImage('customer-targets-report-wrapper')" class='bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm flex items-center gap-1'><i data-lucide='image'></i> ØµÙˆØ±Ø©</button>
                </div>
            </div>`;
            updateIcons();
        }

                // Settlement (ØªØ³ÙˆÙŠØ©) report: aggregates dispatch note vs actual sales & returns per product for a rep/date
                function generateSettlementReport(){
                    // Ø§Ø³ØªØ®Ø¯Ù… Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¥Ù† ÙˆÙØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ fallback Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    const dateInput = document.getElementById('settlement-report-date');
                    const repSelect = document.getElementById('settlement-report-rep');
                    const date = (dateInput && dateInput.value) ? dateInput.value : (dailyReportDateInput ? dailyReportDateInput.value : '');
                    const repName = (repSelect && repSelect.value) ? repSelect.value : (dailyReportRepSelect ? dailyReportRepSelect.value : '');
                    if (!date) { customDialog({ message:'Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®Ø§Ù‹ Ù„Ù„ØªØ³ÙˆÙŠØ©.', title:'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' }); return; }
                    if (!repName || repName === 'all') { customDialog({ message:'Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨ ÙˆØ§Ø­Ø¯ Ù„Ù„ØªØ³ÙˆÙŠØ©.', title:'ØªÙ†Ø¨ÙŠÙ‡' }); return; }

                        // Find dispatch note for that rep/day
                        const dispatchNote = state.dispatchNotes.find(n => n.repName === repName && new Date(n.date).toISOString().split('T')[0] === date);
                        // Build product baseline from products list to keep ordering stable
                        const productIds = state.products.map(p => p.id);
                        const salesForDay = state.sales.filter(s => s.repName === repName && new Date(s.date).toISOString().split('T')[0] === date);

                        // Aggregations
                        const agg = {}; // productId -> metrics
                        function ensure(id){ if(!agg[id]) agg[id] = { productId:id, name: (findProduct(id)?.name)||id, dispatched:0, goodReturn:0, damagedReturn:0, freebie:0, sold:0, invoiceReturn:0 }; }
                        // From dispatch note items
                        if (dispatchNote && Array.isArray(dispatchNote.items)) {
                            dispatchNote.items.forEach(it=>{
                                ensure(it.productId);
                                agg[it.productId].dispatched += Number(it.quantity||0);
                                // Ø¯Ø¹Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯: actualReturn ÙŠØ¹Ø§Ù…Ù„ ÙƒÙ…Ø±ØªØ¬Ø¹ Ø³Ù„ÙŠÙ…
                                agg[it.productId].goodReturn += Number(it.actualReturn||it.goodReturn||0);
                                agg[it.productId].damagedReturn += Number(it.damagedReturn||0);
                                agg[it.productId].freebie += Number(it.freebie||0);
                            });
                        }
                        // From sales (positive quantities)
                        salesForDay.forEach(sale => {
                                sale.items.forEach(item => {
                                        ensure(item.productId);
                                        const q = Number(item.quantity||item.qty||0);
                                        if (sale.total < 0 || q < 0) { agg[item.productId].invoiceReturn += Math.abs(q); }
                                        else { agg[item.productId].sold += q; }
                                });
                        });
                        // Include any product ids missing but present in sales/dispatch
                        Object.keys(agg).forEach(id=>{ if(!productIds.includes(id)) productIds.push(id); });
                        // Rows
                        const rowsHtml = productIds.map(pid => {
                                ensure(pid);
                                const m = agg[pid];
                                // Diff = dispatched - (sold + freebie + returns good + returns damaged)
                                const used = m.sold + m.freebie + m.goodReturn + m.damagedReturn + m.invoiceReturn;
                                const diff = m.dispatched - used;
                                return `<tr style="background:#0b2d5e;color:#fff;font-size:12px;">
                                        <td style='text-align:center;background:#1f3f79'>${formatCurrency(0)}</td>
                                        <td style='text-align:center;background:#111'>${diff}</td>
                                        <td style='text-align:center;background:#062c5c'>${m.dispatched}</td>
                                        <td style='text-align:center;background:#094b2e'>${m.goodReturn}</td>
                                        <td style='text-align:center;background:#062c5c'>${m.invoiceReturn}</td>
                                        <td style='text-align:center;background:#051c44'>${m.sold}</td>
                                        <td style='text-align:center;background:#062c5c'>${m.damagedReturn}</td>
                                        <td style='text-align:center;background:#094b2e'>${m.freebie}</td>
                                        <td style='text-align:center;background:#051c44'>${m.dispatched - m.goodReturn - m.damagedReturn}</td>
                                        <td style='text-align:center;background:#041635'>${m.name}</td>
                                </tr>`;
                        }).join('');

                        const billNumber = salesForDay.length ? (salesForDay[0].invoiceNumber||'') : (dispatchNote?.serial||'');
                        const dayNum = date.split('-')[2];
                        const yearNum = date.split('-')[0];
                        const monthNum = date.split('-')[1];

                        reportOutputArea.innerHTML = `
                                <div id='settlement-report-output' style='direction:rtl;font-family:Cairo;'>
                                    <table style='width:100%;border:4px solid #001a3d;font-size:12px;border-collapse:separate;'>
                                        <thead>
                                            <tr style='background:#0b2d5e;color:#fff;'>
                                                <th style='width:60px;background:#331b6d'>Ù‚ÙŠÙ…Ø©</th>
                                                <th style='background:#0b0b0b'>Ø§Ù„Ø¹Ø¬Ø² / Ø§Ù„ÙØ§Ø¦Ø¶</th>
                                                <th style='background:#041a3f'>Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ø°Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ¨ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                                <th style='background:#094b2e'>Ù‡Ø§Ù„Ùƒ ÙˆØ§ÙƒØ±Ø§Ù…ÙŠØ§Øª</th>
                                                <th style='background:#041a3f'>ØµØ§ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                                <th style='background:#051c44'>Ù…Ø±ØªØ¬Ø¹ ÙÙˆØ§ØªÙŠØ± Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                                <th style='background:#041a3f'>ØµØ§ÙÙŠ Ø¨ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                                <th style='background:#051c44'>Ù…Ø±ØªØ¬Ø¹ Ø§Ø°Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                                <th style='background:#094b2e'>Ø§Ø°Ù† Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                                <th style='background:#0b0b0b'>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                                            </tr>
                                            <tr style='background:#062c5c;color:#fff;'>
                                                <th style='background:#331b6d'>0.00</th>
                                                <th style='background:#111'>${yearNum}</th>
                                                <th style='background:#062c5c'>${monthNum}</th>
                                                <th style='background:#fff;color:#000;font-weight:bold'><img src='' alt='' style='height:20px'></th>
                                                <th style='background:#d49c3b;color:#000;font-weight:bold'>${date.split('-').reverse().join('/')}</th>
                                                <th style='background:#1f3f79'>${repName}</th>
                                                <th style='background:#8d0000;color:#fff'>${billNumber||''}</th>
                                                <th style='background:#b46900;color:#fff'>${dayNum}</th>
                                                <th style='background:#041a3f'>${repName}</th>
                                                <th style='background:#041635'>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rowsHtml}</tbody>
                                    </table>
                                    <div style='display:flex;gap:16px;margin-top:12px;'>
                                        <div style='background:#331b6d;color:#fff;padding:8px 24px;font-weight:bold;'>Total</div>
                                        <div style='background:#271056;color:#fff;padding:8px 24px;font-weight:bold;'>0.0</div>
                                        <div style='flex:1;background:linear-gradient(90deg,#008a00,#006400);color:#fff;text-align:center;font-weight:bold;padding:12px 8px;border:2px solid #004c00;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¬ÙˆØ²Ø§Øª ÙˆØ²ÙŠØ§Ø¯Ø§Øª</div>
                                    </div>
                                    <div class='mt-4 grid grid-cols-3 gap-2 no-print'>
                                        <button onclick="printSection('settlement-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                                        <button onclick="generateReportImage('settlement-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> Ù†Ø³Ø® ÙƒØµÙˆØ±Ø©</button>
                                        <button onclick="shareSettlementWhatsApp('settlement-report-output')" class='bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2'><i data-lucide='send'></i> Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
                                    </div>
                                </div>`;
                        updateIcons();
                }
        
        async function generateReconciliationReport() {
            const date = document.getElementById('recon-report-date').value;
            const repName = document.getElementById('recon-report-rep').value;
            const chainId = document.getElementById('recon-report-chain').value;
            const reportOutputArea = document.getElementById('report-output-area');

            if (!date || !repName) {
                await customDialog({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø¯ÙˆØ¨.', title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });
                return;
            }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }

            // 1. Find the dispatch note
            const dispatchNote = state.dispatchNotes.find(n =>
                n.repName === repName && new Date(n.date).toISOString().split('T')[0] === date
            );

            if (!dispatchNote) {
                reportOutputArea.innerHTML = '<p class="text-center text-red-500 p-4">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ø³ØªÙ„Ø§Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>';
                return;
            }

            // 2. Find all sales for the rep on that day (apply chain filter)
            const sales = state.sales.filter(s =>
                s.repName === repName && new Date(s.date).toISOString().split('T')[0] === date && 
                (!allowedCustomerIds || allowedCustomerIds.includes(s.customerId))
            );

            // 3. Aggregate sales by product ID
            const salesByProduct = {};
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    salesByProduct[item.productId] = (salesByProduct[item.productId] || 0) + item.quantity;
                });
            });

            // 4. Create a master list of all products involved
            const allProductIds = new Set([
                ...dispatchNote.items.map(i => i.productId),
                ...Object.keys(salesByProduct)
            ]);

            // 5. Generate report rows
            let reportRowsHtml = '';
            let totalDeficitValue = 0;
            let totalSurplusValue = 0;

            allProductIds.forEach(productId => {
                const product = findProduct(productId);
                if (!product) return;

                const dispatchItem = dispatchNote.items.find(i => i.productId === productId) || {};
                const takenOut = dispatchItem.quantity || 0;
                const goodReturn = dispatchItem.goodReturn || 0;
                const damagedReturn = dispatchItem.damagedReturn || 0;
                const freebie = dispatchItem.freebie || 0;
                
                const sold = salesByProduct[productId] || 0;

                const expectedReturn = takenOut - sold - freebie;
                const actualReturn = goodReturn + damagedReturn;
                const difference = actualReturn - expectedReturn;

                const differenceValue = difference * (product.price || 0);
                let diffClass = 'text-gray-700';
                if (difference < 0) {
                    diffClass = 'text-red-600 font-bold';
                    totalDeficitValue += differenceValue; // differenceValue will be negative
                } else if (difference > 0) {
                    diffClass = 'text-green-600 font-bold';
                    totalSurplusValue += differenceValue;
                }

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„ØµÙ†Ù Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø§Ù„Ù…Ø®Ø±Ø¬) .. Ø¥Ù„Ø® + ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§
                reportRowsHtml += `
                    <tr style="border-bottom:1px solid #112b57;">
                        <td style="background:#041635;color:#fff;padding:6px 4px;text-align:right;font-weight:600">${escapeHtml(product.name)}</td>
                        <td style="background:#d49c3b;color:#000;padding:6px 4px;text-align:center;font-weight:600">${takenOut}</td>
                        <td style="background:#0b0b0b;color:#fff;padding:6px 4px;text-align:center">${sold}</td>
                        <td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center">${freebie}</td>
                        <td style="background:#041a3f;color:#fff;padding:6px 4px;text-align:center;font-weight:600">${expectedReturn}</td>
                        <td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center">${goodReturn}</td>
                        <td style="background:#041a3f;color:#fff;padding:6px 4px;text-align:center">${damagedReturn}</td>
                        <td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center;font-weight:600">${actualReturn}</td>
                        <td style="background:#041a3f;color:${difference<0?'#ff2e2e':(difference>0?'#25d366':'#fff')};padding:6px 4px;text-align:center;font-weight:${difference!==0?'700':'400'}">${difference}</td>
                        <td style="background:#062c5c;color:${differenceValue<0?'#ff2e2e':(differenceValue>0?'#25d366':'#fff')};padding:6px 4px;text-align:center;font-weight:${differenceValue!==0?'700':'400'}">${formatCurrency(differenceValue)}</td>
                    </tr>`;
            });

            // 6. Build final report HTML
            const finalHtml = `
                <div id='recon-report-output' style='direction:rtl;font-family:Cairo;'>
                    <div style='display:grid;grid-template-columns:120px 1fr 120px;align-items:center;margin-bottom:4px;'>
                        <div style='background:#3b0d00;color:#fff;padding:12px 8px;text-align:center;font-weight:bold;font-size:20px;border:2px solid #210600;'>${date.split('-')[2]}</div>
                        <div style='background:linear-gradient(90deg,#002aa8,#004dff);color:#fff;text-align:center;padding:12px 8px;font-size:24px;font-weight:bold;border:2px solid #001a3d;'>Ø¨ÙŠØ§Ù† Ø¨Ø¹Ø¬ÙˆØ²Ø§Øª ÙˆØ²ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ†</div>
                        <div style='background:#041a3f;color:#fff;padding:12px 8px;text-align:center;font-weight:bold;font-size:20px;border:2px solid #001a3d;'>${repName}</div>
                    </div>
                    <table style='width:100%;border:4px solid #001a3d;font-size:13px;border-collapse:separate;'>
                        <thead>
                            <tr style='color:#fff;'>
                                <th style='background:#041635;text-align:center;font-weight:bold'>Ø§Ù„ØµÙ†Ù</th>
                                <th style='background:#d49c3b;color:#000;font-weight:bold;width:70px;text-align:center'>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                                <th style='background:#0b0b0b;text-align:center;font-weight:bold'>Ø§Ù„Ù…Ø¨Ø§Ø¹</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</th>
                                <th style='background:#041a3f;text-align:center;font-weight:bold'>Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>Ù…Ø±ØªØ¬Ø¹ Ø³Ù„ÙŠÙ…</th>
                                <th style='background:#041a3f;text-align:center;font-weight:bold'>Ù…Ø±ØªØ¬Ø¹ ØªØ§Ù„Ù</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                                <th style='background:#041a3f;text-align:center;font-weight:bold'>Ø§Ù„ÙØ±Ù‚ ÙƒÙ…ÙŠØ©</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>Ø§Ù„ÙØ±Ù‚ Ù‚ÙŠÙ…Ø©</th>
                            </tr>
                        </thead>
                        <tbody>${reportRowsHtml}</tbody>
                    </table>
                    <div style='display:flex;gap:16px;margin-top:12px;'>
                        <div style='background:#3b0d00;color:#fff;padding:8px 24px;font-weight:bold;'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¬Ø²</div>
                        <div style='background:#5c1a00;color:#fff;padding:8px 24px;font-weight:bold;'>${formatCurrency(totalDeficitValue)}</div>
                        <div style='background:#d49c3b;color:#000;padding:8px 24px;font-weight:bold;'>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø²ÙŠØ§Ø¯Ø©</div>
                        <div style='background:#094b2e;color:#fff;padding:8px 24px;font-weight:bold;'>${formatCurrency(totalSurplusValue)}</div>
                        <div style='flex:1;background:linear-gradient(90deg,#007a00,#00b300);color:#fff;text-align:center;font-weight:bold;padding:12px 8px;border:2px solid #004c00;'>${(totalDeficitValue===0 && totalSurplusValue===0)?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¬ÙˆØ²Ø§Øª ÙˆØ²ÙŠØ§Ø¯Ø§Øª':'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù‚ÙŠÙ… Ø£Ø¹Ù„Ø§Ù‡'}</div>
                    </div>
                    <div class='mt-4 grid grid-cols-3 gap-2 no-print'>
                        <button onclick="printSection('recon-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button onclick="generateReportImage('recon-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> ØµÙˆØ±Ø© HD</button>
                        <button onclick="shareReconciliationWhatsApp('recon-report-output')" class='bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2'><i data-lucide='send'></i> Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
                    </div>
                </div>`;

            reportOutputArea.innerHTML = finalHtml;
        }

        // Ù…Ø´Ø§Ø±ÙƒØ© ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
        async function shareReconciliationWhatsApp(elementId){
            const el = document.getElementById(elementId);
            const date = document.getElementById('recon-report-date')?.value || '';
            const rep = document.getElementById('recon-report-rep')?.value || '';
            if (!el){ await customDialog({title:'Ø®Ø·Ø£', message:'ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.'}); return; }
            try {
                showLoading('Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨...');
                // ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¯Ø§Ø®Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙŠØ¨
                el.classList.add('recon-export-scale');
                const canvas = await captureElementCanvas(el, 4);
                el.classList.remove('recon-export-scale');
                const blob = await new Promise(r => canvas.toBlob(r,'image/png'));
                if (!blob) throw new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©');
                const url = await uploadImageBlobToStorage(blob, 'shares/final_settlements');
                hideLoading(); // Ø£Ø®ÙÙ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ù†Ø¹
                const msg = `Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ${rep} - ${date}\n${url}`;
                const desktopUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
                let popup = window.open(desktopUrl, '_blank');
                // fallback Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø£Ùˆ Ù…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
                setTimeout(() => {
                    try {
                        if (!popup || popup.closed) {
                            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                        }
                    } catch(_) {
                        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                    }
                }, 1800);
            } catch(e){
                console.warn('shareReconciliationWhatsApp failed', e);
                hideLoading();
                // Ø¨Ù†Ø§Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø¯ÙŠÙ„Ø© ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ (ØºØ§Ù„Ø¨Ø§Ù‹ origin null Ø£Ùˆ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ®Ø²ÙŠÙ†)
                try {
                    const el2 = document.getElementById(elementId);
                    if (el2){
                        el2.classList.add('recon-export-scale');
                        const cnv = await captureElementCanvas(el2, 2);
                        el2.classList.remove('recon-export-scale');
                        const dataUrl = cnv.toDataURL('image/png');
                        // ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠ
                        const w = window.open('about:blank','_blank');
                        if (w) {
                            w.document.write('<title>ØµÙˆØ±Ø© Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title><p style="font-family:sans-serif">Ø§Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø«Ù… Ø£Ø±ÙÙ‚Ù‡Ø§ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨.</p><img style="max-width:100%;" src="'+dataUrl+'" />');
                        }
                        // Ù†Ø³Ø® Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¨Ø¯ÙˆÙ† Ø±Ø§Ø¨Ø· (Ø±ÙØ¹ ÙØ´Ù„)
                        const altMsg = `Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ${rep} - ${date} (Ù…Ø±ÙÙ‚ ØµÙˆØ±Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹)`;
                        try { navigator.clipboard.writeText(altMsg); } catch(_){}
                        await customDialog({title:'Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø¯ÙŠÙ„Ø©', message:'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø©. ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù„Ù„Ø­ÙØ¸ØŒ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ÙØ³Ø®Øª (Ø¥Ù† Ø³Ù…Ø­ Ø§Ù„Ù…ØªØµÙØ­). Ù„ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ø´ØºÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± http:// (Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ) ÙˆØ±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Storage.'});
                        return; // Ø®Ø±ÙˆØ¬ Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø¯ÙŠÙ„Ø©
                    }
                } catch(_) { /* ignore secondary failure */ }
                await customDialog({title:'Ø®Ø·Ø£', message:'ØªØ¹Ø°Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø£Ùˆ ØªØ¬Ù‡ÙŠØ² Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„ØµÙˆØ±Ø©.'});
            }
        }

        // --- END NEW REPORTING FUNCTIONS ---


        function openCustomerModal(id = null) {
            customerForm.reset();
            document.getElementById('customer-id').value = '';
            populatePriceListDropdown(document.getElementById('customer-price-list'));
            populateRepDropdown(document.getElementById('customer-rep'));

            if (id) {
                // Edit mode
                const sid = String(id);
                const customer = state.customers.find(c => String(c.id) === sid || String(c._id) === sid);
                if (customer) {
                    document.getElementById('customer-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„';
                    document.getElementById('customer-id').value = customer.id || customer._id || '';
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-tax-number').value = customer.taxNumber || '';
                    document.getElementById('customer-phone').value = customer.phone || '';
                    document.getElementById('customer-address').value = customer.address || '';
                    document.getElementById('customer-requires-tax').checked = customer.requiresTaxFiling || false;
                    document.getElementById('customer-price-list').value = customer.priceListId || '';
                    document.getElementById('customer-rep').value = customer.repName || '';
                }
            } else {
                // Add mode
                document.getElementById('customer-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
                // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù†Ø¯ÙˆØ¨Ø§Ù‹ØŒ Ø¹ÙŠÙ‘Ù† Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') {
                        const current = AuthSystem.getCurrentUser();
                        if (current) {
                            const myRep = (state.reps||[]).find(r => r.id === current.id);
                            if (myRep && myRep.name) {
                                const repSel = document.getElementById('customer-rep');
                                if (repSel) repSel.value = myRep.name;
                            }
                        }
                    }
                } catch(e) { /* ignore */ }
            }
            openModal(customerModal);
        }

        function openRepModal(id = null) {
            repForm.reset();
            document.getElementById('rep-id').value = '';

            if (id) {
                // Edit mode
                const rep = state.reps.find(r => r.id === id);
                if (rep) {
                    document.getElementById('rep-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨';
                    document.getElementById('rep-id').value = rep.id;
                    document.getElementById('rep-name').value = rep.name;
                    document.getElementById('rep-serial').value = rep.serial || '';
                    document.getElementById('rep-target').value = rep.target || 0;
                    document.getElementById('rep-next-invoice').value = rep.nextInvoiceNumber || '';
                }
            } else {
                // Add mode
                document.getElementById('rep-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¬Ø¯ÙŠØ¯';
            }
            openModal(repModal);
        }

        // --- PRODUCT & PRICE-LIST MODALS & SAVERS ---
        function openProductModal(id = null) {
            productForm.reset();
            document.getElementById('product-id').value = '';
            if (id) {
                const product = state.products.find(p => p.id === id);
                if (product) {
                    document.getElementById('product-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-code').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-price').value = product.price || 0;
                    document.getElementById('product-category').value = product.category || '';
                    document.getElementById('product-vat-rate').value = (product.vat_rate !== undefined && product.vat_rate !== null) ? Number(product.vat_rate) : 0;
                }
            } else {
                document.getElementById('product-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯';
            }
            openModal(productModal);
        }

        function openPriceListModal(id = null) {
            priceListForm.reset();
            document.getElementById('price-list-id').value = '';
            document.getElementById('price-list-name').value = '';
            const container = document.getElementById('price-list-products');
            const tbody = document.getElementById('price-list-products-body');
            const discountInput = document.getElementById('price-list-discount');
            // ensure tbody exists
            if (!tbody) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>';
            } else {
                tbody.innerHTML = '';

                function parseDiscount(str){
                    if (!str) return 0;
                    const n = parseFloat(String(str).replace('%','').trim());
                    return isNaN(n) ? 0 : n;
                }
                function updateAllPricesAfterDiscount(){
                    const d = parseDiscount(discountInput.value);
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
                        const priceInp = tr.querySelector('.price-list-product-input');
                        const afterInp = tr.querySelector('.price-after-discount');
                        if (!priceInp || !afterInp) return;
                        const v = parseFloat(priceInp.value);
                        if (!isNaN(v)) {
                            const newVal = v * (1 - d/100);
                            afterInp.value = formatNumberEN(newVal);
                        } else {
                            afterInp.value = '';
                        }
                    });
                }

                // build rows
                state.products.forEach((p, idx) => {
                    const tr = document.createElement('tr');
                    tr.dataset.pid = p.id;
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-right">${idx+1}</td>
                        <td class="px-3 py-2 text-center">${escapeHtml(String(p.id||''))}</td>
                        <td class="px-3 py-2 text-right">${escapeHtml(String(p.name||''))}</td>
                        <td class="px-3 py-2 text-center">${escapeHtml(String(p.unit||'Ù‚Ø·Ø¹Ø©'))}</td>
                        <td class="px-3 py-2 text-center">${escapeHtml(String(p.barcode||''))}</td>
                        <td class="px-3 py-2 text-center"><input type="number" step="any" class="price-list-product-input p-1 border rounded w-28 text-center" data-product-id="${p.id}" placeholder="" /></td>
                        <td class="px-3 py-2 text-center"><input type="text" readonly class="price-after-discount p-1 border rounded w-28 text-center bg-gray-50" data-product-id="${p.id}" placeholder="" /></td>
                    `;
                    tbody.appendChild(tr);
                });

                // wire events: update single row on price input change
                tbody.addEventListener('input', (ev) => {
                    const target = ev.target;
                    if (target && target.classList && target.classList.contains('price-list-product-input')) {
                        const d = parseDiscount(discountInput.value);
                        const v = parseFloat(target.value);
                        const row = target.closest('tr');
                        const afterInp = row ? row.querySelector('.price-after-discount') : null;
                        if (afterInp) {
                            if (!isNaN(v)) {
                                afterInp.value = formatNumberEN(v * (1 - d/100));
                            } else {
                                afterInp.value = '';
                            }
                        }
                    }
                });

                // wire discount input
                discountInput.addEventListener('input', () => updateAllPricesAfterDiscount());
            }

            if (id) {
                const pl = state.priceLists.find(x => x.id === id);
                if (pl) {
                    document.getElementById('price-list-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±';
                    document.getElementById('price-list-id').value = pl.id;
                    document.getElementById('price-list-name').value = pl.name;
                    // fill product prices
                    Object.keys(pl.productPrices || {}).forEach(pid => {
                        const inp = container.querySelector(`.price-list-product-input[data-product-id="${pid}"]`);
                        if (inp) inp.value = pl.productPrices[pid];
                    });
                }
            } else {
                document.getElementById('price-list-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±';
            }

            openModal(priceListModal);
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value || document.getElementById('product-code').value.trim();
            const code = document.getElementById('product-code').value.trim();
            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value) || 0;
            const vat_rate = parseFloat(document.getElementById('product-vat-rate')?.value) || 0;
            const category = document.getElementById('product-category').value.trim();
            if (!code || !name) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.' });
                return;
            }

            try {
                await updateProduct(code, { name, price, category, vat_rate: vat_rate, active: true });
                closeModal(productModal);
                await customDialog({ title: 'Ù†Ø¬Ø§Ø­', message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.' });
            } catch (err) {
                console.warn('saveProduct cloud failed', err);
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.' });
            }
        }

        async function savePriceList(e) {
            e.preventDefault();
            const id = document.getElementById('price-list-id').value || Date.now().toString();
            const name = document.getElementById('price-list-name').value.trim();
            if (!name) { await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±.' }); return; }
            const container = document.getElementById('price-list-products');
            const inputs = Array.from(container.querySelectorAll('.price-list-product-input'));
            const productPrices = {};
            inputs.forEach(inp => {
                const pid = inp.dataset.productId;
                const val = parseFloat(inp.value);
                if (!isNaN(val)) productPrices[pid] = val;
            });
            try {
                // Persist to Firestore
                const exists = (state.priceLists||[]).some(pl => pl.id === id);
                if (exists) {
                    await updatePriceListDoc(id, { name, productPrices });
                } else {
                    await addPriceListDoc(id, { name, productPrices });
                }
                closeModal(priceListModal);
                await customDialog({ title: 'Ù†Ø¬Ø§Ø­', message: 'ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.' });
            } catch (err) {
                console.warn('savePriceList cloud failed', err);
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.' });
            }
        }

        // ===== Unified Price Grid (Costs Page) =====
        // Renders the unified price grid and persists per-product price edits to Firestore using updateProduct()
        function renderUnifiedPriceGrid() {
            try {
                const tbody = document.querySelector('#unified-price-grid tbody');
                if (!tbody) return;
                // ensure controls exist (category filter)
                const tableEl = document.getElementById('unified-price-grid');
                if (tableEl) {
                    let controls = document.getElementById('unified-grid-controls');
                    if (!controls) {
                        controls = document.createElement('div');
                        controls.id = 'unified-grid-controls';
                        controls.className = 'mb-3 flex gap-2 items-center';
                        tableEl.parentNode.insertBefore(controls, tableEl);
                        controls.innerHTML = `
                            <label class="text-sm">Ø§Ù„ÙØ¦Ø©:</label>
                            <select id="unified-category-filter" class="p-1 border rounded text-sm">
                                <option value="all">Ø§Ù„ÙƒÙ„</option>
                                <option value="raw">Ø§Ù„Ø®Ø§Ù…Ø§Øª</option>
                                <option value="packaging">Ø§Ù„ØªØºÙ„ÙŠÙ</option>
                                <option value="finished">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</option>
                                <option value="operation">Ø§Ù„ØªØ´ØºÙŠÙ„</option>
                            </select>
                            <button id="unified-filter-apply" class="p-1 bg-gray-100 border rounded text-sm">ØªØ·Ø¨ÙŠÙ‚</button>
                        `;
                        // bind apply
                        controls.querySelector('#unified-filter-apply').addEventListener('click', () => renderUnifiedPriceGrid());
                        // re-render when select changes
                        controls.querySelector('#unified-category-filter').addEventListener('change', () => renderUnifiedPriceGrid());
                    }
                }

                tbody.innerHTML = '';
                const selectedCategory = (document.getElementById('unified-category-filter')?.value) || 'all';

                const products = Array.isArray(state.products) ? state.products.slice().sort((a,b)=> String(a.name||'').localeCompare(String(b.name||''), 'ar')) : [];
                const filtered = products.filter(p => {
                    if (selectedCategory === 'all') return true;
                    if (selectedCategory === 'raw') return String(p.category||'').toLowerCase() === 'raw' || String(p.category||'').toLowerCase().includes('raw') || (p.category === 'raw' );
                    if (selectedCategory === 'packaging') return String(p.category||'').toLowerCase().includes('packag') || String(p.category||'').toLowerCase() === 'packaging';
                    if (selectedCategory === 'finished') return !(String(p.category||'').toLowerCase() === 'raw' || String(p.category||'').toLowerCase().includes('packag'));
                    if (selectedCategory === 'operation') return (p.operationCost !== undefined || p.operationCost !== null);
                    return true;
                });

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©.</td></tr>';
                    return;
                }

                filtered.forEach((p) => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-orange-50';

                    // determine editable field per item
                    let fieldKey = 'price';
                    let fieldLabel = 'Ø§Ù„Ø³Ø¹Ø±';
                    if (String(p.category||'').toLowerCase().includes('raw') || String(p.category||'').toLowerCase() === 'raw') { fieldKey = 'cost'; fieldLabel = 'ØªÙƒÙ„ÙØ©'; }
                    else if (String(p.category||'').toLowerCase().includes('packag') || String(p.category||'').toLowerCase() === 'packaging') { fieldKey = 'cost'; fieldLabel = 'ØªÙƒÙ„ÙØ©'; }
                    else if (selectedCategory === 'operation' || p.operationCost !== undefined) { fieldKey = 'operationCost'; fieldLabel = 'ØªÙƒÙ„ÙØ© ØªØ´ØºÙŠÙ„'; }

                    const currentVal = (p[fieldKey] !== undefined && p[fieldKey] !== null) ? Number(p[fieldKey]) : '';

                    tr.innerHTML = `
                        <td class="px-3 py-2 text-right font-medium">${escapeHtml(p.name || '')}</td>
                        <td class="px-3 py-2 text-center text-sm">${escapeHtml(String(p.id || ''))}</td>
                        <td class="px-3 py-2 text-center text-sm">${escapeHtml(String(p.category || ''))}</td>
                        <td class="px-3 py-2 text-center text-sm">${formatNumberEN(currentVal)}</td>
                        <td class="px-3 py-2 text-center"><input type="number" step="any" inputmode="decimal" class="unified-price-input p-1 border rounded w-28 text-center" data-product-id="${escapeHtml(p.id||'')}" data-field-key="${escapeHtml(fieldKey)}" value="${currentVal === '' ? '' : currentVal}" placeholder="${escapeHtml(fieldLabel)}" /></td>
                        <td class="px-3 py-2 text-center flex items-center gap-2"><span class="unified-save-indicator text-xs text-gray-500">&nbsp;</span><button class="unified-history-btn p-1 text-xs bg-white border rounded" data-product-id="${escapeHtml(p.id||'')}">ØªØ§Ø±ÙŠØ®</button></td>
                    `;

                    tbody.appendChild(tr);
                });

                // Attach input handlers with debounce, and bind history buttons
                const inputs = tbody.querySelectorAll('.unified-price-input');
                inputs.forEach(inp => {
                    const pid = inp.dataset.productId;
                    const fkey = inp.dataset.fieldKey || 'price';
                    const newInp = inp.cloneNode(true);
                    inp.parentNode.replaceChild(newInp, inp);
                    const indicator = newInp.closest('tr').querySelector('.unified-save-indicator');
                    let timer = null;
                    newInp.addEventListener('input', (e) => {
                        if (indicator) indicator.textContent = 'ØªØ­Ø±ÙŠØ±...';
                        if (timer) clearTimeout(timer);
                        timer = setTimeout(async () => {
                            const raw = newInp.value.trim();
                            if (raw === '') { if (indicator) indicator.textContent = ''; return; }
                            const num = Number(raw);
                            if (isNaN(num)) { if (indicator) indicator.textContent = 'Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'; return; }
                            newInp.disabled = true;
                            if (indicator) indicator.textContent = 'Ø­ÙØ¸...';
                            try {
                                const payload = {};
                                payload[fkey] = num;
                                payload.updatedAt = serverTs();
                                await updateProduct(pid, payload);
                                // sync local state
                                const prod = state.products.find(x => String(x.id) === String(pid));
                                if (prod) { prod[fkey] = num; prod.updatedAt = new Date().toISOString(); }
                                saveState();
                                if (indicator) indicator.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
                                setTimeout(()=>{ if (indicator) indicator.textContent = ''; }, 1200);
                            } catch (err) {
                                console.warn('Failed to save unified field for', pid, err);
                                if (indicator) indicator.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸';
                                if (err && err.code === 'permission-denied') customDialog({ title: 'ØµÙ„Ø§Ø­ÙŠØ§Øª', message: 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ….' });
                            } finally { newInp.disabled = false; }
                        }, 650);
                    });
                });

                tbody.querySelectorAll('.unified-history-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const pid = e.currentTarget.dataset.productId;
                        openPriceHistory(pid);
                    });
                });

                updateIcons();
            } catch (e) {
                console.warn('renderUnifiedPriceGrid failed', e);
            }
        }

        // Open price history modal for a product and allow adding a snapshot
        function openPriceHistory(productId) {
            try {
                const modal = document.getElementById('price-history-modal');
                const body = document.getElementById('ph-body');
                const addBtn = document.getElementById('ph-add-btn');
                if (!modal || !body || !addBtn) return;
                const prod = state.products.find(p => String(p.id) === String(productId));
                const hist = Array.isArray(prod && prod.priceHistory) ? prod.priceHistory.slice().sort((a,b)=> new Date(b.at) - new Date(a.at)) : [];
                let html = `<div class="space-y-2">`;
                if (!hist.length) html += `<p class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ø®Ù„Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ©.</p>`;
                hist.forEach(h => {
                    const v = h.value !== undefined ? formatNumberEN(h.value) : '';
                    const who = h.by || (h.uid || 'Ù†Ø¸Ø§Ù…');
                    const when = h.at ? new Date(h.at).toLocaleString('ar-EG') : '';
                    html += `<div class="p-2 border rounded bg-white"><div class="text-sm font-medium">${v}</div><div class="text-xs text-gray-500">${who} â€” ${when}</div></div>`;
                });
                html += `</div>`;
                body.innerHTML = html;
                // bind add button
                addBtn.onclick = async () => {
                    try {
                        const prod = state.products.find(p => String(p.id) === String(productId));
                        if (!prod) return;
                        const current = prod.price !== undefined ? prod.price : (prod.cost !== undefined ? prod.cost : null);
                        if (current === null) { await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ø­Ø§Ù„ÙŠØ© Ù„ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§.' }); return; }
                        const entry = { value: current, at: new Date().toISOString(), by: (auth && auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)) ? (auth.currentUser.email || auth.currentUser.uid) : 'unknown' };
                        prod.priceHistory = prod.priceHistory || [];
                        prod.priceHistory.push(entry);
                        // persist
                        await updateProduct(productId, { priceHistory: prod.priceHistory, updatedAt: serverTs() });
                        saveState();
                        await customDialog({ title: 'Ù†Ø¬Ø§Ø­', message: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¹Ø±.' });
                        // re-open to refresh
                        openPriceHistory(productId);
                    } catch (err) {
                        console.warn('add price history failed', err);
                        await customDialog({ title: 'Ø®Ø·Ø£', message: 'ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®.' });
                    }
                };
                openModal(modal);
            } catch (e) { console.warn('openPriceHistory failed', e); }
        }


        // ===== Stock Control: Add Products Locally =====
        async function saveFinishedProductFromStock(e) {
            e.preventDefault();
            const code = document.getElementById('finished-product-code').value.trim();
            const name = document.getElementById('finished-product-name').value.trim();
            const unit = document.getElementById('finished-product-unit').value.trim() || 'Ù‚Ø·Ø¹Ø©';
            const price = parseFloat(document.getElementById('finished-product-price').value) || 0;
            
            if (!code || !name) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.' });
                return;
            }

            // Check if already exists
            if (state.products && state.products.some(p => p.id === code)) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯ Ù…Ø®ØªÙ„Ù.' });
                return;
            }

            try {
                // Add to state.products
                if (!state.products) state.products = [];
                const chocoRe = /chocolate|Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©|Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ©/i;
                const vatRate = chocoRe.test(name) ? 14 : 0;
                state.products.push({
                    id: code,
                    name: name,
                    unit: unit,
                    price: price,
                    vat_rate: vatRate,
                    category: 'finished',
                    active: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                // Save to localStorage
                saveState();
                
                // Add to costFinished for use in recipes
                if (!window.costFinished) window.costFinished = [];
                if (!window.costFinished.some(p => p.id === code)) {
                    window.costFinished.push({ id: code, code: code, name: name, unit: unit, price: price });
                }
                
                // Try to save to Firestore
                try {
                    await updateProduct(code, { name, unit, price, vat_rate: vatRate, category: 'finished', active: true });
                } catch(err) {
                    console.warn('Failed to sync to Firestore:', err);
                }
                
                // Close modal and refresh
                document.getElementById('modal-add-finished-product').classList.add('hidden');
                document.getElementById('form-add-finished-product').reset();
                
                await customDialog({ title: 'Ù†Ø¬Ø§Ø­', message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ "${name}" Ø¨Ù†Ø¬Ø§Ø­.` });
                
                // Refresh stock table
                const dateEl = document.getElementById('finished-products-date');
                if (dateEl) dateEl.dispatchEvent(new Event('change'));
            } catch (err) {
                console.warn('saveFinishedProductFromStock error:', err);
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬.' });
            }
        }

        async function saveRawMaterialFromStock(e) {
            e.preventDefault();
            const code = document.getElementById('raw-material-code').value.trim();
            const name = document.getElementById('raw-material-name').value.trim();
            const unit = document.getElementById('raw-material-unit').value.trim() || 'ÙƒØ¬Ù…';
            const unitPrice = parseFloat(document.getElementById('raw-material-unit_price').value) || 0;
            const qty = parseFloat(document.getElementById('raw-material-qty').value) || 1;
            const totalCost = Math.round((unitPrice * qty) * 100) / 100;
            
            if (!code || !name) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©.' });
                return;
            }

            // Check if already exists
            if (state.products && state.products.some(p => p.id === code)) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯ Ù…Ø®ØªÙ„Ù.' });
                return;
            }

            try {
                // Add to state.products
                if (!state.products) state.products = [];
                const chocoReRaw = /chocolate|Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©|Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ©/i;
                const vatRateRaw = chocoReRaw.test(name) ? 14 : 0;
                // check tax invoice checkbox
                const taxInvoiceEl = document.getElementById('raw-material-is_tax_invoice');
                const hasTaxInvoice = !!(taxInvoiceEl && taxInvoiceEl.checked);
                // Allow explicit VAT value input; fallback to computed 14% of totalCost when tax invoice checked
                const explicitVat = parseFloat(document.getElementById('raw-material-vat_value')?.value) || 0;
                let input_vat = 0;
                if (explicitVat && explicitVat > 0) input_vat = round2(explicitVat);
                else if (hasTaxInvoice && totalCost > 0) input_vat = round2(totalCost * 0.14);

                // capture invoice metadata and optional file
                const vendorTaxId = document.getElementById('raw-material-vendor_tax_id')?.value.trim() || null;
                const invoiceNumber = document.getElementById('raw-material-invoice_number')?.value.trim() || null;
                const invoiceDate = document.getElementById('raw-material-invoice_date')?.value || null;
                const invoiceFileEl = document.getElementById('raw-material-invoice_image');
                const invoiceFile = (invoiceFileEl && invoiceFileEl.files && invoiceFileEl.files[0]) ? invoiceFileEl.files[0] : null;
                let invoiceImageUrl = null;
                if (invoiceFile && window.storage) {
                    try {
                        const path = `invoices/raw/${code}/${Date.now()}_${invoiceFile.name}`;
                        const snap = await window.storage.ref().child(path).put(invoiceFile);
                        invoiceImageUrl = await snap.ref.getDownloadURL();
                    } catch(uerr) { console.warn('upload invoice image failed', uerr); }
                }

                state.products.push({
                    id: code,
                    name: name,
                    unit: unit,
                    cost: unitPrice,
                    vat_rate: vatRateRaw,
                    category: 'raw',
                    active: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });

                // Save to localStorage
                saveState();

                // Add to costRaw for use in recipes
                if (!window.costRaw) window.costRaw = [];
                if (!window.costRaw.some(p => p.id === code)) {
                    window.costRaw.push({ id: code, code: code, name: name, unit: unit, cost: unitPrice, lastPrice: unitPrice, lastPriceDate: new Date().toISOString(), priceHistory: [], lastPaidVat: input_vat, lastInvoiceNumber: invoiceNumber, lastInvoiceDate: invoiceDate, lastVendorTaxId: vendorTaxId, lastInvoiceImageUrl: invoiceImageUrl });
                }

                // Try to save to Firestore
                try {
                    // Step A: update product cost in Firestore (unit price)
                    await updateProduct(code, { name, unit, cost: unitPrice, vat_rate: vatRateRaw, lastPaidVat: input_vat, lastInvoiceNumber: invoiceNumber, lastInvoiceDate: invoiceDate, lastVendorTaxId: vendorTaxId, lastInvoiceImageUrl: invoiceImageUrl, category: 'raw', active: true });
                } catch(err) {
                    console.warn('Failed to sync to Firestore:', err);
                }
                // Step C: write transaction record to `transactions` to capture input_vat for tax report
                try {
                    if (window.db) {
                        await db.collection('transactions').add({
                            type: 'supply',
                            productId: code,
                            productCode: code,
                            name: name,
                            date: new Date().toISOString(),
                            qty: Number(qty || 0),
                            unitPrice: Number(unitPrice || 0),
                            total_cost: Number(totalCost || 0),
                            input_vat: Number(input_vat || 0),
                            vendor_tax_id: vendorTaxId,
                            invoice_number: invoiceNumber,
                            invoice_date: invoiceDate,
                            vat_value_reported: explicitVat || null,
                            invoice_image_url: invoiceImageUrl,
                            createdAt: serverTs()
                        });
                    }
                } catch(e) {
                    console.warn('Failed to write transaction record:', e);
                }
                
                // Close modal and refresh
                document.getElementById('modal-add-raw-material').classList.add('hidden');
                document.getElementById('form-add-raw-material').reset();
                
                await customDialog({ title: 'Ù†Ø¬Ø§Ø­', message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø§Ù…Ø© "${name}" Ø¨Ù†Ø¬Ø§Ø­.` });
                
                // Refresh stock table
                const dateEl = document.getElementById('raw-materials-date');
                if (dateEl) dateEl.dispatchEvent(new Event('change'));
            } catch (err) {
                console.warn('saveRawMaterialFromStock error:', err);
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø®Ø§Ù…Ø©.' });
            }
        }

        async function savePackagingFromStock(e) {
            e.preventDefault();
            const code = document.getElementById('packaging-code').value.trim();
            const name = document.getElementById('packaging-name').value.trim();
            const unit = document.getElementById('packaging-unit').value.trim() || 'Ù‚Ø·Ø¹Ø©';
            const cost = parseFloat(document.getElementById('packaging-cost').value) || 0;
            
            if (!code || !name) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§Ø³Ù… Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø©.' });
                return;
            }

            // Check if already exists
            if (state.products && state.products.some(p => p.id === code)) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯ Ù…Ø®ØªÙ„Ù.' });
                return;
            }

            try {
                // Add to state.products
                if (!state.products) state.products = [];
                const chocoRePack = /chocolate|Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©|Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ©/i;
                const vatRatePack = chocoRePack.test(name) ? 14 : 0;
                state.products.push({
                    id: code,
                    name: name,
                    unit: unit,
                    cost: cost,
                    vat_rate: vatRatePack,
                    category: 'packaging',
                    active: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });

                // Save to localStorage
                saveState();

                // Add to costPack for use in recipes
                if (!window.costPack) window.costPack = [];
                if (!window.costPack.some(p => p.id === code)) {
                    window.costPack.push({ id: code, code: code, name: name, unit: unit, cost: cost, lastPrice: 0, lastPriceDate: null, priceHistory: [], vat_rate: vatRatePack });
                }

                // capture invoice metadata from form
                const vendorTaxId = document.getElementById('packaging-vendor_tax_id')?.value.trim() || null;
                const invoiceNumber = document.getElementById('packaging-invoice_number')?.value.trim() || null;
                const invoiceDate = document.getElementById('packaging-invoice_date')?.value || null;
                const explicitVat = parseFloat(document.getElementById('packaging-vat_value')?.value) || 0;
                let input_vat = explicitVat && explicitVat > 0 ? round2(explicitVat) : 0;
                const invoiceFileEl = document.getElementById('packaging-invoice_image');
                const invoiceFile = (invoiceFileEl && invoiceFileEl.files && invoiceFileEl.files[0]) ? invoiceFileEl.files[0] : null;
                let invoiceImageUrl = null;
                if (invoiceFile && window.storage) {
                    try {
                        const path = `invoices/packaging/${code}/${Date.now()}_${invoiceFile.name}`;
                        const snap = await window.storage.ref().child(path).put(invoiceFile);
                        invoiceImageUrl = await snap.ref.getDownloadURL();
                    } catch(uerr) { console.warn('upload packaging invoice image failed', uerr); }
                }
                // Try to save to Firestore (including invoice metadata)
                try {
                    await updateProduct(code, { name, unit, cost, vat_rate: vatRatePack, category: 'packaging', active: true, lastPaidVat: input_vat, lastInvoiceNumber: invoiceNumber, lastInvoiceDate: invoiceDate, lastVendorTaxId: vendorTaxId, lastInvoiceImageUrl: invoiceImageUrl });
                } catch(err) {
                    console.warn('Failed to sync to Firestore:', err);
                }
                // write transaction record for packaging if provided
                try {
                    if (window.db) {
                        await db.collection('transactions').add({
                            type: 'supply',
                            productId: code,
                            productCode: code,
                            name: name,
                            date: new Date().toISOString(),
                            qty: 1,
                            unitPrice: Number(cost || 0),
                            total_cost: Number(cost || 0),
                            input_vat: Number(input_vat || 0),
                            vendor_tax_id: vendorTaxId,
                            invoice_number: invoiceNumber,
                            invoice_date: invoiceDate,
                            vat_value_reported: explicitVat || null,
                            invoice_image_url: invoiceImageUrl,
                            createdAt: serverTs()
                        });
                    }
                } catch(e) { console.warn('Failed to write packaging transaction record:', e); }
                
                // Close modal and refresh
                document.getElementById('modal-add-packaging').classList.add('hidden');
                document.getElementById('form-add-packaging').reset();
                
                await customDialog({ title: 'Ù†Ø¬Ø§Ø­', message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø© "${name}" Ø¨Ù†Ø¬Ø§Ø­.` });
                
                // Refresh stock table
                const dateEl = document.getElementById('packaging-date');
                if (dateEl) dateEl.dispatchEvent(new Event('change'));
            } catch (err) {
                console.warn('savePackagingFromStock error:', err);
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø©.' });
            }
        }

        // Save global monthly sales target from Settings and refresh dashboard
        async function saveSalesTarget(e) {
            if (e && e.preventDefault) e.preventDefault();
            const input = document.getElementById('sales-target-input');
            if (!input) return;
            // tolerate commas and whitespace
            const raw = String(input.value || '').replace(/,/g, '').trim();
            const val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨).' });
                return;
            }

            state.settings = state.settings || {};
            state.settings.salesTarget = Number(val);
            saveState();
            
            // Ø­ÙØ¸ ÙÙŠ Firebase Firestore
            try {
                if (window.db) {
                    await db.collection('settings').doc('global-settings').set({
                        salesTarget: Number(val),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', val);
                }
            } catch(err) {
                console.warn('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:', err);
            }
            
            renderDashboard();
            await customDialog({ title: 'Ù†Ø¬Ø§Ø­', message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.' });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
        function updateDigitalClock() {
            const clockEl = document.getElementById('digital-clock');
            if (!clockEl) return;
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            clockEl.textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        updateDigitalClock();
        setInterval(updateDigitalClock, 1000);

        function setupNavigationHandlers() {
            const mainNavBar = document.getElementById('main-nav-bar');
            if (mainNavBar) {
                mainNavBar.addEventListener('click', (e) => {
                    const button = e.target.closest('.bottom-nav-item');
                    if (button && button.dataset.page) {
                        const pageId = button.dataset.page;
                        navigateTo(pageId);
                    }
                });
            }

            // Handle Reports Subnav Clicks - query fresh so handlers work even if elements were not present at script parse time
            const _reportsSubnavItems = document.querySelectorAll('.reports-subnav-item');
            _reportsSubnavItems.forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.reports-subnav-item').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const section = e.currentTarget.dataset.reportSection;
                    showReportContent(section);
                    if (section === 'targets') { try { generateTargetsReport(); } catch(e){} }
                });
            });
            updateIcons(); 
        }

        // --- DISPATCH NOTE FUNCTIONS ---

    function generateAndShowDispatchNoteView(noteId) { /* ... */ } 
    function openSettlementModal(noteId) { /* ... */ } 
        
        // --- MANUAL STATEMENT FUNCTION ---
        function generateAndShowStatement(startDate, endDate, customerIds, title, customerNames, category = 'all') {
            const statementModal = document.getElementById('statement-modal');
            endDate.setHours(23, 59, 59, 999); // Include all of the end day

            const salesInRange = state.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= startDate && saleDate <= endDate && customerIds.includes(sale.customerId);
            });

            let filteredSales = salesInRange;
            if (category !== 'all') {
                filteredSales = salesInRange.filter(sale => {
                    return sale.items.some(item => {
                        const product = findProduct(item.productId);
                        // Ensure product exists and has a category property before checking
                        return product && product.category === category;
                    });
                });
            }
            
            // Sort by date
            filteredSales.sort((a, b) => new Date(a.date) - new Date(b.date));

            // ===== Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (Opening Balance) =====
            // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            const salesBeforeStart = state.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate < startDate && customerIds.includes(sale.customerId);
            });
            
            let openingBalance = 0;
            salesBeforeStart.forEach(sale => {
                openingBalance += (sale.total - sale.paidAmount);
            });

            let html = `<div class="bg-white rounded-lg shadow-xl w-full max-w-6xl p-6 modal-body">
                <div class="printable-statement-content">
                    <h2 class="text-2xl font-bold mb-2">${title}</h2>
                    <p class="text-sm text-gray-600 mb-2">Ø§Ù„ÙØªØ±Ø© Ù…Ù†: ${startDate.toLocaleDateString('ar-EG')} Ø¥Ù„Ù‰: ${endDate.toLocaleDateString('ar-EG')}</p>
                    <p class="text-sm text-gray-600 mb-4">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${customerNames}</p>`;

            if (filteredSales.length === 0) {
                html += '<p class="text-center text-gray-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</p>';
            } else {
                html += '<div class="overflow-x-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200 text-sm">';
                html += `<thead class="bg-gray-100"><tr>
                    <th class="px-4 py-2 text-right font-semibold">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th class="px-4 py-2 text-center font-semibold">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th class="px-4 py-2 text-right font-semibold">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th class="px-4 py-2 text-center font-semibold">Ù…Ø¯ÙŠÙ† (Sales)</th>
                    <th class="px-4 py-2 text-center font-semibold">Ø¯Ø§Ø¦Ù† (Payments)</th>
                    <th class="px-4 py-2 text-center font-semibold">Ø§Ù„Ø±ØµÙŠØ¯</th>
                    <th class="px-4 py-2 text-center font-semibold">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr></thead>`;
                html += '<tbody class="bg-white divide-y divide-gray-100">';
                
                // ===== Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ =====
                html += `<tr class="bg-yellow-50 font-bold">
                    <td class="px-4 py-2 text-right">---</td>
                    <td class="px-4 py-2 text-center">---</td>
                    <td class="px-4 py-2 text-right">Ø±ØµÙŠØ¯ Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ±Ø©</td>
                    <td class="px-4 py-2 text-center">---</td>
                    <td class="px-4 py-2 text-center">---</td>
                    <td class="px-4 py-2 text-center font-bold text-blue-700">${formatCurrency(openingBalance)}</td>
                    <td class="px-4 py-2 text-center">---</td>
                </tr>`;
                
                // ===== Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù…Ø¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø§Ø±ÙŠ =====
                let runningBalance = openingBalance;
                filteredSales.forEach(sale => {
                    const customer = findCustomer(sale.customerId);
                    const debit = sale.total; // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ø¯ÙŠÙ†)
                    const credit = sale.paidAmount; // Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ø¯Ø§Ø¦Ù†)
                    runningBalance += (debit - credit);
                    
                    html += `<tr class="${sale.total < 0 ? 'bg-red-50' : ''}">
                        <td class="px-4 py-2 whitespace-nowrap">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
                        <td class="px-4 py-2 text-center">${sale.invoiceNumber}</td>
                        <td class="px-4 py-2 text-right">${customer ? customer.name : 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ'}</td>
                        <td class="px-4 py-2 text-center font-semibold text-green-700">${formatCurrency(debit)}</td>
                        <td class="px-4 py-2 text-center font-semibold text-red-600">${formatCurrency(credit)}</td>
                        <td class="px-4 py-2 text-center font-bold ${runningBalance < 0 ? 'text-red-600' : 'text-blue-700'}">${formatCurrency(runningBalance)}</td>
                        <td class="px-4 py-2 text-center">${getStatusBadge(sale.status)}</td>
                    </tr>`;
                });
                
                // ===== ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ =====
                let totalDebit = 0;
                let totalCredit = 0;
                filteredSales.forEach(sale => {
                    totalDebit += sale.total;
                    totalCredit += sale.paidAmount;
                });
                
                html += `<tr class="bg-gray-200 font-bold border-t-2 border-gray-400">
                    <td class="px-4 py-2 text-right">---</td>
                    <td class="px-4 py-2 text-center">---</td>
                    <td class="px-4 py-2 text-right">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td class="px-4 py-2 text-center text-green-700">${formatCurrency(totalDebit)}</td>
                    <td class="px-4 py-2 text-center text-red-700">${formatCurrency(totalCredit)}</td>
                    <td class="px-4 py-2 text-center text-blue-900 text-lg">${formatCurrency(runningBalance)}</td>
                    <td class="px-4 py-2 text-center">---</td>
                </tr>`;
                
                html += '</tbody></table></div>';
                
                // ===== Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª =====
                html += `<div class="mt-6 grid grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div class="text-center">
                        <p class="text-gray-600 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ø¯ÙŠÙ†)</p>
                        <p class="text-2xl font-bold text-green-700">${formatCurrency(totalDebit)}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ø¯Ø§Ø¦Ù†)</p>
                        <p class="text-2xl font-bold text-red-700">${formatCurrency(totalCredit)}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600 text-sm">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
                        <p class="text-2xl font-bold ${runningBalance < 0 ? 'text-red-600' : 'text-blue-700'}">${formatCurrency(runningBalance)}</p>
                    </div>
                </div>`;
            }
            html += `</div>`; // Closing printable-statement-content
            html += `<div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
                        <button onclick="closeModal(document.getElementById('statement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Ø¥ØºÙ„Ø§Ù‚</button>
                        <button id="print-statement-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                           <i data-lucide="printer" class="w-5 h-5"></i>
                           <span>Ø·Ø¨Ø§Ø¹Ø©</span>
                        </button>
                    </div>`;
            html += '</div>';

            statementModal.innerHTML = html;
            
            // Add print functionality
            const printBtn = statementModal.querySelector('#print-statement-btn');
            if(printBtn) {
                printBtn.addEventListener('click', () => {
                    const contentToPrint = statementModal.querySelector('.printable-statement-content').innerHTML;
                    const w = window.open('', '', 'height=600,width=1000');
                    if (!w) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
                    w.document.open();
                    w.document.write('<html><head><title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨</title>');
                    w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
                    w.document.write('<style>body { font-family: \'Cairo\', sans-serif; direction: rtl; } @media print { .no-print { display: none; } }</style>');
                    w.document.write('</head><body>');
                    w.document.write(contentToPrint);
                    w.document.write('</body></html>');
                    w.document.close();
                    const doPrint = () => { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
                    const closeBack = () => { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
                    if ('onafterprint' in w) { w.onafterprint = closeBack; } else { setTimeout(closeBack, 1200); }
                    if ('onload' in w) { w.onload = () => setTimeout(doPrint, 100); } else { setTimeout(doPrint, 300); }
                });
            }

            openModal(statementModal);
            updateIcons();
        }

        // ===== INVOICE RECEIPT PRINTING (Unified 80mm thermal layout) =====
        function buildReceiptHtml58mm(sale){
            try {
            const customer = findCustomer(sale.customerId);
            const company = (state.settings && state.settings.companyName) ? state.settings.companyName : 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©';
            const logo = (state.settings && state.settings.companyLogo) ? state.settings.companyLogo : 'https://i.ibb.co/YT4114YW/image.jpg';
            const registry = (state.settings && (state.settings.companyRegistry||state.settings.commercialRegistry)) || '134175';
            const taxId   = (state.settings && (state.settings.companyTaxId||state.settings.taxCard)) || '762878835';
            const phone   = (state.settings && state.settings.companyPhone) || '01011121457';
            const email   = (state.settings && state.settings.companyEmail) || 'delentemilks@gmail.com';
            const repName = sale.repName || '';
                const dateStr = formatArabicDate(sale.date);
                const inv = sale.invoiceNumber || sale.id || '';
                const rows = (sale.items||[]).map(it => {
                    const p = findProduct(it.productId);
                    const name = p ? p.name : (it.name || 'Ù…Ù†ØªØ¬');
                    const qty = it.quantity || it.qty || 0;
                    const price = Number(it.price||0);
                    const total = qty * price * (1 - (it.discountPercent||0)/100);
                    return `<tr><td class="n">${escapeHtml(name)}</td><td class="q">${qty}</td><td class="t">${formatCurrency(total)}</td></tr>`;
                }).join('');
                const total = formatCurrency(sale.total||0);
                const paid = formatCurrency(sale.paidAmount||0);
                const remain = formatCurrency((sale.total||0) - (sale.paidAmount||0));
                const custName = customer ? customer.name : 'Ø¹Ù…ÙŠÙ„';
                const custPhone = customer ? (customer.phone||'') : '';
                const custTax = customer ? (customer.taxNumber||'') : '';

                const nowStr = new Date().toLocaleString('ar-EG', { hour12: true });
                return `<!doctype html><html lang="ar" dir="rtl"><head>
                    <meta charset="utf-8" />
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
                    <title>Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø©</title>
                    <style>
                        @page { size: 80mm auto; margin: 2mm; }
                        body { 
                            font-family: 'Cairo', sans-serif; 
                            direction: rtl; 
                            margin:0; 
                            padding:0; 
                            background:#fff;
                            -webkit-font-smoothing: antialiased;
                            -moz-osx-font-smoothing: grayscale;
                            text-rendering: optimizeLegibility;
                        }
                        .r { 
                            width: 80mm; 
                            max-width: 80mm; 
                            position: relative; 
                            padding: 3mm; 
                            border: 2px solid #222; 
                            box-sizing: border-box;
                            font-family: 'Cairo', sans-serif;
                        }
                        .center { text-align:center }
                        .h1 { font-weight:800; font-size:16px; }
                        .h2 { font-weight:700; font-size:14px; }
                        .row { display:flex; justify-content:space-between; font-size:12px }
                        table { width:100%; border-collapse:collapse; font-size:12px }
                        th { background:#f3f4f6; border:1px solid #e5e7eb; padding:3px; font-weight:700; font-size:12px }
                        td { padding:3px; border:1px solid #f1f5f9; font-size:12px; text-align:center }
                        td.n{ text-align:right; font-weight:600 }
                        td.q{ width:20%; }
                        td.t{ width:28%; text-align:left }
                        hr { border:none; border-top:1px dashed #000; margin:8px 0 }
                        .sep { border-top:1px dashed #000; height:0; margin:8px 0 }
                        .bold { font-weight:700 }
                        .small { font-size:12px }
                        .hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px }
                        .hdr .brand { display:flex; align-items:center; gap:8px; }
                        .hdr img { width: 12mm; height:auto }
                        .tag { font-size:11px; font-weight:600; line-height:1; opacity:.9; margin-top:-2px; }
                        .wm { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none }
                        .wm img { width:60mm; opacity:.06; }
                        .footer { font-size:11px; line-height:1.5; text-align:right }
                        .kv { display:flex; gap:10px; justify-content:space-between; font-size:12px; }
                        .kv .label{ color:#111; font-weight:600 }
                        .kv .value{ color:#111; }
                        .money-row{ display:flex; justify-content:space-between; align-items:center; font-size:13px }
                        .money-row .amt{ text-align:left; min-width:38mm }
                        .cur{ font-size:11px; margin-right:2px }
                    </style>
                                </head><body>
                  <div class="r">
                    <div class="wm">${logo ? `<img src="${logo}" />` : ''}</div>
                    <div class="hdr">
                        <div class="brand"><div><div class="h1">Delente</div><div class="tag">it is just milk</div></div></div>
                        ${logo ? `<img src="${logo}" alt="logo"/>` : ''}
                    </div>
                    <div class="center h2">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                    <div class="center small">${nowStr}</div>
                    <hr />
                    <div class="kv"><div class="value">${inv}</div><div class="label">: Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div></div>
                    <div class="kv"><div class="value"><bdo dir="rtl">${dateStr}</bdo></div><div class="label">: Ø§Ù„ØªØ§Ø±ÙŠØ®</div></div>
                    <div class="kv"><div class="value">${escapeHtml(custName)}</div><div class="label">: Ø§Ù„Ø¹Ù…ÙŠÙ„</div></div>
                    ${repName?`<div class="kv"><div class="value">${escapeHtml(repName)}</div><div class="label">: Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</div></div>`:''}
                    ${custPhone?`<div class="kv"><div class="value">${escapeHtml(custPhone)}</div><div class="label">: Ù‡Ø§ØªÙ</div></div>`:''}
                    ${custTax?`<div class="kv"><div class="value">${escapeHtml(custTax)}</div><div class="label">: Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ</div></div>`:''}
                    <hr />
                    <table><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody>${rows}</tbody></table>
                    <hr />
                    <div class="money-row bold"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="amt">${total} <span class="cur">Ø¬.Ù…</span></span></div>
                    <div class="money-row"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><span class="amt">${paid} <span class="cur">Ø¬.Ù…</span></span></div>
                    <div class="money-row"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span><span class="amt">${remain} <span class="cur">Ø¬.Ù…</span></span></div>
                    <hr />
                    <div class="footer">
                        <div>Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ: ${escapeHtml(String(registry))}</div>
                        <div>Ø¨Ø·Ø§Ù‚Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©: ${escapeHtml(String(taxId))}</div>
                        <div>Ù‡Ø§ØªÙ: ${escapeHtml(String(phone))}</div>
                        <div>E: ${escapeHtml(String(email))}</div>
                    </div>
                    <div class="center small" style="margin-top:4px">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</div>
                                    </div>
                                </body></html>`;
            } catch(e){ return '<html><body>Ø®Ø·Ø£ ÙÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙØ§ØªÙˆØ±Ø©</body></html>'; }
        }

        // Function for Green Button (Standard System Print with Thermal Paper Formatting)
        function printInvoice(invoice) {
            try {
                // 1. Open a popup for the receipt
                const printWindow = window.open('', '_blank', 'width=400,height=600');
                if (!printWindow) { alert('Please allow popups for printing'); return; }
                
                // 2. Build HTML with Thermal CSS (80mm / 78mm paper width)
                const doc = printWindow.document;
                doc.open();
                
                // Write DOCTYPE and basic structure
                doc.write('<!DOCTYPE html>');
                doc.write('<html lang="ar" dir="rtl">');
                doc.write('<head>');
                doc.write('<meta charset="utf-8" />');
                doc.write('<title>Invoice #' + (invoice.id || 'N/A') + '</title>');
                
                // Write CSS styles
                doc.write('<style>');
                doc.write('body { font-family: Tahoma, sans-serif; margin: 0; padding: 5px; width: 100%; max-width: 80mm; color: #000; direction: rtl; }');
                doc.write('.header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 5px; }');
                doc.write('.meta { text-align: center; font-size: 12px; margin-bottom: 10px; }');
                doc.write('.divider { border-top: 1px dashed #000; margin: 5px 0; }');
                doc.write('table { width: 100%; font-size: 12px; border-collapse: collapse; }');
                doc.write('th { text-align: right; border-bottom: 1px solid #000; padding: 3px 0; font-weight: bold; }');
                doc.write('td { text-align: right; padding: 2px 0; }');
                doc.write('td.qty { text-align: center; }');
                doc.write('td.total { text-align: left; }');
                doc.write('.total-box { border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 18px; margin-top: 10px; }');
                doc.write('.footer { text-align: center; margin-top: 15px; font-size: 10px; line-height: 1.6; }');
                doc.write('.small-text { font-size: 10px; }');
                doc.write('@media print { @page { margin: 0; size: auto; width: 80mm; } body { margin: 0; padding: 2px; } }');
                doc.write('</style>');
                
                doc.write('</head><body>');
                
                // Header
                doc.write('<div class="header">Invoice #' + (invoice.id || 'N/A') + '</div>');
                doc.write('<div class="meta">');
                doc.write('<div class="small-text">Date: ' + (invoice.date || 'Today') + '</div>');
                doc.write('<div class="small-text">Customer: <strong>' + (invoice.customerName || 'Cash') + '</strong></div>');
                doc.write('</div>');
                
                doc.write('<div class="divider"></div>');
                
                // Items table
                doc.write('<table>');
                doc.write('<thead><tr><th style="width: 50%;">Item</th><th style="width: 20%;" class="qty">Qty</th><th style="width: 30%;" class="total">Total</th></tr></thead>');
                doc.write('<tbody>');
                if (Array.isArray(invoice.items)) {
                    invoice.items.forEach(function(item) {
                        const total = formatCurrency ? formatCurrency(item.total || 0) : (item.total || 0);
                        doc.write('<tr>');
                        doc.write('<td>' + (item.name || 'Product') + '</td>');
                        doc.write('<td class="qty">' + (item.quantity || item.qty || 0) + '</td>');
                        doc.write('<td class="total">' + total + '</td>');
                        doc.write('</tr>');
                    });
                }
                doc.write('</tbody></table>');
                
                doc.write('<div class="divider"></div>');
                
                // Total box
                const totalAmount = formatCurrency ? formatCurrency(invoice.total || 0) : (invoice.total || 0);
                doc.write('<div class="total-box">TOTAL: ' + totalAmount + '</div>');
                
                doc.write('<div class="footer">');
                doc.write('<div>Thank you for your business</div>');
                doc.write('<div class="small-text">Generated by Smart System</div>');
                doc.write('</div>');
                
                doc.write('</body></html>');
                doc.close();
                
                // Trigger print after a brief delay
                setTimeout(function() {
                    try { printWindow.focus(); } catch(_){}
                    try { printWindow.print(); } catch(_){}
                }, 300);
                
            } catch(e) {
                console.warn('printInvoice error', e);
                alert('Error opening print preview: ' + (e && e.message || 'Unknown error'));
            }
        }
        window.printInvoice = printInvoice;

        window.printSaleById = async function(saleId){
            try {
                const sale = (state.sales||[]).find(s => String(s.id) === String(saleId));
                if (!sale) { alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©'); return; }
                
                // Show preview modal first
                await new Promise(resolve => {
                    showPrintPreviewModal(sale, () => resolve());
                });
                
                const html = buildReceiptHtml58mm(sale);
                const w = window.open('', '', 'width=420,height=640');
                if (!w) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

                // Write content and wait for load to avoid blocking/hangs
                w.document.open();
                w.document.write(html);
                w.document.close();

                const doPrint = () => {
                    try { w.focus(); } catch(_){}
                    try { w.print(); } catch(_){}
                };
                const closeAndReturn = () => {
                    // Close popup and restore focus to the app; also ensure pointer events are enabled
                    try { w.close(); } catch(_){}
                    try { window.focus(); } catch(_){}
                    try { document.body.style.pointerEvents = 'auto'; document.body.style.opacity = '1'; } catch(_){}
                };

                if ('onafterprint' in w) {
                    w.onafterprint = closeAndReturn;
                } else {
                    // Fallback: close after a short delay
                    setTimeout(closeAndReturn, 1200);
                }

                if ('onload' in w) {
                    w.onload = () => setTimeout(doPrint, 100);
                } else {
                    // Fallback if onload not firing
                    setTimeout(doPrint, 300);
                }
            } catch(e){ console.warn('printSaleById error', e); try { alert('ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©'); } catch(_){} }
        }
        
        // Print preview modal for both WiFi and Bluetooth printing
        function showPrintPreviewModal(sale, callback) {
            if (!document.getElementById('print-preview-modal')) {
                const modal = document.createElement('div');
                modal.id = 'print-preview-modal';
                modal.style.position = 'fixed';
                modal.style.inset = '0';
                modal.style.zIndex = '50000';
                modal.style.display = 'none';
                modal.style.background = 'rgba(0,0,0,0.5)';
                
                const content = document.createElement('div');
                content.style.position = 'absolute';
                content.style.top = '50%';
                content.style.left = '50%';
                content.style.transform = 'translate(-50%, -50%)';
                content.style.background = '#fff';
                content.style.borderRadius = '10px';
                content.style.padding = '20px';
                content.style.maxHeight = '90vh';
                content.style.overflow = 'auto';
                content.style.maxWidth = '600px';
                content.style.width = '90%';
                content.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                
                content.innerHTML = `
                    <h2 style="text-align:center;margin-bottom:20px;font-size:20px;font-weight:bold;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h2>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;margin-bottom:8px;font-weight:bold;">Ø­Ø¬Ù… Ø§Ù„ÙˆØ±Ù‚Ø©:</label>
                        <select id="paper-size-select" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
                            <option value="80mm" selected>80mm (Ø­Ø±Ø§Ø±ÙŠ - Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                            <option value="58mm">58mm</option>
                            <option value="A4">A4 (21 Ø³Ù…)</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;margin-bottom:8px;font-weight:bold;">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ±Ù‚Ø©:</label>
                        <select id="paper-orientation-select" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
                            <option value="portrait">Ø¹Ù…ÙˆØ¯ÙŠ</option>
                            <option value="landscape">Ø£ÙÙ‚ÙŠ</option>
                        </select>
                    </div>
                    
                    <div id="print-preview-container" style="border:2px solid #3b82f6;padding:15px;margin-bottom:20px;background:#f9f9f9;max-height:420px;overflow:auto;border-radius:6px;">
                        <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù‡Ù†Ø§ -->
                    </div>
                    
                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                        <button id="print-confirm-btn" style="background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:15px;">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†</button>
                        <button id="print-cancel-btn" style="background:#e5e7eb;color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:15px;">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
            }
            
            const modal = document.getElementById('print-preview-modal');
            const previewContainer = document.getElementById('print-preview-container');
            
            // Generate receipt preview using the exact 80mm template
            try {
                const htmlDoc = (typeof buildReceiptHtml58mm === 'function') ? buildReceiptHtml58mm(sale) : '';
                const temp = document.createElement('div');
                temp.innerHTML = htmlDoc;
                const styleFromDoc = temp.querySelector('style');
                if (styleFromDoc) {
                    const s = document.createElement('style');
                    s.textContent = styleFromDoc.textContent;
                    previewContainer.appendChild(s);
                }
                const r = temp.querySelector('.r');
                if (r) {
                    // Scale preview to fit modal area
                    r.style.margin = '0 auto';
                    r.style.transformOrigin = 'top center';
                    r.style.transform = 'scale(0.75)';
                    previewContainer.appendChild(r);
                } else {
                    previewContainer.innerHTML = '<div style="text-align:center;color:#dc2626">ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</div>';
                }
            } catch(e){
                previewContainer.innerHTML = '<div style="text-align:center;color:#dc2626">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</div>';
            }
            
            // Setup buttons
            document.getElementById('print-confirm-btn').onclick = () => {
                modal.style.display = 'none';
                if (callback) callback();
            };
            
            document.getElementById('print-cancel-btn').onclick = () => {
                modal.style.display = 'none';
            };
            
            modal.style.display = 'block';
        }

        // (ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØµØ±Ø© Ø­Ø³Ø¨ Ø·Ù„Ø¨ÙƒØ› ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)

        // Optional: Share as image via Web Share on Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
        window.shareSaleReceiptImage = async function(saleId){
            try {
                const sale = (state.sales||[]).find(s => String(s.id) === String(saleId));
                if (!sale) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
                // Build a temporary DOM node for rendering
                const temp = document.createElement('div');
                temp.style.position = 'fixed';
                temp.style.left = '-10000px';
                temp.style.top = '0';
                temp.style.width = '384px'; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø£Ù†Ø¸Ù */
                temp.style.background = '#ffffff';
                temp.style.padding = '0';
                temp.style.margin = '0';
                temp.innerHTML = buildReceiptHtml58mm(sale);
                // Ø¶Ø¨Ø· Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                const root = temp.querySelector('.r');
                if (root) {
                    root.style.width = '384px';
                    root.style.maxWidth = '384px';
                }
                document.body.appendChild(temp);
                const target = root || temp;
                // Ø±ÙØ¹ Ø§Ù„Ø¯Ù‚Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙ…ÙˆØ¬ ÙˆØ§Ù„ØªØ´ÙˆÙ‡
                const canvas = await html2canvas(target, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                const file = new File([blob], `invoice-${sale.invoiceNumber||sale.id}.png`, { type: 'image/png' });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    // Ø§Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø¨Ø³Ø±Ø¹Ø© Ù„Ø¶Ù…Ø§Ù† user gesture Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ share
                    const confirmed = await (typeof customDialog === 'function'
                        ? customDialog({ title: 'Ø§Ù„ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø©', message: 'Ø§Ø¶ØºØ· "Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¢Ù†" Ù„ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.', isConfirm: true, confirmText: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¢Ù†', confirmClass: 'bg-indigo-600 hover:bg-indigo-700' })
                        : Promise.resolve(true));
                    if (confirmed) {
                        try {
                            await navigator.share({ files:[file] });
                        } catch(shareErr) {
                            console.warn('navigator.share failed, falling back', shareErr);
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a'); a.href = url; a.download = file.name; a.click(); URL.revokeObjectURL(url);
                            alert('ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.');
                        }
                    }
                } else {
                    // Fallback: download so it can be opened Ø¨Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (RawBT/Xprinter)
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = file.name; a.click(); URL.revokeObjectURL(url);
                    alert('ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©. Ø§ÙØªØ­Ù‡Ø§ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.');
                }
                try { temp.remove(); } catch(_){}
            } catch(e){ console.warn('shareSaleReceiptImage failed', e); alert('ØªØ¹Ø°Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©'); }
        }

        // Upload single sale to ETA via Netlify function
        window.uploadSaleToEta = async function(saleId){
            try {
                const sale = (state.sales||[]).find(s => String(s.id) === String(saleId));
                if (!sale) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
                if (sale.taxUploadStatus === 'uploaded') {
                    if (!confirm('Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ÙØ¹ØŸ')) return;
                }
                const invoice = transformSaleToEtaInvoice(sale);
                const resp = await fetch('/.netlify/functions/eta-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice })
                });
                let data = null;
                try { data = await resp.json(); } catch(_) { /* text fallback */ }
                if (resp.ok && data && data.accepted) {
                    sale.taxUploadStatus = 'uploaded';
                    sale.taxSubmissionUUID = data.submissionUUID || null;
                    sale.etaStatus = 'submitted';
                    sale.etaLastCheckAt = new Date().toISOString();
                    sale.etaErrors = [];
                    try { saveState(); } catch(_){ }
                    renderAllSales();
                    // Log successful submission to `einvoice_logs` for reporting
                    try {
                        if (window.db) {
                            await db.collection('einvoice_logs').add({
                                invoice_number: sale.invoiceNumber || sale.invoice_number || null,
                                uuid: data.submissionUUID || data.submissionUUID || null,
                                status: 'Valid',
                                submission_date: new Date().toISOString(),
                                total: Number(sale.total || 0),
                                createdAt: serverTs()
                            });
                        }
                    } catch(logErr) { console.warn('Failed to write einvoice_logs:', logErr); }

                    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆÙ‚Ø¨ÙˆÙ„Ù‡Ø§ Ø£ÙˆÙ„ÙŠØ§Ù‹ (202). ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©.');
                } else {
                    const txt = (data && data.raw) ? JSON.stringify(data.raw) : await resp.text();
                    sale.taxUploadStatus = 'error';
                    sale.etaStatus = 'error';
                    sale.etaErrors = [txt.slice(0,300)];
                    sale.etaLastCheckAt = new Date().toISOString();
                    try { saveState(); } catch(_){ }
                    renderAllSales();
                    alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + txt);
                }
            } catch(e){ console.warn('uploadSaleToEta error', e); alert('ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©.'); }
        }

        // Load E-Invoice logs and tab wiring
        function escapeHtml(str){
            if (!str && str !== 0) return '';
            return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
        }

        async function loadEinvoiceLogs(){
            try {
                if (!window.db) return;
                const body = document.getElementById('einvoice-log-table-body');
                if (!body) return;
                body.innerHTML = '';
                const snap = await db.collection('einvoice_logs').orderBy('submission_date','desc').limit(200).get();
                snap.forEach(doc => {
                    const d = doc.data() || {};
                    const invoiceNo = escapeHtml(d.invoice_number || '');
                    const date = d.submission_date ? (new Date(d.submission_date)).toLocaleString() : '';
                    const customer = escapeHtml(d.customerName || '');
                    const total = Number(d.total || 0).toFixed(2);
                    const uuid = escapeHtml(d.uuid || '');
                    const status = escapeHtml(d.status || '');
                    const row = `<tr class="text-sm text-gray-700"><td class="p-2">${invoiceNo}</td><td class="p-2">${date}</td><td class="p-2">${customer}</td><td class="p-2 text-right">${total}</td><td class="p-2">${uuid}</td><td class="p-2">${status}</td></tr>`;
                    body.insertAdjacentHTML('beforeend', row);
                });
            } catch(e) { console.warn('loadEinvoiceLogs failed', e); }
        }

        document.addEventListener('DOMContentLoaded', function(){
            try {
                const rptBtn = document.getElementById('tax-tab-report');
                const einBtn = document.getElementById('tax-tab-einvoices');
                if (rptBtn && einBtn) {
                    rptBtn.addEventListener('click', function(){
                        document.getElementById('tax-report-tab').style.display = '';
                        document.getElementById('tax-einvoices-tab').style.display = 'none';
                        rptBtn.classList.add('bg-gray-100'); einBtn.classList.remove('bg-gray-100');
                    });
                    einBtn.addEventListener('click', async function(){
                        document.getElementById('tax-report-tab').style.display = 'none';
                        document.getElementById('tax-einvoices-tab').style.display = '';
                        rptBtn.classList.remove('bg-gray-100'); einBtn.classList.add('bg-gray-100');
                        await loadEinvoiceLogs();
                    });
                }
            } catch(e){ console.warn('tax tabs wiring failed', e); }
        });

        // --- PROMOTION MODAL FUNCTION ---
        function openPromotionModal(id = null) {
            promotionForm.reset();
            document.getElementById('promotion-id').value = '';
            populateProductDropdown(document.getElementById('promotion-product'));
            // Use a specific version for the customer dropdown in promotions to include "All Customers"
            const customerSelect = document.getElementById('promotion-customer-id');
            customerSelect.innerHTML = '<option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ --</option>' + state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            document.getElementById('original-price-display').classList.add('hidden');

            if (id) {
                // Edit mode
                const promotion = state.promotions.find(p => p.id === id);
                if (promotion) {
                    document.getElementById('promotion-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶';
                    document.getElementById('promotion-id').value = promotion.id;
                    document.getElementById('promotion-name').value = promotion.name;
                    document.getElementById('promotion-product').value = promotion.productId;
                    document.getElementById('promotion-price').value = promotion.price;
                    customerSelect.value = promotion.customerId || '';
                    document.getElementById('promotion-start-date').value = promotion.startDate;
                    document.getElementById('promotion-end-date').value = promotion.endDate;
                    updatePromotionOriginalPriceDisplay(promotion.productId);
                }
            } else {
                // Add mode
                document.getElementById('promotion-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯';
                // Set default dates
                document.getElementById('promotion-start-date').value = new Date().toISOString().split('T')[0];
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                document.getElementById('promotion-end-date').value = nextMonth.toISOString().split('T')[0];
            }

            openModal(promotionModal);
        }

        // --- BACKUP & RESTORE FUNCTIONS ---
        function copyTextToClipboard(text) {
            if (!text) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    customDialog({ title: 'Ù†Ø³Ø®', message: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.' });
                }).catch(() => {
                    // fallback
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); customDialog({ title: 'Ù†Ø³Ø®', message: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.' }); } catch (e) { customDialog({ title: 'Ø®Ø·Ø£', message: 'ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯.' }); }
                    ta.remove();
                });
            } else {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); customDialog({ title: 'Ù†Ø³Ø®', message: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.' }); } catch (e) { customDialog({ title: 'Ø®Ø·Ø£', message: 'ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯.' }); }
                ta.remove();
            }
        }

        function createBackup() {
            try {
                const backupTextarea = document.getElementById('backup-data-textarea');
                const copyBtn = document.getElementById('copy-backup-btn');
                const payload = JSON.stringify(state);
                if (backupTextarea) backupTextarea.value = payload;

        
                if (copyBtn) copyBtn.classList.remove('hidden');

                // Also store a timestamped backup in localStorage_backups
                try {
                    const backupsRaw = localStorage.getItem('mandoobiAppState_backups');
                    const backups = backupsRaw ? JSON.parse(backupsRaw) : [];
                    backups.unshift({ ts: new Date().toISOString(), data: state });
                    // Keep only recent 12 backups
                    while (backups.length > 12) backups.pop();
                    localStorage.setItem('mandoobiAppState_backups', JSON.stringify(backups));
                } catch (e) {
                    console.warn('Failed to save local backup list', e);
                }

                customDialog({ title: 'Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.' });
            } catch (e) {
                console.error('createBackup failed', e);
                customDialog({ title: 'Ø®Ø·Ø£', message: 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.' });
            }
        }

        // --- LOCAL-STATE DEBUG & RESTORE PANEL (shows when state is empty) ---
        function showLocalStateDebug() {
            if (document.getElementById('app-local-debug')) return; // already present

            try {
                const panel = document.createElement('div');
                panel.id = 'app-local-debug';
                panel.style.position = 'fixed';
                panel.style.right = '18px';
                panel.style.bottom = '18px';
                panel.style.width = '360px';
                panel.style.maxHeight = '60vh';
                panel.style.overflow = 'auto';
                panel.style.zIndex = '99999';
                panel.style.background = 'linear-gradient(180deg,#fff, #fbfaf8)';
                panel.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
                panel.style.borderRadius = '8px';
                panel.style.padding = '12px';
                panel.style.fontSize = '13px';
                panel.style.direction = 'rtl';
                panel.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <strong style="font-size:14px">ØªØ´Ø®ÙŠØµ ÙˆØ§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</strong>
                        <button id="close-local-debug" style="background:#eee;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                    <div style="font-size:12px;color:#444;margin-bottom:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± <code>file://</code>ØŒ ÙØ¥Ù† Ø§Ù„Ù€localStorage Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„ÙØ› Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ù‚Ø¯ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ø§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¯Ù†Ø§Ù‡ Ø«Ù… Ø§Ø¶ØºØ· Ø§Ø³ØªØ±Ø¬Ø§Ø¹.</div>
                    <div style="margin-bottom:8px">
                        <div id="local-state-keys" style="background:#fff;padding:8px;border:1px solid #eee;border-radius:6px;max-height:120px;overflow:auto"></div>
                    </div>
                    <div style="margin-bottom:8px">
                        <textarea id="local-state-restore" placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ JSON ÙƒØ§Ù…Ù„ Ù„Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ø§Ù„: Ù…Ø­ØªÙˆÙ‰ mandoobiAppState)" style="width:100%;height:120px;border:1px solid #ddd;padding:8px;border-radius:6px;font-size:12px"></textarea>
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-start">
                        <button id="restore-state-btn" style="background:#1f7bd7;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©</button>
                        <button id="download-backups-btn" style="background:#6b7280;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                        <button id="open-storage-btn" style="background:#10b981;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">Ø¹Ø±Ø¶ ÙÙŠ Console</button>
                    </div>
                    <div id="local-state-msg" style="margin-top:8px;font-size:12px;color:#444"></div>
                `;

                document.body.appendChild(panel);

                // Populate keys/preview
                const keysEl = document.getElementById('local-state-keys');
                try {
                    const keys = Object.keys(localStorage).filter(k => k.includes('mandoobiAppState') || k.includes('mandoobi'));
                    if (keys.length === 0) {
                        keysEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ§ØªÙŠØ­ Ù…Ø­Ù„ÙŠØ© Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ localStorage Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.';
                    } else {
                        keys.forEach(k => {
                            const raw = localStorage.getItem(k);
                            let preview = '';
                            try { const parsed = JSON.parse(raw); if (Array.isArray(parsed.sales)) { preview = `sales:${parsed.sales.length}`; } else if (parsed && parsed.sales) { preview = `sales:${(parsed.sales && parsed.sales.length) || 'ØŸ'}`; } else preview = raw ? raw.toString().slice(0,200) : 'empty'; } catch (e) { preview = raw ? raw.toString().slice(0,200) : 'empty'; }
                            const row = document.createElement('div');
                            row.style.padding = '6px 0';
                            row.style.borderBottom = '1px dashed #f0f0f0';
                            row.innerHTML = `<div style="font-weight:600;margin-bottom:4px">${k}</div><div style='font-size:12px;color:#666'>${preview}</div>`;
                            keysEl.appendChild(row);
                        });
                    }
                } catch (e) { keysEl.textContent = 'ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© localStorage: ' + (e.message || e); }

                document.getElementById('close-local-debug').addEventListener('click', () => panel.remove());

                document.getElementById('open-storage-btn').addEventListener('click', () => {
                    console.log('LocalStorage keys for this origin:');
                    Object.keys(localStorage).forEach(k => console.log(k, localStorage.getItem(k)));
                    const msg = document.getElementById('local-state-msg'); if (msg) msg.textContent = 'ØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Console. Ø§ÙØªØ­ DevTools -> Console.';
                });

                document.getElementById('download-backups-btn').addEventListener('click', () => {
                    try {
                        const raw = localStorage.getItem('mandoobiAppState_backups');
                        if (!raw) { document.getElementById('local-state-msg').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©.'; return; }
                        const a = document.createElement('a');
                        const blob = new Blob([raw], { type: 'application/json' });
                        a.href = URL.createObjectURL(blob);
                        a.download = 'mandoobiAppState_backups.json';
                        a.click();
                        document.getElementById('local-state-msg').textContent = 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.';
                    } catch (e) { document.getElementById('local-state-msg').textContent = 'ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ' + (e.message || e); }
                });

                document.getElementById('restore-state-btn').addEventListener('click', () => {
                    const ta = document.getElementById('local-state-restore');
                    const msg = document.getElementById('local-state-msg');
                    if (!ta || !ta.value.trim()) { if (msg) msg.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ JSON ØµØ§Ù„Ø­ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¹Ù„Ø§Ù‡.'; return; }
                    try {
                        const parsed = JSON.parse(ta.value);
                        localStorage.setItem('mandoobiAppState', JSON.stringify(parsed));
                        if (msg) msg.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.';
                        setTimeout(() => location.reload(), 800);
                    } catch (e) {
                        if (msg) msg.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© JSON: ' + (e.message || e);
                    }
                });

            } catch (e) {
                console.warn('showLocalStateDebug failed', e);
            }
        }

        async function restoreBackup() {
            try {
                const raw = document.getElementById('restore-data-textarea')?.value || '';
                if (!raw) {
                    await customDialog({ title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ ÙƒÙˆØ¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ØµØµ.' });
                    return;
                }

                let parsed;
                try { parsed = JSON.parse(raw); } catch (e) { parsed = null; }
                if (!parsed) {
                    await customDialog({ title: 'Ø®Ø·Ø£', message: 'ÙƒÙˆØ¯ Ø§Ù„Ù†Ø³Ø®Ø© ØºÙŠØ± ØµØ§Ù„Ø­. ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ§Ù…Ù„Ø§Ù‹.' });
                    return;
                }

                const confirmed = await customDialog({ title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', message: 'Ø³ØªÙØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªÙŠ Ø£Ù„ØµÙ‚ØªÙ‡Ø§. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ', isConfirm: true, confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø¢Ù†', confirmClass: 'bg-red-600 hover:bg-red-700' });
                if (!confirmed) return;

                state = parsed;
                saveState();
                renderAll();
                await customDialog({ title: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©', message: 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù„ØµÙˆÙ‚Ø©.' });
            } catch (e) {
                console.error('restoreBackup failed', e);
                await customDialog({ title: 'Ø®Ø·Ø£', message: 'ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙƒÙˆØ¯ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' });
            }
        }

        
        // --- All Function Definitions END ---

        // ================================================================
        // ===== INITIALIZATION AND AUTHENTICATION ======================
        // ================================================================

        // --- Firebase Initialization (Compat) ---
        // No firebaseConfig is embedded here. Provide `window.firebaseConfig` before loading this file.
        // When you create the project, add a small inline script before this file that sets `window.firebaseConfig = {...}`
        // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù‡Ù†Ø§. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ­Ø¯Ø« ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± initFirebase().
        // Ø¥Ø¨Ù‚Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ù„ØªÙˆØ¶ÙŠØ­ ÙÙ‚Ø·.

        // Ensure UI is not accidentally blocked by visible modals/overlays and attach listeners on DOM ready.
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Hide any modals that may be visible due to previous state
                document.querySelectorAll('.modal').forEach(m => {
                    try {
                        m.classList.remove('modal-visible');
                        m.classList.add('modal-hidden');
                    } catch (e) {}
                });

                // Ensure loading modal is hidden
                const lm = document.getElementById('loading-modal');
                if (lm) { lm.classList.remove('modal-visible'); lm.classList.add('modal-hidden'); }

                // Make sure the app container accepts pointer events
                const app = document.getElementById('app-container');
                if (app) app.style.pointerEvents = 'auto';

                // Attach event listeners even when auth is not present (file:// offline case)
                try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed on DOMContentLoaded', e); }

                // Small wiring for Costs unified grid controls (refresh, export buttons etc.)
                try {
                    const refreshBtn = document.getElementById('unified-refresh-btn');
                    if (refreshBtn) refreshBtn.addEventListener('click', () => { try { renderUnifiedPriceGrid(); } catch(e){} });
                    const exportJsonBtn = document.getElementById('unified-export-json-btn');
                    if (exportJsonBtn) exportJsonBtn.addEventListener('click', async () => {
                        try {
                            const payload = JSON.stringify(state.products || [], null, 2);
                            const blob = new Blob([payload], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a'); a.href = url; a.download = 'products-prices.json'; a.click(); URL.revokeObjectURL(url);
                        } catch (e) { console.warn('export unified json failed', e); }
                    });

                    const exportCsvBtn = document.getElementById('unified-export-csv-btn');
                    if (exportCsvBtn) exportCsvBtn.addEventListener('click', () => {
                        try {
                            const category = document.getElementById('unified-category-filter')?.value || 'all';
                            const products = Array.isArray(state.products) ? state.products.slice() : [];
                            const rows = products.filter(p => {
                                if (category === 'all') return true;
                                if (category === 'raw') return String(p.category||'').toLowerCase().includes('raw');
                                if (category === 'packaging') return String(p.category||'').toLowerCase().includes('packag');
                                if (category === 'finished') return !(String(p.category||'').toLowerCase().includes('raw') || String(p.category||'').toLowerCase().includes('packag'));
                                if (category === 'operation') return (p.operationCost !== undefined);
                                return true;
                            }).map(p => ({ id: p.id||'', name: p.name||'', category: p.category||'', price: p.price||'', cost: p.cost||'', operationCost: p.operationCost||'' }));
                            const headers = ['id','name','category','price','cost','operationCost'];
                            const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => '"' + String(r[h]||'').replace(/"/g,'""') + '"').join(','))).join('\n');
                            const blob = new Blob([csv], { type: 'text/csv' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a'); a.href = url; a.download = 'products-prices.csv'; a.click(); URL.revokeObjectURL(url);
                        } catch (e) { console.warn('export unified csv failed', e); }
                    });
                } catch (e) { console.warn('unified grid controls bind failed', e); }

                // Small safety: if page-debts is active, trigger a render to populate rows
                setTimeout(() => {
                    try { if (document.getElementById('page-debts')?.classList.contains('active')) renderDebts(); } catch (e) {}
                }, 80);
            } catch (e) { console.warn('Startup cleanup failed', e); }
        });

        // --- Loading Functions ---
        function showLoading(message = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...") {
            document.getElementById('loading-message').textContent = message;
            openModal(loadingModal);
        }
        function hideLoading() {
            closeModal(loadingModal);
        }

        // --- Event Listener Setup ---
        let eventListenersAttached = false;
        function setupAllEventListeners() {
            if (eventListenersAttached) return;
            console.log("Attaching event listeners for the first time...");

            // Navigation
            setupNavigationHandlers();

            // Dashboard
            document.getElementById('dashboard-rep-filter').addEventListener('change', renderDashboard);


            // Sales Page - Monthly Calendar Selector
            const salesMonthSelector = document.getElementById('sales-month-selector');
            
            function updateMonthDisplay(){
                // Month display removed from UI, but still tracking for filtering
                if(!state.activePeriod) return;
                // activePeriod is now auto-applied on change
            }
            
            if(salesMonthSelector){
                // Set default to current month
                const now = new Date();
                const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
                salesMonthSelector.value = currentMonth;
                
                // Apply month filter immediately on change
                salesMonthSelector.addEventListener('change', () => {
                    if(!state) state = {};
                    state.activePeriod = salesMonthSelector.value ? salesMonthSelector.value : null;
                    salesSearchHandler();
                });
            }
            
            // Sales Page
            const searchSalesDateInput = document.getElementById('search-sales-date');
            const clearSalesDateBtn = document.getElementById('clear-sales-date-btn');
            const salesSearchHandler = () => {
                const textFilter = document.getElementById('search-sales-text').value;
                const dateFilter = searchSalesDateInput.value;
                const taxStatusFilter = document.getElementById('tax-status-filter').value;
                const reviewFilter = document.getElementById('review-status-filter')?.value || 'all';
                clearSalesDateBtn.classList.toggle('hidden', !dateFilter);
                renderAllSales(textFilter, dateFilter, taxStatusFilter, reviewFilter);
            };
            document.getElementById('search-sales-text').addEventListener('input', salesSearchHandler);
            searchSalesDateInput.addEventListener('input', salesSearchHandler);
            document.getElementById('tax-status-filter').addEventListener('change', salesSearchHandler);
            document.getElementById('review-status-filter').addEventListener('change', salesSearchHandler);
            clearSalesDateBtn.addEventListener('click', () => {
                searchSalesDateInput.value = '';
                salesSearchHandler();
            });

            // Total Bills Page
            document.getElementById('apply-filters-btn').addEventListener('click', () => renderTotalBills());
            const resetToCurrentMonthBtn = document.getElementById('reset-to-current-month-btn');
            if (resetToCurrentMonthBtn) {
                resetToCurrentMonthBtn.addEventListener('click', () => {
                    setCurrentMonthDates();
                    renderTotalBills();
                });
            }
            // Debts Page - apply filters button (added)
            const applyDebtsBtn = document.getElementById('apply-debts-filters-btn');
            if (applyDebtsBtn) applyDebtsBtn.addEventListener('click', () => renderDebts());
            
            // Add event listener for "Show Unpaid Only" checkbox
            const hidePaidCheckbox = document.getElementById('hide-paid-debts');
            if (hidePaidCheckbox) {
                hidePaidCheckbox.addEventListener('change', () => {
                    // Save state to localStorage
                    localStorage.setItem('debts_hidePaid', hidePaidCheckbox.checked);
                    renderDebts();
                });
                // Restore saved state from localStorage
                const savedState = localStorage.getItem('debts_hidePaid');
                if (savedState !== null) {
                    hidePaidCheckbox.checked = savedState === 'true';
                }
            }
            
            let currentSort = { key: 'date', direction: 'desc' };
            // Highlight handler for Total Bills table
            document.getElementById('total-bills-table-body').addEventListener('click', (e) => {
                const cell = e.target.closest('.invoice-cell');
                if (cell) {
                    const saleId = cell.dataset.id;
                    if (saleId) {
                        toggleReviewColor(saleId, cell);
                    }
                }
            });

            document.getElementById('total-bills-table').querySelector('thead').addEventListener('click', (e) => {
                const header = e.target.closest('th[data-sort]');
                if (!header) return;

                const sortKey = header.dataset.sort;
                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'desc';
                }
                renderTotalBills(currentSort.key, currentSort.direction);
            });

            const selectAllCheckbox = document.getElementById('select-all-total-bills');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    document.querySelectorAll('#total-bills-table-body input.total-bill-row-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                });
            }

            // Stock Control Page
            const stockControlDateEl = document.getElementById('stock-control-date');
            if (stockControlDateEl) stockControlDateEl.addEventListener('change', renderStockLedger);
            const saveStockControlBtnEl = document.getElementById('save-stock-control-btn');
            if (saveStockControlBtnEl) saveStockControlBtnEl.addEventListener('click', saveStockBalances);

            // Finished Products Page (using the same rendering as stock-control)
            const finishedProductsDateEl = document.getElementById('finished-products-date');
            if (finishedProductsDateEl) {
                finishedProductsDateEl.addEventListener('change', () => {
                    try { if (typeof window.installStockEntriesListenerForDate === 'function') window.installStockEntriesListenerForDate(finishedProductsDateEl.value); } catch(_){}
                    renderStockLedgerForFinishedProducts();
                });
                // Initial render + subscribe to this date's live doc
                try { if (typeof window.installStockEntriesListenerForDate === 'function') window.installStockEntriesListenerForDate(finishedProductsDateEl.value); } catch(_){}
                renderStockLedgerForFinishedProducts();
            }
            const saveFinishedProductsBtn = document.getElementById('save-finished-products-btn');
            if (saveFinishedProductsBtn) {
                saveFinishedProductsBtn.addEventListener('click', saveStockBalancesForFinishedProducts);
            }

            // Sale Modal Form
            saleForm.addEventListener('submit', saveSale);
            document.getElementById('cancel-sale-btn').addEventListener('click', () => closeModal(saleModal));
            document.getElementById('add-sale-item-btn').addEventListener('click', () => addSaleItemRow());
            document.getElementById('sale-status').addEventListener('change', updateSaleSummary);
            document.getElementById('sale-discount').addEventListener('input', updateSaleSummary);

            // Other page listeners...
            document.getElementById('search-customers').addEventListener('input', (e) => renderCustomers(e.target.value));
            initializeChainsDisplay(); // Initialize chains display on page load
            document.getElementById('search-products').addEventListener('input', (e) => renderSettings(e.target.value));
            document.getElementById('spreadsheet-save-all-btn').addEventListener('click', saveAllSpreadsheetEntries);
            document.getElementById('spreadsheet-add-row-btn').addEventListener('click', addSpreadsheetRow);
            // Compute next invoice number for a rep by querying Firestore (repId).
            // Do NOT rely on local `state` for this decision â€” query the canonical `invoices` collection.
            async function getNextInvoiceNumber(repId){
                try {
                    if (!repId) return null;
                    if (window.db && typeof db !== 'undefined') {
                        try {
                            const q = await db.collection('invoices')
                                .where('repId', '==', String(repId))
                                .orderBy('invoiceNumber', 'desc')
                                .limit(1)
                                .get();
                            if (!q.empty) {
                                const d = q.docs[0].data();
                                const inv = Number(d && d.invoiceNumber) || 0;
                                if (inv > 0) return inv + 1;
                            }
                        } catch (e) {
                            console.warn('getNextInvoiceNumber: firestore query failed', e);
                        }
                    } else {
                        console.warn('getNextInvoiceNumber: no db available');
                    }
                } catch (e) { console.warn('getNextInvoiceNumber failed', e); }
                // Default to 1 only if no invoices exist for this rep
                return 1;
            }

            // When user types a unified invoice number, populate rows
            unifiedInvoiceNumberInput.addEventListener('input', (e) => {
                const unifiedNumber = e.target.value.trim();
                spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                    const invoiceInput = row.querySelector('.spreadsheet-invoice-number');
                    if (invoiceInput) invoiceInput.value = unifiedNumber;
                });
            });

            // When rep selection changes, query cloud for the last invoice (by repId) and prefill
            try {
                if (spreadsheetRepSelect) {
                    spreadsheetRepSelect.addEventListener('change', async (ev) => {
                        try {
                            const repNameOrId = ev.target.value;
                            if (!repNameOrId) { unifiedInvoiceNumberInput.value = ''; return; }
                            // Resolve rep id from state (dropdown contains names in many cases)
                            const rep = (state.reps||[]).find(r => r.id === repNameOrId || r.name === repNameOrId);
                            if (!rep || !rep.id) {
                                unifiedInvoiceNumberInput.value = '';
                                return;
                            }

                            // Prefer nextInvoiceNumber from the rep profile when available
                            if (rep.nextInvoiceNumber != null && rep.nextInvoiceNumber !== '') {
                                unifiedInvoiceNumberInput.value = String(rep.nextInvoiceNumber);
                                // fill rows incrementally starting from rep.nextInvoiceNumber
                                let offset = 0;
                                spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                                    const invoiceInput = row.querySelector('.spreadsheet-invoice-number');
                                    if (invoiceInput && !invoiceInput.value) {
                                        invoiceInput.value = String(Number(rep.nextInvoiceNumber) + offset);
                                        offset++;
                                    }
                                });
                                return;
                            }

                            // Fallback: query cloud for canonical last invoice
                            const next = await getNextInvoiceNumber(rep.id);
                            if (next != null) {
                                unifiedInvoiceNumberInput.value = String(next);
                                // fill rows with incrementing invoice numbers if they are empty
                                let offset = 0;
                                spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                                    const invoiceInput = row.querySelector('.spreadsheet-invoice-number');
                                    if (invoiceInput && !invoiceInput.value) {
                                        invoiceInput.value = String(next + offset);
                                        offset++;
                                    }
                                });
                            }
                        } catch(e){ console.warn('spreadsheet rep change handler failed', e); }
                    });
                    // If a rep is already selected on load, attempt to prefill from cloud
                    (async function(){
                        try {
                            const cur = spreadsheetRepSelect.value;
                            if (cur) {
                                const rep = (state.reps||[]).find(r => r.id === cur || r.name === cur);
                                if (rep && rep.id) {
                                    if (rep.nextInvoiceNumber != null && rep.nextInvoiceNumber !== '') {
                                        unifiedInvoiceNumberInput.value = String(rep.nextInvoiceNumber);
                                    } else {
                                        const n = await getNextInvoiceNumber(rep.id);
                                        if (n != null) unifiedInvoiceNumberInput.value = String(n);
                                    }
                                }
                            }
                        } catch(_){ }
                    })();
                }
            } catch(e){ console.warn('bind spreadsheetRepSelect failed', e); }

            // Settings: products & price-lists handlers
            const addProductBtn = document.getElementById('add-product-btn');
            if (addProductBtn) addProductBtn.addEventListener('click', () => openProductModal());
            const addPriceListBtn = document.getElementById('add-price-list-btn');
            if (addPriceListBtn) addPriceListBtn.addEventListener('click', () => openPriceListModal());

            // Product / Price list forms
            if (productForm) productForm.addEventListener('submit', saveProduct);
            const cancelProductBtn = document.getElementById('cancel-product-btn');
            if (cancelProductBtn) cancelProductBtn.addEventListener('click', () => closeModal(productModal));

            if (priceListForm) priceListForm.addEventListener('submit', savePriceList);
            const cancelPriceListBtn = document.getElementById('cancel-price-list-btn');
            if (cancelPriceListBtn) cancelPriceListBtn.addEventListener('click', () => closeModal(priceListModal));

            // ===== Stock Control: Add Product Buttons and Forms =====
            const addFinishedProductBtn = document.getElementById('add-finished-product-btn');
            if (addFinishedProductBtn) {
                addFinishedProductBtn.addEventListener('click', () => {
                    document.getElementById('modal-add-finished-product').classList.remove('hidden');
                });
            }
            
            const addRawMaterialBtn = document.getElementById('add-raw-material-btn');
            if (addRawMaterialBtn) {
                addRawMaterialBtn.addEventListener('click', () => {
                    document.getElementById('modal-add-raw-material').classList.remove('hidden');
                });
            }
            
            const addPackagingBtn = document.getElementById('add-packaging-item-btn');
            if (addPackagingBtn) {
                addPackagingBtn.addEventListener('click', () => {
                    document.getElementById('modal-add-packaging').classList.remove('hidden');
                });
            }

            // Forms for stock control product additions
            const formAddFinishedProduct = document.getElementById('form-add-finished-product');
            if (formAddFinishedProduct) {
                formAddFinishedProduct.addEventListener('submit', saveFinishedProductFromStock);
            }
            
            const formAddRawMaterial = document.getElementById('form-add-raw-material');
            if (formAddRawMaterial) {
                formAddRawMaterial.addEventListener('submit', saveRawMaterialFromStock);
            }
            
            const formAddPackaging = document.getElementById('form-add-packaging');
            if (formAddPackaging) {
                formAddPackaging.addEventListener('submit', savePackagingFromStock);
            }

            // Delegated handlers for stock control add buttons (always available)
            document.addEventListener('click', (e) => {
                if (e.target.closest('#add-finished-product-btn')) {
                    console.log('Clicked add finished product btn');
                    document.getElementById('modal-add-finished-product').classList.remove('hidden');
                }
                if (e.target.closest('#add-raw-material-btn')) {
                    console.log('Clicked add raw material btn');
                    document.getElementById('modal-add-raw-material').classList.remove('hidden');
                }
                if (e.target.closest('#add-packaging-item-btn')) {
                    console.log('Clicked add packaging btn');
                    document.getElementById('modal-add-packaging').classList.remove('hidden');
                }
            });

            // Delegated click handlers for edit/delete buttons in Settings
            document.addEventListener('click', async (e) => {
                const editProd = e.target.closest('.edit-product-btn');
                if (editProd) {
                    const id = editProd.dataset.id;
                    if (id) openProductModal(id);
                    return;
                }
                const delProd = e.target.closest('.delete-product-btn');
                if (delProd) {
                    const id = delProd.dataset.id;
                    if (!id) return;
                    const confirmed = await customDialog({ isConfirm: true, message: 'Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ', title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', confirmText: 'Ø­Ø°Ù', confirmClass: 'bg-red-600 hover:bg-red-700' });
                    if (confirmed) {
                        try {
                            await deleteProduct(id);
                            await customDialog({ title: 'ØªÙ…', message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.' });
                        } catch (err) {
                            console.warn('deleteProduct failed', err);
                            await customDialog({ title: 'Ø®Ø·Ø£', message: 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.' });
                        }
                    }
                    return;
                }

                const editPl = e.target.closest('.edit-price-list-btn');
                if (editPl) {
                    const id = editPl.dataset.id;
                    if (id) openPriceListModal(id);
                    return;
                }
                const delPl = e.target.closest('.delete-price-list-btn');
                if (delPl) {
                    const id = delPl.dataset.id;
                    if (!id) return;
                    const confirmed = await customDialog({ isConfirm: true, message: 'Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ', title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', confirmText: 'Ø­Ø°Ù', confirmClass: 'bg-red-600 hover:bg-red-700' });
                    if (confirmed) {
                        try {
                            await deletePriceListDoc(id);
                            await customDialog({ title: 'ØªÙ…', message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.' });
                        } catch (err) {
                            console.warn('deletePriceList failed', err);
                            await customDialog({ title: 'Ø®Ø·Ø£', message: 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.' });
                        }
                    }
                    return;
                }
            });

            const addCustomerBtn = document.getElementById('add-customer-btn');
            // Customers Page
            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { customDialog({ title: 'ØµÙ„Ø§Ø­ÙŠØ§Øª', message: 'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„.' }); return; }
                    openCustomerModal();
                });
                // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
                try { if ((typeof getUserRole === 'function') && getUserRole() === 'rep') addCustomerBtn.style.display = 'none'; } catch(_){}
            }
            document.getElementById('cancel-customer-btn').addEventListener('click', () => closeModal(customerModal));

            customerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('customer-id').value;
                const payload = {
                    name: document.getElementById('customer-name').value.trim(),
                    taxNumber: document.getElementById('customer-tax-number').value.trim(),
                    phone: document.getElementById('customer-phone').value.trim(),
                    address: document.getElementById('customer-address').value.trim(),
                    requiresTaxFiling: document.getElementById('customer-requires-tax').checked,
                    priceListId: document.getElementById('customer-price-list').value || '',
                    repName: document.getElementById('customer-rep').value || '',
                    assignedRepId: (function(){
                        const repField = document.getElementById('customer-rep').value || '';
                        if (!repField) return '';
                        try { const repObj = window.findRep ? window.findRep(repField) : null; return repObj ? repObj.id : ''; } catch(e){ return ''; }
                    })()
                };

                if (!payload.name) {
                    await customDialog({ title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„.' });
                    return;
                }

                const isDuplicate = Array.isArray(state.customers)
                    ? state.customers.some(c => (c.name||'').trim() === payload.name && (c.id||c._id) !== id)
                    : false;
                if (isDuplicate) {
                    await customDialog({ title: 'Ø§Ø³Ù… Ù…ÙƒØ±Ø±', message: 'ÙŠÙˆØ¬Ø¯ Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù.' });
                    return;
                }

                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { await customDialog({ title:'ØµÙ„Ø§Ø­ÙŠØ§Øª', message:'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.' }); return; }
                    if (id) {
                        await updateCustomer(id, payload);
                    } else {
                        await addCustomer(payload);
                    }
                    closeModal(customerModal);
                    await customDialog({ message: 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.', title: 'Ù†Ø¬Ø§Ø­' });
                    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± onSnapshot
                } catch (err) {
                    const msg = (err && err.code === 'permission-denied') ? 'Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' : 'ÙØ´Ù„ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„';
                    await customDialog({ title: 'Ø®Ø·Ø£', message: msg });
                }
            });

            document.getElementById('customers-list').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-customer-btn');
                const deleteBtn = e.target.closest('.delete-customer-btn');
                const claimBtn = e.target.closest('.claim-customer-btn');

                // Ù…Ø·Ø§Ù„Ø¨Ø© (ØªØ¹ÙŠÙŠÙ†) Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù† Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (claimBtn) {
                    try {
                        const customerId = claimBtn.getAttribute('data-id');
                        const current = AuthSystem.getCurrentUser();
                        if (!current) { await customDialog({ title:'ØºÙŠØ± Ù…Ø³Ø¬Ù„', message:'Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.' }); return; }
                        const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                        if (role !== 'rep') { await customDialog({ title:'Ù…Ù…Ù†ÙˆØ¹', message:'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† ÙÙ‚Ø·.' }); return; }
                        const customer = (state.customers||[]).find(c => (c.id||c._id) === customerId);
                        if (!customer) return;
                        if (customer.assignedRepId) { await customDialog({ title:'ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†', message:'Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ØµØ¨Ø­ Ù…Ø®ØµØµØ§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„.' }); return; }
                        const repNameGuess = current.name || (current.email ? current.email.split('@')[0] : 'Ù…Ù†Ø¯ÙˆØ¨');
                        await updateCustomer(customerId, { assignedRepId: current.id, repName: customer.repName || repNameGuess });
                        await customDialog({ title:'ØªÙ…', message:'ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ùƒ.' });
                        try { renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                    } catch(err){ console.warn('claim customer failed', err); }
                    return; // Ù„Ø§ ØªØªØ§Ø¨Ø¹ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰
                }

                if (editBtn) {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { await customDialog({ title:'ØµÙ„Ø§Ø­ÙŠØ§Øª', message:'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.' }); return; }
                    const customerId = editBtn.dataset.id;
                    const customer = (state.customers||[]).find(c => (c.id||c._id) === customerId);
                    if (!canManageCustomer(customer)) {
                        await customDialog({ title:'ØµÙ„Ø§Ø­ÙŠØ§Øª', message:'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø£Ù†Ù‡ Ù„ÙŠØ³ Ù…Ø®ØµØµØ§Ù‹ Ù„Ùƒ.' });
                        return;
                    }
                    openCustomerModal(customerId);
                }

                if (deleteBtn) {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { await customDialog({ title:'ØµÙ„Ø§Ø­ÙŠØ§Øª', message:'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.' }); return; }
                    const customerId = deleteBtn.dataset.id;
                    const customer = Array.isArray(state.customers)
                        ? state.customers.find(c => (c.id||c._id) === customerId)
                        : null;
                    if (!customer) return;
                    if (!canManageCustomer(customer)) {
                        await customDialog({ title:'ØµÙ„Ø§Ø­ÙŠØ§Øª', message:'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø£Ù†Ù‡ Ù„ÙŠØ³ Ù…Ø®ØµØµØ§Ù‹ Ù„Ùƒ.' });
                        return;
                    }

                    const customerHasSales = Array.isArray(state.sales)
                        ? state.sales.some(s => s.customerId === customerId)
                        : false;
                    if (customerHasSales) {
                        await customDialog({
                            title: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù',
                            message: `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customer.name}" Ù„Ø£Ù† Ù„Ø¯ÙŠÙ‡ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù„Ø©.`
                        });
                        return;
                    }

                    const confirmed = await customDialog({
                        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                        message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customer.name}"ØŸ`,
                        isConfirm: true,
                        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                        confirmClass: 'bg-red-600 hover:bg-red-700'
                    });

                    if (confirmed) {
                        try {
                            await deleteCustomer(customerId);
                            await customDialog({ message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.' });
                            // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± onSnapshot
                        } catch (err) {
                            const msg = (err && err.code === 'permission-denied') ? 'Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' : 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„';
                            await customDialog({ title: 'Ø®Ø·Ø£', message: msg });
                        }
                    }
                }
            });

            // Reps Page
            document.getElementById('add-rep-btn').addEventListener('click', () => openRepModal());
            document.getElementById('cancel-rep-btn').addEventListener('click', () => closeModal(repModal));

            repForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('rep-id').value;
                const name = document.getElementById('rep-name').value.trim();
                const serial = document.getElementById('rep-serial').value.trim();
                const target = parseFloat(document.getElementById('rep-target').value) || 0;
                const nextInvoiceNumber = parseInt(document.getElementById('rep-next-invoice').value) || null;

                if (!name) {
                    await customDialog({ title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨.' });
                    return;
                }

                const isDuplicate = (state.reps||[]).some(r => r.name === name && r.id !== id);
                if (isDuplicate) {
                    await customDialog({ title: 'Ø§Ø³Ù… Ù…ÙƒØ±Ø±', message: 'ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø¯ÙˆØ¨ Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù.' });
                    return;
                }

                try {
                    if (id) {
                        await updateRepDoc(id, { name, serial, target, nextInvoiceNumber });
                    } else {
                        await addRepDoc(undefined, { name, serial, target, nextInvoiceNumber });
                    }
                    closeModal(repModal);
                    await customDialog({ message: 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.', title: 'Ù†Ø¬Ø§Ø­' });
                } catch (err) {
                    console.warn('saveRep cloud failed', err);
                    await customDialog({ title: 'Ø®Ø·Ø£', message: 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.' });
                }
            });

            document.getElementById('reps-list').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-rep-btn');
                const deleteBtn = e.target.closest('.delete-rep-btn');

                if (editBtn) {
                    const repId = editBtn.dataset.id;
                    openRepModal(repId);
                }

                if (deleteBtn) {
                    const repId = deleteBtn.dataset.id;
                    const rep = (state.reps||[]).find(r => r.id === repId);
                    if (!rep) return;

                    const repHasSales = (state.sales||[]).some(s => s.repName === rep.name);
                    if (repHasSales) {
                        await customDialog({
                            title: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù',
                            message: `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ "${rep.name}" Ù„Ø£Ù† Ù„Ø¯ÙŠÙ‡ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.`
                        });
                        return;
                    }

                    const confirmed = await customDialog({
                        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                        message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ "${rep.name}"ØŸ`,
                        isConfirm: true,
                        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                        confirmClass: 'bg-red-600 hover:bg-red-700'
                    });

                    if (confirmed) {
                        try {
                            await deleteRepDoc(repId);
                            await customDialog({ message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.' });
                        } catch (err) {
                            console.warn('deleteRep failed', err);
                            await customDialog({ title: 'Ø®Ø·Ø£', message: 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.' });
                        }
                    }
                }
            });

            // Modal and Form Button Handlers
            document.getElementById('cancel-customer-btn').addEventListener('click', () => closeModal(customerModal));
            // ... Add all other modal and form handlers here from the old code

            document.getElementById('add-promotion-btn').addEventListener('click', () => openPromotionModal());
            document.getElementById('cancel-promotion-btn').addEventListener('click', () => closeModal(promotionModal));

            // Batch promotions editor wiring
            const bpAdd = document.getElementById('batch-promo-add-row');
            const bpSave = document.getElementById('batch-promo-save');
            if (bpAdd) bpAdd.addEventListener('click', () => addBatchPromoRow());
            if (bpSave) bpSave.addEventListener('click', saveBatchPromotions);

            promotionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('promotion-id').value;
                const promotionData = {
                    id: id || Date.now().toString(),
                    updatedAt: new Date().toISOString(),
                    name: document.getElementById('promotion-name').value,
                    productId: document.getElementById('promotion-product').value,
                    price: parseFloat(document.getElementById('promotion-price').value),
                    customerId: document.getElementById('promotion-customer-id').value || null,
                    startDate: document.getElementById('promotion-start-date').value,
                    endDate: document.getElementById('promotion-end-date').value,
                };

                if (!promotionData.name || !promotionData.productId || isNaN(promotionData.price) || !promotionData.startDate || !promotionData.endDate) {
                    await customDialog({ title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®).' });
                    return;
                }

                try {
                    if (window.db) {
                        // Persist to Firestore
                        if (id) {
                            await db.collection('promotions').doc(id).set({
                                name: promotionData.name,
                                productId: promotionData.productId,
                                price: Number(promotionData.price||0),
                                customerId: promotionData.customerId || null,
                                startDate: promotionData.startDate,
                                endDate: promotionData.endDate,
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                        } else {
                            const ref = db.collection('promotions').doc();
                            promotionData.id = ref.id;
                            await ref.set({
                                id: promotionData.id,
                                name: promotionData.name,
                                productId: promotionData.productId,
                                price: Number(promotionData.price||0),
                                customerId: promotionData.customerId || null,
                                startDate: promotionData.startDate,
                                endDate: promotionData.endDate,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }, { merge: false });
                        }
                    } else {
                        // Fallback: update local state only
                        if (id) {
                            const index = state.promotions.findIndex(p => p.id === id);
                            if (index >= 0) state.promotions[index] = promotionData; else state.promotions.push(promotionData);
                        } else {
                            state.promotions.push(promotionData);
                        }
                    }
                } catch (err) {
                    console.warn('Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Firestore ÙØ´Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', err);
                    if (id) {
                        const index = state.promotions.findIndex(p => p.id === id);
                        if (index >= 0) state.promotions[index] = promotionData; else state.promotions.push(promotionData);
                    } else {
                        state.promotions.push(promotionData);
                    }
                }

                closeModal(promotionModal);
                renderAll();
                await customDialog({ message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­.', title: 'Ù†Ø¬Ø§Ø­' });
            });

            document.getElementById('promotion-product').addEventListener('change', (e) => {
                updatePromotionOriginalPriceDisplay(e.target.value);
            });

            document.getElementById('promotions-list').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-promotion-btn');
                const deleteBtn = e.target.closest('.delete-promotion-btn');

                if (editBtn) {
                    const promoId = editBtn.dataset.id;
                    openPromotionModal(promoId);
                }

                if (deleteBtn) {
                    const promoId = deleteBtn.dataset.id;
                    const confirmed = await customDialog({
                        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                        message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ØŸ',
                        isConfirm: true,
                        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                        confirmClass: 'bg-red-600 hover:bg-red-700'
                    });

                    if (confirmed) {
                        try {
                            if (window.db) {
                                await db.collection('promotions').doc(promoId).delete();
                            }
                        } catch (err) {
                            console.warn('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† FirestoreØŒ Ø³ÙŠÙØ­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', err);
                        }
                        state.promotions = state.promotions.filter(p => p.id !== promoId);
                        renderAll();
                        await customDialog({ message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­.' });
                    }
                }
            });

            // Dynamic List Click Handlers (delegated)
            document.getElementById('sales-list').addEventListener('click', salesListClickHandler);
            // ... Add all other dynamic list handlers

            // Settings Page
            // Settings: save monthly sales target
            const saveTargetBtn = document.getElementById('save-target-btn');
            if (saveTargetBtn) saveTargetBtn.addEventListener('click', saveSalesTarget);
            document.getElementById('backup-data-btn').addEventListener('click', createBackup);
            document.getElementById('copy-backup-btn').addEventListener('click', () => copyTextToClipboard(document.getElementById('backup-data-textarea').value));
            document.getElementById('restore-data-btn').addEventListener('click', restoreBackup);
            // Admin-only: Cloud import tool wiring
            function showHideAdminImportTool(){
                try {
                    const sec = document.getElementById('admin-cloud-import-section');
                    if (!sec) return;
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'admin') sec.classList.remove('hidden'); else sec.classList.add('hidden');
                } catch(e) { /* ignore */ }
            }
            async function handleAdminStartImport(){
                const statusEl = document.getElementById('admin-import-status');
                const btn = document.getElementById('admin-start-import-btn');
                const fileInput = document.getElementById('admin-import-file');
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role !== 'admin') { alert('Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); return; }
                if (!window.db) { alert('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø². ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.'); return; }
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
                const file = fileInput.files[0];
                btn.disabled = true;
                if (statusEl) statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù„ÙŠÙ„Ù‡...';
                try {
                    const text = await new Promise((resolve, reject) => { const rdr = new FileReader(); rdr.onload = () => resolve(rdr.result); rdr.onerror = reject; rdr.readAsText(file, 'utf-8'); });
                    const backup = (typeof parseBackupText === 'function') ? parseBackupText(text) : JSON.parse(text);
                    if (!backup || typeof backup !== 'object') { throw new Error('ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); }
                    if (statusEl) statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Firestore (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©)...';
                    const options = {
                        importCustomers: true,
                        importProducts: true,
                        importPriceLists: true,
                        importSales: true,
                        importReps: true,
                        importPromotions: true,
                        importSettings: true,
                        importDispatchNotes: !!backup.dispatchNotes,
                        importStockEntries: !!backup.stockEntries,
                        importNotifications: !!backup.notifications
                    };
                    const res = await importBackupObject(backup, options);
                    if (!res || res.ok !== true) {
                        throw new Error('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + (res && res.error ? (res.error.message || String(res.error)) : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                    }
                    if (statusEl) {
                        const c = res.counts || {};
                        statusEl.textContent = `ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ… â€” Ø¹Ù…Ù„Ø§Ø¡: ${c.customers||0}, Ù…Ù†ØªØ¬Ø§Øª: ${c.products||0}, Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø±: ${c.priceLists||0}, Ù…Ù†Ø§Ø¯ÙŠØ¨: ${c.reps||0}, Ù…Ø¨ÙŠØ¹Ø§Øª: ${c.sales||0}`;
                    }
                    try { scheduleEnsureCoreData(); } catch(e) {}
                } catch (e) {
                    console.warn('Admin cloud import failed', e);
                    alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + (e && e.message ? e.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                } finally {
                    btn.disabled = false;
                }
            }
            showHideAdminImportTool();
            setTimeout(showHideAdminImportTool, 1200);
            setTimeout(showHideAdminImportTool, 4000);
            const adminStartBtn = document.getElementById('admin-start-import-btn');
            if (adminStartBtn) adminStartBtn.addEventListener('click', handleAdminStartImport);
            



            // Dispatch Notes Page (New Grid Implementation)
            document.getElementById('add-new-dispatch-item-btn').addEventListener('click', () => addRowToNewDispatchGrid());
            document.getElementById('save-new-dispatch-note-btn').addEventListener('click', saveNewDispatchNoteFromGrid);

            document.getElementById('page-dispatch').addEventListener('click', async (e) => {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // Expand/collapse note details
                const header = e.target.closest('.dispatch-note-header');
                if (header) {
                    const card = header.closest('.dispatch-note-card');
                    if (!card) return; // safety
                    const details = card.querySelector('.dispatch-note-details');
                    const icon = header.querySelector('i[data-lucide="chevron-down"]');
                    if (!details) return; // safety
                    const noteId = card.dataset.noteId;
                    const isHidden = details.classList.contains('hidden');

                    if (isHidden) {
                            // Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨: Ø¹Ø±Ø¶ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
                            if (role === 'rep') {
                                try { renderReadonlyDispatchGrid(noteId, details); } catch(_) { /* fallback */ renderEditableDispatchGrid(noteId, details); }
                            } else {
                                renderEditableDispatchGrid(noteId, details);
                            }
                        details.classList.remove('hidden');
                        if (icon) icon.style.transform = 'rotate(180deg)';
                    } else {
                        details.classList.add('hidden');
                        details.innerHTML = '';
                        if (icon) icon.style.transform = 'rotate(0deg)';
                    }
                    return;
                }

                // Update an existing note
                const updateBtn = e.target.closest('.update-dispatch-note-btn');
                if (updateBtn && role !== 'rep') {
                    const noteId = updateBtn.dataset.noteId;
                    const table = updateBtn.closest('.dispatch-note-details').querySelector('.editable-dispatch-table');
                    await updateDispatchNote(noteId, table);
                    return;
                }

                // Print a dispatch note
                const printBtn = e.target.closest('.print-dispatch-note-btn');
                if (printBtn) {
                    const noteId = printBtn.dataset.noteId;
                    printDispatchNote(noteId);
                    return;
                }

                const copyBtn = e.target.closest('.copy-dispatch-note-btn');
                if (copyBtn) {
                    const noteId = copyBtn.dataset.noteId;
                    await copyDispatchNoteAsImage(noteId);
                    return;
                }

                // Delete an existing note
                const deleteNoteBtn = e.target.closest('.delete-dispatch-note-btn');
                if (deleteNoteBtn && role !== 'rep') {
                    const noteId = deleteNoteBtn.dataset.noteId;
                    await deleteDispatchNote(noteId);
                    return;
                }
                
                // Add a row to an editable grid
                const addRowBtn = e.target.closest('.add-editable-dispatch-item-btn');
                if (addRowBtn && role !== 'rep') {
                    const tableBody = addRowBtn.closest('.dispatch-note-details').querySelector('tbody');
                    const newRow = document.createElement('tr');
                    newRow.className = 'dispatch-item-row';
                    const productOptions = state.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    newRow.innerHTML = `
                        <td class="px-2 py-1"><select class="dispatch-item-product w-full p-1 border rounded-md text-sm" required><option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬...</option>${productOptions}</select></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="quantity" placeholder="0" min="0"></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="goodReturn" placeholder="0" min="0"></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="damagedReturn" placeholder="0" min="0"></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="freebie" placeholder="0" min="0"></td>
                        <td class="px-2 py-1 text-center"><button type="button" class="delete-dispatch-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    `;
                    tableBody.appendChild(newRow);
                    updateIcons();
                    return;
                }

                // Delete a row from any grid (new or editable)
                const deleteRowBtn = e.target.closest('.delete-dispatch-item-btn');
                if (deleteRowBtn && role !== 'rep') {
                    const row = deleteRowBtn.closest('tr');
                    if (row) row.remove();
                    return;
                }
            });

            // Reports Page
            // Initialize chain dropdowns for reports
            populateChainsDropdown(document.getElementById('daily-report-chain'));
            populateChainsDropdown(document.getElementById('range-report-chain'));
            populateChainsDropdown(document.getElementById('monthly-report-chain'));
            populateChainsDropdown(document.getElementById('recon-report-chain'));
            populateChainsDropdown(document.getElementById('targets-chain-filter'));
            
            document.getElementById('generate-daily-report-btn').addEventListener('click', generateDailyReport);
            document.getElementById('generate-recon-report-btn').addEventListener('click', generateReconciliationReport);
            try { document.getElementById('generate-range-report-btn').addEventListener('click', generateRangeReport); } catch(e){}
            try { document.getElementById('generate-monthly-report-btn').addEventListener('click', generateMonthlyReport); } catch(e){}
            // Targets: regenerate on month or rep filter change
            try {
                const tMonth = document.getElementById('targets-month');
                if (tMonth) tMonth.addEventListener('change', generateTargetsReport);
                const tRep = document.getElementById('targets-rep-filter');
                if (tRep) tRep.addEventListener('change', generateTargetsReport);
                const tChain = document.getElementById('targets-chain-filter');
                if (tChain) tChain.addEventListener('change', generateTargetsReport);
            } catch(e){}
            // Add chain change listeners to other reports
            try {
                const dChain = document.getElementById('daily-report-chain');
                if (dChain) dChain.addEventListener('change', generateDailyReport);
                const rChain = document.getElementById('range-report-chain');
                if (rChain) rChain.addEventListener('change', generateRangeReport);
                const mChain = document.getElementById('monthly-report-chain');
                if (mChain) mChain.addEventListener('change', generateMonthlyReport);
                const rcChain = document.getElementById('recon-report-chain');
                if (rcChain) rcChain.addEventListener('change', generateReconciliationReport);
            } catch(e){}
            // Customer Targets: handlers for month/category and save/refresh
            try {
                const cMonth = document.getElementById('customer-targets-month');
                if (cMonth) cMonth.addEventListener('change', generateCustomerTargetsReport);
                const cCat = document.getElementById('customer-targets-category');
                if (cCat) cCat.addEventListener('change', generateCustomerTargetsReport);
                const cRefresh = document.getElementById('refresh-customer-targets-btn');
                if (cRefresh) cRefresh.addEventListener('click', generateCustomerTargetsReport);
                const cSave = document.getElementById('save-customer-targets-btn');
                if (cSave) cSave.addEventListener('click', saveCustomerTargetsFromInputs);
            } catch(e){ console.warn('customer targets handlers failed', e); }
            // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ØªØ³ÙˆÙŠØ© Ø¨Ø³ÙŠØ·Ø©Ø› Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù‚ÙˆØ§Ø¦Ù… Ø®Ø§ØµØ© Ø¨Ù‡Ø§

            // Manual statement button
            document.getElementById('manual-statement-btn').addEventListener('click', () => {
                // Set default dates
                document.getElementById('end-date').value = new Date().toISOString().split('T')[0];
                const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
                document.getElementById('start-date').value = thirtyDaysAgo;
                
                openModal(dateRangeModal);
                updateCustomerList();
            });

            

            // Manual statement form submission
            document.getElementById('date-range-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const category = document.querySelector('input[name="product-category"]:checked').value;
                const selectedCustomerNodes = document.querySelectorAll('#statement-customer-list input[type="checkbox"]:checked');
                
                if (!startDate || !endDate) {
                    await customDialog({ title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©.' });
                    return;
                }
                if (selectedCustomerNodes.length === 0) {
                    await customDialog({ title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.' });
                    return;
                }

                // Expand chain IDs to actual customer IDs
                let expandedIds = [];
                const chains = loadChains();
                Array.from(selectedCustomerNodes).forEach(node => {
                    const val = node.value;
                    if (val.startsWith('chain-')) {
                        const chainId = val.substring(6);
                        const chain = chains.find(c => c.id === chainId);
                        if (chain) expandedIds.push(...(chain.customerIds || []));
                    } else {
                        expandedIds.push(val);
                    }
                });
                
                const customerNames = expandedIds.map(id => findCustomer(id)?.name).filter(n => n).join(', ');
                const title = `ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙŠØ¯ÙˆÙŠ`;

                generateAndShowStatement(new Date(startDate), new Date(endDate), expandedIds, title, customerNames, category);
                closeModal(dateRangeModal);
            });
            
            document.getElementById('cancel-date-range-btn').addEventListener('click', () => {
                closeModal(dateRangeModal);
            });

            // Search in statement customer list
            document.getElementById('statement-customer-search').addEventListener('input', (e) => {
                updateCustomerList(e.target.value);
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + error.message);
                }
            });

            // Debts Page
            try {
                const debtCustomerInput = document.getElementById('debt-customer-filter');
                const debtRepSelect = document.getElementById('debt-rep-filter');
                const debtStartDate = document.getElementById('debt-start-date');
                const debtEndDate = document.getElementById('debt-end-date');
                const debtStatusSelect = document.getElementById('debt-status-filter');
                const debtsCsvBtn = document.getElementById('debts-csv-btn');
                const debtsPrintBtn = document.getElementById('debts-print-btn');

                if (debtRepSelect) populateRepDropdown(debtRepSelect);

                const debtsRerender = () => renderDebts();

                // debt-customer-filter is now a select populated only with customers that have invoices
                if (debtCustomerInput) debtCustomerInput.addEventListener('change', debtsRerender);
                if (debtRepSelect) debtRepSelect.addEventListener('change', debtsRerender);
                if (debtStartDate) debtStartDate.addEventListener('change', debtsRerender);
                if (debtEndDate) debtEndDate.addEventListener('change', debtsRerender);
                if (debtStatusSelect) debtStatusSelect.addEventListener('change', debtsRerender);

                if (debtsCsvBtn) {
                    debtsCsvBtn.addEventListener('click', () => {
                        const rows = (window._lastRenderedDebtsSales || []);
                        if (!rows.length) {
                            customDialog({ title: 'ØªÙ†Ø¨ÙŠÙ‡', message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.' });
                            return;
                        }
                        const headers = ['Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'Ø§Ù„Ù…Ø³Ø¯Ø¯', 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨'];
                        const csv = [headers.join(',')].concat(rows.map(sale => {
                            const cust = findCustomer(sale.customerId)?.name || 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ';
                            const date = formatArabicDate(sale.date);
                            const inv = sale.invoiceNumber || '';
                            const total = (sale.total || 0).toFixed(2);
                            const paid = (sale.paidAmount || 0).toFixed(2);
                            const remaining = ( (sale.total || 0) - (sale.paidAmount || 0) ).toFixed(2);
                            const rep = sale.repName || '';
                            return [`"${cust}"`,`"${date}"`,`"${inv}"`,`"${total}"`,`"${paid}"`,`"${remaining}"`,`"${rep}"`].join(',');
                        })).join('\n');

                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `debts_export_${new Date().toISOString().slice(0,10)}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                    });
                }

                if (debtsPrintBtn) {
                    debtsPrintBtn.addEventListener('click', () => {
                        const rows = (window._lastRenderedDebtsSales || []);
                        const totalStats = window._lastRenderedDebtsStats || {};
                        const w = window.open('', '', 'height=700,width=1000');
                        if (!w) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
                        w.document.open();
                        w.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</title>');
                        w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
                        w.document.write('<style>body{font-family: Cairo, sans-serif; direction: rtl; padding:20px;} table{width:100%;border-collapse:collapse;} th, td{padding:8px;border:1px solid #e5e7eb;text-align:center;} th{background:#fff7ed;color:#c2410c;}</style>');
                        w.document.write('</head><body>');
                        w.document.write('<h3 style="text-align:right">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</h3>');
                        w.document.write(`<p style="text-align:right">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${formatCurrency(totalStats.subtotal || 0)}</p>`);
                        w.document.write(`<p style="text-align:right">Ø§Ù„Ù…Ø³Ø¯Ø¯: ${formatCurrency(totalStats.paid || 0)}</p>`);
                        w.document.write(`<p style="text-align:right">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${totalStats.count || 0}</p>`);
                        w.document.write(`<p style="text-align:right">Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª: ${formatCurrency(totalStats.debts || 0)}</p>`);
                        w.document.write('<hr/>');
                        w.document.write('<table><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø³Ø¯Ø¯</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th></tr></thead><tbody>');
                        rows.forEach(sale => {
                            const cust = findCustomer(sale.customerId)?.name || 'Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ';
                            const date = formatArabicDate(sale.date);
                            const inv = sale.invoiceNumber || '';
                            const total = formatCurrency(sale.total || 0);
                            const paid = formatCurrency(sale.paidAmount || 0);
                            const remaining = formatCurrency((sale.total || 0) - (sale.paidAmount || 0));
                            const rep = sale.repName || '';
                            w.document.write(`<tr><td>${cust}</td><td>${date}</td><td>${inv}</td><td>${total}</td><td>${paid}</td><td>${remaining}</td><td>${rep}</td></tr>`);
                        });
                        w.document.write('</tbody></table>');
                        w.document.write('</body></html>');
                        w.document.close();
                        const doPrint = () => { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
                        const closeBack = () => { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
                        if ('onafterprint' in w) { w.onafterprint = closeBack; } else { setTimeout(closeBack, 1200); }
                        if ('onload' in w) { w.onload = () => setTimeout(doPrint, 120); } else { setTimeout(doPrint, 300); }
                    });
                }
            } catch (e) {
                console.warn('Debts event listeners setup failed', e);
            }

            // Column filter UI removed; no global toggle handler attached.

            // ===== PRODUCTION PAGE TABS HANDLERS =====
            const tabActive = document.getElementById('tab-active-productions');
            const tabCompleted = document.getElementById('tab-completed-productions');
            const sectionActive = document.getElementById('active-productions-section');
            const sectionCompleted = document.getElementById('completed-productions-section');

            if (tabActive && tabCompleted && sectionActive && sectionCompleted) {
                // Handle Active Tab Click
                tabActive.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ğŸŸ¢ Switched to Active Productions');
                    
                    // Show active section, hide completed
                    sectionActive.classList.remove('hidden');
                    sectionCompleted.classList.add('hidden');
                    
                    // Update tab styling
                    tabActive.classList.add('text-green-600', 'border-b-2', 'border-green-600');
                    tabActive.classList.remove('text-gray-600', 'hover:text-gray-800');
                    
                    tabCompleted.classList.remove('text-green-600', 'border-b-2', 'border-green-600');
                    tabCompleted.classList.add('text-gray-600', 'hover:text-gray-800');
                });

                // Handle Completed Tab Click
                tabCompleted.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ğŸ”µ Switched to Completed Productions');
                    
                    // Show completed section, hide active
                    sectionCompleted.classList.remove('hidden');
                    sectionActive.classList.add('hidden');
                    
                    // Update tab styling
                    tabCompleted.classList.add('text-green-600', 'border-b-2', 'border-green-600');
                    tabCompleted.classList.remove('text-gray-600', 'hover:text-gray-800');
                    
                    tabActive.classList.remove('text-green-600', 'border-b-2', 'border-green-600');
                    tabActive.classList.add('text-gray-600', 'hover:text-gray-800');
                });
            } else {
                if (!tabActive) console.warn('âš ï¸ tab-active-productions not found');
                if (!tabCompleted) console.warn('âš ï¸ tab-completed-productions not found');
                if (!sectionActive) console.warn('âš ï¸ active-productions-section not found');
                if (!sectionCompleted) console.warn('âš ï¸ completed-productions-section not found');
            }

            eventListenersAttached = true;
        }

        // --- Auth State Change Handler (guarded) ---
        const internalAuthHandler = async (user) => {
            if (user) {
                // User is signed in
                console.log('User logged in:', user.email);
                showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...");
                logoutBtn.classList.remove('hidden');

                    // 1. Load local data and initialize UI in a robust order:
                    //    - load state
                    //    - attach event listeners (so renders can wire controls)
                    //    - render all UI
                    //    - navigate to dashboard and force dashboard charts to render
                    // loadState() Ù…ÙÙ„ØºØ§Ø©Ø› Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠØ©
                    if (!window.state) window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                    // Preload cached collections so UI shows data even before permissions succeed
                    try { preloadCachedCollections(); } catch(e){ console.warn('preloadCachedCollections (login) failed', e); }
                    try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed during startup', e); }
                    try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed during startup', e); }
                    try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed during startup:', e); }
                    try { renderAll(); } catch (e) { console.warn('renderAll failed during startup:', e); }
                    // Open dashboard by default (show data immediately)
                    try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed during startup:', e); }
                    // Small delayed forcing of dashboard charts to avoid timing issues
                    setTimeout(() => {
                        scheduleRender('charts', ()=>{ try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { /* non-fatal */ } });
                    }, 60);
                    hideLoading(); // App is now usable.
                    try { applyRoleUIRestrictions(); } catch(_){}

                // 2) ÙØ¹Ù‘Ù„ Ù…Ø²Ø§Ù…Ù†Ø© Firestore Ø§Ù„Ø­ÙŠØ© + Ø¶Ù…Ø§Ù† ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                try {
                    if (!window.__RT_LISTENERS_ATTACHED) {
                        setupRealtimeListeners();
                        window.__RT_LISTENERS_ATTACHED = true;
                    }
                } catch(e) { console.warn('setupRealtimeListeners (auth handler) failed', e); }
                try { await importEmbeddedBackupIfNeeded(); } catch(e){ console.warn('importEmbeddedBackupIfNeeded (auth handler) failed', e); }
                try { scheduleEnsureCoreData(); } catch(e){ console.warn('scheduleEnsureCoreData (auth handler) failed', e); }

            } else {
                // User is signed out (or auth returned null). Do NOT delete localStorage automatically.
                // Treat this as offline fallback so the app keeps working with local data when opened via file://
                console.log('No authenticated user detected â€” starting offline/local mode');
                try { logoutBtn.classList.add('hidden'); } catch(e) {}

                try {
                    // Robust offline startup: load local state, attach listeners, render UI and show dashboard
                    if (!window.state) window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                    // Offline / signed-out: also hydrate from caches
                    try { preloadCachedCollections(); } catch(e){ console.warn('preloadCachedCollections (offline) failed', e); }
                    try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed during offline startup', e); }
                    try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed during offline startup', e); }
                    try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed during offline startup:', e); }
                    try { renderAll(); } catch (e) { console.warn('renderAll failed during offline startup:', e); }
                    try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed during offline startup:', e); }
                    setTimeout(() => {
                        scheduleRender('charts', ()=>{ try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { /* non-fatal */ } });
                    }, 60);
                } catch (e) {
                    console.warn('Offline startup failed, falling back to cleared state:', e);
                    // As a last resort, initialize an empty state to keep the UI functional
                    state = { customers: [], products: [], sales: [], priceLists: [], dispatchNotes: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                    renderAll();
                }
                try { applyRoleUIRestrictions(); } catch(_){}
            }
        };

        // Role-based UI restrictions
        function applyRoleUIRestrictions(){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'rep') {
                    const newDispatchSection = document.getElementById('new-dispatch-note-section');
                    if (newDispatchSection) newDispatchSection.style.display = 'none';
                    // Disable edit-related buttons globally on dispatch page
                    document.querySelectorAll('.update-dispatch-note-btn,.delete-dispatch-note-btn,.add-editable-dispatch-item-btn,.delete-dispatch-item-btn,#save-new-dispatch-note-btn,#add-new-dispatch-item-btn').forEach(el=>{
                        el.classList.add('pointer-events-none','opacity-50');
                        if (el.tagName === 'BUTTON' || el.tagName === 'INPUT') el.disabled = true;
                    });
                }
            } catch(e){ console.warn('applyRoleUIRestrictions failed', e); }
        }

        // Register auth listener only if an auth object with a listener method exists
        if (typeof auth !== 'undefined' && auth && typeof auth.onAuthStateChanged === 'function') {
            try {
                auth.onAuthStateChanged(internalAuthHandler);
            } catch (e) {
                console.warn('auth.onAuthStateChanged failed, falling back to safe handler:', e);
                internalAuthHandler(null);
            }
        } else if (typeof onAuthStateChanged === 'function' && window.auth) {
            // support modular firebase export assigned to window.auth
            try {
                onAuthStateChanged(window.auth, internalAuthHandler);
            } catch (e) {
                console.warn('onAuthStateChanged(window.auth) failed, falling back:', e);
                internalAuthHandler(null);
            }
        } else {
            // No auth available (likely opened via file:// or module failed).
            // Fallback: load local state and start app in offline mode instead of clearing state.
            console.warn('No Firebase auth available; loading local data for offline mode.');
            try {
                // Robust offline startup sequence: load -> listeners -> render -> navigate -> force charts
                if (!window.state) window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed in fallback startup', e); }
                try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed in fallback startup', e); }
                try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed in fallback:', e); }
                try { renderAll(); } catch (e) { console.warn('renderAll failed in fallback:', e); }
                try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed in fallback:', e); }
                setTimeout(() => {
                    try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { /* ignore */ }
                }, 60);
            } catch (e) {
                console.error('Fallback UI initialization failed:', e);
            }
        }

        // --- Firestore Sync Function (merge-safe) ---
        async function syncWithFirestore() {
            try {
                const lastSyncTimestamp = state.lastSyncTimestamp;
                console.log(`Starting incremental sync. Fetching changes since: ${lastSyncTimestamp || 'the beginning of time'}`);

                const collections = ['customers', 'products', 'sales', 'priceLists', 'dispatchNotes', 'reps', 'promotions', 'settings'];
                const queries = collections.map(col => {
                    let query = db.collection(col);
                    // For settings, we fetch the whole collection as it's usually one doc
                    if (lastSyncTimestamp && col !== 'settings' && col !== 'sales') {
                        query = query.where('updatedAt', '>', lastSyncTimestamp);
                    }
                    return query.get();
                });

                const snapshots = await Promise.all(queries);
                const newSyncTimestamp = new Date().toISOString();

                let hasChanges = false;
                snapshots.forEach((snapshot, index) => {
                    const collectionName = collections[index];
                    if (!snapshot.empty) {
                        hasChanges = true;
                        console.log(`Found ${snapshot.size} updated document(s) in ${collectionName}.`);
                        snapshot.docs.forEach(doc => {
                            const data = { id: doc.id, ...doc.data() };
                            // Find and update/add the item in the local state
                            const collectionState = state[collectionName];
                            if (Array.isArray(collectionState)) {
                                const existingIndex = collectionState.findIndex(item => item.id === data.id);
                                if (existingIndex > -1) {
                                    collectionState[existingIndex] = data; // Update
                                } else {
                                    collectionState.push(data); // Add
                                }
                            }
                        });
                    } else if (collectionName === 'settings' && !snapshot.empty) {
                         // Special handling for settings (not an array)
                         hasChanges = true;
                         state.settings = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    }
                });

                if (hasChanges) {
                    console.log('Changes found, state will be updated and saved.');
                } else {
                    console.log('No new changes found from Firestore.');
                }

                // Update the sync timestamp regardless, to keep it current
                state.lastSyncTimestamp = newSyncTimestamp;



                // Save the newly synced state to local storage for the next offline load.
                saveState();
                console.log('Firestore sync process finished and state saved locally.');

            } catch (error) {
                console.error('syncWithFirestore failed:', error);
                // Don't update timestamp if sync fails
                throw error; // Re-throw to be caught by the caller's .catch()
            }
        }

        // --- Login Form Handler ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            const loginButton = e.submitter;
            loginButton.disabled = true;
            loginButton.textContent = 'Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';

            try {
                // Use new service-based login (hybrid mode)
                const result = await (typeof window.loginUsingServices === 'function'
                    ? window.loginUsingServices(email, password, { showAlertOnError: false })
                    : auth.signInWithEmailAndPassword(email, password).then(() => ({ ok: true })));
                if (!result.ok) throw new Error(result.error || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                // onAuthStateChanged will handle the rest
                closeModal(loginModal);
            } catch (error) {
                alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            }
        });

    </script>
    <!-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ auto-start offline Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
    <script>
    // Costs / BOM feature (minimal, client-side only)
    (function(){
        const LS_FIN = 'cost_finished';
        const LS_RAW = 'cost_raw';
        const LS_PACK = 'cost_pack';
        const LS_OPS = 'cost_ops';
        const LS_BOM_PREFIX = 'bom_';

        let costFinished = [];
        let costRaw = [];
        let costPack = [];
        let costOps = [];

        function loadLists(){
            try { costFinished = JSON.parse(localStorage.getItem(LS_FIN) || '[]'); } catch(e){ costFinished = []; }
            try { costRaw = JSON.parse(localStorage.getItem(LS_RAW) || '[]'); } catch(e){ costRaw = []; }
            try { costPack = JSON.parse(localStorage.getItem(LS_PACK) || '[]'); } catch(e){ costPack = []; }
            try { costOps = JSON.parse(localStorage.getItem(LS_OPS) || '[]'); } catch(e){ costOps = []; }
            // DEBUG: print what was loaded
            try {
                const rawFromLS = localStorage.getItem(LS_RAW);
                const rawParsed = rawFromLS ? JSON.parse(rawFromLS) : [];
                console.log('ğŸ” loadLists DEBUG: loaded cost_raw from localStorage', { itemCount: rawParsed.length, firstItem: rawParsed[0], timestamp: localStorage.getItem('costLists_local_ts'), rawStorageKey: LS_RAW });
            } catch(e) { console.warn('ğŸ” loadLists DEBUG: error reading cost_raw', e); }
            // Sync to window so simplified recipe quick lists can read them
            try { window.costFinished = costFinished; window.costRaw = costRaw; window.costPack = costPack; window.costOps = costOps; } catch(_){ }
            console.log('loadLists: loaded from localStorage', { costRaw: costRaw.length, costPack: costPack.length, costFinished: costFinished.length });
            // ensure finished products have defaults from app state if empty
            ensureFinishedFromState();
            // ensure raw/pack lists are populated from stock-control state if empty
            try { ensureRawAndPackFromState(); } catch(_){ }
            console.log('loadLists: after ensure', { costRaw: costRaw.length, costPack: costPack.length, costFinished: costFinished.length });
            renderListsSummary(); renderProductSelect(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable();
            // Try overlay-from-cloud after local load
            console.log('loadLists: about to call tryLoadCostListsFromCloud...');
            try { tryLoadCostListsFromCloud(); } catch(e){ console.warn('loadLists: tryLoadCostListsFromCloud failed', e); }
        }

        function saveLists(suppressCloud){
            // ===== 1. Ensure we're using window globals =====
            try { 
                costFinished = window.costFinished || costFinished; 
                costRaw = window.costRaw || costRaw; 
                costPack = window.costPack || costPack; 
                costOps = window.costOps || costOps; 
            } catch(_){ }
            renderListsSummary(); renderProductSelect(); renderRawPriceTable();

            // ===== 2. Cache locally (non-authoritative) - use WINDOW globals =====
            try {
                // Ù„Ø§ ØªÙƒØªØ¨ finished Ø§Ù„ÙØ§Ø±Øº ÙÙˆÙ‚ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© ØªØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª
                try {
                    if (Array.isArray(window.costFinished) && window.costFinished.length > 0) {
                        localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished));
                    } else {
                        const existingFin = JSON.parse(localStorage.getItem(LS_FIN) || '[]');
                        if (Array.isArray(existingFin) && existingFin.length > 0) {
                            // Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ„Ø§ ØªÙƒØªØ¨ ØµÙØ±
                        } else {
                            localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished));
                        }
                    }
                } catch(_){ localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished)); }
                localStorage.setItem(LS_RAW, JSON.stringify(window.costRaw));
                localStorage.setItem(LS_PACK, JSON.stringify(window.costPack));
                localStorage.setItem(LS_OPS, JSON.stringify(window.costOps));
                const timestamp = new Date().toISOString();
                // Do not mark local cache as authoritative timestamp here. Only cache payload.
                console.log('ğŸ’¾ saveLists: cached locally (cache only)', { finished: (window.costFinished||[]).length, raw: (window.costRaw||[]).length, pack: (window.costPack||[]).length, ops: (window.costOps||[]).length, timestamp });
            } catch(e){ console.warn('âš ï¸ saveLists: failed to write local cache', e); }

            // ===== 3. Cloud-first write: push immediately to Firestore (include grid states)
            if (!suppressCloud) {
                try {
                    // ensure window.costLists reflects current arrays
                    window.costLists = window.costLists || {};
                    window.costLists.costRaw = window.costRaw;
                    window.costLists.costPack = window.costPack;
                    window.costLists.costFinished = window.costFinished;
                    // delegate to centralized cloud writer which includes grid states
                    if (typeof window.saveCostListsToFirebase === 'function') {
                        window.saveCostListsToFirebase(true).then(ok => {
                            if (ok) {
                                document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { raw: (window.costRaw||[]).length, pack: (window.costPack||[]).length, finished: (window.costFinished||[]).length } }));
                            }
                        }).catch(e => console.warn('âš ï¸ saveLists: saveCostListsToFirebase failed', e));
                    } else {
                        console.warn('âš ï¸ saveLists: saveCostListsToFirebase not available');
                    }
                } catch(e) { console.warn('âš ï¸ saveLists: cloud write failed', e); }
            }
        }

        // Expose saveLists so other script blocks (earlier in the file) can call it
        try { window.saveLists = saveLists; } catch(_){ }

        // ===== Cloud sync (Firestore) for cost lists - SAFE WITH onSnapshot =====
        let __costDocUnsub = null;
        // ===== CRITICAL FIX: Sync Cloud Stock Numbers to UI =====
        window.syncCloudDataToUI = function(cloudData) {
            console.log("ğŸ”„ Syncing Cloud Numbers to UI...");

            // Helper: Update local array with cloud stock numbers
            const updateStock = (localList, cloudList) => {
                if (!localList || !cloudList) return;
                localList.forEach(item => {
                    // Find the item in cloud data by Name or ID
                    const cloudItem = cloudList.find(c => c.name === item.name || (c.id && c.id === item.id));
                    if (cloudItem) {
                        item.stock = Number(cloudItem.stock) || 0; // Update Stock
                        item.avgCost = Number(cloudItem.avgCost || cloudItem.cost) || 0; // Update Cost
                        item.cost = Number(cloudItem.cost || cloudItem.avgCost) || 0; // Sync both cost fields
                    }
                });
            };

            // 1. Update Raw Materials with cloud stock numbers
            if (window.costRaw && cloudData.raw) {
                updateStock(window.costRaw, cloudData.raw);
                console.log(`âœ… Updated ${window.costRaw.length} raw materials with cloud stock`);
            }

            // 2. Update Packaging with cloud stock numbers
            if (window.costPack && cloudData.pack) {
                updateStock(window.costPack, cloudData.pack);
                console.log(`âœ… Updated ${window.costPack.length} packaging items with cloud stock`);
            }

            // 3. Update Finished Products with cloud stock numbers
            if (window.costFinished && cloudData.finished) {
                updateStock(window.costFinished, cloudData.finished);
                console.log(`âœ… Updated ${window.costFinished.length} finished products with cloud stock`);
            }

            // 4. Re-Draw the Tables with REAL numbers
            try {
                if (typeof renderRawMaterials === 'function') renderRawMaterials();
                if (typeof renderPackaging === 'function') renderPackaging();
                if (typeof renderFinishedProducts === 'function') renderFinishedProducts();
                console.log("âœ… UI Updated with REAL numbers from Cloud");
            } catch(e) {
                console.warn('UI re-render failed:', e);
            }
        };

        function initRealtimeSync() {
            try {
                console.log('ğŸ”Œ Connecting to Real-time Data Stream (onSnapshot - Safe)...');
                if (!window.firebase || !window.firebase.firestore) {
                    console.warn('Firebase not ready for realtime sync');
                    return;
                }
                
                // Only subscribe once to avoid duplicate listeners
                if (__costDocUnsub) {
                    console.log('â„¹ï¸ Realtime sync already active');
                    return;
                }
                
                // Use onSnapshot for efficient, safe real-time updates (NO loops)
                __costDocUnsub = firebase.firestore().collection('settings').doc('costLists')
                .onSnapshot((doc) => {
                    if (!doc.exists) {
                        console.log('â„¹ï¸ No costLists doc in cloud yet');
                        return;
                    }
                    
                    const source = doc.metadata.hasPendingWrites ? "Local" : "Server";
                    const data = doc.data();
                    console.log(`ğŸ“¥ Received update from ${source}`, { hasRaw: !!data.raw, hasPack: !!data.pack, hasFinished: !!data.finished });

                    // Only update if the change comes from SERVER (another device)
                    // or if we are loading for the first time.
                    if (source === "Server" || !window.dataLoaded) {
                        
                        // 1. UPDATE MEMORY
                        window.costLists = window.costLists || {};
                        if (data.raw) window.costLists.costRaw = data.raw;
                        if (data.pack) window.costLists.costPack = data.pack;
                        if (data.finished) window.costLists.costFinished = data.finished;
                        if (data.timestamp) window.costLists.timestamp = data.timestamp;
                        
                        // 2. SYNC TO WINDOW (for inventory system) - ALWAYS UPDATE FROM CLOUD
                        // âœ… FIXED: Always merge cloud data to ensure fresh stock values show in UI
                        if (Array.isArray(data.raw) && data.raw.length > 0) {
                            window.costRaw = data.raw;  // Cloud is authoritative
                            console.log(`âœ… Updated window.costRaw with ${data.raw.length} items from cloud`);
                        }
                        if (Array.isArray(data.pack) && data.pack.length > 0) {
                            window.costPack = data.pack;
                            console.log(`âœ… Updated window.costPack with ${data.pack.length} items from cloud`);
                        }
                        if (Array.isArray(data.finished) && data.finished.length > 0) {
                            window.costFinished = data.finished;
                            console.log(`âœ… Updated window.costFinished with ${data.finished.length} items from cloud`);
                        }
                        
                        // 3. SAVE TO LOCAL CACHE (for offline)
                        try {
                            if (data.raw) localStorage.setItem('cost_raw', JSON.stringify(data.raw));
                            if (data.pack) localStorage.setItem('cost_pack', JSON.stringify(data.pack));
                            if (data.finished) localStorage.setItem('cost_finished', JSON.stringify(data.finished));
                        } catch(e) { console.warn('localStorage sync failed:', e); }
                        
                        // 4. âœ… FORCE UI REFRESH with REAL CLOUD STOCK NUMBERS
                        try {
                            // Call the sync function to merge cloud stock numbers into UI
                            if (typeof window.syncCloudDataToUI === 'function') {
                                window.syncCloudDataToUI(data);
                            }
                            
                            // Also refresh inventory tab if open
                            if (window.inventorySystem && window.inventorySystem.currentTab) {
                                console.log(`ğŸ”„ Cloud data arrived, refreshing ${window.inventorySystem.currentTab} tab UI...`);
                                setTimeout(() => {
                                    window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab);
                                }, 50);
                            }
                        } catch(e) { console.warn('UI refresh failed:', e); }
                        
                        window.dataLoaded = true;
                        console.log('âœ… Real-time sync update applied (safe, no loops)');
                    }
                }, (error) => {
                    console.error('âŒ Realtime sync error:', error);
                    if (error.code === 'permission-denied') {
                        console.warn('âš ï¸ Permission denied - check Firestore rules or re-login');
                    }
                });
                
                // ğŸ”„ Also refresh UI if currently viewing the inventory page
                window.addEventListener('costListsSavedToCloud', () => {
                    try {
                        if (window.inventorySystem && window.inventorySystem.currentTab) {
                            console.log('ğŸ”„ Cloud update detected, refreshing UI...');
                            setTimeout(() => window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab), 100);
                        }
                    } catch(e){ console.warn('UI refresh on cloud update failed:', e); }
                });
            } catch(e) {
                console.error('initRealtimeSync failed:', e);
            }
        }

        // Start realtime sync on Firebase initialization
        setTimeout(() => {
            try { if (typeof initRealtimeSync === 'function') initRealtimeSync(); } catch(e){ console.error('initRealtimeSync error:', e); }
        }, 500);

        async function tryLoadCostListsFromCloud(){
            try {
                console.log("â˜ï¸ Attempting to load and RESTORE data from Cloud...");
                if (!window.firebase || !window.firebase.firestore) {
                    console.warn('âš ï¸ Firebase not initialized');
                    return false;
                }
                
                const doc = await firebase.firestore().collection('settings').doc('costLists').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    console.log("ğŸ“‹ Cloud doc found:", { hasRaw: !!data.raw, hasPack: !!data.pack, hasFinished: !!data.finished, hasRawGridState: !!data.rawGridState, hasPackGridState: !!data.packGridState, hasFinishedProducts: !!data.finishedProducts, hasStockEntries: !!data.stockEntries });
                    
                    // 1. Restore Global Lists (Calculated Costs)
                    if (data.raw && Array.isArray(data.raw) && data.raw.length > 0) {
                        window.costLists = window.costLists || {};
                        window.costLists.costRaw = data.raw;
                        console.log("âœ… Restored costRaw:", data.raw.length, "items");
                    }
                    if (data.pack && Array.isArray(data.pack) && data.pack.length > 0) {
                        window.costLists = window.costLists || {};
                        window.costLists.costPack = data.pack;
                        console.log("âœ… Restored costPack:", data.pack.length, "items");
                    }
                    if (data.finished && Array.isArray(data.finished) && data.finished.length > 0) {
                        window.costLists = window.costLists || {};
                        window.costLists.costFinished = data.finished;
                        console.log("âœ… Restored costFinished:", data.finished.length, "items");
                    }
                    if (data.timestamp) {
                        window.costLists = window.costLists || {};
                        window.costLists.timestamp = data.timestamp;
                    }

                    // 2. CRITICAL: Restore Grid States (The Inputs & Prices)
                    // If the cloud has grid states, inject them into the Window & LocalStorage
                    if (data.rawGridState && typeof data.rawGridState === 'object') {
                        window._rawGridState = data.rawGridState;
                        localStorage.setItem('raw_materials_grid', JSON.stringify(data.rawGridState));
                        console.log("âœ… Restored rawGridState to window and localStorage");
                    }
                    if (data.packGridState && typeof data.packGridState === 'object') {
                        window._packGridState = data.packGridState;
                        localStorage.setItem('packaging_grid', JSON.stringify(data.packGridState));
                        console.log("âœ… Restored packGridState to window and localStorage");
                    }
                    // FIXED: Use finishedProducts field (not finishedGridState)
                    if (data.finishedProducts && typeof data.finishedProducts === 'object') {
                        window._finishedGridState = data.finishedProducts;
                        localStorage.setItem('finished_products_grid', JSON.stringify(data.finishedProducts));
                        console.log("âœ… Restored finishedProducts to window and localStorage:", Object.keys(data.finishedProducts).length, "products");
                    }
                    // FIXED: Restore stock_entries (only when cloud has entries)
                    if (data.stockEntries && typeof data.stockEntries === 'object' && Object.keys(data.stockEntries||{}).length > 0) {
                        if (!window.state) window.state = {};
                        window.state.stockEntries = data.stockEntries;
                        try { localStorage.setItem('stock_entries', JSON.stringify(data.stockEntries)); } catch(_){ }
                        console.log("âœ… Restored stockEntries to window and localStorage:", Object.keys(data.stockEntries).length, "dates");
                    } else {
                        console.log('â­ï¸ Skipped restoring stockEntries (cloud empty)');
                    }

                    // 3. Force Re-Render to show the data
                    try {
                        if (typeof renderRawMaterials === 'function') {
                            console.log("ğŸ¨ Re-rendering Raw Materials...");
                            renderRawMaterials();
                        }
                    } catch(e){ console.warn('renderRawMaterials re-render failed:', e); }
                    
                    try {
                        if (typeof renderPackaging === 'function') {
                            console.log("ğŸ¨ Re-rendering Packaging...");
                            renderPackaging();
                        }
                    } catch(e){ console.warn('renderPackaging re-render failed:', e); }
                    
                    try {
                        if (typeof renderFinishedProducts === 'function') {
                            console.log("ğŸ¨ Re-rendering Finished Products...");
                            renderFinishedProducts();
                        }
                    } catch(e){ console.warn('renderFinishedProducts re-render failed:', e); }

                    console.log("âœ… Data restored from Cloud successfully!");
                    return true;
                } else {
                    console.log('â„¹ï¸ No cloud doc found; using local data');
                    return false;
                }
            } catch (e) {
                console.error("âŒ Failed to load from cloud:", e);
                return false;
            }
        }
        function queueCloudSave(){
            if (!window.db) { console.warn('âš ï¸ queueCloudSave: Firebase not initialized'); return; }
            if (__costCloudTimer) clearTimeout(__costCloudTimer);
            __costCloudTimer = setTimeout(async ()=>{ try {
                        console.log('ğŸ”¥ Attempting to save cost lists to Firebase (settings/costLists)...');
                        // Build conditional payload to avoid overwriting server arrays with empty locals
                        const qpayload = { ops: costOps || [], updatedAt: serverTs() };
                        if (Array.isArray(costFinished) && costFinished.length>0) qpayload.finished = costFinished;
                        if (Array.isArray(costRaw) && costRaw.length>0) qpayload.raw = costRaw;
                        if (Array.isArray(costPack) && costPack.length>0) qpayload.pack = costPack;
                        await db.collection('settings').doc('costLists').set(qpayload, { merge: true });
                        console.log('âœ… Cost lists saved to Firebase (settings/costLists)', { finished: (costFinished||[]).length, raw: (costRaw||[]).length, pack: (costPack||[]).length, ops: (costOps||[]).length });
                    try{ document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { path: 'settings/costLists' } })); }catch(_){ }
                } catch(e){
                    console.warn('âš ï¸ Failed to save to settings/costLists:', e);
                    // Fallback: try saving to the user's document
                    try {
                        const uid = (auth && auth.currentUser) ? (auth.currentUser.uid || auth.currentUser.email) : null;
                        if (!uid) { console.warn('âŒ queueCloudSave fallback: no authenticated user available'); return; }
                        console.log('ğŸ”„ Falling back to save at users/{uid}.costLists...');
                        await db.collection('users').doc(uid).set({
                            costLists: {
                                finished: costFinished || [],
                                raw: costRaw || [],
                                pack: costPack || [],
                                ops: costOps || [],
                                updatedAt: serverTs()
                            }
                        }, { merge: true });
                        console.log('âœ… Cost lists saved to Firebase (users/' + uid + '.costLists)');
                        try{ document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { path: 'users/' + uid + '.costLists' } })); }catch(_){ }
                    } catch(e2){
                        console.warn('âŒ Fallback save to users/{uid}.costLists also failed:', e2);
                    }
                }
            }, 800);
        }

        // Helper function to save cost lists to Firebase (called from saveLists)
        window.saveCostListsToFirebase = async function(immediate){
            // âœ… REMOVED ADMIN CHECK - Allow all logged-in users to save inventory
            // Any authenticated user can now update inventory data
            
            if (!window.db) {
                console.warn('âš ï¸ saveCostListsToFirebase: Firebase not ready, waiting...');
                try { await waitForDbReady(5000); } catch(e) { console.warn('âš ï¸ saveCostListsToFirebase: DB wait timed out', e); }
                if (!window.db) { console.warn('âš ï¸ saveCostListsToFirebase: Firebase still not ready'); return false; }
            }
            const statusEl = document.getElementById('sync-status');
            const setStatus = (txt, visible=true) => {
                try { if (statusEl) { statusEl.textContent = txt; statusEl.classList.toggle('hidden', !visible); } } catch(_){}
            };

            // Only include arrays that have been touched or are non-empty to avoid overwriting server arrays with empty arrays
            const includeRaw = !!window.__rawTouched || ((window.costLists && Array.isArray(window.costLists.costRaw) && window.costLists.costRaw.length>0));
            const includePack = !!window.__packTouched || ((window.costLists && Array.isArray(window.costLists.costPack) && window.costLists.costPack.length>0));
            // FIXED: Check finishedGridState object instead of costFinished array
            const includeFinished = !!window.__finishedTouched || (window._finishedGridState && Object.keys(window._finishedGridState).length > 0);

            const payload = {
                ops: window.costLists?.costOps || [],
                rawGridState: window._rawGridState || {},
                packGridState: window._packGridState || {},
                // FIXED: Use finishedProducts (matches cloud listener field name)
                finishedProducts: window._finishedGridState || {},
                // FIXED: Add stock_entries to cloud payload
                stockEntries: window.state?.stockEntries || {},
                timestamp: new Date().toISOString(),
                updatedAt: serverTs()
            };
            if (includeRaw) payload.raw = window.costLists?.costRaw || [];
            if (includePack) payload.pack = window.costLists?.costPack || [];
            // FIXED: No longer save costFinished array (using finishedProducts object instead)
            // if (includeFinished) payload.finished = window.costLists?.costFinished || [];

            // Attempt immediate write with token refresh + retries
            let attempts = 0; const MAX_ATTEMPTS = 3; const BASE_DELAY = 800;
            while (attempts < MAX_ATTEMPTS) {
                attempts++;
                try {
                    setStatus('Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
                    // attempt token refresh if available (helps with stale tokens)
                    try { if (window.firebase && firebase.auth && firebase.auth().currentUser) await firebase.auth().currentUser.getIdToken(true); } catch(e){ /* ignore token refresh errors */ }
                    await db.collection('settings').doc('costLists').set(payload, { merge: true });
                    const rawCount = Array.isArray(payload.raw) ? payload.raw.length : 0;
                    const packCount = Array.isArray(payload.pack) ? payload.pack.length : 0;
                    // FIXED: Count finishedProducts object keys instead of finished array
                    const finishedCount = payload.finishedProducts ? Object.keys(payload.finishedProducts).length : 0;
                    const stockEntriesCount = payload.stockEntries ? Object.keys(payload.stockEntries).length : 0;
                    console.log('âœ… Cost lists saved to Firebase', { raw: rawCount, pack: packCount, finished: finishedCount, stockEntries: stockEntriesCount });
                    // Update local cache timestamp and grid snapshots only after cloud ack
                    try { localStorage.setItem('costLists_local_ts', payload.timestamp); } catch(_){ }
                    try { if (payload.rawGridState && Object.keys(payload.rawGridState||{}).length>0) localStorage.setItem('raw_materials_grid', JSON.stringify(payload.rawGridState||{})); } catch(_){ }
                    try { if (payload.finishedProducts && Object.keys(payload.finishedProducts||{}).length>0) localStorage.setItem('finished_products_grid', JSON.stringify(payload.finishedProducts||{})); } catch(_){ }
                    try { if (payload.stockEntries && Object.keys(payload.stockEntries||{}).length>0) localStorage.setItem('stock_entries', JSON.stringify(payload.stockEntries||{})); } catch(_){ }
                    try { if (payload.packGridState && Object.keys(payload.packGridState||{}).length>0) localStorage.setItem('packaging_grid', JSON.stringify(payload.packGridState||{})); } catch(_){ }
                    // Mirror finished products into daily_cost_lists (best-effort) so dynamic rows can be restored
                    try {
                        const finishedProductsArray = [];
                        try {
                            const fps = window._finishedGridState || {};
                            for (const k in fps) {
                                if (!Object.prototype.hasOwnProperty.call(fps, k)) continue;
                                const it = fps[k] || {};
                                finishedProductsArray.push({
                                    id: k,
                                    name: it.name || ((Array.isArray(window.costFinished) && window.costFinished.find(x=>String(x.id)===String(k))) ? (window.costFinished.find(x=>String(x.id)===String(k)).name) : ''),
                                    count: (it.actual != null ? it.actual : (it.opening != null ? it.opening : 0)),
                                    updatedAt: it.updatedAt || new Date().toISOString()
                                });
                            }
                        } catch(e){ console.warn('build finishedProductsArray failed', e); }
                        // Use the active finished-products date (YYYY-MM-DD) as the shared daily doc id
                        try {
                            const dateEl = document.getElementById('finished-products-date');
                            const dateId = (dateEl && dateEl.value) ? String(dateEl.value) : (new Date().toISOString().split('T')[0]);
                            if (dateId && Array.isArray(finishedProductsArray)) {
                                try { await db.collection('daily_cost_lists').doc(String(dateId)).set({ finished_products: finishedProductsArray, timestamp: payload.timestamp, updatedAt: serverTs() }, { merge:true }); }
                                catch(e){ console.warn('daily_cost_lists write failed', e); }
                            }
                        } catch(e){ console.warn('daily_cost_lists write (dateId) failed', e); }
                    } catch(e){ console.warn('mirror to daily_cost_lists failed', e); }
                    setStatus('Ù…ØªØ²Ø§Ù…Ù† âœ“', true);
                    setTimeout(()=> setStatus('', false), 2500);
                    return true;
                } catch (e) {
                    console.error('âŒ saveCostListsToFirebase failed (attempt ' + attempts + '):', e);
                    if (e && e.code === 'permission-denied') {
                        setStatus('Ø®Ø·Ø£ ØµÙ„Ø§Ø­ÙŠØ§Øª; Ø£Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', true);
                        console.warn('âš ï¸ Permission denied - check Firestore rules or re-login');
                        // Try to refresh auth and retry
                        try { if (firebase && firebase.auth && firebase.auth().currentUser) await firebase.auth().currentUser.getIdToken(true); } catch(_){}
                    }
                    // Exponential backoff before retry
                    if (attempts < MAX_ATTEMPTS) await new Promise(r => setTimeout(r, BASE_DELAY * attempts));
                }
            }
            setStatus('ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âŒ', true);
            return false;
        };

        // Optional realtime overlay when other clients update the document
        // REMOVED: Duplicate listener - using initRealtimeSync() instead
        function installCostListsListener(){
            console.log('âš ï¸ installCostListsListener deprecated - use initRealtimeSync()');
            return;
        }

        // Debug helper: force fetching the cloud doc and print summary alongside local timestamp
        window.forceCostListsFetch = async function(){
            try{
                try { if (!window.db) { console.warn('forceCostListsFetch: no db available'); return; } } catch(_){ console.warn('forceCostListsFetch: window.db check failed'); return; }
                const ref = db.collection('settings').doc('costLists');
                const snap = await ref.get();
                const localTs = localStorage.getItem('costLists_local_ts') || null;
                console.log('forceCostListsFetch: localTs', localTs);
                if(!snap.exists){ console.log('forceCostListsFetch: cloud doc not found'); return; }
                const d = snap.data() || {};
                const cloudTs = d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null;
                console.log('forceCostListsFetch: cloud summary', { cloudTs, finished: Array.isArray(d.finished) ? d.finished.length : 0, raw: Array.isArray(d.raw) ? d.raw.length : 0, pack: Array.isArray(d.pack) ? d.pack.length : 0, ops: Array.isArray(d.ops) ? d.ops.length : 0, doc: d });
            } catch(e){ console.warn('forceCostListsFetch failed', e); }
        };

        function renderListsSummary(){
            const el = document.getElementById('cost-lists-summary');
            if(!el) return;
            el.textContent = `Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù…Ø©: ${costFinished.length} â€” Ø§Ù„Ø®Ø§Ù…Ø§Øª: ${costRaw.length} â€” ØªØºÙ„ÙŠÙ: ${costPack.length}`;
        }

        // If finished list empty, populate from app state products for convenience
        function ensureFinishedFromState(){
            try{
                if(Array.isArray(costFinished) && costFinished.length === 0){
                    const src = (Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
                    if(src && src.length){
                        src.forEach(p => {
                            const id = p.id || p.code || ('prod-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                            costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'Ù‚Ø·Ø¹Ø©', price: Number(p.price||p.sellPrice||0) });
                        });
                        saveLists();
                    }
                }
            }catch(e){ console.warn('ensureFinishedFromState failed', e); }
        }

        // If raw/pack lists empty, try to populate them from `state.products` (stock-control)
        function ensureRawAndPackFromState(){
            try{
                console.log('ensureRawAndPackFromState START: costRaw=' + (costRaw||[]).length + ', costPack=' + (costPack||[]).length);
                if(Array.isArray(state && state.products) && state.products.length){
                    // populate raw
                    if(Array.isArray(costRaw) && costRaw.length === 0){
                        state.products.forEach(p => {
                            const cat = (p && p.category) ? String(p.category).toLowerCase() : '';
                            if(cat.includes('Ø®Ø§Ù…') || cat.includes('Ù…ÙƒÙˆÙ†Ø§Øª') || cat.includes('Ù…Ø§Ø¯Ø©')){
                                const id = p.id || p.code || ('raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                                costRaw.push({ id, code: id, name: p.name || p.title || p.code || '', unit: p.unit || p.unitName || '' });
                            }
                        });
                    }
                    // populate pack
                    if(Array.isArray(costPack) && costPack.length === 0){
                        state.products.forEach(p => {
                            const cat = (p && p.category) ? String(p.category).toLowerCase() : '';
                            if(cat.includes('ØªØ¹Ø¨Ø¦Ø©') || cat.includes('ØªØºÙ„ÙŠÙ') || cat.includes('Ø¹Ø¨ÙˆØ©') || cat.includes('ÙƒÙŠØ³') || cat.includes('ÙˆØ±Ù‚')){
                                const id = p.id || p.code || ('pack-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                                costPack.push({ id, code: id, name: p.name || p.title || p.code || '', unit: p.unit || p.unitName || '' });
                            }
                        });
                    }
                    // persist if we added items
                    if((Array.isArray(costRaw) && costRaw.length>0) || (Array.isArray(costPack) && costPack.length>0)){
                        try{ saveLists(true); }catch(_){ }
                    }
                }
                // Ensure built-in lists are present: add any missing built-in raw/pack names
                const builtInRaw = [
                    'Ù„Ø¨Ù† Ø¨ÙˆØ¯Ø±Ø©',
                    'Ø¨Ø±ÙˆØªÙŠÙ† Ù…Ø±ÙƒØ²',
                    'Ø¨Ø¯ÙŠÙ„ Ø²Ø¨Ø¯Ø©',
                    'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 200',
                    'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 100',
                    'Ø§Ù†Ø§ØªÙˆ',
                    'ÙƒÙ„ÙˆØ±ÙÙŠÙ„',
                    'S20',
                    'B3',
                    'Ù†ÙŠØ§Ø³ÙŠÙ†',
                    'Ù†ØªØ§Ù…ÙŠØ³ÙŠÙ†',
                    'Ø³ÙˆØ±Ø¨Ø§Øª Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…',
                    'ÙƒÙ„ÙˆØ±ÙŠØ¯ ÙƒØ§Ù„Ø³ÙŠÙˆÙ…',
                    'Ù…Ù†ÙØ­Ø© Ù…ÙŠÙƒØ±ÙˆØ¨ÙŠØ©',
                    'GDL',
                    'Ø¯ÙŠØ±Ù‰ Ø¬ÙŠÙ„ 121',
                    'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…',
                    'Ø§Ù†ØªÙ‰ ÙÙˆÙ…',
                    'Ù†Ø´Ø§',
                    'Ù…ÙŠØ§Ù‡',
                    'ÙƒØ±ÙŠÙ…Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰',
                    'ÙƒØ±ÙŠÙ…Ø© Ø¨Ù‚Ø±Ù‰',
                    'CR 15',
                    'ÙØ§Ù†ÙŠÙ„ÙŠØ§',
                    'Ù…Ø³ØªÙƒØ©',
                    'Ù…ÙŠØ§Ù‡ ÙˆØ±Ø¯',
                    'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 21',
                    'Ù„Ø§ÙƒØªÙ‡ 810',
                    'Ø§ÙŠØ³ ÙƒØ±ÙŠÙ… Ø¨ÙˆØ¯Ø±Ø©',
                    'ÙƒØ±ÙŠÙ… Ø´Ø§Ù†ØªÙŠÙ‡ Ø¨ÙˆØ¯Ø±',
                    'Ø³ÙƒØ±',
                    'Ø§Ø±Ø²',
                    'Ø·Ø¹Ù… Ø§Ù„Ø´ÙŠØ¯Ø±',
                    'Ø·Ø¹Ù… Ø§Ù„Ø±ÙˆÙ…Ù‰',
                    'Ø·Ø¹Ù… Ø¬ÙˆØ¯Ø©',
                    'Ø·Ø¹Ù… Ø§Ù„Ù†Ø³ØªÙˆ',
                    'Ù…Ù„Ø­ Ù„ÙŠÙ…ÙˆÙ†',
                    'Ø®Ø§Ù…Ø§Øª Ø­ÙØ¸ Ø§Ù„Ù…Ø´',
                    'ØµÙˆØµ Ù…Ø´',
                    'ØµÙˆØ¯Ø§ ÙƒØ§ÙˆÙŠØ©',
                    'Ø·Ø¹Ù… Ø²Ø¨Ø¯Ø©',
                    'Ø·Ø¹Ù… ÙƒØ±ÙŠÙ…Ø©',
                    'Ù„Ø§ÙƒØªØ© 815',
                    'Ù„Ø§ÙƒØªØ© 825',
                    'Ø§ÙƒØ³Ø¬ÙŠÙ†',
                    'ÙƒØ±Ø¨ÙˆÙ†Ø§Øª',
                    'Ø·Ø¹Ù… Ø­Ù„ÙŠØ¨',
                    'Ø¨Ø§Ø¯Ù‰ Ø²Ø¨Ø§Ø¯Ù‰',
                    'Ù‡Ø§Ù‰ ÙƒØ±ÙŠÙ… 500',
                    'Ø·Ø¹Ù… Ù‚Ø´Ø·Ø©',
                    'Ù„Ø¨Ù† Ø®Ø§Ù„Ù‰ Ø§Ù„Ø¯Ø³Ù…',
                    'Ø·Ø¹Ù… Ø¬Ø¨Ù†Ø© Ù‚Ø¯ÙŠÙ…Ø©',
                    'Ø­Ø§Ù…Ø¶',
                    'Ø³Ù„ÙØ§Øª ØµÙˆØ¯ÙŠÙˆÙ…',
                    'Ø·Ø¹Ù… Ø§Ù…Ù†ØªØ§Ù„',
                    'Ø·Ø¹Ù… Ø´ÙŠØ¯Ø± Ø²Ø¨Ø¯Ø©',
                    'Ø¨Ø±ÙˆÙƒØ³Ø§ÙŠØ¯',
                    'Ø´Ø·Ø© Ø­Ù…Ø±Ø§Ø¡',
                    'Ø¬Ø¨Ù†Ù‡ Ø±ÙˆÙ…Ù‰ Ù…Ø¨Ø´ÙˆØ±',
                    'ÙƒØ±ÙŠÙ…ÙˆØ³200',
                    'Ø²ÙŠØª Ø¹Ø¨Ø§Ø¯',
                    'Ù„Ø§ÙƒØªØ© s33',
                    'Ø·Ø¹Ù… Ø³Ù…Ù† Ø¨Ù„Ø¯Ù‰',
                    'Ø³ØªØ±ÙŠÙƒ Ø§Ø³ÙŠØ¯',
                    'Ù…Ø¹Ù‚Ù… ÙŠØ¯',
                    'Ø§Ø³ÙŠØªÙˆÙ†',
                    'Ù…ÙƒØ³Ø¨ Ø·Ø¹Ù… ÙƒØ±ÙŠÙ…Ø©',
                    'Ù„ÙˆÙ† Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ© ØºØ§Ù…Ù‚'
                ];
                const builtInPack = [
                    'Ø§Ø³ØªÙŠÙƒØ± Ù‚Ø´Ø·Ø©','Ø§Ø·Ø¨Ø§Ù‚ Ø´Ø±Ø´','Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ ÙƒØ±ÙŠÙ…Ù‰ 3Ùƒ','Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ ÙƒØ±ÙŠÙ…Ù‰ 8Ùƒ','Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ Ù‚Ø·Ø¹ 3Ùƒ','Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ Ù‚Ø·Ø¹ 8Ùƒ','Ø¬Ø±Ø¯Ù„ ÙØ§Ø±Øº 8Ùƒ','Ø¬Ø±Ø¯Ù„ ÙØ§Ø±Øº 3Ùƒ','Ø¨Ø±Ø·Ù…Ø§Ù† 800 Ø¬Ù…','Ø¨Ø±Ø·Ù…Ø§Ù† 500 Ø¬Ù…','Ø¨Ø±Ø·Ù…Ø§Ù† 300 Ø¬Ù…','Ø¨Ø±Ø·Ù…Ø§Ù† 200 Ø¬Ù…','Ø§ÙƒÙŠØ§Ø³ Ø´ÙØ§Ù 27*45','Ø´Ù†Ø· ÙˆØ³Ø· Ø³Ø§Ø¯Ø©','Ø´Ù†Ø· ÙƒØ¨ÙŠØ± Ø³Ø§Ø¯Ø©','Ø´Ù†Ø· ØµØºÙŠØ± Ø³Ø§Ø¯Ø©','Ø§ÙƒÙŠØ§Ø³ Ù„Ø¨Ù† Ø´ÙØ§Ù 1Ùƒ','Ø§ÙƒÙŠØ§Ø³ Ù„Ø¨Ù† Ø´ÙØ§Ù 2Ùƒ','Ø§ÙƒÙŠØ§Ø³ Ù„Ø¨Ù† Ø´ÙØ§Ù 500 Ø¬Ù…','Ø·Ø¨Ù‚ Ø¨Ù„Ø§Ø³ØªÙŠÙƒ 1Ùƒ','Ø·Ø¨Ù‚ Ø¨Ù„Ø§Ø³ØªÙŠÙƒ 500 Ø¬Ù…','Ø¹Ù„Ø¨Ø© Ø¨Ù„Ø§Ø³ØªÙŠÙƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡ 250 Ø¬Ù…','Ø¹Ù„Ø¨Ø© Ø¨Ù„Ø§Ø³ØªÙŠÙƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡ 125 Ø¬Ù…','Ù…Ù†Ø§Ø¯ÙŠÙ„ 40*40','Ù…Ù†Ø§Ø¯ÙŠÙ„ 70-70','Ø±ÙˆÙ„ Ø§Ø³ØªØ±ØªØ´ 40Ø³Ù…','Ø±ÙˆÙ„ Ø§Ø³ØªØ±ØªØ´ 10 Ø³Ù…','ÙƒÙŠØ³ Ù…Ø¹Ø§Ù„Ù‚','ÙƒÙŠØ³ Ø´Ø±Ù†Ùƒ','Ø¹Ù„Ø¨Ø© Ø´ÙØ§Ù ÙƒØ¨ÙŠØ±','ØºØ·Ø§Ø¡ Ø´ÙØ§Ù ÙƒØ¨ÙŠØ±','Ø¹Ù„Ø¨Ø© Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡ Ø³Ø§Ø¯Ø©','ØºØ·Ø§Ø¡ Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡ Ø³Ø§Ø¯Ø©','ÙƒØ±ØªÙˆÙ†Ø© ØªØ¹Ø¨Ø£Ø©','ÙØ®Ø§Ø± Ø²Ø¨Ø§Ø¯Ù‰','ÙØ®Ø§Ø± Ø§Ø±Ø²','Ø¹Ù„Ø¨ Ø²Ø¨Ø§Ø¯Ù‰ Ø¨Ø§Ù„ØºØ·Ø§Ø¡','Ø¬ÙˆØ§Ù†ØªÙ‰ Ø¹Ù„Ø¨Ø©','Ø¬ÙˆØ§Ù†ØªÙ‰ ÙƒÙŠØ³','Ø§ÙˆÙØ± Ø´ÙˆØ²','Ø§ÙˆÙØ± Ù‡ÙŠØ¯ Ø¨Ø§ÙƒØª','ÙƒÙ…Ø§Ù…Ù‡','Ø´Ø±Ø§Ø¨','Ø³Ù„ÙˆØªÙŠØ¨ Ø¹Ø±ÙŠØ¶','Ø¨ÙƒØ± Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø­Ø±Ø§Ø±Ù‰','Ø¨Ø§Ø±ÙƒÙˆØ¯ ØµØºÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ù‡','Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙƒØ¨ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ù‡','ÙÙ„ØªØ± Ù…Ø­Ù„Ø¨','Ø§ÙŠØ³ Ø¨ÙˆÙƒØ³'
                ];
                // add any missing built-in raw names (avoid duplicates, case-insensitive)
                try{
                    let addedRaw = 0;
                    const existingRawNames = new Set((costRaw||[]).map(x => String((x && (x.name||x)) || '').trim().toLowerCase()));
                    builtInRaw.forEach((n,i) => {
                        const key = String(n||'').trim().toLowerCase();
                        if(!key) return;
                        if(!existingRawNames.has(key)){
                            const id = 'builtinraw-' + i + '-' + Date.now().toString(36).slice(4);
                            costRaw.push({ id, code: id, name: n, unit: '' });
                            existingRawNames.add(key);
                            addedRaw++;
                        }
                    });

                    let addedPack = 0;
                    const existingPackNames = new Set((costPack||[]).map(x => String((x && (x.name||x)) || '').trim().toLowerCase()));
                    builtInPack.forEach((n,i) => {
                        const key = String(n||'').trim().toLowerCase();
                        if(!key) return;
                        if(!existingPackNames.has(key)){
                            const id = 'builtinpack-' + i + '-' + Date.now().toString(36).slice(4);
                            costPack.push({ id, code: id, name: n, unit: '' });
                            existingPackNames.add(key);
                            addedPack++;
                        }
                    });

                    if(addedRaw>0 || addedPack>0){
                        try{ saveLists(true); }catch(_){ }
                        console.log('ensureRawAndPackFromState: added built-in items', { addedRaw, addedPack, totalRaw: (costRaw||[]).length, totalPack: (costPack||[]).length });
                    }
                    // Always sync to window for autocomplete access
                    try { window.costRaw = costRaw; window.costPack = costPack; } catch(_){ }
                    console.log('Cost lists synced to window. Totals:', 'costRaw=' + (costRaw||[]).length, 'costPack=' + (costPack||[]).length);
                }catch(e){ console.warn('ensureRawAndPackFromState built-in merge failed', e); }
            }catch(e){ console.warn('ensureRawAndPackFromState failed', e); }
        }

        // Expose a helper to manually import raw/pack lists from stock-control (callable from console)
        try {
            window.importCostListsFromStockControl = function(){
                try{
                    ensureRawAndPackFromState();
                    console.log('importCostListsFromStockControl: done.');
                    // renderQuickLists and renderPriceManager removed - features deleted
                } catch(e) { console.warn('importCostListsFromStockControl failed', e); }
            };
            window.clearCostListsAndReimport = function(){
                try {
                    console.log('Clearing cost lists from localStorage and re-importing...');
                    localStorage.removeItem('cost_raw');
                    localStorage.removeItem('cost_pack');
                    // Reset in-memory
                    costRaw = [];
                    costPack = [];
                    window.costRaw = [];
                    window.costPack = [];
                    // Re-trigger the import
                    try{ if (typeof loadLists === 'function') loadLists(); }catch(_){ }
                    try{ if (typeof loadLists === 'function') loadLists(); }catch(_){ }
                    try{ ensureRawAndPackFromState(); }catch(_){ }
                    // renderPriceManager and renderQuickLists removed - features deleted
                    console.log('Re-import complete. Totals:', 'costRaw=' + (window.costRaw||[]).length, 'costPack=' + (window.costPack||[]).length);
                } catch(e) { console.warn('clearCostListsAndReimport failed', e); }
            };
        } catch(e) {}

        function renderProductSelect(){
            const sel = document.getElementById('cost-product-select');
            if(!sel) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ ØªØ§Ù…...</option>' + costFinished.map(p => `<option value="${escapeHtml(p.id||p.code||p.name)}">${escapeHtml(p.name||p.code)}</option>`).join('');
            if(prev) sel.value = prev;
        }

        // Render left product list (searchable) with quick select buttons
        function renderProductList(filter){
            const container = document.getElementById('cost-product-list'); if(!container) return;
            container.innerHTML = '';
            const q = String(filter || '').trim().toLowerCase();
            const items = (costFinished || []).filter(p => {
                if(!q) return true;
                return (String(p.name||'').toLowerCase().includes(q) || String(p.code||'').toLowerCase().includes(q));
            });
            if(items.length === 0){ container.innerHTML = '<div class="p-2 text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>'; return; }
            items.forEach(p => {
                const el = document.createElement('div');
                el.className = 'p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                el.innerHTML = `<div><div class="font-medium text-sm">${escapeHtml(p.name)}</div><div class="text-xs text-gray-500">${escapeHtml(p.code||'')}</div></div><div><button class="select-product-btn bg-blue-500 text-white px-2 py-1 rounded" data-id="${escapeHtml(p.id)}">Ø§Ø®ØªØ§Ø±</button></div>`;
                container.appendChild(el);
            });
        }

        function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        // Manage lists modal helpers
        function openManageListsModal(){
            console.log('openManageListsModal: start');
            // show modal immediately to avoid perceived freeze, populate tables asynchronously
            const m = document.getElementById('manage-lists-modal');
            if(m){ m.classList.remove('modal-hidden'); m.classList.add('modal-visible'); }
            // render content a bit later so modal appears first
            setTimeout(()=>{ try{ console.log('openManageListsModal: calling renderManageListsTables'); renderManageListsTables(); }catch(e){ console.warn('renderManageListsTables failed', e); } }, 40);
        }
    function closeManageListsModal(){ const m = document.getElementById('manage-lists-modal'); if(m){ m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); } }
    // expose to global so inline onclick works
    try{ window.openManageListsModal = openManageListsModal; window.closeManageListsModal = closeManageListsModal; }catch(e){}

        function renderManageListsTables(){
            // prepare progress UI
            const progressEl = document.getElementById('manage-lists-progress');
            const totalItems = (Array.isArray(costFinished)?costFinished.length:0) + (Array.isArray(costRaw)?costRaw.length:0) + (Array.isArray(costPack)?costPack.length:0);
            let processed = 0;
            if(progressEl){
                if(totalItems === 0){ progressEl.style.display = 'none'; } else { progressEl.style.display = 'block'; progressEl.textContent = `Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± 0 / ${totalItems}`; }
            }

            // chunked renderer with a small immediate batch and small async batches (safer for large lists)
            function chunkRender(items, tbody, rowRenderer, firstSync = 10, batchSize = 20){
                tbody.innerHTML = '';
                if(!items || items.length === 0) return;
                let i = 0;
                // initial synchronous batch
                const initial = Math.min(firstSync, items.length);
                const t0 = Date.now();
                for(; i < initial; i++){
                    const tr = rowRenderer(items[i]);
                    tbody.appendChild(tr);
                    processed++;
                }
                const t1 = Date.now();
                console.log('chunkRender: initial batch', { initial, timeMs: t1 - t0, processed, totalItems });
                if(progressEl) progressEl.textContent = `Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± ${processed} / ${totalItems}`;
                if(i >= items.length) return;

                function nextBatch(){
                    const batchStart = Date.now();
                    const end = Math.min(i + batchSize, items.length);
                    let batchCount = 0;
                    for(; i < end; i++){
                        const tr = rowRenderer(items[i]);
                        tbody.appendChild(tr);
                        processed++; batchCount++;
                    }
                    const batchEnd = Date.now();
                    console.log('chunkRender: batch appended', { batchCount, timeMs: batchEnd - batchStart, processed, totalItems });
                    if(progressEl) progressEl.textContent = `Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± ${processed} / ${totalItems}`;
                    if(i < items.length){
                        setTimeout(nextBatch, 25);
                    }
                }
                setTimeout(nextBatch, 25);
            }

            console.log('renderManageListsTables: starting render', { finished: costFinished.length, raw: costRaw.length, pack: costPack.length });

            const tf = document.querySelector('#manage-finished-table tbody');
            if(tf){ chunkRender(costFinished, tf, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.price||it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="finished" data-id="${escapeHtml(it.id)}">Ø­Ø°Ù</button></td>`;
                    return tr;
                }, 10, 20);
            }

            const trw = document.querySelector('#manage-raw-table tbody');
            if(trw){ chunkRender(costRaw, trw, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="raw" data-id="${escapeHtml(it.id)}">Ø­Ø°Ù</button></td>`;
                    return tr;
                }, 10, 20);
            }

            const tpk = document.querySelector('#manage-pack-table tbody');
            if(tpk){ chunkRender(costPack, tpk, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="pack" data-id="${escapeHtml(it.id)}">Ø­Ø°Ù</button></td>`;
                    return tr;
                }, 10, 20);
            }

            // hide progress once everything is appended (polling check)
            const poll = setInterval(() => {
                if(processed >= totalItems){
                    clearInterval(poll);
                    if(progressEl) { progressEl.textContent = `Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (${totalItems} Ø¹Ù†ØµØ±)`; setTimeout(()=>{ if(progressEl) progressEl.style.display = 'none'; }, 700); }
                    console.log('renderManageListsTables: finished rendering all items', { totalItems });
                }
            }, 200);
        }

        function deleteListItem(listName, id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) return;
            if(listName === 'finished'){ costFinished = costFinished.filter(x=>String(x.id)!==String(id)); }
            if(listName === 'raw'){ costRaw = costRaw.filter(x=>String(x.id)!==String(id)); }
            if(listName === 'pack'){ costPack = costPack.filter(x=>String(x.id)!==String(id)); }
            saveLists(); renderManageListsTables();
        }

        // export lists as JSON for download
        function exportLists(){ const payload = { finished: costFinished, raw: costRaw, pack: costPack, exportedAt: new Date().toISOString() }; const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = 'cost-lists-export.json'; document.body.appendChild(a); a.click(); a.remove(); }

        // Manage modal click handlers
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'manage-export-btn'){ exportLists(); }
            const delBtn = e.target && e.target.closest && e.target.closest('.manage-del-btn');
            if(delBtn){ const list = delBtn.getAttribute('data-list'); const id = delBtn.getAttribute('data-id'); if(list && id) deleteListItem(list, id); }
        });

        // Raw price registry handlers
        function renderRawPriceTable(){
            const tbody = document.querySelector('#raw-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costRaw || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.cost !== undefined ? it.cost : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="raw-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center raw-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="raw-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">Ø­ÙØ¸</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderFinishedPriceTable(){
            const tbody = document.querySelector('#finished-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costFinished || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.price !== undefined ? it.price : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="finished-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center finished-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="finished-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">Ø­ÙØ¸</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderPackPriceTable(){
            const tbody = document.querySelector('#pack-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costPack || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.cost !== undefined ? it.cost : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="pack-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center pack-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="pack-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">Ø­ÙØ¸</button></td>`;
                tbody.appendChild(tr);
            });
        }

        // ===== Price Manager (tables + history) =====
        function pmFormatDate(iso){ try { return iso ? new Date(iso).toLocaleString('ar-EG') : ''; } catch(_){ return ''; } }
        function getListByType(t){ return t==='raw'?costRaw : (t==='pack'?costPack : (t==='finished'?costFinished : costOps)); }
        function setListByType(t, arr){ if(t==='raw') costRaw = arr; else if(t==='pack') costPack = arr; else if(t==='finished') costFinished = arr; else costOps = arr; }
        // Expose helpers globally for other script sections that run outside this IIFE
        try { window.getListByType = getListByType; window.setListByType = setListByType; } catch(_){ }

        // Transient message/toast helper
        function showTransientMessage(msg, ms){
            try{
                const id = 'transient-msg';
                let el = document.getElementById(id);
                if(!el){
                    el = document.createElement('div'); el.id = id;
                    el.style.position = 'fixed'; el.style.right = '16px'; el.style.top = '70px'; el.style.zIndex = 9999;
                    el.style.background = 'rgba(0,0,0,0.8)'; el.style.color = '#fff'; el.style.padding = '8px 12px'; el.style.borderRadius = '6px'; el.style.fontSize = '13px';
                    document.body.appendChild(el);
                }
                el.textContent = msg;
                el.style.display = 'block';
                if(ms && ms>0){ setTimeout(()=>{ try{ el.style.display='none'; }catch(_){ } }, ms); }
            }catch(_){ console.log(msg); }
        }

        // Listen for cloud-save event to show confirmation and debug raw item persistence
        document.addEventListener('costListsSavedToCloud', function(ev){
            try{
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', ev && ev.detail);
                showTransientMessage('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 2500);
                // Debug: if we recently edited a raw item, print it from localStorage and in-memory
                try{
                    const lastId = window.__lastRawEditedId || null;
                    if(lastId){
                        let rawJson = null;
                        try{ rawJson = localStorage.getItem('cost_raw'); }catch(_){ }
                        let parsed = null;
                        try{ parsed = rawJson ? JSON.parse(rawJson) : null; }catch(_){ parsed = null; }
                        const found = Array.isArray(parsed) ? parsed.find(x=>String(x.id)===String(lastId)) : null;
                        console.log('ğŸ” post-cloud-save: lastRawEditedId=', lastId, 'inMemory=', (costRaw||[]).find(x=>String(x.id)===String(lastId)), 'localStorage=', found, 'rawLength=', (parsed||[]).length);
                    }
                }catch(_){ }
            }catch(_){ }
        });

        // Enter key handler for raw price inputs: save on Enter and show saving toast
        document.addEventListener('keydown', function(e){
            if(!e) return;
            const key = e.key || (e.keyCode ? (e.keyCode===13 ? 'Enter' : '') : '');
            if(key !== 'Enter') return;
            const target = e.target || document.activeElement;
            if(!target) return;
            if(target.classList && target.classList.contains('raw-price-input')){
                const id = target.getAttribute('data-id');
                if(id){
                    try{ console.log('â Enter pressed in raw input, saving...', { id }); }catch(_){ }
                    try{ showTransientMessage('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...', 2000); }catch(_){ }
                    try{ saveRawPriceRow(id); }catch(err){ console.warn('saveRawPriceRow failed', err); }
                }
            }
        });

        // Simple history modal
        function openPriceHistory(type, id){
            const list = getListByType(type);
            const it = list.find(x=> String(x.id)===String(id));
            if(!it) return alert('Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            const modal = document.getElementById('price-history-modal'); if(!modal) return;
            const title = modal.querySelector('#ph-title');
            const tbody = modal.querySelector('#ph-body');
            if(title) title.textContent = `Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± â€” ${it.name||id}`;
            const esc = s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const hist = Array.isArray(it.priceHistory)? it.priceHistory : [];
            tbody.innerHTML = hist.length ? hist.map(h=> `<tr><td class="px-2 py-1 text-center">${Number(h.price||0).toFixed(2)}</td><td class="px-2 py-1 text-center">${esc(pmFormatDate(h.date))}</td><td class="px-2 py-1 text-right">${esc(h.note||'')}</td></tr>`).join('') : '<tr><td colspan="3" class="px-2 py-3 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø£Ø³Ø¹Ø§Ø±</td></tr>';
            modal.setAttribute('data-type', type);
            modal.setAttribute('data-id', id);
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }
        function closePriceHistory(){ const m = document.getElementById('price-history-modal'); if(!m) return; m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); }
        function addPriceFromModal(){
            const m = document.getElementById('price-history-modal'); if(!m) return;
            const type = m.getAttribute('data-type'); const id = m.getAttribute('data-id');
            const priceInp = m.querySelector('#ph-new-price'); const noteInp = m.querySelector('#ph-new-note');
            const v = parseFloat(priceInp.value||0) || 0; const note = noteInp.value.trim();
            const list = getListByType(type); const it = list.find(x=> String(x.id)===String(id)); if(!it) return;
            const now = new Date().toISOString();
            it.lastPrice = v; it.lastPriceDate = now;
            it.priceHistory = Array.isArray(it.priceHistory) ? it.priceHistory : [];
            it.priceHistory.unshift({ price: v, date: now, note });
            saveLists(); // renderPriceManager() removed - feature deleted
            // refresh modal body
            openPriceHistory(type, id);
            // clear inputs
            priceInp.value = ''; noteInp.value = '';
        }

        // Wire price manager events
        document.addEventListener('click', function(e){
            // New buttons for PM
            // New buttons for PM
            // Price manager buttons removed - feature deleted
            // if(e.target && e.target.id === 'pm-refresh-btn'){ renderPriceManager(); }
            // if(e.target && e.target.id === 'pm-export-json-btn'){ pmExportJSON(); }
            // if(e.target && e.target.id === 'pm-export-csv-btn'){ pmExportCSV(); }
            // if(e.target && e.target.id === 'pm-print-btn'){ pmPrint(); }tem(); }
            // Price manager buttons removed - feature deleted
            // const tabBtn = e.target && e.target.closest && e.target.closest('#price-manager-block .pm-tab');
            // if(tabBtn){ pmSwitchTo(tabBtn.getAttribute('data-pm-tab')); }
            // const addBtn = e.target && e.target.closest && e.target.closest('.pm-add-price'); if(addBtn){ pmAddPrice(addBtn.getAttribute('data-type'), addBtn.getAttribute('data-id')); }
            const histBtn = e.target && e.target.closest && e.target.closest('.pm-view-history'); if(histBtn){ openPriceHistory(histBtn.getAttribute('data-type'), histBtn.getAttribute('data-id')); }
            if(e.target && e.target.id === 'ph-close-btn'){ closePriceHistory(); }
            if(e.target && e.target.id === 'ph-add-btn'){ addPriceFromModal(); }
        });

        // Install cloud listener after Firebase is ready
        function waitForDbReady(timeoutMs = 5000){
            return new Promise((resolve, reject) => {
                const start = Date.now();
                if (window.db) return resolve(window.db);
                const iv = setInterval(() => {
                    if (window.db) { clearInterval(iv); return resolve(window.db); }
                    if (Date.now() - start > timeoutMs) { clearInterval(iv); return reject(new Error('DB ready timeout')); }
                }, 150);
            });
        }

        document.addEventListener('DOMContentLoaded', function(){ 
            // Cloud-first initialization: attach realtime listener immediately so the app
            // receives authoritative data from Firestore (settings/costLists). LocalStorage
            // is kept only as a cache/fallback, not the source of truth.
            console.log('ğŸ“‹ DOMContentLoaded: Initializing cost lists (cloud-first realtime listener)...');
            try {
                // Wait a short while for firebase init to complete so we don't register listeners
                // before the Firebase app and `db` are available (avoids app-compat/no-app errors).
                waitForDbReady(3000).then(() => {
                    try {
                        initRealtimeSync();
                    } catch(e){ console.warn('âš ï¸ DOMContentLoaded: initRealtimeSync() failed', e); }
                }).catch(err => {
                    console.warn('âš ï¸ DOMContentLoaded: DB not ready, skipping realtime listener:', err);
                    // Fallback: render from local cache if cloud hasn't arrived
                    try { if (!window.dataLoaded) { console.log('âš ï¸ No cloud data yet, falling back to local cache for UI rendering'); loadLists(); } } catch(e){ console.warn('âš ï¸ fallback loadLists failed', e); }
                    try { tryLoadCostListsFromCloud().catch(()=>{}); } catch(_){ }
                });

                // If realtime doesn't provide data within a short timeout, fall back to local cache
                setTimeout(() => {
                    try {
                        if (!window.dataLoaded) {
                            console.log('âš ï¸ No cloud data yet (post-wait), falling back to local cache for UI rendering');
                            try { loadLists(); } catch(e){ console.warn('âš ï¸ fallback loadLists failed', e); }
                            try { tryLoadCostListsFromCloud().catch(()=>{}); } catch(_){ }
                        }
                    } catch(_){ }
                }, 1200);
            } catch(e){ console.warn('âš ï¸ DOMContentLoaded: cost lists cloud-first init failed', e); }
        });

        // ===== Unified Price Grid Renderer =====
        function renderUnifiedPriceGrid(){
            const wrap = document.getElementById('unified-price-grid-block'); if(!wrap) return;
            const tbody = document.querySelector('#unified-price-grid tbody'); if(!tbody) return;
            const esc = s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const all = [];
            // Build items from the canonical global arrays (window.*) to ensure latest persisted values are shown
            (window.costRaw || []).forEach(it=> all.push({type:'Ø®Ø§Ù…Ø©', item:it}));
            (window.costPack || []).forEach(it=> all.push({type:'ØªØºÙ„ÙŠÙ', item:it}));
            (window.costOps || []).forEach(it=> all.push({type:'ØªØ´ØºÙŠÙ„', item:it}));
            (window.costFinished || []).forEach(it=> all.push({type:'Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠ', item:it}));
            // sort alphabetically by type then name (Arabic aware)
            all.sort((a,b)=> {
                const typeCmp = a.type.localeCompare(b.type,'ar');
                if(typeCmp !== 0) return typeCmp;
                return String(a.item.name||'').localeCompare(String(b.item.name||''),'ar');
            });
            tbody.innerHTML = all.map(row => {
                const it = row.item;
                const last = (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:''));
                const date = it.lastPriceDate ? pmFormatDate(it.lastPriceDate) : '';
                return `<tr>
                    <td class="px-2 py-1 text-right">${esc(it.name||'')}</td>
                    <td class="px-2 py-1 text-center">
                        <span class="unified-code inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${esc(it.code||it.id||'')}</span>
                    </td>
                    <td class="px-2 py-1 text-center">${esc(row.type)}</td>
                    <td class="px-2 py-1 text-center">${esc(it.unit||'')}</td>
                    <td class="px-2 py-1 text-center">
                        <span class="unified-current-price inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${last!==''?Number(last).toFixed(2):''}</span>
                    </td>
                    <td class="px-2 py-1 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <input class="unified-new-price w-20 p-1 border rounded text-center text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}" placeholder="0.00" />
                            <button class="unified-save-price bg-blue-600 text-white px-2 py-0.5 rounded text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}">Ø­ÙØ¸</button>
                        </div>
                    </td>
                    <td class="px-2 py-1 text-center">${esc(date)}</td>
                </tr>`;
            }).join('');
            const sumEl = document.getElementById('unified-grid-summary');
            if(sumEl) sumEl.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${all.length} Ø¹Ù†ØµØ±`;
        }

        // Export helpers
        function unifiedExportJSON(){
            const payload = { raw: costRaw, pack: costPack, ops: costOps, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'unified-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function unifiedExportCSV(){
            const rows = [];
            rows.push(['type','name','unit','currentPrice','lastDate']);
            const pushRows = (arr,type)=> (arr||[]).forEach(it=> rows.push([
                type,
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            pushRows(costRaw,'raw'); pushRows(costPack,'pack'); pushRows(costOps,'ops');
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'unified-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function unifiedPrint(){
            const block = document.getElementById('unified-price-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderUnifiedPriceGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        // Export functions for Raw, Pack, Ops unified grids
        function rawUnifiedExportJSON(){
            const payload = { raw: costRaw, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'raw-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function rawUnifiedExportCSV(){
            const rows = [];
            rows.push(['name','unit','currentPrice','lastDate']);
            (costRaw||[]).forEach(it=> rows.push([
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'raw-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function rawUnifiedPrint(){
            const block = document.getElementById('raw-unified-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderRawUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        function packUnifiedExportJSON(){
            const payload = { pack: costPack, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'pack-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function packUnifiedExportCSV(){
            const rows = [];
            rows.push(['name','unit','currentPrice','lastDate']);
            (costPack||[]).forEach(it=> rows.push([
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'pack-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function packUnifiedPrint(){
            const block = document.getElementById('pack-unified-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderPackUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        function opsUnifiedExportJSON(){
            const payload = { ops: costOps, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'ops-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function opsUnifiedExportCSV(){
            const rows = [];
            rows.push(['name','unit','currentPrice','lastDate']);
            (costOps||[]).forEach(it=> rows.push([
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'ops-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function opsUnifiedPrint(){
            const block = document.getElementById('ops-unified-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderOpsUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        // Small helper to show a transient "Saved" indicator next to an element
        function showSavedIndicator(el, text){
            try{
                const label = document.createElement('span');
                label.className = 'unified-saved-indicator';
                label.style.cssText = 'display:inline-block;margin-left:8px;color:#16a34a;font-size:12px;font-weight:600;opacity:0;transition:opacity .18s';
                label.textContent = text || 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
                // place after element (if element is inside container) or append to parent
                if(el && el.parentNode){
                    // remove any existing indicator near this element
                    const existing = el.parentNode.querySelector('.unified-saved-indicator');
                    if(existing) existing.remove();
                    el.parentNode.appendChild(label);
                    // force fade-in
                    setTimeout(()=> label.style.opacity = '1', 20);
                    // fade out and remove
                    setTimeout(()=> { label.style.opacity = '0'; setTimeout(()=> { try{ label.remove(); }catch(_){ } }, 220); }, 1400);
                }
            }catch(e){ console.warn('showSavedIndicator failed', e); }
        }

        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'unified-refresh-btn'){ renderUnifiedPriceGrid(); }
            if(e.target && e.target.id === 'unified-export-json-btn'){ unifiedExportJSON(); }
            if(e.target && e.target.id === 'unified-export-csv-btn'){ unifiedExportCSV(); }
            if(e.target && e.target.id === 'unified-print-btn'){ unifiedPrint(); }
            const inlineBtn = e.target && e.target.closest && e.target.closest('.unified-save-price');
            if(inlineBtn){
                const typeLabel = inlineBtn.getAttribute('data-type');
                const id = inlineBtn.getAttribute('data-id');
                const inp = document.querySelector(`.unified-new-price[data-id="${CSS.escape(id)}"][data-type="${CSS.escape(typeLabel)}"]`);
                if(!inp) return;
                const rawVal = inp.value.trim(); 
                if(rawVal==='') { alert('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯'); return; }
                const num = parseFloat(rawVal); 
                if(isNaN(num)){ alert('Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
                // map Arabic type label to internal key (include finished)
                const mapType = t => t==='Ø®Ø§Ù…Ø©'?'raw': (t==='ØªØºÙ„ÙŠÙ'?'pack': (t==='ØªØ´ØºÙŠÙ„'?'ops': (t==='Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠ'?'finished':'raw')));
                const tKey = mapType(typeLabel);
                const list = getListByType(tKey) || [];
                const it = list.find(x=> String(x.id) === String(id)); 
                if(!it){ alert('Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
                console.log('ğŸ’¾ Inline save price button clicked:', {typeLabel, id, newPrice: num});
                const now = new Date().toISOString();
                it.lastPrice = num; 
                it.lastPriceDate = now; 
                it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; 
                it.priceHistory.unshift({ price: num, date: now, note: 'Ø´Ø¨ÙƒØ© Ù…ÙˆØ­Ø¯Ø©' });
                saveLists(); 
                // renderPriceManager() removed - feature deleted
                renderUnifiedPriceGrid();
                inp.value='';
                console.log('âœ… Price saved and grid refreshed');
                console.log('âœ… Price saved and grid refreshed');
            }
        });

        // Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø®Ù„ÙŠØ© "Ø§Ù„ÙƒÙˆØ¯" (Enter Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬)
        function __commitUnifiedCode(el){
            if(!el) return;
            const typeLabel = el.getAttribute('data-type');
            const id = el.getAttribute('data-id');
            const txt = (el.textContent||'').trim();
            console.log('âœï¸ Editing code:', {typeLabel, id, newCode: txt});
            const mapType = t => t==='Ø®Ø§Ù…Ø©'?'raw': (t==='ØªØºÙ„ÙŠÙ'?'pack': (t==='ØªØ´ØºÙŠÙ„'?'ops': (t==='Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠ'?'finished':'raw')));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); 
            if(!it) { console.warn('âŒ Item not found for code edit'); return; }
            if ((it.code||'') === txt) { console.log('â†©ï¸ Code unchanged'); return; }
            it.code = txt;
            console.log('ğŸ’¾ Committing code change to storage...');
            saveLists(); 
            // renderPriceManager() removed - feature deleted
            renderUnifiedPriceGrid();
        }
        document.addEventListener('focusin', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
        });
        document.addEventListener('keydown', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span && e.key === 'Enter'){
                e.preventDefault(); __commitUnifiedCode(span);
                try { span.blur(); } catch(_){}
            }
        });
        document.addEventListener('focusout', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span){ __commitUnifiedCode(span); }
        });

        // Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø®Ù„ÙŠØ© "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ" (Enter Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬)
        function __commitUnifiedCurrentPrice(el){
            if(!el) return;
            const typeLabel = el.getAttribute('data-type');
            const id = el.getAttribute('data-id');
            const txt = (el.textContent||'').trim(); 
            if(txt==='') { console.log('â†©ï¸ Price empty, ignoring'); return; } // ØªØ¬Ø§Ù‡ÙÙ„ Ø§Ù„ÙØ±Ø§Øº
            const val = parseFloat(txt);
            if(isNaN(val)) { 
                console.warn('âŒ Invalid price value:', txt);
                el.textContent = el.getAttribute('data-prev') || el.textContent; 
                return; 
            }
            console.log('ğŸ’° Editing price:', {typeLabel, id, newPrice: val});
            const mapType = t => t==='Ø®Ø§Ù…Ø©'?'raw': (t==='ØªØºÙ„ÙŠÙ'?'pack': (t==='ØªØ´ØºÙŠÙ„'?'ops': (t==='Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠ'?'finished':'raw')));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); 
            if(!it) { console.warn('âŒ Item not found for price edit'); return; }
            const prev = (it.lastPrice!=null?Number(it.lastPrice):(it.cost!=null?Number(it.cost):null));
            if(prev!=null && Number(prev).toFixed(2) === Number(val).toFixed(2)) { 
                console.log('â†©ï¸ Price unchanged');
                el.textContent = Number(prev).toFixed(2); 
                return; 
            }
            const now = new Date().toISOString();
            it.lastPrice = val; 
            it.lastPriceDate = now; 
            it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; 
            it.priceHistory.unshift({ price: val, date: now, note: 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±' });
            console.log('ğŸ’¾ Committing price change to storage...', {oldPrice: prev, newPrice: val});
            saveLists(); 
            // update only the edited element and show saved indicator; avoid full grid re-render to keep focus
            el.textContent = Number(val).toFixed(2);
            showSavedIndicator(el);
        }
        document.addEventListener('focusin', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
        });
        document.addEventListener('keydown', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span && e.key === 'Enter'){
                e.preventDefault(); __commitUnifiedCurrentPrice(span);
                try { span.blur(); } catch(_){}
            }
        });
        document.addEventListener('focusout', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span){ __commitUnifiedCurrentPrice(span); }
        });

        function saveRawPriceRow(id){
            try{
                console.log('ğŸ”§ saveRawPriceRow: entering', { id });
                const safeId = CSS && CSS.escape ? CSS.escape(id) : id;
                const inp = document.querySelector(`.raw-price-input[data-id="${safeId}"]`);
                if(!inp){ console.warn('saveRawPriceRow: input not found for id', id); return; }
                const v = parseFloat(inp.value || 0) || 0;
                const itIndex = costRaw.findIndex(x => String(x.id) === String(id));
                const it = itIndex >= 0 ? costRaw[itIndex] : null;
                if(!it) { console.warn('saveRawPriceRow: item not found in costRaw', id); return alert('Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); }
                // also update name and unit from inputs
                const nameInp = document.querySelector(`.raw-name-input[data-id="${safeId}"]`);
                const unitInp = document.querySelector(`.raw-unit-input[data-id="${safeId}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                console.log('ğŸ”§ saveRawPriceRow: before change', { id, prev, newValue: v });
                if(v !== prev){
                    it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate });
                    // write back to array in case of reference issues
                    costRaw[itIndex] = it;
                    try{ window.__lastRawEditedId = id; }catch(_){ }
                    console.log('ğŸ”§ saveRawPriceRow: item updated in memory', it);
                } else {
                    console.log('ğŸ”§ saveRawPriceRow: price unchanged for', id);
                }
                saveLists();
                try{ console.log('ğŸ” saveRawPriceRow: localStorage cost_raw snapshot length', (localStorage.getItem('cost_raw')||'').length); }catch(_){ }
                renderRawPriceTable();
                // also refresh BOM selects so new lastPrice appears in data-lastprice
                renderProductSelect();
                // update any open BOM rows that reference this item (if autofill enabled)
                try{ updateBomRowsAfterPriceChange(id, 'raw'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
            }catch(e){ console.warn('saveRawPriceRow: unexpected error', e); }
        }

        function saveFinishedPriceRow(id){
            const inp = document.querySelector(`.finished-price-input[data-id="${id}"]`);
            if(!inp) return;
            const v = parseFloat(inp.value || 0) || 0;
            const it = costFinished.find(x => String(x.id) === String(id));
            if(!it) return alert('Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            const nameInp = document.querySelector(`.finished-name-input[data-id="${id}"]`);
            const unitInp = document.querySelector(`.finished-unit-input[data-id="${id}"]`);
            if(nameInp) it.name = nameInp.value.trim();
            if(unitInp) it.unit = unitInp.value.trim();
            const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.price||0);
            if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
            saveLists(); renderFinishedPriceTable(); renderProductSelect();
            try{ updateBomRowsAfterPriceChange(id, 'finished'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
        }

        function savePackPriceRow(id){
            const inp = document.querySelector(`.pack-price-input[data-id="${id}"]`);
            if(!inp) return;
            const v = parseFloat(inp.value || 0) || 0;
            const it = costPack.find(x => String(x.id) === String(id));
            if(!it) return alert('Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            const nameInp = document.querySelector(`.pack-name-input[data-id="${id}"]`);
            const unitInp = document.querySelector(`.pack-unit-input[data-id="${id}"]`);
            if(nameInp) it.name = nameInp.value.trim();
            if(unitInp) it.unit = unitInp.value.trim();
            const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
            if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
            saveLists(); renderPackPriceTable(); renderProductSelect();
            try{ updateBomRowsAfterPriceChange(id, 'pack'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
        }

        function saveAllPrices(){
            let changed = 0;
            const changedIds = new Set();
            // finished
            Array.from(document.querySelectorAll('.finished-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costFinished.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.finished-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.finished-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.price||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            // raw
            Array.from(document.querySelectorAll('.raw-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costRaw.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.raw-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.raw-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            // pack
            Array.from(document.querySelectorAll('.pack-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costPack.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.pack-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.pack-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            if(changed > 0){ saveLists(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable(); renderProductSelect();
                // update BOM rows for each changed id
                try{ changedIds.forEach(i=> updateBomRowsAfterPriceChange(i)); }catch(e){console.warn('updateBomRowsAfterPriceChange bulk failed', e); }
                alert('ØªÙ… Ø­ÙØ¸ ' + changed + ' Ø³Ø¹Ø±Ø§Ù‹.');
            } else alert('Ù„Ø§ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸.');
        }

        // When a price changes, update any visible BOM rows that reference that component
        function updateBomRowsAfterPriceChange(itemId, listType){
            try{
                // only proceed if autofill is enabled
                const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                if(!auto) return;
                if(!itemId) return;
                const tbody = document.getElementById('cost-bom-body'); if(!tbody) return;
                // find the new price from lists
                const findPrice = (id) => {
                    let found = (costRaw||[]).find(x=>String(x.id)===String(id)) || (costPack||[]).find(x=>String(x.id)===String(id)) || (costFinished||[]).find(x=>String(x.id)===String(id));
                    if(!found) return 0;
                    return Number(found.lastPrice !== undefined && found.lastPrice !== null ? found.lastPrice : (found.cost !== undefined ? found.cost : (found.price !== undefined ? found.price : 0)));
                };

                const newPrice = findPrice(itemId);
                Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                    const compSel = tr.querySelector('.cost-comp-select');
                    if(!compSel) return;
                    if(String(compSel.value) === String(itemId)){
                        const unitCostInp = tr.querySelector('.cost-comp-unitcost');
                        const qtyInp = tr.querySelector('.cost-comp-qty');
                        const totalSpan = tr.querySelector('.cost-comp-total');
                        if(unitCostInp){
                            unitCostInp.value = Number(newPrice || 0).toFixed(2);
                        }
                        // update total display for the row
                        const q = parseFloat(qtyInp && qtyInp.value || 0) || 0;
                        const uc = parseFloat(unitCostInp && unitCostInp.value || 0) || 0;
                        const tot = Math.round(q * uc * 100) / 100;
                        if(totalSpan) totalSpan.textContent = tot.toFixed(2);
                    }
                });
                // recalc totals after updating rows
                calculateTotals();
            }catch(e){ console.warn('updateBomRowsAfterPriceChange error', e); }
        }

        function exportPrices(){ const payload = { raw: costRaw || [], exportedAt: new Date().toISOString() }; const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = 'cost-raw-prices.json'; document.body.appendChild(a); a.click(); a.remove(); }

        function importPricesFromJSON(obj){
            if(!obj || !Array.isArray(obj.raw)) return alert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ù…Ø§Øª ØµØ­ÙŠØ­Ø©');
            let added = 0, updated = 0;
            obj.raw.forEach(r => {
                const id = r.id || r.code || null; if(!id) return;
                const existing = costRaw.find(x => String(x.id) === String(id));
                if(existing){
                    // update lastPrice if present
                    if(r.lastPrice !== undefined){ existing.lastPrice = r.lastPrice; existing.lastPriceDate = r.lastPriceDate || new Date().toISOString(); existing.priceHistory = existing.priceHistory || []; existing.priceHistory.unshift({ price: existing.lastPrice, date: existing.lastPriceDate }); updated++; }
                } else {
                    // add minimal entry
                    const newItem = { id, code: id, name: r.name||r.title||'', unit: r.unit||'', cost: r.cost||0, lastPrice: r.lastPrice||r.cost||0, lastPriceDate: r.lastPriceDate||new Date().toISOString(), priceHistory: r.priceHistory||[] };
                    costRaw.push(newItem); added++;
                }
            });
            saveLists(); renderRawPriceTable(); renderProductSelect(); alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯: ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + added + ' â€” ØªÙ… ØªØ­Ø¯ÙŠØ« ' + updated);
        }

        // wire raw price registry UI
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'export-prices-btn'){ exportPrices(); }
            if(e.target && e.target.id === 'import-prices-btn'){ const inp = document.getElementById('import-prices-input'); if(inp) inp.click(); }
            if(e.target && e.target.id === 'save-all-prices-btn'){ saveAllPrices(); }
            const saveBtn = e.target && e.target.closest && e.target.closest('.raw-price-save-btn'); if(saveBtn){ const id = saveBtn.getAttribute('data-id'); if(id) saveRawPriceRow(id); }
        });

        // import file handler
        const importInp = document.getElementById('import-prices-input'); if(importInp) importInp.addEventListener('change', function(e){
            const f = e.target.files && e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = function(ev){ try{ const obj = JSON.parse(String(ev.target.result || '{}')); importPricesFromJSON(obj); }catch(err){ alert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message); } }; reader.readAsText(f); e.target.value = '';
        });
        
        // add empty raw row
        function addEmptyRawRow(){
            const id = 'raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
            costRaw.push({ id, code: id, name: '', unit: '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
            saveLists(); renderRawPriceTable();
        }

        // import names from app state (state.products or DEFAULT_PRODUCTS)
        function importRawNamesFromState(){
            const src = (Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
            if(!src || !src.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.');
            if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒØ®Ø§Ù…Ø§ØªØŸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø¹Ø§Ø±.')) return;
            let added = 0;
            src.forEach(p => {
                const id = p.id || p.code || ('raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                if(!costRaw.some(x => String(x.id) === String(id) || (x.name && x.name.trim() === (p.name||p.title||'').trim()))) {
                    costRaw.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
                    added++;
                }
            });
            saveLists(); renderRawPriceTable(); renderProductSelect(); alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + added + ' Ø®Ø§Ù…Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
        }

        // wire new buttons
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'add-empty-raw-btn'){ addEmptyRawRow(); }
            if(e.target && e.target.id === 'import-raw-from-state-btn'){ importRawNamesFromState(); }
        });

        // Attach direct listener to the manage button (robust against inner elements)
        document.addEventListener('DOMContentLoaded', function(){
            const mb = document.getElementById('cost-manage-lists-btn'); if(mb) mb.addEventListener('click', openManageListsModal);
        });

        // Add list handlers
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'add-finished-btn'){
                const name = document.getElementById('prod-finished-name').value.trim();
                const code = document.getElementById('prod-finished-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-finished-unit').value.trim() || 'Ù‚Ø·Ø¹Ø©';
                const price = parseFloat(document.getElementById('prod-finished-price').value || 0) || 0;
                if(!name) return alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù…');
                costFinished.push({ id: code, code, name, unit, price }); saveLists();
                document.getElementById('prod-finished-name').value=''; document.getElementById('prod-finished-code').value=''; document.getElementById('prod-finished-price').value='';
            }
            if(e.target && e.target.id === 'add-raw-btn'){
                const name = document.getElementById('prod-raw-name').value.trim();
                const code = document.getElementById('prod-raw-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-raw-unit').value.trim() || 'ÙƒØ¬Ù…';
                const cost = parseFloat(document.getElementById('prod-raw-cost').value || 0) || 0;
                if(!name) return alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©');
                costRaw.push({ id: code, code, name, unit, cost }); saveLists();
                document.getElementById('prod-raw-name').value=''; document.getElementById('prod-raw-code').value=''; document.getElementById('prod-raw-cost').value='';
            }
            if(e.target && e.target.id === 'add-pack-btn'){
                const name = document.getElementById('prod-pack-name').value.trim();
                const code = document.getElementById('prod-pack-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-pack-unit').value.trim() || 'Ù‚Ø·Ø¹Ø©';
                const cost = parseFloat(document.getElementById('prod-pack-cost').value || 0) || 0;
                if(!name) return alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØºÙ„ÙŠÙ');
                costPack.push({ id: code, code, name, unit, cost }); saveLists();
                document.getElementById('prod-pack-name').value=''; document.getElementById('prod-pack-code').value=''; document.getElementById('prod-pack-cost').value='';
            }
        });

        // BOM row creation
        function createComponentOptionHTML(list){ return list.map(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? Number(it.lastPrice) : (it.cost !== undefined ? Number(it.cost) : (it.price !== undefined ? Number(it.price) : 0));
                return `<option value="${escapeHtml(it.id)}" data-unit="${escapeHtml(it.unit||'')}" data-cost="${Number(it.cost||it.price||0)}" data-lastprice="${last}">${escapeHtml(it.name)} (${escapeHtml(it.unit||'')})</option>`;
            }).join(''); }

        function addBOMRow(data){
            const tbody = document.getElementById('cost-bom-body'); if(!tbody) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-2 py-1 text-right">
                    <select class="cost-comp-type p-1 border rounded"><option value="raw">Ø®Ø§Ù…Ø©</option><option value="pack">ØªØºÙ„ÙŠÙ</option></select>
                </td>
                <td class="px-2 py-1 text-right">
                    <select class="cost-comp-select p-1 border rounded"></select>
                </td>
                <td class="px-2 py-1 text-center"><input class="cost-comp-qty p-1 border rounded text-center" value="${data && data.qty ? data.qty : 1}" style="width:90px" /></td>
                <td class="px-2 py-1 text-center"><span class="cost-comp-unit">${data && data.unit?escapeHtml(data.unit):''}</span></td>
                <td class="px-2 py-1 text-center"><input class="cost-comp-unitcost p-1 border rounded text-center" value="${data && data.unitCost?data.unitCost:0}" style="width:110px" /></td>
                <td class="px-2 py-1 text-center"><span class="cost-comp-total">0.00</span></td>
                <td class="px-2 py-1 text-center"><button class="cost-remove-row bg-red-500 text-white px-2 rounded">Ø­Ø°Ù</button></td>
            `;
            tbody.appendChild(tr);
            const typeSel = tr.querySelector('.cost-comp-type');
            const compSel = tr.querySelector('.cost-comp-select');
            // ensure row cells allow dropdowns to overflow if needed
            try{ tr.style.overflow = 'visible'; if(typeSel && typeSel.parentElement) typeSel.parentElement.style.overflow = 'visible'; if(compSel && compSel.parentElement) compSel.parentElement.style.overflow = 'visible'; }catch(e){}
            const qtyInp = tr.querySelector('.cost-comp-qty');
            const unitSpan = tr.querySelector('.cost-comp-unit');
            const unitCostInp = tr.querySelector('.cost-comp-unitcost');
            const totalSpan = tr.querySelector('.cost-comp-total');

            function populateOptions(){
                const isRaw = typeSel.value === 'raw';
                compSel.innerHTML = isRaw ? createComponentOptionHTML(costRaw) : createComponentOptionHTML(costPack);
                if(data && data.id) compSel.value = data.id;
                // set unit and unitcost
                const opt = compSel.options[compSel.selectedIndex];
                if(opt){
                    unitSpan.textContent = opt.getAttribute('data-unit') || '';
                    // if auto-fill from last price is enabled and this is a raw item, prefer data-lastprice
                    const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                    if(isRaw && auto){ unitCostInp.value = Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0); }
                    else { unitCostInp.value = Number(opt.getAttribute('data-cost')||0); }
                }
                recalc();
            }

            // Workarounds: ensure the select receives pointer events and is above overlays
            try{
                [compSel, typeSel].forEach(s=>{
                    if(!s) return;
                    s.style.position = 'relative';
                    s.style.zIndex = 9999;
                    s.style.pointerEvents = 'auto';
                    // make native dropdown arrow available across browsers
                    s.style.webkitAppearance = 'menulist';
                    s.style.MozAppearance = 'menulist-button';
                    s.addEventListener('mousedown', function(ev){ ev.stopPropagation(); });
                    s.addEventListener('click', function(ev){ ev.stopPropagation(); });
                    s.addEventListener('focus', ()=>{ s.style.zIndex = 12000; });
                    s.addEventListener('blur', ()=>{ s.style.zIndex = 9999; });
                });
            }catch(e){/* ignore */}

            function recalc(){
                const q = parseFloat(qtyInp.value || 0) || 0;
                const uc = parseFloat(unitCostInp.value || 0) || 0;
                const tot = Math.round((q * uc) * 100) / 100;
                totalSpan.textContent = tot.toFixed(2);
                calculateTotals();
            }

            typeSel.addEventListener('change', populateOptions);
            compSel.addEventListener('change', () => {
                const opt = compSel.options[compSel.selectedIndex];
                if(opt){
                    unitSpan.textContent = opt.getAttribute('data-unit') || '';
                    const isRaw = typeSel.value === 'raw';
                    const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                    if(isRaw && auto) unitCostInp.value = Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0);
                    else unitCostInp.value = Number(opt.getAttribute('data-cost')||0);
                }
                recalc();
            });
            qtyInp.addEventListener('input', recalc);
            unitCostInp.addEventListener('input', recalc);
            tr.querySelector('.cost-remove-row').addEventListener('click', ()=>{ tr.remove(); calculateTotals(); });

            populateOptions();
        }

        function calculateTotals(){
            const rows = Array.from(document.querySelectorAll('#cost-bom-body tr'));
            let rawSum = 0; let packSum = 0;
            rows.forEach(r => {
                const type = (r.querySelector('.cost-comp-type') && r.querySelector('.cost-comp-type').value) || 'raw';
                const q = parseFloat((r.querySelector('.cost-comp-qty') && r.querySelector('.cost-comp-qty').value) || 0) || 0;
                const uc = parseFloat((r.querySelector('.cost-comp-unitcost') && r.querySelector('.cost-comp-unitcost').value) || 0) || 0;
                const tot = Math.round(q * uc * 100) / 100;
                if(type === 'raw') rawSum += tot; else packSum += tot;
            });

            const yieldVal = parseFloat(document.getElementById('cost-yield').value || 1) || 1;

            // overheads
            const overheadFixed = parseFloat(document.getElementById('cost-overhead-fixed') && document.getElementById('cost-overhead-fixed').value || 0) || 0; // fixed per batch
            const overheadPercent = parseFloat(document.getElementById('cost-overhead-percent') && document.getElementById('cost-overhead-percent').value || 0) || 0; // percent of raw materials

            // percent amount is applied on rawSum (total materials) for the whole batch
            const overheadPercentAmount = Math.round((rawSum * (overheadPercent / 100)) * 100) / 100;

            // per-unit fixed overhead = fixed per batch / yield
            const overheadFixedPerUnit = yieldVal ? Math.round((overheadFixed / yieldVal) * 100) / 100 : 0;

            // total per-unit cost = (raw + pack + overheadPercentAmount + overheadFixed) / yield
            const perUnit = Math.round(((rawSum + packSum + overheadPercentAmount + overheadFixed) / yieldVal) * 100) / 100;

            // update UI
            const rawEl = document.getElementById('cost-raw-total'); if(rawEl) rawEl.textContent = rawSum.toFixed(2);
            const packEl = document.getElementById('cost-pack-total'); if(packEl) packEl.textContent = packSum.toFixed(2);
            const fixedPerUnitEl = document.getElementById('cost-overhead-fixed-perunit'); if(fixedPerUnitEl) fixedPerUnitEl.textContent = overheadFixedPerUnit.toFixed(2);
            const percentAmtEl = document.getElementById('cost-overhead-percent-amount'); if(percentAmtEl) percentAmtEl.textContent = overheadPercentAmount.toFixed(2);
            const totalPerUnitEl = document.getElementById('cost-total-per-unit'); if(totalPerUnitEl) totalPerUnitEl.textContent = perUnit.toFixed(2);
        }

        // Save / load BOM for selected product
        function saveBOMForSelected(){
            const sel = document.getElementById('cost-product-select'); if(!sel) return alert('Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹ ØªØ§Ù…Ø§Ù‹');
            const pid = sel.value; if(!pid) return alert('Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹ ØªØ§Ù…Ø§Ù‹');
            const rows = Array.from(document.querySelectorAll('#cost-bom-body tr')).map(r => ({ type: r.querySelector('.cost-comp-type').value, id: r.querySelector('.cost-comp-select').value, qty: parseFloat(r.querySelector('.cost-comp-qty').value||0)||0, unit: r.querySelector('.cost-comp-unit').textContent||'', unitCost: parseFloat(r.querySelector('.cost-comp-unitcost').value||0)||0 }));
            const payload = { yield: parseFloat(document.getElementById('cost-yield').value||1)||1, items: rows, savedAt: new Date().toISOString() };
            localStorage.setItem(LS_BOM_PREFIX + pid, JSON.stringify(payload));
            alert('ØªÙ… Ø­ÙØ¸ BOM Ù„Ù„Ù…Ù†ØªØ¬');
        }

        function ensureDefaultBOMRows(){ /* legacy BOM disabled after simplification */ return; }

        function loadBOMForProduct(pid){ /* legacy BOM disabled */ return; }

        // UI bindings
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'new-bom-row-btn'){ addBOMRow(); }
            if(e.target && e.target.id === 'cost-save-bom-btn'){ saveBOMForSelected(); }
            if(e.target && e.target.id === 'cost-export-btn'){
                const summary = `ØªÙƒÙ„ÙØ© ÙˆØ­Ø¯Ø©: ${document.getElementById('cost-total-per-unit').textContent} â€” Ø®Ø§Ù…Ø§Øª: ${document.getElementById('cost-raw-total').textContent} â€” ØªØºÙ„ÙŠÙ: ${document.getElementById('cost-pack-total').textContent}`;
                navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(summary).then(()=>alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ')) : prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹:', summary);
            }
            if(e.target && e.target.id === 'cost-load-sample'){
                // small sample to help user start
                costFinished.push({ id: 'P-001', code: 'P-001', name: 'Ù…Ù†ØªØ¬ Ù†Ù…ÙˆØ°Ø¬ÙŠ', unit: 'Ù‚Ø·Ø¹Ø©', price: 100 });
                costRaw.push({ id: 'R-001', code: 'R-001', name: 'Ù„Ø¨Ù†', unit: 'ÙƒØ¬Ù…', cost: 20 });
                costPack.push({ id: 'K-001', code: 'K-001', name: 'Ø¹Ø¨ÙˆØ© Ø¨Ù„Ø§Ø³ØªÙŠÙƒ', unit: 'Ù‚Ø·Ø¹Ø©', cost: 1.5 });
                saveLists(); alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø³ÙŠØ·');
            }
            if(e.target && e.target.id === 'cost-save-all-lists'){ saveLists(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…'); }
        });

        // when product selection changes, load saved BOM if exists
        document.addEventListener('change', function(e){
            if(e.target && e.target.id === 'cost-product-select'){
                document.getElementById('cost-bom-body').innerHTML='';
                const pid = e.target.value; if(!pid){ ensureDefaultBOMRows(); return; } loadBOMForProduct(pid);
            }
            // recalculations when yield or overhead fields change (change event)
            if(e.target && (e.target.id === 'cost-yield' || e.target.id === 'cost-overhead-fixed' || e.target.id === 'cost-overhead-percent')) calculateTotals();
        });

        // live-update totals while user types overheads
        ['cost-overhead-fixed','cost-overhead-percent'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', () => calculateTotals());
        });

        // Recalculate totals whenever the BOM body changes (delegated)
        const bomObserver = new MutationObserver(()=> calculateTotals());
        const bomBody = document.getElementById('cost-bom-body'); if(bomBody) bomObserver.observe(bomBody, { childList:true, subtree:true });

        // show page handler
        function onShowCostsPage(){
            try{ document.getElementById('header-title').textContent = 'Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ'; }catch(e){}
            // ğŸ”§ CRITICAL FIX: Reload lists from localStorage to ensure data persists after refresh
            try { 
                console.log('ğŸ“„ onShowCostsPage: reloading lists from localStorage...'); 
                loadLists(); 
            } catch(e) { 
                console.warn('onShowCostsPage: loadLists() failed', e); 
                // Fallback: just render if loadLists fails
                // renderPriceManager() removed - feature deleted
            }
            // Call simplified cost renderers if available
            // renderQuickLists removed - feature deleted
            if(window.renderRecipes) window.renderRecipes();
            // ØªØ´ØºÙŠÙ„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµØ§Ù…Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙØ§Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ù„ÙŠ ÙŠØ­ØªÙˆÙŠ Ø£Ø³Ù…Ø§Ø¡ Ù‚Ø¯ÙŠÙ…Ø©
            try {
                if (window.autoImportLegacyRecipesOnce) window.autoImportLegacyRecipesOnce();
                if (window.autoRestoreCostListsOnce) window.autoRestoreCostListsOnce();
            } catch(_){ }
        }

        // wire to nav clicks
        document.addEventListener('click', function(e){
            const btn = e.target.closest && e.target.closest('.bottom-nav-item');
            if(btn && btn.getAttribute('data-page') === 'costs'){ setTimeout(onShowCostsPage, 40); }
        });

        // Also detect programmatic navigation
        const pageObserver = new MutationObserver(muts => {
            muts.forEach(m => {
                if(m.target && m.target.id === 'page-costs' && m.attributeName === 'class'){
                    if(m.target.classList.contains('active')) onShowCostsPage();
                }
            });
        });
        const pageCostsEl = document.getElementById('page-costs'); if(pageCostsEl) pageObserver.observe(pageCostsEl, { attributes: true });

        // initialize data on load
        // loadLists() call removed here; initialization centralized earlier to avoid races

        // Restore from price lists: clear any previous Excel import and import finished products from app price lists
        function restoreFromPriceLists(){
            try{
                // clear existing lists (remove any Excel-imported entries)
                costFinished = [];
                costRaw = [];
                costPack = [];

                const src = (Array.isArray(state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
                let added = 0;
                src.forEach(p =>{
                    const id = p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'Ù‚Ø·Ø¹Ø©', price: Number(p.price||p.sellPrice||0) });
                    added++;
                });
                saveLists();
                console.log('restoreFromPriceLists: imported', added, 'products');
                alert('ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (' + added + ' Ø¹Ù†ØµØ±).');
            } catch(e){ console.warn('restoreFromPriceLists failed', e); alert('ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: ' + (e && e.message)); }
        }
        // expose for manual usage and UI button
        window.restoreFromPriceLists = restoreFromPriceLists;

        // ØªØ´ØºÙŠÙ„ ØªØ±Ù…ÙŠÙ… Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©: ÙŠØ¹ÙŠØ¯ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
        window.autoRestoreCostListsOnce = (function(){
            let done = false;
            let retries = 0;
            const maxRetries = 10;
            const retryDelayMs = 500;
            function attempt(){
                if (done) return;
                try {
                    try { if (typeof loadLists === 'function') loadLists(); } catch(_){ }
                    const hasAny = (Array.isArray(window.costFinished) && window.costFinished.length)
                                  || (Array.isArray(window.costRaw) && window.costRaw.length)
                                  || (Array.isArray(window.costPack) && window.costPack.length);
                    if (hasAny) { done = true; return; }
                    const hasProducts = Array.isArray(state.products) && state.products.length;
                    if (hasProducts) {
                        restoreFromPriceLists();
                        // renderQuickLists removed - feature deleted
                        done = true; return;
                    }
                    if (retries < maxRetries) { retries++; setTimeout(attempt, retryDelayMs); return; }
                    // No products after retries; leave it to manual button
                    done = true;
                } catch(_){ done = true; }
            }
            return attempt;
        })();

    // NOTE: auto-restore from price lists was previously executed here on load and caused unwanted alerts.
    // Auto-run has been disabled to avoid automatic popups. To run restore manually, call restoreFromPriceLists() from the console or add a dedicated button.
    // try{ restoreFromPriceLists(); } catch(e){}

        // Add bulk packaging items provided by user into costPack (avoid duplicates)
        (function addDefaultPackItems(){
            const PACK_ITEMS = [
"Ø§Ø³ØªÙŠÙƒØ± Ù‚Ø´Ø·Ø©",
"Ø§Ø·Ø¨Ø§Ù‚ Ø´Ø±Ø´",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ ÙƒØ±ÙŠÙ…Ù‰ 3Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ ÙƒØ±ÙŠÙ…Ù‰ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ Ù‚Ø·Ø¹ 3Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ Ù‚Ø·Ø¹ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ±  Ù…Ù„Ø­ Ø®ÙÙŠÙ Ø·Ø¨ÙŠØ¹Ù‰ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ù„Ø­ Ø®ÙÙŠÙ Ù†Ø¨Ø§ØªÙ‰ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù‚Ø±ÙŠØ´ Ø®Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ø³Ù… 8 Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù‚Ø±ÙŠØ´ ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ø¯Ø³Ù… 8 Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙÙŠØªØ§ Ø³Ø§Ø¯Ø© Ø·Ø¨ÙŠØ¹Ù‰ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙÙŠØªØ§ ÙÙ„ÙÙ„ Ø·Ø¨ÙŠØ¹Ù‰ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙÙŠØªØ§ ÙÙ„ÙÙ„ Ù†Ø¨Ø§ØªÙ‰ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙÙŠØªØ§ Ø³Ø§Ø¯Ø© Ù†Ø¨Ø§ØªÙ‰ 8Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ø·Ø¨ÙŠØ¹Ù‰ 3Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ù†Ø¨Ø§ØªÙ‰ 3Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù…ÙˆØ±ØªØ© 2.5Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù…ÙˆØ±ØªØ© 300 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± ØµÙˆØµ Ø´ÙŠØ¯Ø± 3Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù†Ø³ØªÙˆ Ø·Ø¨ÙŠØ¹Ù‰ 3Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ© Ø¨ÙŠØ¶Ø§Ø¡ 4Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ø¨Ø³Ø·Ø±Ù…Ø©",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ø´ÙŠØ¯Ø±",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ø±ÙˆÙ…Ù‰",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ø¬ÙˆØ¯Ø©",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ø²ÙŠØªÙˆÙ†",
"Ø§Ø³ØªÙŠÙƒØ± ÙƒÙŠØ±Ù‰ Ù‚Ø´Ø·Ø©",
"Ù„ÙˆØ¬Ùˆ Ø§Ù„Ø±Ø¨ÙŠØ¹ Ø§Ø²Ø±Ù‚",
"Ù„ÙˆØ¬Ùˆ Ø§Ù„Ø±Ø¨ÙŠØ¹ Ø§Ø®Ø¶Ø±",
"Ù„ÙˆØ¬Ùˆ ÙÙŠØªØ§ ÙÙ„ÙÙ„ Ø·Ø¨ÙŠØ¹Ù‰",
"Ø§ÙƒÙŠØ§Ø³ Ø¬Ø±Ø§Ø¯Ù„ 8Ùƒ",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ 40*40",
"Ø¬ÙˆØ§Ù†ØªÙ‰ Ø¹Ù„Ø¨Ø©",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ ÙÙŠØªØ§ Ø³Ø§Ø¯Ø© Ù†Ø¨Ø§ØªÙ‰",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ Ù…Ù„Ø­ Ø®ÙÙŠÙ Ù†Ø¨Ø§ØªÙ‰",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ Ù‚Ø±ÙŠØ´ Ø®Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ø³Ù…",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ Ù‚Ø±ÙŠØ´ ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ø¯Ø³Ù…",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ Ø³Ø§Ø¯Ø© 30-30",
"Ø±ÙˆÙ„ ÙØ±Ø´ ØµÙˆØ§Ù†Ù‰",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ ØµÙˆØ§Ù†Ù‰ 70-70",
"Ø§ÙƒÙŠØ§Ø³ Ø´ÙØ§Ù 27*45",
"Ø´Ù†Ø· ÙˆØ³Ø· Ø³Ø§Ø¯Ø©",
"Ø´Ù†Ø· ÙƒØ¨ÙŠØ± Ø³Ø§Ø¯Ø©",
"Ø´Ù†Ø· ØµØºÙŠØ± Ø³Ø§Ø¯Ø©",
"Ø§ÙƒÙŠØ§Ø³ Ù„Ø¨Ù† Ø´ÙØ§Ù 1Ùƒ",
"Ø¨Ø±Ø·Ù…Ø§Ù† 800 Ø¬Ù…",
"Ø¨Ø±Ø·Ù…Ø§Ù† 500 Ø¬Ù…",
"Ø¨Ø±Ø·Ù…Ø§Ù† 300 Ø¬Ù…",
"Ø·Ø¨Ù‚ Ø¨Ù„Ø§Ø³ØªÙŠÙƒ 1Ùƒ",
"Ø¬Ø±Ø¯Ù„ ÙØ§Ø±Øº 8Ùƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡",
"ØºØ·Ø§Ø¡ Ø¬Ø±Ø¯Ù„ 8Ùƒ",
"Ø¬Ø±Ø¯Ù„ ÙØ§Ø±Øº 3Ùƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡",
"ØºØ·Ø§Ø¡ Ø¬Ø±Ø¯Ù„ 3Ùƒ",
"ØºØ·Ø§Ø¡  Ø²Ø¨Ø§Ø¯Ù‰ 100 Ø¬Ù…",
"Ø¹Ù„Ø¨Ø© Ø­Ù„ÙˆÙŠØ§Øª Ø´ÙØ§Ù",
"ØºØ·Ø§Ø¡ Ø²Ø¨Ø§Ø¯Ù‰ 140 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø²Ø¨Ø¯Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰ 1Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ø²Ø¨Ø¯Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰ 900Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø²Ø¨Ø¯Ø© Ø¬Ø§Ù…ÙˆØ³Ù‰500Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø²Ø¨Ø¯Ø© Ø¨Ù‚Ø±Ù‰ 1Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ø²Ø¨Ø¯Ø© Ø¨Ù‚Ø±Ù‰ 900Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø²Ø¨Ø¯Ø© Ø¨Ù‚Ø±Ù‰ 500Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø³Ù…Ù† Ø¬Ø§Ù…ÙˆØ³Ù‰ 800 Ø¬Ù…",
"ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù…Ø§Ù† Ø³Ù…Ù† Ø¬Ø§Ù…ÙˆØ³Ù‰ 800 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø³Ù…Ù† Ø¬Ø§Ù…ÙˆØ³Ù‰ 500 Ø¬Ù…",
"ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù…Ø§Ù† Ø³Ù…Ù† Ø¬Ø§Ù…ÙˆØ³Ù‰ 500 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø³Ù…Ù† Ø¬Ø§Ù…ÙˆØ³Ù‰ 200 Ø¬Ù…",
"ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù…Ø§Ù† Ø³Ù…Ù† Ø¬Ø§Ù…ÙˆØ³Ù‰ 200 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø³Ù…Ù† Ø¨Ù‚Ø±Ù‰ 800 Ø¬Ù…",
"ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù…Ø§Ù† Ø³Ù…Ù† Ø¨Ù‚Ø±Ù‰ 800 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø³Ù…Ù† Ø¨Ù‚Ø±Ù‰ 500 Ø¬Ù…",
"ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù…Ø§Ù† Ø³Ù…Ù† Ø¨Ù‚Ø±Ù‰ 500 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ø³Ù…Ù† Ø¨Ù‚Ø±Ù‰ 200 Ø¬Ù…",
"ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù…Ø§Ù† Ø³Ù…Ù† Ø¨Ù‚Ø±Ù‰ 200 Ø¬Ù…",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ Ù‚Ø·Ø¹ 10Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ø´ ÙƒØ±ÙŠÙ…Ù‰ 10Ùƒ",
"ÙƒØ±ØªÙˆÙ†Ø© ØªØ¹Ø¨Ø£Ø© Ø§Ø±Ø²",
"ÙƒØ±ØªÙˆÙ†Ø© ØªØ¹Ø¨Ø£Ø© Ø²Ø¨Ø§Ø¯Ù‰",
"ÙƒØ±ØªÙˆÙ†Ø© ØªØ¹Ø¨Ø£Ø© Ø³Ù…Ù† 800 Ø¬Ù…",
"ÙƒØ±ØªÙˆÙ†Ø© ØªØ¹Ø¨Ø£Ø© Ø³Ù…Ù† 500 Ø¬Ù…",
"ÙƒØ±ØªÙˆÙ†Ø© ØªØ¹Ø¨Ø£Ø© Ø³Ù…Ù†-Ù…ÙˆØ±ØªØ© 200 Ø¬Ù…",
"Ø±ÙˆÙ„ Ø§Ø³ØªØ±ØªØ´ 40Ø³Ù…",
"Ø§ÙƒÙŠØ§Ø³ Ù…ÙˆØ±ØªØ©  ÙØ§ÙƒÙŠÙˆÙ…",
"Ø§ÙŠØ³ Ø¨ÙˆÙƒØ³ ÙÙ„ ÙƒØ¨ÙŠØ±",
"Ø§ÙŠØ³ Ø¨ÙˆÙƒØ³ ÙÙ„ ØµØºÙŠØ±",
"Ø¹Ù„Ø¨Ø© Ø´ÙØ§Ù ÙƒØ¨ÙŠØ±",
"ØºØ·Ø§Ø¡ Ø´ÙØ§Ù ÙƒØ¨ÙŠØ±",
"Ø§ÙƒÙŠØ§Ø³ Ù„Ø¨Ù† Ø´ÙØ§Ù 2Ùƒ",
"ÙÙ„ØªØ± Ù…Ø­Ù„Ø¨",
"Ø¹Ù„Ø¨Ø© Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡ Ø³Ø§Ø¯Ø©",
"ØºØ·Ø§Ø¡ Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡ Ø³Ø§Ø¯Ø©",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ ÙÙŠØªØ§ Ø³Ø§Ø¯Ø© Ø·Ø¨ÙŠØ¹Ù‰",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ ÙÙŠØªØ§ ÙÙ„ÙÙ„ Ø·Ø¨ÙŠØ¹Ù‰",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ Ù…Ù„Ø­ Ø®ÙÙŠÙ Ø·Ø¨ÙŠØ¹Ù‰",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ ØµÙˆØ§Ù†Ù‰ Ù…Ø³ØªØ·ÙŠÙ„Ø©",
"Ø§Ø³ØªÙŠÙƒØ± Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ© Ø³ÙˆØ¯Ø§Ø¡ 4Ùƒ",
"Ø§ÙƒÙŠØ§Ø³ Ø²Ø¨Ø¯Ø© ÙØ§ÙƒÙŠÙˆÙ…",
"Ø¹Ù„Ø¨Ø© ÙØ§Ø±Øº 1Ùƒ",
"ØºØ·Ø§Ø¡ Ø§Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù†-Ø²Ø¨Ø§Ø¯Ù‰ 500 Ø¬Ù…",
"Ø§ÙƒÙŠØ§Ø³ Ù‚Ù…Ø§Ù…Ø©",
"Ø§ÙˆÙØ± Ù‡ÙŠØ¯ Ø¨Ø§ÙƒØª",
"Ø¬Ø±Ø¯Ù„ ÙØ§Ø±Øº 8Ùƒ",
"Ø¬Ø±Ø¯Ù„ ÙØ§Ø±Øº 3Ùƒ",
"Ø§ÙÙŠØ² ÙƒÙŠØ³",
"Ù…Ù†Ø§Ø¯ÙŠÙ„ ÙÙŠØªØ§ ÙÙ„ÙÙ„ Ù†Ø¨Ø§ØªÙ‰",
"Ù„ÙˆØ¬Ùˆ Ø§Ù„Ø±Ø¨ÙŠØ¹ ÙÙŠØªØ§ Ø³Ø§Ø¯Ø© Ø·Ø¨ÙŠØ¹Ù‰",
"Ù„ÙˆØ¬Ùˆ Ø§Ù„Ø±Ø¨ÙŠØ¹ Ù…Ù„Ø­ Ø®ÙÙŠÙ Ø·Ø¨ÙŠØ¹Ù‰",
"ØºØ·Ø§Ø¡ Ø¨Ø±Ø·Ù…Ø§Ù† Ø³Ù…Ù† 800 / 500 Ø¬Ù…",
"ØºØ·Ø§Ø¡ Ø¨Ø±Ø·Ù…Ø§Ù† Ø³Ù…Ù† 200 Ø¬Ù… / 300 Ø¬Ù…",
"Ø¨Ø±Ø·Ù…Ø§Ù† 200 Ø¬Ù…",
"Ø·Ø¨Ù‚ Ø¨Ù„Ø§Ø³ØªÙŠÙƒ 500 Ø¬Ù…",
"Ø¹Ù„Ø¨Ø© Ø¨Ù„Ø§Ø³ØªÙŠÙƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡ 250 Ø¬Ù…",
"ÙƒÙŠØ³ Ø´Ø±Ù†Ùƒ",
"ÙØ®Ø§Ø± Ø²Ø¨Ø§Ø¯Ù‰",
"ÙØ®Ø§Ø± Ø§Ø±Ø²",
"Ø¹Ù„Ø¨Ø© Ø¨Ù„Ø§Ø³ØªÙŠÙƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡ 125 Ø¬Ù…",
"Ø¹Ù„Ø¨ Ø²Ø¨Ø§Ø¯Ù‰ Ø¨Ø§Ù„ØºØ·Ø§Ø¡ Ø£Ø¨Ùˆ Ø§Ù„Ø®ÙŠØ±",
"Ø²Ø¬Ø§Ø¬Ø© Ù„Ø¨Ù† ÙØ§Ø±ØºØ©",
"ÙØ®Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ø±",
"Ø§Ø·Ø¨Ø§Ù‚ 1Ùƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡",
"Ø¹Ù„Ø¨Ø© ÙØ§Ø±Øº 4Ùƒ Ø¨Ø§Ù„ØºØ·Ø§Ø±",
"Ø§Ø³ØªÙŠÙƒØ± Ù…Ù„Ø­ Ø®ÙÙŠÙ Ù†Ø¨Ø§ØªÙ‰ 4Ùƒ",
"Ø§Ø³ØªÙŠÙƒØ± ÙÙŠØªØ§ Ù†Ø¨Ø§ØªÙ‰ 4Ùƒ",
"Ø§ÙƒÙŠØ§Ø³ Ù„Ø¨Ù† Ø´ÙØ§Ù 500 Ø¬Ù…",
"Ø³Ù„ÙˆØªÙŠØ¨ Ø¹Ø±ÙŠØ¶",
"Ø§ÙˆÙØ± Ø´ÙˆØ²",
"ÙƒÙ…Ø§Ù…Ù‡",
"Ø´Ø±Ø§Ø¨",
"Ø¨Ø§Ø±ÙƒÙˆØ¯ ØµØºÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ù‡",
"Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙƒØ¨ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ù‡",
"ÙƒÙŠØ³ Ù…Ø¹Ø§Ù„Ù‚",
"Ø§ÙƒÙŠØ§Ø³ Ø´Ø±Ù†Ùƒ Ø§Ø±Ø²",
"Ø§ÙƒÙŠØ§Ø³ Ø´Ø±Ù†Ùƒ Ø²Ø¨Ø§Ø¯Ù‰",
"Ø¬ÙˆØ§Ù†ØªÙ‰ ÙƒÙŠØ³",
"ÙƒØ±ØªÙˆÙ†Ø© ØªØ¹Ø¨Ø£Ø© Ù…ÙˆØ²Ø±ÙŠÙ„Ø§",
"Ø¨ÙƒØ± Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø­Ø±Ø§Ø±Ù‰",
"Ø§Ø³ØªÙŠÙƒØ± Ø²Ø¨Ø§Ø¯Ù‰ ÙØ®Ø§Ø±",
"Ø§Ø³ØªÙŠÙƒØ± Ø§Ø±Ø² ÙØ®Ø§Ø±",
"ÙƒØ±ØªÙˆÙ†Ù‡ Ù…ÙˆØ²Ø±ÙŠÙ„Ø§",
"Ø±ÙˆÙ„ Ø§Ø³ØªØ±ØªØ´ 10 Ø³Ù…",
"Ø¬Ø±Ø¯Ù„ 4Ùƒ Ø¨Ø§Ù„ØºØ·Ø§Ø¡",
"Ø¬Ø±Ø¯Ù„ 4Ùƒ",
"ØºØ·Ø§Ø¡ Ø¬Ø±Ø¯Ù„ 4Ùƒ",
"Ø¹Ù„Ø¨Ù‡ Ù…ÙØµÙ„ÙŠ Ø´ÙØ§Ù Ø¨Ø§Ù„ØºØ·Ø§Ø¡"
            ];
            try{
                let added = 0;
                PACK_ITEMS.forEach(name => {
                    if(!costPack.some(x => String(x.name).trim() === String(name).trim())){
                        const id = 'pack-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
                        costPack.push({ id, code: id, name: name, unit: 'Ù‚Ø·Ø¹Ø©', cost: 0 });
                        added++;
                    }
                });
                if(added > 0) saveLists();
                console.log('Added packaging items:', added);
                // Don't show an alert on initial population to avoid annoying startup popups.
                // If the user wants confirmation, they can open Manage Lists or export the lists.
            } catch(e){ console.warn('addDefaultPackItems error', e); }
        })();

        // --- Excel Import (SheetJS) ---
        function loadSheetJs() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) return resolve(window.XLSX);
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
                s.onload = () => resolve(window.XLSX);
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        function detectKey(keys, candidates){
            const norm = k => String(k||'').trim().toLowerCase();
            for(const k of keys){
                const n = norm(k);
                for(const c of candidates){ if(n.indexOf(c) !== -1) return k; }
            }
            return null;
        }

        async function handleExcelFile(file) {
            try{
                await loadSheetJs();
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type:'array'});
                const first = wb.SheetNames[0];
                const sheet = wb.Sheets[first];
                const rows = XLSX.utils.sheet_to_json(sheet, {defval: ''});
                if(!rows || !rows.length) return alert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');

                // detect columns
                const sampleKeys = Object.keys(rows[0]);
                const codeKey = detectKey(sampleKeys, ['code','ÙƒÙˆØ¯']);
                const nameKey = detectKey(sampleKeys, ['name','item','Ø§Ù„Ø¨ÙŠØ§Ù†','Ø§Ø³Ù…']);
                const unitKey = detectKey(sampleKeys, ['unit','Ø§Ù„ÙˆØ­Ø¯Ø©','ÙˆØ­Ø¯Ø©']);
                const costKey = detectKey(sampleKeys, ['ØªÙƒÙ„Ù','cost']);
                const priceKey = detectKey(sampleKeys, ['Ø³Ø¹Ø±','price','Ø¨ÙŠØ¹']);
                const sectionKey = detectKey(sampleKeys, ['Ù‚Ø³Ù…','Ø§Ù„Ù‚Ø³Ù…','category','type']);

                let addedFinished = 0, addedRaw = 0, addedPack = 0;
                rows.forEach(r => {
                    const code = String(r[codeKey] || r['Code'] || r['code'] || '').trim() || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    const name = String(r[nameKey] || r['Item Name'] || r['item name'] || '').trim() || '';
                    const unit = String(r[unitKey] || '').trim() || '';
                    const cost = parseFloat(String(r[costKey] || r['Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©'] || r['Cost'] || '') || 0) || 0;
                    const price = parseFloat(String(r[priceKey] || r['Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹'] || r['Price'] || '') || 0) || 0;
                    const section = String(r[sectionKey] || r['Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†'] || r['Ø§Ù„Ù‚Ø³Ù…'] || '').trim().toLowerCase();

                    const item = { id: code, code, name, unit, cost, price };
                    // heuristics to classify
                    if(section.includes('Ø§Ù†ØªØ§Ø¬') || section.includes('ØªØ§Ù…') || section.includes('product') || (name && (name.toLowerCase().indexOf('Ø¬Ø¨Ù†Ø©')>-1 || name.toLowerCase().indexOf('Ù„Ø¨Ù†')>-1))) {
                        costFinished.push(item); addedFinished++;
                    } else if(section.includes('Ø®Ø§Ù…Ø§Øª') || section.includes('Ø®Ø§Ù…') || section.includes('Ù…ÙˆØ§Ø¯') || section.includes('raw')){
                        costRaw.push(item); addedRaw++;
                    } else if(section.includes('ØªØ¹Ø¨') || section.includes('ØªØºÙ„ÙŠÙ') || section.includes('pack') || section.includes('Ø¹Ø¨ÙˆØ©')){
                        costPack.push(item); addedPack++;
                    } else {
                        // default: finished
                        costFinished.push(item); addedFinished++;
                    }
                });

                saveLists();
                alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù…Ø© ${addedFinished} â€” Ø§Ù„Ø®Ø§Ù…Ø§Øª ${addedRaw} â€” Ø§Ù„ØªØºÙ„ÙŠÙ ${addedPack}`);
            } catch(e){ console.error('Excel import failed', e); alert('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: ' + (e && e.message)); }
        }

        // wire import controls
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'cost-import-xlsx-btn'){
                const inp = document.getElementById('cost-excel-input'); if(inp) inp.click();
            }
            if(e.target && e.target.id === 'cost-import-from-state-btn'){
                // import existing app products (state.products or DEFAULT_PRODUCTS)
                const src = (Array.isArray(state.products) && state.products.length) ? state.products : DEFAULT_PRODUCTS || [];
                let added = 0;
                src.forEach(p =>{
                    const id = p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    const existing = costFinished.find(x => String(x.id) === String(id));
                    if(!existing){ costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'Ù‚Ø·Ø¹Ø©', price: Number(p.price||p.sellPrice||0) }); added++; }
                });
                saveLists();
                alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ' + added + ' Ù…Ù†ØªØ¬ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
            }
        });
        document.getElementById('cost-excel-input') && document.getElementById('cost-excel-input').addEventListener('change', function(e){
            const f = e.target.files && e.target.files[0]; if(f) handleExcelFile(f);
            // reset input
            e.target.value = '';
        });
    })();
    </script>
        <!-- Claude client helper: call Netlify proxy at /api/claude -->
        <script>
            (function(){
                if (window.ClaudeAPI) return; // guard
                window.ClaudeAPI = {
                    async chat(opts){
                        const payload = {
                            model: (opts && opts.model) || 'claude-3-5-sonnet-20241022',
                            max_tokens: (opts && opts.max_tokens) || 512,
                            system: opts && opts.system,
                            messages: (opts && opts.messages) || [],
                            stream: !!(opts && opts.stream)
                        };
                        const res = await fetch('/api/claude', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) {
                            const text = await res.text().catch(()=> '');
                            throw new Error('Claude proxy error: HTTP ' + res.status + (text ? ('\n' + text) : ''));
                        }
                        const ct = res.headers.get('content-type')||'';
                        if (ct.includes('application/json')) return res.json();
                        return res.text();
                    },
                    async simple(prompt, extra){
                        const messages = [{ role: 'user', content: prompt }];
                        const data = await this.chat({ ...(extra||{}), messages });
                        try {
                            const parts = Array.isArray(data && data.content) ? data.content : [];
                            const txt = parts.find(p => p && p.type === 'text');
                            return txt ? txt.text : JSON.stringify(data);
                        } catch(e){ return JSON.stringify(data||{}); }
                    }
                };

                // Minimal console test helper (optional)
                window.testClaude = async function(){
                    try {
                        console.time('claude');
                        const out = await window.ClaudeAPI.simple('Ù‚Ù„ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!');
                        console.timeEnd('claude');
                        alert(out);
                    } catch(err){
                        console.error(err);
                        alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Claude: ' + (err && err.message));
                    }
                };
            })();

            // ================= Simplified Cost (Recipe) Feature =================
            (function(){
                const LS_SIMPLE_RECIPES = 'simple_cost_recipes';
                let simpleRecipes = [];
                let lastFocusedRecipeId = null;
                // timers to debounce input handling per recipe card to avoid rebuilding DOM on every keystroke
                const recipeInputTimers = new Map();

                function loadSimpleRecipes(){
                    try { const raw = localStorage.getItem(LS_SIMPLE_RECIPES); simpleRecipes = raw ? JSON.parse(raw) : []; if(!Array.isArray(simpleRecipes)) simpleRecipes = []; } catch(e){ simpleRecipes = []; }
                    // Also load drafts to restore them if user revisits
                    try { const draftRaw = localStorage.getItem('costDrafts'); if (draftRaw) state.costDrafts = JSON.parse(draftRaw); } catch(e){}
                    // Expose to global window for other functions
                    window.simpleRecipes = simpleRecipes;
                }
                function saveSimpleRecipes(){ try { localStorage.setItem(LS_SIMPLE_RECIPES, JSON.stringify(simpleRecipes)); window.simpleRecipes = simpleRecipes; } catch(e){} }
                function toNum(v){ return parseFloat(v||0) || 0; }
                function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
                function computeRecipe(r){
                    const ingredientsCost = (r.ingredients||[]).reduce((a,x)=> a + (toNum(x.qtyKg) * toNum(x.unitCost)), 0);
                    const packagingCost = (r.packaging||[]).reduce((a,x)=> a + toNum(x.cost), 0);
                    const operationsCost = (r.operations||[]).reduce((a,x)=> a + toNum(x.cost), 0);
                    const totalBatchCost = ingredientsCost + packagingCost + operationsCost;
                    const costPerKg = toNum(r.batchSizeKg) > 0 ? totalBatchCost / toNum(r.batchSizeKg) : 0;
                    return { ingredientsCost, packagingCost, operationsCost, totalBatchCost, costPerKg };
                }
                function ingredientRow(idx, ing){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="ing">\n<input class="ing-name flex-1 p-1 border rounded text-xs" placeholder="Ø§Ø³Ù…" value="${esc(ing.name)}" />\n<input class="ing-qty w-20 p-1 border rounded text-xs text-center" placeholder="ÙƒÙ…ÙŠØ©" value="${esc(ing.qtyKg)}" />\n<input class="ing-cost w-20 p-1 border rounded text-xs text-center" placeholder="Ø³Ø¹Ø±/ÙƒØ¬Ù…" value="${esc(ing.unitCost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">Ã—</button>\n</div>`;
                }
                function packagingRow(idx, pk){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="pack">\n<input class="pack-name flex-1 p-1 border rounded text-xs" placeholder="Ø§Ø³Ù…" value="${esc(pk.name)}" />\n<input class="pack-cost w-24 p-1 border rounded text-xs text-center" placeholder="Ù‚ÙŠÙ…Ø©" value="${esc(pk.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">Ã—</button>\n</div>`;
                }
                function operationRow(idx, op){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="op">\n<input class="op-name flex-1 p-1 border rounded text-xs" placeholder="ÙˆØµÙ" value="${esc(op.name)}" />\n<input class="op-cost w-24 p-1 border rounded text-xs text-center" placeholder="Ù‚ÙŠÙ…Ø©" value="${esc(op.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">Ã—</button>\n</div>`;
                }
                function computeAndCardHTML(r){
                    const c = computeRecipe(r);
                    // Try to restore draft values if they exist
                    if (!state.costDrafts) state.costDrafts = {};
                    const draft = state.costDrafts[r.id] || {};
                    const name = draft.name || r.name || '';
                    const batchSizeKg = draft.batchSizeKg || r.batchSizeKg || '';
                    const notes = draft.notes || r.notes || '';
                    const ingredients = (draft.ingredients && Array.isArray(draft.ingredients) && draft.ingredients.length > 0) ? draft.ingredients : r.ingredients;
                    const packaging = (draft.packaging && Array.isArray(draft.packaging) && draft.packaging.length > 0) ? draft.packaging : r.packaging;
                    const operations = (draft.operations && Array.isArray(draft.operations) && draft.operations.length > 0) ? draft.operations : r.operations;
                    return `<div class="flex items-center gap-2 mb-2">\n<input class="recipe-name w-full p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" value="${esc(name)}" />\n<input class="recipe-batch w-28 p-2 border rounded" placeholder="Ø¯ÙØ¹Ø© ÙƒØ¬Ù…" value="${esc(batchSizeKg)}" />\n<button class="delete-recipe bg-red-600 text-white px-2 py-1 rounded text-sm">Ø­Ø°Ù</button>\n<button class="save-produce-card bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-sm" data-recipe-id="${esc(r.id)}">Ø­ÙØ¸ ÙˆØ¥Ù†ØªØ§Ø¬</button>\n</div>\n<div class="grid md:grid-cols-3 gap-4">\n<div>\n<h4 class="font-semibold text-sm mb-1">Ø§Ù„Ø®Ø§Ù…Ø§Øª</h4>\n<div class="ingredients space-y-2">${ingredients.map((ing,i)=> ingredientRow(i, ing)).join('')}</div>\n<button class="add-ingredient bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ Ø®Ø§Ù…Ø©</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">Ø§Ù„ØªØ¹Ø¨Ø¦Ø©</h4>\n<div class="packaging space-y-2">${packaging.map((pk,i)=> packagingRow(i, pk)).join('')}</div>\n<button class="add-packaging bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ ØªØºÙ„ÙŠÙ</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">Ø§Ù„ØªØ´ØºÙŠÙ„</h4>\n<div class="operations space-y-2">${operations.map((op,i)=> operationRow(i, op)).join('')}</div>\n<button class="add-operation bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ ØªØ´ØºÙŠÙ„</button>\n</div>\n</div>\n<div class="text-sm bg-gray-50 border rounded p-3 grid grid-cols-2 md:grid-cols-5 gap-2">\n<div><span class="text-gray-600">Ø®Ø§Ù…Ø§Øª:</span> <span class="font-bold">${c.ingredientsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">ØªØºÙ„ÙŠÙ:</span> <span class="font-bold">${c.packagingCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">ØªØ´ØºÙŠÙ„:</span> <span class="font-bold">${c.operationsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø©:</span> <span class="font-bold">${c.totalBatchCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">Ø§Ù„ØªÙƒÙ„ÙØ© / ÙƒØ¬Ù…:</span> <span class="font-bold">${c.costPerKg.toFixed(2)}</span></div>\n</div>\n<textarea class="recipe-notes w-full p-2 border rounded text-sm" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">${esc(notes)}</textarea>`;
                }
                function renderRecipes(){
                    const listEl = document.getElementById('recipes-list'); if(!listEl) return;
                    listEl.innerHTML = '';
                    if(simpleRecipes.length === 0){
                        listEl.innerHTML = '<div class="p-4 bg-white rounded shadow text-sm text-gray-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· "Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯".</div>';
                        return;
                    }
                    simpleRecipes.forEach(r => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow border p-4 space-y-3';
                        card.setAttribute('data-id', r.id);
                        card.innerHTML = computeAndCardHTML(r);
                        listEl.appendChild(card);

                // Attach autosave handlers to card inputs for persistent drafts
                        try {
                            const inputs = card.querySelectorAll('input, textarea');
                            inputs.forEach(input => {
                                // Real-time save on input (no debounce for smooth typing)
                                input.addEventListener('input', () => {
                                    saveCostCardDraft(card);
                                });
                                // Save on blur
                                input.addEventListener('blur', () => {
                                    saveCostCardDraft(card);
                                });
                                // Also save when Tab is pressed
                                input.addEventListener('keydown', (ev) => {
                                    if (ev.key === 'Tab') {
                                        saveCostCardDraft(card);
                                    }
                                    // On Enter in ingredient/packaging/operation name field, show autocomplete if appropriate
                                    if (ev.key === 'Enter') {
                                        ev.preventDefault();
                                        saveCostCardDraft(card);
                                        // Move to next focusable element
                                        const focusables = Array.from(card.querySelectorAll('input, textarea, button')).filter(el => !el.disabled && el.offsetParent !== null);
                                        const idx = focusables.indexOf(ev.target);
                                        if (idx >= 0 && idx < focusables.length - 1) {
                                            focusables[idx + 1].focus();
                                        }
                                    }
                                });
                            });

                            // Attach autocomplete handlers for ingredient/packaging names
                            const ingNameInputs = card.querySelectorAll('.ingredients .ing-name');
                            const packNameInputs = card.querySelectorAll('.packaging .pack-name');
                            const opNameInputs = card.querySelectorAll('.operations .op-name');

                            ingNameInputs.forEach(inp => {
                                inp.addEventListener('focus', (e) => {
                                    showCostAutocomplete(e.target, 'ingredient');
                                });
                                inp.addEventListener('input', (e) => {
                                    if (e.target.value.trim().length > 0) {
                                        showCostAutocomplete(e.target, 'ingredient');
                                    }
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });

                            packNameInputs.forEach(inp => {
                                inp.addEventListener('focus', (e) => {
                                    showCostAutocomplete(e.target, 'packaging');
                                });
                                inp.addEventListener('input', (e) => {
                                    if (e.target.value.trim().length > 0) {
                                        showCostAutocomplete(e.target, 'packaging');
                                    }
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });

                            opNameInputs.forEach(inp => {
                                inp.addEventListener('focus', (e) => {
                                    showCostAutocomplete(e.target, 'operation');
                                });
                                inp.addEventListener('input', (e) => {
                                    if (e.target.value.trim().length > 0) {
                                        showCostAutocomplete(e.target, 'operation');
                                    }
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });
                        } catch (err) {
                            console.warn('attach card handlers failed', err);
                        }
                    });
                }
                function addRecipe(){
                    const r = { id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name: '', batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' };
                    simpleRecipes.push(r); 
                    saveSimpleRecipes(); 
                    renderRecipes();
                    lastFocusedRecipeId = r.id;
                    
                    // Show the save and produce button
                    const saveBtn = document.getElementById('save-and-produce-btn');
                    if (saveBtn) saveBtn.style.display = 'inline-flex';
                    
                    // Auto-create a production run for this recipe
                    try {
                        const startDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                        window.createProductionRun(r.id, startDate, null, 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ');
                    } catch(err) {
                        console.warn('Failed to auto-create production run:', err);
                    }
                }
                
                function saveAndProduceRecipe() {
                    if (!lastFocusedRecipeId) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆØµÙØ© Ø£ÙˆÙ„Ø§Ù‹');
                        return;
                    }
                    
                    const recipe = (window.simpleRecipes || []).find(r => r.id === lastFocusedRecipeId);
                    if (!recipe || !recipe.name) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹');
                        return;
                    }
                    
                    // Save the recipe
                    saveSimpleRecipes();
                    alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØµÙØ©: ${recipe.name}`);
                    
                    // Create production run and navigate
                    try {
                        const startDate = new Date().toISOString().split('T')[0];
                        const success = window.createProductionRun(recipe.id, startDate, null, `ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ - ${recipe.name}`);
                        if (success) {
                            // Navigate to production page
                            setTimeout(() => {
                                window.navigateTo('production');
                            }, 300);
                        } else {
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø©');
                        }
                    } catch(err) {
                        console.warn('Failed to create production run:', err);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø©');
                    }
                }
                function importFromOld(){
                    try{ if(typeof loadLists === 'function'){ loadLists(); } }catch(e){}
                    const fins = Array.isArray(window.costFinished)? window.costFinished : [];
                    const raws = Array.isArray(window.costRaw)? window.costRaw : [];
                    const packs = Array.isArray(window.costPack)? window.costPack : [];
                    let created = 0, updated = 0;
                    const byId = (arr,id)=> arr.find(x=> String(x.id) === String(id));
                    const unitCostOfRaw = r => (r && (r.lastPrice!=null?r.lastPrice:r.cost)) || 0;
                    const unitCostOfPack = p => (p && (p.lastPrice!=null?p.lastPrice:p.cost)) || 0;
                    fins.forEach(p => {
                        const name = (p && (p.name||p.code||'')).toString(); if(!name) return;
                        let existing = simpleRecipes.find(r=> (r.name||'') === name);
                        if(!existing){ existing = { id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' }; simpleRecipes.push(existing); created++; }
                        // try read BOM by id, then code, then name
                        const keys = [ p.id, p.code, p.name ].filter(Boolean).map(v => 'bom_' + v);
                        let bomObj = null;
                        for(const k of keys){ try{ const raw = localStorage.getItem(k); if(raw){ bomObj = JSON.parse(raw); break; } }catch(e){} }
                        if(!bomObj || !Array.isArray(bomObj.items)){ updated += 0; return; }
                        const ings = []; const pkgs = [];
                        bomObj.items.forEach(it => {
                            const qty = parseFloat(it.qty||0) || 0;
                            if((it.type||'').toLowerCase() === 'raw'){
                                const r = byId(raws, it.id);
                                ings.push({ name: (r && r.name) || (it.name||'Ù…ÙƒÙˆÙ‘Ù†'), qtyKg: qty || '', unitCost: unitCostOfRaw(r) });
                            } else if((it.type||'').toLowerCase() === 'pack'){
                                const pk = byId(packs, it.id);
                                const uc = unitCostOfPack(pk);
                                pkgs.push({ name: (pk && pk.name) || (it.name||'ØªØºÙ„ÙŠÙ'), cost: (qty * uc) || 0 });
                            }
                        });
                        // estimate batch size = sum raw qty where unit probably kg if data exists
                        const batch = ings.reduce((a,x)=> a + (parseFloat(x.qtyKg||0)||0), 0);
                        if(batch > 0 && !existing.batchSizeKg) existing.batchSizeKg = batch;
                        // merge by appending if empty
                        if(existing.ingredients.length === 0) existing.ingredients = ings;
                        if(existing.packaging.length === 0) existing.packaging = pkgs;
                        updated++;
                    });
                    saveSimpleRecipes(); renderRecipes();
                    alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ø£Ù†Ø´Ø¦Øª ${created} ÙˆØµÙØ§ØªØŒ ÙˆØªÙ… ØªØ­Ø¯ÙŠØ« ${updated}.`);
                }
                // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµØ§Ù…Øª Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·)
                function silentImportIfEmpty(){
                    try{ if(typeof loadLists === 'function'){ loadLists(); } }catch(e){}
                    if (simpleRecipes.length > 0) return; // Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ Ù„Ùˆ ØªÙˆØ¬Ø¯ ÙˆØµÙØ§Øª Ø¨Ø§Ù„ÙØ¹Ù„
                    const fins = Array.isArray(window.costFinished)? window.costFinished : [];
                    const raws = Array.isArray(window.costRaw)? window.costRaw : [];
                    const packs = Array.isArray(window.costPack)? window.costPack : [];
                    if (!fins.length && !raws.length && !packs.length) return; // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
                    let created = 0;
                    fins.forEach(p => {
                        const name = (p && (p.name||p.code||'')); if(!name) return;
                        if(!simpleRecipes.some(r => r.name === name)){
                            simpleRecipes.push({ id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg:'', ingredients:[], packaging:[], operations:[], notes:'' });
                            created++;
                        }
                    });
                    if (created){ saveSimpleRecipes(); renderRecipes(); }
                }
                // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ÙØªØ­ Ù„ØµÙØ­Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
                window.autoImportLegacyRecipesOnce = (function(){
                    let done = false;
                    return function(){ if(done) return; try { silentImportIfEmpty(); } catch(_){} done = true; };
                })();
                // ÙƒØ´Ù Ø§Ù„Ø¯ÙˆØ§Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹
                window.importOldCosts = importFromOld;
                window.importOldCostsSilent = silentImportIfEmpty;
                function syncCard(card){
                    const id = card.getAttribute('data-id'); const r = simpleRecipes.find(x=>x.id===id); if(!r) return;
                    r.name = card.querySelector('.recipe-name')?.value.trim() || '';
                    r.batchSizeKg = card.querySelector('.recipe-batch')?.value.trim() || '';
                    r.notes = card.querySelector('.recipe-notes')?.value || '';
                    r.ingredients = Array.from(card.querySelectorAll('.ingredients > div')).map(d => ({ name: d.querySelector('.ing-name')?.value.trim() || '', qtyKg: d.querySelector('.ing-qty')?.value.trim() || '', unitCost: d.querySelector('.ing-cost')?.value.trim() || '' }));
                    r.packaging = Array.from(card.querySelectorAll('.packaging > div')).map(d => ({ name: d.querySelector('.pack-name')?.value.trim() || '', cost: d.querySelector('.pack-cost')?.value.trim() || '' }));
                    r.operations = Array.from(card.querySelectorAll('.operations > div')).map(d => ({ name: d.querySelector('.op-name')?.value.trim() || '', cost: d.querySelector('.op-cost')?.value.trim() || '' }));
                    saveSimpleRecipes(); 
                    // DO NOT call renderRecipes() - preserve focus and DOM state
                }

                function saveCostCardDraft(card) {
                    try {
                        const id = card.getAttribute('data-id');
                        if (!id) return;
                        if (!state.costDrafts) state.costDrafts = {};
                        const draft = {
                            name: card.querySelector('.recipe-name')?.value.trim() || '',
                            batchSizeKg: card.querySelector('.recipe-batch')?.value.trim() || '',
                            notes: card.querySelector('.recipe-notes')?.value || '',
                            ingredients: Array.from(card.querySelectorAll('.ingredients > div')).map(d => ({
                                name: d.querySelector('.ing-name')?.value.trim() || '',
                                qtyKg: d.querySelector('.ing-qty')?.value.trim() || '',
                                unitCost: d.querySelector('.ing-cost')?.value.trim() || ''
                            })),
                            packaging: Array.from(card.querySelectorAll('.packaging > div')).map(d => ({
                                name: d.querySelector('.pack-name')?.value.trim() || '',
                                cost: d.querySelector('.pack-cost')?.value.trim() || ''
                            })),
                            operations: Array.from(card.querySelectorAll('.operations > div')).map(d => ({
                                name: d.querySelector('.op-name')?.value.trim() || '',
                                cost: d.querySelector('.op-cost')?.value.trim() || ''
                            }))
                        };
                        state.costDrafts[id] = draft;
                        try { localStorage.setItem('costDrafts', JSON.stringify(state.costDrafts)); } catch (e) {}
                    } catch (e) {
                        console.warn('saveCostCardDraft failed', e);
                    }
                }

                function showCostAutocomplete(input, type) {
                    try {
                        const searchTerm = input.value.trim().toLowerCase();
                        const container = input.parentElement;
                        let suggestionsList = container.querySelector('.cost-suggestions');

                        if (!suggestionsList) {
                            suggestionsList = document.createElement('div');
                            suggestionsList.className = 'cost-suggestions absolute bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-60 overflow-y-auto';
                            suggestionsList.style.display = 'none';
                            suggestionsList.style.direction = 'rtl';
                            suggestionsList.style.top = '100%';
                            suggestionsList.style.right = '0';
                            suggestionsList.style.minWidth = '250px';
                            suggestionsList.style.zIndex = '9999';
                            container.style.position = 'relative';
                            container.appendChild(suggestionsList);
                        }

                        // Build list from available sources: cost lists and app products
                        let predefinedNames = [];
                        try {
                            // From costRaw (raw materials) if present
                            if (type === 'ingredient' && Array.isArray(window.costRaw)) {
                                window.costRaw.forEach(it => {
                                    const n = (typeof it === 'string') ? it : (it && (it.name || it.code)) ? (it.name || it.code) : '';
                                    if (n) predefinedNames.push(String(n).trim());
                                });
                            }
                            // From costPack (packaging) if present
                            if (type === 'packaging' && Array.isArray(window.costPack)) {
                                window.costPack.forEach(it => {
                                    const n = (typeof it === 'string') ? it : (it && (it.name || it.code)) ? (it.name || it.code) : '';
                                    if (n) predefinedNames.push(String(n).trim());
                                });
                            }
                            // Also pull from global state.products filtering by category as fallback/augmentation
                            if (Array.isArray(state.products)) {
                                state.products.forEach(p => {
                                    const name = (p && (p.name || p.title || p.code)) ? String(p.name || p.title || p.code).trim() : '';
                                    const cat = (p && p.category) ? String(p.category).toLowerCase() : '';
                                    if (!name) return;
                                    if (type === 'ingredient') {
                                        if (cat.includes('Ø®Ø§Ù…') || cat.includes('Ù…Ø§Ø¯Ø©') || cat.includes('Ù…ÙƒÙˆÙ†Ø§Øª')) predefinedNames.push(name);
                                    } else if (type === 'packaging') {
                                        if (cat.includes('ØªØ¹Ø¨Ø¦Ø©') || cat.includes('ØªØºÙ„ÙŠÙ') || cat.includes('Ø¹Ø¨ÙˆØ©') || cat.includes('ÙˆØ±Ù‚') || cat.includes('ÙƒÙŠØ³')) predefinedNames.push(name);
                                    } else {
                                        predefinedNames.push(name);
                                    }
                                });
                            }
                        } catch (e) {
                            // ignore and continue with whatever we collected
                        }

                        // Fallback to small built-in lists if nothing found
                        if (predefinedNames.length === 0) {
                            if (type === 'ingredient') {
                                predefinedNames = ['Ù„Ø¨Ù† Ø¨ÙˆØ¯Ø±Ø©','Ø³ÙƒØ±','Ù…ÙŠØ§Ù‡','Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…'];
                            } else if (type === 'packaging') {
                                predefinedNames = ['Ø§Ø³ØªÙŠÙƒØ± Ù‚Ø´Ø·Ø©','Ø¨Ø±Ø·Ù…Ø§Ù† 500 Ø¬Ù…','Ø¬Ø±Ø¯Ù„ ÙØ§Ø±Øº 3Ùƒ'];
                            }
                        }

                        // De-duplicate and normalize
                        const seen = new Set();
                        const uniqueNames = [];
                        predefinedNames.forEach(n => {
                            const key = String(n || '').trim();
                            if (!key) return;
                            const lk = key.toLowerCase();
                            if (!seen.has(lk)) { seen.add(lk); uniqueNames.push(key); }
                        });

                        // Filter by search term or show full list on empty
                        let matches = [];
                        if (!searchTerm) {
                            // Show all available names (no limit for full access)
                            matches = uniqueNames;
                        } else {
                            // Filter by search term and show up to 200 results
                            matches = uniqueNames.filter(name => name.toLowerCase().includes(searchTerm)).slice(0, 200);
                        }

                        if (matches.length === 0) {
                            suggestionsList.innerHTML = '<div class="p-2 text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚ØªØ±Ø­Ø§Øª</div>';
                            suggestionsList.style.display = 'block';
                            return;
                        }

                        suggestionsList.innerHTML = matches.map(name => `
                            <div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-product-name="${name}">
                                ${name}
                            </div>
                        `).join('');
                        suggestionsList.style.display = 'block';

                        // Handle suggestion click
                        suggestionsList.removeEventListener('click', () => {});
                        suggestionsList.addEventListener('click', (e) => {
                            const item = e.target.closest('[data-product-name]');
                            if (item) {
                                input.value = item.getAttribute('data-product-name');
                                suggestionsList.style.display = 'none';
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                                saveCostCardDraft(input.closest('[data-id]'));
                            }
                        });
                    } catch (err) {
                        console.warn('showCostAutocomplete failed', err);
                    }
                }

                function hideCostAutocomplete(input) {
                    try {
                        const suggestionsList = input.parentElement?.querySelector('.cost-suggestions');
                        if (suggestionsList) suggestionsList.style.display = 'none';
                    } catch (e) {}
                }
                document.addEventListener('click', function(e){
                    if(e.target && e.target.id === 'add-recipe-btn'){ addRecipe(); }
                    if(e.target && e.target.id === 'save-and-produce-btn'){ try { saveAndProduceRecipe(); } catch(_){ /* ignore */ } }
                    if(e.target && e.target.classList.contains('save-produce-card')){ 
                        const recipeId = e.target.getAttribute('data-recipe-id');
                        if(recipeId && window.simpleRecipes && Array.isArray(window.simpleRecipes)) {
                            const recipe = window.simpleRecipes.find(r => r.id === recipeId);
                            if (recipe && recipe.name) {
                                saveSimpleRecipes();
                                const startDate = new Date().toISOString().split('T')[0];
                                const success = window.createProductionRun(recipeId, startDate, null, `Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ - ${recipe.name}`);
                                if (success) {
                                    alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØµÙØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ ØªØ´ØºÙŠÙ„Ø©: ${recipe.name}`);
                                    setTimeout(() => window.navigateTo('production'), 300);
                                } else {
                                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø©');
                                }
                            } else {
                                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹');
                            }
                        }
                    }
                    if(e.target && e.target.id === 'import-old-costs-btn'){ importFromOld(); }
                    if(e.target && e.target.id === 'restore-costs-from-products-btn'){ try { if (window.restoreFromPriceLists) window.restoreFromPriceLists(); if (window.renderRecipes) window.renderRecipes(); } catch(_){} }
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(card){
                        if(e.target.classList.contains('add-ingredient')){ 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                r.ingredients.push({ name:'', qtyKg:'', unitCost:'' }); 
                                saveSimpleRecipes(); 
                                // Add row to DOM instead of full re-render
                                const ingDiv = card.querySelector('.ingredients');
                                if(ingDiv) {
                                    const idx = r.ingredients.length - 1;
                                    const newRow = document.createElement('div');
                                    newRow.className = 'flex gap-2 items-center';
                                    newRow.setAttribute('data-row', idx);
                                    newRow.setAttribute('data-type', 'ing');
                                    newRow.innerHTML = `<input class="ing-name flex-1 p-1 border rounded text-xs" placeholder="Ø§Ø³Ù…" value="" /><input class="ing-qty w-20 p-1 border rounded text-xs text-center" placeholder="ÙƒÙ…ÙŠØ©" value="" /><input class="ing-cost w-20 p-1 border rounded text-xs text-center" placeholder="Ø³Ø¹Ø±/ÙƒØ¬Ù…" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">Ã—</button>`;
                                    ingDiv.appendChild(newRow);
                                    const newIng = newRow.querySelector('.ing-name');
                                    if(newIng){
                                        newIng.addEventListener('focus', function(){ showCostAutocomplete(this, 'ingredient'); });
                                        newIng.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'ingredient'); });
                                        newIng.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
                                        newIng.focus();
                                    }
                                }
                            } 
                        }
                        if(e.target.classList.contains('add-packaging')){ 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                r.packaging.push({ name:'', cost:'' }); 
                                saveSimpleRecipes(); 
                                // Add row to DOM instead of full re-render
                                const packDiv = card.querySelector('.packaging');
                                if(packDiv) {
                                    const idx = r.packaging.length - 1;
                                    const newRow = document.createElement('div');
                                    newRow.className = 'flex gap-2 items-center';
                                    newRow.setAttribute('data-row', idx);
                                    newRow.setAttribute('data-type', 'pack');
                                    newRow.innerHTML = `<input class="pack-name flex-1 p-1 border rounded text-xs" placeholder="Ø§Ø³Ù…" value="" /><input class="pack-cost w-24 p-1 border rounded text-xs text-center" placeholder="Ù‚ÙŠÙ…Ø©" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">Ã—</button>`;
                                    packDiv.appendChild(newRow);
                                    const newPack = newRow.querySelector('.pack-name');
                                    if(newPack){
                                        newPack.addEventListener('focus', function(){ showCostAutocomplete(this, 'packaging'); });
                                        newPack.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'packaging'); });
                                        newPack.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
                                        newPack.focus();
                                    }
                                }
                            } 
                        }
                        if(e.target.classList.contains('add-operation')){ 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                r.operations.push({ name:'', cost:'' }); 
                                saveSimpleRecipes(); 
                                // Add row to DOM instead of full re-render
                                const opsDiv = card.querySelector('.operations');
                                if(opsDiv) {
                                    const idx = r.operations.length - 1;
                                    const newRow = document.createElement('div');
                                    newRow.className = 'flex gap-2 items-center';
                                    newRow.setAttribute('data-row', idx);
                                    newRow.setAttribute('data-type', 'op');
                                    newRow.innerHTML = `<input class="op-name flex-1 p-1 border rounded text-xs" placeholder="ÙˆØµÙ" value="" /><input class="op-cost w-24 p-1 border rounded text-xs text-center" placeholder="Ù‚ÙŠÙ…Ø©" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">Ã—</button>`;
                                    opsDiv.appendChild(newRow);
                                    const newOp = newRow.querySelector('.op-name');
                                    if(newOp){
                                        newOp.addEventListener('focus', function(){ showCostAutocomplete(this, 'operation'); });
                                        newOp.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'operation'); });
                                        newOp.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
                                        newOp.focus();
                                    }
                                }
                            } 
                        }
                        if(e.target.classList.contains('delete-recipe')){ 
                            if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')){ 
                                const id = card.getAttribute('data-id'); 
                                simpleRecipes = simpleRecipes.filter(x=>x.id!==id); 
                                saveSimpleRecipes(); 
                                card.remove(); // Just remove from DOM
                            } 
                        }
                        if(e.target.classList.contains('row-del')){ 
                            const row = e.target.closest('div[data-row]'); 
                            const type = row.getAttribute('data-type'); 
                            const idx = parseInt(row.getAttribute('data-row')); 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                if(type==='ing'){ r.ingredients.splice(idx,1); } 
                                else if(type==='pack'){ r.packaging.splice(idx,1); } 
                                else if(type==='op'){ r.operations.splice(idx,1); } 
                                saveSimpleRecipes(); 
                                row.remove(); // Just remove from DOM
                            } 
                        }
                    }
                });
                document.addEventListener('input', function(e){
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(!card) return;
                    const interesting = e.target.classList && (
                        e.target.classList.contains('recipe-name') ||
                        e.target.classList.contains('recipe-batch') ||
                        e.target.classList.contains('recipe-notes') ||
                        e.target.classList.contains('ing-name') ||
                        e.target.classList.contains('ing-qty') ||
                        e.target.classList.contains('ing-cost') ||
                        e.target.classList.contains('pack-name') ||
                        e.target.classList.contains('pack-cost') ||
                        e.target.classList.contains('op-name') ||
                        e.target.classList.contains('op-cost')
                    );
                    if(!interesting) return;

                    // Debounce removed - drafts now save in real-time via 'input' event listener above
                    // This prevents lag during typing
                });
                document.addEventListener('focusin', function(e){
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(card) lastFocusedRecipeId = card.getAttribute('data-id');
                });
                
                // Prevent unnecessary full re-renders on click - only render when needed
                let renderScheduled = false;
                function scheduleRender() {
                    if (renderScheduled) return;
                    renderScheduled = true;
                    setTimeout(() => {
                        renderRecipes();
                        // renderQuickLists removed - feature deleted
                        renderScheduled = false;
                    }, 100);
                }
                
                document.addEventListener('click', function(e){
                    // Only render if navigating TO costs page for the first time
                    if(e.target && e.target.getAttribute && e.target.getAttribute('data-page')==='costs'){ 
                        scheduleRender();
                    }
                    if(e.target && e.target.classList.contains('quick-add-item')){
                        const name = e.target.getAttribute('data-name')||''; const type = e.target.getAttribute('data-add-type');
                        if(!name) return;
                        // pick target recipe
                        let target = simpleRecipes.find(r=>r.id===lastFocusedRecipeId);
                        if(!target){ target = simpleRecipes.length === 1 ? simpleRecipes[0] : null; }
                        if(!target){ addRecipe(); target = simpleRecipes[simpleRecipes.length-1]; lastFocusedRecipeId = target.id; }
                        if(type === 'ing'){ target.ingredients.push({ name, qtyKg:'', unitCost:'' }); }
                        else if(type === 'pack'){ target.packaging.push({ name, cost:'' }); }
                        saveSimpleRecipes(); 
                        scheduleRender();
                    }
                });
                // expose for legacy navigation handler
                window.renderRecipes = renderRecipes;
                loadSimpleRecipes(); // initial

        })();
        
        // ===== PRODUCTION RUNS FUNCTIONS (GLOBAL SCOPE) =====
        function generateProductionId() {
            const today = new Date();
            const dateStr = today.getFullYear().toString() + String(today.getMonth() + 1).padStart(2, '0') + String(today.getDate()).padStart(2, '0');
            const count = (window.state.productions || []).filter(p => p.id && p.id.startsWith('PROD-' + dateStr)).length + 1;
            return 'PROD-' + dateStr + '-' + String(count).padStart(3, '0');
        }

        function calculateProductionCost(recipe) {
            if (!recipe) return 0;
            let total = 0;
            (recipe.ingredients || []).forEach(ing => { total += parseFloat(ing.cost) || 0; });
            (recipe.packaging || []).forEach(pkg => { total += parseFloat(pkg.cost) || 0; });
            (recipe.operations || []).forEach(op => { total += parseFloat(op.cost) || 0; });
            return total;
        }

        window.renderProductionRuns = function() {
            // This function is now an alias for renderProductionsList
            if (window.renderProductionsList) {
                window.renderProductionsList();
            }
        };
                
        window.openCreateProductionModal = function() {
            const recipeSelect = document.getElementById('production-recipe-select');
            const dateInput = document.getElementById('production-start-date');
            
            if (recipeSelect) {
                recipeSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ÙˆØµÙØ© --</option>';
                const recipes = window.simpleRecipes || [];
                console.log('Available recipes:', recipes);
                if (recipes.length === 0) {
                    recipeSelect.innerHTML += '<option disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙØ§Øª Ù…ØªØ§Ø­Ø©</option>';
                } else {
                    recipes.forEach(recipe => {
                        const option = document.createElement('option');
                        option.value = recipe.id;
                        option.textContent = recipe.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                        recipeSelect.appendChild(option);
                    });
                }
            }
            
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
            
            const modal = document.getElementById('modal-create-production');
            if (modal) {
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            }
            console.log('Opened create production modal');
        };

        // ===== ATTACH EVENT LISTENERS TO PRODUCTION EDIT BUTTONS =====
        function attachProductionButtonListeners() {
            const activeTable = document.getElementById('active-productions-table-body');
            const completedTable = document.getElementById('completed-productions-table-body');

            // Handle clicks on active productions table
            if (activeTable) {
                activeTable.addEventListener('click', function(e) {
                    const btn = e.target.closest('.btn-edit-production');
                    if (btn) {
                        const productionId = btn.dataset.id;
                        console.log('ğŸ“‹ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ´ØºÙŠÙ„Ø©:', productionId);
                        window.openEditProductionModal(productionId);
                    }
                });
            }

            // Handle clicks on completed productions table
            if (completedTable) {
                completedTable.addEventListener('click', function(e) {
                    const btn = e.target.closest('.btn-edit-production');
                    if (btn) {
                        const productionId = btn.dataset.id;
                        console.log('ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ØªØ´ØºÙŠÙ„Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©:', productionId);
                        window.openEditProductionModal(productionId);
                    }
                });
            }
        }

        window.renderProductionsList = function() {
            try {
                const activeBody = document.getElementById('active-productions-table-body');
                const completedBody = document.getElementById('completed-productions-table-body');
                if (!activeBody || !completedBody) return;

                const productions = window.state.productions || [];
                activeBody.innerHTML = '';
                completedBody.innerHTML = '';

                        const activeProds = productions.filter(p => p.status === 'in-progress');
                        const completedProds = productions.filter(p => p.status !== 'in-progress');

                        // Render active productions
                        activeProds.forEach(prod => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="px-3 py-3 text-right font-semibold text-blue-600">${escapeHtml(prod.id)}</td>
                                <td class="px-3 py-3 text-right">${escapeHtml(prod.productName || prod.recipeName)}</td>
                                <td class="px-3 py-3 text-right">${escapeHtml(prod.recipeName)}</td>
                                <td class="px-3 py-3 text-center text-sm">${prod.startDate || '-'}</td>
                                <td class="px-3 py-3 text-center">${prod.expectedQty || '-'}</td>
                                <td class="px-3 py-3 text-center"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†ØªØ§Ø¬</span></td>
                                <td class="px-3 py-3 text-center">
                                    <button class="btn-edit-production bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" data-id="${escapeHtml(prod.id)}">ØªØ­Ø¯ÙŠØ«</button>
                                </td>
                            `;
                            activeBody.appendChild(tr);
                        });

                        // Render completed productions
                        completedProds.forEach(prod => {
                            const tr = document.createElement('tr');
                            const profit = (prod.totalRevenue || 0) - (prod.totalCost || 0);
                            const profitClass = profit >= 0 ? 'text-green-600' : 'text-red-600';
                            tr.innerHTML = `
                                <td class="px-3 py-3 text-right font-semibold text-gray-600">${escapeHtml(prod.id)}</td>
                                <td class="px-3 py-3 text-right">${escapeHtml(prod.productName || prod.recipeName)}</td>
                                <td class="px-3 py-3 text-center">${prod.actualQty || prod.finalQty || '-'}</td>
                                <td class="px-3 py-3 text-right">${(prod.totalCost || 0).toFixed(2)}</td>
                                <td class="px-3 py-3 text-right">${(prod.totalRevenue || 0).toFixed(2)}</td>
                                <td class="px-3 py-3 text-right ${profitClass}"><strong>${profit.toFixed(2)}</strong></td>
                                <td class="px-3 py-3 text-center text-sm">${prod.completedDate || '-'}</td>
                                <td class="px-3 py-3 text-center">
                                    <button class="btn-edit-production bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600" data-id="${escapeHtml(prod.id)}">Ø¹Ø±Ø¶</button>
                                </td>
                            `;
                            completedBody.appendChild(tr);
                        });

                        document.getElementById('no-active-productions').style.display = activeProds.length ? 'none' : 'block';
                        document.getElementById('no-completed-productions').style.display = completedProds.length ? 'none' : 'block';

                        // ===== Attach event listeners to edit buttons (Event Delegation) =====
                        attachProductionButtonListeners();
            } catch(err) {
                console.warn('renderProductionsList error:', err);
            }
        };

        // ===== LOAD PRODUCTIONS FROM FIREBASE =====
        window.loadProductionsFromFirebase = async function() {
            if (!window.db || !window.auth?.currentUser) {
                console.warn('Firebase not ready, using local productions only');
                return;
            }

            try {
                const uid = window.auth.currentUser.uid;
                // Preferred source: user's appState.productions (allowed by rules)
                try {
                    const udoc = await db.collection('users').doc(uid).get();
                    if (udoc.exists) {
                        const appState = udoc.data() && udoc.data().appState ? udoc.data().appState : null;
                        if (appState && Array.isArray(appState.productions) && appState.productions.length > 0) {
                            window.state.productions = appState.productions;
                            console.log('âœ… Loaded', appState.productions.length, 'productions from users/' + uid + '.appState');
                            saveState();
                            return;
                        }
                    }
                } catch(err) {
                    console.warn('Failed to read users/{uid}.appState for productions:', err);
                }
            } catch(e){ console.warn('loadProductionsFromFirebase failed early', e); }

            // Fallback: try global productions collection
            try {
                const globalProdsSnap = await db.collection('productions').get();
                if (globalProdsSnap.size > 0) {
                    const productions = [];
                    globalProdsSnap.forEach(doc => {
                        productions.push(doc.data());
                    });
                    if (!Array.isArray(window.state.productions)) window.state.productions = [];
                    window.state.productions = productions;
                    console.log('âœ… Loaded', productions.length, 'productions from Firebase (global collection)');
                    saveState();
                    return;
                }
            } catch(err) {
                console.error('Failed to load productions from Firebase (global):', err);
            }
        };

        // Render on page load
        try { window.renderProductionsList(); } catch(e) { console.warn('Initial renderProductionsList failed:', e); }
        
        // Try to load from Firebase in background â€” defer until auth is ready
        (function(){
            try {
                if (window.db && window.auth && window.auth.currentUser) {
                    window.loadProductionsFromFirebase();
                    return;
                }
                if (window.auth && typeof window.auth.onAuthStateChanged === 'function') {
                    const unsub = window.auth.onAuthStateChanged(function(u){
                        if (u) {
                            try { window.loadProductionsFromFirebase(); } catch(e){ console.warn('Firebase load failed on auth event:', e); }
                            try { if (typeof unsub === 'function') unsub(); } catch(_){ }
                        }
                    });
                    return;
                }
                // Last resort: try again after short delay
                setTimeout(()=>{ try { window.loadProductionsFromFirebase(); } catch(e){ console.warn('Firebase load failed (delayed):', e); } }, 1500);
            } catch(e){ console.warn('Firebase load scheduling failed:', e); }
        })();

        // ===== PRODUCTION RUN CREATION FUNCTION (GLOBAL) =====
        window.createProductionRun = function(recipeId, startDate, expectedQty, notes) {
            try {
                if (!recipeId) {
                    console.error('No recipeId provided');
                    return false;
                }

                // Find recipe
                const recipe = (window.simpleRecipes || []).find(r => r.id === recipeId);
                if (!recipe) {
                    console.error('Recipe not found:', recipeId);
                    return false;
                }

                // Generate auto ID: PROD-YYYYMMDD-###
                const today = new Date();
                const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                const existingToday = (window.state.productions || []).filter(p => p.id && p.id.includes(dateStr));
                const runNumber = String(existingToday.length + 1).padStart(3, '0');
                const productionId = `PROD-${dateStr}-${runNumber}`;

                // Calculate total cost from recipe
                let totalCost = 0;
                (recipe.ingredients || []).forEach(ing => {
                    totalCost += parseFloat(ing.cost || 0);
                });
                (recipe.packaging || []).forEach(pkg => {
                    totalCost += parseFloat(pkg.cost || 0);
                });
                (recipe.operations || []).forEach(op => {
                    totalCost += parseFloat(op.cost || 0);
                });

                // Create production object
                const production = {
                    id: productionId,
                    recipeId: recipeId,
                    recipeName: recipe.name,
                    productName: recipe.name,
                    startDate: startDate,
                    createdAt: new Date().toISOString(),
                    expectedQty: parseFloat(expectedQty) || null,
                    actualQty: null,
                    status: 'in-progress',
                    totalCost: totalCost,
                    sellPrice: 0,
                    totalRevenue: 0,
                    profit: 0,
                    notes: notes,
                    completedDate: null
                };

                // Add to state and save locally FIRST
                if (!Array.isArray(window.state.productions)) window.state.productions = [];
                window.state.productions.push(production);
                
                try {
                    saveState(); // Save to localStorage synchronously
                } catch(err) {
                    console.error('Failed to save state locally:', err);
                }

                console.log('âœ… Production created locally:', productionId);

                // Try to sync to Firebase using helper function
                window.saveProductionToFirebase(production);
                
                return true;
            } catch(err) {
                console.error('Error in createProductionRun:', err);
                return false;
            }
        };

        // ===== HELPER FUNCTION TO SAVE PRODUCTION TO FIREBASE DIRECTLY =====
        window.saveProductionToFirebase = async function(production) {
            if (!production || !production.id) {
                console.warn('Invalid production object');
                return;
            }

            if (!window.db || !window.auth || !auth.currentUser) {
                console.warn('Firebase not initialized or no auth, production will only be saved locally');
                return;
            }

            try {
                const uid = auth.currentUser.uid;
                const userRef = db.collection('users').doc(uid);

                // Read existing appState (if any)
                let existing = null;
                try {
                    const snap = await userRef.get();
                    if (snap.exists) existing = snap.data() && snap.data().appState ? snap.data().appState : null;
                } catch(_){ /* ignore read errors */ }

                const prods = Array.isArray(existing?.productions) ? existing.productions.slice() : (Array.isArray(window.state.productions) ? window.state.productions.slice() : []);
                // Ensure no duplicate
                const idx = prods.findIndex(p => p && p.id === production.id);
                if (idx === -1) prods.push(production); else prods[idx] = production;

                // Write back to users/{uid}.appState.productions
                try {
                    await userRef.set({ appState: { productions: prods }, lastUpdatedBy: uid, updatedAt: serverTs() }, { merge: true });
                    console.log('âœ… Production saved to Firebase (users/' + uid + '.appState.productions):', production.id);
                    return;
                } catch(e){
                    console.warn('Failed to save production into users/{uid}.appState, will try global collection:', e);
                }

                // Last resort: try saving to global productions collection
                try {
                    await db.collection('productions').doc(production.id).set(production);
                    console.log('âœ… Production saved to Firebase (global collection):', production.id);
                    return;
                } catch(e2){
                    console.error('Failed to save production to Firebase (global):', e2);
                }
            } catch(err) {
                console.error('Error in saveProductionToFirebase:', err);
            }
        };

        // ===== EDIT PRODUCTION MODAL FUNCTION (GLOBAL) =====
        window.openEditProductionModal = function(productionId) {
            const production = (window.state.productions || []).find(p => p.id === productionId);
            if (!production) {
                alert('Ø§Ù„ØªØ´ØºÙŠÙ„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                return;
            }

            // Populate form fields
            document.getElementById('edit-production-id').value = productionId;
            document.getElementById('edit-production-final-qty').value = production.actualQty || production.finalQty || '';
            document.getElementById('edit-production-status').value = production.status || 'in-progress';
            document.getElementById('edit-production-sell-price').value = production.sellPrice || '';
            document.getElementById('edit-production-notes').value = production.notes || '';

            // Update summary
            const totalCost = production.totalCost || 0;
            const finalQty = parseFloat(production.actualQty || production.finalQty || 1);
            const sellPrice = parseFloat(production.sellPrice || 0);
            const totalRevenue = finalQty * sellPrice;
            const profit = totalRevenue - totalCost;

            document.getElementById('summary-total-cost').textContent = totalCost.toFixed(2);
            document.getElementById('summary-total-revenue').textContent = totalRevenue.toFixed(2);
            document.getElementById('summary-profit-loss').textContent = profit.toFixed(2);
            document.getElementById('summary-profit-loss').style.color = profit >= 0 ? 'green' : 'red';

            // Show modal
            const modal = document.getElementById('modal-edit-production');
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        };

        // ===== HANDLE CREATE PRODUCTION FORM SUBMIT =====
        const createProductionForm = document.getElementById('form-create-production');
        if (createProductionForm) {
            createProductionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const recipeId = document.getElementById('production-recipe-select').value;
                    const startDate = document.getElementById('production-start-date').value;
                    const expectedQty = document.getElementById('production-expected-qty').value || null;
                    const notes = document.getElementById('production-notes').value || '';
                    
                    if (!recipeId) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆØµÙØ©');
                        return;
                    }
                    
                    if (!startDate) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡');
                        return;
                    }
                    
                    // Call the production creation function
                    const success = window.createProductionRun(recipeId, startDate, expectedQty, notes);
                    
                    if (success) {
                        alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­');
                        
                        // Close modal and refresh list
                        document.getElementById('modal-create-production').classList.remove('modal-visible');
                        document.getElementById('modal-create-production').classList.add('modal-hidden');
                        
                        // Reset form
                        createProductionForm.reset();
                        
                        // Refresh productions list
                        window.renderProductionsList();
                    } else {
                        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø©');
                    }
                } catch(err) {
                    console.error('Error in form submit:', err);
                    alert('âŒ Ø®Ø·Ø£: ' + (err.message || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø©'));
                }
            });
        }

        // ===== HANDLE PRODUCTION UPDATE BUTTON CLICK (NOT FORM SUBMIT) =====
        // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        function attachProductionSaveListener() {
            const saveBtn = document.getElementById('btn-save-production-update');
            if (!saveBtn) {
                console.warn('âš ï¸ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');
                // Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                setTimeout(attachProductionSaveListener, 500);
                return;
            }

            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­ÙØ¸ØŒ Ø¬Ø§Ø±ÙŠ Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬');

            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('ğŸ”µ Save button clicked');
                
                const productionId = document.getElementById('edit-production-id').value;
                const finalQty = parseFloat(document.getElementById('edit-production-final-qty').value) || 0;
                const status = document.getElementById('edit-production-status').value;
                const sellPrice = parseFloat(document.getElementById('edit-production-sell-price').value) || 0;
                const notes = document.getElementById('edit-production-notes').value;

                console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:', { productionId, finalQty, status, sellPrice, notes });

                if (!productionId) {
                    console.error('âŒ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ØªØ´ØºÙŠÙ„Ø© ÙØ§Ø±Øº');
                    alert('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ØªØ´ØºÙŠÙ„Ø© ÙØ§Ø±Øº');
                    return;
                }

                const production = (window.state.productions || []).find(p => p.id === productionId);
                if (!production) {
                    console.error('âŒ Ø§Ù„ØªØ´ØºÙŠÙ„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©:', productionId);
                    alert('Ø§Ù„ØªØ´ØºÙŠÙ„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }

                console.log('ğŸ”§ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„Ø©...');

                // Update production object
                production.actualQty = finalQty;
                production.finalQty = finalQty;
                production.status = status;
                production.sellPrice = sellPrice;
                production.notes = notes;
                production.totalRevenue = finalQty * sellPrice;
                production.profit = production.totalRevenue - production.totalCost;

                if (status === 'completed' && !production.completedDate) {
                    production.completedDate = new Date().toISOString().split('T')[0];
                }

                console.log('âœï¸ ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ´ØºÙŠÙ„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«:', production);

                // Save to state synchronously FIRST
                try {
                    saveState();
                    console.log('ğŸ’¾ âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ localStorage');
                } catch(err) {
                    console.error('ğŸ’¾ âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ:', err);
                }

                // Save to Firebase using helper function
                if (window.saveProductionToFirebase) {
                    try {
                        window.saveProductionToFirebase(production);
                        console.log('ğŸ”¥ âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Firebase');
                    } catch(err) {
                        console.error('ğŸ”¥ âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Firebase:', err);
                    }
                } else {
                    console.warn('âš ï¸ Ø¯Ø§Ù„Ø© saveProductionToFirebase ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                }

                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                
                // Close modal
                console.log('ğŸšª Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„...');
                const modal = document.getElementById('modal-edit-production');
                if (modal) {
                    modal.classList.remove('modal-visible');
                    modal.classList.add('modal-hidden');
                }
                
                // Refresh list
                if (window.renderProductionsList) {
                    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬...');
                    window.renderProductionsList();
                } else {
                    console.warn('âš ï¸ Ø¯Ø§Ù„Ø© renderProductionsList ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                }

                console.log('âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
            });
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachProductionSaveListener);
        } else {
            // Ø§Ù„Ù€ DOM Ù…Ø­Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
            attachProductionSaveListener();
        }
        
        </script>
    <!-- Add Finished Product Modal -->
    <div id="modal-add-finished-product" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠ</h3>
            <form id="form-add-finished-product" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" id="finished-product-code" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: P-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" id="finished-product-name" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø¨Ù† Ø²Ø¨Ø§Ø¯ÙŠ" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <input type="text" id="finished-product-unit" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø·Ø¹Ø©" value="Ù‚Ø·Ø¹Ø©">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ù„Ø³Ø¹Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="number" id="finished-product-price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ø­ÙØ¸</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-finished-product').classList.add('hidden')">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Raw Material Modal (force-replaced to include invoice/tax fields) -->
    <div id="modal-add-raw-material" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù…Ø©</h3>
            <form id="form-add-raw-material" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium mb-1">ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Ù…Ø©</label>
                    <input type="text" id="raw-material-code" name="raw_material_code" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: R-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©</label>
                    <input type="text" id="raw-material-name" name="raw_material_name" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø¨Ù†" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <input type="text" id="raw-material-unit" name="raw_material_unit" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ¬Ù…" value="ÙƒØ¬Ù…">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ)</label>
                    <input type="number" id="raw-material-unit_price" name="raw_material_unit_price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <input type="number" id="raw-material-qty" name="raw_material_qty" class="w-full p-2 border rounded-md" placeholder="1" step="any" value="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</label>
                    <input type="text" id="raw-material-total_cost" name="raw_material_total_cost" class="w-full p-2 border rounded-md bg-gray-50" readonly value="0">
                </div>
                <div>
                    <label class="inline-flex items-center gap-2">
                        <input type="checkbox" id="raw-material-is_tax_invoice" name="raw_material_is_tax_invoice" class="h-4 w-4">
                        <span class="text-sm">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©ØŸ (Tax Invoice?)</span>
                    </label>
                </div>
                <div class="pt-2 border-t">
                    <h4 class="text-sm font-medium">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ§Ù„ÙØ§ØªÙˆØ±Ø©</h4>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ (Vendor Tax ID)</label>
                        <input type="text" id="raw-material-vendor_tax_id" name="raw_material_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: 123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                        <input type="text" id="raw-material-invoice_number" name="raw_material_invoice_number" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: INV-001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                        <input type="date" id="raw-material-invoice_date" name="raw_material_invoice_date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (VAT/Tax Value)</label>
                        <input type="number" id="raw-material-vat_value" name="raw_material_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Invoice Image)</label>
                        <input type="file" id="raw-material-invoice_image" name="raw_material_invoice_image" accept="image/*,application/pdf" class="w-full">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ø­ÙØ¸</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-raw-material').classList.add('hidden')">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Packaging Modal (force-replaced to include invoice/tax fields) -->
    <div id="modal-add-packaging" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ØªØ¹Ø¨Ø¦Ø©</h3>
            <form id="form-add-packaging" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium mb-1">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                    <input type="text" id="packaging-code" name="packaging_code" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: PKG-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                    <input type="text" id="packaging-name" name="packaging_name" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„Ø¨Ø© Ø¨Ù„Ø§Ø³ØªÙŠÙƒÙŠØ©" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <input type="text" id="packaging-unit" name="packaging_unit" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø·Ø¹Ø©" value="Ù‚Ø·Ø¹Ø©">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="number" id="packaging-cost" name="packaging_cost" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div class="pt-2 border-t">
                    <h4 class="text-sm font-medium">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ§Ù„ÙØ§ØªÙˆØ±Ø©</h4>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ (Vendor Tax ID)</label>
                        <input type="text" id="packaging-vendor_tax_id" name="packaging_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: 123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                        <input type="text" id="packaging-invoice_number" name="packaging_invoice_number" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: INV-001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                        <input type="date" id="packaging-invoice_date" name="packaging_invoice_date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (VAT/Tax Value)</label>
                        <input type="number" id="packaging-vat_value" name="packaging_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Invoice Image)</label>
                        <input type="file" id="packaging-invoice_image" name="packaging_invoice_image" accept="image/*,application/pdf" class="w-full">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ø­ÙØ¸</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-packaging').classList.add('hidden')">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Wire raw material modal total calculation
        (function(){
            function updateRawMaterialTotal(){
                try{
                    const unitEl = document.getElementById('raw-material-unit_price');
                    const qtyEl = document.getElementById('raw-material-qty');
                    const totalEl = document.getElementById('raw-material-total_cost');
                    const unit = parseFloat(unitEl?.value) || 0;
                    const qty = parseFloat(qtyEl?.value) || 0;
                    const total = Math.round((unit * qty) * 100) / 100;
                    if (totalEl) totalEl.value = total.toFixed(2);
                    return total;
                }catch(e){ console.warn('updateRawMaterialTotal failed', e); return 0; }
            }
            document.addEventListener('DOMContentLoaded', function(){
                try{
                    const unitEl = document.getElementById('raw-material-unit_price');
                    const qtyEl = document.getElementById('raw-material-qty');
                    if (unitEl) unitEl.addEventListener('input', updateRawMaterialTotal);
                    if (qtyEl) qtyEl.addEventListener('input', updateRawMaterialTotal);
                    // initial compute
                    updateRawMaterialTotal();
                }catch(e){}
            });
            window.updateRawMaterialTotal = updateRawMaterialTotal;
        })();
    </script>

    <!-- Modal: Create New Production Run -->
    <div id="modal-create-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
            <h3 class="text-lg font-bold mb-4">Ø¥Ù†Ø´Ø§Ø¡ ØªØ´ØºÙŠÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <form id="form-create-production" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙØ©</label>
                    <select id="production-recipe-select" class="w-full p-2 border rounded-md" required>
                        <option value="">-- Ø§Ø®ØªØ± ÙˆØµÙØ© --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„ÙˆØµÙØ©</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                        <input type="date" id="production-start-date" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="number" id="production-expected-qty" class="w-full p-2 border rounded-md" placeholder="Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹" step="0.01">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="production-notes" class="w-full p-2 border rounded-md" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø¥Ù†ØªØ§Ø¬..."></textarea>
                </div>

                <div class="bg-blue-50 border border-blue-200 p-3 rounded-md text-sm text-blue-800">
                    <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (24 Ø³Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹).
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø©</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-create-production').classList.remove('modal-visible'); document.getElementById('modal-create-production').classList.add('modal-hidden');">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Production Run -->
    <div id="modal-edit-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
            <h3 class="text-lg font-bold mb-4">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ´ØºÙŠÙ„Ø©</h3>
            <form id="form-edit-production" class="space-y-4">
                <input type="hidden" id="edit-production-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</label>
                        <input type="number" id="edit-production-final-qty" class="w-full p-2 border rounded-md" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„Ø©</label>
                        <select id="edit-production-status" class="w-full p-2 border rounded-md" required>
                            <option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†ØªØ§Ø¬</option>
                            <option value="completed">Ù…Ù†ØªÙ‡ÙŠØ©</option>
                            <option value="cancelled">Ù…Ù„ØºØ§Ø©</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="number" id="edit-production-sell-price" class="w-full p-2 border rounded-md" step="0.01" placeholder="0">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="edit-production-notes" class="w-full p-2 border rounded-md" rows="3"></textarea>
                </div>

                <div id="production-summary" class="bg-gray-50 border border-gray-200 p-3 rounded-md text-sm">
                    <p><strong>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</strong> <span id="summary-total-cost">0</span></p>
                    <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹:</strong> <span id="summary-total-revenue">0</span></p>
                    <p><strong>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©:</strong> <span id="summary-profit-loss" class="font-bold">0</span></p>
                </div>

                <div class="flex gap-2">
                    <button type="button" id="btn-save-production-update" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-edit-production').classList.remove('modal-visible'); document.getElementById('modal-edit-production').classList.add('modal-hidden');">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>

    <script>
        // Prevent the production edit modal from causing a full restart â€” attach safe save handler
        (function(){
            // Ensure the DOM is ready or the element exists (script placed at end of body)
            const saveProductionBtn = document.getElementById('btn-save-production-update');
            if (saveProductionBtn) {
                saveProductionBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const productionIdEl = document.getElementById('edit-production-id');
                    const finalQtyEl = document.getElementById('edit-production-final-qty');
                    const statusEl = document.getElementById('edit-production-status');
                    const sellPriceEl = document.getElementById('edit-production-sell-price');
                    const notesEl = document.getElementById('edit-production-notes');

                    const productionId = productionIdEl ? productionIdEl.value : '';
                    const finalQty = parseFloat(finalQtyEl ? finalQtyEl.value : 0) || 0;
                    const status = statusEl ? statusEl.value : '';
                    const sellPrice = parseFloat(sellPriceEl ? sellPriceEl.value : 0) || 0;
                    const notes = notesEl ? notesEl.value : '';

                    const production = (window.state && Array.isArray(window.state.productions) ? window.state.productions : []).find(p => p.id === productionId);
                    if (!production) {
                        alert('Ø§Ù„ØªØ´ØºÙŠÙ„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                        return;
                    }

                    production.actualQty = finalQty;
                    production.finalQty = finalQty;
                    production.status = status;
                    production.sellPrice = sellPrice;
                    production.notes = notes;
                    production.totalRevenue = finalQty * sellPrice;
                    production.profit = (production.totalRevenue || 0) - (production.totalCost || 0);

                    if (status === 'completed' && !production.completedDate) {
                        production.completedDate = new Date().toISOString().split('T')[0];
                    }

                    try { if (typeof saveState === 'function') saveState(); } catch(err) { console.error(err); }

                    try {
                        if (typeof window.saveProductionToFirebase === 'function') {
                            window.saveProductionToFirebase(production);
                        }
                    } catch(err) { console.warn(err); }

                    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª');
                    
                    // Close modal safely
                    try {
                        const modal = document.getElementById('modal-edit-production');
                        if (modal) {
                            modal.classList.remove('modal-visible');
                            modal.classList.add('modal-hidden');
                        }
                    } catch(_){}
                    
                    if (typeof window.renderProductionsList === 'function') window.renderProductionsList();
                });
            }
        })();
    </script>
    <script src="./taxes.js"></script>
    <script>
        async function fixChocolateVatOneTime(silent=false){
            const chocoRe = /chocolate|Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©|Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ©/i;
            if (!window.db) { alert('Firestore ØºÙŠØ± Ø¬Ø§Ù‡Ø². ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªÙ‡ÙŠØ¦Ø© Firebase.'); return; }
            try{
                const snap = await db.collection('products').get();
                let updated = 0;
                let batch = db.batch();
                let pending = 0;
                const BATCH_LIMIT = 400;
                for (const doc of snap.docs){
                    try{
                        const data = doc.data() || {};
                        const name = (data.name||'').toString();
                        if (chocoRe.test(name)){
                            // only update if different to avoid unnecessary writes
                            if (!data.vat_rate || Number(data.vat_rate) !== 14){
                                batch.set(doc.ref, { vat_rate: 14, updatedAt: serverTs() }, { merge: true });
                                pending++; updated++;
                                if (pending >= BATCH_LIMIT){ await batch.commit(); batch = db.batch(); pending = 0; }
                            }
                        }
                    }catch(e){ console.warn('fixChocolateVatOneTime: doc skipped', doc.id, e); }
                }
                if (pending > 0) await batch.commit();
                if (!silent) alert('Done! Updated ' + updated + ' products'); else console.log('Chocolate VAT auto-fix updated', updated, 'products');
                try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
            }catch(e){ console.error('fixChocolateVatOneTime failed', e); if (!silent) alert('Error: ' + (e && e.message || e)); }
        }

        // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©: Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
        function autoFixChocolateVatOnce(){
            try {
                const KEY = 'fix_choco_vat_14_done';
                if (localStorage.getItem(KEY) === '1') return;
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (!(role === 'admin' || role === 'manager')) return;
                if (!window.db || !window.auth || !auth.currentUser) return;
                fixChocolateVatOneTime(true).then(()=>{ try { localStorage.setItem(KEY, '1'); } catch(_){} });
            } catch(e){ console.warn('autoFixChocolateVatOnce failed', e); }
        }
    </script>
    <script>
        // Simple Bluetooth test function - tries multiple UUIDs
        async function performSimpleBluetoothTest() {
            console.log('ğŸ”µ BT Test Started');
            const processingMsg = document.createElement('div');
            processingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:10px;z-index:50001;box-shadow:0 4px 6px rgba(0,0,0,0.2);text-align:center;min-width:300px;';
            processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ±...</div><div style="font-size:14px;color:#666;">Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ·</div>`;
            document.body.appendChild(processingMsg);
            
            const uuidCombos = [
                { service: '000018f0-0000-1000-8000-00805f9b34fb', char: '00002af1-0000-1000-8000-00805f9b34fb', name: 'BLE' },
                { service: '0000ff00-0000-1000-8000-00805f9b34fb', char: '0000ff01-0000-1000-8000-00805f9b34fb', name: 'FF00' },
                { service: '49535343-fe7d-4ae5-8fa9-9fafd205e455', char: '49535343-8841-43f4-a8d4-ecbe34729bb3', name: 'HM-10' }
            ];
            
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø£Ùˆ Edge.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>`;
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: uuidCombos.map(u => u.service)
                });
                
                console.log('âœ“ Device selected:', device.name);
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:blue;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${device.name || 'Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ±'}...</div>`;
                const server = await device.gatt.connect();
                console.log('âœ“ Connected to GATT');
                
                let characteristic = null;
                let usedCombo = null;
                
                for (const combo of uuidCombos) {
                    try {
                        processingMsg.innerHTML = `<div style="font-size:14px;color:#666;">Ø¬Ø±Ø¨ ${combo.name}...</div>`;
                        const service = await server.getPrimaryService(combo.service);
                        characteristic = await service.getCharacteristic(combo.char);
                        usedCombo = combo;
                        console.log('âœ“ Connected using:', combo.name);
                        break;
                    } catch (e) {
                        console.log('âœ— Failed:', combo.name, e.message);
                        continue;
                    }
                }
                
                if (!characteristic) {
                    throw new Error('Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ±. Ø¬Ø±Ø¨ Ø¨Ø±ÙŠÙ†ØªØ± Ø¢Ø®Ø±.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">âœ“ Ù…ØªØµÙ„ (${usedCombo.name})!<br>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</div>`;
                
                const escpos = [
                    0x1B, 0x40, // Initialize
                    0x1B, 0x61, 0x01, // Center
                    0x48, 0x65, 0x6C, 0x6C, 0x6F, // Hello
                    0x0A, 0x0A,
                    0x54, 0x65, 0x73, 0x74, // Test
                    0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A,
                    0x1D, 0x56, 0x00 // Full cut
                ];
                
                const data = new Uint8Array(escpos);
                
                for (let i = 0; i < data.length; i += 20) {
                    const chunk = data.slice(i, i + 20);
                    await characteristic.writeValue(chunk);
                    await new Promise(r => setTimeout(r, 100));
                }
                
                console.log('âœ“ Data sent successfully');
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">âœ“ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!<br><small>UUID: ${usedCombo.name}</small></div><div style="font-size:14px;color:#666;margin-top:10px;">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ± - ÙŠØ¬Ø¨ Ø·Ø¨Ø§Ø¹Ø© "Hello Test"</div>`;
                setTimeout(() => {
                    try { document.body.removeChild(processingMsg); } catch(_){}
                    try { device.gatt.disconnect(); } catch(_){}
                }, 5000);
                
            } catch (err) {
                console.error('ğŸ”´ BT Test Error:', err);
                processingMsg.innerHTML = `<div style="font-size:16px;font-weight:bold;color:red;">Ø®Ø·Ø£:</div><div style="font-size:12px;color:#666;margin:10px 0;">${err.message}</div><button onclick="this.parentElement.remove()" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>`;
            }
        }

        // Print invoice via Bluetooth using ESC/POS commands - ASCII ONLY, like test button
        async function printInvoiceViaBluetooth(saleArg) {
            console.log('ğŸ”µ BT Invoice Print Started');
            const processingMsg = document.createElement('div');
            processingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:10px;z-index:50001;box-shadow:0 4px 6px rgba(0,0,0,0.2);text-align:center;min-width:300px;';
            processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ±...</div>`;
            document.body.appendChild(processingMsg);
            
            const uuidCombos = [
                { service: '000018f0-0000-1000-8000-00805f9b34fb', char: '00002af1-0000-1000-8000-00805f9b34fb', name: 'BLE' },
                { service: '0000ff00-0000-1000-8000-00805f9b34fb', char: '0000ff01-0000-1000-8000-00805f9b34fb', name: 'FF00' },
                { service: '49535343-fe7d-4ae5-8fa9-9fafd205e455', char: '49535343-8841-43f4-a8d4-ecbe34729bb3', name: 'HM-10' }
            ];
            
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø£Ùˆ Edge.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>`;
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: uuidCombos.map(u => u.service)
                });
                
                console.log('âœ“ Device selected:', device.name);
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:blue;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${device.name || 'Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ±'}...</div>`;
                const server = await device.gatt.connect();
                console.log('âœ“ Connected to GATT');
                
                let characteristic = null;
                let usedCombo = null;
                
                for (const combo of uuidCombos) {
                    try {
                        processingMsg.innerHTML = `<div style="font-size:14px;color:#666;">Ø¬Ø±Ø¨ ${combo.name}...</div>`;
                        const service = await server.getPrimaryService(combo.service);
                        characteristic = await service.getCharacteristic(combo.char);
                        usedCombo = combo;
                        console.log('âœ“ Connected using:', combo.name);
                        break;
                    } catch (e) {
                        console.log('âœ— Failed:', combo.name, e.message);
                        continue;
                    }
                }
                
                if (!characteristic) {
                    throw new Error('Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠÙ†ØªØ±. Ø¬Ø±Ø¨ Ø¨Ø±ÙŠÙ†ØªØ± Ø¢Ø®Ø±.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">âœ“ Ù…ØªØµÙ„ (${usedCombo.name})!<br>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...</div>`;
                
                // Helper: Convert ASCII string to byte array (OLD-SCHOOL, like test button)
                function stringToAsciiBytes(str) {
                    const bytes = [];
                    for (let i = 0; i < str.length; i++) {
                        const code = str.charCodeAt(i);
                        if (code <= 127) {
                            bytes.push(code);
                        } else {
                            bytes.push(63); // ? for non-ASCII
                        }
                    }
                    return bytes;
                }
                
                // Build invoice data - ASCII ONLY
                const customer = findCustomer(saleArg.customerId);
                const customerName = (customer && customer.name) ? customer.name.substring(0, 15) : 'Customer';
                const invoiceNum = (saleArg.invoiceNumber || '0').toString();
                const dateObj = new Date(saleArg.createdAt);
                const engDate = ('0' + dateObj.getDate()).slice(-2) + '/' + ('0' + (dateObj.getMonth() + 1)).slice(-2) + '/' + dateObj.getFullYear();
                
                // Start building ESC/POS command array
                let escpos = [
                    0x1B, 0x40, // Initialize printer
                    0x1B, 0x61, 0x01 // Center alignment
                ];
                
                // Add store name
                escpos = escpos.concat(stringToAsciiBytes('DELENTE STORE'));
                escpos.push(0x0A, 0x0A);
                
                // Add separator
                escpos = escpos.concat(stringToAsciiBytes('===================='));
                escpos.push(0x0A);
                
                // Left align for invoice details
                escpos.push(0x1B, 0x61, 0x00);
                
                // Invoice number
                escpos = escpos.concat(stringToAsciiBytes('Invoice #' + invoiceNum));
                escpos.push(0x0A);
                
                // Customer name
                escpos = escpos.concat(stringToAsciiBytes('Customer: ' + customerName));
                escpos.push(0x0A);
                
                // Date
                escpos = escpos.concat(stringToAsciiBytes('Date: ' + engDate));
                escpos.push(0x0A);
                
                // Separator
                escpos = escpos.concat(stringToAsciiBytes('--------------------'));
                escpos.push(0x0A);
                
                // Items header
                escpos = escpos.concat(stringToAsciiBytes('ITEMS'));
                escpos.push(0x0A);
                
                // Add each item
                if (saleArg.items && Array.isArray(saleArg.items)) {
                    saleArg.items.forEach((item, idx) => {
                        const product = findProduct(item.productId);
                        const pName = (product && product.name) ? product.name.substring(0, 15) : 'Item';
                        const qty = item.quantity || 0;
                        const price = item.unitPrice || 0;
                        const total = qty * price;
                        
                        escpos = escpos.concat(stringToAsciiBytes((idx + 1) + '. ' + pName));
                        escpos.push(0x0A);
                        escpos = escpos.concat(stringToAsciiBytes('   ' + qty + 'x ' + price.toFixed(2) + '=' + total.toFixed(2)));
                        escpos.push(0x0A);
                    });
                }
                
                // Separator
                escpos = escpos.concat(stringToAsciiBytes('--------------------'));
                escpos.push(0x0A);
                
                // Total
                const totalAmount = saleArg.totalAmount || 0;
                escpos = escpos.concat(stringToAsciiBytes('TOTAL: ' + totalAmount.toFixed(2) + ' EGP'));
                escpos.push(0x0A, 0x0A);
                
                // Footer
                escpos = escpos.concat(stringToAsciiBytes('Thank you!'));
                escpos.push(0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A);
                
                // Full cut
                escpos.push(0x1D, 0x56, 0x00);
                
                const data = new Uint8Array(escpos);
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...</div>`;
                
                // Send data in chunks (100ms delay like test button)
                for (let i = 0; i < data.length; i += 20) {
                    const chunk = data.slice(i, i + 20);
                    await characteristic.writeValue(chunk);
                    await new Promise(r => setTimeout(r, 100));
                }
                
                console.log('âœ“ Invoice sent successfully');
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">âœ“ ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!</div>`;
                setTimeout(() => {
                    try { document.body.removeChild(processingMsg); } catch(_){}
                    try { device.gatt.disconnect(); } catch(_){}
                }, 3000);
                
            } catch (err) {
                console.error('ğŸ”´ BT Print Error:', err);
                processingMsg.innerHTML = `<div style="font-size:16px;font-weight:bold;color:red;">Ø®Ø·Ø£:</div><div style="font-size:12px;color:#666;margin:10px 0;">${err.message}</div><button onclick="this.parentElement.remove()" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>`;
            }
        }
        
        // Attach to yellow test button
        document.addEventListener('DOMContentLoaded', function() {
            const testBtn = document.getElementById('sales-bt-test-btn');
            if (testBtn) {
                console.log('âœ… Bluetooth test button found, attaching handler');
                testBtn.addEventListener('click', function() {
                    console.log('ğŸŸ¡ Yellow test button clicked');
                    performSimpleBluetoothTest().catch(e => {
                        console.error('Test failed:', e);
                        alert('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + e.message);
                    });
                });
            } else {
                console.warn('âš ï¸ sales-bt-test-btn not found in DOM');
            }
        });

        // ==================== INVENTORY SYSTEM (Cloud-First) ====================
        window.inventorySystem = {
            currentTab: 'raw',
            currentItem: null,
            
            // ğŸ”§ CRITICAL: Sync all local data to window globals BEFORE loading
            // This ensures any recent edits in localStorage are in memory
            _syncFromLocalStorage() {
                try {
                    const rawLS = localStorage.getItem('cost_raw');
                    const packLS = localStorage.getItem('cost_pack');
                    const finLS = localStorage.getItem('cost_finished');
                    
                    if (rawLS) window.costRaw = JSON.parse(rawLS);
                    if (packLS) window.costPack = JSON.parse(packLS);
                    if (finLS) window.costFinished = JSON.parse(finLS);
                    
                    console.log('âœ… _syncFromLocalStorage: updated window arrays from localStorage', {
                        raw: (window.costRaw || []).length,
                        pack: (window.costPack || []).length,
                        finished: (window.costFinished || []).length
                    });
                } catch(e) {
                    console.warn('_syncFromLocalStorage failed:', e);
                }
            },
            
            // Load inventory data from Firestore
            async loadInventoryData(category) {
                try {
                    this.currentTab = category || 'raw';
                    
                    // ğŸ”§ CRITICAL: Sync from localStorage FIRST to get latest edits
                    this._syncFromLocalStorage();
                    
                    const tbody = document.getElementById(`table-${this.currentTab}`);
                    if (!tbody) {
                        console.warn(`âš ï¸ Table not found: table-${this.currentTab}`);
                        return;
                    }
                    
                    // ğŸ”§ CRITICAL: Always refresh from localStorage FIRST to get latest edits
                    // This ensures that if user edited stock and switched tabs, they see the latest version
                    try {
                        if (this.currentTab === 'raw') {
                            const lsRaw = localStorage.getItem('cost_raw');
                            if (lsRaw) window.costRaw = JSON.parse(lsRaw);
                        } else if (this.currentTab === 'packing') {
                            const lsPack = localStorage.getItem('cost_pack');
                            if (lsPack) window.costPack = JSON.parse(lsPack);
                        } else if (this.currentTab === 'finished') {
                            const lsFin = localStorage.getItem('cost_finished');
                            if (lsFin) window.costFinished = JSON.parse(lsFin);
                        }
                    } catch(e){ console.warn('Failed to refresh from localStorage:', e); }
                    
                    // First, try to load from local window arrays (faster, offline-capable)
                    let items = [];
                    
                    if (this.currentTab === 'raw') {
                        if (window.costRaw && Array.isArray(window.costRaw)) {
                            items = window.costRaw;
                            console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from window.costRaw`);
                        }
                        if (items.length === 0) {
                            try {
                                const ls = localStorage.getItem('cost_raw');
                                if (ls) {
                                    items = JSON.parse(ls) || [];
                                    window.costRaw = items;
                                    console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from localStorage.cost_raw`);
                                }
                            } catch(_){}
                        }
                    } else if (this.currentTab === 'packing') {
                        if (window.costPack && Array.isArray(window.costPack)) {
                            items = window.costPack;
                            console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from window.costPack`);
                        }
                        if (items.length === 0) {
                            try {
                                const ls = localStorage.getItem('cost_pack');
                                if (ls) {
                                    items = JSON.parse(ls) || [];
                                    window.costPack = items;
                                    console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from localStorage.cost_pack`);
                                }
                            } catch(_){}
                        }
                    } else if (this.currentTab === 'finished') {
                        if (window.costFinished && Array.isArray(window.costFinished)) {
                            items = window.costFinished;
                            window.finishedProducts = window.costFinished; // Keep in sync
                            console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from window.costFinished`);
                        }
                        // Fallback to legacy finishedProducts array
                        if (items.length === 0 && window.finishedProducts && Array.isArray(window.finishedProducts)) {
                            items = window.finishedProducts;
                            console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from window.finishedProducts`);
                        }
                        // Fallback to localStorage key
                        if (items.length === 0) {
                            try {
                                const ls = localStorage.getItem('cost_finished');
                                if (ls) {
                                    items = JSON.parse(ls) || [];
                                    window.costFinished = items;
                                    window.finishedProducts = items;
                                    console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from localStorage.cost_finished`);
                                }
                            } catch(_){}
                        }
                        // Fallback to finished grid state object (derived to array)
                        if (items.length === 0) {
                            try {
                                const gridObj = (window._finishedGridState && typeof window._finishedGridState === 'object')
                                    ? window._finishedGridState
                                    : (function(){ try { return JSON.parse(localStorage.getItem('finished_products_grid')||'{}'); } catch(_) { return {}; } })();
                                const keys = Object.keys(gridObj||{});
                                if (keys.length > 0) {
                                    items = keys.map(id => {
                                        const it = gridObj[id]||{};
                                        return {
                                            id,
                                            name: it.name || id,
                                            stock: (it.actual != null ? it.actual : (it.opening != null ? it.opening : 0)),
                                            unit: 'Ù‚Ø·Ø¹Ø©',
                                            cost: Number(it.cost||0)
                                        };
                                    });
                                    console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from finished_products_grid`);
                                }
                            } catch(e){ console.warn('derive finished from grid failed', e); }
                        }
                        // Fallback to DEFAULT_PRODUCTS (seed) if still empty
                        if (items.length === 0 && Array.isArray(window.DEFAULT_PRODUCTS) && window.DEFAULT_PRODUCTS.length > 0) {
                            try {
                                items = window.DEFAULT_PRODUCTS.map(p => ({ id: p.id || p.code || ('prod-'+Math.random().toString(36).slice(2,8)), name: p.name || p.title || 'Ù…Ù†ØªØ¬', unit: p.unit || 'Ù‚Ø·Ø¹Ø©', stock: 0, cost: Number(p.price||p.sellPrice||0) }));
                                window.costFinished = items;
                                window.finishedProducts = items;
                                try { localStorage.setItem('cost_finished', JSON.stringify(items)); } catch(_){}
                                console.log(`ğŸ“¦ Seeded ${items.length} finished items from DEFAULT_PRODUCTS`);
                            } catch(e){ console.warn('seed finished from DEFAULT_PRODUCTS failed', e); }
                        }
                    }
                    
                    // If local arrays are empty, try Firestore (last resort)
                    // Avoid slow retries when offline - DISABLED to prevent hang
                    if (false && items.length === 0 && window.db && navigator.onLine) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</td></tr>';
                        try {
                            const snapshot = await db.collection('inventory_items').where('category', '==', this.currentTab).get();
                            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                            console.log(`ğŸ“¦ Loaded ${items.length} items for category: ${this.currentTab} from Firestore`);
                        } catch(e) {
                            console.warn(`âš ï¸ Failed to load from Firestore: ${e.message}`);
                        }
                    }
                    
                    // Display items or empty message
                    if (items.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</div><div class="text-xs text-gray-400 mt-2">Ø§Ø¶ØºØ· "+" Ù„Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</div></td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = items.map(item => {
                        const itemName = item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        const itemStock = item.stock !== undefined ? item.stock : 0;
                        const itemPrice = item.price !== undefined ? item.price : (item.cost || item.avgCost || 0);
                        const itemUnit = item.unit || 'ÙˆØ­Ø¯Ø©';
                        const itemId = item.id || item.name || 'N/A';
                        
                        return `
                            <tr onclick="window.inventorySystem.openItemModal('${itemId}')" class="hover:bg-blue-50 cursor-pointer transition">
                                <td class="p-3 font-bold">${itemName}</td>
                                <td class="p-3"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">${itemStock}</span></td>
                                <td class="p-3 text-sm text-gray-500">${itemUnit}</td>
                                <td class="p-3 text-sm">${parseFloat(itemPrice || 0).toFixed(2)} Ø¬.Ù…</td>
                            </tr>
                        `;
                    }).join('');
                    
                    console.log(`âœ… Rendered ${items.length} items for category: ${this.currentTab}`);
                } catch (err) {
                    console.error('âŒ Load inventory failed:', err);
                    const tbody = document.getElementById(`table-${this.currentTab}`);
                    if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + err.message + '</td></tr>';
                }
            },
            
            // Open item detail modal
            async openItemModal(itemId) {
                try {
                    let item = null;
                    let docId = itemId;
                    
                    // STRATEGY 1: Try to find item in local window arrays first
                    // This handles items loaded from localStorage that may not be in Firestore yet
                    const currentArray = 
                        this.currentTab === 'raw' ? window.costRaw :
                        this.currentTab === 'packing' ? window.costPack :
                        window.costFinished;
                    
                    if (Array.isArray(currentArray)) {
                        // Try to find by ID first
                        item = currentArray.find(i => i && (i.id === itemId || i.id === docId));
                        
                        // If not found, try by name (user might have clicked a name-based row)
                        if (!item) {
                            item = currentArray.find(i => i && i.name === itemId);
                            if (item) docId = item.id || itemId;
                        }
                    }
                    
                    // STRATEGY 2: If not in local array, try Firestore
                    if (!item && window.db) {
                        const doc = await db.collection('inventory_items').doc(itemId).get();
                        if (doc.exists) {
                            item = doc.data();
                            docId = doc.id;
                        }
                    }
                    
                    // If still not found, show error
                    if (!item) {
                        console.warn(`âŒ Item not found: ${itemId}. Current array:`, currentArray);
                        alert('Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                        return;
                    }
                    
                    // Store current item for editing
                    this.currentItem = { id: docId, ...item };
                    
                    // Update modal display
                    document.getElementById('modal-title').textContent = item.name || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ†Ù';
                    document.getElementById('modal-stock').textContent = item.stock || 0;
                    document.getElementById('modal-cost').textContent = (item.avgCost || item.cost || 0).toFixed(2);
                    document.getElementById('itemCardModal').style.display = 'block';
                    
                    console.log(`âœ… Opened item modal: ${item.name} (from ${item.id ? 'Firebase' : 'Local'})`);
                } catch (err) {
                    console.error('âŒ Open modal failed:', err);
                    alert('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
                }
            },
            
            // Adjust stock (add/subtract)
            async adjustStock(action) {
                if (!this.currentItem) {
                    alert('âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØµÙ†Ù');
                    return;
                }
                const qty = prompt(action === 'add' ? 'ÙƒÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙØ¶Ø§ÙØ©ØŸ' : 'ÙƒÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ©ØŸ', '0');
                if (!qty || isNaN(qty) || Number(qty) <= 0) return;
                
                try {
                    const newStock = (this.currentItem.stock || 0) + (action === 'add' ? Number(qty) : -Number(qty));
                    if (newStock < 0) { alert('Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨'); return; }
                    
                    // Try to update in Firestore if DB is available (create-or-update)
                    if (window.db && this.currentItem.id && navigator.onLine) {
                        try {
                            await db.collection('inventory_items').doc(this.currentItem.id).set({ 
                                stock: newStock, 
                                updatedAt: serverTs(),
                                name: this.currentItem.name || '',
                                unit: this.currentItem.unit || 'Ù‚Ø·Ø¹Ø©',
                                category: this.currentTab || 'packing'
                            }, { merge: true });
                            console.log(`âœ… Stock saved to Firestore: ${this.currentItem.name} â†’ ${newStock}`);
                        } catch(dbErr) {
                            console.warn(`âš ï¸ Could not save to Firestore (offline or missing doc): ${dbErr.message}`);
                            try { if (typeof window.addPendingInventoryUpdate === 'function') window.addPendingInventoryUpdate({ id: this.currentItem.id, category: this.currentTab, stock: newStock, name: this.currentItem.name }); } catch(_){ }
                        }
                    } else {
                        try { if (typeof window.addPendingInventoryUpdate === 'function') window.addPendingInventoryUpdate({ id: this.currentItem.id, category: this.currentTab, stock: newStock, name: this.currentItem.name }); } catch(_){ }
                    }
                    
                    // Update in memory and local arrays
                    this.currentItem.stock = newStock;
                    
                    // Also update in the appropriate window array
                    const array = this.currentTab === 'raw' ? window.costRaw :
                                  this.currentTab === 'packing' ? window.costPack :
                                  window.costFinished;
                    
                    if (Array.isArray(array)) {
                        const idx = array.findIndex(i => i && (i.id === this.currentItem.id || i.name === this.currentItem.name));
                        if (idx >= 0) {
                            array[idx].stock = newStock;
                        }
                    }
                    
                    // Save to localStorage
                    if (this.currentTab === 'raw') localStorage.setItem('cost_raw', JSON.stringify(window.costRaw));
                    else if (this.currentTab === 'packing') localStorage.setItem('cost_pack', JSON.stringify(window.costPack));
                    else localStorage.setItem('cost_finished', JSON.stringify(window.costFinished));
                    
                    // Update modal display
                    document.getElementById('modal-stock').textContent = newStock;
                    this.loadInventoryData(this.currentTab); // Refresh table
                    
                    // Auto-save to cloud if available (with debounce)
                    if (this.currentTab === 'finished') {
                        try { if (typeof window.debouncedFinishedSave === 'function') window.debouncedFinishedSave(); } catch(_){ }
                    } else {
                        try { if (typeof window.saveLists === 'function') window.saveLists(); } catch(_){ }
                    }
                    
                    console.log(`âœ… Stock adjusted: ${this.currentItem.name} â†’ ${newStock}`);
                } catch (err) {
                    console.error('âŒ Adjust stock failed:', err);
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯');
                }
            },
            
            showAddItemModal() {
                // Show the add item modal for current category
                const currentCategory = this.currentTab || 'finished';
                
                // Reset form
                document.getElementById('addItemName').value = '';
                document.getElementById('addItemStock').value = '0';
                document.getElementById('addItemCost').value = '0';
                document.getElementById('addItemCategory').value = currentCategory;
                
                const unitMap = {
                    'raw': 'ÙƒØ¬Ù…',
                    'packing': 'Ù‚Ø·Ø¹Ø©',
                    'finished': 'Ù‚Ø·Ø¹Ø©'
                };
                document.getElementById('addItemUnit').value = unitMap[currentCategory] || 'Ù‚Ø·Ø¹Ø©';
                
                // Show modal
                const modal = document.getElementById('addItemModal');
                if (modal) {
                    modal.style.display = 'block';
                    console.log(`â• Add Item Modal opened for category: ${currentCategory}`);
                } else {
                    console.error('âŒ addItemModal not found in DOM');
                }
            },
            
            async saveNewItem() {
                try {
                    const name = document.getElementById('addItemName').value.trim();
                    const stock = parseFloat(document.getElementById('addItemStock').value) || 0;
                    const cost = parseFloat(document.getElementById('addItemCost').value) || 0;
                    const unit = document.getElementById('addItemUnit').value || 'Ù‚Ø·Ø¹Ø©';
                    const category = document.getElementById('addItemCategory').value || 'finished';
                    
                    if (!name) {
                        alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬');
                        return;
                    }
                    
                    if (!window.db) {
                        alert('âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©');
                        return;
                    }
                    
                    const newItem = {
                        name,
                        code: name, // Use name as code
                        stock,
                        cost,
                        avgCost: cost,
                        unit,
                        price: cost, // Also set price field for compatibility
                        category,
                        createdAt: serverTs(),
                        updatedAt: serverTs()
                    };
                    
                    const docRef = await db.collection('inventory_items').add(newItem);
                    const newId = docRef.id;
                    
                    // Update the item with its new ID
                    newItem.id = newId;
                    await docRef.update({ id: newId });
                    
                    console.log(`âœ… New item added to Firestore: ${name} (id: ${newId})`);
                    
                    // Also add to window arrays for immediate display
                    if (category === 'raw') {
                        if (!window.costRaw) window.costRaw = [];
                        window.costRaw.push(newItem);
                    } else if (category === 'packing') {
                        if (!window.costPack) window.costPack = [];
                        window.costPack.push(newItem);
                    } else if (category === 'finished') {
                        if (!window.costFinished) window.costFinished = [];
                        window.costFinished.push(newItem);
                    }
                    
                    // Save to localStorage immediately
                    try {
                        if (category === 'raw') {
                            localStorage.setItem('cost_raw', JSON.stringify(window.costRaw || []));
                        } else if (category === 'packing') {
                            localStorage.setItem('cost_pack', JSON.stringify(window.costPack || []));
                        } else if (category === 'finished') {
                            localStorage.setItem('cost_finished', JSON.stringify(window.costFinished || []));
                        }
                        console.log(`ğŸ’¾ Saved to localStorage: ${name}`);
                    } catch(e) {
                        console.warn('âš ï¸ Failed to save to localStorage:', e);
                    }
                    
                    // Save to cloud via saveLists
                    if (typeof window.saveLists === 'function') {
                        window.saveLists(false).catch(e => console.warn('âš ï¸ Failed to sync to cloud:', e));
                    }
                    
                    alert(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${name}" Ø¨Ù†Ø¬Ø§Ø­`);
                    
                    // Close modal and refresh
                    document.getElementById('addItemModal').style.display = 'none';
                    window.inventorySystem.loadInventoryData(category);
                } catch(err) {
                    console.error('âŒ saveNewItem failed:', err);
                    alert(`âŒ Ø®Ø·Ø£: ${err.message}`);
                }
            }
        };

        // ===== Offline Queue for Inventory Updates =====
        (function(){
            const LS_INV_QUEUE = 'pending_inventory_updates';
            function readQueue(){ try { return JSON.parse(localStorage.getItem(LS_INV_QUEUE) || '[]'); } catch(_) { return []; } }
            function writeQueue(arr){ try { localStorage.setItem(LS_INV_QUEUE, JSON.stringify(arr||[])); } catch(_){} }
            window.addPendingInventoryUpdate = function(op){
                try {
                    const q = readQueue();
                    q.push({ id: op.id, category: op.category, stock: op.stock, name: op.name, ts: new Date().toISOString() });
                    writeQueue(q);
                    console.log('ğŸ•’ queued inventory update', op);
                } catch(e){ console.warn('queue add failed', e); }
            };
            window.flushPendingInventoryUpdates = async function(){
                if (!navigator.onLine || !window.db) return false;
                let q = readQueue(); if (!Array.isArray(q) || q.length===0) return true;
                const remaining = [];
                for (const op of q){
                    try {
                        if (!op.id) { remaining.push(op); continue; }
                        await db.collection('inventory_items').doc(op.id).set({ stock: op.stock, updatedAt: serverTs() }, { merge: true });
                        console.log('â˜ï¸ flushed inventory update', op);
                    } catch(e){ console.warn('flush failed for', op, e); remaining.push(op); }
                }
                writeQueue(remaining);
                return remaining.length===0;
            };
            window.addEventListener('online', function(){ 
                // Re-enabled: Safe auto-flush when back online
                console.log('ğŸŒ Back online! Auto-flushing pending updates...');
                try { 
                    setTimeout(() => window.flushPendingInventoryUpdates(), 500);
                } catch(e){ console.warn('Auto-flush on online failed:', e); } 
            });
            // Try flushing shortly after page load
            // Disabled: was polling aggressively
            // setTimeout(()=>{ try { window.flushPendingInventoryUpdates(); } catch(_){ } }, 3000);
        })();

        // ==================== DATA MIGRATION (Auto-Run on First Load) ====================
        window.migrateInventoryToCloud = async function() {
            try {
                if (!window.db) { 
                    console.warn('âš ï¸ Firestore not ready yet, will retry...');
                    return false; 
                }
                
                // Ensure arrays are loaded
                if (!window.costRaw) window.costRaw = [];
                if (!window.costPack) window.costPack = [];
                if (!window.finishedProducts) window.finishedProducts = [];
                
                const migrated = { raw: 0, packing: 0, finished: 0 };
                
                // Helper function to get server timestamp
                const getTimestamp = () => {
                    try {
                        return firebase.firestore.FieldValue.serverTimestamp();
                    } catch(e) {
                        return new Date();
                    }
                };
                
                // Migrate window.costRaw (raw materials)
                if (Array.isArray(window.costRaw) && window.costRaw.length > 0) {
                    console.log(`ğŸ”„ Migrating ${window.costRaw.length} raw materials...`);
                    for (const item of window.costRaw) {
                        try {
                            if (!item || !item.name) continue;
                            
                            const docId = item.id || item.code || `raw_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                            const docRef = db.collection('inventory_items').doc(docId);
                            const existing = await docRef.get();
                            
                            if (!existing.exists) {
                                await docRef.set({
                                    name: item.name || '',
                                    code: item.code || '',
                                    unit: item.unit || 'ÙƒØ¬Ù…',
                                    category: 'raw',
                                    stock: 0,
                                    cost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    avgCost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    priceHistory: Array.isArray(item.priceHistory) ? item.priceHistory : [],
                                    lastInvoiceNumber: item.lastInvoiceNumber || '',
                                    lastVendorTaxId: item.lastVendorTaxId || '',
                                    createdAt: getTimestamp(),
                                    updatedAt: getTimestamp()
                                });
                                migrated.raw++;
                            }
                        } catch(itemErr) {
                            console.warn(`âš ï¸ Failed to migrate raw item: ${item?.name}`, itemErr);
                        }
                    }
                    console.log(`âœ… Migrated ${migrated.raw} raw materials`);
                }
                
                // Migrate window.costPack (packaging)
                if (Array.isArray(window.costPack) && window.costPack.length > 0) {
                    console.log(`ğŸ”„ Migrating ${window.costPack.length} packaging items...`);
                    for (const item of window.costPack) {
                        try {
                            if (!item || !item.name) continue;
                            
                            const docId = item.id || item.code || `pack_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                            const docRef = db.collection('inventory_items').doc(docId);
                            const existing = await docRef.get();
                            
                            if (!existing.exists) {
                                await docRef.set({
                                    name: item.name || '',
                                    code: item.code || '',
                                    unit: item.unit || 'Ù‚Ø·Ø¹Ø©',
                                    category: 'packing',
                                    stock: 0,
                                    cost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    avgCost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    priceHistory: Array.isArray(item.priceHistory) ? item.priceHistory : [],
                                    createdAt: getTimestamp(),
                                    updatedAt: getTimestamp()
                                });
                                migrated.packing++;
                            }
                        } catch(itemErr) {
                            console.warn(`âš ï¸ Failed to migrate packing item: ${item?.name}`, itemErr);
                        }
                    }
                    console.log(`âœ… Migrated ${migrated.packing} packaging items`);
                }

                // Migrate window.finishedProducts if exists
                if (Array.isArray(window.finishedProducts) && window.finishedProducts.length > 0) {
                    console.log(`ğŸ”„ Migrating ${window.finishedProducts.length} finished products...`);
                    for (const item of window.finishedProducts) {
                        try {
                            if (!item || !item.name) continue;
                            
                            const docId = item.id || `finished_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                            const docRef = db.collection('inventory_items').doc(docId);
                            const existing = await docRef.get();
                            
                            if (!existing.exists) {
                                await docRef.set({
                                    name: item.name || '',
                                    code: item.code || '',
                                    unit: item.unit || 'Ù‚Ø·Ø¹Ø©',
                                    category: 'finished',
                                    stock: 0,
                                    cost: parseFloat(item.cost) || 0,
                                    avgCost: parseFloat(item.cost) || 0,
                                    createdAt: getTimestamp(),
                                    updatedAt: getTimestamp()
                                });
                                migrated.finished++;
                            }
                        } catch(itemErr) {
                            console.warn(`âš ï¸ Failed to migrate finished product: ${item?.name}`, itemErr);
                        }
                    }
                    console.log(`âœ… Migrated ${migrated.finished} finished products`);
                }
                
                const total = migrated.raw + migrated.packing + migrated.finished;
                if (total > 0) {
                    console.log(`ğŸ‰ Migration completed! Total: ${total} items`);
                    
                    // Show success message to user
                    try {
                        await customDialog({ 
                            title: 'âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 
                            message: `ØªÙ… Ø±ÙØ¹ ${total} ØµÙ†Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\nâ€¢ Ø®Ø§Ù…Ø§Øª: ${migrated.raw}\nâ€¢ ØªØºÙ„ÙŠÙ: ${migrated.packing}\nâ€¢ Ù…Ù†ØªØ¬Ø§Øª ØªØ§Ù…Ø©: ${migrated.finished}` 
                        });
                    } catch(e) { 
                        console.warn('Dialog failed:', e);
                    }
                    
                    // Auto-refresh inventory view if on stock-control page
                    if (window.inventorySystem && window.inventorySystem.loadInventoryData) {
                        setTimeout(() => window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab || 'raw'), 500);
                    }
                } else {
                    console.log('â„¹ï¸ No new items to migrate');
                }
                
                return true;
            } catch (err) {
                console.error('âŒ Migration failed:', err);
                try {
                    await customDialog({ title: 'âŒ Ø®Ø·Ø£', message: 'ÙØ´Ù„ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n' + (err.message || JSON.stringify(err)) });
                } catch(e) { 
                    console.error('Error dialog failed:', e);
                }
                return false;
            }
        };

        // AUTO-RUN MIGRATION: Check if inventory is empty, then migrate
        window.autoMigrateIfNeeded = async function() {
            try {
                if (!window.db) {
                    console.log('â³ Waiting for Firestore...');
                    setTimeout(window.autoMigrateIfNeeded, 1000);
                    return;
                }
                // Ù„Ø§ ØªÙØ´ØºÙ‘Ù„ Ø§Ù„ØªÙ‡Ø¬ÙŠØ± Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…ØªØ§Ø­ Ø£Ùˆ ØªÙ…Ù‘Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§
                if (window.__migrationAttempted) { console.log('â­ï¸ Migration already attempted, skipping.'); return; }
                if (!navigator.onLine) { console.log('â­ï¸ Offline: skipping auto-migration'); window.__migrationAttempted = true; return; }
                
                // Ensure costRaw and costPack are loaded from localStorage if not in window
                if (!window.costRaw || window.costRaw.length === 0) {
                    try {
                        const rawFromLS = localStorage.getItem('cost_raw');
                        if (rawFromLS) {
                            window.costRaw = JSON.parse(rawFromLS);
                            console.log(`ğŸ“¦ Loaded ${window.costRaw.length} items from localStorage (cost_raw)`);
                        }
                    } catch(e) {
                        console.warn('Failed to load cost_raw from localStorage:', e);
                    }
                }
                
                if (!window.costPack || window.costPack.length === 0) {
                    try {
                        const packFromLS = localStorage.getItem('cost_pack');
                        if (packFromLS) {
                            window.costPack = JSON.parse(packFromLS);
                            console.log(`ğŸ“¦ Loaded ${window.costPack.length} items from localStorage (cost_pack)`);
                        }
                    } catch(e) {
                        console.warn('Failed to load cost_pack from localStorage:', e);
                    }
                }
                
                // Check if inventory_items collection is empty
                const snapshot = await db.collection('inventory_items').limit(1).get();
                
                if (snapshot.empty) {
                    console.log('ğŸ“¦ Inventory is empty. Starting auto-migration...');
                    window.__migrationAttempted = true;
                    
                    // Show loading message
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'migration-loading';
                    loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:99999;text-align:center;';
                    loadingDiv.innerHTML = '<div style="font-size:20px;font-weight:bold;color:#2563eb;margin-bottom:10px;">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div><div style="font-size:14px;color:#666;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>';
                    document.body.appendChild(loadingDiv);
                    
                    await window.migrateInventoryToCloud();
                    
                    // Remove loading message
                    try { document.getElementById('migration-loading').remove(); } catch(e) {}
                    
                } else {
                    console.log('âœ… Inventory already has data. Skipping migration.');
                    window.__migrationAttempted = true;
                }
            } catch (err) {
                console.error('âŒ Auto-migration check failed:', err);
            }
        };

        // Auto-load inventory when stock-control page is opened
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to initialize, then check migration
            setTimeout(() => {
                window.autoMigrateIfNeeded();
            }, 2000);
            
            // Load inventory data if stock page is active
            setTimeout(() => {
                const stockPage = document.getElementById('page-stock-control');
                if (stockPage && stockPage.classList.contains('active')) {
                    if (window.inventorySystem) window.inventorySystem.loadInventoryData('raw');
                }
            }, 3000);
        });

        // ==================== BRIDGE OLD RENDER FUNCTIONS TO NEW UI ====================
        // Override old functions to work with new tabbed interface
        
        // Fix Counters - Update tab headers with correct item counts
        function updateCounters() {
            try {
                // Update Raw Materials counter
                if (window.costRaw && Array.isArray(window.costRaw)) {
                    const btnRaw = document.getElementById('btn-raw');
                    if (btnRaw) {
                        btnRaw.innerHTML = `ğŸ¥› Ø®Ø§Ù…Ø§Øª <span class="bg-yellow-100 text-yellow-800 text-xs px-2 rounded-full">${window.costRaw.length}</span>`;
                    }
                }
                
                // Update Packaging counter
                if (window.costPack && Array.isArray(window.costPack)) {
                    const btnPack = document.getElementById('btn-packing');
                    if (btnPack) {
                        btnPack.innerHTML = `ğŸ¥¡ ØªØºÙ„ÙŠÙ <span class="bg-purple-100 text-purple-800 text-xs px-2 rounded-full">${window.costPack.length}</span>`;
                    }
                }
                
                // Fix Finished Products: count from costFinished, finishedProducts, or derived grid state
                let finishedCount = 0;
                if (window.costFinished && Array.isArray(window.costFinished) && window.costFinished.length > 0) {
                    window.finishedProducts = window.costFinished;
                    finishedCount = window.costFinished.length;
                    console.log(`ğŸ“¦ Loaded finishedProducts from window.costFinished: ${finishedCount} items`);
                    renderFinishedProducts();
                } else if (window.finishedProducts && Array.isArray(window.finishedProducts) && window.finishedProducts.length > 0) {
                    finishedCount = window.finishedProducts.length;
                } else {
                    try {
                        const derived = (typeof __getFinishedFromGrid === 'function') ? __getFinishedFromGrid() : [];
                        finishedCount = Array.isArray(derived) ? derived.length : 0;
                        if (finishedCount > 0) {
                            // keep UI consistent by rendering immediately
                            renderFinishedProducts();
                            console.log(`ğŸ“¦ Finished count from grid state: ${finishedCount}`);
                        }
                    } catch(_) { finishedCount = 0; }
                }
                
                const btnFinished = document.getElementById('btn-finished');
                if (btnFinished) {
                    btnFinished.innerHTML = `ğŸ“¦ Ù…Ù†ØªØ¬ ØªØ§Ù… <span class="bg-blue-100 text-blue-800 text-xs px-2 rounded-full">${finishedCount}</span>`;
                }
                
                console.log(`âœ… updateCounters: Raw=${window.costRaw?.length || 0}, Pack=${window.costPack?.length || 0}, Finished=${finishedCount}`);
                
                // Save finished products to localStorage and Cloud
                if (window.finishedProducts && window.finishedProducts.length > 0) {
                    try {
                        localStorage.setItem('cost_finished', JSON.stringify(window.finishedProducts));
                        console.log(`ğŸ’¾ Saved ${finishedCount} finished products to localStorage`);
                        
                        // Also save to Firestore via saveCostListsToFirebase if available
                        if (navigator.onLine && typeof window.saveCostListsToFirebase === 'function') {
                            window.saveCostListsToFirebase(true).catch(e => console.warn('âš ï¸ Failed to save finished products to cloud:', e));
                        }
                    } catch(e) {
                        console.warn('âš ï¸ Failed to save finished products:', e);
                    }
                }
            } catch(e) {
                console.error('âŒ updateCounters failed:', e);
            }
        }
        
        function renderRawMaterials() {
            try {
                const tbody = document.getElementById('table-raw');
                if (!tbody) {
                    console.warn('âš ï¸ table-raw not found');
                    return;
                }
                if (!window.costRaw || !Array.isArray(window.costRaw) || window.costRaw.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø§Ù…Ø§Øª</td></tr>';
                    return;
                }
                
                tbody.innerHTML = window.costRaw.map((item, idx) => `
                    <tr onclick="window.inventorySystem.openItemModal('${item.id || item.name || 'raw_' + idx}')" class="hover:bg-blue-50 cursor-pointer border-b">
                        <td class="p-3 font-bold">${item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td class="p-3 text-blue-700 font-bold text-center">${item.stock || 0}</td>
                        <td class="p-3 text-sm text-gray-500 text-center">${item.unit || 'ÙƒØ¬Ù…'}</td>
                        <td class="p-3 text-sm text-center">${parseFloat(item.cost || item.avgCost || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                console.log(`âœ… renderRawMaterials: rendered ${window.costRaw.length} items`);
                try { if (typeof updateCounters === 'function') updateCounters(); } catch(_){ }
            } catch(e) {
                console.error('âŒ renderRawMaterials failed:', e);
            }
        }

        function renderPackaging() {
            try {
                const tbody = document.getElementById('table-packing');
                if (!tbody) {
                    console.warn('âš ï¸ table-packing not found');
                    return;
                }
                if (!window.costPack || !Array.isArray(window.costPack) || window.costPack.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ ØªØºÙ„ÙŠÙ</td></tr>';
                    return;
                }

                tbody.innerHTML = window.costPack.map((item, idx) => `
                    <tr onclick="window.inventorySystem.openItemModal('${item.id || item.name || 'pack_' + idx}')" class="hover:bg-blue-50 cursor-pointer border-b">
                        <td class="p-3 font-bold">${item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td class="p-3 text-purple-700 font-bold text-center">${item.stock || 0}</td>
                        <td class="p-3 text-sm text-gray-500 text-center">${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                        <td class="p-3 text-sm text-center">${parseFloat(item.cost || item.avgCost || 0).toFixed(2)}</td>
                    </tr>
                `).join('');

                console.log(`âœ… renderPackaging: rendered ${window.costPack.length} items`);
                try { if (typeof updateCounters === 'function') updateCounters(); } catch(_){ }
            } catch(e) {
                console.error('âŒ renderPackaging failed:', e);
            }
        }

        // Helper: build finished products array from grid state
        function __getFinishedFromGrid(){
            try {
                const src = (window._finishedGridState && typeof window._finishedGridState === 'object') ? window._finishedGridState : (function(){ try { return JSON.parse(localStorage.getItem('finished_products_grid')||'{}'); } catch(_) { return {}; }})();
                const arr = []; const keys = Object.keys(src||{});
                keys.forEach(id => { const it = src[id]||{}; arr.push({ id, name: it.name || id, stock: (it.actual != null ? it.actual : (it.opening != null ? it.opening : 0)), unit: 'Ù‚Ø·Ø¹Ø©', cost: Number(it.cost||0) }); });
                return arr;
            } catch(_) { return []; }
        }

        function renderFinishedProducts() {
            try {
                const tbody = document.getElementById('table-finished');
                if (!tbody) {
                    console.warn('âš ï¸ table-finished not found');
                    return;
                }
                
                // âœ… FIXED: Use ONLY window.costFinished (removed finishedProducts fallback to avoid variable mismatch)
                let products = (window.costFinished && Array.isArray(window.costFinished) && window.costFinished.length > 0) ? window.costFinished : __getFinishedFromGrid();
                
                if (!products || !Array.isArray(products) || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ§Ù…Ø©. Ø§Ø¶ØºØ· "+" Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬.</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map((item, idx) => {
                    // Handle both old format (id, name, unit, price) and new format (name, stock, cost)
                    const itemName = item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const itemStock = item.stock !== undefined ? item.stock : 0;
                    const itemPrice = item.price !== undefined ? item.price : (item.cost || 0);
                    const itemUnit = item.unit || 'Ù‚Ø·Ø¹Ø©';
                    
                    return `
                        <tr onclick="window.inventorySystem.openItemModal('${item.id || item.name || 'finished_' + idx}')" class="hover:bg-blue-50 cursor-pointer border-b">
                            <td class="p-3 font-bold">${itemName}</td>
                            <td class="p-3 text-green-700 font-bold text-center">${itemStock}</td>
                            <td class="p-3 text-sm text-gray-500 text-center">${itemUnit}</td>
                            <td class="p-3 text-sm text-center">${parseFloat(itemPrice || 0).toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                console.log(`âœ… renderFinishedProducts: rendered ${products.length} items`);
                try { if (typeof updateCounters === 'function') updateCounters(); } catch(_){ }
            } catch(e) {
                console.error('âŒ renderFinishedProducts failed:', e);
            }
        }

        // Auto-refresh views after page load
        document.addEventListener('DOMContentLoaded', function() {
            // Disabled: was causing excessive polling and hang
            // setTimeout(() => {
            //     console.log('ğŸ”„ Auto-refreshing inventory views...');
            //     updateCounters();
            //     renderRawMaterials();
            //     renderPackaging();
            //     renderFinishedProducts();
            // }, 4000);
        });
    </script>
