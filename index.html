<!DOCTYPE html>
<html lang="ar" dir="rtl">
    <style id="fallback-hidden-css">
        /* Fallback: ensure elements with class 'hidden' are actually hidden
           even if Tailwind fails to load on some devices/browsers */
        .hidden { display: none !important; }
    </style>
        <!-- Tailwind CDN is not recommended in production; keep for now or replace with compiled CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas for converting receipts to images for thermal printers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Cinzel:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet>
    <!-- Note: Using the Tailwind CDN is fine for development only. For production install Tailwind as a PostCSS plugin
         or use the Tailwind CLI per https://tailwindcss.com/docs/installation -->
    
    <!-- Library to convert HTML to Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- NEW: Include Chart.js library for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Lucide Icons (before other scripts) -->

    <!-- Global error overlay to surface runtime issues to the user -->
    

    <!-- Leaflet for interactive maps (CDN) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

        <!-- تم إلغاء الاعتماد على الحالة المشتركة القديمة (shared/public_app_state) نهائياً -->

        <!-- Firebase SDK (compat build for simple global usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

        <!-- Firebase Config injected from user-provided settings (modular snippet adapted) -->
        

    <!-- Firebase Configuration & Authentication System -->
    

    <!-- ===== CustomersService: Cache-First Customer Data Management ===== -->
    

    <!-- ===== SalesService: Sales & Invoices with Offline Queue ===== -->
    

    <!-- Firebase initialization + sync helpers -->
    
    

    <style>
        
        /* watermark removed - body::before deleted per user request */

        #app-container {
            background-color: #ffffff !important; /* reset to white after watermark removal */
            padding-bottom: 120px; /* Ensure content doesn't hide behind bottom nav */
            padding-top: 72px; /* Offset for fixed header height so content is visible */
        }
        /* Extra safety: ensure pages have at least header offset if used outside app-container */
        .page { padding-top: 8px; }
        /* Fix main header to top so it doesn't scroll away */
        header {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            z-index: 70;
        }
        
        .page { display: none; }
        .page.active { display: block; }

        /* Main Bottom Nav Styling */
        .bottom-nav {
            position: fixed !important;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60; /* Ensure main nav is above other content */
            background: #ffffff;
            height: auto;
            min-height: 56px;
        }
        .bottom-nav-item { 
            width: 7.69%; /* Adjusted for 13 items */
            transition: all 0.2s ease;
            color: #6b7280; /* Gray-500 default */
            padding: 8px 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
        } 
        
        /* Simple Active State (Default blue on click/active page) */
        .bottom-nav-item.active {
            color: #2563eb; /* Blue-600 */
            font-weight: 600;
        }

        /* Icon styling - Improved specificity and defaults */
        .lucide-icon {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
        }

        /* Bottom nav specific icon styling */
        .bottom-nav-item svg {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
            margin: 0 auto !important;
        }

        .bottom-nav-item.active svg {
            color: #2563eb !important; 
        }

        /* Ensure all Lucide icons have consistent styling */
        [data-lucide] {
            display: inline-block !important;
            vertical-align: middle !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
        }

        /* Additional size variations */
        [data-lucide].icon-sm {
            width: 16px !important;
            height: 16px !important;
        }
        
        /* Debts Table Styling to match screenshot */
        #debts-detail-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-family: Arial, sans-serif !important;
            direction: rtl !important;
        }
        
        #debts-detail-table th {
            background: #5c3317 !important;
            color: white !important;
            font-weight: bold !important;
            padding: 8px !important;
            border: 1px solid #3e2211 !important;
            text-align: center !important;
        }
        
        #debts-detail-table td {
            padding: 8px !important;
            border: 1px solid #ddd !important;
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            text-align: center !important;
            color: black !important;
            font-weight: bold !important;
        }
        
        #debts-detail-table td:first-child {
            text-align: right !important;
        }
        
        /* Force visibility of table elements */
        #debts-detail-table, #debts-detail-table thead, #debts-detail-table tbody,
        #debts-detail-table tr, #debts-detail-table th, #debts-detail-table td {
            display: revert !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        [data-lucide].icon-lg {
            width: 32px !important;
            height: 32px !important;
        }

        /* Allow specific size overrides through classes */
        [data-lucide].w-4 { width: 16px; height: 16px; }
        [data-lucide].w-5 { width: 20px; height: 20px; }
        [data-lucide].w-6 { width: 24px; height: 24px; }

        /* (removed) Floating action button for Month Close */

        /* تكبير خاص للتصدير في تقرير التسوية النهائية */
        .recon-export-scale { width:1800px !important; }
        .recon-export-scale table { width:100% !important; }
        .recon-export-scale th, .recon-export-scale td { padding:10px !important; font-size:16px !important; }

        /* Inquiry page table styling */
        #inq-report-table th { background:#041635;color:#fff;padding:6px 8px;text-align:center;font-weight:700; }
        #inq-report-table td { padding:5px 6px;text-align:center;border-bottom:1px solid #e0e7ef; }
        #inq-report-table td.prod-name { text-align:right;font-weight:600;background:#f8fafc; }
        #inq-report-table tr:nth-child(even) td { background:#ffffff; }
        #inq-report-table tr:nth-child(odd) td { background:#f3f6fa; }
        #inq-report-table .qty-cell { font-weight:600;color:#0b3d91; }
        #inq-report-table .total-cell { font-weight:600;color:#07523e; }
        #inq-summary .card { background:#041a3f;color:#fff;padding:12px 10px;border-radius:8px;display:flex;flex-direction:column;gap:4px; }
        #inq-summary .card span.val { font-size:16px;font-weight:700; }

        /* Price list sheet (match Excel-like style) */
        .price-sheet { width:100%; border-collapse:collapse; direction:rtl; font-size:12px; }
        .price-sheet thead th { background:#efefef; border:1px solid #c1c1d0; padding:6px 8px; text-align:center; font-weight:800; }
        .price-sheet tbody td { border:1px solid #d4d4e0; padding:6px 8px; text-align:center; }
        .price-sheet tbody tr:nth-child(odd) td { background:#f9f9fb; }
        .price-sheet tbody tr:nth-child(even) td { background:#ffffff; }
        .price-sheet td.name { text-align:right; font-weight:600; }
        .sheet-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .sheet-title { font-weight:800; font-size:16px; border:2px solid #888; padding:4px 10px; border-radius:4px; }
        .sheet-meta { display:flex; gap:12px; color:#374151; font-size:12px; }
        .pl-controls .label { font-weight:700; font-size:12px; }

        /* Column filter menu (Debts / Cash tables) */
        .column-filter-menu { position:absolute; background:#ffffff; border:1px solid #c4a300; box-shadow:0 4px 10px rgba(0,0,0,0.12); border-radius:6px; padding:8px; width:220px; max-height:340px; overflow:auto; font-size:12px; z-index:9999; direction:rtl; }
        .column-filter-menu .filter-search { width:100%; padding:4px 6px; border:1px solid #ddd; border-radius:4px; margin-bottom:6px; font-size:12px; }
        .column-filter-menu .filter-list label { cursor:pointer; line-height:1.4; }
        .column-filter-menu .filter-list input { vertical-align:middle; }
        .column-filter-menu .filter-actions { display:flex; gap:6px; margin-top:8px; }
        .column-filter-menu .filter-actions button { flex:1; background:linear-gradient(180deg,#ffd700,#daa520); color:#000; font-weight:600; padding:6px 4px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
        .column-filter-menu .filter-actions button:hover { filter:brightness(1.05); }
        .column-filter-btn { position:relative; }
        .column-filter-btn.filtered { color:#1d4ed8 !important; font-weight:700; }
        .column-filter-btn.filtered::after { content:''; position:absolute; top:2px; inset-inline-end:2px; width:7px; height:7px; background:#1d4ed8; border-radius:50%; box-shadow:0 0 0 1px #ffffff; }
        


        /* Reports SubNav Styling - positioned in lower white space area below bottom nav */
        /* Reports subnav is hidden by default and only shown when .active is added by navigation */
        #reports-subnav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: -64px; /* Hide below bottom-nav by default */
            height: 64px; /* Taller area for icons/labels */
            background-color: #f3f4f6; /* Gray-100 */
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -1px 8px rgba(0,0,0,0.04);
            display: none;
            justify-content: space-around;
            align-items: center;
            padding: 0 6px;
            z-index: 50; /* below bottom nav */
            transition: bottom 0.3s ease;
        }

        #reports-subnav.active {
            display: flex !important;
            bottom: 56px !important; /* Position above bottom-nav (56px is default min-height) */
        }
        
        .reports-subnav-item {
            width: 25%; /* 4 items */
            padding: 0.5rem 0.25rem; /* Equivalent to p-2 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-600 */
            font-size: 0.75rem; /* text-xs */
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        /* Style for Lucide icons inside subnav buttons */
        .reports-subnav-item svg {
            color: #4b5563; /* Default icon color */
            width: 16px;
            height: 16px;
        }
        .reports-subnav-item.active svg,
        .reports-subnav-item.active span {
            color: #dc2626; /* red-600 */
            font-weight: 600; /* font-semibold */
        }


    .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            visibility: hidden;
        }
        .modal-visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            visibility: visible;
        }
        .hidden {
            display: none !important;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        #backup-data-textarea, #restore-data-textarea {
            resize: none;
            height: 150px;
            font-family: monospace;
            font-size: 12px;
            direction: ltr;
            text-align: left;
        }

        .only-print {
            display: none;
        }

        #sale-modal.modal-visible {
            transform: none; /* Override for full screen modal */
        }
        
        /* Spreadsheet Entry Styles (Matching user request image and color theme) */
        #spreadsheet-entry-table input,
        #spreadsheet-entry-table select {
            width: 100%;
            padding: 4px;
            font-size: 0.875rem; /* text-sm */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            min-width: 60px; /* Ensure minimum width */
            text-align: center;
            transition: background-color 0.1s ease;
        }
        
        /* Style for read-only fields */
        #spreadsheet-entry-table input[readonly], 
        #spreadsheet-entry-table .spreadsheet-product-name {
            background-color: #f3f4f6; /* gray-100 */
            cursor: default;
        }
        
        /* Highlighting specific input fields (No alternating rows, only cell colors) */
        .spreadsheet-invoice-number {
            background-color: #e0f2fe; /* Light Blue 100 */
            font-weight: 600;
        }
        .spreadsheet-product-code, 
        .spreadsheet-product-name {
            background-color: #d1fae5; /* Light Green 100 */
            font-weight: 500;
        }
        /* Style for required select fields in spreadsheet row */
        .spreadsheet-collection {
            background-color: #e5e7eb; /* Gray-200 slightly darker background */
        }
        .spreadsheet-total {
            background-color: #fce7f3; /* Pink-100 for totals */
            font-weight: 700;
            color: #9d174d; /* Rose-700 */
        }


        #spreadsheet-entry-table .spreadsheet-product-name,
        #spreadsheet-entry-table .spreadsheet-collection {
            text-align: right;
            padding-right: 8px; /* Give some space for Arabic text */
        }
        #spreadsheet-entry-table th,
        #spreadsheet-entry-table td {
            padding: 4px 6px;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        /* New styles for Promotion Price Highlight */
        #spreadsheet-entry-table .spreadsheet-price.promotion-price-applied {
            background-color: #fef3c7 !important; /* Yellow-100 */
            color: #b91c1c !important; /* Red-700 */
            font-weight: 800;
            border: 2px solid #f59e0b; /* Amber-500 */
        }
        /* Style for Tax Filing Status field */
        .spreadsheet-tax-status-input {
            background-color: #fef2f2; /* Red-50 */
            text-align: center;
        }
        /* Style for Sales List Not Filed Tax Status */
        .tax-not-filed-badge {
            background-color: #fef2f2; /* Red-50 */
            color: #991b1b; /* Red-800 */
            font-weight: 700;
            border: 2px solid #dc2626; /* Red-600 */
            padding: 2px 8px;
        }

        /* NEW: Styling for Detailed Sales Table View */
        .sale-detail-grid {
            grid-template-columns: 1fr 3fr 1fr; /* Total | Details | Actions */
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sale-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 10px;
        }
        /* Ensure table header and rows use identical grid columns for perfect alignment */
        .sale-items-table thead tr,
        .sale-items-table tbody tr {
            display: grid;
            grid-template-columns: 2fr 0.5fr 0.5fr 0.5fr auto;
            align-items: center;
        }
        .sale-items-table th,
        .sale-items-table td {
            display: block; /* allow grid children sizing */
            padding-left: .75rem; padding-right: .75rem; padding-top: .5rem; padding-bottom: .5rem;
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        /* constrain numeric inputs to the column width and center them */
        .sale-item-quantity, .sale-item-price {
            width: 100%;
            max-width: 4.5rem;
            margin: 0 auto;
            text-align: center;
        }

        /* Make sure the sale modal content clears any fixed page header */
        #sale-modal main {
            margin-top: 80px !important; /* clear the fixed top navigation */
        }

        /* Force table/thead/tbody to block so grid rows align correctly */
        .sale-items-table,
        .sale-items-table thead,
        .sale-items-table tbody {
            display: block;
            width: 100%;
        }
        .sale-items-table th, .sale-items-table td {
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        .sale-items-table th {
            font-weight: 600;
            color: #4b5563;
            background-color: #f9fafb;
        }

        /* --- NEW SALES LIST CELL COLORS (Matching Spreadsheet) --- */
        .sale-item-name-cell, .sale-item-code-cell {
            background-color: #d1fae5; /* Green-100 */
        }
        .sale-item-total-cell {
            background-color: #fce7f3; /* Pink-100 */
            color: #9d174d; /* Pink-700 for high contrast */
        }
        .sale-item-qty-cell, .sale-item-price-cell {
            background-color: #e0f2fe; /* Blue-100 */
        }
        /* -------------------------------------------------------- */


        /* NEW: Styles for dedicated printing */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }

        /* Invoice quick-search fixed sidebar (only on Sales page, desktop) */
        /* Make the invoice quick-search visible and fixed inside Sales page by default
           (always visible so user can test easily). Change media query later if you want
           to hide on small screens. */
        #page-sales #invoice-quick-search {
            display: block !important;
            position: fixed;
            left: 12px; /* position at left side like the screenshot */
            top: 96px; /* a bit lower under the sticky header */
            width: 190px;
            height: calc(100vh - 120px);
            overflow: auto;
            z-index: 9; /* stay below header (header uses z-10) */
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            background: #ffffff;
        }
        
        /* Dispatch Item Inputs Styling */
        #dispatch-items-table input {
            padding: 2px 4px !important;
            font-size: 0.75rem !important;
        }

        /* Stock Control Column Colors */
        .stock-col-initial { background-color: #e0f2fe; } /* Light Blue */
        .stock-col-inward { background-color: #dcfce7; } /* Light Green */
        .stock-col-production { background-color: #f3e8ff; } /* Light Purple */
        .stock-col-outbound { background-color: #fef9c3; } /* Light Yellow */
        .stock-col-book { background-color: #e5e7eb; } /* Gray */
        .stock-col-actual { background-color: #fee2e2; } /* Light Red */
        .stock-col-diff { background-color: #ffedd5; } /* Light Orange */
        
        /* NEW: Custom Highlight Colors for Manual Review */
        .invoice-cell {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 8px;
            display: inline-block;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 700;
        }
        .invoice-cell.highlight-blue {
            background-color: #93c5fd !important; /* Blue-300 */
            color: #1e3a8a !important; /* Blue-900 */
        }
        .invoice-cell.highlight-green {
            background-color: #86efac !important; /* Green-300 */
            color: #14532d !important; /* Green-900 */
        }
        .invoice-cell.highlight-purple {
            background-color: #c4b5fd !important; /* Violet-300 */
            color: #4c1d95 !important; /* Violet-900 */
        }
        .invoice-cell.highlight-orange {
            background-color: #fed7aa !important; /* Orange-300 */
            color: #7c2d12 !important; /* Orange-900 */
        }
        .invoice-cell.highlight-teal {
            background-color: #99f6e4 !important; /* Teal-300 */
            color: #0f766e !important; /* Teal-800 */
        }
        /* ===== Debts page custom layout (matches provided screenshot) ===== */
        #debts-detail-table th {
    background: linear-gradient(180deg,#ffd700,#daa520) !important;
    color: black !important;
    font-weight: bold !important;
    padding: 8px !important;
    border: 1px solid #c4a300 !important;
    text-align: center !important;
}

.debts-container {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        .debts-sidebar {
            width: 320px; /* fixed left column */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .debts-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }
        .debt-card {
            border-radius: 10px;
            padding: 22px 16px;
            margin-bottom: 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
            background: linear-gradient(180deg, #fff7ed, #fef3c7);
        }
        .debt-card .title {
            font-weight: 700;
            color: #7c4a00;
            margin-bottom: 6px;
        }
        .debt-card .value {
            font-size: 28px;
            font-weight: 800;
            color: #3b2a0d;
        }
        .debt-card.big {
            background: linear-gradient(180deg,#7a4300,#3b2300);
            color: #fff;
            padding: 26px 18px;
        }

        /* Make the debts table header gold gradient */
        .gold-header th {
            background: linear-gradient(180deg,#f6d06a,#d59d00);
            color: #3b2a04;
            font-weight: 800;
            padding: 14px;
            border-right: 1px solid rgba(255,255,255,0.15);
        }
        /* Adjust table to take remaining space */
        .debts-main {
            flex: 1 1 auto;
        }
        /* Small adjustments for date inputs and filters to match screenshot */
        .filter-input { height:44px; padding:10px 12px; }
        
        /* Fix for debts table visibility: ensure table elements use proper table display types
           and prevent parent overflow from clipping rows when rendering under some environments. */
          #debts-detail-table { display: table !important; width: 100% !important; table-layout: auto !important; position: relative !important; z-index: 5 !important; }
        #debts-detail-table thead { display: table-header-group !important; }
        #debts-detail-table tbody { display: table-row-group !important; }
        #debts-detail-table tr { display: table-row !important; visibility: visible !important; opacity: 1 !important; }
        #debts-detail-table td, #debts-detail-table th { display: table-cell !important; color: inherit !important; }
        .debts-main .overflow-x-auto { overflow: auto !important; }

        /* Stronger visibility rules for debts rows in case theme/global CSS hides them */
        #debts-detail-table tbody tr td {
            color: #111 !important;
            background: transparent !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: table-cell !important;
            font-size: 14px !important;
        }
        #debts-detail-table tbody {
            min-height: 120px !important;
        }
        /* Allow JS filtering to hide rows even with the base !important rules */
        #debts-detail-table tr.hidden-by-filter { display: none !important; }
        /* Ensure debts main content sits above any large background watermark */
        .debts-main { position: relative !important; z-index: 6 !important; }

        /* Column filter UI removed (restored original header behavior) */
        /* Re-introduced column filter UI styles */
        .column-filter-btn {
            display:inline-block;
            background:transparent;
            border:0;
            cursor:pointer;
            padding:2px 6px;
            margin-inline-start:6px;
            border-radius:4px;
            font-size:14px;
        }
        .column-filter-btn:hover { background: rgba(0,0,0,0.04); }
        .column-filter-menu {
            position: absolute;
            z-index: 99999;
            background: #fff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            padding: 8px;
            width: 260px;
            max-height: 340px;
            overflow: hidden;
            direction: rtl;
            display: none;
            border-radius: 6px;
        }
        .column-filter-menu .filter-search { width:100%; padding:8px; border:1px solid #e5e7eb; margin-bottom:6px; border-radius:4px; }
        .column-filter-menu .filter-list { max-height:200px; overflow:auto; padding-right:6px; }
        .column-filter-menu .filter-list label { display:block; padding:4px 2px; font-size:13px; }
        .column-filter-menu .filter-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
        .column-filter-menu .filter-actions button { padding:6px 10px; border-radius:6px; border:0; cursor:pointer; }
        .column-filter-menu .apply-btn { background:#f97316; color:white; }
        .column-filter-menu .clear-btn { background:#f3f4f6; color:#111; }

        /* Alternating row colors to match the screenshot */
        /* Even rows - lighter gold */
        #debts-detail-table tbody tr:nth-child(even) td {
            background: linear-gradient(180deg, #fff5d5, #ffd868) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }
        
        /* Odd rows - darker gold */
        #debts-detail-table tbody tr:nth-child(odd) td {
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }

        /* Money columns - all centered */
        #debts-detail-table tbody tr td.total,
        #debts-detail-table tbody tr td.paid,
        #debts-detail-table tbody tr td.remaining {
            text-align: center !important;
        }

        /* Text alignment */
        #debts-detail-table tbody tr td {
            text-align: center !important;
        }
        #debts-detail-table tbody tr td.customer-name {
            text-align: right !important;
        }

        /* Header styling (legacy) - replaced by Cool Gradient theme below */
        #debts-detail-table thead th {
            /* legacy fallback kept intentionally */
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: bold !important;
            padding: 8px !important;
            text-align: center !important;
        }

        /* ===== Cool Gradient Theme for Debts Table ===== */
        /* Table shell */
        #debts-detail-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-family: Arial, sans-serif !important;
            direction: rtl !important;
            border: 1px solid #a5b4fc !important; /* cool cyan border */
            color: #0f172a !important;
        }

        /* Glossy linear gradient header: right (dark purple) → royal blue → teal (left) */
        #debts-detail-table thead th {
            background: linear-gradient(to left, #2c0f5b 0%, #2b6cb0 50%, #06b6d4 100%) !important;
            color: #ffffff !important;
            font-weight: 800 !important;
            padding: 10px 12px !important;
            text-align: center !important;
            border-bottom: 1px solid rgba(0,0,0,0.12) !important;
            border-top: 2px solid rgba(255,255,255,0.35) !important; /* slight white top-border for glossy effect */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
        }

        /* First column (right-most) - Date/Day */
        #debts-detail-table tbody td:first-child,
        #debts-detail-table tbody th:first-child {
            background: #2c0f5b !important; /* dark purple */
            color: #ffffff !important;
            font-weight: 700 !important;
            text-align: right !important;
            border-right: 1px solid #a5b4fc !important;
        }

        /* Data column tints (3-column repeating pattern) */
        /* Pattern: (3n+1) soft blue, (3n+2) light lavender, (3n+3) pale cyan */
        #debts-detail-table tbody td:nth-child(3n+1) {
            background: rgba(230,240,255,0.85) !important; /* soft blue */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }
        #debts-detail-table tbody td:nth-child(3n+2) {
            background: rgba(243,229,255,0.88) !important; /* light lavender */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }
        #debts-detail-table tbody td:nth-child(3n+3) {
            background: rgba(224,247,250,0.88) !important; /* pale cyan */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }

        /* Zebra-striping overlay: slightly adjust tint on even rows */
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+1) { background: rgba(216,230,255,0.9) !important; }
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+2) { background: rgba(236,228,255,0.9) !important; }
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+3) { background: rgba(206,244,246,0.9) !important; }

        /* Money/total cells highlight */
        #debts-detail-table tbody tr td.total,
        #debts-detail-table tbody tr td.paid,
        #debts-detail-table tbody tr td.remaining {
            background: #06b6d4 !important; /* bright cyan/teal */
            color: #ffffff !important;
            font-weight: 800 !important;
            border: 1px solid #7dd3fc !important;
        }

        /* Hover accent */
        #debts-detail-table tbody tr:hover td {
            transform: translateY(0);
            box-shadow: inset 0 0 0 9999px rgba(255,255,255,0.02);
            transition: background-color 120ms ease;
        }

        /* Footer */
        #debts-detail-table tfoot td {
            background: linear-gradient(to left, #0f172a, #1e293b) !important; /* dark indigo/navy */
            color: #ffffff !important;
            font-weight: 700 !important;
            padding: 10px !important;
            border-top: 2px solid #a5b4fc !important;
        }

        /* Ensure cells have visible cool-blue borders */
        #debts-detail-table td, #debts-detail-table th {
            border: 1px solid #a5b4fc !important;
            padding: 8px !important;
        }

        /* Keep customer name right-aligned for Arabic */
        #debts-detail-table tbody tr td.customer-name { text-align: right !important; }

        /* Small responsive fix: allow table to scroll horizontally */
        .debts-main .overflow-x-auto { overflow-x: auto !important; }

        /* End Cool Gradient Theme */

        /* Summary boxes styling - different gold gradients */
        .debt-card {
            padding: 20px !important;
            border-radius: 8px !important;
            margin: 8px !important;
        }

        /* اجمالي الفواتير */
        .debt-card:nth-child(1) {
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            color: black !important;
        }

        /* المسدد */
        .debt-card:nth-child(2) {
            background: linear-gradient(180deg, #f0c233, #cc9900) !important;
            color: black !important;
        }

        /* SUB TOTAL */
        .debt-card:nth-child(3) {
            background: linear-gradient(180deg, #ffdb4d, #e6b800) !important;
            color: black !important;
        }

        /* اجمالي المديونيات - lighter brown */
        .debt-card.big {
            background: linear-gradient(180deg, #8b6914, #654b0f) !important;
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        }

        /* Hover effect - lighter gold for both odd and even rows */
        #debts-detail-table tbody tr:hover td {
            background: linear-gradient(180deg, #fff7e6, #ffe180) !important;
        }

        /* Splash Screen Styles - SHOW BY DEFAULT */
        #splash-screen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: linear-gradient(135deg, #8b5fbf 0%, #5a3d8a 100%) !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            flex-direction: column !important;
            z-index: 9999 !important;
            font-family: 'Montserrat', sans-serif, -apple-system, BlinkMacSystemFont, sans-serif !important;
            overflow: hidden !important;
        }

        #splash-logo-wrapper {
            position: relative;
            width: 500px;
            height: 400px;
            margin-bottom: 20px;
        }

        #splash-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* تنسيق قطع اللوجو (التجميع من التشتت) */
        .splash-piece {
            position: absolute;
            background-image: url('https://i.ibb.co/YT4114YW/image.jpg');
            background-repeat: no-repeat;
            background-size: 500px 400px;
            opacity: 0;
            transform: scale(0);
            transition: all 5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .splash-trademark {
            position: absolute;
            top: 115px;
            right: 55px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            opacity: 0;
            transition: opacity 1s;
            z-index: 50;
        }

        /* منطقة النصوص */
        #splash-text-area {
            position: relative;
            text-align: center;
            z-index: 100;
            min-height: 100px;
            width: 100%;
            overflow: hidden;
            direction: ltr;
        }

        /* حاويات النصوص (للحركة الأفقية) */
        .splash-title-wrapper {
            display: block;
            opacity: 0;
            position: relative;
        }

        /* كلاسات الحركة الأفقية */
        .splash-slide-from-left {
            animation: splashSlideHorizontalLeft 5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        .splash-slide-from-right {
            animation: splashSlideHorizontalRight 5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }

        /* تعريف الحركات الأفقية */
        @keyframes splashSlideHorizontalLeft {
            from { opacity: 0; transform: translateX(-100vw); }
            to   { opacity: 1; transform: translateX(0); }
        }
        @keyframes splashSlideHorizontalRight {
            from { opacity: 0; transform: translateX(100vw); }
            to   { opacity: 1; transform: translateX(0); }
        }

        /* تنسيق الحروف (للحركة الرأسية - موجة البحر) */
        .splash-letter {
            display: inline-block;
            position: relative;
            transform: translateY(0);
        }

        /* تعريف حركة موجة البحر الرأسية */
        @keyframes splashSeaWaveVertical {
            0%   { transform: translateY(0); }
            20%  { transform: translateY(-20px); }
            40%  { transform: translateY(15px); }
            60%  { transform: translateY(-10px); }
            80%  { transform: translateY(5px); }
            100% { transform: translateY(0); }
        }

        .splash-main-title {
            font-family: 'Cinzel', serif;
            font-size: 52px;
            color: #fff;
            letter-spacing: 3px;
            margin: 0;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .splash-sub-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 15px;
            color: #fff;
            letter-spacing: 4px;
            margin-top: 10px;
            text-transform: uppercase;
            font-weight: 600;
            white-space: nowrap;
        }

        #splash-text-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
        }

        /* ENTER button (legacy id kept in JS fallback) */
        #enter-btn,
        #splash-enter-btn {
            margin: 30px auto 0;
            padding: 12px 50px;
            background-color: #000;
            color: #fff;
            border: none;
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: opacity 0.8s ease, transform 0.8s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 2px;
            border-radius: 4px;
            min-width: 180px;
            font-size: 16px;
            font-weight: 600;
        }
        
        #splash-enter-btn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        #splash-enter-btn:hover {
            background-color: #333;
            transform: translateY(-2px) scale(1.05);
        }

        /* LOGIN PAGE IMPROVED STYLES */
        #login-page {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%) !important;
            z-index: 9998 !important;
            min-height: 100vh !important;
        }

        /* Centered login card */
        #login-page > div {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: calc(100% - 32px) !important;
            max-width: 500px !important;
            background: #ffffff !important;
            border-radius: 12px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            padding: 40px !important;
            z-index: 9999 !important;
        }

    </style>
</head>
<body class="bg-gray-100">
    
    <style>
        /* Targets table grid: soft horizontal lines + clear vertical separators */
        .targets-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .targets-table th, .targets-table td { padding: 6px 8px; font-size: 12px; text-align: center; }
        .targets-table tbody td { border-bottom: 1px solid rgba(17,24,39,0.06); }
        .targets-table td + td, .targets-table th + th { border-left: 2px solid rgba(59,130,246,0.25); }
        .targets-col-day { background:#e8f2ff; color:#0b1b34; }
        .targets-col-total { background:#ffe4e6; color:#0b1b34; font-weight:700; }
        /* Customer targets visual style (approximate to provided Excel screenshot) */
        .customer-targets-table { border-collapse: separate; border-spacing:0; width:100%; font-size:12px; }
        .customer-targets-table th { padding:6px 6px; font-weight:700; color:#fff; text-align:center; }
        .cth-name { background:#2f2f34; }
        .cth-multi-target, .cth-dairy-target { background:#b66a00; }
        .cth-multi-ach, .cth-dairy-ach { background:#0f2d64; }
        .cth-total-target { background:#004d40; }
        .cth-total-ach { background:#003366; }
        .cth-rem, .cth-rem-total { background:#5a3d00; }
        .cth-pct, .cth-pct-total { background:#2c3e50; }
        .customer-targets-table tbody tr:nth-child(even) td { background:#f9fafb; }
        .customer-targets-table tbody tr:nth-child(odd) td { background:#fff; }
        .customer-targets-table td { padding:5px 6px; text-align:center; border-bottom:1px solid #e5e7eb; }
        .customer-targets-table td.name { text-align:right; font-weight:600; }
        .customer-targets-table input.cust-target-input { background:#fff; font-size:11px; }
        .customer-targets-table .ach-cell { font-weight:600; color:#0d47a1; }
        .customer-targets-table .rem-pos { color:#b45309; font-weight:600; }
        .customer-targets-table .rem-zero { color:#059669; font-weight:600; }
        .customer-targets-table .pct-ok { color:#047857; font-weight:600; }
        .customer-targets-table .pct-low { color:#374151; font-weight:600; }
        .ghost-zero::before { content:'0'; opacity:0.35; }
    </style>
    <style>
        /* Stock Control V2 Styles */
        .section-view-v2 { display: none; animation: fadeIn 0.3s ease-out; }
        .section-view-v2.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-item-v2 { cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solbacid transparent; color: #64748b; font-weight: 600; font-size: 13px; }
        .nav-item-v2:hover { background-color: #f1f5f9; }
        .nav-item-v2:nth-child(1).active { color: #fff; font-weight: 700; background: linear-gradient(135deg, #06b6d4, #0e7490);; border-bottom: 3px solid #fff; }
        .nav-item-v2:nth-child(2).active { color: #fff; font-weight: 700; background: linear-gradient(135deg, #10b981, #059669); border-bottom: 3px solid #fff; }
        .nav-item-v2:nth-child(3).active { color: #fff; font-weight: 700; background: linear-gradient(135deg, #a855f7, #9333ea); border-bottom: 3px solid #fff; }
        .nav-item-v2:nth-child(4).active { color: #fff; font-weight: 700; background: linear-gradient(135deg, #f97316, #ea580c); border-bottom: 3px solid #fff; }
        
        /* Larger fonts for Stock Control V2 for better readability */
        #page-stock-control-v2 { font-size: 16px; }
        #page-stock-control-v2 table tbody td { font-size: 14px; font-weight: 600; }
        #page-stock-control-v2 table tbody td:nth-child(1) { font-size: 15px; font-weight: 700; }
        #page-stock-control-v2 table tbody td:nth-child(2), #page-stock-control-v2 table tbody td:nth-child(3) { font-size: 17px; font-weight: 700; color: #1f2937; }
        #stockBody-v2 td { font-size: 15px; font-weight: 600; }
        #logsBody-v2 td { font-size: 13px; }

        .badge { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .badge.online { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge.offline { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    </style>
    <style>
        /* Hide accidental visible code blocks that may appear at top of page */
        body > pre, body > code, .top-debug-text { display: none !important; }
    </style>
    <!-- Removed duplicate global quick-search; using page-local panel inside #page-sales -->
    

    <!-- UI Navigation & Authentication Handler -->
    

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div id="splash-logo-wrapper">
            <div id="splash-container"></div>
            <div class="splash-trademark">®</div>
        </div>

        <div id="splash-text-area">
            <div class="splash-title-wrapper" id="wrapper1">
                <h1 class="splash-main-title" id="title1"></h1>
            </div>
            <div class="splash-title-wrapper" id="wrapper2">
                <p class="splash-sub-title" id="title2"></p>
            </div>
            <button id="splash-enter-btn" style="opacity: 0; pointer-events: none;">ENTER</button>
        </div>
    </div>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="min-h-screen bg-gradient-to-br from-blue-900 to-blue-950 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">مرحباً</h1>
                <p class="text-gray-600 mt-2">نظام إدارة المبيعات</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل بريدك الإلكتروني" required>
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10" placeholder="أدخل كلمة المرور" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password" title="إظهار/إخفاء">
                            👁️
                        </button>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="login-remember" class="h-4 w-4 text-blue-600 rounded">
                    <label for="login-remember" class="mr-2 text-sm text-gray-600">تذكرني</label>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">دخول</button>

                <div class="text-center text-sm text-gray-600">
                    <p>لا تملك حساب؟ <button type="button" id="go-to-register-btn" class="text-blue-600 hover:underline font-semibold">إنشاء حساب جديد</button></p>
                </div>
            </form>

            <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                <p><strong>للاختبار السريع:</strong></p>
                <p>البريد: test@example.com</p>
                <p>كلمة المرور: test123</p>
            </div>
        </div>
    </div>

    <!-- REGISTER PAGE - DISABLED (يتم الدخول فقط يدويًا) -->
    <!-- <div id="register-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4 hidden">
        ... form removed ...
    </div> -->

    <div id="app-container" class="mx-auto bg-white shadow-lg min-h-screen" style="display:none;">
        
        <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 no-print flex justify-between items-center">
            <div class="flex items-center">
                <img id="company-logo-img" src="" alt="شعار" style="height:40px;display:none;margin-left:10px;border-radius:6px;background:white;padding:2px;" />
                <h1 id="header-title" class="text-xl font-bold">لوحة المعلومات</h1>
            </div>
            <!-- الساعة الرقمية في منتصف الهيدر -->
            <div class="flex-1 flex justify-center">
                <div id="digital-clock" class="text-2xl font-mono font-bold text-white tracking-widest" style="letter-spacing:0.1em;">00:00:00</div>
            </div>
            <div class="flex items-center gap-4">
                <!-- GPS quick toggle for reps (no need to open settings) -->
                <button id="gps-toggle-btn" class="px-2 py-1 rounded text-xs font-semibold bg-red-500 text-white hover:bg-red-600" title="تشغيل/إيقاف مشاركة الموقع">GPS OFF</button>
                <!-- Admin-only: open interactive map modal for all reps -->
                <button id="open-map-btn" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-xs font-semibold flex items-center gap-1" title="عرض خريطة المناديب">
                    <span>الخريطة</span>
                </button>
                <span id="reviewer-badge" class="hidden bg-amber-500 text-white px-2 py-1 rounded text-xs font-semibold" title="وضع المراجعة (قراءة فقط)">وضع المراجعة</span>
                <span id="current-user-display" class="text-white text-sm"></span>
                <!-- Cloud sync UI removed: using Local Storage for stock/costing -->
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">تسجيل الخروج</button>
            </div>
        </header>

        <main class="p-4">
            <!-- Admin Map Modal -->
            <div id="reps-map-modal" class="hidden fixed inset-0 z-40 bg-black bg-opacity-50 items-center justify-center" style="display:none;">
                <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                        <h3 class="font-bold text-gray-800">خريطة المناديب</h3>
                        <button id="close-map-btn" class="text-gray-600 hover:text-black">إغلاق</button>
                    </div>
                    <div class="p-0">
                        <div id="reps-map" style="height:70vh; width:100%;"></div>
                    </div>
                </div>
            </div>
            <div id="page-dashboard" class="page active">
                <div class="mb-4 grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div>
                        <label for="dashboard-rep-filter" class="block text-sm font-medium text-gray-700">عرض إحصائيات المندوب:</label>
                        <select id="dashboard-rep-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-green-800 font-semibold">إجمالي المبيعات (الشهر)</h3>
                        <p id="total-sales" class="text-2xl font-bold text-green-900 mt-1">0 ج.م</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-blue-800 font-semibold">المبالغ المحصلة</h3>
                        <p id="total-collected" class="text-2xl font-bold text-blue-900 mt-1">0 ج.م</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-orange-800 font-semibold">المبالغ المستحقة</h3>
                        <p id="total-due" class="text-2xl font-bold text-orange-900 mt-1">0 ج.م</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-purple-800 font-semibold">عدد الفواتير</h3>
                        <p id="sales-count" class="text-2xl font-bold text-purple-900 mt-1">0</p>
                    </div>
                </div>

                <!-- Target Progress -->
                <div class="mb-6">
                    <h3 id="target-title" class="font-bold text-gray-800 mb-2">الهدف الشهري:</h3>
                    <h4 id="target-amount-display" class="text-blue-600 font-bold text-lg mb-2"></h4>
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="target-progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill text-xs text-white text-center" style="width: 0%;">
                            <span id="target-progress-text">0%</span>
                        </div>
                    </div>
                </div>

                <!-- CHART / GRAPHS SECTION (Kept charts in Dashboard for dual purpose) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <!-- Daily Sales Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">المبيعات اليومية للشهر الحالي</h3>
                        <div class="h-64">
                            <canvas id="sales-7-days-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Reps Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">أفضل المناديب (مبيعات)</h3>
                        <div class="h-64">
                            <canvas id="top-reps-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Products (Quantity/Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">أفضل المنتجات (كمية)</h3>
                         <div class="h-64">
                            <canvas id="top-products-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top Customers (Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">أفضل العملاء (قيمة)</h3>
                         <div class="h-64">
                            <canvas id="top-customers-chart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- END CHART / GRAPHS SECTION -->
                
                <!-- The Reports button is no longer needed in the Dashboard -->
                <div class="mb-6 hidden">
                    <button id="view-reports-btn" class="w-full bg-blue-700 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-blue-800 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        <span>عرض التقارير والرسوم البيانية</span>
                    </button>
                </div>
                
                <div class="mb-6">
                    <button id="manual-statement-btn" class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-gray-700 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="file-text"></i>
                        <span>كشف حساب يدوي</span>
                    </button>
                </div>

                

                <div>
                    <h3 class="font-bold text-gray-800 mb-3">أحدث عمليات البيع</h3>
                    <div id="recent-sales-list" class="space-y-3">
                        <p class="text-gray-500 text-center">لا توجد عمليات بيع بعد.</p>
                    </div>
                </div>
            </div>

            <div id="page-sales" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="receipt" class="w-6 h-6 text-blue-600"></i>
                        <span>جميع المبيعات</span>
                    </h2>
                    <!-- سهم التمرير السريع للأسفل -->
                    <button id="scroll-to-bottom-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center gap-1 transition" title="انزل لآخر الفواتير">
                        <i data-lucide="arrow-down" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <button id="sales-quick-print-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة حرارية (صورة)">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                            <span>طباعة حرارية</span>
                        </button>
                        <button id="sales-bt-print-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة بلوتوث (تجريبية)">
                            <i data-lucide="bluetooth" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">بلوتوث</span>
                        </button>
                        <button id="sales-bt-test-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="اختبار بلوتوث بسيط">
                            <i data-lucide="zap" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">اختبار</span>
                        </button>
                        <button id="sales-html-print-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة عادية">
                            <i data-lucide="file" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">طباعة عادية</span>
                        </button>
                    </div>
                    <!-- FAB is used for adding sales now -->
                </div>
                <!-- Sales filters bar (restored) -->
                <div id="sales-filters-bar" class="flex flex-col sm:flex-row gap-2 mb-4" style="position:sticky; top:72px; z-index:20; background:#ffffff; padding:8px 0;">
                    <input id="search-sales-text" type="text" placeholder="ابحث باسم العميل أو رقم الفاتورة أو الإجمالي..." class="w-full p-2 border rounded-md">
                    <div class="flex items-center w-full sm:w-auto relative">
                        <input id="search-sales-date" type="date" class="w-full p-2 border border-gray-300 rounded-md appearance-none">
                        <button id="clear-sales-date-btn" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-600 hidden font-bold text-xl leading-none p-1">&times;</button>
                    </div>
                    <input type="month" id="sales-month-selector" class="w-full sm:w-auto p-2 border rounded-md">
                    <select id="tax-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">فلترة بحالة الرفع</option>
                        <option value="filed">تم الرفع</option>
                        <option value="not-filed">لم يتم الرفع</option>
                    </select>
                    <select id="review-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">كل الفواتير</option>
                        <option value="pending">قيد المراجعة فقط</option>
                        <option value="reviewed">المعتمدة فقط</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div id="daily-total-container" class="bg-blue-100 border-r-4 border-blue-500 p-3 rounded-lg text-center hidden shadow-md">
                        <span class="font-semibold">إجمالي مبيعات اليوم المحدد:</span>
                        <span id="daily-total-amount" class="font-bold text-blue-800">0 ج.م</span>
                    </div>
                    <!-- Right column: filtered total only (quick-search moved to side drawer) -->
                    <div style="display:flex;gap:12px;align-items:flex-start;">
                        <div id="filtered-total-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg text-center shadow-md" style="flex:1;">
                            <div>
                                <span class="font-semibold">إجمالي الفواتير المعروضة:</span>
                                <span id="filtered-total-amount" class="font-bold text-green-800">0 ج.م</span>
                            </div>
                            <div class="mt-1 text-sm text-green-900">
                                <span class="font-semibold">عدد الفواتير:</span>
                                <span id="filtered-total-count" class="font-bold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Left slide-in drawer for Invoice Quick Search -->
                <div id="invoice-quick-search-wrap" class="fixed z-40 left-0" style="top:120px;width:220px;">
                    <div id="invoice-quick-search-content" class="relative transition-transform duration-200 ease-out">
                        <div id="invoice-quick-search-panel" class="bg-white p-2 rounded-r-lg shadow-lg border border-gray-200" style="width:220px;">
                            <div style="display:flex;flex-direction:column;gap:6px;align-items:stretch;">
                                <div style="background:#111027;color:#fff;padding:6px 8px;border-radius:4px;text-align:center;font-weight:700;">Number<br><div id="invoice-val-number" style="font-size:14px;margin-top:4px;">--</div></div>
                                <div style="background:#f6d8bf;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Total<br><div id="invoice-val-total" style="font-weight:700;">--</div></div>
                                <div style="background:#f4cfa9;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Return<br><div id="invoice-val-return">--</div></div>
                                <div style="background:#eee2d6;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Net amount<br><div id="invoice-val-net">--</div></div>
                                <div style="background:#e6f3e9;color:#0b6b2d;padding:6px 6px;border-radius:4px;text-align:center;">C - Name<br><div id="invoice-val-cname">--</div></div>
                                <div style="background:#2b2b2b;color:#fff;padding:6px 6px;border-radius:4px;text-align:center;">Date<br><div id="invoice-val-date" style="font-size:14px;margin-top:4px;" dir="ltr" lang="ar">--</div></div>
                                <div style="text-align:center;margin-top:6px;">
                                    <input id="invoice-search-input" type="text" inputmode="numeric" placeholder="رقم" class="w-full p-1 border rounded-md text-center text-sm" />
                                </div>
                                <div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">
                                    <button id="invoice-search-btn" class="bg-blue-600 text-white px-2 py-1 rounded-md text-sm">بحث</button>
                                    <button id="invoice-clear-btn" class="bg-gray-200 text-gray-700 px-2 py-1 rounded-md text-sm">مسح</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Lens handle (outside the sliding content so it remains visible) -->
                    <button id="invoice-quick-search-toggle" class="fixed left-0 bg-white border border-gray-300 rounded-full w-9 h-9 shadow flex items-center justify-center z-50" style="top:220px" title="بحث">
                        <i data-lucide="search" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>

                <!-- Hidden thermal print root -->
                <div id="thermal-print-root" style="display:none"></div>
                <div id="sales-list" class="space-y-3"></div>
            </div>
            <!-- تمت إزالة شريط التصدير الضريبي حسب الطلب -->

            <!-- Inquiry / استعلام عن مبيعات العملاء (فترة محددة + عملاء متعددين) -->
            <div id="page-inquiry" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="search" class="w-6 h-6 text-blue-600"></i>
                        <span>استعلام عن مبيعات العملاء</span>
                    </h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4 text-sm items-start">
                    <div>
                        <label class="block font-semibold mb-1">من تاريخ</label>
                        <input id="inq-date-from" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">إلى تاريخ</label>
                        <input id="inq-date-to" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">بحث عن عميل</label>
                        <input id="inq-customer-filter" type="text" placeholder="اكتب جزء من الاسم" class="w-full p-2 border rounded" />
                        <p class="text-[11px] text-gray-500 mt-1">استخدم Ctrl أو Shift للاختيار المتعدد في القائمة.</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">العملاء المختارون</label>
                        <select id="inq-customers" multiple size="8" class="w-full p-2 border rounded"></select>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button id="inq-generate-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2 text-sm"><i data-lucide="play"></i> تنفيذ الاستعلام</button>
                    <button id="inq-print-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 flex items-center gap-2 text-sm"><i data-lucide="printer"></i> طباعة</button>
                    <button id="inq-image-btn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2 text-sm"><i data-lucide="image"></i> صورة</button>
                </div>
                <div id="inq-summary" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 text-sm"></div>
                <div id="inq-report-wrapper" class="bg-white rounded-lg shadow p-3 overflow-auto">
                    <table id="inq-report-table" class="w-full text-xs border-collapse" style="direction:rtl;min-width:820px;">
                        <thead id="inq-report-head"></thead>
                        <tbody id="inq-report-body"></tbody>
                    </table>
                    <div class="mt-6" id="inq-customers-breakdown"></div>
                </div>
            </div>

            <!-- Price Lists / قوائم الأسعار: صفحة مخصصة لعرض قائمة واحدة حسب الاختيار -->
            <div id="page-price-lists" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="badge-dollar-sign" class="w-6 h-6 text-amber-600"></i>
                        <span>قوائم الأسعار</span>
                    </h2>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-3">
                    <div class="pl-controls grid grid-cols-1 md:grid-cols-7 gap-3 mb-4 text-sm items-end">
                        <div>
                            <label class="label block mb-1">طريقة الاختيار</label>
                            <select id="pl-filter-mode" class="w-full p-2 border rounded">
                                <option value="customer">حسب العميل</option>
                                <option value="priceList">حسب القائمة</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="label block mb-1">اختر العميل/القائمة</label>
                            <select id="pl-selector" class="w-full p-2 border rounded"></select>
                        </div>
                        <div>
                            <label class="label block mb-1">خصم % للقائمة</label>
                            <input id="pl-global-discount" type="number" min="0" max="100" step="0.01" value="0" class="w-full p-2 border rounded" />
                        </div>
                        <div class="flex items-end gap-2">
                            <button id="pl-print" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">طباعة</button>
                            <button id="pl-image" class="bg-indigo-600 text-white px-3 py-2 rounded text-sm">صورة</button>
                        </div>
                    </div>

                    <div class="sheet-header">
                        <div class="sheet-meta">
                            <span id="pl-date"></span>
                        </div>
                        <div class="sheet-title">قائمة أسعار المحلات</div>
                        <div class="sheet-meta">
                            <span id="pl-customer-name"></span>
                        </div>
                    </div>

                    <div id="pl-sheet-container" class="overflow-auto"></div>

                    <!-- قديمة: عرض جميع القوائم (لم يعد يستخدم، أبقيته للرجوع عند الحاجة) -->
                    <div id="all-price-lists-container" class="grid md:grid-cols-2 gap-4" style="display:none"></div>
                </div>
            </div>

            

            
            
            
            <div id="page-dispatch" class="page">
                <!-- Local tabs inside dispatch page -->
                <div class="mb-4 flex gap-2 no-print" style="display:flex;gap:8px;margin-bottom:16px;">
                    <button id="dispatch-notes-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#3b82f6;color:white;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">الأذونات</button>
                    <button id="receipt-local-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#d1d5db;color:#374151;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">كشف التحصيل</button>
                </div>

                <!-- Tab content: الأذونات -->
                <div id="dispatch-notes-tab-content" class="dispatch-local-tab-content" style="display:block;">
                <div id="new-dispatch-note-section" class="bg-gray-100 p-4 rounded-lg border mb-6">
                    <h3 class="text-lg font-bold mb-3">إضافة إذن استلام جديد</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="new-dispatch-note-number" class="block text-sm font-medium text-gray-700">رقم الإذن (يدوي)</label>
                            <input type="number" id="new-dispatch-note-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="new-dispatch-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                            <select id="new-dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="new-dispatch-date" class="block text-sm font-medium text-gray-700">تاريخ الإذن</label>
                            <input type="date" id="new-dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>

                    <div class="overflow-x-auto bg-white rounded-lg shadow mt-4 border">
                        <table id="new-dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">المنتج</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مستلم (كمية)</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع سليم</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع تالف</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مجاني</th>
                                    <th class="px-2 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="new-dispatch-items-container" class="divide-y divide-gray-200">
                                <!-- New item rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                         <button type="button" id="add-new-dispatch-item-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            إضافة صنف
                        </button>
                        <button type="button" id="save-new-dispatch-note-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            حفظ الإذن الجديد
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <hr class="my-6 border-t-2 border-dashed">

                <!-- Existing Dispatch Notes List -->
                <h3 class="text-lg font-bold mb-3">الأذونات السابقة</h3>
                <div id="dispatch-notes-list" class="space-y-4"></div>
                <!-- ملخص أصناف المندوب (عرض فقط) -->
                <div id="rep-dispatch-summary" class="hidden mt-8 bg-white border rounded-lg p-4">
                    <h4 class="font-bold mb-3 flex items-center gap-2 text-indigo-700"><i data-lucide="clipboard-list" class="w-5 h-5"></i> ملخص البضاعة الحالية</h4>
                    <div id="rep-dispatch-summary-content" class="text-sm"></div>
                </div>
                </div> <!-- end dispatch-notes-tab-content -->

                <!-- Tab content: كشف التحصيل -->
                <div id="receipt-local-tab-content" class="dispatch-local-tab-content" style="display:none;">
                    <h2 class="text-xl font-bold mb-4">كشف التحصيل</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Left: Receipt List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-4 rounded shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">من تاريخ:</label>
                                        <input type="date" id="receipt-from-date-local" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">إلى تاريخ:</label>
                                        <input type="date" id="receipt-to-date-local" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2"></label>
                                        <button id="receipt-filter-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">تطبيق الفلاتر</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto bg-white rounded-lg shadow">
                                    <table class="w-full border-collapse border border-gray-300">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="border p-2 text-right">التاريخ</th>
                                                <th class="border p-2 text-right">رقم الفاتورة</th>
                                                <th class="border p-2 text-right">العميل</th>
                                                <th class="border p-2 text-right">نوع التحصيل</th>
                                                <th class="border p-2 text-right">المبلغ</th>
                                                <th class="border p-2 text-right">الحالة</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receipt-table-body-local" class="text-sm"></tbody>
                                    </table>
                                </div>
                                <div class="mt-4 p-4 bg-gray-50 rounded border">
                                    <div class="grid grid-cols-3 gap-4 text-lg font-bold">
                                        <div>الإجمالي: <span id="receipt-total-local" class="text-green-600">0</span></div>
                                        <div>العدد: <span id="receipt-count-local" class="text-blue-600">0</span></div>
                                        <div>المتوسط: <span id="receipt-avg-local" class="text-purple-600">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Rep Receipt Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-4 rounded shadow-md sticky top-20">
                                <h3 class="text-lg font-bold mb-4 text-right">النسريات والمصروفات</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">اختر المندوب:</label>
                                    <select id="receipt-rep-dropdown-local" class="w-full p-2 border rounded text-right">
                                        <option value="">-- اختر المندوب --</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">النثريات:</label>
                                    <input type="number" id="rep-credit-transactions-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                    <input type="text" id="rep-credits-reason-local" placeholder="السبب (كارتة اكرامية، إلخ...)" class="w-full p-2 border rounded text-right mt-1 text-xs bg-blue-50">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">المصروفات:</label>
                                    <input type="number" id="rep-expenses-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                    <input type="text" id="rep-expenses-reason-local" placeholder="السبب (تاكسي، طعام، إلخ...)" class="w-full p-2 border rounded text-right mt-1 text-xs bg-red-50">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">ملاحظات:</label>
                                    <textarea id="rep-notes-local" class="w-full p-2 border rounded text-right" rows="4" placeholder="ملاحظات إضافية..."></textarea>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button id="receipt-print-btn-local" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold">طباعة كشف التحصيل</button>
                                    <button id="receipt-save-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">حفظ البيانات</button>
                                    <button id="settlement-btn-local" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">تسوية آجلة للعملاء</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- end receipt-local-tab-content -->
            </div>
            
            <!-- Settlement Modal (تسوية آجلة) -->
            <div id="settlement-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h2 class="text-2xl font-bold text-purple-700">تسوية آجلة للعملاء</h2>
                            <button onclick="closeSettlementModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                        </div>
                        
                        <!-- Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-gray-50 rounded">
                            <div>
                                <label class="block text-sm font-medium mb-2">من تاريخ:</label>
                                <input type="date" id="settlement-from-date" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">إلى تاريخ:</label>
                                <input type="date" id="settlement-to-date" class="w-full p-2 border rounded">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-2">أو حدد أرقام الفواتير (اكتب الأرقام واضغط فاصلة بين كل رقم):</label>
                                <input type="text" id="settlement-invoice-numbers" placeholder="اكتب الأرقام هكذا: 1001 ثم فاصلة ثم 1002 ثم فاصلة" class="w-full p-2 border rounded text-right">
                                <p class="text-xs text-gray-500 mt-1">مثال صحيح: 1001,1002,1003 أو 1001, 1002, 1003</p>
                            </div>
                            <div class="md:col-span-2 flex gap-2">
                                <button onclick="generateSettlement()" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 font-semibold">عرض التسوية</button>
                                <button onclick="printSettlement()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">طباعة</button>
                                <button onclick="markSettled()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">تسديد وإلغاء المديونية</button>
                            </div>
                        </div>
                        
                        <!-- Results Table -->
                        <div id="settlement-results" class="mt-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- RE-ACTIVATED REPORTS PAGE -->
            <div id="page-reports" class="page" style="padding-bottom: 50px;">
                <h2 class="text-xl font-bold mb-4 no-print">التقارير التفصيلية</h2>
                
                <div id="report-filter-container" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                    <!-- Daily Report Content -->
                    <div data-report-content="daily" class="space-y-4 active">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير المبيعات اليومي</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="daily-report-date" class="block text-sm font-medium text-gray-700">التاريخ:</label>
                                <input type="date" id="daily-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="daily-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                                <select id="daily-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="daily-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="daily-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <button id="generate-daily-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض التقرير اليومي</button>
                    </div>

                    <!-- Date Range Report Content (Hidden by default) -->
                    <div data-report-content="range" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير مبيعات فترة زمنية</h3>
                         <!-- Reuse date range form logic but simplified -->
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="range-start-date" class="block text-sm font-medium text-gray-700">من تاريخ:</label>
                                <input type="date" id="range-start-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-end-date" class="block text-sm font-medium text-gray-700">إلى تاريخ:</label>
                                <input type="date" id="range-end-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="range-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <div>
                             <label for="range-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                             <select id="range-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <button id="generate-range-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض تقرير الفترة</button>
                    </div>

                    <!-- Monthly Report Content (Hidden by default) -->
                    <div data-report-content="monthly" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">ملخص المبيعات الشهري</h3>
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="monthly-report-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
                                <input type="month" id="monthly-report-month" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="monthly-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                                <select id="monthly-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="monthly-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="monthly-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <button id="generate-monthly-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض التقرير الشهري</button>
                    </div>

                    <!-- Reconciliation Report Content (Hidden by default) -->
                    <div data-report-content="reconciliation" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير التسوية (العجز والزيادة)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="recon-report-date" class="block text-sm font-medium text-gray-700">تاريخ إذن الاستلام:</label>
                                <input type="date" id="recon-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="recon-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                                <select id="recon-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="recon-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="recon-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <button id="generate-recon-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">إنشاء تقرير التسوية</button>
                    </div>

                    <!-- Stocktake (Shortage/Surplus) Report Content -->
                    <div data-report-content="stocktake" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">ملخص الجرد (عجز / زيادة)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="stocktake-start-date" class="block text-sm font-medium text-gray-700">من تاريخ:</label>
                                <input type="date" id="stocktake-start-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="stocktake-end-date" class="block text-sm font-medium text-gray-700">إلى تاريخ:</label>
                                <input type="date" id="stocktake-end-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                        </div>
                        <button id="generate-stocktake-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض ملخص الجرد</button>
                        <p class="text-xs text-gray-600">يعرض جميع فروقات الجرد (عجز/زيادة) المعتمدة خلال الفترة المحددة. يتم التحديث تلقائياً بعد اعتماد الجرد.</p>
                    </div>

                    <div data-report-content="targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير تحقيق التارجت الشهري لكل مندوب</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="targets-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
                                <input type="month" id="targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="targets-rep-filter" class="block text-sm font-medium text-gray-700">بحث مندوب (اختياري):</label>
                                <select id="targets-rep-filter" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="all">عرض كل المناديب</option>
                                </select>
                            </div>
                            <div>
                                <label for="targets-chain-filter" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="targets-chain-filter" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <button id="generate-targets-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض تقرير التارجت</button>
                        <p class="text-xs text-gray-600">يعرض الجدول صافي المبيعات اليومية لكل مندوب، ومقارنة الشهر بالتارجت مع النسبة المفترضة حتى تاريخ اليوم والنسبة المحققة الفعلية.</p>
                    </div>

                    <div data-report-content="customer-targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تارجت العملاء (اكسبشن / سفير / الضحى)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="customer-targets-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
                                <input type="month" id="customer-targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="customer-targets-category" class="block text-sm font-medium text-gray-700">الفئة:</label>
                                <select id="customer-targets-category" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="multi">مالتي</option>
                                    <option value="dairy">البان</option>
                                    <option value="both" selected>الاثنين معاً</option>
                                </select>
                            </div>
                        </div>
                        <button id="generate-customer-targets-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold mb-4">عرض تقرير التارجت</button>
                        <div class="flex gap-3">
                            <button id="save-customer-targets-btn" type="button" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">حفظ التارجت</button>
                            <button id="refresh-customer-targets-btn" type="button" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">تحديث التقرير</button>
                        </div>
                        <p class="text-xs text-gray-600">عدل قيم التارجت في الخلايا ثم اضغط حفظ. التقرير يحسب المحقق والمتبقي ونسبة الإنجاز لكل عميل حسب الفئة المختارة.</p>
                        <div id="customer-targets-report-output" class="mt-2"></div>
                    </div>

                </div>

                <div id="report-output-area" class="mt-6">
                    <p class="text-center text-gray-500 mt-8">اختر نوع التقرير واضغط "عرض" للبدء.</p>
                </div>
            </div>
            <!-- END RE-ACTIVATED REPORTS PAGE -->


            <!-- ########## PROMOTIONS PAGE ########## -->
            <div id="page-promotions" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">العروض الترويجية</h2>
                    <div class="flex items-center gap-2">
                        <!-- Notify dropdown (اخطار) -->
                        <div class="relative" id="promotions-notify-root">
                            <button id="promotions-notify-btn" class="bg-white border px-3 py-1 rounded-md text-sm flex items-center gap-2" aria-haspopup="true" aria-expanded="false">
                                <span class="text-sm font-semibold">اخطار</span>
                                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
                            </button>
                            <div id="promotions-notify-menu" class="hidden absolute right-0 mt-2 w-52 bg-white border rounded shadow-lg z-50">
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="prices">اخطار باسعار اصناف</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="new-item">اخطار بصنف جديد</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="promotions">اخطار بعروض</button>
                            </div>
                        </div>

                        <button id="add-promotion-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 flex items-center gap-2">
                            <i data-lucide="percent"></i>
                            <span>إضافة عرض جديد</span>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <button id="promotions-view-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm">العروض</button>
                    <button id="notifications-view-btn" class="px-3 py-1 bg-white text-gray-700 rounded-md text-sm border">الاخطارات</button>
                </div>

                <!-- Batch Promotions Editor (Create many rows exactly like screenshot) -->
                <div class="bg-white border rounded-md p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <label class="text-sm">العميل</label>
                            <select id="batch-promo-customer" class="p-2 border rounded-md min-w-[220px]"></select>
                            <label class="text-sm">من</label>
                            <input id="batch-promo-from" type="date" class="p-2 border rounded-md">
                            <label class="text-sm">إلى</label>
                            <input id="batch-promo-to" type="date" class="p-2 border rounded-md">
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="batch-promo-add-row" class="px-3 py-1 bg-amber-600 text-white rounded-md text-sm">إضافة صف</button>
                            <button id="batch-promo-save" class="px-3 py-1 bg-green-600 text-white rounded-md text-sm">حفظ العروض</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full" id="batch-promo-table" style="border-collapse:separate;border-spacing:0 6px;">
                            <thead>
                                <tr>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Price</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">To</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">From</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Item Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Code</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Customer Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">حذف</th>
                                </tr>
                            </thead>
                            <tbody id="batch-promo-rows"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">أدخل كود الصنف والسعر؛ سيتم تطبيق العرض تلقائياً على الفترة المحددة ثم يعود السعر الطبيعي بعد انتهائها.</p>
                </div>

                <div id="promotions-list" class="space-y-3">
                    <p class="text-gray-500 text-center mt-8">لا توجد عروض مسجلة حالياً.</p>
                </div>

                <div id="notifications-list" class="space-y-3 hidden">
                    <p class="text-gray-500 text-center mt-8">لا توجد اخطارات بعد. استخدم زر "اخطار" لإنشاء واحد.</p>
                </div>
            </div>
            <!-- ########## END PROMOTIONS PAGE ########## -->


            <div id="page-customers" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">قائمة العملاء</h2>
                    <div class="flex items-center gap-2">
                        <button id="add-chain-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg shadow hover:bg-gray-300 flex items-center gap-2 text-sm">
                            <i data-lucide="layers"></i>
                            <span>إضافة سلسلة</span>
                        </button>
                        <button id="add-customer-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                            <i data-lucide="user-plus"></i>
                            <span>إضافة عميل</span>
                        </button>
                    </div>
                </div>
                <div id="chains-display" class="mb-4"></div>
                <input id="search-customers" type="text" placeholder="ابحث عن عميل..." class="w-full p-2 border rounded-md mb-4">
                <div id="customers-list" class="space-y-3"></div>
            </div>

            <div id="page-reps" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">إدارة المناديب</h2>
                    <button id="add-rep-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="user-plus"></i>
                        <span>إضافة مندوب</span>
                    </button>
                </div>
                <div id="reps-list" class="space-y-3"></div>
            </div>

            <!-- ########## SPREADSHEET ENTRY PAGE (إدخال سريع) ########## -->
            <div id="page-spreadsheet-entry" class="page">
                <h2 class="text-lg font-bold mb-4">إدخال سريع لعمليات البيع</h2>
                <div class="bg-gray-100 p-3 rounded-lg border mb-4">
                    <!-- Modified grid layout to accommodate the new field -->
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <div>
                            <label for="spreadsheet-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                            <select id="spreadsheet-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-customer" class="block text-sm font-medium text-gray-700">العميل</label>
                            <select id="spreadsheet-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-date" class="block text-sm font-medium text-gray-700">تاريخ الفواتير</label>
                            <input type="date" id="spreadsheet-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <!-- NEW: Unified Invoice Number Field -->
                        <div>
                            <label for="unified-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة (موحد)</label>
                            <input type="number" id="unified-invoice-number" class="mt-1 block w-full p-2 border border-blue-400 bg-blue-50 rounded-md font-bold" placeholder="تطبيق على كل الصفوف">
                        </div>
                        <!-- END NEW -->
                    </div>
                </div>

                <div class="overflow-x-auto shadow rounded-lg border">
                    <table id="spreadsheet-entry-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">رقم الفاتورة</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">الكود</th> <!-- NEW CODE COLUMN -->
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 uppercase min-w-[150px]">الصنف</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">الكمية</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">السعر</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">سعر معدل</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">خصم %</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">القسم</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[100px]">التحصيل</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px] spreadsheet-tax-header" style="display: none;">المنظومة</th> <!-- NEW TAX FILING COLUMN -->
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[80px]">الإجمالي</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase"></th> <!-- Delete button -->
                            </tr>
                        </thead>
                        <tbody id="spreadsheet-entry-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be added by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-between items-center flex-wrap gap-3">
                    <button id="spreadsheet-add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-1 text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>إضافة صف جديد</span>
                    </button>
                    <button id="spreadsheet-save-all-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold flex items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span>حفظ كل المدخلات</span>
                    </button>
                </div>

            </div>
             <!-- ########## END SPREADSHEET ENTRY PAGE ########## -->
            
            <!-- ########## DEBTS PAGE (المديونيات) ########## -->
            <div id="page-debts" class="page">
                <!-- Debts Tab Only (Collection Receipt removed) -->
                <div class="mb-4 flex gap-2 no-print" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button id="debts-tab-btn" class="debts-tab-button active" style="padding: 8px 16px; background-color: #3b82f6; color: white; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; border: none;">المديونيات</button>
                </div>

                <!-- Debts Tab Content -->
                <div id="debts-tab-content" class="debts-tab-content active">
                <div class="mb-4 flex flex-col items-end">
                    <h1 class="text-2xl font-bold text-right flex items-center gap-2">
                        <i data-lucide="file-warning" class="w-7 h-7 text-amber-600"></i>
                        <span>مديونيات المناديب</span>
                    </h1>
                    <p class="text-sm text-gray-600 text-right flex items-center gap-1">
                        <span>عرض وإدارة المديونيات</span>
                    </p>
                </div>

                <!-- debug banner removed -->

                <div class="debts-container mb-6">
                    <!-- Left sidebar: actions + stacked summary cards -->
                    <aside class="debts-sidebar">
                        <div class="debts-actions">
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-print-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">طباعة</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-csv-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">تحميل CSV</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-refresh-btn" title="تحديث المديونيات">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M20 4v6h-6M4 20v-6h6"/></svg>
                                <span class="ml-1">تحديث</span>
                            </button>
                        </div>

                        <!-- Debug banner removed as per user request -->

                        <div class="debt-card">
                            <div class="title">SUB TOTAL</div>
                            <div id="debts-subtotal" class="value">91,295 ج.م</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">المسدد</div>
                            <div id="debts-paid" class="value">76,336 ج.م</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">عدد الفواتير</div>
                            <div id="debts-invoices-count" class="value">14,959</div>
                        </div>

                        <div class="debt-card big">
                            <div class="title">المديونيات</div>
                            <div id="debts-total-debt" class="value">2,025 ج.م</div>
                        </div>
                    </aside>

                    <!-- Right main area: filters + table -->
                    <section class="debts-main">
                        <!-- Search Filters -->
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block mb-1 text-sm">بحث باسم العميل</label>
                                <!-- Show only customers who have invoices (either paid or due) -->
                                <select id="debt-customer-filter" class="w-full p-2 border rounded-md text-sm filter-input">
                                    <option value="">جميع العملاء</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">بحث باسم المندوب</label>
                                <select id="debt-rep-filter" class="w-full p-2 border rounded-md text-sm bg-white filter-input">
                                    <option value="">جميع المناديب</option>
                                    <option value="5/11/25">5/11/25</option>
                                    <option value="7/11/25">7/11/25</option>
                                    <option value="">ترتيب حسب المندوب</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">من تاريخ</label>
                                <input type="date" id="debt-start-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">إلى تاريخ</label>
                                <input type="date" id="debt-end-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                        </div>

                        <div class="mb-4 flex items-center gap-4">
                            <button id="apply-debts-filters-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">تطبيق الفلترة</button>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hide-paid-debts" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="text-sm font-semibold text-gray-700">عرض غير المسدد فقط</span>
                            </label>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto bg-white rounded-lg shadow-sm" style="background: #fafafa !important;">
                            <table class="min-w-full" id="debts-detail-table" style="border-collapse: collapse !important;">
                                <thead>
                                            <tr>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:right">
                                                    <span>اسم العميل</span>
                                                    <button class="column-filter-btn" data-col="customer" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>التاريخ</span>
                                                    <button class="column-filter-btn" data-col="date" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>رقم الفاتورة</span>
                                                    <button class="column-filter-btn" data-col="invoice" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>اجمالى الفاتورة</span>
                                                    <button class="column-filter-btn" data-col="total" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>المسدد</span>
                                                    <button class="column-filter-btn" data-col="paid" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>المتبقى</span>
                                                    <button class="column-filter-btn" data-col="remaining" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>المندوب</span>
                                                    <button class="column-filter-btn" data-col="rep" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                            </tr>
                                </thead>
                                <tbody id="debts-detail-body" class="divide-y divide-gray-200">
                                    <!-- سيتم إضافة الصفوف ديناميكياً -->
                                </tbody>
                            </table>
                            <div id="debts-empty-message" class="text-center text-gray-500 p-6 hidden">
                                لا توجد فواتير مطابقة للفلاتر
                            </div>
                        </div>
                    </section>
                </div>
                </div> <!-- End of debts-tab-content -->
            </div>
            <!-- ########## END DEBTS PAGE ########## -->
            
            <!-- ########## CASH PAGE (الكاش) ########## -->
            <div id="page-cash" class="page">
                <div id="cash-content-wrapper">
                        <h2 class="text-xl font-bold mb-4">الكاش - كشف التحصيل</h2>

                        <div class="mb-4 flex gap-2 items-center no-print">
                            <div class="ml-auto text-sm text-gray-600">اختر صف ثم استخدم الأزرار داخل كل صف لإجراءات المندوب</div>
                        </div>

                        <!-- Main grid: table (left) + summary (right) -->
                        <div class="cash-grid flex gap-4 items-start">
                            <div class="cash-table-area flex-1 overflow-x-auto bg-white rounded-lg shadow">
                                <table id="cash-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 text-center">#</th>
                                            <th class="p-2 text-center">التاريخ <button class="cash-column-filter-btn" data-col="date" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">رقم الفاتورة <button class="cash-column-filter-btn" data-col="invoice" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-right">اسم العميل <button class="cash-column-filter-btn" data-col="customer" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-right">المندوب <button class="cash-column-filter-btn" data-col="rep" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">إجمالي الفاتورة <button class="cash-column-filter-btn" data-col="total" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">خصم</th>
                                            <th class="p-2 text-center">الدفعة الأولى</th>
                                            <th class="p-2 text-center">الدفعة الثانية</th>
                                            <th class="p-2 text-center">إجمالي المحصل بعد الخصم</th>
                                            <th class="p-2 text-center">المتبقي <button class="cash-column-filter-btn" data-col="remaining" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">كشف التحصيل <button class="cash-column-filter-btn" data-col="collection" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">رقم كشف التحصيل</th>
                                            <th class="p-2 text-center">الخزينة</th>
                                            <th class="p-2 text-center">إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cash-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows created by renderCash() -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Cash summary panel (totals) - right column -->
                            <aside id="cash-summary-panel" class="w-60 p-2 bg-gray-50 rounded-lg shadow-sm text-right">
                                    <table style="width:100%;border-collapse:collapse;font-size:14px;">
                                        <tbody>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">إجمالي الفواتير</td>
                                                                <td id="cash-summary-total" style="padding:6px;font-weight:700;text-align:left">0 ج.م</td>
                                                            </tr>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">عدد الفواتير</td>
                                                                <td id="cash-summary-count" style="padding:6px;font-weight:600;text-align:left">0</td>
                                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">الدفعات المسددة</td>
                                                <td id="cash-summary-paid" style="padding:6px;font-weight:600;color:#047857;text-align:left">0 ج.م</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">خصم خاص</td>
                                                <td id="cash-summary-discount" style="padding:6px;font-weight:600;color:#b91c1c;text-align:left">0 ج.م</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">المتبقي</td>
                                                <td id="cash-summary-remaining" style="padding:6px;font-weight:700;text-align:left">0 ج.م</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="pt-2 no-print">
                                        <button id="cash-print-btn" class="w-full bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600">طباعة المحدد</button>
                                        <button id="cash-include-all-btn" class="w-full mt-2 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">شمل كل الفواتير في الكاش</button>
                                    </div>
                                </aside>
                        </div>
                    </div>
            </div>

            <!-- ########## END CASH PAGE ########## -->
            

            <!-- Rep Debts Page removed per user request -->
            <!-- ########## STOCK CONTROL V2 (Embedded) - DEFAULT ########## -->
            <script>
            // Prevent ReferenceError before stock-control-v2.js loads
            (function(){
                const noop = function(){ return null; };
                const placeholders = ['nav','filterProd','toggleTrans','saveTrans','updateHint','setStocktakeDate','filterStock','submitStock','setLogsDate','loadLogs','toggleModal','importFromOldSystem','saveBulkCategories','addProduct','filterByDate','updateProductPrice'];
                window.appV2 = window.appV2 || {};
                placeholders.forEach(fn => { if (typeof window.appV2[fn] !== 'function') window.appV2[fn] = noop; });
            })();
            </script>
            <div id="page-stock-control-v2" class="page" style="padding-bottom: 80px;">
                <!-- Header -->
                <header class="bg-white shadow-sm z-50 sticky top-0 border-b border-gray-100">
                    <div class="flex justify-between items-center px-4 py-3">
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-700 text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-md">
                                <i class="fas fa-cubes"></i>
                            </div>
                            <div>
                                <h1 class="font-bold text-sm leading-tight text-gray-800">إدارة المخزون</h1>
                                <div id="connectionStatus-v2" class="badge offline w-fit mt-1 text-[10px]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> جاري الاتصال...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation Tabs -->
                    <nav class="flex justify-around bg-white pt-1 shadow-sm border-t border-gray-100">
                        <button data-nav="products" id="nav-products-v2" class="nav-item-v2 active flex-1 py-4 flex flex-col items-center gap-1 hover:bg-gray-50 transition">
                            <i class="fas fa-boxes-stacked text-xl text-blue-600"></i> <span class="text-xs font-bold text-gray-700">الأصناف</span>
                        </button>
                        <button data-nav="movements" id="nav-movements-v2" class="nav-item-v2 flex-1 py-4 flex flex-col items-center gap-1 hover:bg-gray-50 transition">
                            <i class="fas fa-exchange-alt text-xl text-gray-400"></i> <span class="text-xs font-bold text-gray-700">الحركة</span>
                        </button>
                        <button data-nav="stocktake" id="nav-stocktake-v2" class="nav-item-v2 flex-1 py-4 flex flex-col items-center gap-1 hover:bg-gray-50 transition">
                            <i class="fas fa-clipboard-check text-xl text-gray-400"></i> <span class="text-xs font-bold text-gray-700">الجرد</span>
                        </button>
                        <button data-nav="reports" id="nav-reports-v2" class="nav-item-v2 flex-1 py-4 flex flex-col items-center gap-1 hover:bg-gray-50 transition">
                            <i class="fas fa-history text-xl text-gray-400"></i> <span class="text-xs font-bold text-gray-700">السجلات</span>
                        </button>
                    </nav>
                </header>

                <!-- Main Content -->
                <div class="container mx-auto p-4 pb-24 pt-20">

                    <!-- 1. Products View -->
                    <section id="view-products-v2" class="section-view-v2 active">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-4">
                                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-1">
                                    <button data-filter="all" class="filter-chip-v2 active bg-gradient-to-r from-blue-500 to-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105">الكل</button>
                                    <button data-filter="raw_material" class="filter-chip-v2 bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105">خامات</button>
                                    <button data-filter="packaging" class="filter-chip-v2 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:from-purple-600 hover:to-purple-700 transition-all transform hover:scale-105">تغليف</button>
                                    <button data-filter="finished_goods" class="filter-chip-v2 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105">تام</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-xs font-bold text-gray-600">عرض تاريخ:</label>
                                    <input type="date" id="dateFilter-v2" class="border rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button data-action="add-product" class="bg-gradient-to-r from-gray-800 to-black text-white px-5 py-2.5 rounded-xl flex items-center justify-center hover:from-black hover:to-gray-900 transition-all transform hover:scale-105 shadow-lg text-sm font-bold">
                                    <i class="fas fa-plus mr-2"></i> إضافة صنف
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState-v2" class="hidden flex flex-col items-center justify-center py-12 text-center">
                            <div class="bg-gray-100 p-5 rounded-full mb-3"><i class="fas fa-box-open text-4xl text-gray-400"></i></div>
                            <h3 class="text-gray-800 font-bold">المخزن فارغ</h3>
                            <p class="text-xs text-gray-500 mb-4">قاعدة البيانات جاهزة لاستقبال الأصناف</p>
                            <button data-action="add-product" class="bg-blue-600 text-white px-6 py-2 rounded shadow text-sm font-bold">إضافة صنف يدوياً</button>
                        </div>

                        <!-- Table -->
                        <div id="tableContainer-v2" class="bg-white rounded-lg shadow-sm border overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-50 text-[10px] text-gray-500 uppercase border-b">
                                        <tr>
                                            <th class="p-3">اسم الصنف</th>
                                            <th class="p-3 text-center">الرصيد</th>
                                            <th class="p-3 text-center">التكلفة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsBody-v2" class="divide-y text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- 2. Movements View -->
                    <section id="view-movements-v2" class="section-view-v2">
                        <div class="max-w-md mx-auto bg-white rounded-lg shadow border overflow-hidden">
                            <div class="bg-slate-800 p-3 text-white flex justify-between items-center">
                                <h2 class="font-bold text-sm">تسجيل إذن حركة</h2>
                                <span id="transBadge-v2" class="bg-green-500 text-[10px] px-2 py-0.5 rounded font-bold">وارد</span>
                            </div>
                            
                            <div class="p-4">
                                <div class="flex gap-2 mb-4">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="mtype-v2" value="inbound" checked class="hidden peer" data-action="toggle-trans">
                                        <div class="p-2 border rounded bg-gray-50 text-center text-xs font-bold peer-checked:bg-green-100 peer-checked:border-green-500 peer-checked:text-green-800 transition">
                                            <i class="fas fa-arrow-down"></i> شراء / وارد
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="mtype-v2" value="outbound" class="hidden peer" data-action="toggle-trans">
                                        <div class="p-2 border rounded bg-gray-50 text-center text-xs font-bold peer-checked:bg-red-100 peer-checked:border-red-500 peer-checked:text-red-800 transition">
                                            <i class="fas fa-arrow-up"></i> صرف / بيع
                                        </div>
                                    </label>
                                </div>

                                <form data-action="save-trans">
                                    <div id="inboundFields-v2" class="mb-3">
                                        <label class="text-[10px] font-bold text-gray-500 block mb-1">المورد</label>
                                        <input id="supplierSelect-v2" list="suppliers-datalist" class="w-full border rounded p-2 text-sm bg-gray-50 outline-none focus:border-blue-500" placeholder="اختر أو اكتب اسم المورد">
                                        <datalist id="suppliers-datalist"></datalist>
                                    </div>
                                    <div id="outboundFields-v2" class="hidden mb-3">
                                        <label class="text-[10px] font-bold text-gray-500 block mb-1">يصرف إلى</label>
                                        <select id="destSelect-v2" class="w-full border rounded p-2 text-sm bg-red-50 font-bold outline-none focus:border-red-500">
                                            <option>مصنع الجبن</option>
                                            <option>مصنع الزبادي</option>
                                            <option>مصنع السمنة</option>
                                            <option>مندوب مبيعات</option>
                                            <option>هالك / تالف</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="text-[10px] font-bold text-gray-500 block mb-1">الصنف</label>
                                        <select id="prodSelect-v2" class="w-full border rounded p-2 text-sm bg-white outline-none" required data-action="update-hint"></select>
                                        <div id="stockHint-v2" class="text-[10px] text-blue-600 font-bold mt-1 h-4 px-1"></div>
                                    </div>

                                    <div class="flex gap-2 mb-4">
                                        <div class="flex-1">
                                            <label class="text-[10px] font-bold text-gray-500 block mb-1">الكمية</label>
                                            <input type="number" id="qty-v2" step="0.01" min="0.01" required class="w-full border rounded p-2 text-center font-bold text-lg outline-none">
                                        </div>
                                        <div class="flex-1" id="priceDiv-v2">
                                            <label class="text-[10px] font-bold text-green-600 block mb-1">السعر</label>
                                            <input type="number" id="price-v2" step="0.01" class="w-full border border-green-300 bg-green-50 rounded p-2 text-center font-bold outline-none" placeholder="ج.م">
                                        </div>
                                    </div>

                                    <button id="transBtn-v2" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold shadow hover:bg-black transition">حفظ الحركة</button>
                                </form>
                            </div>
                        </div>
                    </section>

                    <!-- 3. Stocktake View -->
                    <section id="view-stocktake-v2" class="section-view-v2">
                        <div class="bg-white rounded-lg shadow border overflow-hidden">
                            <div class="p-3 bg-gray-50 border-b flex justify-between items-center sticky top-0 z-10">
                                <h2 class="font-bold text-sm text-gray-700">جرد المخزن</h2>
                                <div class="flex gap-2 items-center">
                                    <label class="text-[10px] text-gray-600">تاريخ الجرد:</label>
                                    <input type="date" id="stocktake-date-v2" class="border rounded px-2 py-1 text-[12px]" data-action="stocktake-date">
                                    <button data-action="stocktake-today" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">اليوم</button>
                                    <div class="flex gap-1">
                                        <button data-filter="finished_goods" class="st-filter-v2 active text-[10px] px-2 py-1 rounded bg-blue-600 text-white">تام</button>
                                        <button data-filter="raw_material" class="st-filter-v2 text-[10px] px-2 py-1 rounded border bg-white text-gray-500">خام</button>
                                        <button data-filter="packaging" class="st-filter-v2 text-[10px] px-2 py-1 rounded border bg-white text-gray-500">تغليف</button>
                                    </div>
                                </div>
                            </div>
                            <div class="max-h-[60vh] overflow-y-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-100 text-[10px] uppercase text-gray-500">
                                        <tr>
                                            <th class="p-2">الصنف</th>
                                            <th class="p-2 text-center w-16">نظام</th>
                                            <th class="p-2 text-center w-20">فعلي</th>
                                            <th class="p-2 text-center w-12">فرق</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stockBody-v2" class="text-xs font-bold divide-y"></tbody>
                                </table>
                            </div>
                            <div class="p-3 border-t bg-gray-50">
                                <button data-action="submit-stock" class="w-full bg-green-600 text-white py-2 rounded font-bold shadow hover:bg-green-700 transition text-sm">
                                    اعتماد الجرد
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- 4. Reports View -->
                    <section id="view-reports-v2" class="section-view-v2">
                        <div class="bg-white rounded-lg shadow border overflow-hidden">
                            <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                                <h2 class="font-bold text-sm text-gray-700">سجل العمليات</h2>
                                <div class="flex items-center gap-2">
                                    <label class="text-[10px] text-gray-600">اليوم:</label>
                                    <input type="date" id="logs-date-filter-v2" class="border rounded px-2 py-1 text-[12px]" data-action="logs-date">
                                    <button data-action="logs-today" class="text-xs bg-blue-600 text-white px-2 py-1 rounded shadow hover:bg-blue-700">اليوم</button>
                                    <button data-action="load-logs" class="text-xs bg-white border px-2 py-1 rounded shadow hover:bg-gray-100" title="تحديث"><i class="fas fa-sync-alt"></i></button>
                                </div>
                            </div>
                            <div class="max-h-[70vh] overflow-y-auto">
                                <table class="w-full text-right text-xs">
                                    <thead class="bg-gray-100 text-gray-500 border-b">
                                        <tr>
                                            <th class="p-3 whitespace-nowrap">الوقت</th>
                                            <th class="p-3 whitespace-nowrap">الحركة</th>
                                            <th class="p-3 whitespace-nowrap">الصنف</th>
                                            <th class="p-3 whitespace-nowrap">الكمية</th>
                                            <th class="p-3 whitespace-nowrap">الجهة</th>
                                            <th class="p-3 whitespace-nowrap">إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logsBody-v2" class="divide-y">
                                        <tr><td colspan="6" class="p-4 text-center text-gray-400">جاري التحميل...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                </div>

                <!-- Category Modal -->
                <div id="categoryModal-v2" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-[100] flex items-center justify-center backdrop-blur-sm">
                    <div class="bg-white w-11/12 max-w-2xl rounded-lg shadow-xl p-5 max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-gray-800">تصنيف المنتجات</h3>
                            <button data-action="toggle-category" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mb-4">حدد الفئة المناسبة لكل منتج</p>
                        <div class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-blue-800">استيراد من النظام القديم</p>
                                <p class="text-[10px] text-blue-600">يمكنك استيراد كل قسم على حدة من localStorage</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-import="raw_material" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700">
                                    <i class="fas fa-download"></i> استيراد الخامات
                                </button>
                                <button data-import="packaging" class="bg-yellow-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-yellow-700">
                                    <i class="fas fa-download"></i> استيراد التغليف
                                </button>
                                <button data-import="finished_goods" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700">
                                    <i class="fas fa-download"></i> استيراد التام
                                </button>
                            </div>
                        </div>
                        <div id="categoryList-v2" class="space-y-2"></div>
                        <div class="flex justify-end gap-2 mt-5 pt-3 border-t">
                            <button data-action="toggle-category" class="text-gray-500 text-sm font-bold px-3 py-2 hover:bg-gray-100 rounded">إغلاق</button>
                            <button data-action="save-categories" class="bg-blue-600 text-white px-5 py-2 rounded text-sm font-bold hover:bg-blue-700">حفظ التصنيفات</button>
                        </div>
                    </div>
                </div>

                <!-- Add Product Modal -->
                <div id="productModal-v2" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-[100] flex items-center justify-center backdrop-blur-sm">
                    <div class="bg-white w-11/12 max-w-sm rounded-lg shadow-xl p-5">
                        <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">إضافة صنف جديد</h3>
                        <form data-action="add-product-form">
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-500">اسم الصنف</label>
                                    <input id="newProdName-v2" class="w-full border rounded p-2 text-sm focus:border-blue-500 outline-none" required placeholder="مثال: لبن خام">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">القسم</label>
                                    <select id="newProdCat-v2" class="w-full border rounded p-2 text-sm bg-white">
                                        <option value="raw_material">خامات</option>
                                        <option value="finished_goods">منتج تام</option>
                                        <option value="packaging">تغليف</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">الوحدة</label>
                                    <select id="newProdUnit-v2" class="w-full border rounded p-2 text-sm bg-white">
                                        <option value="كجم">كجم</option>
                                        <option value="طن">طن</option>
                                        <option value="قطعة">قطعة</option>
                                        <option value="كرتونة">كرتونة</option>
                                        <option value="شكارة">شكارة</option>
                                        <option value="لتر">لتر</option>
                                        <option value="رول">رول</option>
                                        <option value="صفيحة">صفيحة</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-5">
                                <button type="button" data-action="toggle-product" class="text-gray-500 text-sm font-bold px-3 py-2 hover:bg-gray-100 rounded">إلغاء</button>
                                <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded text-sm font-bold hover:bg-blue-700">حفظ</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- PAGE: PRODUCTION RUNS / التشغيلات -->
            <div id="page-production" class="page" style="padding-bottom: 80px;">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="settings" class="w-6 h-6 text-green-600"></i>
                        إدارة التشغيلات (دفعات الإنتاج)
                    </h3>
                    <button id="create-production-btn" onclick="window.openCreateProductionModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> تشغيلة جديدة
                    </button>
                </div>

                <div class="p-4 rounded-lg bg-green-50 border border-green-200 text-sm leading-relaxed mb-6">
                    إنشاء تشغيلات إنتاج جديدة بناءً على الوصفات. كل تشغيلة تُتبع من البدء إلى الانتهاء، مع تحديث المخزون وحساب الأرباح والخسائر تلقائياً.
                </div>

                <!-- Tabs for viewing productions -->
                <div class="flex gap-2 mb-4 border-b">
                    <button id="tab-active-productions" class="px-4 py-2 font-semibold text-green-600 border-b-2 border-green-600">التشغيلات الجارية</button>
                    <button id="tab-completed-productions" class="px-4 py-2 font-semibold text-gray-600 hover:text-gray-800">التشغيلات المنتهية</button>
                </div>

                <!-- Active Productions Table -->
                <div id="active-productions-section" class="mb-6">
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">رقم التشغيلة</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">المنتج</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">الوصفة</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">تاريخ البدء</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الكمية المتوقعة</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الحالة</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="active-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="no-active-productions" class="text-center py-6 text-gray-500">لا توجد تشغيلات جارية حالياً</div>
                </div>

                <!-- Completed Productions Table -->
                <div id="completed-productions-section" class="mb-6 hidden">
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">رقم التشغيلة</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">المنتج</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">الكمية النهائية</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">التكلفة الإجمالية</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">سعر البيع</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">الربح/الخسارة</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">تاريخ الانتهاء</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="completed-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="no-completed-productions" class="text-center py-6 text-gray-500">لا توجد تشغيلات منتهية حالياً</div>
                </div>
            </div>

            <div id="page-total-bills" class="page">
                <div id="total-bills-content-wrapper">
                    <h2 class="text-xl font-bold mb-4">إجمالي الفواتير</h2>

                    <!-- Filter Controls -->
                    <div id="total-bills-filters" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label for="filter-from-date" class="block text-sm font-medium text-gray-700">من تاريخ</label>
                                <input type="date" id="filter-from-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-to-date" class="block text-sm font-medium text-gray-700">إلى تاريخ</label>
                                <input type="date" id="filter-to-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-customer-name" class="block text-sm font-medium text-gray-700">اسم العميل</label>
                                <input type="text" id="filter-customer-name" placeholder="بحث..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة</label>
                                <input type="number" id="filter-invoice-number" placeholder="بحث..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="flex flex-col gap-1">
                                <button id="reset-to-current-month-btn" class="bg-gray-500 text-white py-1 px-2 rounded-lg hover:bg-gray-600 text-sm">الشهر الحالي</button>
                                <button id="apply-filters-btn" class="bg-blue-600 text-white py-1 px-2 rounded-lg hover:bg-blue-700">تطبيق الفلترة</button>
                            </div>
                        </div>
                    </div>

                    <!-- Total Display -->
                    <div id="total-bills-summary-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg mb-4 text-center shadow-md flex items-center justify-center gap-4">
                        <div>
                            <span class="font-semibold">إجمالي الفواتير المعروضة:</span>
                            <span id="total-bills-summary-amount" class="font-bold text-green-800">0 ج.م</span>
                        </div>
                        <div class="flex items-center border-r-2 border-green-300 pr-4">
                            <input type="checkbox" id="include-total-in-export" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                            <label for="include-total-in-export" class="mr-2 text-sm font-medium text-green-900">تضمين الإجمالي</label>
                        </div>
                    </div>

                    <!-- Bills Table -->
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table id="total-bills-table" class="min-w-full divide-y divide-gray-200">
                                                                            <thead class="bg-gray-50">
                                                                                <tr>
                                                                                    <th class="p-4"><input type="checkbox" id="select-all-total-bills"></th>
                                                                                    <th data-sort="date" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">التاريخ</th>                                                            <th data-sort="invoiceNumber" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">رقم الفاتورة</th>
                                                            <th data-sort="customerName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">اسم العميل</th>
                                                            <th data-sort="repName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">اسم المندوب</th>
                                                            <th data-sort="total" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">إجمالي الفاتورة</th>
                                                            <th data-sort="status" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">النوع/الحالة</th>
                                                            <th data-sort="category" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">القسم/الصنف</th>
                                                        </tr>
                                                    </thead>                            <tbody id="total-bills-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be injected by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('total-bills-content-wrapper')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> طباعة الكل</button>
                    <button onclick="generateReportImage('total-bills-content-wrapper')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> نسخ الكل كصورة</button>
                </div>
                <div class="mt-2 p-3 border-t-2 border-dashed no-print">
                    <div class="flex gap-2">
                        <button onclick="exportSelectedRows('print')" class="w-1/2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> طباعة المحدد</button>
                        <button onclick="exportSelectedRows('image')" class="w-1/2 bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> نسخ المحدد كصورة</button>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="space-y-6">
                    <!-- شريط تحكم سريع داخل الإعدادات -->
                    <!-- الزر اليدوي لإصلاح شيكولاتة تم إزالته وجُعل العمل تلقائيًا -->
                    <div class="flex items-center justify-end gap-2 no-print">
                        <button id="open-user-management-btn" class="bg-purple-600 text-white px-3 py-2 rounded-md text-sm hover:bg-purple-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            إدارة المستخدمين
                        </button>
                    </div>
                    <!-- إدارة المستخدمين والأدوار (للمدراء فقط) -->
                    <div id="user-management-section" class="p-4 border rounded-lg bg-white hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">إدارة المستخدمين</h3>
                            <button id="refresh-users-btn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-gray-300">تحديث</button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">يمكنك تعديل صلاحية كل مستخدم (admin, rep, viewer). التغييرات تُحفظ فوراً في Firestore.</p>
                        <div id="user-role-warning" class="p-2 mb-2 rounded border border-yellow-300 bg-yellow-50 text-yellow-800 hidden"></div>
                        <div class="mb-3 flex flex-wrap gap-2 items-center">
                            <button id="seed-missing-roles-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-plus"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M9 12h6"/><path d="M12 9v6"/></svg>
                                توليد الأدوار الناقصة
                            </button>
                            <span id="seed-roles-status" class="text-xs text-gray-600"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-right">الاسم</th>
                                        <th class="px-2 py-2 text-right">البريد</th>
                                        <th class="px-2 py-2 text-center">الدور</th>
                                        <th class="px-2 py-2 text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="bg-white divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- محدد الشهر: اختيار فترة العرض الشهرية -->
                    <div>
                        <h3 class="text-lg font-bold mb-1">الفترة الشهرية المعروضة</h3>
                        <p class="text-xs text-gray-500 mb-2">اختر شهراً لاستعراض بياناته. يبدأ التطبيق تلقائياً بالشهر الحالي، ويمكنك الرجوع لأي شهر سابق من هنا.</p>
                        <div class="flex items-center gap-2">
                            <input type="month" id="active-period-input" class="p-2 border rounded-md" />
                            <button id="active-period-today-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-300">الشهر الحالي</button>
                            <span id="active-period-indicator" class="text-sm text-gray-600 ml-auto"></span>
                        </div>
                    </div>

                    <!-- تتبع موقع المناديب (GPS) -->
                    <div id="gps-settings" class="p-4 border rounded-lg bg-white">
                        <h3 class="text-lg font-bold mb-2">تتبع موقع المناديب (GPS)</h3>
                        <div class="flex items-center gap-2 mb-1">
                            <input type="checkbox" id="gps-share-toggle" class="w-4 h-4">
                            <label for="gps-share-toggle" class="text-sm">مشاركة موقعي من هذا الجهاز</label>
                            <span id="gps-share-status" class="text-xs text-gray-600 ml-auto"></span>
                        </div>
                        <p class="text-xs text-gray-500">عند التفعيل، سيطلب المتصفح إذن الوصول للموقع ويتم تحديث الإحداثيات دورياً في السحابة.</p>
                        <div id="admin-gps-list" class="mt-3 hidden">
                            <h4 class="font-semibold mb-1">مواقع المناديب الآن</h4>
                            <div id="rep-locations-list" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2">الهدف الشهري العام للمبيعات</h3>
                        <p class="text-xs text-gray-500 mb-2">هذا هو الهدف الافتراضي (يستخدم في حال عدم اختيار مندوب محدد في لوحة المعلومات).</p>
                        <div class="flex items-center gap-2">
                            <input type="number" id="sales-target-input" class="w-full p-2 border rounded-md" placeholder="أدخل الهدف الشهري">
                            <button id="save-target-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">حفظ</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold">شعار الشركة</h3>
                        <p class="text-xs text-gray-500 mb-2">أدخل رابط الشعار (URL) ليظهر في رأس التطبيق والتقارير. يمكنك استخدام رابط ملف محلي بصيغة file:///C:/... عند تشغيل التطبيق محلياً، أو رفع الصورة إلى استضافة ثم وضع الرابط هنا.</p>
                        <div class="flex items-center gap-2">
                            <input type="text" id="company-logo-input" class="w-full p-2 border rounded-md" placeholder="https://example.com/logo.jpg أو file:///C:/Users/.../logo.jpg">
                            <button id="save-company-logo-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">نصيحة: لتحميل الصورة على الويب بسرعة استخدم خدمات مثل imgur.com أو GitHub (repo أو gist) أو أي استضافة صور لديك.</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">كتالوج المنتجات</h3>
                            <button id="add-product-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">إضافة منتج</button>
                        </div>
                        <input id="search-products" type="text" placeholder="ابحث عن منتج..." class="w-full p-2 border rounded-md mb-2">
                        <div id="products-list" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>
                    
                    <!-- قوائم الأسعار (مُرتجعة هنا في الإعدادات كما كانت قبل التعديل) -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">قوائم الأسعار</h3>
                            <button id="add-price-list-btn" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700">إضافة قائمة</button>
                        </div>
                        <div id="price-lists-container" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-2">النسخ الاحتياطي والاستعادة</h3>
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-4">
                            <div>
                                <h4 class="font-semibold mb-2">1. نسخ البيانات (Backup) </h4>
                                <p class="text-xs text-gray-600 mb-2">اضغط لإنشاء كود يحتوي على كل بياناتك (عملاء، فواتير، منتجات، مناديب). انسخ هذا الكود واحتفظ به في مكان آمن.</p>
                                <button id="backup-data-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-2">إنشاء نسخة احتياطية الآن</button>
                                <textarea id="backup-data-textarea" class="w-full p-2 border rounded-md bg-gray-200" readonly placeholder="سيظهر كود النسخة الاحتياطية هنا..."></textarea>
                                <button id="copy-backup-btn" class="w-full mt-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 hidden">نسخ الكود</button>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-2">2. استعادة البيانات (Restore)</h4>
                                <p class="text-xs text-gray-600 mb-2">الصق الكود الذي نسخته سابقاً هنا لاستعادة بياناتك. <strong class="text-red-600">تحذير: هذا سيستبدل جميع البيانات الحالية.</strong></p>
                                <textarea id="restore-data-textarea" class="w-full p-2 border rounded-md" style="height: 100px;" placeholder="الصق كود النسخة الاحتياطية هنا..."></textarea>
                                <button id="restore-data-btn" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">استعادة البيانات</button>
                            </div>
                        </div>
                    </div>

                    <!-- أداة استيراد إلى السحابة (Firestore) - للمدير فقط -->
                    <div id="admin-cloud-import-section" class="p-4 border-2 border-yellow-300 rounded-lg bg-yellow-50 space-y-3 no-print hidden">
                        <h3 class="text-lg font-bold">استيراد نسخة قديمة إلى السحابة (Firestore)</h3>
                        <p class="text-xs text-gray-700">هذه الأداة ترفع محتويات ملف النسخة الاحتياطية القديم (JSON أو TXT) مباشرةً إلى جداول Firestore (customers, products, priceLists, reps, sales...). تظهر فقط للمستخدمين ذوي صلاحية admin.</p>
                        <div class="flex items-center gap-2">
                            <input id="admin-import-file" type="file" accept=".json,.txt,application/json,text/plain" class="flex-1 p-2 border rounded-md bg-white" />
                            <button id="admin-start-import-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed">بدء الاستيراد</button>
                        </div>
                        <div id="admin-import-status" class="text-sm text-gray-700"></div>
                    </div>
                </div>
            <!-- (قوائم الأسعار الآن مُدارة من صفحة الإعدادات - تم إرجاع الواجهة إلى مكانها داخل الإعدادات) -->
            </div>

        <!-- Costs Page: التكاليف (مبسطة) -->

                    <div id="page-costs" class="page" style="padding-bottom: 80px;">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="flask-conical" class="w-6 h-6 text-blue-600"></i>
                        حساب تكلفة المنتج
                    </h3>
                    <div class="flex items-center gap-2">
                    <button id="add-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> منتج جديد
                    </button>
                    <button id="save-and-produce-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1" style="display:none;">
                        <i data-lucide="check" class="w-4 h-4"></i> حفظ وإنشاء تشغيلة
                    </button>
                    <!-- أزلنا أزرار الاستيراد لتقليل الإزدحام. الاستيراد مازال متاحاً عبر الدوال العامة إن لزم. -->
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm leading-relaxed mb-6">
                    أدخل مكوّنات (خامات)، مواد تعبئة، ومصاريف تشغيل لكل <span class="font-bold">دفعة إنتاج</span>. يحسب النظام التكلفة الإجمالية وتكلفة الكيلو/الوحدة النهائية.
                    مثال: منتج "جبنة قريش" يخرج 50 كجم في دفعة؛ تضيف اللبن (كمية كجم وسعر للكجم)، المنفحة، الملح، ثم التغليف (أكياس، صناديق)، ثم مصروف التشغيل (كهرباء، أجور) بالقيمة الإجمالية.
                </div>
                <!-- Price Manager (Raw, Pack, Ops) -->

                <!-- Unified Price Grid (Printable Overview) -->
                <details id="unified-price-grid-block" class="mb-6 bg-white rounded-lg border">
                    <summary class="cursor-pointer select-none px-4 py-3 flex items-center gap-2 text-sm font-semibold">
                        <i data-lucide="table" class="w-4 h-4 text-indigo-600"></i>
                        شبكة موحدة لكل الأسعار
                        <span id="unified-grid-summary" class="ml-auto text-gray-500 text-xs"></span>
                    </summary>
                    <div class="px-4 pb-4 pt-2 space-y-3">
                        <div class="flex flex-wrap gap-2 text-xs">
                            <button type="button" id="unified-refresh-btn" class="px-3 py-1 rounded bg-indigo-600 text-white">تحديث</button>
                            <button type="button" id="unified-print-btn" class="px-3 py-1 rounded bg-gray-200 text-gray-800">طباعة</button>
                            <button type="button" id="unified-export-json-btn" class="px-3 py-1 rounded bg-green-600 text-white">تصدير JSON</button>
                            <button type="button" id="unified-export-csv-btn" class="px-3 py-1 rounded bg-emerald-500 text-white">تصدير CSV</button>
                        </div>
                        <div class="overflow-x-auto border rounded">
                            <table id="unified-price-grid" class="min-w-full divide-y divide-gray-200 text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-right px-2 py-1">الاسم</th>
                                        <th class="text-center px-2 py-1">الكود</th>
                                        <th class="text-center px-2 py-1">النوع</th>
                                        <th class="text-center px-2 py-1">الوحدة</th>
                                        <th class="text-center px-2 py-1">السعر الحالي</th>
                                        <th class="text-center px-2 py-1">سعر جديد</th>
                                        <th class="text-center px-2 py-1">آخر تحديث</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="text-[11px] text-gray-500">هذه الشبكة للعرض السريع في المكتب لتقدير التكلفة. أي تعديل للأسعار يتم من خلال قسم إدارة الأسعار أعلاه.</div>
                    </div>
                </details>
                <div id="recipes-list" class="space-y-6"></div>
            </div>

            <!-- Taxes Page -->
            <div id="page-taxes" class="page" style="padding-bottom:80px;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="percent" class="w-6 h-6 text-blue-600"></i>
                        <span>الضرائب</span>
                    </h2>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-medium">اختر الشهر</label>
                        <input id="tax-month-input" type="month" class="p-2 border rounded-md">
                        <button id="tax-refresh-btn" class="bg-blue-600 text-white px-3 py-2 rounded-md">عرض</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex gap-2 mb-3">
                        <button id="tax-tab-report" class="px-3 py-2 bg-gray-100 rounded">تقرير القيمة المضافة</button>
                        <button id="tax-tab-einvoices" class="px-3 py-2 bg-white rounded">سجل الفواتير</button>
                    </div>

                    <div id="tax-tab-content">
                        <!-- Report Tab -->
                        <div id="tax-report-tab">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">إجمالي المبيعات الخاضعة</div>
                                    <div id="tax-total-sales" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">الضريبة الخارجة (Output VAT)</div>
                                    <div id="tax-output-vat" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">الضريبة الداخلة (Input VAT)</div>
                                    <div id="tax-input-vat" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">الصافي المستحق</div>
                                    <div id="tax-net-payable" class="text-2xl font-bold">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- E-Invoice Log Tab -->
                        <div id="tax-einvoices-tab" style="display:none;">
                            <div class="overflow-x-auto mt-3">
                                <table class="w-full table-auto border-collapse">
                                    <thead>
                                        <tr class="text-sm text-gray-600">
                                            <th class="p-2 text-left">Invoice #</th>
                                            <th class="p-2 text-left">Date</th>
                                            <th class="p-2 text-left">Customer</th>
                                            <th class="p-2 text-right">Total</th>
                                            <th class="p-2 text-left">UUID</th>
                                            <th class="p-2 text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="einvoice-log-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- صفحة تكاليف 2 - نظام تكاليف الألبان الاحترافي -->
            <div id="page-costs-v2" class="page" style="padding-bottom:80px;">
                <style>
                    /* تنسيقات خاصة بصفحة التكاليف v2 - مثل الصورة */
                    .cv2-tab-btn {
                        color: #64748b;
                        background: transparent;
                        border: none;
                        cursor: pointer;
                        position: relative;
                    }
                    .cv2-tab-btn:hover {
                        color: #3b82f6;
                        background-color: #f1f5f9;
                    }
                    .cv2-tab-btn.active {
                        color: #3b82f6;
                        background-color: #eff6ff;
                    }
                    .cv2-tab-btn.active::after {
                        content: '';
                        position: absolute;
                        bottom: 0;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 60%;
                        height: 3px;
                        background: #3b82f6;
                        border-radius: 3px 3px 0 0;
                    }
                    .glass-card {
                        background: white;
                        border-radius: 2rem;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        border: 1px solid #e2e8f0;
                        overflow: hidden;
                    }
                    .input-pro {
                        width: 100%;
                        padding: 1rem;
                        border: 2px solid #f1f5f9;
                        border-radius: 1rem;
                        background-color: #f8fafc;
                        font-weight: bold;
                        font-size: 1.125rem;
                        color: #334155;
                        outline: none;
                        transition: all 0.3s;
                    }
                    .input-pro:focus {
                        border-color: #3b82f6;
                        background-color: white;
                    }
                </style>

                <!-- TOP NAVIGATION - مثل الصورة -->
                <nav class="bg-white border-b-2 border-gray-100 sticky top-16 z-40 shadow-sm mb-6">
                    <div class="max-w-7xl mx-auto px-4">
                        <div class="flex justify-center items-center gap-1 py-2">
                            <!-- الرئيسية -->
                            <button onclick="window.costsV2.navTo('dashboard')" data-cv2-nav="dashboard" class="cv2-tab-btn active flex flex-col items-center px-8 py-3 rounded-lg transition-all">
                                <i data-lucide="home" class="w-6 h-6 mb-1"></i>
                                <span class="text-sm font-bold">الرئيسية</span>
                            </button>
                            
                            <!-- التشغيل -->
                            <button onclick="window.costsV2.navTo('batches')" data-cv2-nav="batches" class="cv2-tab-btn flex flex-col items-center px-8 py-3 rounded-lg transition-all">
                                <i data-lucide="settings" class="w-6 h-6 mb-1"></i>
                                <span class="text-sm font-bold">التشغيل</span>
                            </button>
                            
                            <!-- الوصفات -->
                            <button onclick="window.costsV2.navTo('recipes')" data-cv2-nav="recipes" class="cv2-tab-btn flex flex-col items-center px-8 py-3 rounded-lg transition-all">
                                <i data-lucide="flask-conical" class="w-6 h-6 mb-1"></i>
                                <span class="text-sm font-bold">الوصفات</span>
                            </button>
                            
                            <!-- الأسعار -->
                            <button onclick="window.costsV2.navTo('prices')" data-cv2-nav="prices" class="cv2-tab-btn flex flex-col items-center px-8 py-3 rounded-lg transition-all">
                                <i data-lucide="dollar-sign" class="w-6 h-6 mb-1"></i>
                                <span class="text-sm font-bold">الأسعار</span>
                            </button>
                            
                            <!-- الأرباح -->
                            <button onclick="window.costsV2.navTo('reports')" data-cv2-nav="reports" class="cv2-tab-btn flex flex-col items-center px-8 py-3 rounded-lg transition-all">
                                <i data-lucide="trending-up" class="w-6 h-6 mb-1"></i>
                                <span class="text-sm font-bold">الأرباح</span>
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- CONTENT AREA -->
                <main class="px-6 md:px-10 pb-20">
                    
                    <!-- DASHBOARD -->
                    <section data-cv2-view="dashboard" class="max-w-7xl mx-auto">
                        <div class="glass-card p-10 border-none shadow-xl mb-10 bg-gradient-to-br from-white to-blue-50/30">
                            <div class="flex justify-between items-center flex-wrap gap-10">
                                <div class="max-w-2xl">
                                    <h2 class="text-4xl font-black text-slate-900 mb-4 tracking-tight">نظام مراقبة التكاليف والإنتاج</h2>
                                    <p class="text-slate-500 font-bold text-xl leading-relaxed italic">تابع دورة تصنيع الألبان من سحب الخامات وحتى حساب الأرباح الصافية لكل تشغيلة.</p>
                                </div>
                                <button onclick="window.costsV2.navTo('batches')" class="bg-blue-600 text-white px-12 py-5 rounded-2xl font-black text-lg shadow-2xl shadow-blue-200 hover:bg-blue-700 hover:-translate-y-1 transition-all active:scale-95 flex items-center gap-3">
                                    <i data-lucide="play" class="fill-current"></i>
                                    فتح تشغيلة إنتاج
                                </button>
                            </div>
                        </div>

                        <div class="glass-card">
                            <div class="p-8 border-b bg-slate-50 flex justify-between items-center">
                                <h3 class="font-black text-slate-800 flex items-center gap-4 text-2xl">
                                    <i data-lucide="activity" class="text-blue-600 w-8 h-8"></i> آخر العمليات
                                </h3>
                            </div>
                            <div id="cv2-dashboard-activity-list" class="divide-y divide-slate-100 min-h-[400px]">
                                <div class="flex flex-col items-center justify-center p-32 opacity-40">
                                    <i data-lucide="clock-3" class="w-20 h-20 mb-4 text-slate-300"></i>
                                    <p class="text-xl font-bold text-slate-400">جاري تحميل النشاطات الأخيرة...</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- PRICE GRID -->
                    <section data-cv2-view="prices" class="hidden max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-10 px-4">
                            <div>
                                <h2 class="text-4xl font-black text-slate-900">شبكة الأسعار الموحدة</h2>
                                <p class="text-lg font-bold text-slate-500 mt-2">مرجع تسعير الخامات وتكاليف التشغيل اليومية</p>
                            </div>
                            <button onclick="window.costsV2.openModal('cv2-modal-ingredient')" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition flex items-center gap-3 text-lg">
                                <i data-lucide="plus-circle" class="w-6 h-6"></i> إضافة صنف خام
                            </button>
                        </div>
                        <div class="glass-card shadow-2xl">
                            <table class="w-full text-right">
                                <thead class="bg-slate-950 text-slate-400 text-[12px] font-black uppercase border-b border-slate-800">
                                    <tr>
                                        <th class="p-6">الخامة / المصروف</th>
                                        <th class="p-6">الوحدة</th>
                                        <th class="p-6">التكلفة المعتمدة</th>
                                        <th class="p-6">تاريخ التحديث</th>
                                        <th class="p-6 text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="cv2-ingredients-tbody" class="divide-y divide-slate-100 text-lg font-bold text-slate-800"></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- RECIPES -->
                    <section data-cv2-view="recipes" class="hidden max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-10 px-4">
                            <h2 class="text-4xl font-black text-slate-900 tracking-tight">قائمة الوصفات المعيارية</h2>
                            <button onclick="window.costsV2.openRecipeModal()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition text-lg">وصفة جديدة (BOM)</button>
                        </div>
                        <div id="cv2-recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>
                    </section>

                    <!-- BATCHES -->
                    <section data-cv2-view="batches" class="hidden max-w-7xl mx-auto">
                        <div class="mb-16">
                            <h2 class="text-3xl font-black text-slate-900 mb-10 flex items-center gap-5 px-4">
                                <span class="w-5 h-5 bg-blue-600 rounded-full animate-pulse shadow-[0_0_20px_rgba(37,99,235,0.6)]"></span>
                                تشغيلات تحت التصنيع
                            </h2>
                            <div id="cv2-active-batches-list" class="space-y-8"></div>
                        </div>
                        <div class="pt-12 border-t border-slate-200">
                            <h2 class="text-3xl font-black text-slate-400 mb-10 px-4 italic">أرشيف التشغيلات المغلقة</h2>
                            <div id="cv2-completed-batches-list" class="space-y-8 opacity-75"></div>
                        </div>
                    </section>

                    <!-- REPORTS -->
                    <section data-cv2-view="reports" class="hidden max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-12 px-4">
                            <h2 class="text-4xl font-black text-slate-900 flex items-center gap-5">
                                <i data-lucide="pie-chart" class="text-emerald-500 w-10 h-10"></i> التقارير والربحية
                            </h2>
                            <button onclick="window.costsV2.loadReports()" class="text-lg bg-white border-2 border-slate-100 px-8 py-3 rounded-2xl font-black shadow-sm hover:bg-slate-50 transition">تحديث البيانات</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-10 mb-16">
                            <div class="glass-card p-12 bg-emerald-600 text-white shadow-2xl border-none">
                                <p class="text-[12px] font-black uppercase tracking-[0.2em] mb-3 opacity-80">صافي الأرباح المحققة</p>
                                <h3 class="text-6xl font-black" id="cv2-rpt-total-profit">0</h3>
                            </div>
                            <div class="glass-card p-12 border-none shadow-xl">
                                <p class="text-[12px] text-slate-400 font-black uppercase tracking-[0.2em] mb-3">إجمالي المبيعات</p>
                                <h3 class="text-5xl font-black text-slate-800" id="cv2-rpt-total-revenue">0</h3>
                            </div>
                            <div class="glass-card p-12 border-none shadow-xl">
                                <p class="text-[12px] text-slate-400 font-black uppercase tracking-[0.2em] mb-3">تكلفة الإنتاج</p>
                                <h3 class="text-5xl font-black text-red-600" id="cv2-rpt-total-cogs">0</h3>
                            </div>
                        </div>
                        <div class="glass-card overflow-x-auto shadow-2xl">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-950 text-slate-400 font-black text-[11px] uppercase border-b border-slate-800">
                                    <tr>
                                        <th class="p-6">التشغيلة</th>
                                        <th class="p-6">المنتج</th>
                                        <th class="p-6">تكلفة الكيلو</th>
                                        <th class="p-6">المباع</th>
                                        <th class="p-6 text-emerald-400">الإيراد</th>
                                        <th class="p-6 text-red-400">التكلفة</th>
                                        <th class="p-6 text-white">الصافي</th>
                                        <th class="p-6">الهامش %</th>
                                    </tr>
                                </thead>
                                <tbody id="cv2-reports-tbody" class="divide-y divide-slate-100 font-bold text-slate-800 text-base"></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- BATCH DETAILS -->
                    <section data-cv2-view="batch-details" class="hidden max-w-5xl mx-auto">
                        <button onclick="window.costsV2.navTo('batches')" class="mb-8 text-slate-500 hover:text-blue-600 font-black flex items-center gap-3 text-lg transition">
                            <i data-lucide="arrow-right" class="w-6 h-6"></i> عودة لقائمة التشغيلات
                        </button>
                        <div id="cv2-batch-details-content"></div>
                    </section>
                </main>

                <!-- Reports Subnav (أنواع التقارير) -->
                <nav id="reports-subnav" class="fixed left-0 right-0 mx-auto justify-around p-2 no-print">
                    <button data-report-section="daily" class="reports-subnav-item active">
                        <i data-lucide="calendar"></i><span>يومي</span>
                    </button>
                    <button data-report-section="range" class="reports-subnav-item">
                        <i data-lucide="calendar-range"></i><span>فترة</span>
                    </button>
                    <button data-report-section="monthly" class="reports-subnav-item">
                        <i data-lucide="calendar"></i><span>شهري</span>
                    </button>
                    <button data-report-section="reconciliation" class="reports-subnav-item">
                        <i data-lucide="scale"></i><span>التسوية النهائية</span>
                    </button>
                    <button data-report-section="targets" class="reports-subnav-item">
                        <i data-lucide="target"></i><span>تارجت المناديب</span>
                    </button>
                    <button data-report-section="customer-targets" class="reports-subnav-item">
                        <i data-lucide="users"></i><span>تارجت العملاء</span>
                    </button>
                </nav>

                <!-- MODALS -->

                <!-- Modal: Ingredient -->
                <div id="cv2-modal-ingredient" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center backdrop-blur-xl p-6">
                    <div class="bg-white rounded-[2.5rem] w-full max-w-md p-10 shadow-2xl">
                        <h3 class="text-3xl font-black mb-10 border-b pb-5 text-slate-900">تعريف صنف بالشبكة</h3>
                        <form onsubmit="window.costsV2.saveIngredient(event)">
                            <div class="space-y-8">
                                <input id="cv2-ing-name" placeholder="اسم الخامة (لبن، منفحة..)" class="input-pro" required>
                                <input id="cv2-ing-unit" placeholder="الوحدة (كجم / لتر / ساعة)" class="input-pro" required>
                                <div>
                                    <label class="text-[12px] font-black text-slate-400 uppercase mb-3 block mr-3 tracking-widest">سعر التكلفة المعتمد</label>
                                    <input id="cv2-ing-cost" type="number" step="0.01" class="input-pro text-orange-600 text-4xl py-6" required>
                                </div>
                            </div>
                            <div class="mt-12 flex gap-5">
                                <button type="button" onclick="window.costsV2.closeModal('cv2-modal-ingredient')" class="flex-1 py-5 text-slate-500 font-black text-lg">إلغاء</button>
                                <button type="submit" class="flex-2 py-5 bg-blue-600 text-white rounded-3xl font-black text-xl shadow-2xl hover:bg-blue-700 transition">حفظ السعر</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal: Recipe Builder -->
                <div id="cv2-modal-recipe" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center backdrop-blur-xl p-4">
                    <div class="bg-white rounded-2xl w-full max-w-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                        <h3 class="text-xl font-bold mb-4 border-b pb-3 text-blue-600">تصميم وصفة إنتاج وتشغيل</h3>
                        <form onsubmit="window.costsV2.saveRecipe(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">اسم المنتج النهائي</label>
                                    <input id="cv2-rec-name" placeholder="مثال: جبنة بيضاء" class="w-full p-2 border rounded-lg text-sm" required oninput="window.costsV2.showProductSuggestions(this.value)">
                                    <div id="cv2-product-suggestions" class="hidden absolute bg-white border-2 border-blue-200 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto w-96 z-50">
                                        <!-- سيتم ملأها ديناميكياً -->
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">وحدة المنتج</label>
                                    <input id="cv2-rec-unit" placeholder="صفيحة/كجم" class="w-full p-2 border rounded-lg text-sm" required>
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-slate-50 to-blue-50/30 p-4 rounded-xl border mb-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-sm text-slate-700 flex items-center gap-2">
                                        <i data-lucide="package" class="w-4 h-4 text-blue-600"></i>
                                        المكونات والخامات
                                    </h4>
                                    <button type="button" onclick="window.costsV2.addIngredientRow()" class="text-xs bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-1">
                                        <i data-lucide="plus" class="w-3 h-3"></i>
                                        إضافة صنف
                                    </button>
                                </div>
                                <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-slate-200">
                                    <table class="w-full text-right text-sm">
                                        <thead class="bg-slate-100 text-slate-600 font-bold text-xs border-b">
                                            <tr>
                                                <th class="p-2 text-right" style="width: 30%;">النوع</th>
                                                <th class="p-2 text-right" style="width: 35%;">اسم الصنف</th>
                                                <th class="p-2 text-center" style="width: 15%;">الكمية</th>
                                                <th class="p-2 text-center" style="width: 15%;">التكلفة</th>
                                                <th class="p-2 text-center" style="width: 5%;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="cv2-recipe-ingredients-list" class="divide-y divide-slate-100"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">الكمية الناتجة المتوقعة</label>
                                    <input id="cv2-rec-expected-yield" type="number" step="0.0001" placeholder="770" class="w-full p-2 border rounded-lg text-sm" required oninput="window.costsV2.calcRecipeTotal()">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">تشغيل إضافي</label>
                                    <input id="cv2-rec-overhead" type="number" step="0.01" placeholder="0.00" class="w-full p-2 border rounded-lg text-sm" oninput="window.costsV2.calcRecipeTotal()">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">سعر البيع</label>
                                    <input id="cv2-rec-std-price" type="number" step="0.01" placeholder="0.00" class="w-full p-2 border rounded-lg text-sm text-emerald-600 bg-emerald-50" required>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="text-xs font-bold text-blue-500 mb-1 block">رقم التشغيلة</label>
                                    <input id="cv2-rec-manual-batch-num" type="number" placeholder="مثلاً: 150" class="w-full p-2 border rounded-lg text-sm border-blue-200">
                                </div>
                            </div>

                            <div class="p-6 bg-gradient-to-r from-slate-800 to-slate-900 text-white rounded-xl text-center mb-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-xs text-slate-400 mb-1">التكلفة الإجمالية</p>
                                        <h4 class="text-2xl font-black text-blue-400"><span id="cv2-rec-final-cost">0.00</span> <span class="text-lg">ج.م</span></h4>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400 mb-1">تكلفة الوحدة الواحدة</p>
                                        <h4 class="text-2xl font-black text-emerald-400"><span id="cv2-rec-unit-cost">0.00</span> <span class="text-lg">ج.م</span></h4>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <button type="button" onclick="window.costsV2.closeModal('cv2-modal-recipe')" class="flex-1 py-2 text-slate-500 font-bold text-sm hover:text-slate-700 transition">إلغاء</button>
                                <button type="submit" class="flex-2 px-6 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700 transition">حفظ الوصفة</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal: Close Batch -->
                <div id="cv2-modal-close-batch" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center backdrop-blur-xl p-6">
                    <div class="bg-white rounded-[3rem] w-full max-w-lg p-12 shadow-2xl">
                        <h3 class="text-3xl font-black mb-3 text-red-600 text-center uppercase tracking-tighter">إغلاق التشغيلة</h3>
                        <p class="text-center text-sm font-bold text-slate-400 mb-12 uppercase tracking-widest">سجل الأرقام الحقيقية النهائية للإنتاج</p>
                        <form onsubmit="window.costsV2.closeBatchConfirm(event)" class="space-y-10">
                            <input type="hidden" id="cv2-close-batch-id-hidden">
                            <div class="bg-red-50 p-8 rounded-[2.5rem] border-2 border-red-100 shadow-inner">
                                <label class="text-[12px] font-black text-red-600 uppercase mb-4 block tracking-widest">إجمالي المصاريف الفعلية</label>
                                <input id="cv2-close-total-cost" type="number" step="0.01" class="w-full p-6 border-2 border-red-100 rounded-3xl font-black text-red-700 text-5xl bg-white outline-none focus:border-red-500 transition shadow-xl text-center" required>
                            </div>
                            <div class="bg-emerald-50 p-8 rounded-[2.5rem] border-2 border-emerald-100 shadow-inner">
                                <label class="text-[12px] font-black text-emerald-600 uppercase mb-4 block tracking-widest">الإنتاج الصافي (Yield)</label>
                                <input id="cv2-close-final-qty" type="number" step="0.01" class="w-full p-6 border-2 border-emerald-100 rounded-3xl font-black text-emerald-700 text-5xl bg-white outline-none focus:border-emerald-500 transition shadow-xl text-center" required placeholder="0">
                            </div>
                            <div class="flex gap-6 pt-6">
                                <button type="button" onclick="window.costsV2.closeModal('cv2-modal-close-batch')" class="flex-1 py-5 text-slate-400 font-black text-xl">رجوع</button>
                                <button type="submit" class="flex-2 px-10 py-5 bg-red-600 text-white rounded-3xl font-black text-xl shadow-2xl hover:bg-red-700 transition transform active:scale-95">اعتماد الإغلاق</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal: Sale -->
                <div id="cv2-modal-sale" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center backdrop-blur-xl p-6">
                    <div class="bg-white rounded-[2.5rem] w-full max-w-md p-10 shadow-2xl">
                        <h3 class="text-2xl font-black mb-10 border-b pb-5 text-blue-600">تسجيل مبيعات التشغيلة</h3>
                        <form onsubmit="window.costsV2.saveBatchSale(event)" class="space-y-6">
                            <input id="cv2-sale-customer" placeholder="اسم العميل" class="input-pro" required>
                            <div class="grid grid-cols-2 gap-6">
                                <input id="cv2-sale-qty" type="number" step="0.01" placeholder="الكمية" class="input-pro" required>
                                <input id="cv2-sale-price" type="number" step="0.01" placeholder="سعر البيع" class="input-pro text-emerald-600 font-black" required>
                            </div>
                            <div class="mt-12 flex gap-5">
                                <button type="button" onclick="window.costsV2.closeModal('cv2-modal-sale')" class="flex-1 py-5 text-slate-400 font-black">إلغاء</button>
                                <button type="submit" class="flex-2 py-5 bg-blue-600 text-white rounded-3xl font-black text-lg shadow-2xl">حفظ العملية</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Bottom Nav - Adjusted buttons after moving reports -->
        <nav id="main-nav-bar" class="bottom-nav fixed bottom-0 left-0 right-0 mx-auto bg-white border-t shadow-t p-2 flex justify-around no-print">
            <button data-page="dashboard" class="bottom-nav-item active flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                <span class="text-xs">الرئيسية</span>
            </button>
            <button data-page="spreadsheet-entry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-table"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                <span class="text-xs">إدخال سريع</span>
            </button>
            <!-- BUTTON FOR SALES PAGE (Search, view all invoices) -->
            <button data-page="sales" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6"/><path d="M16 12h-6"/><path d="M16 16h-6"/></svg>
                <span class="text-xs">المبيعات</span>
            </button>
            <button data-page="dispatch" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>
                <span class="text-xs">الاذونات</span>
            </button>
            <!-- REPORTS BUTTON RETAINED, NOW GOES TO DEDICATED REPORTS PAGE -->
            <button data-page="reports" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                <span class="text-xs">التقارير</span>
            </button>
            <!-- TAXES Button -->
            <button data-page="taxes" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><path d="M21 12A9 9 0 1 1 3 12 9 9 0 0 1 21 12z"/><path d="M9 9h.01"/><path d="M15 15h.01"/><path d="M7 17l10-10"/></svg>
                <span class="text-xs">الضرائب</span>
            </button>
            <!-- NEW: تكاليف2 (نظام التكاليف الجديد) Button - Admin only -->
            <button id="costs-v2-nav-btn" data-page="costs-v2" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-factory"><path d="M2 20h20"/><path d="M4 20V10l6-6 6 6v10"/><path d="M8 14h8"/><path d="M8 18h8"/></svg>
                <span class="text-xs">تكاليف2</span>
            </button>
            <!-- NEW: Production / التشغيلات Button -->
            <button id="production-nav-btn" data-page="production" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.08 5.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08-5.08l4.24-4.24"/></svg>
                <span class="text-xs">التشغيلات</span>
            </button>
            <button data-page="promotions" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
                <span class="text-xs">العروض</span>
            </button>
            <button data-page="customers" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span class="text-xs">العملاء</span>
            </button>
            <button data-page="reps" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2"><path d="M14 19a6 6 0 0 0-12 0"/><circle cx="8" cy="9" r="4"/><path d="M22 19a6 6 0 0 0-6-6 4 4 0 1 0 0-8"/></svg>
                <span class="text-xs">المناديب</span>
            </button>
            <!-- NEW: Cash (الكاش) Button -->
            <button id="cash-nav-btn" data-page="cash" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                <span class="text-xs">الكاش</span>
            </button>

            <!-- NEW: Debts (المديونيات) Button -->
            <button id="debts-nav-btn" data-page="debts" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <!-- Using a simple wallet/credit icon similar to design -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M21 12v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h14"/><path d="M16 3v4"/><path d="M8 12h.01"/></svg>
                <span class="text-xs">المديونيات</span>
            </button>
            <!-- NEW: Stock Control V2 tab (Default/Active) -->
            <button data-page="stock-control-v2" class="bottom-nav-item active flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-warehouse"><path d="M3 21V8l9-5 9 5v13"/><path d="M13 13h4v8H7v-8h4"/><path d="M7 21h10"/></svg>
                <span class="text-xs">ستوك كنترول </span>
            </button>
            <button data-page="total-bills" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                <span class="text-xs">إجمالي الفواتير</span>
            </button>
            <!-- NEW: Inquiry (استعلام) Button -->
            <button data-page="inquiry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-xs">استعلام</span>
            </button>
            <!-- NEW: Price Lists (قوائم الأسعار) Button -->
            <button data-page="price-lists" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-dollar-sign"><path d="M7 21h10"/><path d="M12 17v-6"/><path d="M9 14h6"/><path d="M12 9h.01"/><path d="M12 3 2 9l10 6 10-6Z"/></svg>
                <span class="text-xs">قوائم الأسعار</span>
            </button>
            <button data-page="settings" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                <span class="text-xs">الإعدادات</span>
            </button>
        </nav>
    </div>

    <!-- ########## MODALS ########## -->

    <!-- CUSTOM CONFIRMATION/ALERT DIALOG -->
    <div id="custom-confirm-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 id="dialog-title" class="text-xl font-bold mb-4">إشعار</h2>
            <p id="dialog-message" class="text-gray-700 mb-6"></p>
            <div id="dialog-actions" class="flex justify-end gap-3">
                <button id="dialog-cancel-btn" type="button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 hidden">إلغاء</button>
                <button id="dialog-confirm-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">تأكيد</button>
            </div>
        </div>
    </div>

    <!-- PRICE HISTORY MODAL -->
    <div id="price-history-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="ph-title" class="text-xl font-bold">سجل الأسعار</h2>
                <button id="ph-close-btn" type="button" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
            </div>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="text-center px-2 py-1">السعر</th>
                            <th class="text-center px-2 py-1">التاريخ</th>
                            <th class="text-right px-2 py-1">ملاحظة</th>
                        </tr>
                    </thead>
                    <tbody id="ph-body"></tbody>
                </table>
            </div>
            <div class="flex items-end gap-2">
                <div class="flex-1">
                    <label class="block text-xs text-gray-600 mb-1">سعر جديد</label>
                    <input id="ph-new-price" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="0.00" />
                </div>
                <div class="flex-[2]">
                    <label class="block text-xs text-gray-600 mb-1">ملاحظة (اختياري)</label>
                    <input id="ph-new-note" class="w-full p-2 border rounded" placeholder="مورد/تفاصيل" />
                </div>
                <button id="ph-add-btn" class="bg-blue-600 text-white px-3 py-2 rounded h-[42px]">إضافة</button>
            </div>
        </div>
    </div>
    
    <!-- LOADING MODAL -->
    <div id="loading-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4">
            <div class="loader"></div>
            <p id="loading-message" class="text-lg font-semibold text-gray-700">جارٍ التحميل...</p>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 class="text-xl font-bold mb-4">تسجيل الدخول</h2>
            <form id="login-modal-form">
                <div class="mb-4">
                    <label for="login-email-modal" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                    <input type="email" id="login-email-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="login-password-modal" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                    <div class="relative">
                        <input type="password" id="login-password-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md pr-10" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password-modal" title="إظهار/إخفاء">👁️</button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-950 font-bold">تسجيل الدخول</button>
            </form>
        </div>
    </div>

    <!-- DEBTS SUMMARY MODAL (المديونيات) -->
    <div id="debts-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right" style="display:none !important">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">ملخص المديونيات</h2>
                <button type="button" onclick="closeModal(document.getElementById('debts-summary-modal'))" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
            </div>

            <div id="debts-summary-content" class="space-y-4">
                <div>
                    <h3 class="font-bold">المديونيات حسب العملاء</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-customer" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">اسم العميل</th>
                                    <th class="text-center px-2 py-1">إجمالي الفواتير</th>
                                    <th class="text-center px-2 py-1">المسدد</th>
                                    <th class="text-center px-2 py-1">المتبقى</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
    
                    <!-- MANAGE LISTS MODAL -->
                    <div id="manage-lists-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">ادارة القوائم</h2>
                                <button type="button" onclick="closeManageListsModal()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
                            </div>

                            <!-- progress area: updated while chunked rendering proceeds -->
                            <div id="manage-lists-progress" class="mb-3 text-sm text-gray-600" style="display:none">جارٍ تحميل العناصر...</div>

                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-bold">المنتجات التامة</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-finished-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">سعر</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">الخامات (مواد إنتاج)</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-raw-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">تكلفة</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">التغليف/التعبئة</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-pack-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">تكلفة</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="pt-3 border-t flex justify-between items-center">
                                    <div class="text-sm text-gray-600">يمكنك حذف أي عنصر من القوائم أو إغلاق النافذة للعودة.</div>
                                    <div>
                                        <button id="manage-export-btn" class="bg-green-600 text-white px-3 py-1 rounded">تصدير القوائم</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <div>
                    <h3 class="font-bold">المديونيات حسب المندوب</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-rep" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">اسم المندوب</th>
                                    <th class="text-center px-2 py-1">إجمالي الفواتير</th>
                                    <th class="text-center px-2 py-1">المسدد</th>
                                    <th class="text-center px-2 py-1">المتبقى</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="pt-3 border-t">
                    <div class="flex justify-between items-center">
                        <div class="font-bold">إجمالي المديونيات (المتبقي)</div>
                        <div id="debts-summary-total" class="font-extrabold text-lg">0 ج.م</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW FULL-SCREEN SALE MODAL (for detailed single entry) -->
    <div id="sale-modal" class="modal modal-hidden fixed inset-0 bg-gray-100 z-30 flex flex-col">
        <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center no-print">
            <h2 id="sale-modal-title" class="text-xl font-bold">إضافة عملية بيع</h2>
            <button id="cancel-sale-btn" class="p-2 hover:bg-blue-700 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        </header>

        <main class="flex-grow p-4 overflow-y-auto">
            <form id="sale-form">
                <input type="hidden" id="sale-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="sale-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                        <select id="sale-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        <input type="text" id="sale-rep-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
                    </div>
                    <div>
                        <label for="sale-customer" class="block text-sm font-medium text-gray-700">العميل</label>
                        <select id="sale-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        <input type="text" id="sale-customer-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
                    </div>
                    <div>
                        <label for="sale-date" class="block text-sm font-medium text-gray-700">تاريخ الفاتورة</label>
                        <input type="date" id="sale-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="sale-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة (يدوي)</label>
                        <input type="number" id="sale-invoice-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="أدخل رقم الفاتورة من الدفتر">
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="sale-items-table min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase w-2/5">المنتج</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الكمية</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">السعر</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الإجمالي</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="sale-items-container" class="bg-white divide-y divide-gray-200">
                            <!-- Sale item rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-sale-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    إضافة منتج آخر
                </button>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="sale-notes" class="block text-sm font-medium text-gray-700">ملاحظات</label>
                        <textarea id="sale-notes" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="sale-status" class="block text-sm font-medium text-gray-700">حالة الدفع</label>
                                <select id="sale-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="paid">مدفوع بالكامل</option>
                                    <option value="due">آجل</option>
                                    <option value="partial">مدفوع جزئياً</option>
                                </select>
                            </div>
                            <div id="paid-amount-container" class="hidden">
                                <label for="sale-paid-amount" class="block text-sm font-medium text-gray-700">المبلغ المدفوع</label>
                                <input type="number" id="sale-paid-amount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            </div>
                        </div>
                        <div>
                            <label for="sale-discount" class="block text-sm font-medium text-gray-700">خصم على الفاتورة (%)</label>
                            <input type="number" id="sale-discount" placeholder="مثال: 2 أو 3.5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                        </div>
                        <div>
                            <label for="sale-addition" class="block text-sm font-medium text-gray-700">إضافة على الفاتورة (%)</label>
                            <input type="number" id="sale-addition" placeholder="مثال: 14" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            <p class="text-xs text-gray-500 mt-1">يتم حسابها كزيادة على الإجمالي الفرعي (قبل الخصم).</p>
                        </div>
                    </div>
                </div>
            </form>
        </main>

        <footer class="p-4 bg-white border-t no-print">
            <div id="sale-summary" class="max-w-md ml-auto text-lg space-y-2">
                <div class="flex justify-between"><span>الإجمالي الفرعي:</span><span id="sale-subtotal-text">0 ج.م</span></div>
                <div class="flex justify-between text-red-600"><span>الخصم:</span><span id="sale-discount-text">0 ج.م</span></div>
                <div class="flex justify-between"><span>ضريبة القيمة المضافة (VAT):</span><span id="sale-vat-text">0 ج.م</span></div>
                <div class="flex justify-between"><span>الاستقطاع (1% إن كان العميل جهة خاضعة للضريبة):</span><span id="sale-withholding-text">0 ج.م</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold text-2xl"><span>إجمالي بعد الضرائب والاقتطاعات:</span><span id="sale-final-text">0 ج.م</span></div>
                <div class="flex justify-between font-bold text-2xl"><span style="opacity:0.75">إجمالي (عرض قديم)</span><span id="sale-total-text" style="opacity:0.6">0 ج.م</span></div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="eta-upload-from-modal-btn" class="hidden bg-purple-700 text-white px-6 py-3 rounded-lg hover:bg-purple-800 font-bold text-lg flex items-center gap-2">
                    <i data-lucide="cloud-upload" class="w-5 h-5"></i>
                    إرسال للضرائب
                </button>
                <button type="button" class="bg-gray-400 text-white px-8 py-3 rounded-lg hover:bg-gray-500 font-bold text-lg" onclick="document.getElementById('sale-modal').classList.add('modal-hidden'); document.getElementById('sale-modal').classList.remove('modal-visible');">خروج</button>
                <button type="submit" form="sale-form" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg">حفظ الفاتورة</button>
            </div>
        </footer>
    </div>
    
    <!-- CUSTOMER MODAL -->
    <div id="customer-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="customer-modal-title" class="text-xl font-bold mb-4">إضافة عميل جديد</h2>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="mb-4">
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">اسم العميل</label>
                    <input type="text" id="customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <!-- NEW: Tax Number Input -->
                <div class="mb-4">
                    <label for="customer-tax-number" class="block text-sm font-medium text-gray-700">الرقم الضريبي</label>
                    <input type="text" id="customer-tax-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="أدخل الرقم الضريبي">
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-phone" class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
                    <input type="tel" id="customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="customer-address" class="block text-sm font-medium text-gray-700">العنوان (رابط خرائط جوجل)</label>
                    <input type="text" id="customer-address" placeholder="الصق رابط خرائط جوجل هنا..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <!-- NEW: Requires Tax Filing Checkbox -->
                <div class="mb-4 flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <input type="checkbox" id="customer-requires-tax" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 ml-2">
                    <label for="customer-requires-tax" class="block text-sm font-medium text-orange-800">العميل يتطلب رفع فواتيره لمنظومة الضرائب</label>
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-price-list" class="block text-sm font-medium text-gray-700">قائمة الأسعار</label>
                    <select id="customer-price-list" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="mb-4">
                    <label for="customer-rep" class="block text-sm font-medium text-gray-700">المندوب المسؤول</label>
                    <select id="customer-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-customer-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ العميل</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PLACEHOLDER MODALS -->
    <div id="rep-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="rep-modal-title" class="text-xl font-bold mb-4">إدارة مندوب</h2>
            <form id="rep-form">
                <input type="hidden" id="rep-id">
                <div class="mb-4"><label for="rep-name" class="block text-sm font-medium text-gray-700">اسم المندوب</label><input type="text" id="rep-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="rep-email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني للمندوب</label><input type="email" id="rep-email" class="mt-1 block w-full p-2 border rounded-md" placeholder="example@email.com" required></div>
                <div class="mb-4"><label for="rep-serial" class="block text-sm font-medium text-gray-700">كود/سيريال</label><input type="text" id="rep-serial" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="mb-4"><label for="rep-target" class="block text-sm font-medium text-gray-700">الهدف الشهري</label><input type="number" id="rep-target" class="mt-1 block w-full p-2 border rounded-md" value="0"></div>
                <div class="mb-4"><label for="rep-next-invoice" class="block text-sm font-medium text-gray-700">رقم الفاتورة القادمة</label><input type="number" id="rep-next-invoice" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-rep-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ المندوب</button></div>
            </form>
        </div>
    </div>

    <div id="product-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="product-modal-title" class="text-xl font-bold mb-4">إدارة منتج</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="mb-4"><label for="product-code" class="block text-sm font-medium text-gray-700">كود المنتج</label><input type="text" id="product-code" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="product-name" class="block text-sm font-medium text-gray-700">اسم المنتج</label><input type="text" id="product-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4">
                    <label for="product-unit-type" class="block text-sm font-medium text-gray-700">نوع الوحدة</label>
                    <select id="product-unit-type" class="mt-1 block w-full p-2 border rounded-md">
                        <option value="weight">موزون (كيلو جرام) - يسمح بالكسور</option>
                        <option value="piece">معبأ (قطعة) - أرقام صحيحة فقط</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">المنتجات الموزونة تسمح بالكسور في المبيعات، المعبأة أرقام صحيحة فقط</p>
                </div>
                <div class="mb-4"><label for="product-price" class="block text-sm font-medium text-gray-700">السعر الافتراضي</label><input type="number" id="product-price" class="mt-1 block w-full p-2 border rounded-md" step="any" required></div>
                <div class="mb-4"><label for="product-category" class="block text-sm font-medium text-gray-700">الفئة (للتصفية)</label><input type="text" id="product-category" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="mb-4"><label for="product-vat-rate" class="block text-sm font-medium text-gray-700">نسبة الضريبة لكل وحدة (%)</label><input type="number" id="product-vat-rate" class="mt-1 block w-full p-2 border rounded-md" step="0.01" value="0"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-product-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ المنتج</button></div>
            </form>
        </div>
    </div>
    
    <div id="price-list-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-4 modal-body">
            <h2 id="price-list-modal-title" class="text-xl font-bold mb-2">إدارة قائمة أسعار</h2>
            <!-- Quick discount box (editable) -->
            <div class="flex items-center justify-start gap-3 mb-3">
                <label for="price-list-discount" class="text-sm text-gray-700">نسبة الخصم السريع</label>
                <input id="price-list-discount" type="text" value="5%" class="w-16 p-1 border rounded text-center font-bold bg-white" title="اكتب نسبة الخصم مثل 5% أو 10%" />
                <span class="text-xs text-gray-500">(سيتم عرض السعر بعد الخصم في العمود الأخير)</span>
            </div>
            <form id="price-list-form">
                <input type="hidden" id="price-list-id">
                <div class="mb-4"><label for="price-list-name" class="block text-sm font-medium text-gray-700">اسم القائمة</label><input type="text" id="price-list-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <!-- Replaced products list with an Excel-like table view (keeps same id to preserve JS bindings) -->
                <div id="price-list-products" class="overflow-x-auto max-h-[60vh] border rounded-lg bg-white">
                    <table id="price-list-products-table" class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-right">م</th>
                                <th class="px-3 py-2 text-center">الكود</th>
                                <th class="px-3 py-2 text-right">اسم الصنف</th>
                                <th class="px-3 py-2 text-center">الوحدة</th>
                                <th class="px-3 py-2 text-center">الباركود</th>
                                <th class="px-3 py-2 text-center">السعر</th>
                                <th class="px-3 py-2 text-center">السعر بعد الخصم</th>
                            </tr>
                        </thead>
                        <tbody id="price-list-products-body" class="bg-white">
                            <tr>
                                <td colspan="7" class="text-center text-gray-500 p-6">جاري تحميل المنتجات...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-price-list-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ القائمة</button></div>
            </form>
        </div>
    </div>

    <!-- NEW PROMOTION MODAL -->
    <div id="promotion-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="promotion-modal-title" class="text-xl font-bold mb-4">إضافة عرض جديد</h2>
            <form id="promotion-form">
                <input type="hidden" id="promotion-id">
                <div class="mb-4">
                    <label for="promotion-name" class="block text-sm font-medium text-gray-700">اسم العرض</label>
                    <input type="text" id="promotion-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="promotion-product" class="block text-sm font-medium text-gray-700">المنتج</label>
                    <select id="promotion-product" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                </div>
                <div id="original-price-display" class="mb-2 text-sm text-gray-600 hidden">
                    السعر الافتراضي للمنتج: <span id="current-product-price" class="font-bold"></span>
                </div>
                 <div class="mb-4">
                    <label for="promotion-price" class="block text-sm font-medium text-gray-700">سعر العرض</label>
                    <input type="number" id="promotion-price" class="mt-1 block w-full p-2 border border-red-400 bg-red-50 rounded-md font-bold" required step="any" placeholder="السعر المخفض">
                </div>
                <div class="mb-4">
                    <label for="promotion-customer-id" class="block text-sm font-medium text-gray-700">العميل المستهدف (اختياري)</label>
                    <select id="promotion-customer-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    <p class="text-xs text-gray-500 mt-1">إذا لم تختر عميلاً، سيتم تطبيق العرض على **جميع** العملاء.</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="promotion-start-date" class="block text-sm font-medium text-gray-700">تاريخ البداية</label>
                        <input type="date" id="promotion-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="promotion-end-date" class="block text-sm font-medium text-gray-700">تاريخ الانتهاء</label>
                        <input type="date" id="promotion-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-promotion-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">حفظ العرض</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END PROMOTION MODAL -->

    <!-- NOTIFICATION (اخطار) MODAL -->
    <div id="notify-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="notify-modal-title" class="text-xl font-bold">اخطار</h2>
                <button type="button" onclick="closeNotifyModal()" class="p-2 hover:bg-gray-100 rounded-md">إغلاق</button>
            </div>
            <form id="notify-form">
                <input type="hidden" id="notify-type" value="">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-sm font-medium">عنوان الإخطار (كلمتين)</label>
                        <input id="notify-title" type="text" maxlength="40" placeholder="مثال: تغيير سعر" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="text-sm font-medium">النوع</label>
                        <select id="notify-type-select" class="mt-1 block w-full p-2 border rounded-md">
                            <option value="prices">تغيير سعر</option>
                            <option value="new-item">صنف جديد</option>
                            <option value="promotions">عرض</option>
                        </select>
                    </div>
                </div>

                <div id="notify-product-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">اختر صنف</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-product"></select>
                </div>

                <div id="notify-promo-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">اختر عرض</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-promo"></select>
                </div>

                <div id="notify-new-item-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">اسم الصنف الجديد</label>
                    <input type="text" id="notify-new-item-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="ادخل اسم الصنف الجديد">
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">قائمة الأصناف والأسعار (صفوف مثل Excel)</label>
                    <div class="mt-2 mb-2 grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-500">اختر عميل (اختياري)</label>
                            <select id="notify-customer" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">خصم عام % (تطبيق على كل الصفوف)</label>
                            <input id="notify-global-discount" type="number" min="0" max="100" step="0.01" placeholder="0" class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <div class="mt-2 mb-2 flex gap-2">
                        <button type="button" id="notify-add-row-btn" class="bg-gray-100 px-3 py-1 rounded-md">إضافة صف</button>
                        <button type="button" id="notify-paste-btn" class="bg-gray-100 px-3 py-1 rounded-md">لصق من Excel</button>
                    </div>
                    <div class="overflow-x-auto border rounded">
                        <table class="min-w-full text-sm" id="notify-rows-table">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-right">كود</th>
                                <th class="px-2 py-2 text-right">صنف</th>
                                <th class="px-2 py-2 text-center">سعر</th>
                                <th class="px-2 py-2 text-center">خصم %</th>
                                <th class="px-2 py-2 text-center">سعر بعد الخصم</th>
                                <th class="px-2 py-2"></th>
                            </tr></thead>
                            <tbody id="notify-rows-body"><tr><td colspan="6" class="text-center text-gray-500 p-4">لا توجد صفوف بعد.</td></tr></tbody>
                        </table>
                    </div>
                    <textarea id="notify-paste-area" placeholder="الصق بيانات Excel هنا (كود\tاسم\tسعر\tخصم%)" class="w-full mt-2 p-2 border rounded-md" style="display:none;min-height:80px"></textarea>
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">نص موجز (اختياري)</label>
                    <input id="notify-short-text" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="سطر قصير يظهر مع الإخطار للمستخدم أو العميل">
                </div>
                <div class="mb-3">
                    <label class="text-sm font-medium">رابط شعار الشركة (اختياري)</label>
                    <input id="notify-logo-url" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="https://example.com/logo.png - سيضاف كرابط في الرسالة">
                    <p class="text-xs text-gray-500 mt-1">ملاحظة: لإرسال صورة فعلياً عبر واتساب تحتاج رفع الصورة على URL متاح ثم استخدام واجهة واتساب لإرسال ميديا. هنا سنضيف رابط الشعار داخل النص.</p>
                </div>

                <div class="flex justify-between items-center gap-2">
                    <div class="flex gap-2">
                        <button type="button" id="notify-share-wa-btn" class="bg-green-600 text-white px-4 py-2 rounded-md">مشاركة على واتساب</button>
                        <button type="button" onclick="closeNotifyModal()" class="bg-gray-300 px-4 py-2 rounded-md">إلغاء</button>
                    </div>
                    <div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">حفظ الإخطار</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    

    <!-- Modals for Reports/Dispatch/Statements (Keeping placeholders for compatibility) -->
    <div id="statement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4"></div>
    <div id="date-range-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        	<!-- Date Range Form / Statement Customer List -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-xl font-bold mb-4">كشف حساب يدوي</h2>
            <form id="date-range-form">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">تاريخ البداية</label>
                        <input type="date" id="start-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">تاريخ الانتهاء</label>
                        <input type="date" id="end-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">تصفية حسب صنف:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center"><input type="radio" name="product-category" value="all" checked class="text-blue-600 focus:ring-blue-500 ml-1"> الكل</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="dairy" class="text-blue-600 focus:ring-blue-500 ml-1"> ألبان</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="multi" class="text-blue-600 focus:ring-blue-500 ml-1"> مالتي</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="supermarket-chain-filter" class="block text-sm font-medium text-gray-700">تصفية حسب السلسلة</label>
                    <select id="supermarket-chain-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="all">جميع الفروع</option>
                        <option value="exception">اكسبشن ماركت</option>
                        <option value="awladragab">اولاد رجب</option>
                        <option value="samysalama">سامي سلامه</option>
                        <option value="gomlamarket">جملة ماركت</option>
                        <option value="dreams">دريمز</option>
                    </select>
                </div>
                <h3 class="text-lg font-bold mb-3 border-t pt-4">اختر العملاء المطلوبين:</h3>
                <input type="text" id="statement-customer-search" placeholder="ابحث باسم العميل..." class="w-full p-2 border rounded-md mb-3">
                <div id="statement-customer-list" class="space-y-1 max-h-48 overflow-y-auto border p-2 rounded-md bg-gray-50">
                    <!-- Customers will be injected here -->
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-date-range-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">إنشاء كشف الحساب</button>
                </div>
            </form>
        </div>
    </div>
    <div id="dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <h2 id="dispatch-modal-title" class="text-xl font-bold mb-4">إضافة إذن استلام بضاعة</h2>
            <form id="dispatch-note-form">
                <input type="hidden" id="dispatch-note-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="dispatch-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                        <select id="dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="dispatch-date" class="block text-sm font-medium text-gray-700">تاريخ الإذن</label>
                        <input type="date" id="dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>

                <div class="overflow-x-auto bg-gray-50 rounded-lg shadow mt-4 border">
                    <table id="dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">المنتج</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مستلم (كمية)</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع سليم</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع تالف</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مجاني</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="dispatch-items-container" class="divide-y divide-gray-200">
                            <!-- Dispatch item rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-dispatch-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    إضافة صنف آخر للإذن
                </button>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-dispatch-note-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ الإذن</button>
                </div>
            </form>
        </div>
    </div>
    <div id="view-dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Content injected dynamically -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <div id="dispatch-note-view-content">
                <!-- Report details will be injected here -->
            </div>
            <div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
                <button id="close-view-dispatch-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
                <button id="print-dispatch-btn" onclick="printSection('dispatch-note-view-content')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                    <span>طباعة (Ctrl+P)</span>
                </button>
            </div>
        </div>
    </div>
    <div id="settlement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Adding main content div inside modal placeholder for consistency -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6">
            <h2 id="settlement-modal-title" class="text-xl font-bold mb-4">تسوية مرتجعات إذن الاستلام</h2>
            <div id="settlement-content">
                <!-- Settlement report will be generated here -->
                <p class="text-center text-gray-500 mt-2">يتم تحميل بيانات التسوية...</p>
            </div>
            <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('settlement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="reconciliation-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"></div>
    <div id="rep-sales-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body">
             <h2 id="rep-sales-summary-title" class="text-xl font-bold mb-4">كشف حساب المندوب</h2>
             <div id="rep-sales-summary-content">
                 <!-- Rep Statement content injected dynamically -->
             </div>
             <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('rep-sales-summary-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="daily-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="customer-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="ai-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>

    <!-- NEW: Image Preview Modal -->
    <div id="image-preview-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <h2 class="text-xl font-bold mb-4">معاينة الصورة</h2>
            <p class="text-sm text-gray-600 mb-4">يمكنك الآن نسخ الصورة بالضغط عليها بالزر الأيمن (أو الضغط المطول في الجوال) واختيار "نسخ الصورة"، أو تحميلها على جهازك.</p>
            <div id="image-preview-container" class="mb-4 border p-2 bg-gray-100 max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal(document.getElementById('image-preview-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
                <button id="download-image-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">تحميل الصورة</button>
            </div>
        </div>
    </div>


    <!-- Removed duplicate Firebase SDK (9.6.10) to avoid double init -->

    


    <!-- Lucide Icons - Direct CDN Link -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        // Initialize Lucide icons globally
        document.addEventListener('DOMContentLoaded', function() {
            if (window.lucide) {
                window.lucide.createIcons();
            }
        });
        
        // Re-initialize icons when costs-v2 page is shown
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-page="costs-v2"]');
            if (btn && window.lucide) {
                setTimeout(() => {
                    window.lucide.createIcons();
                }, 200);
            }
        });
    </script>
    
    <!-- لا يوجد كود auto-start offline هنا في النسخة الأصلية -->
    
        <!-- Claude client helper: call Netlify proxy at /api/claude -->
        
    <!-- Add Finished Product Modal -->
    <div id="modal-add-finished-product" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">إضافة منتج نهائي</h3>
            <form id="form-add-finished-product" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">كود المنتج</label>
                    <input type="text" id="finished-product-code" class="w-full p-2 border rounded-md" placeholder="مثال: P-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">اسم المنتج</label>
                    <input type="text" id="finished-product-name" class="w-full p-2 border rounded-md" placeholder="مثال: لبن زبادي" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">الوحدة</label>
                    <input type="text" id="finished-product-unit" class="w-full p-2 border rounded-md" placeholder="مثال: قطعة" value="قطعة">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">السعر (اختياري)</label>
                    <input type="number" id="finished-product-price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-finished-product').classList.add('hidden')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Raw Material Modal (force-replaced to include invoice/tax fields) -->
    <div id="modal-add-raw-material" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">إضافة خامة</h3>
            <form id="form-add-raw-material" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium mb-1">كود الخامة</label>
                    <input type="text" id="raw-material-code" name="raw_material_code" class="w-full p-2 border rounded-md" placeholder="مثال: R-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">اسم الخامة</label>
                    <input type="text" id="raw-material-name" name="raw_material_name" class="w-full p-2 border rounded-md" placeholder="مثال: لبن" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">الوحدة</label>
                    <input type="text" id="raw-material-unit" name="raw_material_unit" class="w-full p-2 border rounded-md" placeholder="مثال: كجم" value="كجم">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">سعر الوحدة (سعر الشراء الحالي)</label>
                    <input type="number" id="raw-material-unit_price" name="raw_material_unit_price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">الكمية</label>
                    <input type="number" id="raw-material-qty" name="raw_material_qty" class="w-full p-2 border rounded-md" placeholder="1" step="any" value="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">إجمالي التكلفة</label>
                    <input type="text" id="raw-material-total_cost" name="raw_material_total_cost" class="w-full p-2 border rounded-md bg-gray-50" readonly value="0">
                </div>
                <div>
                    <label class="inline-flex items-center gap-2">
                        <input type="checkbox" id="raw-material-is_tax_invoice" name="raw_material_is_tax_invoice" class="h-4 w-4">
                        <span class="text-sm">فاتورة ضريبية؟ (Tax Invoice?)</span>
                    </label>
                </div>
                <div class="pt-2 border-t">
                    <h4 class="text-sm font-medium">تفاصيل المورد والفاتورة</h4>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">رقم ضريبي للمورد (Vendor Tax ID)</label>
                        <input type="text" id="raw-material-vendor_tax_id" name="raw_material_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="مثال: 123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">رقم الفاتورة</label>
                        <input type="text" id="raw-material-invoice_number" name="raw_material_invoice_number" class="w-full p-2 border rounded-md" placeholder="مثال: INV-001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">تاريخ الفاتورة</label>
                        <input type="date" id="raw-material-invoice_date" name="raw_material_invoice_date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">قيمة الضريبة (VAT/Tax Value)</label>
                        <input type="number" id="raw-material-vat_value" name="raw_material_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">صورة الفاتورة (Invoice Image)</label>
                        <input type="file" id="raw-material-invoice_image" name="raw_material_invoice_image" accept="image/*,application/pdf" class="w-full">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-raw-material').classList.add('hidden')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Packaging Modal (force-replaced to include invoice/tax fields) -->
    <div id="modal-add-packaging" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">إضافة مادة تعبئة</h3>
            <form id="form-add-packaging" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium mb-1">كود المادة</label>
                    <input type="text" id="packaging-code" name="packaging_code" class="w-full p-2 border rounded-md" placeholder="مثال: PKG-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">اسم المادة</label>
                    <input type="text" id="packaging-name" name="packaging_name" class="w-full p-2 border rounded-md" placeholder="مثال: علبة بلاستيكية" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">الوحدة</label>
                    <input type="text" id="packaging-unit" name="packaging_unit" class="w-full p-2 border rounded-md" placeholder="مثال: قطعة" value="قطعة">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">التكلفة (اختياري)</label>
                    <input type="number" id="packaging-cost" name="packaging_cost" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div class="pt-2 border-t">
                    <h4 class="text-sm font-medium">تفاصيل المورد والفاتورة</h4>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">رقم ضريبي للمورد (Vendor Tax ID)</label>
                        <input type="text" id="packaging-vendor_tax_id" name="packaging_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="مثال: 123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">رقم الفاتورة</label>
                        <input type="text" id="packaging-invoice_number" name="packaging_invoice_number" class="w-full p-2 border rounded-md" placeholder="مثال: INV-001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">تاريخ الفاتورة</label>
                        <input type="date" id="packaging-invoice_date" name="packaging_invoice_date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">قيمة الضريبة (VAT/Tax Value)</label>
                        <input type="number" id="packaging-vat_value" name="packaging_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">صورة الفاتورة (Invoice Image)</label>
                        <input type="file" id="packaging-invoice_image" name="packaging_invoice_image" accept="image/*,application/pdf" class="w-full">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-packaging').classList.add('hidden')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    

    <!-- Modal: Create New Production Run -->
    <div id="modal-create-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
            <h3 class="text-lg font-bold mb-4">إنشاء تشغيلة جديدة</h3>
            <form id="form-create-production" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">اختر الوصفة</label>
                    <select id="production-recipe-select" class="w-full p-2 border rounded-md" required>
                        <option value="">-- اختر وصفة --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">سيتم اختيار المنتج تلقائياً من الوصفة</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">تاريخ البدء</label>
                        <input type="date" id="production-start-date" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">الكمية المتوقعة (اختياري)</label>
                        <input type="number" id="production-expected-qty" class="w-full p-2 border rounded-md" placeholder="سيتم تحديثه لاحقاً" step="0.01">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">ملاحظات</label>
                    <textarea id="production-notes" class="w-full p-2 border rounded-md" rows="3" placeholder="مثال: ملاحظات عن الإنتاج..."></textarea>
                </div>

                <div class="bg-blue-50 border border-blue-200 p-3 rounded-md text-sm text-blue-800">
                    <strong>ملاحظة:</strong> يمكنك تحديث الكمية النهائية والحالة بعد الانتهاء من الإنتاج (24 ساعة تقريباً).
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">إنشاء التشغيلة</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-create-production').classList.remove('modal-visible'); document.getElementById('modal-create-production').classList.add('modal-hidden');">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Production Run -->
    <div id="modal-edit-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
            <h3 class="text-lg font-bold mb-4">تحديث التشغيلة</h3>
            <form id="form-edit-production" class="space-y-4">
                <input type="hidden" id="edit-production-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">الكمية النهائية</label>
                        <input type="number" id="edit-production-final-qty" class="w-full p-2 border rounded-md" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">حالة التشغيلة</label>
                        <select id="edit-production-status" class="w-full p-2 border rounded-md" required>
                            <option value="in-progress">قيد الإنتاج</option>
                            <option value="completed">منتهية</option>
                            <option value="cancelled">ملغاة</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">سعر البيع للوحدة (اختياري)</label>
                    <input type="number" id="edit-production-sell-price" class="w-full p-2 border rounded-md" step="0.01" placeholder="0">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">ملاحظات</label>
                    <textarea id="edit-production-notes" class="w-full p-2 border rounded-md" rows="3"></textarea>
                </div>

                <div id="production-summary" class="bg-gray-50 border border-gray-200 p-3 rounded-md text-sm">
                    <p><strong>التكلفة الإجمالية:</strong> <span id="summary-total-cost">0</span></p>
                    <p><strong>إجمالي البيع:</strong> <span id="summary-total-revenue">0</span></p>
                    <p><strong>الربح/الخسارة:</strong> <span id="summary-profit-loss" class="font-bold">0</span></p>
                </div>

                <div class="flex gap-2">
                    <button type="button" id="btn-save-production-update" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ التحديثات</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-edit-production').classList.remove('modal-visible'); document.getElementById('modal-edit-production').classList.add('modal-hidden');">إلغاء</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Bluetooth Printer Module -->
    <script src="src/utils/bluetooth-printer.js?v=2" charset="UTF-8"></script>
    
    <!-- New Advanced Print System -->
    <script src="src/utils/new-print-system.js?v=1.0.1" charset="UTF-8"></script>
    
    <!-- Authentication System - must load before firebase-init -->
    <script src="src/services/auth-service.js?v=1" charset="UTF-8"></script>

    <!-- Taxes module (defines window.initTaxesPage) -->
    <script src="taxes.js?v=1" charset="UTF-8"></script>
    
    <!-- Main application logic - must load before firebase-init -->
    <script src="js/inline-scripts.js?v=12" charset="UTF-8"></script>
    
    <!-- Realtime sync services -->
    <script src="src/services/realtime-sync.js?v=1" charset="UTF-8"></script>
    
    <!-- ✅ CLEANED: ترتيب صحيح للسكريبتات -->
    
    <!-- 1. Firebase initialization (MUST BE FIRST) -->
    <script src="src/services/firebase-init.js?v=1" charset="UTF-8"></script>
    
    <!-- 2. Core initialization (before main logic) -->
    <script src="src/core/init.js?v=10" charset="UTF-8"></script>
    
    <!-- 3. Main app logic -->
    <script src="js/main.js?v=20260108073000" charset="UTF-8" defer></script>
    
    <!-- ⚠️ REMOVED: reports-logic.js (missing file - 404 error) -->
    <!-- ⚠️ REMOVED: sales-logic.js (missing file - 404 error) -->
    <!-- ⚠️ REMOVED: taxes.js (loads after login only via inline-scripts.js) -->

    <!-- Shared formatters (load before inline-scripts) -->
    <script src="js/formatters.js?v=1" charset="UTF-8"></script>
        <!-- Global currency formatter shim to prevent early-call errors -->
        <script charset="UTF-8">
            (function(){
                try {
                    if (typeof window.formatCurrency !== 'function') {
                        window.formatCurrency = function(n){
                            try {
                                return new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP', maximumFractionDigits: 2 }).format(Number(n||0));
                            } catch(e){
                                var num = Number(n||0);
                                return (num.toFixed ? num.toFixed(2) : String(num)) + ' ج.م';
                            }
                        };
                    }
                    // Create alias for scripts that reference bare name inside IIFEs
                    if (typeof window.formatCurrency === 'function') {
                        try { formatCurrency = window.formatCurrency; } catch(e){}
                        // Also provide formatMoney fallback via formatCurrency
                        if (typeof window.formatMoney !== 'function') {
                            window.formatMoney = function(n){ return window.formatCurrency(n); };
                        }
                    }
                } catch(_){ /* ignore */ }
            })();
        </script>
    <!-- UI core (icons + modal helpers) -->
    <script src="js/ui-core.js?v=1" charset="UTF-8"></script>
    <!-- Helper utilities (findCustomer, findProduct, findRep) -->
    <script src="src/utils/helpers-extra.js?v=1" charset="UTF-8"></script>
    <!-- Staff/Mandoob services -->
    <script src="js/staff-services.js?v=1" charset="UTF-8"></script>
    <!-- Reports/Charts/Export services -->
    <script src="js/reports-services.js?v=1" charset="UTF-8"></script>
    
    <!-- Reports UI (Chart rendering & export extracted) -->
    <script src="js/reports-ui.js?v=1" charset="UTF-8"></script>

    <!-- Application Core Services (Cache-first architecture) -->
    <script src="js/app-services.js?v=1" charset="UTF-8"></script>

    <!-- Printer Services (Bluetooth + PDF) -->
    <script src="js/printer-services.js?v=1" charset="UTF-8"></script>

    <!-- Stock Control V2 Logic -->
    <script src="js/stock-control-v2.js?v=2" charset="UTF-8"></script>

    <!-- Stock UI (Rendering & UI helpers extracted from V2) -->
    <script src="js/stock-ui.js?v=1" charset="UTF-8"></script>

    <!-- Costs V2 Logic (DISABLED - using costs-v2-integrated.js instead) -->
    <!-- <script src="js/costs-v2-logic.js?v=1" charset="UTF-8"></script> -->

    <!-- Costs V2 Integrated (نظام التكاليف 2.0 المدمج) -->
    <script src="js/costs-v2-integrated.js?v=4" charset="UTF-8"></script>

    <!-- LOGIN & AUTH HANDLER -->
    <script>
    (function() {
        // Initialize Costs V2 when page loads
        window.addEventListener('load', function() {
            if (window.CostsV2 && typeof window.CostsV2.init === 'function') {
                window.CostsV2.init();
            }
        });
        
        // Handle login form submission
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!window.auth) {
                    alert('Firebase not initialized');
                    return;
                }
                
                window.auth.signInWithEmailAndPassword(email, password)
                    .then(function(result) {
                        console.log('✅ Login successful:', result.user.email);
                        // Hide login, show app
                        document.getElementById('login-page').style.display = 'none';
                        document.getElementById('app-container').style.display = 'flex';
                        // Show dashboard
                        if (typeof showPage === 'function') {
                            showPage('page-dashboard');
                        }
                    })
                    .catch(function(error) {
                        console.error('Login error:', error);
                        alert('خطأ في تسجيل الدخول: ' + error.message);
                    });
            });
        }
        
        // Handle toggle password visibility
        const toggleBtns = document.querySelectorAll('.toggle-password');
        toggleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const inputId = this.getAttribute('data-target');
                const input = document.getElementById(inputId);
                if (input.type === 'password') {
                    input.type = 'text';
                    this.textContent = '🙈';
                } else {
                    input.type = 'password';
                    this.textContent = '👁️';
                }
            });
        });
    })();
    </script>

