<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delente ERP - ???? ????? ???????</title>
    <!-- Global Error Handler for Mobile Debugging -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            try {
                const fullMsg = msg + '\n\nFile: ' + url + '\nLine: ' + line + ':' + col;
                const errorText = (error && error.stack) ? error.stack : fullMsg;
                
                // Show alert with error details
                alert('?? Mobile Error Detected:\n\n' + fullMsg + '\n\n' + (error && error.stack ? error.stack.substring(0, 200) : ''));
                
                // Replace page with error display
                document.body.innerHTML = '<div style="color:red; background:white; font-size:18px; padding:20px; font-family:monospace; white-space:pre-wrap; direction:ltr; text-align:left;"><strong>?? ERROR DETECTED:</strong>\n\n' + fullMsg + '\n\n<strong>Stack:</strong>\n' + (error && error.stack ? error.stack : 'No stack trace') + '</div>';
                document.body.style.margin = '0';
                document.body.style.height = '100vh';
            } catch(e) {
                document.body.innerHTML = '<div style="color:red; background:white; padding:20px;">Critical Error Handler Failed</div>';
            }
            return true; // Suppress default error handling
        };
    </script>
    <style id="fallback-hidden-css">
        /* Fallback: ensure elements with class 'hidden' are actually hidden
           even if Tailwind fails to load on some devices/browsers */
        .hidden { display: none !important; }
    </style>
    <script>
                // ???? ????? ?? ?????? ???? ?? ?? ???????
                function updateGlobalClock() {
                    const clockEl = document.getElementById('global-clock-time');
                    if (!clockEl) return;
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const dateStr = now.toLocaleDateString('ar-EG');
                    clockEl.textContent = `${dateStr} - ${timeStr}`;
                }
                setInterval(updateGlobalClock, 1000);
                document.addEventListener('DOMContentLoaded', updateGlobalClock);
                // raw/pack grids
                document.addEventListener('DOMContentLoaded', function(){
                    try {
                        window._rawGridState = JSON.parse(localStorage.getItem('raw_materials_grid') || '{}');
                    } catch(e){ window._rawGridState = {}; }
                    try {
                        window._packGridState = JSON.parse(localStorage.getItem('packaging_grid') || '{}');
                    } catch(e){ window._packGridState = {}; }
                    console.debug('Loaded State:', { raw: window._rawGridState, pack: window._packGridState });
                    if (!window.saveRawGridStateNow){
                        window.saveRawGridStateNow = async function(){ try { localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState || {})); } catch(e){} try { if (window.db) await db.collection('settings').doc('costLists').set({ rawGridState: window._rawGridState, updatedAt: serverTs() }, { merge:true }); } catch(e){} };
                        window.debouncedRawSave = function(){ clearTimeout(window._rawGridSaveTimer); window._rawGridSaveTimer = setTimeout(window.saveRawGridStateNow, 700); };
                        window.savePackGridStateNow = async function(){ try { localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState || {})); } catch(e){} try { if (window.db) await db.collection('settings').doc('costLists').set({ packGridState: window._packGridState, updatedAt: serverTs() }, { merge:true }); } catch(e){} };
                        window.debouncedPackSave = function(){ clearTimeout(window._packGridSaveTimer); window._packGridSaveTimer = setTimeout(window.savePackGridStateNow, 700); };
                    }
                });
        window.addEventListener('load', function() {
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
            }
            var dashboard = document.getElementById('page-dashboard');
            if (dashboard) dashboard.classList.add('active');
            var navItems = document.getElementsByClassName('bottom-nav-item');
            for (var j = 0; j < navItems.length; j++) {
                navItems[j].classList.remove('active');
                if (navItems[j].getAttribute('data-page') === 'dashboard') {
                    navItems[j].classList.add('active');
                }
            }
        });
    </script>
        <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas for converting receipts to images for thermal printers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Note: Using the Tailwind CDN is fine for development only. For production install Tailwind as a PostCSS plugin
         or use the Tailwind CLI per https://tailwindcss.com/docs/installation -->
    <script>
        // Safe fallback for updateIcons to avoid ReferenceError if other scripts call it before icon library loads.
        // If you use Lucide or a similar icon replacer, it will call its replace/scan method when available.
        window.updateIcons = (function(){
            let scheduled = false;
            return function(){
                if (scheduled) return; // debounce rapid calls
                scheduled = true;
                requestAnimationFrame(() => {
                    try {
                        if (window.lucide && typeof window.lucide.replace === 'function') {
                            window.lucide.replace();
                        } else if (window.Lucide && typeof window.Lucide.replace === 'function') {
                            window.Lucide.replace();
                        }
                    } catch(e) { /* silent */ }
                    scheduled = false;
                });
            };
        })();

        
    </script>
    <script>
        // Global safe guards to prevent early crashes
        // ===== Render Scheduler (performance) =====
        (function(){
            const scheduled = new Map();
            const lastRun = new Map();
            const MIN_INTERVAL = 80; // ms between same-key renders
            function runTask(key, fn){
                scheduled.delete(key);
                try {
                    const start = performance.now();
                    fn();
                    lastRun.set(key, start);
                } catch(e){ console.warn('render task failed', key, e); }
            }
            window.scheduleRender = function(key, fn){
                try {
                    if (typeof key !== 'string') key = 'anon';
                    const now = performance.now();
                    const prev = lastRun.get(key) || 0;
                    if (scheduled.has(key)) return; // already queued
                    if ((now - prev) < MIN_INTERVAL) { // defer a bit more to batch
                        const handle = setTimeout(()=>{ scheduled.delete(key); window.requestIdleCallback ? requestIdleCallback(()=>runTask(key, fn), { timeout: 300 }) : requestAnimationFrame(()=>runTask(key, fn)); }, MIN_INTERVAL);
                        scheduled.set(key, handle);
                        return;
                    }
                    const handle = window.requestIdleCallback ? requestIdleCallback(()=>runTask(key, fn), { timeout: 300 }) : requestAnimationFrame(()=>runTask(key, fn));
                    scheduled.set(key, handle);
                } catch(e){ try { fn(); } catch(_){} }
            };
        })();
        (function(){
            try { window.state = window.state || {}; } catch(e) { window.state = {}; }
            if (typeof window.formatCurrency !== 'function') {
                window.formatCurrency = function(n){ try { return new Intl.NumberFormat('ar-EG',{style:'currency',currency:'EGP',maximumFractionDigits:2}).format(Number(n||0)); } catch(e){ return (Number(n||0)).toFixed(2)+' ?.?'; } };
            }
            if (typeof window.findCustomer !== 'function') {
                window.findCustomer = function(id){ try { return (state.customers||[]).find(c => (c.id||c._id) === id) || null; } catch(e){ return null; } };
            }
            if (typeof window.updateCustomerList !== 'function') {
                window.updateCustomerList = function(){ /* noop safety */ };
            }
            if (typeof window.DEFAULT_PRODUCTS === 'undefined') {
                window.DEFAULT_PRODUCTS = [];
            }
            // Default company logo URL (used when no custom URL is saved)
            if (typeof window.DEFAULT_COMPANY_LOGO_URL === 'undefined') {
                window.DEFAULT_COMPANY_LOGO_URL = 'https://i.ibb.co/YT4114YW/image.jpg';
            }
        })();
    </script>
    <!-- Library to convert HTML to Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- NEW: Include Chart.js library for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Lucide Icons (before other scripts) -->

    <!-- Global error overlay to surface runtime issues to the user -->
    <script>
        (function(){
            function showOverlay(msg, stack){
                try {
                    var ov = document.getElementById('error-overlay');
                    if (!ov) {
                        ov = document.createElement('div');
                        ov.id = 'error-overlay';
                        ov.style.position = 'fixed';
                        ov.style.top = '0';
                        ov.style.left = '0';
                        ov.style.right = '0';
                        ov.style.zIndex = '99999';
                        ov.style.background = 'rgba(220,38,38,0.95)';
                        ov.style.color = '#fff';
                        ov.style.fontFamily = 'Cairo, sans-serif';
                        ov.style.direction = 'rtl';
                        ov.style.padding = '8px 12px';
                        ov.style.fontSize = '12px';
                        ov.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">'
                                     + '<div><strong>??? ??? ?? ???????:</strong> <span id="err-msg"></span><div id="err-stack" style="white-space:pre-wrap;opacity:.9;margin-top:4px"></div></div>'
                                     + '<button id="err-close" style="background:#111;border:0;color:#fff;padding:6px 10px;border-radius:6px">?????</button>'
                                     + '</div>';
                        document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(ov); });
                        if (document.readyState === 'complete' || document.readyState === 'interactive') { try { document.body.appendChild(ov); } catch(_){} }
                        document.addEventListener('click', function(e){ if (e.target && e.target.id === 'err-close'){ try { ov.remove(); } catch(_){} } });
                    }
                    var m = ov.querySelector('#err-msg'); if (m) m.textContent = msg || '';
                    var s = ov.querySelector('#err-stack'); if (s) s.textContent = stack || '';
                } catch(e){}
            }
            window.addEventListener('error', function(e){
                try {
                    showOverlay(String(e && e.message) || 'Runtime error', (e && e.error && e.error.stack) || e.stack || '');
                } catch(_){}
            });

        // ===== Bluetooth printer helpers (robust connect + per-invoice print) =====
        (function(){
            // Known UUIDs for XPrinter and generic ESC/POS
            const PRINTER_CONFIG = {
                services: [
                    '000018f0-0000-1000-8000-00805f9b34fb',
                    'e7810a71-73ae-499d-8c15-faa9aef0c3f2',
                    '49535343-fe7d-4ae5-8fa9-9fafd205e455'
                ],
                characteristics: [
                    '00002af1-0000-1000-8000-00805f9b34fb',
                    'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f',
                    '49535343-8841-43f4-a8d4-ecbe34729bb3'
                ]
            };
            window.printDevice = null;
            window.printCharacteristic = null;

            window.connectToPrinter = async function(){
                try {
                    if (!('bluetooth' in navigator)) throw new Error('Web Bluetooth not supported in this browser');
                    console.log('Searching for XPrinter...');
                    const device = await navigator.bluetooth.requestDevice({ filters: [{ services: PRINTER_CONFIG.services }], optionalServices: PRINTER_CONFIG.services });
                    const server = await device.gatt.connect();
                    console.log('Connected to GATT');

                    // Find a service that exists on the device
                    let service = null;
                    for (const uuid of PRINTER_CONFIG.services){
                        try { service = await server.getPrimaryService(uuid); console.log('Found Service:', uuid); break; } catch(e) { /* continue */ }
                    }
                    if (!service) throw new Error('No matching service found.');

                    // Try known characteristic UUIDs first
                    let char = null;
                    try {
                        for (const uuid of PRINTER_CONFIG.characteristics){
                            try { char = await service.getCharacteristic(uuid); if (char) break; } catch(e) {}
                        }
                    } catch(e){ /* ignore */ }

                    // If still not found, inspect any characteristic and pick a writable one
                    if (!char){
                        const potentialChars = await service.getCharacteristics();
                        char = potentialChars.find(c => c.properties && (c.properties.write || c.properties.writeWithoutResponse));
                    }

                    if (!char) throw new Error('Write Characteristic NOT found!');

                    window.printCharacteristic = char;
                    window.printDevice = device;
                    alert('? Connected to XPrinter successfully!');
                    return { device, characteristic: char };
                } catch (error){
                    console.error('connectToPrinter failed', error);
                    throw error;
                }
            };

            window.printInvoiceBluetooth = async function(sale){
                try {
                    if (!sale) { alert('?? ??? ????? ?????? ???????'); return; }
                    // Build payload using existing helper if present
                    const payload = (typeof buildEscPosReceipt === 'function') ? buildEscPosReceipt(sale) : (function(){
                        // fallback simple text
                        const enc = new TextEncoder();
                        return enc.encode('Invoice #'+(sale.invoiceNumber||sale.id)+'\nTotal: '+(sale.total||0)+'\n');
                    })();

                    if (!window.printCharacteristic){
                        try { await window.connectToPrinter(); } catch(e){ alert('??? ??????? ????????: '+(e&&e.message)); return; }
                    }

                    const char = window.printCharacteristic;
                    if (!char) { alert('?? ???? ????? ????? ???????'); return; }

                    // Write in chunks
                    const CHUNK = 180; // larger chunk for modern devices
                    for (let i=0;i<payload.length;i+=CHUNK){
                        const slice = payload.slice(i, i+CHUNK);
                        try {
                            if (char.properties.writeWithoutResponse) await char.writeValueWithoutResponse(slice);
                            else await char.writeValue(slice);
                        } catch(e){
                            // try writeValue as fallback
                            try { await char.writeValue(slice); } catch(er){ throw er; }
                        }
                        await new Promise(r=>setTimeout(r, 30));
                    }
                    alert('?? ????? ???????? ??????? ??? ????????.');
                } catch(e){ console.error('printInvoiceBluetooth failed', e); alert('??? ??????? ??? ????????: '+(e&&e.message)); }
            };
        })();
            window.addEventListener('unhandledrejection', function(e){
                try {
                    var reason = e && e.reason; var msg = '';
                    if (typeof reason === 'string') msg = reason; else if (reason && reason.message) msg = reason.message; else msg = 'Unhandled rejection';
                    var stack = reason && reason.stack ? reason.stack : '';
                    showOverlay(msg, stack);
                } catch(_){}
            });
        })();
    </script>

    <!-- Leaflet for interactive maps (CDN) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

        <!-- ?? ????? ???????? ??? ?????? ???????? ??????? (shared/public_app_state) ??????? -->

        <!-- Firebase SDK (compat build for simple global usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

        <!-- Firebase Config injected from user-provided settings (modular snippet adapted) -->
        <script>
            window.FIREBASE_CONFIG = {
                apiKey: "AIzaSyDLmZPE9teCYf2rMXd1AwT5yq4xlRSHcSk",
                authDomain: "delente-business.firebaseapp.com",
                projectId: "delente-business",
                // ? ????? ??? ????? ???????: ????? ?????? ???? <project-id>.appspot.com
                // ?????? ??????? "delente-business.firebasestorage.app" ???? ????? CORS ???? ????? ???????
                storageBucket: "delente-business.appspot.com",
                messagingSenderId: "646706509650",
                appId: "1:646706509650:web:1eaa4b94d2990b6be9ac8b"
            };
        </script>

    <!-- Firebase Configuration & Authentication System -->
    <script>
        // ???? ????? ?????????? ????????? ?? Firebase
        // (Firebase Config ????? ?? ????? ????? - DOMContentLoaded)
        const AuthSystem = {
            // ????? ????? ?????? ??????????
            USERS_KEY: 'app_users',
            CURRENT_USER_KEY: 'app_current_user',
            
            // ?????? ??? ???? ?????????? ????????
            getAllUsers() {
                try {
                    const data = localStorage.getItem(this.USERS_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.warn('Error loading users:', e);
                    return [];
                }
            },
            
            // ??? ????? ??????????
            saveUsers(users) {
                try {
                    localStorage.setItem(this.USERS_KEY, JSON.stringify(users));
                } catch (e) {
                    console.error('Error saving users:', e);
                }
            },
            
            // ????? ?? ?????? ??????? ??????????
            findUserByEmail(email) {
                const users = this.getAllUsers();
                return users.find(u => u.email === email.toLowerCase());
            },
            
            // ??????? (????? ???? ????)
            async register(email, password, name) {
                if (!window.auth) return { success: false, message: 'Firebase Auth ??? ????' };
                try {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    try { await cred.user.updateProfile({ displayName: name }); } catch(e) {}
                    try {
                        if (window.db) {
                            await db.collection('users').doc(cred.user.uid).set({
                                email: email.toLowerCase(),
                                name: name,
                                createdAt: new Date().toISOString()
                            }, { merge: true });
                        }
                    } catch(e) { console.warn('?????: ??? ??? ????? ???????? ?? Firestore', e); }
                    const newUser = { id: cred.user.uid, email: email.toLowerCase(), name, firebase: true, createdAt: new Date().toISOString(), data: {} };
                    this.setCurrentUser(newUser);
                    return { success: true, message: '?? ????? ?????? ?????', user: newUser };
                } catch (err) {
                    let msg = '??? ????? ??????';
                    if (err.code === 'auth/email-already-in-use') msg = '?????? ?????? ??????';
                    else if (err.code === 'auth/weak-password') msg = '???? ?????? ?????';
                    else if (err.code === 'auth/invalid-email') msg = '?????? ??? ????';
                    return { success: false, message: msg };
                }
            },
            
            // ????? ??????
            async login(email, password) {
                if (!window.auth) return { success: false, message: 'Firebase Auth ??? ????' };
                try {
                    const cred = await auth.signInWithEmailAndPassword(email, password);
                    const displayName = cred.user.displayName || (cred.user.email ? cred.user.email.split('@')[0] : '??????');
                    const currentUser = { id: cred.user.uid, email: cred.user.email.toLowerCase(), name: displayName, firebase: true, data: {} };
                    this.setCurrentUser(currentUser);
                    return { success: true, message: '?? ?????? ?????', user: currentUser };
                } catch (err) {
                    let msg = '??? ??????';
                    if (err.code === 'auth/wrong-password') msg = '???? ?????? ??? ?????';
                    else if (err.code === 'auth/user-not-found') msg = '???????? ??? ?????';
                    else if (err.code === 'auth/invalid-email') msg = '?????? ??? ????';
                    else if (err.code === 'auth/too-many-requests') msg = '??????? ?????? ????? ??????';
                    return { success: false, message: msg };
                }
            },
            
            // ??? ???????? ??????
            setCurrentUser(user) {
                try {
                    localStorage.setItem(this.CURRENT_USER_KEY, JSON.stringify(user));
                } catch (e) {
                    console.error('Error saving current user:', e);
                }
            },
            
            // ?????? ??? ???????? ??????
            getCurrentUser() {
                try {
                    const data = localStorage.getItem(this.CURRENT_USER_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.warn('Error loading current user:', e);
                    return null;
                }
            },
            
            // ????? ??????
            logout() {
                try {
                    localStorage.removeItem(this.CURRENT_USER_KEY);
                } catch (e) {
                    console.error('Error logging out:', e);
                }
            },
            
            // ????? ?????? ????????
            updateUserData(userId, newData) {
                const users = this.getAllUsers();
                const user = users.find(u => u.id === userId);
                
                if (!user) return false;
                
                user.data = { ...user.data, ...newData };
                this.saveUsers(users);
                
                // ????? ???????? ?????? ?? ???
                const currentUser = this.getCurrentUser();
                if (currentUser && currentUser.id === userId) {
                    this.setCurrentUser(user);
                }
                
                return true;
            }
        };
        // ??????? ??? ???????? ?? ?????? ???????? (????? ??? ????? ???? userRoles ???? state.shared.public_app_state)
        // ????? ??????? ????? ??????? ???????? (???? ?????? ????? ??? ?????? users ??? Firestore)
        window.FORCED_ADMINS = (window.FORCED_ADMINS || [ 'omarsakr1222@gmail.com', 'yousefsakr1222@gmail.com' ]);
        window.FORCED_REVIEWERS = (window.FORCED_REVIEWERS || [
            'yasserhassan1222@gmail.com',
            'belalhatem1222@gmail.com',
            'mohamedhossein1222@gmail.com'
        ]);
        function getUserRole() {
            try {
                const user = AuthSystem.getCurrentUser();
                if (!user) return 'guest';
                // ?????? 1: ????? ????? ?? ?????? ??? FORCED_ADMINS
                if (window.FORCED_ADMINS.includes((user.email||'').toLowerCase())) return 'admin';
                // ?????? 2: ?????? ????? ???
                if (window.FORCED_REVIEWERS.includes((user.email||'').toLowerCase())) return 'reviewer';
                // ?????? 3: ?? ????? ??????? ??????? ?? ?????? roles
                if (window.__rolesMap && window.__rolesMap[user.id]) return window.__rolesMap[user.id];
                // ?????? 2: ?? ?????? users ???? ??? ??????? ?????? (?????? ?????? ????)
                if (window.state && Array.isArray(state.users)) {
                    const byId = state.users.find(u => u._id === user.id);
                    if (byId && byId.role) return byId.role;
                    const byEmail = state.users.find(u => (u.email||'').toLowerCase() === (user.email||'').toLowerCase());
                    if (byEmail && byEmail.role) return byEmail.role;
                }
            } catch(e) { /* ignore */ }
            // ???????: ?? ?????? ???? ???? ??? ??????? ?????? ?????? ??????
            return 'rep';
        }

        // ????? ?????? ?????? ??? ?? ????
        document.addEventListener('DOMContentLoaded', () => {
            if (AuthSystem.getAllUsers().length === 0) {
                AuthSystem.register('test@example.com', 'test123', '?????? ??????');
            }
        });
    </script>

    <!-- ===== CustomersService: Cache-First Customer Data Management ===== -->
    <script>
        /**
         * CustomersService - Inline Implementation
         * Cache-first customer data loading for offline support
         * CRITICAL: Ensures name, phone, address, balance, id fields exist for legacy code
         */
        window.CustomersService = {
            // Cache the service dependencies once they're ready
            _storageService: null,
            _firestoreService: null,
            _errorHandler: null,

            // Initialize with dependencies (called by firebase-init or manually)
            setDependencies(storageService, firestoreService, errorHandler) {
                window.CustomersService._storageService = storageService;
                window.CustomersService._firestoreService = firestoreService;
                window.CustomersService._errorHandler = errorHandler;
                console.log('? CustomersService dependencies injected');
            },

            // Map Firestore doc to legacy shape
            mapToLegacy(doc) {
                if (!doc) return null;
                const id = doc.id || doc._id || ('cust_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                
                return {
                    id,
                    name: doc.name || doc.customerName || '',
                    phone: doc.phone || doc.phoneNumber || '', // CRITICAL for search
                    address: doc.address || '',
                    balance: typeof doc.balance === 'number' ? doc.balance : 0,
                    email: doc.email || '',
                    taxNumber: doc.taxNumber || '',
                    category: doc.category || 'normal',
                    notes: doc.notes || '',
                    createdAt: doc.createdAt || null,
                    updatedAt: doc.updatedAt || null,
                    isActive: doc.isActive !== false,
                    ...doc
                };
            },

            // Check if cache is fresh
            isCacheFresh(maxAgeMs) {
                maxAgeMs = maxAgeMs || (6 * 60 * 60 * 1000); // 6 hours default
                const cached = this.readCache();
                if (!cached || !cached.length) return false;
                
                // For inline version, check localStorage directly
                try {
                    const data = localStorage.getItem('CUSTOMERS');
                    if (!data) return false;
                    const parsed = JSON.parse(data);
                    if (!parsed.timestamp) return false;
                    const age = Date.now() - parsed.timestamp;
                    return age < maxAgeMs;
                } catch(e) {
                    return false;
                }
            },

            // Read cache
            readCache() {
                try {
                    const data = localStorage.getItem('CUSTOMERS');
                    if (!data) return [];
                    const parsed = JSON.parse(data);
                    return parsed.data || [];
                } catch(e) {
                    console.warn('CustomersService: Cache read failed:', e);
                    return [];
                }
            },

            // Write cache
            writeCache(customers) {
                try {
                    localStorage.setItem('CUSTOMERS', JSON.stringify({
                        data: customers,
                        timestamp: Date.now()
                    }));
                } catch(e) {
                    console.warn('CustomersService: Cache write failed:', e);
                }
            },

            // Fetch from Firestore
            async fetchFromServer() {
                try {
                    if (!window.db) {
                        console.warn('CustomersService: Firestore not ready');
                        return [];
                    }

                    console.log('CustomersService: Fetching from Firestore...');
                    const snapshot = await window.db.collection('customers')
                        .where('isActive', '==', true)
                        .orderBy('name')
                        .limit(10000)
                        .get();

                    const customers = snapshot.docs
                        .map(doc => window.CustomersService.mapToLegacy(doc.data() ? { id: doc.id, ...doc.data() } : { id: doc.id }))
                        .filter(c => c && c.id);

                    console.log(`CustomersService: Fetched ${customers.length} customers from server`);
                    return customers;
                } catch(e) {
                    console.error('CustomersService: Server fetch failed:', e.message);
                    return [];
                }
            },

            // Main: Get customers with cache-first
            async getCustomers(opts) {
                opts = opts || {};
                const forceRefresh = opts.forceRefresh || false;
                const maxAgeMs = opts.maxAgeMs || (6 * 60 * 60 * 1000);

                try {
                    // Try cache if not forced refresh
                    if (!forceRefresh && this.isCacheFresh(maxAgeMs)) {
                        console.log('CustomersService: Using cached customers');
                        return this.readCache();
                    }

                    // Fetch from server
                    const customers = await this.fetchFromServer();

                    // Write to cache
                    if (Array.isArray(customers) && customers.length > 0) {
                        this.writeCache(customers);
                        return customers;
                    }

                    // Fallback to cache
                    const cached = this.readCache();
                    if (Array.isArray(cached) && cached.length > 0) {
                        console.log('CustomersService: Server returned empty, using cached data');
                        return cached;
                    }

                    return customers; // Empty array
                } catch(e) {
                    console.error('CustomersService: getCustomers failed:', e);
                    // Graceful fallback to cache on error
                    return this.readCache();
                }
            },

            // Clear cache (for testing)
            clearCache() {
                try {
                    localStorage.removeItem('CUSTOMERS');
                } catch(e) {
                    console.warn('CustomersService: Cache clear failed:', e);
                }
            }
        };

        console.log('? CustomersService defined (inline)');
    </script>

    <!-- ===== SalesService: Sales & Invoices with Offline Queue ===== -->
    <script>
        /**
         * SalesService - Inline Implementation
         * Smart invoice saving with offline queue + auto-sync
         * 
         * KEY FEATURES:
         * - Read: Limited recent sales (50-100 invoices)
         * - Write Online: Direct save to Firestore
         * - Write Offline: Add to pending_invoices queue
         * - Auto-Sync: syncPendingInvoices() when connection restored
         */
        window.SalesService = {
            _storageService: null,
            _firestoreService: null,
            _errorHandler: null,

            setDependencies(storageService, firestoreService, errorHandler) {
                window.SalesService._storageService = storageService;
                window.SalesService._firestoreService = firestoreService;
                window.SalesService._errorHandler = errorHandler;
                console.log('? SalesService dependencies injected');
            },

            // Map Firestore doc to legacy shape
            mapToLegacy(doc) {
                if (!doc) return null;
                const id = doc.id || doc._id || ('inv_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                
                return {
                    id,
                    invoiceNumber: doc.invoiceNumber || id,
                    customerId: doc.customerId || '',
                    customerName: doc.customerName || '',
                    items: Array.isArray(doc.items) ? doc.items : [],
                    subtotal: typeof doc.subtotal === 'number' ? doc.subtotal : 0,
                    tax: typeof doc.tax === 'number' ? doc.tax : 0,
                    total: typeof doc.total === 'number' ? doc.total : 0,
                    date: doc.date || new Date().toISOString(),
                    period: doc.period || '',
                    userId: doc.userId || '',
                    userName: doc.userName || '',
                    status: doc.status || 'completed',
                    paymentMethod: doc.paymentMethod || 'cash',
                    notes: doc.notes || '',
                    createdAt: doc.createdAt || null,
                    updatedAt: doc.updatedAt || null,
                    ...doc
                };
            },

            // Get recent sales (limited query)
            async getRecentSales(opts) {
                opts = opts || {};
                const limit = opts.limit || 100;
                const forUserId = opts.forUserId || null;
                const cacheKey = forUserId ? ('SALES_USER_' + forUserId) : 'SALES_RECENT';
                
                try {
                    // Try cache first (30 min TTL for sales)
                    const cached = localStorage.getItem(cacheKey);
                    if (cached && !opts.forceRefresh) {
                        const parsed = JSON.parse(cached);
                        if (parsed.timestamp && (Date.now() - parsed.timestamp) < 30 * 60 * 1000) {
                            console.log('SalesService: Using cached recent sales');
                            return parsed.data || [];
                        }
                    }

                    // Fetch from Firestore
                    if (!window.db) {
                        console.warn('SalesService: Firestore not ready, using cache');
                        return cached ? (JSON.parse(cached).data || []) : [];
                    }

                    console.log('SalesService: Fetching recent ' + limit + ' sales...');
                    let query = window.db.collection('sales')
                        .orderBy('createdAt', 'desc')
                        .limit(limit);

                    if (forUserId) {
                        query = query.where('userId', '==', forUserId);
                    }

                    const snapshot = await query.get();
                    const sales = snapshot.docs
                        .map(doc => window.SalesService.mapToLegacy({ id: doc.id, ...doc.data() }))
                        .filter(s => s && s.id);

                    // Cache results
                    localStorage.setItem(cacheKey, JSON.stringify({
                        data: sales,
                        timestamp: Date.now()
                    }));

                    console.log('SalesService: Fetched ' + sales.length + ' sales');
                    return sales;
                } catch (e) {
                    console.error('SalesService: getRecentSales failed:', e);
                    // Fallback to cache
                    const cached = localStorage.getItem(cacheKey);
                    return cached ? (JSON.parse(cached).data || []) : [];
                }
            },

            // CRITICAL: Save invoice with offline queue
            async saveInvoice(invoiceData) {
                try {
                    if (!invoiceData) {
                        throw new Error('Invalid invoice data');
                    }

                    const invoice = {
                        ...invoiceData,
                        createdAt: invoiceData.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    // Try Firestore first if online
                    if (window.db && navigator.onLine !== false) {
                        try {
                            const docId = invoice.id || ('inv_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                            await window.db.collection('sales').doc(docId).set(invoice);
                            console.log('? SalesService: Invoice ' + docId + ' saved to Firestore');
                            return { ok: true, id: docId, queued: false };
                        } catch (serverError) {
                            console.warn('SalesService: Firestore save failed, queuing:', serverError.message);
                            // Fall through to queue
                        }
                    }

                    // Add to queue
                    console.log('SalesService: Adding invoice to offline queue');
                    const queueId = this.addToQueue(invoice);
                    return { ok: true, id: queueId, queued: true, message: 'Queued for sync' };
                } catch (e) {
                    console.error('SalesService: saveInvoice failed:', e);
                    return { ok: false, error: e.message };
                }
            },

            // Add to pending queue
            addToQueue(invoice) {
                const queue = this.getPendingQueue();
                const queueId = invoice.id || ('inv_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36));
                
                queue.push({
                    ...invoice,
                    id: queueId,
                    _queuedAt: Date.now()
                });

                localStorage.setItem('pending_invoices', JSON.stringify(queue));
                console.log('SalesService: Invoice ' + queueId + ' queued (' + queue.length + ' pending)');
                return queueId;
            },

            // Get pending queue
            getPendingQueue() {
                try {
                    const data = localStorage.getItem('pending_invoices');
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    return [];
                }
            },

            // Get pending count
            getPendingCount() {
                return this.getPendingQueue().length;
            },

            // Sync pending invoices
            async syncPendingInvoices() {
                const queue = this.getPendingQueue();
                
                if (queue.length === 0) {
                    console.log('SalesService: No pending invoices');
                    return { synced: 0, failed: 0, errors: [] };
                }

                console.log('SalesService: Syncing ' + queue.length + ' pending invoices...');
                
                const results = { synced: 0, failed: 0, errors: [] };
                const remaining = [];

                for (let i = 0; i < queue.length; i++) {
                    const invoice = queue[i];
                    try {
                        if (!window.db) {
                            throw new Error('Firestore not available');
                        }

                        // Clean queue metadata
                        const clean = { ...invoice };
                        delete clean._queuedAt;
                        delete clean._localTimestamp;

                        await window.db.collection('sales').doc(invoice.id).set(clean);
                        console.log('? Synced invoice ' + invoice.id);
                        results.synced++;
                    } catch (e) {
                        console.error('? Failed to sync ' + invoice.id + ':', e.message);
                        results.failed++;
                        results.errors.push({ id: invoice.id, error: e.message });
                        remaining.push(invoice);
                    }
                }

                // Update queue
                localStorage.setItem('pending_invoices', JSON.stringify(remaining));
                console.log('SalesService: Sync complete - ' + results.synced + ' synced, ' + results.failed + ' failed');
                return results;
            },

            // Clear queue
            clearQueue() {
                localStorage.removeItem('pending_invoices');
                console.log('SalesService: Queue cleared');
            }
        };

        console.log('? SalesService defined (inline)');
        
        // Auto-sync on connection restore
        if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
            window.addEventListener('online', function() {
                console.log('?? Connection restored - auto-syncing pending invoices...');
                setTimeout(function() {
                    if (window.SalesService && typeof window.SalesService.syncPendingInvoices === 'function') {
                        window.SalesService.syncPendingInvoices().then(function(result) {
                            if (result.synced > 0) {
                                console.log('? Auto-sync: ' + result.synced + ' invoices synced');
                                try {
                                    if (typeof customDialog === 'function') {
                                        customDialog({
                                            title: '?? ????????',
                                            message: '?? ??? ' + result.synced + ' ?????? ????? ??????? ?????'
                                        });
                                    } else {
                                        alert('?? ??? ' + result.synced + ' ?????? ?????');
                                    }
                                } catch(e) {}
                            }
                        }).catch(function(e) {
                            console.error('Auto-sync failed:', e);
                        });
                    }
                }, 2000); // Wait 2s after connection restore
            });
        }
    </script>

    <!-- Firebase initialization + sync helpers -->
    <script>
        /**
         * ??????: ??? ??? ??? ?? firebaseConfig ????? � ???? ?????? ??????? ?? ?????.
         * ??? ????? ????? Firebase ???? ?? ????? ??????? ?? ????? ????? ??? ????? ??? ??????
         * ????? ?? ??? ????? ?? ???? ???? HTML ??? ??? ???????:
         *
         * <script> (example) � if you include this inline, escape the closing tag like `<\/script>`
         *   window.firebaseConfig = {
         *     apiKey: "...",
         *     authDomain: "...",
         *     projectId: "...",
         *     storageBucket: "...",
         *     messagingSenderId: "...",
         *     appId: "..."
         *   };
         *
         * ??? ???? ????? ?????? ?? ??????? ?????? ?????? ?????? ????? ??????? ?????? ???? ???????.
         */

        // If you want to embed the config for local use, provide it here.
        // For safety this only assigns when no config already exists on the page.
        try {
            if (!window.firebaseConfig && window.FIREBASE_CONFIG) {
                window.firebaseConfig = window.FIREBASE_CONFIG;
            }
        } catch(e) { /* ignore */ }

        // If you want me to embed the config you pasted, it will be applied
        // below only if no other `window.firebaseConfig` is present.
        if (!window.firebaseConfig) {
            window.firebaseConfig = {
                apiKey: "AIzaSyDLmZPE9teCYf2rMXd1AwT5yq4xlRSHcSk",
                authDomain: "delente-business.firebaseapp.com",
                projectId: "delente-business",
                // ? FIX: ????? ??? ??????? ??? ????? ??????? ?????? ????? ??????
                storageBucket: "delente-business.appspot.com",
                messagingSenderId: "646706509650",
                appId: "1:646706509650:web:1eaa4b94d2990b6be9ac8b"
            };
            // NOTE: This embeds your Firebase config into the local file. It's
            // safe for local use but if this file will be public, consider
            // removing the literal config and instead set `window.FIREBASE_CONFIG`
            // at runtime or restrict your API key in the Firebase console.
        }

        // ?????? ??????? ??????? ????? ??????? ???? ??????? ??????
        // ??????: ????? ??? false ??? ??????? ?? ???? ??? ??????
        window.ALLOW_ANON = true;

        // === Reviewer (Read-Only) helpers ===
        function isReviewer() {
            try { return typeof getUserRole === 'function' && getUserRole() === 'reviewer'; } catch(e){ return false; }
        }
        // Treat 'manager' as a read-only viewer as well (can view all pages but not modify)
        function isReadOnly(){
            try {
                if (typeof getUserRole !== 'function') return false;
                const r = getUserRole();
                return r === 'reviewer' || r === 'manager';
            } catch(e){ return false; }
        }
        function notifyReadOnly(message) {
            const msg = message || '??? ?????? ?? ??? ???????? (????? ???).';
            try { customDialog({ title: '??? ????????', message: msg }); } catch(e) { try { alert(msg); } catch(_){} }
        }
        function installReviewerReadOnlyGuards() {
            if (!window.db || window.__REVIEWER_GUARDS_INSTALLED) return;
            window.__REVIEWER_GUARDS_INSTALLED = true;
            try {
                const origCollection = db.collection.bind(db);
                const origDoc = db.doc.bind(db);
                const origBatch = db.batch ? db.batch.bind(db) : null;
                const origRunTx = db.runTransaction ? db.runTransaction.bind(db) : null;

                function wrapDocRef(ref){
                    if (!ref || ref.__wrappedReviewer) return ref;
                    const w = Object.create(ref);
                    ['set','update','delete'].forEach(fn => {
                        if (typeof ref[fn] === 'function') {
                            w[fn] = function(){
                                                if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); }
                                return ref[fn].apply(ref, arguments);
                            };
                        }
                    });
                    w.__wrappedReviewer = true;
                    return w;
                }

                function wrapCollectionRef(col){
                    if (!col || col.__wrappedReviewer) return col;
                    const w = Object.create(col);
                    if (typeof col.add === 'function') {
                        w.add = function(){
                            if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); }
                            return col.add.apply(col, arguments);
                        };
                    }
                    if (typeof col.doc === 'function') {
                        w.doc = function(){
                            const d = col.doc.apply(col, arguments);
                            return wrapDocRef(d);
                        };
                    }
                    w.__wrappedReviewer = true;
                    return w;
                }

                db.collection = function(path){
                    const col = origCollection(path);
                    return wrapCollectionRef(col);
                };
                db.doc = function(path){
                    const d = origDoc(path);
                    return wrapDocRef(d);
                };
                if (origBatch) {
                    db.batch = function(){
                        const b = origBatch();
                        const wrapper = {
                            set(){ if (isReadOnly()) { notifyReadOnly(); return wrapper; } b.set.apply(b, arguments); return wrapper; },
                            update(){ if (isReadOnly()) { notifyReadOnly(); return wrapper; } b.update.apply(b, arguments); return wrapper; },
                            delete(){ if (isReadOnly()) { notifyReadOnly(); return wrapper; } b.delete.apply(b, arguments); return wrapper; },
                            commit(){ if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); } return b.commit(); }
                        };
                        return wrapper;
                    };
                }
                if (origRunTx) {
                    db.runTransaction = function(updateFn){
                        if (isReadOnly()) { notifyReadOnly(); return Promise.reject(new Error('read-only')); }
                        return origRunTx(updateFn);
                    };
                }
            } catch(e) { console.warn('Reviewer guards setup failed', e); }
        }
        function applyReviewerModeUI(){
            const badge = document.getElementById('reviewer-badge');
            if (badge) badge.classList.toggle('hidden', !isReadOnly());
        }

        // Auto-restore sales from cloud when local cache is empty (runs on login)
        window.autoRestoreSalesIfEmpty = async function(){
            try {
                if (!window.auth || !auth.currentUser) return;
                // if local cache exists and non-empty, skip
                const raw = localStorage.getItem('cache_sales');
                if (raw && raw.length > 2) return; // not empty ("[]" length 2)
                if (window.state && Array.isArray(state.sales) && state.sales.length > 0) return;
                const email = (auth.currentUser.email||'').toLowerCase();
                if (!email) return;
                if (!window.db) { console.warn('autoRestoreSalesIfEmpty: Firestore not ready'); return; }
                try {
                    // Try loading all sales first (no filter)
                    const allSnap = await db.collection('sales').limit(1000).get();
                    const allCount = allSnap.size;
                    console.log(`?? autoRestoreSalesIfEmpty: Total sales in cloud: ${allCount}`);
                    
                    // Then load user's sales
                    const snap = await db.collection('sales').where('repEmail','==', email).get();
                    const arr = [];
                    snap.forEach(doc => {
                        const s = doc.data() || {};
                        s._id = doc.id; if (!s.id) s.id = doc.id;
                        arr.push(s);
                    });
                    
                    // If not enough user sales, load all sales
                    if (arr.length < 50 && allCount > arr.length) {
                        console.log(`?? Only ${arr.length} sales for user, loading all ${allCount} sales from cloud`);
                        allSnap.forEach(doc => {
                            const s = doc.data() || {};
                            s._id = doc.id; if (!s.id) s.id = doc.id;
                            if (!arr.find(x => x.id === s.id)) arr.push(s);
                        });
                    }
                    
                    if (arr.length > 0) {
                        try { localStorage.setItem('cache_sales', JSON.stringify(arr)); } catch(e){}
                        try { localStorage.setItem('reps_local_ts', new Date().toISOString()); } catch(e){}
                        window.state = window.state || {};
                        state.sales = arr.slice(0,500);
                        try { if (typeof renderAllSales === 'function') renderAllSales('', '', 'all'); } catch(e){}
                        try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                        console.log('? autoRestoreSalesIfEmpty: restored', arr.length, 'sales for', email);
                    } else {
                        console.log('autoRestoreSalesIfEmpty: no sales found for', email);
                    }
                } catch(e){ console.warn('autoRestoreSalesIfEmpty: query failed', e); }
            } catch(e){ console.warn('autoRestoreSalesIfEmpty failed', e); }
        };

        // Sync all sales from localStorage to cloud to prevent data loss
        window.syncAllSalesToCloud = async function(){
            try {
                if (!window.auth || !auth.currentUser) return;
                if (!window.db) { console.warn('syncAllSalesToCloud: DB not ready'); return; }
                
                const raw = localStorage.getItem('cache_sales');
                if (!raw || raw.length <= 2) {
                    console.log('?? syncAllSalesToCloud: no sales in localStorage to sync');
                    return;
                }
                
                try {
                    const localSales = JSON.parse(raw);
                    if (!Array.isArray(localSales) || localSales.length === 0) return;
                    
                    console.log(`?? syncAllSalesToCloud: syncing ${localSales.length} sales to cloud...`);
                    
                    // Check which ones are already in cloud
                    const cloudSnap = await db.collection('sales').limit(1000).get();
                    const cloudIds = new Set();
                    cloudSnap.forEach(doc => {
                        cloudIds.add(doc.id);
                        const data = doc.data();
                        if (data.id) cloudIds.add(String(data.id));
                    });
                    
                    let uploaded = 0;
                    let batch = db.batch();
                    let count = 0;
                    
                    for (const sale of localSales) {
                        const id = String(sale.id || sale._id || '');
                        if (!id || cloudIds.has(id)) continue; // already in cloud
                        
                        try {
                            const ref = db.collection('sales').doc(id);
                            batch.set(ref, { ...sale, synced: true, syncedAt: new Date().toISOString() }, { merge: true });
                            uploaded++;
                            count++;
                            
                            if (count >= 450) {
                                await batch.commit();
                                batch = db.batch();
                                count = 0;
                            }
                        } catch(e) {
                            console.warn(`Failed to sync sale ${id}:`, e);
                        }
                    }
                    
                    if (count > 0) await batch.commit();
                    console.log(`? syncAllSalesToCloud: uploaded ${uploaded} new sales to cloud`);
                    
                } catch(e) {
                    console.error('syncAllSalesToCloud: parse failed', e);
                }
            } catch(e) {
                console.warn('syncAllSalesToCloud failed', e);
            }
        };

        function initFirebase() {
            try {
                if (!window.firebase) {
                    console.warn('Firebase SDK not loaded');
                    return false;
                }
                if (window.__FIREBASE_INIT_DONE) return true;
                // initialize using compat SDK (we included -compat scripts)
                // accept either global name (FIREBASE_CONFIG) or legacy firebaseConfig
                var cfg = window.firebaseConfig || window.FIREBASE_CONFIG || null;
                if (!cfg) {
                    console.warn('No firebaseConfig found on window.firebaseConfig or window.FIREBASE_CONFIG � provide it before loading this file');
                    return false;
                }
                firebase.initializeApp(cfg);
                // expose common helpers and mark cloud-only mode
                try {
                    window.auth = firebase.auth();
                    window.db = firebase.firestore();
                    window.storage = firebase.storage();
                } catch (e) {
                    console.warn('Firebase services not available after init', e);
                }
                window.__FIREBASE_INIT_DONE = true;
                // When Firebase is initialized we enable CLOUD_ONLY mode so localStorage writes are suppressed
                window.CLOUD_ONLY = true;
                console.log('Firebase initialized (compat) � CLOUD_ONLY enabled');
                // Global safety flags: disable any auto-seeding on startup per user request
                try {
                    window.__DISABLE_AUTO_SEED_GLOBAL = true;
                    window.__DISABLE_AUTO_SEED_COST_LISTS = true;
                } catch(_){ }

                // Install read-only guards for reviewers (after db is ready)
                try { installReviewerReadOnlyGuards(); } catch(e){ console.warn('installReviewerReadOnlyGuards failed', e); }

                // ?????? ???? ???????
                try {
                    auth.onAuthStateChanged(async function(u){
                        if (u) {
                            window.currentUser = u;
                            // Force refresh auth token to prevent 403 permission errors
                            try {
                                await u.getIdToken(true);
                                console.log('? Auth Token Refreshed - Write Access Granted');
                            } catch(e){ console.warn('Token refresh failed:', e); }
                            
                            const unified = { id: u.uid, email: (u.email||'').toLowerCase(), name: (u.displayName || (u.email ? u.email.split('@')[0] : '??????')), firebase: true, data: {} };
                            AuthSystem.setCurrentUser(unified);
                            // ???????? ???? ???????? ?? ?????? roles ?????? ????? ???????
                            try {
                                window.__rolesMap = window.__rolesMap || {};
                                db.collection('roles').doc(u.uid).onSnapshot(snap => {
                                    if (snap.exists) {
                                        window.__rolesMap[u.uid] = snap.data().role || 'user';
                                        document.dispatchEvent(new Event('role-ready'));
                                    }
                                }, err => console.warn('role doc snapshot error', err));
                            } catch(e){ console.warn('setup role listener failed', e); }
                            try { UIController.showApp(); } catch(e){ console.error('showApp error:', e); }
                            try { initializeAppForUser(); } catch(e){ console.error('initializeAppForUser error:', e); }
                            try { setupRealtimeListeners(); } catch(e){ console.error('setupRealtimeListeners error:', e); }
                            try { if (typeof autoRestoreSalesIfEmpty === 'function') autoRestoreSalesIfEmpty(); } catch(e){ console.error('autoRestoreSalesIfEmpty error:', e); }
                            
                            // Sync all local sales to cloud to prevent data loss
                            setTimeout(() => {
                                try { if (typeof syncAllSalesToCloud === 'function') syncAllSalesToCloud(); } catch(e){ console.error('syncAllSalesToCloud error:', e); }
                            }, 2000);
                            
                            // === ????? ?????? ??????? ????? blocking UI ??? ???????? ===
                            // Start real-time sync for cost lists
                            setTimeout(() => {
                                try { if (typeof initRealtimeSync === 'function') initRealtimeSync(); } catch(e){ console.error('initRealtimeSync error:', e); }
                            }, 500);
                            
                            // ?????? ??????? ??????? ??? ??? ????? ???????? ??? ???
                            setTimeout(() => {
                                try { if (typeof initRealtimeRecovery === 'function') initRealtimeRecovery(); } catch(e){ console.error('initRealtimeRecovery error:', e); }
                            }, 800);
                            
                            try { setPresenceOnline(); } catch(e){ console.error('setPresenceOnline error:', e); }
                            
                            // ????? ???????? ??? appState ??????
                            setTimeout(() => {
                                try {
                                    if (!window.__DISABLE_AUTO_SEED_GLOBAL && typeof seedDefaultsIfEmpty === 'function') {
                                        seedDefaultsIfEmpty();
                                    } else {
                                        console.log('?? Auto-seeding disabled by flag; skipping seedDefaultsIfEmpty');
                                    }
                                } catch(e){ console.error('seedDefaultsIfEmpty error:', e); }
                            }, 1000);
                            
                            // ?? ??? ????? ?? ??? ????? ????? ??????? ?????
                            setTimeout(() => {
                                try { if (typeof initLegacyCollectionsIfEmpty === 'function') initLegacyCollectionsIfEmpty(); } catch(e){ console.error('initLegacyCollectionsIfEmpty error:', e); }
                            }, 1200);
                            
                            // ?????? ???? ????? ???????? ????????
                            setTimeout(() => {
                                try { if (typeof scheduleEnsureCoreData === 'function') scheduleEnsureCoreData(); } catch(e){ console.error('scheduleEnsureCoreData error:', e); }
                            }, 1500);
                            
                            // ??? ?????? ?????? ????????
                            setTimeout(() => {
                                try { if (typeof maybeAutoClosePreviousMonth === 'function') maybeAutoClosePreviousMonth(); } catch(e){ console.error('maybeAutoClosePreviousMonth error:', e); }
                                try { if (typeof ensureDefaultActivePeriod === 'function') ensureDefaultActivePeriod(); } catch(e){ console.error('ensureDefaultActivePeriod error:', e); }
                            }, 1800);
                            
                            // Auto-resume GPS sharing if previously enabled
                            setTimeout(() => {
                                try {
                                    if (localStorage.getItem('gps_sharing_enabled') === '1') {
                                        if (typeof startLocationSharing === 'function') startLocationSharing();
                                    }
                                    if (typeof window.__gpsHeaderSync === 'function') window.__gpsHeaderSync();
                                } catch(e){ console.error('GPS sharing error:', e); }
                            }, 2000);
                            
                            // ????? ????? ????? ?????????? ????????
                            setTimeout(() => {
                                try { if (typeof autoFixChocolateVatOnce === 'function') autoFixChocolateVatOnce(); } catch(e){ console.error('autoFixChocolateVatOnce error:', e); }
                            }, 2500);
                            
                            // Reviewer mode UI updates
                            try { applyReviewerModeUI(); } catch(e){ console.error('applyReviewerModeUI error:', e); }
                            
                            // ????? ????? ???? ?????? ??? ????? ?????
                            try { applyRoleNavRestrictions(); } catch(e){ console.error('applyRoleNavRestrictions error:', e); }
                            
                            // ??????? ?????? ???? ??? 10 ????? ??? ????? ??????
                            let tries = 0; const tmr = setInterval(()=>{ tries++; try { applyRoleNavRestrictions(); } catch(e){ console.error('roleNavRestrictions retry error:', e); } if (tries>10) clearInterval(tmr); },1000);
                        } else {
                            try { AuthSystem.logout(); } catch(e){}
                            try { UIController.showLoginPage(); } catch(e){}
                            try { setPresenceOffline(); } catch(e){}
                        }
                        try { UIController.updateCurrentUserDisplay(); } catch(e){}
                    });
                } catch(e) { console.warn('onAuthStateChanged setup failed', e); }

                return true;
            } catch (e) {
                console.warn('initFirebase error', e);
                return false;
            }
        }

        // Try to initialize automatically if a config exists
        try { initFirebase(); } catch(e) { /* ignore */ }

        // ??????? ????? ????????? ??? ??? ???? ????? (??? ????????? ?? onAuthStateChanged ??? ????? ??????)
        function setupRealtimeListeners(){
            if (!window.db) { console.warn('Firestore ??? ???? ???'); return; }
            window.state = window.state || {};
            // ???????? (Admin/Reviewer: ?? ????????? ???????: ??????? ???)
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = AuthSystem.getCurrentUser();
                const applySnap = function(snap){
                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    arr.sort((a,b)=>{
                        const ta = new Date(a.date || a.createdAt || 0).getTime();
                        const tb = new Date(b.date || b.createdAt || 0).getTime();
                        return tb - ta;
                    });
                    state.sales = arr.slice(0,500);
                    try { localStorage.setItem('cache_sales', JSON.stringify(state.sales)); } catch(e){}
                    try {
                        const textFilter = document.getElementById('search-sales-text')?.value || '';
                        const dateFilter = document.getElementById('search-sales-date')?.value || '';
                        const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                        if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                        else if (typeof renderSalesList === 'function') renderSalesList();
                        if (typeof renderDashboard === 'function') renderDashboard();
                    } catch(e){}
                };
                const onErr = function(err){
                    console.warn('sales snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('sales'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_sales');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.sales || state.sales.length === 0) && Array.isArray(cached) && cached.length) {
                            state.sales = cached;
                            const textFilter = document.getElementById('search-sales-text')?.value || '';
                            const dateFilter = document.getElementById('search-sales-date')?.value || '';
                            const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                            if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                            if (typeof renderDashboard === 'function') renderDashboard();
                        }
                    } catch(e){}
                };

                if (role === 'admin' || role === 'reviewer' || role === 'manager') {
                    db.collection('sales').onSnapshot(applySnap, onErr);
                    } else if ((role === 'rep' || role === 'user') && current && current.id) {
                    const uid = String(current.id);
                    const email = (current.email||'').toLowerCase();
                    const byId = new Map();
                    let salesErrCount = 0;
                    const mergeAndRender = () => {
                        const arr = Array.from(byId.values());
                        arr.sort((a,b)=>{
                            const ta = new Date(a.date || a.createdAt || 0).getTime();
                            const tb = new Date(b.date || b.createdAt || 0).getTime();
                            return tb - ta;
                        });
                        state.sales = arr.slice(0,500);
                        try { localStorage.setItem('cache_sales', JSON.stringify(state.sales)); } catch(e){}
                        try { if (typeof renderAllSales === 'function') renderAllSales('', '', 'all'); } catch(e){}
                        try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                    };
                    // CRITICAL FIX: Listen to the rep's personal invoices subcollection
                    // This ensures admin-created invoices appear on the rep's screen
                    db.collection('users').doc(uid).collection('invoices').onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    // ??????????? ???????? ???? ??????? ??????? ??????
                    db.collection('sales').where('createdBy','==', uid).onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ /* fallback to full snapshot */ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    db.collection('sales').where('repId','==', uid).onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    // Legacy support: ??? ???????? ??????? ?????? ???? ????? ??????? ????? ?? uid
                    // ???? ?????? ??? ???? ????? ??????? ?? ????? ???????? ????? ??? ?????? ?? ?????
                    try {
                        const currentRepDoc = (state.reps||[]).find(r => (r.email||'').toLowerCase() === email) || (state.reps||[]).find(r => (r.name||'') === (current && current.name));
                        const repDocId = currentRepDoc && currentRepDoc.id ? String(currentRepDoc.id) : null;
                        if (repDocId && repDocId !== uid) {
                            db.collection('sales').where('repId','==', repDocId).onSnapshot(snap => {
                                try {
                                    snap.docChanges().forEach(change => {
                                        if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                        const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                                    });
                                } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                                mergeAndRender();
                            }, onErr);
                            // attach error-only listener to surface failures
                            db.collection('sales').where('repId','==', repDocId).onSnapshot(()=>{}, err => console.warn('sales repDocId query error', err));
                        }
                    } catch(e){ console.warn('setupRealtimeListeners: repDocId mapping failed', e); }
                    db.collection('sales').where('createdByEmail','==', email).onSnapshot(snap => {
                        try {
                            snap.docChanges().forEach(change => {
                                if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; byId.set(change.doc.id, d);
                            });
                        } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                        mergeAndRender();
                    }, onErr);
                    // ? CRITICAL: Listen by repName - wait for state.reps to be ready
                    const setupRepNameListener = () => {
                        try {
                            const currentRepDoc = (state.reps||[]).find(r => (r.email||'').toLowerCase() === email);
                            const repName = currentRepDoc ? currentRepDoc.name : null;
                            if (repName) {
                                console.log('? Rep listener: watching sales where repName ==', repName);
                                db.collection('sales').where('repName','==', repName).onSnapshot(snap => {
                                    console.log('?? Rep sales snapshot received:', snap.size, 'invoices for', repName);
                                    try {
                                        snap.docChanges().forEach(change => {
                                            if (change.type === 'removed') { try { byId.delete(change.doc.id); } catch(_){} return; }
                                            const d = change.doc.data()||{}; d._id = change.doc.id; if(!d.id) d.id = change.doc.id; 
                                            console.log('  - Invoice:', d.invoiceNumber, 'repName:', d.repName, 'total:', d.total);
                                            byId.set(change.doc.id, d);
                                        });
                                    } catch(e){ snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); }
                                    mergeAndRender();
                                }, err => console.warn('sales repName query error', err));
                            } else {
                                console.warn('?? Could not find rep name for email:', email, '- retrying in 2 seconds');
                                setTimeout(setupRepNameListener, 2000);
                            }
                        } catch(e){ 
                            console.warn('setupRealtimeListeners: repName listener failed', e);
                            setTimeout(setupRepNameListener, 2000);
                        }
                    };
                    // Try immediately, but retry if reps not ready
                    setupRepNameListener();
                    const salesErrorHandler = err => { salesErrCount++; console.warn('sales legacy query error', err); if (salesErrCount >= 3) { tryBroadSalesFallback(); } };
                    // reattach with dedicated handlers (original above kept minimal)
                    db.collection('sales').where('createdBy','==', uid).onSnapshot(()=>{}, salesErrorHandler);
                    db.collection('sales').where('repId','==', uid).onSnapshot(()=>{}, salesErrorHandler);
                    db.collection('sales').where('createdByEmail','==', email).onSnapshot(()=>{}, salesErrorHandler);
                    try {
                        const currentRepDoc = (state.reps||[]).find(r => (r.email||'').toLowerCase() === email) || (state.reps||[]).find(r => (r.name||'') === (current && current.name));
                        const repDocId = currentRepDoc && currentRepDoc.id ? String(currentRepDoc.id) : null;
                        if (repDocId && repDocId !== uid) {
                            db.collection('sales').where('repId','==', repDocId).onSnapshot(()=>{}, salesErrorHandler);
                        }
                    } catch(e){ /* ignore */ }
                    db.collection('users').doc(uid).collection('invoices').onSnapshot(()=>{}, err => console.warn('user-invoices subcollection error', err));
                    function tryBroadSalesFallback(){
                        // ?????? ?????: ????? ???? ?????? ????? ??? ?????? ????????? ????????
                        db.collection('sales').limit(500).onSnapshot(snap => {
                            snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); });
                            mergeAndRender();
                        }, err => console.warn('broad sales fallback failed', err));
                    }
                    // ?? ??? ????? ??? ?????? ????? ??????
                    setTimeout(()=>{
                        if ((!state.sales || state.sales.length===0)) {
                            try {
                                const raw = localStorage.getItem('cache_sales');
                                const cached = raw ? JSON.parse(raw): [];
                                if (Array.isArray(cached) && cached.length) {
                                    state.sales = cached;
                                    if (typeof renderDashboard === 'function') renderDashboard();
                                }
                            } catch(e){}
                        }
                    }, 2000);
                } else {
                    db.collection('sales').onSnapshot(applySnap, onErr);
                }
            } catch(e){ console.warn('sales listener init failed', e); }
            // ??????? (????? ??????? ??? ???????: ??? ?????? ??? + ??? ?????????)
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = AuthSystem.getCurrentUser();
                if (role === 'admin') {
                    db.collection('customers').onSnapshot(function(snap){
                        // If there are pending writes from this client, only apply the overlay
                        // when the cloud snapshot contains newer data than local cache.
                        if (snap.metadata && snap.metadata.hasPendingWrites) {
                            try {
                                let maxTs = null;
                                snap.forEach(doc => {
                                    const d = doc.data()||{};
                                    const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null;
                                    if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs;
                                });
                                const localTs = localStorage.getItem('customers_local_ts') || null;
                                if (maxTs && localTs) {
                                    if (new Date(maxTs) <= new Date(localTs)) {
                                        console.log('?? customers listener: ignoring pending write (local) � cloud not newer', {maxTs, localTs});
                                        return;
                                    }
                                    console.log('?? customers listener: pendingWrites but cloud newer � applying overlay', {maxTs, localTs});
                                } else {
                                    console.log('?? customers listener: ignoring pending write (local) � missing timestamps', {maxTs, localTs});
                                    return;
                                }
                            } catch(_) { console.log('?? customers listener: timestamp compare failed'); return; }
                        }

                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); localStorage.setItem('customers_local_ts', new Date().toISOString()); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                        try { attemptDeleteSpecificCustomersOnce(); } catch(e){}
                    }, err => {
                        console.warn('customers snapshot error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                    });
                } else if ((role === 'rep' || role === 'user') && current && current.id) {
                    const uid = String(current.id);
                    const byId = new Map();
                    let custErrCount = 0;
                    const applyAndRender = () => {
                        const arr = Array.from(byId.values());
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                    };

                    const shouldApplySnapshot = (snap, localKey) => {
                        try {
                            if (!snap.metadata || !snap.metadata.hasPendingWrites) return true;
                            let maxTs = null;
                            snap.forEach(doc => {
                                const d = doc.data() || {};
                                const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null;
                                if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs;
                            });
                            const localTs = localStorage.getItem(localKey) || null;
                            if (!maxTs || !localTs) return false;
                            return new Date(maxTs) > new Date(localTs);
                        } catch(e){ console.log('listener: timestamp compare failed', e); return false; }
                    };

                    // 1) ????? ??????? - assignedRepId
                    db.collection('customers').where('assignedRepId','==', uid).onSnapshot(function(snap){
                        if (!shouldApplySnapshot(snap, 'customers_local_ts')) { console.log('?? customers(rep) listener: skipping (local newer or missing ts)'); return; }
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => {
                        console.warn('customers snapshot (rep-owned) error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                        custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback();
                    });

                    // legacy queries: repId and ownerId
                    db.collection('customers').where('repId','==', uid).onSnapshot(function(snap){
                        if (!shouldApplySnapshot(snap, 'customers_local_ts')) { console.log('?? customers(legacy) listener: skipping (local newer or missing ts)'); return; }
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => { console.warn('customers snapshot (legacy repId) error', err); custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback(); });

                    db.collection('customers').where('ownerId','==', uid).onSnapshot(function(snap){
                        if (!shouldApplySnapshot(snap, 'customers_local_ts')) { console.log('?? customers(owner) listener: skipping (local newer or missing ts)'); return; }
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => { console.warn('customers snapshot (legacy ownerId) error', err); custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback(); });
                    function tryBroadCustomersFallback(){
                        db.collection('customers').limit(500).onSnapshot(snap => {
                            snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id,d); });
                            applyAndRender();
                        }, err => console.warn('broad customers fallback failed', err));
                    }
                } else {
                    // ????? ????: ???? ???????? ??? ????? ????? ??? ?????? ???????
                    db.collection('customers').onSnapshot(function(snap){
                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                    }, err => {
                        console.warn('customers snapshot (other role) error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                    });
                }
            } catch(e){ console.warn('customers listener init failed', e); }
            // ????????
            try {
                db.collection('products').onSnapshot(function(snap){
                    if (snap.metadata && snap.metadata.hasPendingWrites) {
                        try {
                            let maxTs = null;
                            snap.forEach(doc => { const d = doc.data()||{}; const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null; if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs; });
                            const localTs = localStorage.getItem('products_local_ts') || null;
                            if (maxTs && localTs) {
                                if (new Date(maxTs) <= new Date(localTs)) { console.log('?? products listener: ignoring pending write (local) � cloud not newer', {maxTs, localTs}); return; }
                                console.log('?? products listener: pendingWrites but cloud newer � applying overlay', {maxTs, localTs});
                            } else { console.log('?? products listener: missing timestamps; ignoring pending write', {maxTs, localTs}); return; }
                        } catch(_) { console.log('?? products listener: ts compare failed; ignoring'); return; }
                    }
                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        // ???? ???? ????? id ??????? ?? ?????? ??????? ?????? ?????? ???????
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        // ??? ?? ???? ??? ??? ???? productPrices ?????? ?? ??? price ???? ????? ????? ?????? ???? ????????
                        arr.push(d);
                    });
                    state.products = arr;
                    try { localStorage.setItem('cache_products', JSON.stringify(arr)); localStorage.setItem('products_local_ts', new Date().toISOString()); } catch(e){}
                    try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                }, err => {
                    console.warn('products snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('products'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_products');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.products || state.products.length === 0) && Array.isArray(cached) && cached.length) {
                            state.products = cached;
                            if (typeof renderProductList === 'function') renderProductList('');
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('products listener init failed', e); }
            // ????? ???????
            try {
                db.collection('priceLists').onSnapshot(function(snap){
                    if (snap.metadata && snap.metadata.hasPendingWrites) {
                        try {
                            let maxTs = null;
                            snap.forEach(doc => { const d = doc.data()||{}; const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null; if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs; });
                            const localTs = localStorage.getItem('priceLists_local_ts') || null;
                            if (maxTs && localTs) {
                                if (new Date(maxTs) <= new Date(localTs)) { console.log('?? priceLists listener: ignoring pending write (local) � cloud not newer', {maxTs, localTs}); return; }
                                console.log('?? priceLists listener: pendingWrites but cloud newer � applying overlay', {maxTs, localTs});
                            } else { console.log('?? priceLists listener: missing timestamps; ignoring pending write', {maxTs, localTs}); return; }
                        } catch(_) { console.log('?? priceLists listener: ts compare failed; ignoring'); return; }
                    }

                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        const pl = { id: doc.id, name: d.name || d.title || doc.id, productPrices: {} };
                        if (d.productPrices && typeof d.productPrices === 'object') {
                            pl.productPrices = d.productPrices;
                        } else if (d.prices && typeof d.prices === 'object') {
                            pl.productPrices = d.prices;
                        } else if (d.map && typeof d.map === 'object') {
                            pl.productPrices = d.map;
                        } else {
                            // ??? ????? ??????: ?????? ????? ?? ??????? ??????
                            const pp = {};
                            Object.keys(d).forEach(k => {
                                if (/^\d+$/.test(k) && typeof d[k] === 'number') pp[k] = d[k];
                            });
                            pl.productPrices = pp;
                        }
                        arr.push(pl);
                    });
                    // ?? ???? ????? ??? ???? ???????? ?????? ????? ??????? ??????? ?? appState/?????????
                    if (arr.length > 0) {
                        state.priceLists = arr;
                        try { localStorage.setItem('cache_priceLists', JSON.stringify(arr)); localStorage.setItem('priceLists_local_ts', new Date().toISOString()); } catch(e){}
                        try { if (typeof renderSettings === 'function') renderSettings(document.getElementById('search-products')?.value || ''); } catch(e){}
                        try { updateAllPriceListDropdowns(); } catch(e){}
                        try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                        // IMPORTANT: ????? ??? ???? ??????? ??? ???? ??????? ??? ?? ???? "???? ????? ?????"
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                    }
                }, err => {
                    console.warn('priceLists snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('priceLists'); } catch(e){} }
                    // Fallback ??? ??? ?????????: ????? ??????? ??????? ?????? ??? ????? ???????
                    if (err && err.code === 'permission-denied') {
                        if ((!state.priceLists || !state.priceLists.length) && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025)) {
                            state.priceLists = window.EMBEDDED_PRICE_LISTS_BACKUP_2025.map(pl => ({ id: pl.id, name: pl.name, productPrices: pl.productPrices || {} }));
                            console.log('?? ??????? ?????? ??????? ??????? ???? ??? ?????????');
                            try { updateAllPriceListDropdowns(); } catch(e){}
                            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                            try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                        }
                    }
                    // Fallback ?????: ?????? ??????? ??????
                    try {
                        const raw = localStorage.getItem('cache_priceLists');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.priceLists || state.priceLists.length === 0) && Array.isArray(cached) && cached.length) {
                            state.priceLists = cached;
                            try { updateAllPriceListDropdowns(); } catch(e){}
                            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                            try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('priceLists listener init failed', e); }
            // ????????
            try {
                db.collection('reps').onSnapshot(function(snap){
                    if (snap.metadata && snap.metadata.hasPendingWrites) {
                        try {
                            let maxTs = null;
                            snap.forEach(doc => { const d = doc.data()||{}; const u = d && d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null; if (u) maxTs = (!maxTs || new Date(u) > new Date(maxTs)) ? u : maxTs; });
                            const localTs = localStorage.getItem('reps_local_ts') || null;
                            if (maxTs && localTs) {
                                if (new Date(maxTs) <= new Date(localTs)) { console.log('?? reps listener: ignoring pending write (local) � cloud not newer', {maxTs, localTs}); return; }
                                console.log('?? reps listener: pendingWrites but cloud newer � applying overlay', {maxTs, localTs});
                            } else { console.log('?? reps listener: missing timestamps; ignoring pending write', {maxTs, localTs}); return; }
                        } catch(_) { console.log('?? reps listener: ts compare failed; ignoring'); return; }
                    }

                    const arr = [];
                    snap.forEach(doc => { const d = doc.data(); d.id = doc.id; arr.push(d); });
                    state.reps = arr;
                    try { localStorage.setItem('reps_local_ts', new Date().toISOString()); } catch(e){}
                    try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
                    try {
                        const simpleIds = ['sale-rep','customer-rep','new-dispatch-rep','spreadsheet-rep','debt-rep-filter','dashboard-rep-filter'];
                        simpleIds.forEach(id => { const el = document.getElementById(id); if (el && typeof populateRepDropdown === 'function') populateRepDropdown(el); });
                        const reportIds = ['daily-report-rep','range-report-rep','monthly-report-rep','recon-report-rep'];
                        reportIds.forEach(id => { const el = document.getElementById(id); if (el && typeof populateRepDropdownReports === 'function') populateRepDropdownReports(el); });
                    } catch(e){}
                }, err => console.warn('reps snapshot error', err));
                // (Optional) could add permission handler for reps/users/presence if needed
            } catch(e){ console.warn('reps listener init failed', e); }
            
            // Listen to current user document for chains and other state
            try {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).onSnapshot(function(snap){
                        if (!snap.exists) return;
                        const data = snap.data() || {};
                        const appState = data.appState || {};
                        
                        // Load chains from cloud
                        if (Array.isArray(appState.chains)) {
                            state.chains = appState.chains;
                            // Update localStorage for offline access
                            try { localStorage.setItem('customerChains', JSON.stringify(appState.chains)); } catch(e){}
                            // Refresh UI if on customers page
                            try { if (typeof renderChainsDisplay === 'function') renderChainsDisplay(); } catch(e){}
                            console.log('?? Loaded chains from cloud:', appState.chains.length);
                        }
                    }, err => console.warn('user doc snapshot error', err));
                }
            } catch(e){ console.warn('user doc listener init failed', e); }
            
            // ?????????? (???????) � Admin only
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') {
                    db.collection('users').onSnapshot(function(snap){
                        const usersArr = [];
                        snap.forEach(doc => {
                            const d = doc.data();
                            d._id = doc.id;
                            if (!d.uid) d.uid = doc.id;
                            if (d.email) { try { d.email = String(d.email).toLowerCase(); } catch(_){} }
                            usersArr.push(d);
                        });
                        state.users = usersArr;
                        try {
                            UIController.updateCurrentUserDisplay();
                            if (typeof renderUsersTable === 'function') renderUsersTable();
                        } catch(e){}
                    }, err => console.warn('users snapshot error', err));
                }
            } catch(e){ console.warn('users listener init failed', e); }

            // ?? ????? ???????? ??????? ?????? shared/public_app_state ???????? ?????? ?????? ???? ?? ????????? ???????

            // ?????? (presence) � Admin only
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') {
                    db.collection('presence').onSnapshot(function(snap){
                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; arr.push(d); });
                        state.presence = arr;
                        try {
                            if (Array.isArray(state.users) && state.users.length) {
                                const byId = new Map(arr.map(p => [String(p.uid||p._id||''), p]));
                                state.users = state.users.map(u => {
                                    const p = byId.get(String(u._id||u.uid||''));
                                    const merged = Object.assign({}, u);
                                    if (p) {
                                        // ???????? ???? ???? ?? presence
                                        if ((!merged.email || merged.email==='') && p.email) merged.email = String(p.email).toLowerCase();
                                        merged.online = (p.online !== false); // ???? ???????? true ??? ?? ??? ??????
                                        try {
                                            if ((!u.email || u.email==='') && p.email && db) {
                                                db.collection('users').doc(String(u._id)).set({ email: String(p.email).toLowerCase() }, { merge: true }).catch(()=>{});
                                            }
                                        } catch(_e){}
                                    } else {
                                        // ?? ???? presence ???? ???????? � ???? ??? ??? ???? ???? ???????
                                        merged.online = (typeof u.online !== 'undefined') ? !!u.online : false; // ????????? false (??? ????) 
                                    }
                                    return merged;
                                });
                            }
                        } catch(_){ }
                        try { renderRepLocations(); } catch(e){}
                        try { renderRepMap(); } catch(e){}
                        try { if (typeof renderUsersTable === 'function') renderUsersTable(); } catch(e){}
                    }, err => console.warn('presence snapshot error', err));
                }
            } catch(e){ console.warn('presence listener init failed', e); }

            // ?????? ?????? (dispatchNotes)
            try {
                db.collection('dispatchNotes').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                    // ??? ?????? ????????
                    arr.sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
                    state.dispatchNotes = arr;
                    try { localStorage.setItem('cache_dispatchNotes', JSON.stringify(arr)); } catch(e){}
                    try { if (typeof renderDispatchPage === 'function') renderDispatchPage(); } catch(e){}
                }, err => {
                    console.warn('dispatchNotes snapshot error', err);
                    if (err && err.code === 'permission-denied') {
                        try {
                            const raw = localStorage.getItem('cache_dispatchNotes');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.dispatchNotes || state.dispatchNotes.length===0) && cached.length){
                                state.dispatchNotes = cached; if (typeof renderDispatchPage === 'function') renderDispatchPage();
                            }
                        } catch(e){}
                    }
                });
            } catch(e){ console.warn('dispatchNotes listener init failed', e); }

            // Daily collections (rep expenses + daily collection sheet)
            try {
                db.collection('daily_collections').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.dailyCollections = arr;
                    try { localStorage.setItem('cache_daily_collections', JSON.stringify(arr)); } catch(e){}
                }, err => {
                    console.warn('daily_collections snapshot error', err);
                    try {
                        const raw = localStorage.getItem('cache_daily_collections');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.dailyCollections || state.dailyCollections.length===0) && cached.length){
                            state.dailyCollections = cached;
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('daily_collections listener init failed', e); }

            // ?????? ????????? (promotions)
            try {
                db.collection('promotions').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.promotions = arr;
                    try { localStorage.setItem('cache_promotions', JSON.stringify(arr)); } catch(e){}
                    try { if (typeof renderPromotions === 'function') renderPromotions(); } catch(e){}
                    try { if (typeof updateAllSalePrices === 'function') updateAllSalePrices(); } catch(e){}
                }, err => {
                    console.warn('promotions snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('promotions'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_promotions');
                        if (raw) state.promotions = JSON.parse(raw);
                    } catch(e){}
                });
            } catch(e){ console.warn('promotions listener init failed', e); }

            // ??????? ?????????? (openingBalances) � ??????? ??????? ??? ??????
            try {
                db.collection('openingBalances').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.openingBalances = arr;
                    try { localStorage.setItem('cache_openingBalances', JSON.stringify(arr)); } catch(e){}
                }, err => {
                    console.warn('openingBalances snapshot error', err);
                    try {
                        const raw = localStorage.getItem('cache_openingBalances');
                        if (raw) state.openingBalances = JSON.parse(raw);
                    } catch(e){}
                });
            } catch(e){ console.warn('openingBalances listener init failed', e); }

            // ????????? ?????? (settings) � ????? ?????? ?????????? ??????
            try {
                db.collection('settings').doc('global-settings').onSnapshot(function(snap){
                    if (snap.exists) {
                        const settings = snap.data() || {};
                        state.settings = state.settings || {};
                        if (settings.salesTarget !== undefined) {
                            state.settings.salesTarget = settings.salesTarget;
                            // ????? ??? ??????? ?????? (??? ?? ?? ??? ?????? ??????)
                            try {
                                const input = document.getElementById('sales-target-input');
                                if (input) {
                                    input.value = settings.salesTarget;
                                }
                            } catch(e){}
                            // ????? ??? ???? ????????? ??? ???? ?????
                            try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                        }
                        console.log('?? ????? ????????? ?? ???????:', settings);
                    }
                }, err => {
                    console.warn('settings snapshot error', err);
                });
            } catch(e){ console.warn('settings listener init failed', e); }
        }

        // ===== GPS Tracking (Presence Location) =====
        (function(){
            const LS_GPS = 'gps_sharing_enabled';
            window.__gpsWatchId = null;
            window.__repsMap = null;
            window.__repMarkers = {};
            window.__gpsHeaderSync = function(){
                try {
                    const btn = document.getElementById('gps-toggle-btn');
                    if (!btn) return;
                    // Remove any neutral/old classes to avoid conflicts
                    btn.classList.remove('bg-gray-200','hover:bg-gray-300','text-gray-800');
                    const enabled = localStorage.getItem(LS_GPS) === '1';
                    btn.textContent = enabled ? 'GPS ON' : 'GPS OFF';
                    btn.classList.toggle('bg-green-500', enabled);
                    btn.classList.toggle('hover:bg-green-600', enabled);
                    btn.classList.toggle('text-white', enabled);
                    // OFF state as red for clear visual cue
                    btn.classList.toggle('bg-red-500', !enabled);
                    btn.classList.toggle('hover:bg-red-600', !enabled);
                    btn.classList.toggle('text-white', !enabled);
                } catch(e){}
            };

            window.startLocationSharing = function(){
                try {
                    const statusEl = document.getElementById('gps-share-status');
                    if (!navigator.geolocation) { if (statusEl) statusEl.textContent = '??????? ?? ???? ??????'; return; }
                    if (!auth || !auth.currentUser) { if (statusEl) statusEl.textContent = '?? ??? ????? ??????'; return; }
                    if (window.__gpsWatchId != null) return; // already running
                    const opts = { enableHighAccuracy: true, maximumAge: 15000, timeout: 15000 };
                    window.__gpsWatchId = navigator.geolocation.watchPosition(async function(pos){
                        try {
                            const { latitude:lat, longitude:lng, accuracy } = pos.coords || {};
                            const uid = auth.currentUser.uid;
                            await db.collection('presence').doc(uid).set({
                                uid,
                                email: (auth.currentUser.email||'').toLowerCase(),
                                online: true,
                                location: { lat, lng, accuracy },
                                locationUpdatedAt: serverTs(),
                                sharing: true
                            }, { merge:true });
                            const s = `??? ?????: ${new Date().toLocaleTimeString('ar-EG')}`;
                            if (statusEl) statusEl.textContent = s;
                        } catch(e){ /* ignore */ }
                    }, function(err){ if (statusEl) statusEl.textContent = '???? ????? ??????'; console.warn('GPS error', err); }, opts);
                    try { localStorage.setItem(LS_GPS, '1'); } catch(e){}
                    try { window.__gpsHeaderSync(); } catch(e){}
                } catch(e){ console.warn('startLocationSharing failed', e); }
            };

            window.stopLocationSharing = function(){
                try {
                    const statusEl = document.getElementById('gps-share-status');
                    if (window.__gpsWatchId != null) { try { navigator.geolocation.clearWatch(window.__gpsWatchId); } catch(e){} window.__gpsWatchId = null; }
                    try { localStorage.removeItem(LS_GPS); } catch(e){}
                    if (statusEl) statusEl.textContent = '?????';
                    if (auth && auth.currentUser && db) {
                        const uid = auth.currentUser.uid;
                        db.collection('presence').doc(uid).set({ sharing:false }, { merge:true }).catch(()=>{});
                    }
                    try { window.__gpsHeaderSync(); } catch(e){}
                } catch(e){ console.warn('stopLocationSharing failed', e); }
            };

            window.setupGpsSharingControls = function(){
                try {
                    const toggle = document.getElementById('gps-share-toggle');
                    const statusEl = document.getElementById('gps-share-status');
                    const adminBox = document.getElementById('admin-gps-list');
                    if (!toggle) return; // settings page not in DOM
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (adminBox) adminBox.classList.toggle('hidden', role !== 'admin');
                    const enabled = localStorage.getItem(LS_GPS) === '1';
                    toggle.checked = enabled;
                    if (enabled) { statusEl && (statusEl.textContent = '???? ????????...'); startLocationSharing(); }
                    toggle.addEventListener('change', function(){
                        if (toggle.checked) { statusEl && (statusEl.textContent = '???? ????????...'); startLocationSharing(); }
                        else { stopLocationSharing(); }
                    });
                    // ??? ????? ???????? ?????? ??? ??? ?????????
                    try { window.renderRepLocations(); } catch(e){}
                    // ????? ??????? renderRepMap ??? ???? ??????? ??????
                    try { window.renderRepMap(); } catch(e){}
                    // Also wire header button now that DOM is ready
                    try {
                        const hdrBtn = document.getElementById('gps-toggle-btn');
                        if (hdrBtn) {
                            window.__gpsHeaderSync();
                            hdrBtn.addEventListener('click', function(){
                                const isOn = localStorage.getItem(LS_GPS) === '1';
                                if (isOn) {
                                    stopLocationSharing();
                                } else {
                                    statusEl && (statusEl.textContent = '???? ????????...');
                                    startLocationSharing();
                                }
                                // Immediately refresh text to reflect Delente ON/OFF without waiting for async
                                try { window.__gpsHeaderSync(); } catch(e){}
                            });
                        }
                    } catch(e){}
                } catch(e){ console.warn('setupGpsSharingControls failed', e); }
            };

            window.renderRepLocations = function(){
                try {
                    const listEl = document.getElementById('rep-locations-list');
                    const adminBox = document.getElementById('admin-gps-list');
                    if (!listEl || !adminBox || adminBox.classList.contains('hidden')) return;
                    const rows = (state.presence||[])
                        .map(p => {
                            try {
                                if (!p || !p.location) return null;
                                const latRaw = p.location.lat;
                                const lngRaw = p.location.lng;
                                const lat = Number(latRaw);
                                const lng = Number(lngRaw);
                                if (!isFinite(lat) || !isFinite(lng)) return null;
                                const name = (state.users||[]).find(u=>u.uid===p.uid)?.name || (state.reps||[]).find(r=>r.email && p.email && r.email.toLowerCase()===p.email.toLowerCase())?.name || p.email || p.uid;
                                const acc = p.location.accuracy;
                                const when = p.locationUpdatedAt && p.locationUpdatedAt.toDate ? p.locationUpdatedAt.toDate() : (p.locationUpdatedAt || null);
                                const timeStr = when ? new Date(when).toLocaleString('ar-EG') : '';
                                const link = `https://www.google.com/maps?q=${lat},${lng}`;
                                return `<div class="flex items-center gap-2 p-2 bg-gray-50 rounded">
                                    <span class="font-semibold">${(name||'?????')}</span>
                                    <span class="text-gray-600">(${lat.toFixed(5)}, ${lng.toFixed(5)}${acc?` � �${Math.round(acc)}?`:''})</span>
                                    <a class="text-blue-600 underline ml-auto" target="_blank" href="${link}">??? ???????</a>
                                    <span class="text-xs text-gray-500">${timeStr}</span>
                                </div>`;
                            } catch(e){ return null; }
                        }).filter(Boolean).join('');
                    listEl.innerHTML = rows || '<div class="text-sm text-gray-500">?? ???? ????? ?????? ???? ??????.</div>';
                } catch(e){ /* ignore */ }
            };

            // Interactive map: initialize and update markers
            window.openRepsMap = function(){
                try {
                    const modal = document.getElementById('reps-map-modal');
                    if (!modal) return;
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    setTimeout(()=>{
                        if (!window.__repsMap) {
                            window.__repsMap = L.map('reps-map', { zoomControl: true });
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: '&copy; OpenStreetMap'
                            }).addTo(window.__repsMap);
                        }
                        renderRepMap();
                    }, 50);
                } catch(e){ console.warn('openRepsMap failed', e); }
            };

            window.closeRepsMap = function(){
                try {
                    const modal = document.getElementById('reps-map-modal');
                    if (!modal) return;
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                } catch(e){}
            };

            window.renderRepMap = function(){
                try {
                    if (!window.__repsMap) return;
                    const presence = (state.presence||[]).map(p => {
                        if (!p || !p.location) return null;
                        const lat = Number(p.location.lat);
                        const lng = Number(p.location.lng);
                        if (!isFinite(lat) || !isFinite(lng)) return null;
                        p._lat = lat; p._lng = lng; return p;
                    }).filter(p => p && p.sharing !== false);
                    const bounds = [];
                    // Diagnostic: log presence summary to help debug missing markers
                    try { console.debug('renderRepMap presence:', presence.map(x=>({uid: x.uid||x._id||x.email, email: x.email, lat: x._lat, lng: x._lng, sharing: x.sharing}))); } catch(e){}
                    // Remove markers that are no longer present (use stable key including email fallback)
                    const currentUids = new Set(presence.map(p => String(p.uid||p._id||p.email||'')));
                    Object.keys(window.__repMarkers).forEach(key => {
                        if (!currentUids.has(key)) {
                            try { window.__repsMap.removeLayer(window.__repMarkers[key]); } catch(e){}
                            delete window.__repMarkers[key];
                        }
                    });
                    presence.forEach(p => {
                        const key = String(p.uid || p._id || p.email || '');
                        const lat = p._lat, lng = p._lng;
                        const name = (state.users||[]).find(u=>u.uid===p.uid)?.name || (state.reps||[]).find(r=>r.email && p.email && r.email.toLowerCase()===p.email.toLowerCase())?.name || p.email || '?????';
                        const when = p.locationUpdatedAt && p.locationUpdatedAt.toDate ? p.locationUpdatedAt.toDate() : (p.locationUpdatedAt || null);
                        const timeStr = when ? new Date(when).toLocaleString('ar-EG') : '';
                        const popupHtml = `<div style="min-width:160px"><div style="font-weight:700">${name}</div><div style="font-size:12px;color:#555">${lat.toFixed(5)}, ${lng.toFixed(5)}</div><div style="font-size:11px;color:#777">${timeStr}</div><a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color:#2563eb;text-decoration:underline">??? ???????</a></div>`;
                        if (!window.__repMarkers[key]) {
                            window.__repMarkers[key] = L.marker([lat, lng]).addTo(window.__repsMap).bindPopup(popupHtml);
                        } else {
                            window.__repMarkers[key].setLatLng([lat, lng]);
                            window.__repMarkers[key].setPopupContent(popupHtml);
                        }
                        bounds.push([lat, lng]);
                    });
                    if (bounds.length) {
                        try { window.__repsMap.fitBounds(bounds, { padding: [30,30] }); } catch(e){}
                    }
                } catch(e){ console.warn('renderRepMap failed', e); }
            };

            // Wire header map button and modal close
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const openBtn = document.getElementById('open-map-btn');
                    const closeBtn = document.getElementById('close-map-btn');
                    if (openBtn) openBtn.addEventListener('click', openRepsMap);
                    if (closeBtn) closeBtn.addEventListener('click', closeRepsMap);
                    // Wire header GPS toggle regardless of settings page
                    const hdrBtn = document.getElementById('gps-toggle-btn');
                    if (hdrBtn) {
                        try { window.__gpsHeaderSync(); } catch(e){}
                        hdrBtn.addEventListener('click', function(){
                            try {
                                const isOn = localStorage.getItem('gps_sharing_enabled') === '1';
                                if (isOn) stopLocationSharing(); else startLocationSharing();
                            } catch(e){}
                        });
                    }
                } catch(e){}
            });
        })();

        // ===== ????? ?????? ?? ??? ?? ??? ??? state ???? ??????? ?????? =====
        function initRealtimeRecovery(){
            let attempts = 0;
            const maxAttempts = 5; // ??????? ?????? ????? ??????? ??????????
            const intervalMs = 3000;
            if (window.__REALTIME_RECOVERY_STARTED) return; // ??? ???????
            window.__REALTIME_RECOVERY_STARTED = true;
            const iv = setInterval(()=>{
                attempts++;
                try {
                    const salesOk = Array.isArray(state.sales) && state.sales.length > 0;
                    const customersOk = Array.isArray(state.customers) && state.customers.length > 0;
                    const productsOk = Array.isArray(state.products) && state.products.length > 0;
                    // ??? ???????? ???????? ????? ???? ???????
                    if (salesOk || (customersOk && productsOk)) {
                        clearInterval(iv);
                        return;
                    }
                    // ????? ?????? ????? ?????????
                    console.warn('Realtime recovery attempt', attempts, '� ????? ????? setupRealtimeListeners');
                    setupRealtimeListeners();
                    // ????? ?? ????? ??????? ???? ????
                    try { preloadCachedCollections(); ensureCachedDataRendered(); } catch(e){}
                } catch(e){ console.warn('initRealtimeRecovery loop error', e); }
                if (attempts >= maxAttempts) {
                    clearInterval(iv);
                    console.warn('Realtime recovery stopped ??? ???? ???? ?????? ?????????');
                }
            }, intervalMs);
        }

        /* ================================================================
           ?? ???? ???????? (Schema) ??????? ?? Firestore (??????)
           ---------------------------------------------------------------
           users: {
             uid (doc id), email, name, role, createdAt, lastLoginAt
           }
           customers: {
             id (doc id), name, phone, taxNumber, requiresTaxFiling, priceListId,
             balance (???????), createdAt, updatedAt
           }
           products: {
             id (doc id), name, sku, price, cost, unit, active, createdAt, updatedAt
           }
           sales: {
             id (doc id), invoiceNumber, customerId, repId/repName, items:[{productId, qty, price}],
             total, paidAmount, status (paid|partial|due|return), discountPercent,
             taxFilingStatus, date (ISO), createdAt, updatedAt
           }
           presence (??????? ??????): {
             uid (doc id), email, lastActive: serverTimestamp(), online: true
           }
           ---------------------------------------------------------------
           ???? ???????? ??? ?? ?????? ??? ?????? CRUD ????? ?? ??????? ???????
           ???? state. ????????? ???? ?????? ??? onSnapshot.
        ================================================================ */

        // ???? ?????? ????? ?? ???????
        function serverTs(){
            try { return firebase.firestore.FieldValue.serverTimestamp(); } catch(e){ return new Date(); }
        }

        // ===== CRUD: ???????? =====
        async function addProduct(data){
            const obj = {
                name: data.name || '',
                sku: data.sku || data.id || Date.now().toString(),
                price: Number(data.price||0),
                vat_rate: Number(data.vat_rate||0),
                cost: Number(data.cost||0),
                unit: data.unit || '????',
                active: data.active !== false,
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            return db.collection('products').add(obj);
        }
        async function updateProduct(id, partial){
            // ensure vat_rate is numeric if provided
            const patched = Object.assign({}, partial);
            if (patched.vat_rate !== undefined) patched.vat_rate = Number(patched.vat_rate) || 0;
            return db.collection('products').doc(id).set({ ...patched, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteProduct(id){ return db.collection('products').doc(id).delete(); }

        // ===== CRUD: ??????? =====
        async function addCustomer(data){
            // Local-first persistence: ???? ?????? ??? ?? ????? ?????
            // ????? ??? ????? ???????? ??? ????? CLOUD_ONLY ?? ??? ??????
            const obj = {
                name: data.name || '',
                phone: data.phone || '',
                taxNumber: data.taxNumber || '',
                address: data.address || '',
                repName: data.repName || '',
                requiresTaxFiling: !!data.requiresTaxFiling,
                priceListId: data.priceListId || '',
                balance: Number(data.balance||0),
                // ????? ??????? ??????? ?? ?????? (???????). ?? ?? ?????? ???? ?????? ????? ????????.
                assignedRepId: (function(){
                    try {
                        if (data.assignedRepId) return data.assignedRepId;
                        // ??? ??? ????? ????? ???? ??????? ????? ????????? ????? ??????? ?? ??????? ???????
                        const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                        if (role === 'rep' && window.auth && auth.currentUser) return auth.currentUser.uid;
                        if (data.repName) {
                            const r = window.findRep ? window.findRep(data.repName) : null;
                            return r ? r.id : '';
                        }
                    } catch(e){}
                    return '';
                })(),
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            try {
                // ???? ?????? ??????? ?????
                if (!window.state) window.state = {};
                if (!Array.isArray(window.state.customers)) window.state.customers = [];
                const localId = obj.id || obj._id || (Date.now()+''+Math.random().toString(16).slice(2));
                const localObj = Object.assign({}, obj, { _id: localId });
                window.state.customers.push(localObj);
                // ??? ???? ?? LocalStorage ??? ?? ???? ?????
                try { localStorage.setItem('customers', JSON.stringify(window.state.customers)); } catch(_){ /* ignore localStorage errors */ }
            } catch(e){ /* ignore state update errors */ }

            // ?? ???? ????? ??????? ????????
            return db.collection('customers').add(obj);
        }
        async function updateCustomer(id, partial){
            const obj = { ...partial };
            try {
                if (!obj.assignedRepId && obj.repName) {
                    const r = window.findRep ? window.findRep(obj.repName) : null;
                    if (r) obj.assignedRepId = r.id;
                }
            } catch(e){}
            return db.collection('customers').doc(id).set({ ...obj, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteCustomer(id){ return db.collection('customers').doc(id).delete(); }

        // ===== CRUD: ????? ??????? =====
        async function addPriceListDoc(id, data){
            const ref = id ? db.collection('priceLists').doc(String(id)) : db.collection('priceLists').doc();
            const obj = {
                id: id || ref.id,
                name: data.name || '',
                productPrices: data.productPrices || {},
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            await ref.set(obj, { merge:false });
            return ref;
        }
        async function updatePriceListDoc(id, partial){
            return db.collection('priceLists').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
        }
        async function deletePriceListDoc(id){ return db.collection('priceLists').doc(String(id)).delete(); }

        // ===== CRUD: ???????? =====
        async function addRepDoc(id, data){
            const ref = id ? db.collection('reps').doc(String(id)) : db.collection('reps').doc();
            const obj = {
                id: id || ref.id,
                name: data.name || '',
                serial: data.serial || '',
                target: Number(data.target||0),
                nextInvoiceNumber: data.nextInvoiceNumber || null,
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            await ref.set(obj, { merge:false });
            return ref;
        }
        async function updateRepDoc(id, partial){
            return db.collection('reps').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteRepDoc(id){ return db.collection('reps').doc(String(id)).delete(); }

        // ??????? ????? ???????: ??????? ??? ?????? ??? ?????? ?? ??????? ??? ?????????
        function canManageCustomer(c){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') return true;
                if (role === 'rep') {
                    if (!c) return false;
                    const assigned = c.assignedRepId || '';
                    if (!assigned) return true; // ??? ????? => ???? ??????
                    const current = AuthSystem.getCurrentUser();
                    if (current && current.id === assigned) return true;
                    return false;
                }
                // ????? ???? (viewer/user) ??? ??? ????? ??? ?? ???? ????? ??????
                return true;
            } catch(e){ return true; }
        }
        // ?????? ????: ??? ?????? ????? ???. ??? ????? ????? ???? Firestore ?????? ?? ?? ??????? ?? ???? ?? ????? ??? ??????.

        // ===== CRUD: ???????? =====
        async function addSale(data){
                const obj = {
                id: data.id || undefined,
                invoiceNumber: data.invoiceNumber || null,
                customerId: data.customerId || null,
                repName: data.repName || data.repId || '',
                items: Array.isArray(data.items) ? data.items : [],
                // subtotal, taxAmount and withholdingAmount are optional but preferred for reporting
                // Ensure numeric fields are sanitized to avoid Firestore `undefined` errors
                subtotal: Number(data.subtotal) || 0,
                taxAmount: (data.taxAmount !== undefined) ? Number(data.taxAmount) : (data.vatAmount !== undefined ? Number(data.vatAmount) : 0),
                withholdingAmount: (data.withholdingAmount !== undefined) ? Number(data.withholdingAmount) : 0,
                total: Number(data.total) || 0,
                paidAmount: Number(data.paidAmount||0),
                status: data.status || 'due',
                discountPercent: Number(data.discountPercent||0),
                taxFilingStatus: data.taxFilingStatus || '',
                date: data.date || new Date().toISOString(),
                repEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
                repId: data.repId || null,
                createdBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
                // Admin-entry metadata (if saving on behalf of a rep)
                isAdminEntry: data.isAdminEntry === true,
                recordedByName: data.recordedByName || null,
                originalCreatorId: data.originalCreatorId || null,
                adminEntry: data.adminEntry === true,
                adminEnteredBy: data.adminEnteredBy || null,
                // Backwards-compatible admin flags for easy querying & UI
                created_by_admin: (data.created_by_admin === true) || (data.adminEntry === true) || (data.isAdminEntry === true),
                entry_source: (data.entry_source) ? data.entry_source : (data.adminEntry === true || data.isAdminEntry === true ? 'admin' : (data.entry_source || null)),
                createdAt: serverTs(),
                updatedAt: serverTs(),
                updatedBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null
            };
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // ??????: ???????/???????? => ??? ????????? ??? ??? ?????? ????????
                if (role === 'sales' || role === 'rep') obj.reviewStatus = 'pending';
                else obj.reviewStatus = 'reviewed';
            } catch(_) { obj.reviewStatus = 'pending'; }

            // Ensure each item includes a `vat_rate` and then detect adjusted prices
            try {
                let anyAdjusted = false;
                obj.items = Array.isArray(obj.items) ? obj.items : [];
                // normalize vat_rate on each item from product master if missing
                obj.items = obj.items.map(it => {
                    try {
                        const item = Object.assign({}, it);
                        const prod = findProduct(item.productId) || {};
                        item.vat_rate = (item.vat_rate !== undefined && item.vat_rate !== null) ? Number(item.vat_rate) : (prod && prod.vat_rate ? Number(prod.vat_rate) : 0);
                        return item;
                    } catch(e){ return it; }
                });
                obj.items = obj.items.map(it => {
                    try {
                        const item = Object.assign({}, it);
                        const prod = findProduct(item.productId) || {};
                        let expectedPrice = (prod.price != null) ? Number(prod.price) : 0;
                        try {
                            const customer = findCustomer(obj.customerId);
                            if (customer && customer.priceListId) {
                                const pl = findPriceList(customer.priceListId);
                                if (pl && pl.productPrices && pl.productPrices[item.productId] !== undefined) expectedPrice = Number(pl.productPrices[item.productId]);
                            }
                        } catch(_){ }
                        try {
                            const promo = getActivePromotionPrice(item.productId, obj.customerId);
                            if (promo !== null && promo !== undefined) expectedPrice = Number(promo);
                        } catch(_){ }
                        const entered = Number(item.price) || 0;
                        const diff = Math.abs(entered - (Number(expectedPrice) || 0));
                        if (diff > 0.005) {
                            item.adjusted = true;
                            anyAdjusted = true;
                        } else {
                            item.adjusted = item.adjusted === true;
                        }
                        item.expectedPrice = expectedPrice;
                        return item;
                    } catch(e){ return it; }
                });
                if (anyAdjusted) {
                    obj.reviewReason = 'adjusted';
                    obj.reviewStatus = 'pending';
                    try { obj.reviewRequestedBy = (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : null; } catch(_){ }
                    obj.reviewRequestedAt = new Date().toISOString();
                    console.log('addSale: detected adjusted prices, marking reviewReason=adjusted', { id: obj.id, invoiceNumber: obj.invoiceNumber });
                }
            } catch(e){ console.warn('addSale: adjusted-detection failed', e); }
            const ref = data && data.id
                ? db.collection('sales').doc(String(data.id))
                : db.collection('sales').doc();
            if (!data.id) obj.id = ref.id;
            try {
                console.log('addSale: writing doc', obj.id, 'invoice:', obj.invoiceNumber);
                await ref.set(obj, { merge: false });
                console.log('addSale: write success', obj.id);
            } catch (e) {
                console.warn('addSale: write failed', e);
                // If this is a permission error and the user is an admin, try fallback paths
                const msg = (e && e.message) ? String(e.message).toLowerCase() : '';
                const code = e && e.code ? e.code : null;
                const isPerm = (code === 'permission-denied' || (typeof code === 'string' && code.toLowerCase().includes('permission'))) || msg.includes('permission') || msg.includes('insufficient');
                if (isPerm) {
                    try {
                        // Try writing to a project-level `invoices` collection as fallback
                        const invoicesRef = db.collection('invoices').doc(obj.id);
                        await invoicesRef.set(obj, { merge: false });
                        console.log('addSale: fallback write success to invoices/', obj.id);
                        // update local ref variable so callers receive a docref-like value
                        ref = invoicesRef;
                    } catch (e2) {
                        console.warn('addSale: fallback to invoices failed', e2);
                        // Try per-user invoices subcollection if repId exists
                        if (obj.repId) {
                            try {
                                const userInvRef = db.collection('users').doc(String(obj.repId)).collection('invoices').doc(obj.id);
                                await userInvRef.set(obj, { merge: false });
                                console.log('addSale: fallback write success to users/{repId}/invoices/', obj.id);
                                ref = userInvRef;
                            } catch (e3) {
                                console.warn('addSale: fallback to users/{repId}/invoices failed', e3);
                                // All fallbacks failed � rethrow the original permission error for upstream handling
                                throw e;
                            }
                        } else {
                            // No repId to try per-user path � rethrow original
                            throw e;
                        }
                    }
                } else {
                    throw e;
                }
            }
            // Update local cache immediately to survive refresh when reads are blocked
            try { upsertCachedSale(Object.assign({}, obj, { _id: obj.id })); } catch(e){}
            // Optional: update UI quickly if snapshots are blocked
            try {
                if (!window.state) window.state = {};
                if (!Array.isArray(state.sales)) state.sales = [];
                const exists = state.sales.some(s => (s.id||s._id) === obj.id);
                if (!exists) state.sales.unshift(Object.assign({}, obj));
                const textFilter = document.getElementById('search-sales-text')?.value || '';
                const dateFilter = document.getElementById('search-sales-date')?.value || '';
                const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                if (typeof renderDashboard === 'function') renderDashboard();
            } catch(e){}
            return ref;
        }
        // ===== CRUD: ?????? ?????? (dispatchNotes) =====
        async function addDispatchNote(data){
            const base = {
                noteNumber: data.noteNumber || null,
                repName: data.repName || '',
                date: data.date || new Date().toISOString(),
                items: Array.isArray(data.items) ? data.items : [],
                createdAt: serverTs(),
                updatedAt: serverTs(),
                createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null
            };
            const ref = data && data.id ? db.collection('dispatchNotes').doc(String(data.id)) : db.collection('dispatchNotes').doc();
            if (!data.id) base.id = ref.id; else base.id = data.id;
            await ref.set(base, { merge:false });
            // ????? ???? ???? ??? ?? ??? ???napshot ???
            try {
                if (!state.dispatchNotes) state.dispatchNotes = [];
                const exists = state.dispatchNotes.some(n => (n.id||n._id) === base.id);
                if (!exists) state.dispatchNotes.unshift(Object.assign({}, base));
                if (typeof renderDispatchPage === 'function') renderDispatchPage();
            } catch(e){}
            return ref;
        }
        async function updateDispatchNote(id, partial){
            const meta = { updatedAt: serverTs() };
            await db.collection('dispatchNotes').doc(id).set({ ...partial, ...meta }, { merge:true });
            try {
                if (Array.isArray(state.dispatchNotes)){
                    const i = state.dispatchNotes.findIndex(n => (n.id||n._id) === id);
                    if (i>=0) state.dispatchNotes[i] = Object.assign({}, state.dispatchNotes[i], partial, { id });
                    if (typeof renderDispatchPage === 'function') renderDispatchPage();
                }
            } catch(e){}
        }
        async function deleteDispatchNote(id){
            await db.collection('dispatchNotes').doc(id).delete();
            try {
                state.dispatchNotes = (state.dispatchNotes||[]).filter(n => (n.id||n._id) !== id);
                if (typeof renderDispatchPage === 'function') renderDispatchPage();
            } catch(e){}
        }
        async function updateSale(id, partial){
            // ??? ????? ?????? ??? ??? ?????
            try {
                if (Array.isArray(state.sales)){
                    const s = state.sales.find(x => (x.id||x._id) === id);
                    if (s && (s.locked === true || (s.lockPeriod && String(s.lockPeriod).length))) {
                        alert('??? ???????? ??? ??? ????? ??? ???? ???????');
                        throw new Error('sale-locked');
                    }
                }
            } catch(e){}
            const meta = { updatedAt: serverTs() };
            try { if (window.auth && auth.currentUser) meta.updatedBy = auth.currentUser.uid; } catch(e){}
            await db.collection('sales').doc(id).set({ ...partial, ...meta }, { merge:true });
            // ??? ??? ??????? (???????) ????????? ????/???? ??????? ????? ??? ???? ?????? ???????
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = (typeof AuthSystem !== 'undefined' && AuthSystem.getCurrentUser) ? AuthSystem.getCurrentUser() : null;
                // ??? ??????? ????? ?? ?????? ?? ?? ???????? ???????
                let targetRepName = null;
                try {
                    const existing = Array.isArray(state.sales) ? state.sales.find(x => (x.id||x._id) === id) : null;
                    targetRepName = (partial && partial.repName) ? String(partial.repName) : (existing && existing.repName ? String(existing.repName) : null);
                } catch(_){}
                if (role === 'admin' && current && targetRepName) {
                    // Find rep's actual Firebase Auth UID from state.users by matching email
                    let repUid = null;
                    try {
                        const rep = (state.reps||[]).find(r => r.name === targetRepName);
                        const repEmail = rep && rep.email ? String(rep.email).toLowerCase() : null;
                        if (repEmail && Array.isArray(state.users)) {
                            const userDoc = state.users.find(u => (u.email || '').toLowerCase() === repEmail);
                            repUid = userDoc ? (userDoc.uid || userDoc._id || userDoc.id) : null;
                        }
                    } catch(e){ console.warn('Failed to find rep uid in updateSale:', e); }
                    
                    if (repUid && String(current.id) !== String(repUid)) {
                        const docDataSnap = await db.collection('sales').doc(id).get();
                        const mergedData = Object.assign({}, (docDataSnap.exists ? (docDataSnap.data()||{}) : {}), partial, meta, { id });
                        // ?????/??? ???????? ??????? ??? ???? ??????? ????? ???????? ??????? ??? ?????
                        await db.collection('users').doc(String(repUid)).collection('invoices').doc(String(id)).set(mergedData, { merge: true });
                        try { console.log('?? Admin updated sale copied to user subcollection:', { repName: targetRepName, repUid, id }); } catch(_){ }
                    }
                }
            } catch(e){ console.warn('updateSale: admin sync to users/{repId}/invoices failed', e); }
            try {
                const list = getCachedSales();
                const idx = list.findIndex(s => (s.id||s._id) === id);
                if (idx >= 0) {
                    list[idx] = Object.assign({}, list[idx], partial, { id, _id: id });
                    setCachedSales(list);
                }
            } catch(e){}
            // Soft update UI if snapshots are blocked
            try {
                if (Array.isArray(state.sales)){
                    const i = state.sales.findIndex(s => (s.id||s._id) === id);
                    if (i >= 0) state.sales[i] = Object.assign({}, state.sales[i], partial, { id });
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    if (typeof renderDashboard === 'function') renderDashboard();
                }
            } catch(e){}
        }
        async function deleteSale(id){
            await db.collection('sales').doc(id).delete();
            try { removeCachedSale(id); } catch(e){}
            try {
                if (Array.isArray(state.sales)){
                    state.sales = state.sales.filter(s => (s.id||s._id) !== id);
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    if (typeof renderDashboard === 'function') renderDashboard();
                }
            } catch(e){}
        }

        // ??????: ???? ??????? ???????? ????????? ???? ??????? ???? ????? ??? ??????.

        // ??????? ?? ??????? ????? ?? state.*.push ?? ??????? ???????? ??? ??????.

        // ===== Seeding: ?????? ???????? (Admin/First-time) =====
        async function seedDefaultsIfEmpty(){
            try {
                if (!window.db) return;
                // ???? ?????????: ???? ?????? ??? ??? ????? 'admin' ?? ??? ???? ????????? ????? ?????? (????? ???)
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const [custSnap, plSnap] = await Promise.all([
                    db.collection('customers').limit(1).get(),
                    db.collection('priceLists').limit(1).get()
                ]);
                // ??? ??? Admin ????? ?????? ??????? ?? ???? ???
                if (custSnap && !custSnap.empty && plSnap && !plSnap.empty) return;
                if (role !== 'admin' && !(custSnap.empty && plSnap.empty)) return;

                console.log('Seeding default data: customers, products, priceLists');

                const batch = db.batch();

                // ?????? ?????? ???????? ????? ???? ????? ??????? ?????
                const products = [
                    { id: 'P001', name: '???? 1', sku: 'SKU-001', price: 100, cost: 70, unit: '????' },
                    { id: 'P002', name: '???? 2', sku: 'SKU-002', price: 150, cost: 110, unit: '????' },
                    { id: 'P003', name: '???? 3', sku: 'SKU-003', price: 200, cost: 140, unit: '????' }
                ];
                products.forEach(p => {
                    const ref = db.collection('products').doc(p.id);
                    batch.set(ref, {
                        name: p.name,
                        sku: p.sku,
                        price: Number(p.price||0),
                        cost: Number(p.cost||0),
                        unit: p.unit || '????',
                        active: true,
                        createdAt: serverTs(),
                        updatedAt: serverTs()
                    }, { merge: true });
                });

                // ????? ????? ???????? ?????? (retail / wholesale) ?? ????? ????? ???????? ?????
                const retailPrices = { P001: 100, P002: 150, P003: 200 };
                const wholesalePrices = { P001: 90, P002: 135, P003: 180 };

                const plRetailRef = db.collection('priceLists').doc('retail');
                batch.set(plRetailRef, {
                    name: '????? (retail)',
                    productPrices: retailPrices,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });

                const plWholesaleRef = db.collection('priceLists').doc('wholesale');
                batch.set(plWholesaleRef, {
                    name: '???? (wholesale)',
                    productPrices: wholesalePrices,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });

                // ????? ????????? ??????? ?????? ???????
                const customers = [
                    { id: 'CUST001', name: '???? ????? 1', phone: '01000000001', priceListId: 'retail', requiresTaxFiling: false },
                    { id: 'CUST002', name: '???? ???? 1',  phone: '01000000002', priceListId: 'wholesale', requiresTaxFiling: true },
                    { id: 'CUST003', name: '???? ????? 2', phone: '01000000003', priceListId: 'retail', requiresTaxFiling: false }
                ];
                customers.forEach(c => {
                    const ref = db.collection('customers').doc(c.id);
                    batch.set(ref, {
                        name: c.name,
                        phone: c.phone || '',
                        taxNumber: '',
                        requiresTaxFiling: !!c.requiresTaxFiling,
                        priceListId: c.priceListId,
                        balance: 0,
                        createdAt: serverTs(),
                        updatedAt: serverTs()
                    }, { merge: true });
                });

                await batch.commit();
                console.log('? Seeding complete');
                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                // ??? ????? ???? ????? ?? ??????? ????? ?????? ?????? ??? ???? ?????
                try { initLegacyCollectionsIfEmpty(); } catch(e){}
            } catch (e) {
                console.warn('Seeding failed', e);
            }
        }

        // ===== ????? ?? ????? ??????? ????? ?????? (Customers / PriceLists / price_lists) =====
        async function initLegacyCollectionsIfEmpty(){
            if (!window.db) return;
            const needCustomers = !state.customers || state.customers.length === 0;
            const needPriceLists = !state.priceLists || state.priceLists.length === 0;
            if (!needCustomers && !needPriceLists) return;
            console.log('Checking legacy collection names for data...');
            const tasks = [];
            if (needCustomers) tasks.push(db.collection('Customers').get().catch(()=>null));
            if (needCustomers) tasks.push(db.collection('customers_old').get().catch(()=>null));
            if (needPriceLists) tasks.push(db.collection('PriceLists').get().catch(()=>null));
            if (needPriceLists) tasks.push(db.collection('price_lists').get().catch(()=>null));
            const results = await Promise.all(tasks);
            results.forEach(snapshot => {
                if (!snapshot || snapshot.empty) return;
                const firstDoc = snapshot.docs[0];
                const collName = firstDoc && firstDoc.ref && firstDoc.ref.parent && firstDoc.ref.parent.id;
                if (!collName) return;
                if (['Customers','customers_old'].includes(collName)) {
                    const arr = []; snapshot.forEach(doc=>{ const d = doc.data(); d._legacy = true; d._id = doc.id; arr.push(d); });
                    if (arr.length > 0 && (!state.customers || state.customers.length === 0)) {
                        state.customers = arr;
                        console.log('Imported legacy customers from', collName, 'count=', arr.length);
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                    }
                }
                if (['PriceLists','price_lists'].includes(collName)) {
                    const arr = []; snapshot.forEach(doc=>{ const d = doc.data(); d._legacy = true; d.id = doc.id; arr.push(d); });
                    if (arr.length > 0 && (!state.priceLists || state.priceLists.length === 0)) {
                        state.priceLists = arr;
                        console.log('Imported legacy priceLists from', collName, 'count=', arr.length);
                        try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                    }
                }
            });
        }

        // ===== ???? ????? ???????? ???????? (??????? + ????? ???????) ?? ??????? ?? ????? ??????? ??? ?????? =====
        async function ensureCoreData(){
            if (!db) return;
            if (window.__coreDataEnsured) return;
            const needCustomers = !state.customers || state.customers.length === 0;
            const needPriceLists = !state.priceLists || state.priceLists.length === 0;
            const needProducts = !state.products || state.products.length === 0;
            const needReps = !state.reps || state.reps.length === 0;
            if (!needCustomers && !needPriceLists && !needProducts && !needReps) { window.__coreDataEnsured = true; return; }
            console.log('ensureCoreData: ?????? ????? ???????? ????????');
            try {
                // ??????? ?????? ??????? ????? (??? ???? ????????? ????? ?????) ??? ??????? ????????
                try { await importEmbeddedBackupIfNeeded(); } catch(e){ console.warn('importEmbeddedBackupIfNeeded early call failed', e); }
                const [custSnap, plSnap, prodSnap, repsSnap] = await Promise.all([
                    needCustomers ? db.collection('customers').get() : Promise.resolve(null),
                    needPriceLists ? db.collection('priceLists').get() : Promise.resolve(null),
                    needProducts ? db.collection('products').get() : Promise.resolve(null),
                    needReps ? db.collection('reps').get() : Promise.resolve(null)
                ]);
                if (custSnap && !custSnap.empty) {
                    const arr = [];
                    custSnap.forEach(doc => {
                        const d = doc.data();
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    state.customers = arr; console.log('ensureCoreData: customers fetched =', arr.length);
                    try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                    try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                }
                if (plSnap && !plSnap.empty) {
                    const arr = []; plSnap.forEach(doc => {
                        const d = doc.data() || {};
                        const pl = { id: doc.id, name: d.name || d.title || doc.id, productPrices: {} };
                        if (d.productPrices && typeof d.productPrices === 'object') pl.productPrices = d.productPrices;
                        else if (d.prices && typeof d.prices === 'object') pl.productPrices = d.prices;
                        else if (d.map && typeof d.map === 'object') pl.productPrices = d.map;
                        else {
                            const pp = {}; Object.keys(d).forEach(k => { if (/^\d+$/.test(k) && typeof d[k] === 'number') pp[k] = d[k]; });
                            pl.productPrices = pp;
                        }
                        arr.push(pl);
                    });
                    state.priceLists = arr; console.log('ensureCoreData: priceLists fetched =', arr.length);
                    try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                    try { updateAllPriceListDropdowns(); } catch(e){}
                    // ????? ??? ??????? ??? ?????? ??????? ????? ??? priceListId
                    try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                }
                if (prodSnap && !prodSnap.empty) {
                    const arr = [];
                    prodSnap.forEach(doc => {
                        const d = doc.data();
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    state.products = arr; console.log('ensureCoreData: products fetched =', arr.length);
                    try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                }
                if (repsSnap && !repsSnap.empty) {
                    const arr = []; repsSnap.forEach(doc => { const d = doc.data(); d.id = doc.id; arr.push(d); });
                    state.reps = arr; console.log('ensureCoreData: reps fetched =', arr.length);
                    try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
                }
            } catch(e){ console.warn('ensureCoreData: ??? ????? ????????? ????????', e); }

            // ??? ?? ???? ????? ????? ????? ????? ?????? ????? ???????? ?? ???????
            const stillNeedCust = !state.customers || state.customers.length === 0;
            const stillNeedPL = !state.priceLists || state.priceLists.length === 0;
            if (stillNeedCust || stillNeedPL) {
                console.log('ensureCoreData: ?????? ??? ????? Legacy ??????');
                try {
                    if (stillNeedCust) {
                        const legacyCustNames = ['Customers','customers_old'];
                        for (const cname of legacyCustNames) {
                            try {
                                const snap = await db.collection(cname).get();
                                if (!snap.empty) {
                                    const batch = db.batch(); const arr=[];
                                    snap.forEach(doc => { const d=doc.data(); d._legacy=true; d._id=doc.id; arr.push(d); const ref=db.collection('customers').doc(doc.id); batch.set(ref, { name:d.name||'', phone:d.phone||'', taxNumber:d.taxNumber||'', requiresTaxFiling:!!d.requiresTaxFiling, priceListId:d.priceListId||'', balance:Number(d.balance||0), createdAt: d.createdAt||serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                    await batch.commit();
                                    state.customers = arr; console.log('ensureCoreData: imported legacy customers from', cname, 'count=', arr.length);
                                    try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                                    break;
                                }
                            } catch(err){ /* ignore */ }
                        }
                    }
                    if (stillNeedPL) {
                        const legacyPLNames = ['PriceLists','price_lists'];
                        for (const cname of legacyPLNames) {
                            try {
                                const snap = await db.collection(cname).get();
                                if (!snap.empty) {
                                    const batch = db.batch(); const arr=[];
                                    snap.forEach(doc => { const d=doc.data(); d._legacy=true; d.id=doc.id; arr.push(d); const ref=db.collection('priceLists').doc(doc.id); batch.set(ref, { name: d.name||d.title||'?????', productPrices: d.productPrices||d.prices||{}, createdAt: d.createdAt||serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                    await batch.commit();
                                    state.priceLists = arr; console.log('ensureCoreData: imported legacy priceLists from', cname, 'count=', arr.length);
                                    try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                    try { updateAllPriceListDropdowns(); } catch(e){}
                                    break;
                                }
                            } catch(err){ /* ignore */ }
                        }
                    }
                } catch(e){ console.warn('ensureCoreData legacy phase error', e); }
            }

            // ????? ?????: ??????? ?? ????? ??????? ??????? ?? ?? ??? ????
            const finalNeedCust = !state.customers || state.customers.length === 0;
            const finalNeedPL = !state.priceLists || state.priceLists.length === 0;
            const finalNeedProd = !state.products || state.products.length === 0;
            if (finalNeedCust || finalNeedPL || finalNeedProd) {
                console.log('ensureCoreData: ?????? ?? ????? ???????');
                try {
                    const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('app_state_backup_')).sort();
                    if (backupKeys.length) {
                        const latest = localStorage.getItem(backupKeys[backupKeys.length-1]);
                        if (latest) {
                            const parsed = JSON.parse(latest);
                            const batch = db.batch();
                            if (finalNeedCust && Array.isArray(parsed.customers) && parsed.customers.length) {
                                parsed.customers.forEach(c => { if (!c || !c.name) return; const id = c.id || c._id || c.name.replace(/\s+/g,'_'); const ref=db.collection('customers').doc(id); batch.set(ref,{ name:c.name, phone:c.phone||'', taxNumber:c.taxNumber||'', requiresTaxFiling:!!c.requiresTaxFiling, priceListId:c.priceListId||'', balance:Number(c.balance||0), createdAt: serverTs(), updatedAt: serverTs() },{ merge:true}); });
                                state.customers = parsed.customers.map(c => ({...c, _id: c.id||c._id||c.name.replace(/\s+/g,'_')}));
                            }
                            if (finalNeedPL && Array.isArray(parsed.priceLists) && parsed.priceLists.length) {
                                parsed.priceLists.forEach(pl => { if (!pl || !pl.name) return; const id = pl.id || pl.name.replace(/\s+/g,'_'); const ref=db.collection('priceLists').doc(id); batch.set(ref,{ name: pl.name, productPrices: pl.productPrices||{}, createdAt: serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                state.priceLists = parsed.priceLists.map(pl => ({...pl, id: pl.id||pl.name.replace(/\s+/g,'_')}));
                            }
                            if (finalNeedProd && Array.isArray(parsed.products) && parsed.products.length) {
                                parsed.products.forEach(p => { if (!p || !p.name) return; const id = p.id || p._id || p.sku || p.name.replace(/\s+/g,'_'); const ref=db.collection('products').doc(id); batch.set(ref,{ name:p.name, sku:p.sku||id, price:Number(p.price||0), cost:Number(p.cost||p.price||0), unit:p.unit||'????', active:p.active!==false, createdAt: serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                state.products = parsed.products.map(p => ({...p, _id: p.id||p._id||p.sku||p.name.replace(/\s+/g,'_')}));
                            }
                            if (!batch._ops || batch._ops.length) { await batch.commit(); }
                            if (state.customers && state.customers.length) { try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){} }
                            if (state.priceLists && state.priceLists.length) { try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){} try { updateAllPriceListDropdowns(); } catch(e){} }
                            if (state.products && state.products.length) { try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){} }
                            console.log('ensureCoreData: ??????? ?? ????? ??????? ?????');
                        }
                    }
                    // ?????? ??????: ??????? ?????? ?? ?????? ????? ?????? ??? ?? ??? ????
                    const stillNeedAfterBackupCust = !state.customers || state.customers.length === 0;
                    const stillNeedAfterBackupPL = !state.priceLists || state.priceLists.length === 0;
                    const stillNeedAfterBackupProd = !state.products || state.products.length === 0;
                    if (stillNeedAfterBackupCust || stillNeedAfterBackupPL || stillNeedAfterBackupProd){
                        const legacyRecovered = recoverLegacyLocalData();
                        const batch2 = db.batch();
                        if (stillNeedAfterBackupProd && legacyRecovered.products.length){
                            legacyRecovered.products.forEach(p => {
                                if (!p || !p.name) return; const id = p.id || p._id || p.sku || slugId(p.name);
                                batch2.set(db.collection('products').doc(id), {
                                    name: p.name || p.title || '????',
                                    sku: p.sku || p.code || id,
                                    price: Number(p.price || p.unitPrice || 0),
                                    cost: Number(p.cost || p.purchaseCost || p.price || 0),
                                    unit: p.unit || '????',
                                    active: p.active !== false,
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.products = legacyRecovered.products.map(p => ({
                                _id: p.id || p._id || p.sku || slugId(p.name),
                                name: p.name || p.title || '????',
                                sku: p.sku || p.code || (p.id || ''),
                                price: Number(p.price || p.unitPrice || 0),
                                cost: Number(p.cost || p.purchaseCost || p.price || 0),
                                unit: p.unit || '????',
                                active: p.active !== false
                            }));
                        }
                        if (stillNeedAfterBackupPL && legacyRecovered.priceLists.length){
                            legacyRecovered.priceLists.forEach(pl => {
                                const id = pl.id || pl.code || slugId(pl.name,'pl_'+Date.now());
                                batch2.set(db.collection('priceLists').doc(id), {
                                    name: pl.name || pl.title || '????? ?????',
                                    productPrices: pl.productPrices || pl.prices || pl.map || {},
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.priceLists = legacyRecovered.priceLists.map(pl => ({
                                id: pl.id || pl.code || slugId(pl.name),
                                name: pl.name || pl.title || '????? ?????',
                                productPrices: pl.productPrices || pl.prices || pl.map || {}
                            }));
                        }
                        const hasCustNow = state.customers && state.customers.length;
                        if (stillNeedAfterBackupCust && !hasCustNow && legacyRecovered.customers && legacyRecovered.customers.length){
                            legacyRecovered.customers.forEach(c => {
                                if (!c || !c.name) return; const id = c.id || c._id || slugId(c.name);
                                batch2.set(db.collection('customers').doc(id), {
                                    name: c.name,
                                    phone: c.phone || '',
                                    taxNumber: c.taxNumber || '',
                                    requiresTaxFiling: !!c.requiresTaxFiling,
                                    priceListId: c.priceListId || '',
                                    balance: Number(c.balance || 0),
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.customers = legacyRecovered.customers.map(c => ({...c, _id: c.id || c._id || slugId(c.name)}));
                        }
                        if (batch2._mutations && batch2._mutations.length){
                            await batch2.commit();
                            console.log('?? ??????? ?????? ?????? ?? ?????? ????? ?????');
                        }
                        if (state.products && state.products.length){ try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){} }
                        if (state.priceLists && state.priceLists.length){ try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){} try { updateAllPriceListDropdowns(); } catch(e){} }
                        if (state.customers && state.customers.length){ try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){} }
                    }
                    // ?????: ??????? ?????? ?? ?????? ??????? ???? ????? (?? ?? ??? ??????? ?????? ?? ???????)
                    let needAfterAllPL = !state.priceLists || state.priceLists.length === 0;
                    if (needAfterAllPL && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025) && window.EMBEDDED_PRICE_LISTS_BACKUP_2025.length){
                        try {
                            const res = await importBackupObject({ priceLists: window.EMBEDDED_PRICE_LISTS_BACKUP_2025 }, {
                                importCustomers:false, importProducts:false, importPriceLists:true,
                                importSales:false, importReps:false, importPromotions:false,
                                importSettings:false, importDispatchNotes:false, importStockEntries:false, importNotifications:false
                            });
                            if (res && res.ok && res.counts && res.counts.priceLists > 0){
                                console.log('? ?? ??????? ????? ??????? ?? ?????? ???????:', res.counts.priceLists);
                                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                try { updateAllPriceListDropdowns(); } catch(e){}
                            }
                        } catch(e){ console.warn('??? ??????? ??????? ?? ?????? ???????', e); }
                        needAfterAllPL = !state.priceLists || state.priceLists.length === 0;
                    }

                    // ?????? ?????: ??? ?? ??? HTML ???? ?? ??? ?????? (1458.html)
                    if (needAfterAllPL) {
                        try {
                            const imported = await importPriceListsFromLegacyHtmlFile('1458.html');
                            if (imported > 0) {
                                console.log('? ?? ??????? ????? ??????? ?? 1458.html:', imported);
                                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                try { updateAllPriceListDropdowns(); } catch(e){}
                            } else {
                                console.log('?? ??? ?????? ??? ????? ????? ???? 1458.html? ????? ??????? window.importPriceListsFromLocalFile() ??????? ??? ??????');
                            }
                        } catch(e){ console.warn('??? ??????? ????? ??????? ?? 1458.html', e); }
                    }
                } catch(e){ console.warn('ensureCoreData local backup phase error', e); }
            }
            if (state.customers && state.customers.length && state.priceLists && state.priceLists.length && state.products && state.products.length && state.reps && state.reps.length) window.__coreDataEnsured = true;
        }
        function scheduleEnsureCoreData(){
            setTimeout(ensureCoreData, 1500);
            // ????? ???? ?????? ?? ????? ???????? (?? ?????) ??? ????? ?????? ?????
            setTimeout(function(){ try { migrateSalesFromUserDocIfFound(); } catch(e){} }, 3000);
            // ???? ?????? ????? ?? ??????? ??? ?????
            setTimeout(function(){ try { if (typeof window.loadCashFromCloud === 'function') window.loadCashFromCloud(); } catch(e){ console.warn('loadCashFromCloud on startup failed', e); } }, 2500);
            setTimeout(ensureCoreData, 5000);
            setTimeout(ensureCoreData, 12000);
        }

        // ===== ??????? ?? shared/public_app_state.appState ??? ????????? ???????? (?? ????? ???????????) =====
        function slugId(name, fallback){
            try { return (name||'').toString().trim().toLowerCase().replace(/[^a-z0-9\u0600-\u06FF]+/gi,'_').replace(/^_+|_+$/g,'') || fallback || (Date.now()+'');} catch(e){ return fallback || (Date.now()+''); }
        }
        // ??????? ???? ?? ?????? localStorage ???????? (?????? / ????? ????? / ?????)
        function recoverLegacyLocalData(){
            const possibleProductKeys = [ 'products','product_list','app_products','products_data','finished_products','cost_finished' ];
            const possiblePriceListKeys = [ 'priceLists','price_lists','app_priceLists','priceListsData','price_lists_data','pricing_tables' ];
            const possibleCustomerKeys = [ 'customers','customer_list','app_customers','customers_data' ];
            const products = [];
            const priceLists = [];
            const customers = [];
            function tryParse(key){
                try { const raw = localStorage.getItem(key); if (!raw) return null; return JSON.parse(raw); } catch(e){ return null; }
            }
            possibleProductKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(p => { if (p && (p.name||p.title)) products.push(p); }); }
                else if (typeof val === 'object') { Object.keys(val).forEach(id => { const p=val[id]; if (p && (p.name||p.title)) products.push(Object.assign({ id }, p)); }); }
            });
            possiblePriceListKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(pl => { if (pl && (pl.name||pl.title)) priceLists.push(pl); }); }
                else if (typeof val === 'object') {
                    const looksMap = Object.values(val).every(v => typeof v === 'number');
                    if (looksMap) priceLists.push({ name: 'Legacy List', productPrices: val });
                    else Object.keys(val).forEach(id => { const pl=val[id]; if (pl && (pl.name||pl.title)) priceLists.push(Object.assign({ id }, pl)); else if (pl && typeof pl==='object' && Object.values(pl).every(v=>typeof v==='number')) priceLists.push({ id, name:id, productPrices: pl }); });
                }
            });
            possibleCustomerKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(c => { if (c && c.name) customers.push(c); }); }
                else if (typeof val === 'object') { Object.keys(val).forEach(id => { const c=val[id]; if (c && c.name) customers.push(Object.assign({ id }, c)); }); }
            });
            console.log('recoverLegacyLocalData: products=', products.length, 'priceLists=', priceLists.length, 'customers=', customers.length);
            return { products, priceLists, customers };
        }
        // ===== ??????? ????? ??????? ?? ??? HTML ???? (????? 1458.html) =====
        function normalizePriceListsArray(arr){
            try {
                if (!Array.isArray(arr)) return [];
                return arr.map(pl => ({
                    id: pl.id || pl.code || slugId(pl.name, undefined),
                    name: pl.name || pl.title || '????? ?????',
                    productPrices: pl.productPrices || pl.prices || pl.map || {}
                })).filter(pl => pl && pl.name && pl.productPrices && typeof pl.productPrices === 'object');
            } catch(e){ return []; }
        }

        function tryParseJsonLoose(text){
            try { return JSON.parse(text); } catch(e) {}
            try { return JSON.parse(text.replace(/\,\s*}/g,'}').replace(/\,\s*]/g,']')); } catch(e) {}
            try {
                // replace single quotes cautiously (only around keys/strings)
                const t = text.replace(/"/g,'\"').replace(/'([^']*)'/g,'"$1"');
                return JSON.parse(t);
            } catch(e) { return null; }
        }

        // ?? ??? ????? ?????????? ???????? ??????? ????? ??? ??? ????????
        window.EMBEDDED_PRICE_LISTS_BACKUP_2025 = [];
        window.EMBEDDED_FULL_BACKUP = { customers:[], products:[], priceLists:[], reps:[], promotions:[], sales:[] };
        async function importEmbeddedBackupIfNeeded(){ return { ok:true, disabled:true }; }
        // ??? ????? ???? ????????? ?????? ??????? ??? ??? ?????.

        // ===== ??????? ???? ???????? ????? (JSON) ??? ????????? ???????? =====
        async function importBackupObject(backup, options){
            const opts = Object.assign({
                importCustomers: true,
                importProducts: true,
                importPriceLists: true,
                importSales: true,
                importReps: true,
                importPromotions: true,
                importSettings: true,
                importDispatchNotes: true,
                importStockEntries: true,
                importNotifications: true
            }, options||{});
            if (!db) { console.warn('Firestore ??? ????'); return { ok:false, reason:'no-db' }; }
            const counts = { customers:0, products:0, priceLists:0, sales:0, reps:0, promotions:0, settings:0, dispatchNotes:0, stockEntries:0, notifications:0 };
            let batch = db.batch();
            let pending = 0;
            async function commitIfNeeded(force){ if (force || pending >= 450) { await batch.commit(); batch = db.batch(); pending = 0; } }

            try {
                if (opts.importCustomers && Array.isArray(backup.customers)){
                    for (const c of backup.customers){
                        const id = c.id || slugId(c.name);
                        const ref = db.collection('customers').doc(id);
                        batch.set(ref, {
                            name: c.name || '',
                            phone: c.phone || '',
                            taxNumber: c.taxNumber || '',
                            requiresTaxFiling: !!c.requiresTaxFiling,
                            priceListId: c.priceListId || '',
                            repName: c.repName || '',
                            address: c.address || '',
                            createdAt: c.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.customers++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importProducts && Array.isArray(backup.products)){
                    for (const p of backup.products){
                        const id = (p.id || slugId(p.name)).toString();
                        const ref = db.collection('products').doc(id);
                        batch.set(ref, {
                            name: p.name || '',
                            sku: p.sku || id,
                            price: Number(p.price||0),
                            cost: Number(p.cost||0),
                            unit: p.unit || '????',
                            active: p.active !== false,
                            createdAt: p.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.products++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importPriceLists && Array.isArray(backup.priceLists)){
                    for (const pl of backup.priceLists){
                        const id = pl.id || slugId(pl.name);
                        const ref = db.collection('priceLists').doc(id);
                        batch.set(ref, {
                            name: pl.name || id,
                            productPrices: pl.productPrices || pl.prices || {},
                            createdAt: pl.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.priceLists++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importReps && Array.isArray(backup.reps)){
                    for (const r of backup.reps){
                        const id = r.id || slugId(r.name);
                        const ref = db.collection('reps').doc(id);
                        batch.set(ref, {
                            name: r.name || '',
                            serial: r.serial || '',
                            target: Number(r.target||0),
                            nextInvoiceNumber: (r.nextInvoiceNumber==null? null : r.nextInvoiceNumber),
                            createdAt: r.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.reps++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importSales && Array.isArray(backup.sales)){
                    for (const s of backup.sales){
                        const sid = (s.id || '').toString() || undefined;
                        const ref = sid ? db.collection('sales').doc(sid) : db.collection('sales').doc();
                        const items = Array.isArray(s.items) ? s.items.map(it => ({
                            productId: it.productId || it.code || '',
                            qty: Number(it.qty!=null ? it.qty : (it.quantity||0)),
                            price: Number(it.price||0)
                        })) : [];
                        batch.set(ref, {
                            invoiceNumber: s.invoiceNumber || null,
                            customerId: s.customerId || null,
                            repName: s.repName || s.repId || '',
                            items,
                            total: Number(s.total||0),
                            paidAmount: Number(s.paidAmount||0),
                            status: s.status || 'due',
                            discountPercent: Number(s.discountPercent||s.discount||0),
                            taxFilingStatus: s.taxFilingStatus || '',
                            date: s.date || new Date().toISOString(),
                            notes: s.notes || '',
                            includeInCash: !!s.includeInCash,
                            collectionReportCreated: !!s.collectionReportCreated,
                            paidToSafe: !!s.paidToSafe,
                            firstPayment: s.firstPayment!=null ? Number(s.firstPayment) : undefined,
                            secondPayment: s.secondPayment!=null ? Number(s.secondPayment) : undefined,
                            collectionDiscount: s.collectionDiscount!=null ? Number(s.collectionDiscount) : undefined,
                            collectionNumber: s.collectionNumber!=null ? s.collectionNumber : undefined,
                            createdAt: s.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.sales++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importPromotions && Array.isArray(backup.promotions)){
                    for (const pr of backup.promotions){
                        const id = pr.id || slugId(pr.name);
                        const ref = db.collection('promotions').doc(id);
                        batch.set(ref, Object.assign({}, pr, { updatedAt: serverTs() }), { merge:true });
                        counts.promotions++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importSettings && backup.settings){
                    const sid = backup.settings.id || 'global-settings';
                    const ref = db.collection('settings').doc(sid);
                    batch.set(ref, Object.assign({}, backup.settings, { updatedAt: serverTs() }), { merge:true });
                    counts.settings++; pending++; await commitIfNeeded(false);
                }

                if (opts.importDispatchNotes && Array.isArray(backup.dispatchNotes)){
                    for (const dn of backup.dispatchNotes){
                        const did = (dn.id || '').toString() || undefined;
                        const ref = did ? db.collection('dispatchNotes').doc(did) : db.collection('dispatchNotes').doc();
                        batch.set(ref, Object.assign({}, dn, { updatedAt: serverTs() }), { merge:true });
                        counts.dispatchNotes++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importStockEntries && backup.stockEntries && typeof backup.stockEntries === 'object'){
                    for (const d of Object.keys(backup.stockEntries)){
                        const ref = db.collection('stockEntries').doc(d);
                        batch.set(ref, { date: d, entries: backup.stockEntries[d], updatedAt: serverTs() }, { merge:true });
                        counts.stockEntries++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importNotifications && Array.isArray(backup.notifications)){
                    for (const n of backup.notifications){
                        const idn = n.id || (Date.now()+Math.random()).toString(36);
                        const ref = db.collection('notifications').doc(idn);
                        batch.set(ref, Object.assign({}, n), { merge:true });
                        counts.notifications++; pending++; await commitIfNeeded(false);
                    }
                }

                await commitIfNeeded(true);
            } catch(e){ console.warn('importBackupObject error', e); return { ok:false, error:e, counts }; }

            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
            try { updateAllPriceListDropdowns(); } catch(e){}
            try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
            return { ok:true, counts };
        }

        function parseBackupText(text){
            try { return JSON.parse(text); } catch(e){
                try { return tryParseJsonLoose(text); } catch(e2){ return null; }
            }
        }

        window.importBackupJson = async function(input, options){
            try {
                const backup = (typeof input === 'string') ? parseBackupText(input) : input;
                if (!backup || typeof backup !== 'object') { alert('???? ????? ?????? ??????????'); return false; }
                const res = await importBackupObject(backup, options);
                if (res && res.ok) { alert('?? ????????? ?????'); return true; }
                alert('??? ?????????'); return false;
            } catch(e){ console.warn('importBackupJson failed', e); alert('??? ??? ????? ?????????'); return false; }
        };

        window.importBackupFromLocalFile = function(){
            try {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json,.txt,.html';
                input.onchange = async function(){
                    const f = this.files && this.files[0]; if (!f) return;
                    const reader = new FileReader();
                    reader.onload = async function(){
                        const txt = reader.result;
                        const ok = await window.importBackupJson(txt);
                        if (ok) console.log('Backup imported successfully');
                    };
                    reader.readAsText(f, 'utf-8');
                };
                input.click();
            } catch(e){ console.warn('importBackupFromLocalFile failed', e); }
        };
        async function importFromSharedAppState(options){
            const opts = Object.assign({ force: true, cleanupDefaults: true }, options||{});
            if (!db) { console.warn('Firestore ??? ????'); return false; }
            const doc = await db.collection('shared').doc('public_app_state').get().catch(()=>null);
            if (!doc || !doc.exists) { console.log('shared/public_app_state ??? ?????'); return false; }
            const data = doc.data() || {}; const as = data.appState || {};
            const custArr = Array.isArray(as.customers) ? as.customers : [];
            const plArr = Array.isArray(as.priceLists) ? as.priceLists : [];
            const repsArr = Array.isArray(as.reps) ? as.reps : [];
            if (custArr.length === 0 && plArr.length === 0 && repsArr.length === 0) { console.log('?? ???? customers/priceLists/reps ???? appState'); return false; }

            // ???? ??????? ?????? ?????? ?? ??? ??? ????? ???????????
            const [currCustSnap, currPlSnap, currRepsSnap] = await Promise.all([
                db.collection('customers').get(), db.collection('priceLists').get(), db.collection('reps').get()
            ]);
            const existingCustIds = new Set(currCustSnap.docs.map(d=>d.id));
            const existingPlIds = new Set(currPlSnap.docs.map(d=>d.id));
            const existingRepIds = new Set(currRepsSnap.docs.map(d=>d.id));

            const batch = db.batch();
            const targetCustIds = new Set();
            const targetPlIds = new Set();
            const targetRepIds = new Set();

            custArr.forEach(c => {
                const id = c.id || c._id || slugId(c.name, undefined);
                if (!id) return;
                targetCustIds.add(id);
                batch.set(db.collection('customers').doc(id), {
                    name: c.name || '',
                    phone: c.phone || '',
                    taxNumber: c.taxNumber || '',
                    requiresTaxFiling: !!c.requiresTaxFiling,
                    priceListId: c.priceListId || '',
                    balance: Number(c.balance||0),
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            plArr.forEach(pl => {
                const id = pl.id || slugId(pl.name, undefined);
                if (!id) return;
                targetPlIds.add(id);
                batch.set(db.collection('priceLists').doc(id), {
                    name: pl.name || '?????',
                    productPrices: pl.productPrices || {},
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            repsArr.forEach(r => {
                const id = r.id || slugId(r.name, undefined);
                if (!id) return;
                targetRepIds.add(id);
                batch.set(db.collection('reps').doc(id), {
                    name: r.name || '',
                    serial: r.serial || r.code || '',
                    target: Number(r.target||0),
                    nextInvoice: Number(r.nextInvoice||r.next_invoice||0),
                    active: r.active !== false,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            // ????? ??????????? ???? ??????? ?????? ??? ?? ??? ??? ???????? ???????
            if (opts.cleanupDefaults) {
                const defaultCustIds = ['CUST001','CUST002','CUST003'];
                defaultCustIds.forEach(id => { if (existingCustIds.has(id) && !targetCustIds.has(id)) batch.delete(db.collection('customers').doc(id)); });
                const defaultPlIds = ['retail','wholesale'];
                defaultPlIds.forEach(id => { if (existingPlIds.has(id) && !targetPlIds.has(id)) batch.delete(db.collection('priceLists').doc(id)); });
                ['REP1','REP2','REP3'].forEach(id => { if (existingRepIds.has(id) && !targetRepIds.has(id)) batch.delete(db.collection('reps').doc(id)); });
            }

            await batch.commit();
            // ???? ?????? ??????? ????? ??????
            state.customers = custArr.map(c => ({...c, _id: c.id || c._id || slugId(c.name)}));
            state.priceLists = plArr.map(pl => ({...pl, id: pl.id || slugId(pl.name)}));
            state.reps = repsArr.map(r => ({...r, id: r.id || slugId(r.name)}));
            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
            try { updateAllPriceListDropdowns(); } catch(e){}
            try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
            console.log('??????? appState -> ????????? ?????');
            return true;
        }
        window.importFromSharedAppState = importFromSharedAppState;

        // ===== ???? ???????? ??????? (????? ???? ?? ??? ??????) =====
        async function migrateLegacyCollections(){
            if (!db) { console.warn('Firestore ??? ????'); return; }
            const role = getUserRole();
            if (role !== 'admin') { alert('??? ??????? ?????? ???'); return; }
            console.log('??? ???? ???????? ??????? ??? ????????? ????????');
            const legacySets = [
                { src: 'Customers', dest: 'customers', map: d => ({
                    name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
                    priceListId: d.priceListId || d.pricelist || d.price_list_id || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'customers_old', dest: 'customers', map: d => ({
                    name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
                    priceListId: d.priceListId || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'PriceLists', dest: 'priceLists', map: d => ({
                    name: d.name||d.title||'?????', productPrices: d.productPrices || d.prices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'price_lists', dest: 'priceLists', map: d => ({
                    name: d.name||'?????', productPrices: d.productPrices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })}
            ];
            let migratedCustomers = 0, migratedPriceLists = 0;
            for (const set of legacySets) {
                try {
                    const snap = await db.collection(set.src).get();
                    if (snap.empty) continue;
                    for (const doc of snap.docs) {
                        const data = doc.data() || {};
                        const destRef = db.collection(set.dest).doc(doc.id);
                        const exists = await destRef.get();
                        if (exists.exists) continue; // ???? ???????
                        await destRef.set(set.map(data), { merge: true });
                        if (set.dest === 'customers') migratedCustomers++; else if (set.dest === 'priceLists') migratedPriceLists++;
                    }
                } catch(e){ console.warn('??? ????? ???????? ???????', set.src, e); }
            }
            console.log(`????? ??????: ????? +=${migratedCustomers}, ????? ????? +=${migratedPriceLists}`);
            alert(`????? ?????? ?????\n????? ??? ???????: ${migratedCustomers}\n????? ????? ??? ???????: ${migratedPriceLists}`);
            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
        }
        window.migrateLegacyCollections = migrateLegacyCollections; // ????? ?? ????????

        // ===== ?????? Presence ????? ?????? =====
        function setPresenceOnline(){
            try {
                if (!db || !auth || !auth.currentUser) return;
                // ?? ???? ?????? ?? ???????? ??????/???? (????? ???)
                try { if (isReadOnly()) return; } catch(_){ }
                const u = auth.currentUser;
                db.collection('presence').doc(u.uid).set({
                    uid: u.uid,
                    email: (u.email||'').toLowerCase(),
                    online: true,
                    lastActive: serverTs()
                }, { merge: true }).catch(e=>console.warn('presence set error', e));
            } catch(e){ console.warn('setPresenceOnline failed', e); }
        }
        function setPresenceOffline(){
            try {
                if (!db || !auth || !auth.currentUser) return;
                try { if (isReadOnly()) return; } catch(_){ }
                const u = auth.currentUser;
                db.collection('presence').doc(u.uid).set({
                    online: false,
                    lastActive: serverTs()
                }, { merge: true }).catch(e=>console.warn('presence unset error', e));
            } catch(e){ console.warn('setPresenceOffline failed', e); }
        }
        window.addEventListener('beforeunload', function(){ try { setPresenceOffline(); } catch(e){} });


        // Firebase save/load helpers for cloud sync are defined later in the file
        // (they are implemented with Firebase Auth + Firestore where available).

        // LocalStorage access helpers � these suppress local reads/writes when CLOUD_ONLY is enabled.
        function lsGet(key) {
            try {
                if (window.CLOUD_ONLY) return null;
                return localStorage.getItem(key);
            } catch (e) { return null; }
        }
        function lsSet(key, value) {
            try {
                if (window.CLOUD_ONLY) {
                    console.debug('CLOUD_ONLY: suppressed localStorage.setItem', key);
                    return;
                }
                localStorage.setItem(key, value);
            } catch (e) { /* ignore */ }
        }
        function lsRemove(key) {
            try {
                if (window.CLOUD_ONLY) {
                    console.debug('CLOUD_ONLY: suppressed localStorage.removeItem', key);
                    return;
                }
                localStorage.removeItem(key);
            } catch (e) { /* ignore */ }
        }

        // Ensure grid states are loaded as early as possible to avoid race conditions
        document.addEventListener('DOMContentLoaded', function () {
            try { window._rawGridState = JSON.parse(localStorage.getItem('raw_materials_grid') || '{}'); } catch (e) { window._rawGridState = {}; }
            try { window._packGridState = JSON.parse(localStorage.getItem('packaging_grid') || '{}'); } catch (e) { window._packGridState = {}; }
            try { window._finishedGridState = JSON.parse(localStorage.getItem('finished_products_grid') || '{}'); } catch (e) { window._finishedGridState = {}; }
            // CRITICAL: Also load stock entries from localStorage
            try { if (!window.state) window.state = {}; window.state.stockEntries = JSON.parse(localStorage.getItem('stock_entries') || '{}'); } catch (e) { if (!window.state) window.state = {}; window.state.stockEntries = {}; }
            console.log('Loaded State:', window._rawGridState);
            console.log('Loaded Packaging State:', window._packGridState);
            console.log('Loaded Finished State:', window._finishedGridState);
            console.log('Loaded Stock Entries:', window.state.stockEntries);
            // create lightweight save helpers if they aren't present yet
                if (!window._gridHelpersInstalled) {
                window._gridHelpersInstalled = true;
                window._rawGridSaveTimer = null;
                window._packGridSaveTimer = null;
                window._finishedGridSaveTimer = null;
                window.isUpdatingFromCloud = false;
                window._lastSavedCostListsJson = '';

                (function(){
                    try {
                        var ind = document.getElementById('cloud-save-indicator');
                        if (!ind) {
                            ind = document.createElement('div');
                            ind.id = 'cloud-save-indicator';
                            ind.style.position = 'fixed';
                            ind.style.bottom = '12px';
                            ind.style.left = '12px';
                            ind.style.background = 'rgba(0,0,0,0.75)';
                            ind.style.color = '#fff';
                            ind.style.padding = '6px 10px';
                            ind.style.borderRadius = '6px';
                            ind.style.zIndex = 99999;
                            ind.style.fontFamily = 'Cairo, sans-serif';
                            ind.style.display = 'none';
                            ind.textContent = '???? ?????...';
                            document.body.appendChild(ind);
                        }
                        window._toggleSaveIndicator = function(on){ try { ind.style.display = on ? 'block' : 'none'; } catch(e){} };
                    } catch(e){ window._toggleSaveIndicator = function(){}; }
                })();

                function sanitizeForSave(obj){
                    try {
                        if (obj == null) return obj;
                        if (Array.isArray(obj)) return obj.map(sanitizeForSave);
                        if (typeof obj === 'object'){
                            var out = {};
                            for (var k in obj){
                                if (!Object.prototype.hasOwnProperty.call(obj,k)) continue;
                                if (k && k.charAt(0) === '_' ) continue; // strip internal keys
                                if (k === 'ui' || k === 'editing') continue;
                                var v = obj[k];
                                if (typeof v === 'string'){
                                    var n = v.trim();
                                    if (/^-?\d+(?:\.\d+)?$/.test(n)) out[k] = Number(n);
                                    else out[k] = n;
                                } else if (typeof v === 'object') out[k] = sanitizeForSave(v);
                                else out[k] = v;
                            }
                            return out;
                        }
                        if (typeof obj === 'string' && /^-?\d+(?:\.\d+)?$/.test(obj.trim())) return Number(obj.trim());
                        return obj;
                    } catch(e){ console.warn('sanitizeForSave failed', e); return obj; }
                }

                async function saveCostListsPayload(payload){
                    try {
                        window._toggleSaveIndicator(true);
                        if (!window.db) {
                            try { localStorage.setItem('costLists_local', JSON.stringify(payload)); } catch(e){ console.warn('local backup failed', e); }
                            return;
                        }
                        var s = JSON.stringify(payload);
                        if (s === window._lastSavedCostListsJson) return;
                        try {
                            await db.collection('settings').doc('costLists').set(payload, { merge: true });
                            window._lastSavedCostListsJson = s;
                        } catch(e){ console.error('saveCostListsPayload write failed', e); }
                    } catch(e){ console.error('saveCostListsPayload failed', e); }
                    finally { try { window._toggleSaveIndicator(false); } catch(_){} }
                }

                window.saveRawGridStateNow = async function(){
                    try {
                        try { localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState || {})); } catch(e){ console.warn('localStorage raw save failed', e); }
                        var payload = { rawMaterials: sanitizeForSave(window._rawGridState || {}), timestamp: new Date().toISOString() };
                        await saveCostListsPayload(payload);
                    } catch(e){ console.error('saveRawGridStateNow failed', e); }
                };

                window.debouncedRawSave = function(){ clearTimeout(window._rawGridSaveTimer); window._rawGridSaveTimer = setTimeout(window.saveRawGridStateNow, 1500); };

                window.savePackGridStateNow = async function(){
                    try {
                        try { localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState || {})); } catch(e){ console.warn('localStorage pack save failed', e); }
                        var payload = { packaging: sanitizeForSave(window._packGridState || {}), timestamp: new Date().toISOString() };
                        await saveCostListsPayload(payload);
                    } catch(e){ console.error('savePackGridStateNow failed', e); }
                };

                window.debouncedPackSave = function(){ clearTimeout(window._packGridSaveTimer); window._packGridSaveTimer = setTimeout(window.savePackGridStateNow, 1500); };

                window.saveFinishedGridStateNow = async function(){
                    try {
                        try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(e){ console.warn('localStorage finished save failed', e); }
                        try { localStorage.setItem('stock_entries', JSON.stringify(window.state?.stockEntries || {})); } catch(e){ console.warn('localStorage stock_entries save failed', e); }
                        var payload = { 
                            finished: window.costFinished || [], // CRITICAL: Save finished products array with stock data
                            finishedProducts: sanitizeForSave(window._finishedGridState || {}),
                            stockEntries: sanitizeForSave(window.state?.stockEntries || {}),
                            timestamp: new Date().toISOString() 
                        };
                        await saveCostListsPayload(payload);
                    } catch(e){ console.error('saveFinishedGridStateNow failed', e); }
                };

                window.debouncedFinishedSave = function(){ clearTimeout(window._finishedGridSaveTimer); window._finishedGridSaveTimer = setTimeout(window.saveFinishedGridStateNow, 1500); };
            }
            
            // Force Sync to Cloud function
            window.forceFullCloudSync = async function(){
                try {
                    if (!window.firebase || !window.firebase.firestore) { alert('? Firebase ??? ????'); return; }
                    if (!window.db) { alert('? Database ??? ????'); return; }
                    if (!confirm('?? ???? ??? ?? ???????? ??????? ??????? ?????')) return;
                    
                    const payload = {
                        costRaw: window.costLists?.costRaw || [],
                        costPack: window.costLists?.costPack || [],
                        // FIXED: Remove costFinished array (using finishedProducts object)
                        rawGridState: window._rawGridState || {},
                        packGridState: window._packGridState || {},
                        finishedProducts: window._finishedGridState || {}, // FIXED: Use finishedProducts
                        stockEntries: window.state?.stockEntries || {}, // FIXED: Add stock_entries
                        timestamp: new Date().toISOString()
                    };
                    await db.collection('settings').doc('costLists').set(payload, { merge: true });
                    alert('? ?? ??? ???????? ??????? ?????! ????? ???? ????? ?? ?? ???? ???.');
                } catch (e) {
                    console.error('forceFullCloudSync error:', e);
                    alert('? ??? ?????: ' + (e && e.message ? e.message : e));
                }
            };
            
            // Dynamic force-sync button removed for local-only workflow
        });

        // ===== Install costLists cloud listener (real-time sync) =====
        window.__costDocUnsub = window.__costDocUnsub || null;
        window.installCostListsListener = function(){
            try {
                if (!window.db || window.__costDocUnsub) return;
                var ref = db.collection('settings').doc('costLists');
                window.__costDocUnsub = ref.onSnapshot(function(snap){
                    try {
                        if (!snap || !snap.exists) return;
                        window.isUpdatingFromCloud = true;
                        var data = snap.data() || {};
                        try { if (data.rawMaterials) { window._rawGridState = data.rawMaterials; localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState||{})); } } catch(e){ console.warn('apply raw failed', e); }
                        try { if (data.packaging) { window._packGridState = data.packaging; localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState||{})); } } catch(e){ console.warn('apply pack failed', e); }
                        try { if (data.finishedProducts) { window._finishedGridState = data.finishedProducts; localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState||{})); } } catch(e){ console.warn('apply finished failed', e); }
                        // FIXED: Restore stock_entries from cloud (avoid wiping local when cloud empty)
                        try {
                            if (data.stockEntries && typeof data.stockEntries === 'object' && Object.keys(data.stockEntries||{}).length > 0 && window.state) {
                                window.state.stockEntries = data.stockEntries;
                                try { localStorage.setItem('stock_entries', JSON.stringify(data.stockEntries||{})); } catch(_){ }
                            } else {
                                console.log('?? costLists RT: skipped stockEntries overlay (cloud empty)');
                            }
                        } catch(e){ console.warn('apply stockEntries failed', e); }
                        try { if (data.costRaw) { window.costLists = window.costLists || {}; window.costLists.costRaw = data.costRaw; } } catch(e){ console.warn('apply costRaw failed', e); }
                        try { if (data.costPack) { window.costLists = window.costLists || {}; window.costLists.costPack = data.costPack; } } catch(e){ console.warn('apply costPack failed', e); }
                        try { if (data.costFinished) { window.costLists = window.costLists || {}; window.costLists.costFinished = data.costFinished; } } catch(e){ console.warn('apply costFinished failed', e); }
                        try {
                            window._lastSavedCostListsJson = JSON.stringify({ rawMaterials: window._rawGridState, packaging: window._packGridState, finishedProducts: window._finishedGridState, costRaw: (window.costLists&&window.costLists.costRaw)||[], costPack: (window.costLists&&window.costLists.costPack)||[], costFinished: (window.costLists&&window.costLists.costFinished)||[] });
                        } catch(e){}
                    } catch(e){ console.warn('costLists snapshot handler failed', e); }
                    finally { setTimeout(function(){ window.isUpdatingFromCloud = false; }, 50); }
                });
            } catch(e){ console.warn('installCostListsListener failed', e); }
        };

        document.addEventListener('DOMContentLoaded', function(){ setTimeout(function(){ try { if (typeof window.installCostListsListener === 'function') window.installCostListsListener(); } catch(e){} }, 1200); });

        // ===== Helpers: Sales cache (used when reads are blocked) =====
        function getCachedSales(){
            try { const raw = localStorage.getItem('cache_sales'); return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
        }
        function setCachedSales(arr){
            try { localStorage.setItem('cache_sales', JSON.stringify(Array.isArray(arr)? arr : [])); } catch(e){}
        }
        function upsertCachedSale(sale){
            try {
                if (!sale || !sale.id) return;
                const list = getCachedSales();
                const idx = list.findIndex(s => s && (s.id === sale.id || s._id === sale.id));
                if (idx >= 0) list[idx] = sale; else list.unshift(sale);
                if (list.length > 500) list.length = 500;
                setCachedSales(list);
            } catch(e){}
        }
        function removeCachedSale(id){
            try {
                const list = getCachedSales().filter(s => s && s.id !== id && s._id !== id);
                setCachedSales(list);
            } catch(e){}
        }

        // ===== Permission-denied resilience =====
        window.__permissionErrorCounts = window.__permissionErrorCounts || {};
        function handlePermissionDenied(coll){
            try {
                const c = window.__permissionErrorCounts;
                c[coll] = (c[coll] || 0) + 1;
                const core = ['sales','customers','products','priceLists'];
                const coreFailures = core.filter(x => c[x] && c[x] > 0).length;
                // If all core collections failed at least once, render cached data immediately
                if (coreFailures === core.length) {
                    ensureCachedDataRendered();
                    showPermissionBanner();
                } else if (c[coll] >= 2) {
                    // After 2 failures of same coll, still show banner
                    showPermissionBanner();
                }
            } catch(e){ /* ignore */ }
        }
        function preloadCachedCollections(){
            try {
                if (!window.state) window.state = {};
                // Load cached customers/products/priceLists if empty
                if (!state.customers || !state.customers.length){
                    const raw = localStorage.getItem('cache_customers');
                    if (raw){ try { state.customers = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.products || !state.products.length){
                    const raw = localStorage.getItem('cache_products');
                    if (raw){ try { state.products = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.priceLists || !state.priceLists.length){
                    const raw = localStorage.getItem('cache_priceLists');
                    if (raw){ try { state.priceLists = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.sales || !state.sales.length){
                    const s = getCachedSales();
                    if (s && s.length) state.sales = s;
                }
                // Render quickly if we hydrated anything
                try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                try {
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                } catch(e){}
            } catch(e){ /* ignore */ }
        }
        function ensureCachedDataRendered(){
            preloadCachedCollections();
        }
        function showPermissionBanner(){
            try {
                let bn = document.getElementById('permission-banner');
                if (!bn){
                    bn = document.createElement('div');
                    bn.id = 'permission-banner';
                    bn.style.cssText = 'position:fixed;top:72px;left:0;right:0;z-index:120;background:#fee;border:1px solid #f99;padding:6px 10px;font-size:14px;text-align:center;font-weight:600;color:#b00000';
                    bn.innerHTML = '?? ????? ??????? Firestore: ??? ??? ???????? ?? ?????? ??????? ???. ??? ??????? ?? ??? ???????.';
                    document.body.appendChild(bn);
                }
            } catch(e){ /* ignore */ }
        }

        // ????? ???? ????? ?????? ????? ??????? ?? ???????
        function updateAllPriceListDropdowns(){
            try {
                const els = [
                    document.getElementById('customer-price-list')
                ].filter(Boolean);
                els.forEach(el => { if (typeof populatePriceListDropdown === 'function') populatePriceListDropdown(el, el.value || ''); });
            } catch(e){ /* ignore */ }
        }

        // ????? ???? ????? ?????? ??????? ?? ???????
        function updateAllCustomerDropdowns(){
            try {
                const els = [
                    document.getElementById('sale-customer'),
                    document.getElementById('spreadsheet-customer') || document.getElementById('spreadsheet-customer-select') || document.getElementById('spreadsheetCustomerSelect')
                ].filter(Boolean);
                els.forEach(el => {
                    const current = el.value || '';
                    if (typeof populateCustomerDropdown === 'function') populateCustomerDropdown(el, current);
                });
            } catch(e){ /* ignore */ }
        }

        // ===== ????? ??? ?????? ?????? =====
        function __formatPeriod(dateObj){
            const y = dateObj.getFullYear();
            const m = (dateObj.getMonth()+1).toString().padStart(2,'0');
            return `${y}-${m}`;
        }
        function defaultPrevMonthPeriod(){
            const d = new Date(); d.setDate(1); d.setMonth(d.getMonth()-1);
            return __formatPeriod(d);
        }
        function periodToRange(period){
            // period: 'YYYY-MM'
            try {
                const [y,m] = period.split('-').map(Number);
                const start = new Date(y, m-1, 1, 0,0,0,0);
                const end = new Date(y, m, 0, 23,59,59,999); // last day of month
                return { startISO: start.toISOString(), endISO: end.toISOString() };
            } catch(e){
                const d = new Date();
                return { startISO: new Date(d.getFullYear(), d.getMonth(), 1).toISOString(), endISO: new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999).toISOString() };
            }
        }
        function nextPeriod(period){
            try {
                const [y,m] = period.split('-').map(Number);
                const d = new Date(y, m-1, 1); d.setMonth(d.getMonth()+1);
                return __formatPeriod(d);
            } catch(e){ return defaultPrevMonthPeriod(); }
        }

        async function computeClosingBalances(period){
            if (!db) throw new Error('Firestore ??? ????');
            const { endISO } = periodToRange(period);
            const snap = await db.collection('sales').where('date','<=', endISO).get();
            const byCustomer = new Map();
            snap.forEach(doc => {
                const s = doc.data() || {};
                const cid = s.customerId || 'UNKNOWN';
                if (s.status === 'return') return;
                const total = Number(s.total||0);
                const paid = Number(s.paidAmount||0);
                const out = Math.max(total - paid, 0);
                if (!byCustomer.has(cid)) byCustomer.set(cid, 0);
                byCustomer.set(cid, byCustomer.get(cid) + out);
            });
            const result = [];
            let totalOutstanding = 0;
            byCustomer.forEach((amt, cid) => {
                const rounded = Math.round(amt*100)/100;
                totalOutstanding += rounded;
                const cu = (state.customers||[]).find(c => (c.id||c._id) === cid) || {};
                result.push({ customerId: cid, customerName: cu.name || cid, closing: rounded });
            });
            result.sort((a,b)=> (b.closing - a.closing));
            return { period, endISO, customers: result, totalOutstanding: Math.round(totalOutstanding*100)/100 };
        }

        async function lockMonthSales(period){
            const { startISO, endISO } = periodToRange(period);
            // ??? ?????? ??? ????? ??? (??? ?? ?? ??? ????? ?????)
            const snap = await db.collection('sales').where('date','>=', startISO).where('date','<=', endISO).get();
            let batch = db.batch(); let pending = 0; const BATCH_LIMIT = 450;
            for (const doc of snap.docs){
                batch.set(doc.ref, { locked: true, lockPeriod: period, lockedAt: serverTs(), lockedBy: (auth&&auth.currentUser)?auth.currentUser.uid:null }, { merge:true });
                pending++; if (pending >= BATCH_LIMIT){ await batch.commit(); batch = db.batch(); pending = 0; }
            }
            if (pending>0) await batch.commit();
        }

        async function performMonthClose(period){
            const role = getUserRole();
            if (role !== 'admin') { alert('????? ????? ???? ?????? ???'); return { ok:false, reason:'not-admin' }; }
            const summary = await computeClosingBalances(period);
            const next = nextPeriod(period);
            // ??? ??????? ?????? ???? ??????
            const existing = await db.collection('monthlyClosings').doc(period).get().catch(()=>null);
            if (existing && existing.exists) { alert('?? ????? ??? ????? ??????'); return { ok:false, reason:'already-closed' }; }

            // ????? ????? ??????? + ?????? ??????? ?????? ????
            await db.collection('monthlyClosings').doc(period).set({
                period,
                closedAt: serverTs(),
                closedBy: (auth&&auth.currentUser)? auth.currentUser.uid : null,
                totalCustomers: summary.customers.length,
                totalOutstanding: summary.totalOutstanding
            }, { merge:true });
            // ????? ?????? ???????
            {
                let batch = db.batch(); let pending = 0; const LIM = 450;
                for (const row of summary.customers){
                    const ref = db.collection('monthlyClosings').doc(period).collection('customers').doc(row.customerId || slugId(row.customerName));
                    batch.set(ref, { customerId: row.customerId, customerName: row.customerName, closing: row.closing }, { merge:true });
                    pending++; if (pending>=LIM){ await batch.commit(); batch = db.batch(); pending = 0; }
                }
                if (pending>0) await batch.commit();
            }
            // ????? ????? ???????? ????? ??????
            {
                let batch = db.batch(); let pending = 0; const LIM = 450;
                for (const row of summary.customers){
                    const amount = Math.round(Number(row.closing||0)*100)/100;
                    if (!amount) continue;
                    const oid = `${row.customerId||slugId(row.customerName)}_${next}`;
                    const ref = db.collection('openingBalances').doc(oid);
                    batch.set(ref, {
                        customerId: row.customerId,
                        customerName: row.customerName,
                        period: next,
                        sourcePeriod: period,
                        amount,
                        createdAt: serverTs(),
                        createdBy: (auth&&auth.currentUser)?auth.currentUser.uid:null
                    }, { merge:true });
                    pending++; if (pending>=LIM){ await batch.commit(); batch = db.batch(); pending = 0; }
                }
                if (pending>0) await batch.commit();
            }

            // ??? ?????? ?????
            await lockMonthSales(period);
            if (!arguments[1] || !arguments[1].silent) {
                alert('?? ????? ????? ?????? ??????? ?????????? ????? ??????');
            }
            return { ok:true, summary };
        }

        // ????? ????? ?????? ???????? ??? ?????? (Admin ???)
        async function maybeAutoClosePreviousMonth(){
            try {
                // Ensure the server recognises this user as admin (check roles/users on Firestore)
                try {
                    if (!auth || !auth.currentUser) return;
                    const uid = auth.currentUser.uid;
                    let serverRole = null;
                    try {
                        const rdoc = await db.collection('roles').doc(uid).get();
                        if (rdoc.exists && rdoc.data() && rdoc.data().role) serverRole = rdoc.data().role;
                    } catch(_){ /* ignore */ }
                    if (!serverRole) {
                        try {
                            const udoc = await db.collection('users').doc(uid).get();
                            if (udoc.exists && udoc.data() && udoc.data().role) serverRole = udoc.data().role;
                        } catch(_){ /* ignore */ }
                    }
                    if (serverRole !== 'admin') {
                        // Not an admin according to server-side data � skip auto-close to avoid permission errors
                        console.warn('maybeAutoClosePreviousMonth: skipping auto-close because server role != admin', { serverRole });
                        return;
                    }
                } catch(e){ console.warn('maybeAutoClosePreviousMonth: role check failed, skipping', e); return; }
                const now = new Date();
                const currentPeriod = __formatPeriod(now);
                const prevPeriod = defaultPrevMonthPeriod();
                // ?? ????? ??? ??? ?? ????? ????? ??? ?????? ?? ?????? ??? (???????) � ????? ???????? ?????? ??? ?? ???? ????? ?????
                const docRef = db.collection('monthlyClosings').doc(prevPeriod);
                const doc = await docRef.get();
                if (!doc.exists) {
                    await performMonthClose(prevPeriod, { silent: true });
                }
            } catch(e){ console.warn('maybeAutoClosePreviousMonth failed', e); }
        }

        // ?????? ?????? ?? ???????: ?????? ?????? ????? ????? ??????? (????????)
        function setActivePeriod(period){
            try {
                window.state = window.state || {};
                state.activePeriod = period;
                try { localStorage.setItem('active_period', String(period)); } catch(e){}
                
                // ???? ???? ????? ???????? ????? ????? ?? ????? ???????
                const salesDateInput = document.getElementById('search-sales-date');
                if (salesDateInput) {
                    salesDateInput.value = `${period}-01`;
                    try { salesDateInput.dispatchEvent(new Event('change')); } catch(e){}
                }
                
                // ??? ??? ????? ???????? ?? ??????? ??????
                try {
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    
                    // ????? ????? ???????? ????? ??? ?????? ?????? ???????
                    if (typeof renderAllSales === 'function') {
                        renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    }
                    if (typeof renderDashboard === 'function') renderDashboard();
                    if (typeof renderDebts === 'function') renderDebts();
                    if (typeof renderRepDebts === 'function') renderRepDebts();
                    
                    // ????? ???????
                    console.log(`Active period changed to: ${period}`);
                } catch(e){ 
                    console.warn('Error while rendering after period change', e);
                }
            } catch(e){ console.warn('setActivePeriod error', e); }
        }
        function ensureDefaultActivePeriod(){
            try {
                const saved = localStorage.getItem('active_period');
                const now = new Date();
                const current = __formatPeriod(now);
                
                // ?????? ?? state.activePeriod ?????
                const stateActive = (window.state && state.activePeriod) ? String(state.activePeriod) : '';
                
                // ??? ???? ?? ?? ????? ?????? ?? ??????? ? ???? ????
                if (!saved || saved !== current || stateActive !== current) { 
                    console.log(`ensureDefaultActivePeriod: Updating from saved=${saved}, stateActive=${stateActive} to ${current}`);
                    setActivePeriod(current); 
                }
            } catch(e){ console.warn('ensureDefaultActivePeriod error', e); }
        }

        // ???? ?????? ???? ??????? ??????? ?????? ????? ?????? ??????
        window.resetActivePeriod = function() {
            try {
                const current = __formatPeriod(new Date());
                localStorage.setItem('active_period', current);
                if (window.state) window.state.activePeriod = current;
                console.log(`Reset active period to: ${current}`);
                if (typeof ensureDefaultActivePeriod === 'function') ensureDefaultActivePeriod();
                return current;
            } catch(e) {
                console.error('resetActivePeriod error', e);
                return null;
            }
        };

        // === PERIODIC ACTIVE PERIOD CHECK (Every hour) ===
        // ????? ???? ?????? ?????? ?? ???? ?????? ?? ??????? ??? ?????? ????? ??????
        (function(){
            const CHECK_INTERVAL = 3600000; // 1 hour in ms
            setInterval(()=>{
                try {
                    ensureDefaultActivePeriod();
                } catch(e){ console.warn('Periodic active period check failed', e); }
            }, CHECK_INTERVAL);
            // ????? ???? ??? ????? ??? ??? ???????
            try {
                ensureDefaultActivePeriod();
                console.log('Initial activePeriod check executed');
            } catch(e){ console.warn('Initial active period check failed', e); }
        })();

        // === PERIODIC SALE PRICES REFRESH (Every 30 seconds) ===
        // ????? ????? ???????? ?????? ?????? ?? ?? ??????? ??????? ??????? ??? ?????? ???? ?????
        (function(){
            const REFRESH_INTERVAL = 30000; // 30 seconds in ms
            setInterval(()=>{
                try {
                    if (typeof updateAllSalePrices === 'function') {
                        updateAllSalePrices();
                    }
                } catch(e){ console.warn('Periodic sale prices refresh failed', e); }
            }, REFRESH_INTERVAL);
        })();

        // (manual month close UI removed � handled automatically and via settings calendar)

        // ==========================================
        // ??? BLUETOOTH PRINT - CANDIDATE LIST STRATEGY ???
        // ==========================================

        // Define Known Printer Configurations (from previous success)
        const PRINTER_CANDIDATES = [
            { 
                name: "Standard BLE", 
                service: "000018f0-0000-1000-8000-00805f9b34fb", 
                char: "00002af1-0000-1000-8000-00805f9b34fb" 
            },
            { 
                name: "ISSC / Chinese Generic", 
                service: "49535343-fe7d-4ae5-8fa9-9fafd205e455", 
                char: "49535343-8841-43f4-a8d4-ecbe34729bb3" 
            },
            { 
                name: "Generic Variant 1 (AF30)", 
                service: "0000af30-0000-1000-8000-00805f9b34fb", 
                char: "0000af31-0000-1000-8000-00805f9b34fb" 
            },
            { 
                name: "Generic Variant 2 (FF00)", 
                service: "0000ff00-0000-1000-8000-00805f9b34fb", 
                char: "0000ff02-0000-1000-8000-00805f9b34fb" 
            }
        ];

        let btCharacteristic = null;
        let btDevice = null;

        async function connectToBluetoothPrinter() {
            try {
                console.log("Starting Candidate Search...");
                
                // 1. Request Device with ALL candidate services in 'optionalServices'
                // This is CRITICAL for permissions.
                const allServices = PRINTER_CANDIDATES.map(c => c.service);
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, // Try to find everything
                    optionalServices: allServices 
                });

                const server = await device.gatt.connect();
                console.log("Connected to GATT. Scanning candidates...");

                // 2. Iterate through candidates to find the first match
                for (const candidate of PRINTER_CANDIDATES) {
                    try {
                        const service = await server.getPrimaryService(candidate.service);
                        const characteristic = await service.getCharacteristic(candidate.char);
                        
                        // If we are here, we found a match!
                        btCharacteristic = characteristic;
                        btDevice = device;
                        console.log(`? MATCH FOUND: ${candidate.name}`);
                        alert(`?? ??????? ?????! (${candidate.name})`);
                        
                        // Add disconnect listener
                        device.addEventListener('gattserverdisconnected', () => {
                            alert("?? ?? ??? ??????? ????????");
                            btCharacteristic = null;
                        });
                        
                        return true;
                    } catch (error) {
                        console.log(`? Failed candidate: ${candidate.name}`);
                    }
                }
                
                throw new Error("?? ??? ?????? ??? ?? ???? ????? ?????? (No matching UUID found).");

            } catch (error) {
                alert("??? ?? ???????: " + error.message);
                return false;
            }
        }

        async function printInvoiceBluetooth(invoice) {
            // Show processing message first
            const processingMsg = document.createElement('div');
            processingMsg.style.position = 'fixed';
            processingMsg.style.top = '50%';
            processingMsg.style.left = '50%';
            processingMsg.style.transform = 'translate(-50%, -50%)';
            processingMsg.style.background = '#fff';
            processingMsg.style.padding = '30px';
            processingMsg.style.borderRadius = '10px';
            processingMsg.style.zIndex = '50001';
            processingMsg.style.boxShadow = '0 4px 6px rgba(0,0,0,0.2)';
            processingMsg.style.textAlign = 'center';
            processingMsg.innerHTML = `
                <div style="font-size:18px;font-weight:bold;margin-bottom:15px;">???? ??????? ?????????...</div>
                <div style="font-size:14px;color:#666;margin-bottom:15px;">???? ?????? ?? ????? ???????? ?????????</div>
                <div style="animation:spin 1s linear infinite;font-size:24px;" id="spinner">?</div>
            `;
            
            const backdrop = document.createElement('div');
            backdrop.style.position = 'fixed';
            backdrop.style.inset = '0';
            backdrop.style.background = 'rgba(0,0,0,0.3)';
            backdrop.style.zIndex = '50000';
            
            document.body.appendChild(backdrop);
            document.body.appendChild(processingMsg);
            
            // Add spinner animation
            const style = document.createElement('style');
            style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
            document.head.appendChild(style);
            
            try {
                // 1. Connection Check
                if (!btCharacteristic) {
                    const success = await connectToBluetoothPrinter();
                    if (!success) {
                        backdrop.remove();
                        processingMsg.remove();
                        alert('??? ??????? ????? ????????');
                        return;
                    }
                }

                // Update message to indicate printing
                processingMsg.innerHTML = `
                    <div style="font-size:18px;font-weight:bold;margin-bottom:15px;">???? ????? ???????? ???????...</div>
                    <div style="font-size:14px;color:#666;">???? ????????</div>
                `;

                try {
                    const encoder = new TextEncoder();
                    
                    // ESC/POS commands for Xprinter 80mm
                    const ESC = 0x1B;
                    const GS = 0x1D;
                    
                    const customer = findCustomer(invoice.customerId);
                    const customerName = customer ? customer.name : (invoice.customerName || '????');
                    const taxNumber = customer ? (customer.taxNumber || '') : '';
                    
                    let commands = [];
                    
                    // Initialize printer
                    commands.push(ESC, 0x40);
                    
                    // Company header - Center aligned, large text
                    commands.push(ESC, 0x61, 0x01); // Center align
                    commands.push(ESC, 0x21, 0x30); // Double height + width
                    commands.push(...encoder.encode("?????? ??????\n"));
                    commands.push(ESC, 0x21, 0x00); // Normal size
                    
                    // Separator
                    commands.push(...encoder.encode("================================\n"));
                    
                    // Left align for details
                    commands.push(ESC, 0x61, 0x00);
                    
                    // Invoice details
                    const now = new Date();
                    const dateStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
                    const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
                    
                    commands.push(...encoder.encode(`???????: ${dateStr} ${timeStr}\n`));
                    commands.push(...encoder.encode(`??? ????????: ${invoice.invoiceNumber || invoice.id}\n`));
                    commands.push(...encoder.encode(`??????: ${customerName}\n`));
                    if (taxNumber) {
                        commands.push(...encoder.encode(`????? ???????: ${taxNumber}\n`));
                    }
                    commands.push(...encoder.encode(`???????: ${invoice.repName || '??? ????'}\n`));
                    
                    commands.push(...encoder.encode("--------------------------------\n"));
                    
                    // Table header - Bold
                    commands.push(ESC, 0x45, 0x01); // Bold ON
                    const header = String("?????").padEnd(16) + 
                                  String("??????").padStart(6) + 
                                  String("?????").padStart(8) + 
                                  String("????????").padStart(10);
                    commands.push(...encoder.encode(header + "\n"));
                    commands.push(ESC, 0x45, 0x00); // Bold OFF
                    
                    commands.push(...encoder.encode("--------------------------------\n"));
                    
                    // Items
                    let subtotal = 0;
                    if (invoice.items && Array.isArray(invoice.items)) {
                        invoice.items.forEach(item => {
                            const product = findProduct(item.productId);
                            const itemName = (product?.name || item.name || item.productName || '????').substring(0, 15);
                            const qty = item.quantity || 0;
                            const price = item.price || 0;
                            const itemTotal = qty * price;
                            subtotal += itemTotal;
                            
                            // Item name on first line
                            commands.push(...encoder.encode(itemName + "\n"));
                            
                            // Qty, price, total on second line aligned
                            const itemLine = String(qty).padStart(6) + 
                                           String(price.toFixed(2)).padStart(14) + 
                                           String(itemTotal.toFixed(2)).padStart(10);
                            commands.push(...encoder.encode(itemLine + "\n"));
                        });
                    }
                    
                    commands.push(...encoder.encode("================================\n"));
                    
                    // Totals - Bold and larger
                    commands.push(ESC, 0x45, 0x01); // Bold ON
                    commands.push(ESC, 0x21, 0x10); // Double height
                    
                    const totalLine = String("????????:").padEnd(20) + String((invoice.total || 0).toFixed(2)).padStart(12) + " ?.?";
                    commands.push(...encoder.encode(totalLine + "\n"));
                    
                    commands.push(ESC, 0x21, 0x00); // Normal size
                    commands.push(ESC, 0x45, 0x00); // Bold OFF
                    
                    commands.push(...encoder.encode("================================\n"));
                    
                    // Footer - Center
                    commands.push(ESC, 0x61, 0x01);
                    commands.push(...encoder.encode("???? ???????? ????\n"));
                    commands.push(ESC, 0x61, 0x00);
                    
                    // Feed lines
                    commands.push(0x0A, 0x0A, 0x0A, 0x0A);
                    
                    // Cut paper
                    commands.push(GS, 0x56, 0x00);
                    
                    const data = new Uint8Array(commands);
                    
                    // Send in small chunks
                    const CHUNK_SIZE = 20;
                    for (let i = 0; i < data.length; i += CHUNK_SIZE) {
                        const chunk = data.slice(i, i + CHUNK_SIZE);
                        await btCharacteristic.writeValue(chunk);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Wait for printer to finish
                    await new Promise(r => setTimeout(r, 2000));

                    processingMsg.innerHTML = `
                        <div style="font-size:18px;font-weight:bold;margin-bottom:15px;color:#059669;">? ?? ????? ???????? ?????</div>
                        <div style="font-size:14px;color:#666;">???? ?? ???????? ????? ??????</div>
                        <div style="font-size:12px;color:#999;margin-top:10px;">??????? ????? ????? ???????</div>
                    `;
                    setTimeout(() => {
                        backdrop.remove();
                        processingMsg.remove();
                    }, 4000);

                } catch (error) {
                    throw new Error('??? ?? ???????: ' + error.message);
                }
            } catch (error) {
                console.error('Bluetooth print error:', error);
                // Don't reset connection on error - may just be temporary
                
                processingMsg.innerHTML = `
                    <div style="font-size:18px;font-weight:bold;margin-bottom:15px;color:#dc2626;">? ??? ?? ???????</div>
                    <div style="font-size:14px;color:#666;margin-bottom:15px;">${error.message}</div>
                    <button id="close-error-msg" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">?????</button>
                `;
                document.getElementById('close-error-msg').onclick = () => {
                    backdrop.remove();
                    processingMsg.remove();
                };
            }
        }

        // Make globally available
        window.printInvoiceBluetooth = printInvoiceBluetooth;

        // ==========================================
        // ?? RAWBT INTENT PRINT (Android Direct API)
        // ==========================================
        function printViaRawBT(invoice) {
            // 1. Construct a Clean, Simple Receipt Text (ESC/POS style layout)
            // We use plain text with special formatting characters for RawBT to interpret.
            let text = "";
            
            // Header
            text += "[C]<b><font size='big'>?????? ??????</font></b>\n";
            text += "[C]================================\n";
            text += `[L]<b>??? ????????:</b>[R]${invoice.id || 'N/A'}\n`;
            text += `[L]<b>???????:</b>[R]${invoice.date ? new Date(invoice.date).toLocaleDateString('ar-EG') : '?????'}\n`;
            text += "[C]--------------------------------\n";
            
            // Items
            if (invoice.items && Array.isArray(invoice.items)) {
                invoice.items.forEach(item => {
                    const itemName = item.name || item.productId || '????';
                    const qty = item.quantity || item.qty || 0;
                    const price = item.price || 0;
                    const total = item.total || (qty * price);
                    text += `[L]<b>${itemName}</b>\n`;
                    text += `[L]${qty} x ${formatCurrency(price)}[R]${formatCurrency(total)}\n`;
                });
            }
            
            text += "[C]--------------------------------\n";
            text += `[R]<b><font size='big'>????????: ${formatCurrency(invoice.total || 0)}</font></b>\n`;
            text += "[C]================================\n";
            text += "[C]???? ???????? ????\n";
            text += "\n\n"; // Feed

            // 2. Encode and Trigger RawBT Intent
            // This opens the RawBT app directly with the data
            const encodedData = encodeURIComponent(text);
            window.location.href = "rawbt:" + encodedData;
        }
        window.printViaRawBT = printViaRawBT;
    </script>
    <script>
        // --- FIX: Define Missing USB Print Function ---
        // Called from sales page with printViaUSB(sale)
        window.printViaUSB = async function(sale) {
            try {
                if (!sale) {
                    return alert("? ?? ???? ?????? ???????");
                }

                // 1. Build Invoice HTML for printing
                const invoiceHTML = `
                    <div style="width: 80mm; font-family: Arial, sans-serif; direction: rtl; padding: 4mm; color: black; background: white;">
                        <div style="text-align: center; border: 1px solid black; padding: 4mm;">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">Delente ERP</div>
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">?????? ??????</div>
                            <div style="border-top: 1px dashed black; border-bottom: 1px dashed black; padding: 4px 0; margin: 4px 0; font-size: 11px;">
                                <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                    <span>???:</span><span>${sale.invoiceNumber || sale.id || ''}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                    <span>???????:</span><span>${sale.date ? new Date(sale.date).toLocaleDateString('ar-EG') : ''}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                    <span>??????:</span><span>${sale.customerName || '????'}</span>
                                </div>
                            </div>
                            ${sale.items && Array.isArray(sale.items) ? `
                                <table style="width: 100%; font-size: 10px; border-collapse: collapse; margin: 4px 0;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid black;">
                                            <th style="text-align: right; padding: 2px;">?????</th>
                                            <th style="text-align: center; padding: 2px;">??????</th>
                                            <th style="text-align: center; padding: 2px;">?????</th>
                                            <th style="text-align: left; padding: 2px;">????????</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sale.items.map(item => {
                                            const qty = item.quantity || item.qty || 0;
                                            const price = item.price || 0;
                                            const total = qty * price;
                                            return `<tr style="border-bottom: 1px dotted #ccc;">
                                                <td style="text-align: right; padding: 2px;">${item.productName || item.name || ''}</td>
                                                <td style="text-align: center; padding: 2px;">${qty}</td>
                                                <td style="text-align: center; padding: 2px;">${price.toFixed(2)}</td>
                                                <td style="text-align: left; padding: 2px;">${total.toFixed(2)}</td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : ''}
                            <div style="border-top: 1px solid black; border-bottom: 1px solid black; padding: 4px 0; margin: 4px 0; font-size: 12px; font-weight: bold;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>????????:</span><span>${(sale.total || 0).toFixed(2)} ?.?</span>
                                </div>
                            </div>
                            <div style="font-size: 10px; margin: 4px 0;">
                                <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                                    <span>???????:</span><span>${((((sale.paidAmount !== undefined && sale.paidAmount !== null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0)).toFixed(2)} ?.?</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>???????:</span><span>${(((sale.total || 0) - (((sale.paidAmount !== undefined && sale.paidAmount !== null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0))).toFixed(2)} ?.?</span>
                                </div>
                            </div>
                            <div style="border-top: 1px dashed black; padding: 4px 0; margin: 4px 0; font-size: 10px; text-align: center;">
                                ????? ???????? ????
                            </div>
                        </div>
                    </div>
                `;

                // 2. Create a hidden container and inject HTML
                const printContainer = document.createElement('div');
                printContainer.id = 'usb-print-container';
                printContainer.innerHTML = invoiceHTML;
                printContainer.style.display = 'none';
                document.body.appendChild(printContainer);

                // 3. Add print styles
                const styleId = 'usb-thermal-print-style';
                let style = document.getElementById(styleId);
                if (!style) {
                    style = document.createElement('style');
                    style.id = styleId;
                    style.innerHTML = `
                        @media print {
                            body * { visibility: hidden; }
                            #usb-print-container, #usb-print-container * { visibility: visible; }
                            #usb-print-container { 
                                position: absolute; 
                                left: 0; 
                                top: 0; 
                                width: 100%;
                            }
                            @page { size: 80mm auto; margin: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                // 4. Trigger print and cleanup
                setTimeout(() => {
                    window.print();
                    // Cleanup after print dialog closes
                    setTimeout(() => {
                        if (printContainer && printContainer.parentNode) {
                            printContainer.parentNode.removeChild(printContainer);
                        }
                    }, 500);
                }, 100);

            } catch(e) {
                console.error('USB Print Error:', e);
                alert('? ??? ?? ???????: ' + (e && e.message ? e.message : e));
            }
        };
    </script>

    <style>
        
        /* watermark removed - body::before deleted per user request */

        #app-container {
            background-color: #ffffff !important; /* reset to white after watermark removal */
            padding-bottom: 120px; /* Ensure content doesn't hide behind bottom nav */
            padding-top: 72px; /* Offset for fixed header height so content is visible */
        }
        /* Extra safety: ensure pages have at least header offset if used outside app-container */
        .page { padding-top: 8px; }
        /* Fix main header to top so it doesn't scroll away */
        header {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            z-index: 70;
        }
        
        .page { display: none; }
        .page.active { display: block; }

        /* Main Bottom Nav Styling */
        .bottom-nav {
            position: fixed !important;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60; /* Ensure main nav is above other content */
            background: #ffffff;
            height: auto;
            min-height: 56px;
        }
        .bottom-nav-item { 
            width: 7.69%; /* Adjusted for 13 items */
            transition: all 0.2s ease;
            color: #6b7280; /* Gray-500 default */
            padding: 8px 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
        } 
        
        /* Simple Active State (Default blue on click/active page) */
        .bottom-nav-item.active {
            color: #2563eb; /* Blue-600 */
            font-weight: 600;
        }

        /* Icon styling - Improved specificity and defaults */
        .lucide-icon {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
        }

        /* Bottom nav specific icon styling */
        .bottom-nav-item svg {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
            margin: 0 auto !important;
        }

        .bottom-nav-item.active svg {
            color: #2563eb !important; 
        }

        /* Ensure all Lucide icons have consistent styling */
        [data-lucide] {
            display: inline-block !important;
            vertical-align: middle !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
        }

        /* Additional size variations */
        [data-lucide].icon-sm {
            width: 16px !important;
            height: 16px !important;
        }
        
        /* Debts Table Styling to match screenshot */
        #debts-detail-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-family: Arial, sans-serif !important;
            direction: rtl !important;
        }
        
        #debts-detail-table th {
            background: #5c3317 !important;
            color: white !important;
            font-weight: bold !important;
            padding: 8px !important;
            border: 1px solid #3e2211 !important;
            text-align: center !important;
        }
        
        #debts-detail-table td {
            padding: 8px !important;
            border: 1px solid #ddd !important;
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            text-align: center !important;
            color: black !important;
            font-weight: bold !important;
        }
        
        #debts-detail-table td:first-child {
            text-align: right !important;
        }
        
        /* Force visibility of table elements */
        #debts-detail-table, #debts-detail-table thead, #debts-detail-table tbody,
        #debts-detail-table tr, #debts-detail-table th, #debts-detail-table td {
            display: revert !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        [data-lucide].icon-lg {
            width: 32px !important;
            height: 32px !important;
        }

        /* Allow specific size overrides through classes */
        [data-lucide].w-4 { width: 16px; height: 16px; }
        [data-lucide].w-5 { width: 20px; height: 20px; }
        [data-lucide].w-6 { width: 24px; height: 24px; }

        /* (removed) Floating action button for Month Close */

        /* ????? ??? ??????? ?? ????? ??????? ???????? */
        .recon-export-scale { width:1800px !important; }
        .recon-export-scale table { width:100% !important; }
        .recon-export-scale th, .recon-export-scale td { padding:10px !important; font-size:16px !important; }

        /* Inquiry page table styling */
        #inq-report-table th { background:#041635;color:#fff;padding:6px 8px;text-align:center;font-weight:700; }
        #inq-report-table td { padding:5px 6px;text-align:center;border-bottom:1px solid #e0e7ef; }
        #inq-report-table td.prod-name { text-align:right;font-weight:600;background:#f8fafc; }
        #inq-report-table tr:nth-child(even) td { background:#ffffff; }
        #inq-report-table tr:nth-child(odd) td { background:#f3f6fa; }
        #inq-report-table .qty-cell { font-weight:600;color:#0b3d91; }
        #inq-report-table .total-cell { font-weight:600;color:#064e3b; }
        #inq-summary .card { background:#041a3f;color:#fff;padding:12px 10px;border-radius:8px;display:flex;flex-direction:column;gap:4px; }
        #inq-summary .card span.val { font-size:16px;font-weight:700; }

        /* Price list sheet (match Excel-like style) */
        .price-sheet { width:100%; border-collapse:collapse; direction:rtl; font-size:12px; }
        .price-sheet thead th { background:#efefef; border:1px solid #c1c1d0; padding:6px 8px; text-align:center; font-weight:800; }
        .price-sheet tbody td { border:1px solid #d4d4e0; padding:6px 8px; text-align:center; }
        .price-sheet tbody tr:nth-child(odd) td { background:#f9f9fb; }
        .price-sheet tbody tr:nth-child(even) td { background:#ffffff; }
        .price-sheet td.name { text-align:right; font-weight:600; }
        .sheet-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .sheet-title { font-weight:800; font-size:16px; border:2px solid #888; padding:4px 10px; border-radius:4px; }
        .sheet-meta { display:flex; gap:12px; color:#374151; font-size:12px; }
        .pl-controls .label { font-weight:700; font-size:12px; }

        /* Column filter menu (Debts / Cash tables) */
        .column-filter-menu { position:absolute; background:#ffffff; border:1px solid #c4a300; box-shadow:0 4px 10px rgba(0,0,0,0.12); border-radius:6px; padding:8px; width:220px; max-height:340px; overflow:auto; font-size:12px; z-index:9999; direction:rtl; }
        .column-filter-menu .filter-search { width:100%; padding:4px 6px; border:1px solid #ddd; border-radius:4px; margin-bottom:6px; font-size:12px; }
        .column-filter-menu .filter-list label { cursor:pointer; line-height:1.4; }
        .column-filter-menu .filter-list input { vertical-align:middle; }
        .column-filter-menu .filter-actions { display:flex; gap:6px; margin-top:8px; }
        .column-filter-menu .filter-actions button { flex:1; background:linear-gradient(180deg,#ffd700,#daa520); color:#000; font-weight:600; padding:6px 4px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
        .column-filter-menu .filter-actions button:hover { filter:brightness(1.05); }
        .column-filter-btn { position:relative; }
        .column-filter-btn.filtered { color:#1d4ed8 !important; font-weight:700; }
        .column-filter-btn.filtered::after { content:''; position:absolute; top:2px; inset-inline-end:2px; width:7px; height:7px; background:#1d4ed8; border-radius:50%; box-shadow:0 0 0 1px #ffffff; }
        


        /* Reports SubNav Styling - positioned in lower white space area below bottom nav */
        /* Reports subnav is hidden by default and only shown when .active is added by navigation */
        #reports-subnav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: -64px; /* Hide below bottom-nav by default */
            height: 64px; /* Taller area for icons/labels */
            background-color: #f3f4f6; /* Gray-100 */
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -1px 8px rgba(0,0,0,0.04);
            display: none;
            justify-content: space-around;
            align-items: center;
            padding: 0 6px;
            z-index: 50; /* below bottom nav */
            transition: bottom 0.3s ease;
        }

        #reports-subnav.active {
            display: flex !important;
            bottom: 56px !important; /* Position above bottom-nav (56px is default min-height) */
        }
        
        .reports-subnav-item {
            width: 25%; /* 4 items */
            padding: 0.5rem 0.25rem; /* Equivalent to p-2 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-600 */
            font-size: 0.75rem; /* text-xs */
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        /* Style for Lucide icons inside subnav buttons */
        .reports-subnav-item svg {
            color: #4b5563; /* Default icon color */
            width: 16px;
            height: 16px;
        }
        .reports-subnav-item.active svg,
        .reports-subnav-item.active span {
            color: #dc2626; /* red-600 */
            font-weight: 600; /* font-semibold */
        }


    .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            visibility: hidden;
        }
        .modal-visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            visibility: visible;
        }
        .hidden {
            display: none !important;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        #backup-data-textarea, #restore-data-textarea {
            resize: none;
            height: 150px;
            font-family: monospace;
            font-size: 12px;
            direction: ltr;
            text-align: left;
        }

        .only-print {
            display: none;
        }

        #sale-modal.modal-visible {
            transform: none; /* Override for full screen modal */
        }
        
        /* Spreadsheet Entry Styles (Matching user request image and color theme) */
        #spreadsheet-entry-table input,
        #spreadsheet-entry-table select {
            width: 100%;
            padding: 4px;
            font-size: 0.875rem; /* text-sm */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            min-width: 60px; /* Ensure minimum width */
            text-align: center;
            transition: background-color 0.1s ease;
        }
        
        /* Style for read-only fields */
        #spreadsheet-entry-table input[readonly], 
        #spreadsheet-entry-table .spreadsheet-product-name {
            background-color: #f3f4f6; /* gray-100 */
            cursor: default;
        }
        
        /* Highlighting specific input fields (No alternating rows, only cell colors) */
        .spreadsheet-invoice-number {
            background-color: #e0f2fe; /* Light Blue 100 */
            font-weight: 600;
        }
        .spreadsheet-product-code, 
        .spreadsheet-product-name {
            background-color: #d1fae5; /* Light Green 100 */
            font-weight: 500;
        }
        /* Style for required select fields in spreadsheet row */
        .spreadsheet-collection {
            background-color: #e5e7eb; /* Gray-200 slightly darker background */
        }
        .spreadsheet-total {
            background-color: #fce7f3; /* Pink-100 for totals */
            font-weight: 700;
            color: #9d174d; /* Rose-700 */
        }


        #spreadsheet-entry-table .spreadsheet-product-name,
        #spreadsheet-entry-table .spreadsheet-collection {
            text-align: right;
            padding-right: 8px; /* Give some space for Arabic text */
        }
        #spreadsheet-entry-table th,
        #spreadsheet-entry-table td {
            padding: 4px 6px;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        /* New styles for Promotion Price Highlight */
        #spreadsheet-entry-table .spreadsheet-price.promotion-price-applied {
            background-color: #fef3c7 !important; /* Yellow-100 */
            color: #b91c1c !important; /* Red-700 */
            font-weight: 800;
            border: 2px solid #f59e0b; /* Amber-500 */
        }
        /* Style for Tax Filing Status field */
        .spreadsheet-tax-status-input {
            background-color: #fef2f2; /* Red-50 */
            text-align: center;
        }
        /* Style for Sales List Not Filed Tax Status */
        .tax-not-filed-badge {
            background-color: #fef2f2; /* Red-50 */
            color: #991b1b; /* Red-800 */
            font-weight: 700;
            border: 2px solid #dc2626; /* Red-600 */
            padding: 2px 8px;
        }

        /* NEW: Styling for Detailed Sales Table View */
        .sale-detail-grid {
            grid-template-columns: 1fr 3fr 1fr; /* Total | Details | Actions */
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sale-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 10px;
        }
        /* Ensure table header and rows use identical grid columns for perfect alignment */
        .sale-items-table thead tr,
        .sale-items-table tbody tr {
            display: grid;
            grid-template-columns: 2fr 0.5fr 0.5fr 0.5fr auto;
            align-items: center;
        }
        .sale-items-table th,
        .sale-items-table td {
            display: block; /* allow grid children sizing */
            padding-left: .75rem; padding-right: .75rem; padding-top: .5rem; padding-bottom: .5rem;
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        /* constrain numeric inputs to the column width and center them */
        .sale-item-quantity, .sale-item-price {
            width: 100%;
            max-width: 4.5rem;
            margin: 0 auto;
            text-align: center;
        }

        /* Make sure the sale modal content clears any fixed page header */
        #sale-modal main {
            margin-top: 80px !important; /* clear the fixed top navigation */
        }

        /* Force table/thead/tbody to block so grid rows align correctly */
        .sale-items-table,
        .sale-items-table thead,
        .sale-items-table tbody {
            display: block;
            width: 100%;
        }
        .sale-items-table th, .sale-items-table td {
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        .sale-items-table th {
            font-weight: 600;
            color: #4b5563;
            background-color: #f9fafb;
        }

        /* --- NEW SALES LIST CELL COLORS (Matching Spreadsheet) --- */
        .sale-item-name-cell, .sale-item-code-cell {
            background-color: #d1fae5; /* Green-100 */
        }
        .sale-item-total-cell {
            background-color: #fce7f3; /* Pink-100 */
            color: #9d174d; /* Pink-700 for high contrast */
        }
        .sale-item-qty-cell, .sale-item-price-cell {
            background-color: #e0f2fe; /* Blue-100 */
        }
        /* -------------------------------------------------------- */


        /* NEW: Styles for dedicated printing */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }

        /* Invoice quick-search fixed sidebar (only on Sales page, desktop) */
        /* Make the invoice quick-search visible and fixed inside Sales page by default
           (always visible so user can test easily). Change media query later if you want
           to hide on small screens. */
        #page-sales #invoice-quick-search {
            display: block !important;
            position: fixed;
            left: 12px; /* position at left side like the screenshot */
            top: 96px; /* a bit lower under the sticky header */
            width: 190px;
            height: calc(100vh - 120px);
            overflow: auto;
            z-index: 9; /* stay below header (header uses z-10) */
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            background: #ffffff;
        }
        
        /* Dispatch Item Inputs Styling */
        #dispatch-items-table input {
            padding: 2px 4px !important;
            font-size: 0.75rem !important;
        }

        /* Stock Control Column Colors */
        .stock-col-initial { background-color: #e0f2fe; } /* Light Blue */
        .stock-col-inward { background-color: #dcfce7; } /* Light Green */
        .stock-col-production { background-color: #f3e8ff; } /* Light Purple */
        .stock-col-outbound { background-color: #fef9c3; } /* Light Yellow */
        .stock-col-book { background-color: #e5e7eb; } /* Gray */
        .stock-col-actual { background-color: #fee2e2; } /* Light Red */
        .stock-col-diff { background-color: #ffedd5; } /* Light Orange */
        
        /* NEW: Custom Highlight Colors for Manual Review */
        .invoice-cell {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 8px;
            display: inline-block;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 700;
        }
        .invoice-cell.highlight-blue {
            background-color: #93c5fd !important; /* Blue-300 */
            color: #1e3a8a !important; /* Blue-900 */
        }
        .invoice-cell.highlight-green {
            background-color: #86efac !important; /* Green-300 */
            color: #14532d !important; /* Green-900 */
        }
        .invoice-cell.highlight-purple {
            background-color: #c4b5fd !important; /* Violet-300 */
            color: #4c1d95 !important; /* Violet-900 */
        }
        .invoice-cell.highlight-orange {
            background-color: #fed7aa !important; /* Orange-300 */
            color: #7c2d12 !important; /* Orange-900 */
        }
        .invoice-cell.highlight-teal {
            background-color: #99f6e4 !important; /* Teal-300 */
            color: #0f766e !important; /* Teal-800 */
        }
        /* ===== Debts page custom layout (matches provided screenshot) ===== */
        #debts-detail-table th {
    background: linear-gradient(180deg,#ffd700,#daa520) !important;
    color: black !important;
    font-weight: bold !important;
    padding: 8px !important;
    border: 1px solid #c4a300 !important;
    text-align: center !important;
}

.debts-container {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        .debts-sidebar {
            width: 320px; /* fixed left column */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .debts-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }
        .debt-card {
            border-radius: 10px;
            padding: 22px 16px;
            margin-bottom: 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
            background: linear-gradient(180deg, #fff7ed, #fef3c7);
        }
        .debt-card .title {
            font-weight: 700;
            color: #7c4a00;
            margin-bottom: 6px;
        }
        .debt-card .value {
            font-size: 28px;
            font-weight: 800;
            color: #3b2a0d;
        }
        .debt-card.big {
            background: linear-gradient(180deg,#7a4300,#3b2300);
            color: #fff;
            padding: 26px 18px;
        }

        /* Make the debts table header gold gradient */
        .gold-header th {
            background: linear-gradient(180deg,#f6d06a,#d59d00);
            color: #3b2a04;
            font-weight: 800;
            padding: 14px;
            border-right: 1px solid rgba(255,255,255,0.15);
        }
        /* Adjust table to take remaining space */
        .debts-main {
            flex: 1 1 auto;
        }
        /* Small adjustments for date inputs and filters to match screenshot */
        .filter-input { height:44px; padding:10px 12px; }
        
        /* Fix for debts table visibility: ensure table elements use proper table display types
           and prevent parent overflow from clipping rows when rendering under some environments. */
          #debts-detail-table { display: table !important; width: 100% !important; table-layout: auto !important; position: relative !important; z-index: 5 !important; }
        #debts-detail-table thead { display: table-header-group !important; }
        #debts-detail-table tbody { display: table-row-group !important; }
        #debts-detail-table tr { display: table-row !important; visibility: visible !important; opacity: 1 !important; }
        #debts-detail-table td, #debts-detail-table th { display: table-cell !important; color: inherit !important; }
        .debts-main .overflow-x-auto { overflow: auto !important; }

        /* Stronger visibility rules for debts rows in case theme/global CSS hides them */
        #debts-detail-table tbody tr td {
            color: #111 !important;
            background: transparent !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: table-cell !important;
            font-size: 14px !important;
        }
        #debts-detail-table tbody {
            min-height: 120px !important;
        }
        /* Allow JS filtering to hide rows even with the base !important rules */
        #debts-detail-table tr.hidden-by-filter { display: none !important; }
        /* Ensure debts main content sits above any large background watermark */
        .debts-main { position: relative !important; z-index: 6 !important; }

        /* Column filter UI removed (restored original header behavior) */
        /* Re-introduced column filter UI styles */
        .column-filter-btn {
            display:inline-block;
            background:transparent;
            border:0;
            cursor:pointer;
            padding:2px 6px;
            margin-inline-start:6px;
            border-radius:4px;
            font-size:14px;
        }
        .column-filter-btn:hover { background: rgba(0,0,0,0.04); }
        .column-filter-menu {
            position: absolute;
            z-index: 99999;
            background: #fff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            padding: 8px;
            width: 260px;
            max-height: 340px;
            overflow: hidden;
            direction: rtl;
            display: none;
            border-radius: 6px;
        }
        .column-filter-menu .filter-search { width:100%; padding:8px; border:1px solid #e5e7eb; margin-bottom:6px; border-radius:4px; }
        .column-filter-menu .filter-list { max-height:200px; overflow:auto; padding-right:6px; }
        .column-filter-menu .filter-list label { display:block; padding:4px 2px; font-size:13px; }
        .column-filter-menu .filter-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
        .column-filter-menu .filter-actions button { padding:6px 10px; border-radius:6px; border:0; cursor:pointer; }
        .column-filter-menu .apply-btn { background:#f97316; color:white; }
        .column-filter-menu .clear-btn { background:#f3f4f6; color:#111; }

        /* Alternating row colors to match the screenshot */
        /* Even rows - lighter gold */
        #debts-detail-table tbody tr:nth-child(even) td {
            background: linear-gradient(180deg, #fff5d5, #ffd868) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }
        
        /* Odd rows - darker gold */
        #debts-detail-table tbody tr:nth-child(odd) td {
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }

        /* Money columns - all centered */
        #debts-detail-table tbody tr td.total,
        #debts-detail-table tbody tr td.paid,
        #debts-detail-table tbody tr td.remaining {
            text-align: center !important;
        }

        /* Text alignment */
        #debts-detail-table tbody tr td {
            text-align: center !important;
        }
        #debts-detail-table tbody tr td.customer-name {
            text-align: right !important;
        }

        /* Header styling (legacy) - replaced by Cool Gradient theme below */
        #debts-detail-table thead th {
            /* legacy fallback kept intentionally */
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: bold !important;
            padding: 8px !important;
            text-align: center !important;
        }

        /* ===== Cool Gradient Theme for Debts Table ===== */
        /* Table shell */
        #debts-detail-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-family: Arial, sans-serif !important;
            direction: rtl !important;
            border: 1px solid #a5b4fc !important; /* cool cyan border */
            color: #0f172a !important;
        }

        /* Glossy linear gradient header: right (dark purple) ? royal blue ? teal (left) */
        #debts-detail-table thead th {
            background: linear-gradient(to left, #2c0f5b 0%, #2b6cb0 50%, #06b6d4 100%) !important;
            color: #ffffff !important;
            font-weight: 800 !important;
            padding: 10px 12px !important;
            text-align: center !important;
            border-bottom: 1px solid rgba(0,0,0,0.12) !important;
            border-top: 2px solid rgba(255,255,255,0.35) !important; /* slight white top-border for glossy effect */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
        }

        /* First column (right-most) - Date/Day */
        #debts-detail-table tbody td:first-child,
        #debts-detail-table tbody th:first-child {
            background: #2c0f5b !important; /* dark purple */
            color: #ffffff !important;
            font-weight: 700 !important;
            text-align: right !important;
            border-right: 1px solid #a5b4fc !important;
        }

        /* Data column tints (3-column repeating pattern) */
        /* Pattern: (3n+1) soft blue, (3n+2) light lavender, (3n+3) pale cyan */
        #debts-detail-table tbody td:nth-child(3n+1) {
            background: rgba(230,240,255,0.85) !important; /* soft blue */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }
        #debts-detail-table tbody td:nth-child(3n+2) {
            background: rgba(243,229,255,0.88) !important; /* light lavender */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }
        #debts-detail-table tbody td:nth-child(3n+3) {
            background: rgba(224,247,250,0.88) !important; /* pale cyan */
            border: 1px solid #a5b4fc !important;
            color: #0b1a2b !important;
        }

        /* Zebra-striping overlay: slightly adjust tint on even rows */
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+1) { background: rgba(216,230,255,0.9) !important; }
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+2) { background: rgba(236,228,255,0.9) !important; }
        #debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+3) { background: rgba(206,244,246,0.9) !important; }

        /* Money/total cells highlight */
        #debts-detail-table tbody tr td.total,
        #debts-detail-table tbody tr td.paid,
        #debts-detail-table tbody tr td.remaining {
            background: #06b6d4 !important; /* bright cyan/teal */
            color: #ffffff !important;
            font-weight: 800 !important;
            border: 1px solid #7dd3fc !important;
        }

        /* Hover accent */
        #debts-detail-table tbody tr:hover td {
            transform: translateY(0);
            box-shadow: inset 0 0 0 9999px rgba(255,255,255,0.02);
            transition: background-color 120ms ease;
        }

        /* Footer */
        #debts-detail-table tfoot td {
            background: linear-gradient(to left, #0f172a, #1e293b) !important; /* dark indigo/navy */
            color: #ffffff !important;
            font-weight: 700 !important;
            padding: 10px !important;
            border-top: 2px solid #a5b4fc !important;
        }

        /* Ensure cells have visible cool-blue borders */
        #debts-detail-table td, #debts-detail-table th {
            border: 1px solid #a5b4fc !important;
            padding: 8px !important;
        }

        /* Keep customer name right-aligned for Arabic */
        #debts-detail-table tbody tr td.customer-name { text-align: right !important; }

        /* Small responsive fix: allow table to scroll horizontally */
        .debts-main .overflow-x-auto { overflow-x: auto !important; }

        /* End Cool Gradient Theme */

        /* Summary boxes styling - different gold gradients */
        .debt-card {
            padding: 20px !important;
            border-radius: 8px !important;
            margin: 8px !important;
        }

        /* ?????? ???????? */
        .debt-card:nth-child(1) {
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            color: black !important;
        }

        /* ?????? */
        .debt-card:nth-child(2) {
            background: linear-gradient(180deg, #f0c233, #cc9900) !important;
            color: black !important;
        }

        /* SUB TOTAL */
        .debt-card:nth-child(3) {
            background: linear-gradient(180deg, #ffdb4d, #e6b800) !important;
            color: black !important;
        }

        /* ?????? ?????????? - lighter brown */
        .debt-card.big {
            background: linear-gradient(180deg, #8b6914, #654b0f) !important;
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        }

        /* Hover effect - lighter gold for both odd and even rows */
        #debts-detail-table tbody tr:hover td {
            background: linear-gradient(180deg, #fff7e6, #ffe180) !important;
        }

    </style>
</head>
<body class="bg-gray-100">
    <script>
        // Ensure a safe updateIcons exists early to prevent ReferenceError when other scripts call it.
        if (!window.updateIcons) {
            window.updateIcons = function(){
                try {
                    if (window.lucide && typeof window.lucide.replace === 'function') {
                        window.lucide.replace();
                        return;
                    }
                    if (window.Lucide && typeof window.Lucide.replace === 'function') {
                        window.Lucide.replace();
                        return;
                    }
                } catch(e) {
                    // ignore
                }
            };
        }

        // Debug helper: reveal invoice sidebar (type manually in Console if needed)
        window.showInvoiceQuickSearch = function(){
            try {
                var el = document.getElementById('invoice-quick-search-panel') || document.getElementById('invoice-quick-search-global');
                if (el) el.style.display = '';
                return !!el;
            } catch(e){ return false; }
        };
    </script>
    <style>
        /* Targets table grid: soft horizontal lines + clear vertical separators */
        .targets-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .targets-table th, .targets-table td { padding: 6px 8px; font-size: 12px; text-align: center; }
        .targets-table tbody td { border-bottom: 1px solid rgba(17,24,39,0.06); }
        .targets-table td + td, .targets-table th + th { border-left: 2px solid rgba(59,130,246,0.25); }
        .targets-col-day { background:#e8f2ff; color:#0b1b34; }
        .targets-col-total { background:#ffe4e6; color:#0b1b34; font-weight:700; }
        /* Customer targets visual style (approximate to provided Excel screenshot) */
        .customer-targets-table { border-collapse: separate; border-spacing:0; width:100%; font-size:12px; }
        .customer-targets-table th { padding:6px 6px; font-weight:700; color:#fff; text-align:center; }
        .cth-name { background:#2f2f34; }
        .cth-multi-target, .cth-dairy-target { background:#b66a00; }
        .cth-multi-ach, .cth-dairy-ach { background:#0f2d64; }
        .cth-total-target { background:#004d40; }
        .cth-total-ach { background:#003366; }
        .cth-rem, .cth-rem-total { background:#5a3d00; }
        .cth-pct, .cth-pct-total { background:#2c3e50; }
        .customer-targets-table tbody tr:nth-child(even) td { background:#f9fafb; }
        .customer-targets-table tbody tr:nth-child(odd) td { background:#fff; }
        .customer-targets-table td { padding:5px 6px; text-align:center; border-bottom:1px solid #e5e7eb; }
        .customer-targets-table td.name { text-align:right; font-weight:600; }
        .customer-targets-table input.cust-target-input { background:#fff; font-size:11px; }
        .customer-targets-table .ach-cell { font-weight:600; color:#0d47a1; }
        .customer-targets-table .rem-pos { color:#b45309; font-weight:600; }
        .customer-targets-table .rem-zero { color:#059669; font-weight:600; }
        .customer-targets-table .pct-ok { color:#047857; font-weight:600; }
        .customer-targets-table .pct-low { color:#374151; font-weight:600; }
        .ghost-zero::before { content:'0'; opacity:0.35; }
    </style>
    <style>
        /* Hide accidental visible code blocks that may appear at top of page */
        body > pre, body > code, .top-debug-text { display: none !important; }
    </style>
    <!-- Removed duplicate global quick-search; using page-local panel inside #page-sales -->
    <script>
        // ?????? ?? ??? ?????? ???????? ??? - ?? ????? ?????
        function showDashboardPage() {
            // ????? ???? ??????? ?????
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
                pages[i].style.display = 'none';
            }
            
            // ????? ???? ???? ?????????
            var dashboard = document.getElementById('page-dashboard');
            if (dashboard) {
                dashboard.classList.add('active');
                dashboard.style.display = 'block';
            }
            
            // ????? ????????? ?? ???? ??????
            var navItems = document.getElementsByClassName('bottom-nav-item');
            for (var i = 0; i < navItems.length; i++) {
                navItems[i].classList.remove('active');
                if (navItems[i].getAttribute('data-page') === 'dashboard') {
                    // ?? ???? ?????? ?????????
                    navItems[i].classList.add('active');
                }
            }

            // ????? ????? ?? ????? ?????? (?? ?? ???? ????? DOM ????? ??? ??? ??????)
            var statementCustomerListEl = document.getElementById('statement-customer-list');
            var statementCustomerSearchEl = document.getElementById('statement-customer-search');
            if (statementCustomerListEl && statementCustomerSearchEl) {
                statementCustomerSearchEl.value = '';
                try { updateCustomerList(''); } catch (e) { console.warn('updateCustomerList failed during dashboard init', e); }
            }

            // ????? ????????? ????????? ?? ????? ??????
            try { updateIcons(); } catch (e) { console.warn('updateIcons failed', e); }

            // Keep the Cash page synchronized whenever main UI re-renders (e.g., after save/delete)
            try { if (typeof renderCash === 'function') renderCash(); } catch (e) { console.warn('renderCash failed from renderAll', e); }
        }

        // ????? ?????? ??? ????? ???????
        document.addEventListener('DOMContentLoaded', showDashboardPage);
        
        // ????? ?????? ??? ????? ?????? ???????
        window.addEventListener('load', showDashboardPage);
        
        // ????? ???? ??????
        showDashboardPage();
    </script>

    <!-- UI Navigation & Authentication Handler -->
    <script>
        const UIController = {
            // ??? ???? ????? ??????
            showLoginPage() {
                const loginEl = document.getElementById('login-page');
                const registerEl = document.getElementById('register-page');
                const appEl = document.getElementById('app-container');
                if (loginEl) loginEl.classList.remove('hidden');
                if (registerEl) registerEl.classList.add('hidden');
                if (appEl) appEl.classList.add('hidden');
            },

            // ??? ???? ???????
            showRegisterPage() {
                const loginEl = document.getElementById('login-page');
                const registerEl = document.getElementById('register-page');
                if (loginEl) loginEl.classList.add('hidden');
                if (registerEl) registerEl.classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            },

            // ??? ??????? ???????
            showApp() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('register-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                this.updateCurrentUserDisplay();
            },

            // ????? ??? ???????? ??????
            updateCurrentUserDisplay() {
                const user = AuthSystem.getCurrentUser();
                const userDisplay = document.getElementById('current-user-display');
                if (user && userDisplay) {
                    const role = getUserRole();
                    userDisplay.textContent = `??????? ${user.name} (${role})`;
                    try {
                        // Toggle admin map button visibility based on role
                        const mapBtn = document.getElementById('open-map-btn');
                        if (mapBtn) mapBtn.classList.toggle('hidden', role !== 'admin');
                    } catch(e){}
                }
            },

            // ????? ?? ??????? ?? ??? ?????? ???????
            showPage(pageId) {
                const pages = document.querySelectorAll('.page');
                pages.forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                const page = document.getElementById(pageId);
                if (page) {
                    page.classList.add('active');
                    page.style.display = 'block';
                }
            }
        };

        // ??????? ????? ????? ??????
        document.addEventListener('DOMContentLoaded', () => {
            // ?????/????? ???? ??????
            try {
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-target');
                        const input = document.getElementById(id);
                        if (!input) return;
                        input.type = input.type === 'password' ? 'text' : 'password';
                        btn.textContent = input.type === 'password' ? '???' : '??';
                    });
                });
            } catch(e) { /* ignore */ }
            // ????? ????? ????? ?????? (???? ?????)
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const rememberEl = document.getElementById('login-remember');
                    const remember = rememberEl ? rememberEl.checked : false;
                    
                    // Use new service-based login (hybrid mode)
                    const result = await (typeof window.loginUsingServices === 'function'
                        ? window.loginUsingServices(email, password, { showAlertOnError: false })
                        : AuthSystem.login(email, password));
                    
                    if (result.ok || result.success) {
                        if (remember) {
                            localStorage.setItem('app_remember_email', email);
                        }
                        loginForm.reset();
                        // onAuthStateChanged ????? ????????
                    } else {
                        alert('? ???: ' + (result.error || result.message));
                    }
                });
            }

            // ????? ????? ????? ?????? (???????)
            const loginFormModal = document.getElementById('login-modal-form');
            if (loginFormModal) {
                loginFormModal.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailEl = document.getElementById('login-email-modal');
                    const passEl = document.getElementById('login-password-modal');
                    const email = emailEl ? emailEl.value : '';
                    const password = passEl ? passEl.value : '';
                    // Use new service-based login (hybrid mode)
                    const result = await (typeof window.loginUsingServices === 'function'
                        ? window.loginUsingServices(email, password, { showAlertOnError: false })
                        : AuthSystem.login(email, password));
                    if (result.ok || result.success) {
                        loginFormModal.reset();
                        try { closeModal(document.getElementById('login-modal')); } catch(_){}
                    } else {
                        alert('? ???: ' + (result.error || result.message));
                    }
                });
            }

            // ????? ????? ???????
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const confirmPassword = document.getElementById('register-password-confirm').value;
                    
                    // ?????? ?? ????? ????? ??????
                    if (password !== confirmPassword) {
                        alert('? ????? ?????? ??? ???????');
                        return;
                    }
                    
                    // ?????? ?? ??? ???? ??????
                    if (password.length < 6) {
                        alert('? ???? ?????? ??? ?? ???? 6 ???? ??? ?????');
                        return;
                    }
                    
                    const result = await AuthSystem.register(email, password, name);
                    
                    if (result.success) {
                        alert('? ' + result.message + '\n\n????? ???? ????? ??????');
                        
                        // ??? ???????
                        registerForm.reset();
                        
                        // ?????? ??? ???? ????? ??????
                        UIController.showLoginPage();
                    } else {
                        alert('? ???: ' + result.message);
                    }
                });
            }

            // ??????? ??????? ??? ????? ????? ?????? ????????
            const goToRegisterBtn = document.getElementById('go-to-register-btn');
            if (goToRegisterBtn) {
                goToRegisterBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    UIController.showRegisterPage();
                });
            }

            const goToLoginBtn = document.getElementById('go-to-login-btn');
            if (goToLoginBtn) {
                goToLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    UIController.showLoginPage();
                });
            }

            // ????? ?? ????? ??????
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (confirm('?? ???? ????? ???????')) {
                        // Use new service-based logout (hybrid mode)
                        await (typeof window.logoutUsingServices === 'function'
                            ? window.logoutUsingServices({ showAlertOnError: false })
                            : AuthSystem.logout());
                        localStorage.removeItem('app_remember_email');
                        UIController.showLoginPage();
                    }
                });
            }

            // ??? ??? ??? ???????? ???? ???? ??????
            // ???????? ??? onAuthStateChanged ???? ????? ?????? ?? ??? ???????
            const rememberEmail = localStorage.getItem('app_remember_email');
            if (rememberEmail) {
                const pageEmail = document.getElementById('login-email');
                if (pageEmail) pageEmail.value = rememberEmail;
                const modalEmail = document.getElementById('login-email-modal');
                if (modalEmail) modalEmail.value = rememberEmail;
            }
            UIController.showLoginPage();
        });

        // ???? ?????? ??????? ???????? ??????
        async function initializeAppForUser() {
            // ????? ?????: ????? ??? ??? ????????? ??????? ???? ????? state.
            // ????? activePeriod: ?????? ??????? ?????? ??????? ?? ????? ??? localStorage ???????
            const currentPeriod = __formatPeriod(new Date());
            if (!window.state) {
                window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], productions: [], settings: { salesTarget: 10000 }, stockEntries: {}, activePeriod: currentPeriod, chains: [] };
                // CRITICAL: Load stockEntries from localStorage on init
                try {
                    const saved = localStorage.getItem('stock_entries');
                    if (saved) window.state.stockEntries = JSON.parse(saved);
                } catch(e){ console.warn('Failed to restore stockEntries during init', e); }
            }
            else {
                // t???? activePeriod ?????? ??????? ?????? ??? ????? ???????
                window.state.activePeriod = currentPeriod;
                // ???? ?? ???? productions array
                if (!Array.isArray(window.state.productions)) window.state.productions = [];
                // CRITICAL: Preserve stockEntries from localStorage if available
                try {
                    if (!window.state.stockEntries || Object.keys(window.state.stockEntries).length === 0) {
                        const saved = localStorage.getItem('stock_entries');
                        if (saved) window.state.stockEntries = JSON.parse(saved);
                    }
                } catch(e){ console.warn('Failed to restore stockEntries during re-init', e); }
            }
            // ??? ?????? ?????? ?? localStorage
            try { localStorage.setItem('active_period', currentPeriod); } catch(e){}
            console.log(`initializeAppForUser: Set activePeriod to ${currentPeriod}`);
            try { UIController.updateCurrentUserDisplay(); } catch(e){}
            
            // === PHASE 4: Load Products with Cache-First Strategy ===
            try {
                if (typeof window.ProductsService === 'object' && typeof window.ProductsService.getProducts === 'function') {
                    console.log('Loading products with Cache-First strategy...');
                    const products = await window.ProductsService.getProducts({ maxAgeMs: 6 * 60 * 60 * 1000 });
                    if (Array.isArray(products) && products.length > 0) {
                        window.state.products = products;
                        console.log(`? Loaded ${products.length} products from cache/server`);
                    } else {
                        console.warn('No products loaded, using empty array');
                        window.state.products = [];
                    }
                } else {
                    console.warn('ProductsService not available, using empty products array');
                    window.state.products = [];
                }
            } catch(e) {
                console.error('Failed to load products:', e);
                window.state.products = [];
            }
            
            // === PHASE 5: Load Customers with Cache-First Strategy ===
            try {
                if (typeof window.CustomersService === 'object' && typeof window.CustomersService.getCustomers === 'function') {
                    console.log('Loading customers with Cache-First strategy...');
                    const customers = await window.CustomersService.getCustomers({ maxAgeMs: 6 * 60 * 60 * 1000 });
                    if (Array.isArray(customers) && customers.length > 0) {
                        window.state.customers = customers;
                        console.log(`? Loaded ${customers.length} customers from cache/server`);
                    } else {
                        console.warn('No customers loaded, using empty array');
                        window.state.customers = [];
                    }
                } else {
                    console.warn('CustomersService not available, using empty customers array');
                    window.state.customers = [];
                }
            } catch(e) {
                console.error('Failed to load customers:', e);
                window.state.customers = [];
            }
            
            // ????? ????? ?????? ?????? ??? ???? ?? ???????
            setTimeout(()=>{
                try { 
                    ensureDefaultActivePeriod();
                    console.log(`Forced activePeriod check: current=${currentPeriod}, saved=${localStorage.getItem('active_period')}`);
                } catch(e){}
            }, 500);
        }

        // ???? ??? ???????? ?????? (???? ??? ???????? ?????? ??? ???? ?? Firebase)
        const DataManager = {
            // ??? ???????? ???? ??? ??? ????????
            saveAppState(stateObj) {
                const user = AuthSystem.getCurrentUser();
                if (!user) {
                    console.warn('Cannot save state: no current user logged in');
                    return false;
                }
                
                try {
                    // ??? ???????? ?????? ????
                    localStorage.setItem('app_state', JSON.stringify(stateObj));
                    
                    // ??? ???? ???????? ?? ?????? ????????
                    user.data.lastAppState = stateObj;
                    AuthSystem.setCurrentUser(user);

                    // ???? ????? ??? ?????? ?? Firebase (?? ?? ??????)
                    try {
                        if (typeof saveStateToFirebase === 'function') {
                            saveStateToFirebase(stateObj).then(ok => {
                                if (ok) console.log('? saved state to Firebase');
                            }).catch(e => console.warn('Failed to save state to Firebase', e));
                        }
                    } catch(e) { console.warn('saveStateToFirebase error', e); }

                    return true;
                } catch (e) {
                    console.error('Error saving app state:', e);
                    return false;
                }
            },

            // ????? ???????? ??? ????????
            loadAppState() {
                const user = AuthSystem.getCurrentUser();
                
                try {
                    // ??? ????? ???????? ???????
                    const localData = localStorage.getItem('app_state');
                    if (localData) {
                        return JSON.parse(localData);
                    }
                    
                    // ??? ?? ????? ??? ?? ?????? ????????
                    if (user && user.data && user.data.lastAppState) {
                        return user.data.lastAppState;
                    }
                    
                    return null;
                } catch (e) {
                    console.error('Error loading app state:', e);
                    return null;
                }
            },

            // ??? ???? ???????? ??????? ????????
            clearUserData() {
                const user = AuthSystem.getCurrentUser();
                if (!user) return false;
                
                try {
                    user.data = {};
                    AuthSystem.setCurrentUser(user);
                    localStorage.removeItem('app_state');
                    return true;
                } catch (e) {
                    console.error('Error clearing user data:', e);
                    return false;
                }
            }
        };

        // ????? ?????????? ???????? (????? + ??? Firestore)
        function canManageUsers(){ try { return getUserRole() === 'admin'; } catch(e){ return false; } }

        function updateUserManagementVisibility(){
            const sec = document.getElementById('user-management-section');
            if (!sec) return;
            if (canManageUsers()) {
                sec.classList.remove('hidden');
                try { renderUsersTable(); } catch(e){}
            } else {
                sec.classList.add('hidden');
            }
        }

        function renderUsersTable(){
            const tbody = document.getElementById('users-table-body');
            const warn = document.getElementById('user-role-warning');
            if (!tbody) return;
            if (!canManageUsers()) { if (warn){ warn.textContent = '??? ?????? ????? ???????? ???.'; warn.classList.remove('hidden'); } return; }
            if (warn) warn.classList.add('hidden');
            const list = Array.isArray(window.state && state.users) ? state.users : [];
            if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="px-2 py-3 text-center text-gray-500">?? ???? ???????? ???.</td></tr>'; return; }
            const current = AuthSystem.getCurrentUser();
            tbody.innerHTML = list.map(u => {
                const role = (u.role || 'user');
                const disabled = (current && current.id === u._id) ? 'data-self="1"' : '';
                const pres = (window.state && Array.isArray(state.presence)) ? state.presence.find(p => (p._id===u._id) || (p.uid===u._id) || ((p.email||'').toLowerCase() === (u.email||'').toLowerCase())) : null;
                const online = (typeof u.online !== 'undefined') ? !!u.online : !!(pres && pres.online === true); // ??? true? ??? !== false
                const emailStr = ((u.email||'').toLowerCase()) || ((pres && pres.email) ? (pres.email||'').toLowerCase() : '');
                return `<tr>
                    <td class="px-2 py-2">${u.name || '-'}</td>
                    <td class="px-2 py-2 flex items-center gap-2">
                        <span class="inline-block w-2.5 h-2.5 rounded-full ${online ? 'bg-green-500' : 'bg-gray-400'}" title="${online ? '???? ????' : '??? ????'}"></span>
                        <span>${emailStr}</span>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <select class="user-role-select p-1 border rounded" data-uid="${u._id}" ${disabled}>
                            <option value="admin" ${role==='admin'?'selected':''}>admin</option>
                            <option value="rep" ${role==='rep'?'selected':''}>rep</option>
                            <option value="viewer" ${role==='viewer'?'selected':''}>viewer</option>
                            <option value="user" ${role==='user'?'selected':''}>user</option>
                        </select>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="apply-role-btn bg-blue-600 text-white px-3 py-1 rounded text-xs" data-uid="${u._id}">?????</button>
                            ${emailStr ? '' : `<button class="set-user-email-btn bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs" title="????? ????" data-uid="${u._id}">????? ????</button>`}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // ????? ??????? ??????
        document.addEventListener('click', async function(e){
            const btn = e.target && e.target.closest ? e.target.closest('.apply-role-btn') : null;
            if (!btn) return;
            if (!canManageUsers()) { alert('???? ???? ?????? ???????'); return; }
            const uid = btn.getAttribute('data-uid');
            const sel = document.querySelector(`select.user-role-select[data-uid="${uid}"]`);
            if (!uid || !sel) return;
            const role = sel.value;
            const current = AuthSystem.getCurrentUser();
            if (current && current.id === uid && role !== 'admin') {
                if (!confirm('??? ????? ????? ?????? ?????? ?? ????? ?? ???? ??????? ???????. ?? ??? ??????')) return;
            }
            try {
                // ????? users/{uid}.role
                await db.collection('users').doc(uid).set({ role: role }, { merge: true });
                // ????? roles/{uid}.role ??????? ?? ????? Firestore ??? ???????
                try { await db.collection('roles').doc(uid).set({ role: role }, { merge: true }); } catch(_e){}
                alert('?? ????? ????? ?????');
            } catch (err) {
                console.warn('??? ????? ?????', err);
                alert('???? ????? ?????? ???? ?? ?????? ??????????');
            }
        });

        document.addEventListener('click', function(e){
            const r = e.target && e.target.id === 'refresh-users-btn';
            if (!r) return;
            try { renderUsersTable(); } catch(e){}
        });

        // Auto-save when the new-price input changes (so user doesn't have to press the button)
        document.addEventListener('change', function(e){
            const inp = e.target && e.target.classList && e.target.classList.contains('unified-new-price') ? e.target : null;
            if(!inp) return;
            const id = inp.getAttribute('data-id');
            const typeLabel = inp.getAttribute('data-type');
            const rawVal = (inp.value||'').trim(); if(rawVal==='' ) return;
            const num = parseFloat(rawVal); if(isNaN(num)) { alert('??? ??? ????'); return; }
            const mapType = t => t==='????'?'raw': (t==='?????'?'pack': (t==='?????'?'ops': (t==='???? ?????'?'finished':'raw')));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); if(!it){ alert('?????? ??? ?????'); return; }
            const now = new Date().toISOString();
            it.lastPrice = num; it.lastPriceDate = now; it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; it.priceHistory.unshift({ price: num, date: now, note: '???? ?????' });
            saveLists();
            // update current price span
            const currentSpan = document.querySelector(`.unified-current-price[data-id="${CSS.escape(id)}"][data-type="${CSS.escape(typeLabel)}"]`);
            if(currentSpan) currentSpan.textContent = Number(num).toFixed(2);
            showSavedIndicator(inp);
            // keep input value as-is or clear depending on UX; here we clear to indicate completion
            inp.value = '';
            console.log('? unified-new-price change saved');
        });

        // ?????/????? ???? ???????? ?????? ?? ??????
        document.addEventListener('click', async function(e){
            const btn = e.target && e.target.closest ? e.target.closest('.set-user-email-btn') : null;
            if (!btn) return;
            if (!canManageUsers()) { alert('???? ???? ?????? ???????'); return; }
            const uid = btn.getAttribute('data-uid');
            const currentEmail = (state.users||[]).find(u=>String(u._id)===String(uid))?.email || '';
            const val = prompt('???? ???? ????????', currentEmail || '');
            if (!val) return;
            const email = String(val).trim().toLowerCase();
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('???? ???? ??? ?????'); return; }
            try {
                await db.collection('users').doc(uid).set({ email }, { merge: true });
                // ???? ??????? ???? ??? ??????
                try {
                    const i = (state.users||[]).findIndex(u=>String(u._id)===String(uid));
                    if (i>=0) { state.users[i] = Object.assign({}, state.users[i], { email }); }
                } catch(_){ }
                renderUsersTable();
            } catch(err){
                alert('???? ??? ??????');
                console.warn('set email failed', err);
            }
        });

        // ?? ??? ????? ?????????? ???? ?????????
        document.addEventListener('click', function(e){
            const openBtn = e.target && (e.target.id === 'open-user-management-btn' || (e.target.closest && e.target.closest('#open-user-management-btn')));
            if (!openBtn) return;
            if (!canManageUsers()) { alert('??? ?????? ???????? ???'); return; }
            const sec = document.getElementById('user-management-section');
            if (sec) {
                sec.classList.remove('hidden');
                try { sec.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e){}
            }
        });

        // ????/???? ??? ??????? ??? ????? ?????? ???? ????? ???????? ??????
        document.addEventListener('DOMContentLoaded', updateUserManagementVisibility);
        try { UIController.updateCurrentUserDisplay = (function(orig){ return function(){ try { orig.call(UIController); } catch(e){}; try { updateUserManagementVisibility(); } catch(e){}; }; })(UIController.updateCurrentUserDisplay); } catch(e){}
    </script>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">??????</h1>
                <p class="text-gray-600 mt-2">???? ????? ????????</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">?????? ??????????</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="???? ????? ??????????" required>
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">???? ??????</label>
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10" placeholder="???? ???? ??????" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password" title="?????/?????">
                            ???
                        </button>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="login-remember" class="h-4 w-4 text-blue-600 rounded">
                    <label for="login-remember" class="mr-2 text-sm text-gray-600">??????</label>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">????</button>

                <div class="text-center text-sm text-gray-600">
                    <p>?? ???? ????? <button type="button" id="go-to-register-btn" class="text-blue-600 hover:underline font-semibold">????? ???? ????</button></p>
                </div>
            </form>

            <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                <p><strong>???????? ??????:</strong></p>
                <p>??????: test@example.com</p>
                <p>???? ??????: test123</p>
            </div>
        </div>
    </div>

    <!-- REGISTER PAGE -->
    <div id="register-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">????? ???? ????</h1>
                <p class="text-gray-600 mt-2">???? ????? ????????</p>
            </div>
            
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">????? ??????</label>
                    <input type="text" id="register-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="???? ???? ??????" required>
                </div>

                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">?????? ??????????</label>
                    <input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="???? ????? ??????????" required>
                </div>

                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">???? ??????</label>
                    <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="???? ???? ???? ????" required>
                </div>

                <div>
                    <label for="register-password-confirm" class="block text-sm font-medium text-gray-700 mb-1">????? ???? ??????</label>
                    <input type="password" id="register-password-confirm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="??? ????? ???? ??????" required>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">????? ??????</button>

                <div class="text-center text-sm text-gray-600">
                    <p>???? ???? ??????? <button type="button" id="go-to-login-btn" class="text-blue-600 hover:underline font-semibold">????</button></p>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="mx-auto bg-white shadow-lg min-h-screen hidden">
        
        <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 no-print flex justify-between items-center">
            <div class="flex items-center">
                <img id="company-logo-img" src="" alt="????" style="height:40px;display:none;margin-left:10px;border-radius:6px;background:white;padding:2px;" />
                <h1 id="header-title" class="text-xl font-bold">???? ?????????</h1>
            </div>
            <!-- ?????? ??????? ?? ????? ?????? -->
            <div class="flex-1 flex justify-center">
                <div id="digital-clock" class="text-2xl font-mono font-bold text-white tracking-widest" style="letter-spacing:0.1em;">00:00:00</div>
            </div>
            <div class="flex items-center gap-4">
                <!-- GPS quick toggle for reps (no need to open settings) -->
                <button id="gps-toggle-btn" class="px-2 py-1 rounded text-xs font-semibold bg-red-500 text-white hover:bg-red-600" title="?????/????? ?????? ??????">GPS OFF</button>
                <!-- Admin-only: open interactive map modal for all reps -->
                <button id="open-map-btn" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-xs font-semibold flex items-center gap-1" title="??? ????? ????????">
                    <span>???????</span>
                </button>
                <span id="reviewer-badge" class="hidden bg-amber-500 text-white px-2 py-1 rounded text-xs font-semibold" title="??? ???????? (????? ???)">??? ????????</span>
                <span id="current-user-display" class="text-white text-sm"></span>
                <!-- Cloud sync UI removed: using Local Storage for stock/costing -->
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">????? ??????</button>
            </div>
        </header>

        <main class="p-4">
            <!-- Admin Map Modal -->
            <div id="reps-map-modal" class="hidden fixed inset-0 z-40 bg-black bg-opacity-50 items-center justify-center" style="display:none;">
                <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                        <h3 class="font-bold text-gray-800">????? ????????</h3>
                        <button id="close-map-btn" class="text-gray-600 hover:text-black">?????</button>
                    </div>
                    <div class="p-0">
                        <div id="reps-map" style="height:70vh; width:100%;"></div>
                    </div>
                </div>
            </div>
            <div id="page-dashboard" class="page active">
                <div class="mb-4 grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div>
                        <label for="dashboard-rep-filter" class="block text-sm font-medium text-gray-700">??? ???????? ???????:</label>
                        <select id="dashboard-rep-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-green-800 font-semibold">?????? ???????? (?????)</h3>
                        <p id="total-sales" class="text-2xl font-bold text-green-900 mt-1">0 ?.?</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-blue-800 font-semibold">??????? ???????</h3>
                        <p id="total-collected" class="text-2xl font-bold text-blue-900 mt-1">0 ?.?</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-orange-800 font-semibold">??????? ????????</h3>
                        <p id="total-due" class="text-2xl font-bold text-orange-900 mt-1">0 ?.?</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-purple-800 font-semibold">??? ????????</h3>
                        <p id="sales-count" class="text-2xl font-bold text-purple-900 mt-1">0</p>
                    </div>
                </div>

                <!-- Target Progress -->
                <div class="mb-6">
                    <h3 id="target-title" class="font-bold text-gray-800 mb-2">????? ??????:</h3>
                    <h4 id="target-amount-display" class="text-blue-600 font-bold text-lg mb-2"></h4>
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="target-progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill text-xs text-white text-center" style="width: 0%;">
                            <span id="target-progress-text">0%</span>
                        </div>
                    </div>
                </div>

                <!-- CHART / GRAPHS SECTION (Kept charts in Dashboard for dual purpose) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <!-- Daily Sales Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">???????? ??????? ????? ??????</h3>
                        <div class="h-64">
                            <canvas id="sales-7-days-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Reps Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">???? ???????? (??????)</h3>
                        <div class="h-64">
                            <canvas id="top-reps-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Products (Quantity/Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">???? ???????? (????)</h3>
                         <div class="h-64">
                            <canvas id="top-products-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top Customers (Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">???? ??????? (????)</h3>
                         <div class="h-64">
                            <canvas id="top-customers-chart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- END CHART / GRAPHS SECTION -->
                
                <!-- The Reports button is no longer needed in the Dashboard -->
                <div class="mb-6 hidden">
                    <button id="view-reports-btn" class="w-full bg-blue-700 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-blue-800 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        <span>??? ???????? ??????? ????????</span>
                    </button>
                </div>
                
                <div class="mb-6">
                    <button id="manual-statement-btn" class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-gray-700 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="file-text"></i>
                        <span>??? ???? ????</span>
                    </button>
                </div>

                

                <div>
                    <h3 class="font-bold text-gray-800 mb-3">???? ?????? ?????</h3>
                    <div id="recent-sales-list" class="space-y-3">
                        <p class="text-gray-500 text-center">?? ???? ?????? ??? ???.</p>
                    </div>
                </div>
            </div>

            <div id="page-sales" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="receipt" class="w-6 h-6 text-blue-600"></i>
                        <span>???? ????????</span>
                    </h2>
                    <!-- ??? ??????? ?????? ?????? -->
                    <button id="scroll-to-bottom-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center gap-1 transition" title="???? ???? ????????">
                        <i data-lucide="arrow-down" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <button id="sales-quick-print-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="????? ?????? (????)">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                            <span>????? ??????</span>
                        </button>
                        <button id="sales-bt-print-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="????? ?????? (???????)">
                            <i data-lucide="bluetooth" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">??????</span>
                        </button>
                        <button id="sales-bt-test-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="?????? ?????? ????">
                            <i data-lucide="zap" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">??????</span>
                        </button>
                        <button id="sales-html-print-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="????? ?????">
                            <i data-lucide="file" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">????? ?????</span>
                        </button>
                    </div>
                    <!-- FAB is used for adding sales now -->
                </div>
                <!-- Sales filters bar (restored) -->
                <div id="sales-filters-bar" class="flex flex-col sm:flex-row gap-2 mb-4" style="position:sticky; top:72px; z-index:20; background:#ffffff; padding:8px 0;">
                    <input id="search-sales-text" type="text" placeholder="???? ???? ?????? ?? ??? ???????? ?? ????????..." class="w-full p-2 border rounded-md">
                    <div class="flex items-center w-full sm:w-auto relative">
                        <input id="search-sales-date" type="date" class="w-full p-2 border border-gray-300 rounded-md appearance-none">
                        <button id="clear-sales-date-btn" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-600 hidden font-bold text-xl leading-none p-1">&times;</button>
                    </div>
                    <input type="month" id="sales-month-selector" class="w-full sm:w-auto p-2 border rounded-md">
                    <select id="tax-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">????? ????? ?????</option>
                        <option value="filed">?? ?????</option>
                        <option value="not-filed">?? ??? ?????</option>
                    </select>
                    <select id="review-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">?? ????????</option>
                        <option value="pending">??? ???????? ???</option>
                        <option value="reviewed">???????? ???</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div id="daily-total-container" class="bg-blue-100 border-r-4 border-blue-500 p-3 rounded-lg text-center hidden shadow-md">
                        <span class="font-semibold">?????? ?????? ????? ??????:</span>
                        <span id="daily-total-amount" class="font-bold text-blue-800">0 ?.?</span>
                    </div>
                    <!-- Right column: filtered total only (quick-search moved to side drawer) -->
                    <div style="display:flex;gap:12px;align-items:flex-start;">
                        <div id="filtered-total-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg text-center shadow-md" style="flex:1;">
                            <div>
                                <span class="font-semibold">?????? ???????? ????????:</span>
                                <span id="filtered-total-amount" class="font-bold text-green-800">0 ?.?</span>
                            </div>
                            <div class="mt-1 text-sm text-green-900">
                                <span class="font-semibold">??? ????????:</span>
                                <span id="filtered-total-count" class="font-bold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Left slide-in drawer for Invoice Quick Search -->
                <div id="invoice-quick-search-wrap" class="fixed z-40 left-0" style="top:120px;width:220px;">
                    <div id="invoice-quick-search-content" class="relative transition-transform duration-200 ease-out">
                        <div id="invoice-quick-search-panel" class="bg-white p-2 rounded-r-lg shadow-lg border border-gray-200" style="width:220px;">
                            <div style="display:flex;flex-direction:column;gap:6px;align-items:stretch;">
                                <div style="background:#111027;color:#fff;padding:6px 8px;border-radius:4px;text-align:center;font-weight:700;">Number<br><div id="invoice-val-number" style="font-size:14px;margin-top:4px;">--</div></div>
                                <div style="background:#f6d8bf;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Total<br><div id="invoice-val-total" style="font-weight:700;">--</div></div>
                                <div style="background:#f4cfa9;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Return<br><div id="invoice-val-return">--</div></div>
                                <div style="background:#eee2d6;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Net amount<br><div id="invoice-val-net">--</div></div>
                                <div style="background:#e6f3e9;color:#0b6b2d;padding:6px 6px;border-radius:4px;text-align:center;">C - Name<br><div id="invoice-val-cname">--</div></div>
                                <div style="background:#2b2b2b;color:#fff;padding:6px 6px;border-radius:4px;text-align:center;">Date<br><div id="invoice-val-date" style="font-size:14px;margin-top:4px;" dir="ltr" lang="ar">--</div></div>
                                <div style="text-align:center;margin-top:6px;">
                                    <input id="invoice-search-input" type="text" inputmode="numeric" placeholder="???" class="w-full p-1 border rounded-md text-center text-sm" />
                                </div>
                                <div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">
                                    <button id="invoice-search-btn" class="bg-blue-600 text-white px-2 py-1 rounded-md text-sm">???</button>
                                    <button id="invoice-clear-btn" class="bg-gray-200 text-gray-700 px-2 py-1 rounded-md text-sm">???</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Lens handle (outside the sliding content so it remains visible) -->
                    <button id="invoice-quick-search-toggle" class="fixed left-0 bg-white border border-gray-300 rounded-full w-9 h-9 shadow flex items-center justify-center z-50" style="top:220px" title="???">
                        <i data-lucide="search" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>

                <!-- Hidden thermal print root -->
                <div id="thermal-print-root" style="display:none"></div>
                <div id="sales-list" class="space-y-3"></div>
            </div>
            <!-- ??? ????? ???? ??????? ??????? ??? ????? -->

            <!-- Inquiry / ??????? ?? ?????? ??????? (???? ????? + ????? ???????) -->
            <div id="page-inquiry" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="search" class="w-6 h-6 text-blue-600"></i>
                        <span>??????? ?? ?????? ???????</span>
                    </h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4 text-sm items-start">
                    <div>
                        <label class="block font-semibold mb-1">?? ?????</label>
                        <input id="inq-date-from" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">??? ?????</label>
                        <input id="inq-date-to" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">??? ?? ????</label>
                        <input id="inq-customer-filter" type="text" placeholder="???? ??? ?? ?????" class="w-full p-2 border rounded" />
                        <p class="text-[11px] text-gray-500 mt-1">?????? Ctrl ?? Shift ???????? ??????? ?? ???????.</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">??????? ?????????</label>
                        <select id="inq-customers" multiple size="8" class="w-full p-2 border rounded"></select>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button id="inq-generate-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2 text-sm"><i data-lucide="play"></i> ????? ?????????</button>
                    <button id="inq-print-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 flex items-center gap-2 text-sm"><i data-lucide="printer"></i> ?????</button>
                    <button id="inq-image-btn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2 text-sm"><i data-lucide="image"></i> ????</button>
                </div>
                <div id="inq-summary" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 text-sm"></div>
                <div id="inq-report-wrapper" class="bg-white rounded-lg shadow p-3 overflow-auto">
                    <table id="inq-report-table" class="w-full text-xs border-collapse" style="direction:rtl;min-width:820px;">
                        <thead id="inq-report-head"></thead>
                        <tbody id="inq-report-body"></tbody>
                    </table>
                    <div class="mt-6" id="inq-customers-breakdown"></div>
                </div>
            </div>

            <!-- Price Lists / ????? ???????: ???? ????? ???? ????? ????? ??? ???????? -->
            <div id="page-price-lists" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="badge-dollar-sign" class="w-6 h-6 text-amber-600"></i>
                        <span>????? ???????</span>
                    </h2>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-3">
                    <div class="pl-controls grid grid-cols-1 md:grid-cols-7 gap-3 mb-4 text-sm items-end">
                        <div>
                            <label class="label block mb-1">????? ????????</label>
                            <select id="pl-filter-mode" class="w-full p-2 border rounded">
                                <option value="customer">??? ??????</option>
                                <option value="priceList">??? ???????</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="label block mb-1">???? ??????/???????</label>
                            <select id="pl-selector" class="w-full p-2 border rounded"></select>
                        </div>
                        <div>
                            <label class="label block mb-1">??? % ???????</label>
                            <input id="pl-global-discount" type="number" min="0" max="100" step="0.01" value="0" class="w-full p-2 border rounded" />
                        </div>
                        <div class="flex items-end gap-2">
                            <button id="pl-print" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">?????</button>
                            <button id="pl-image" class="bg-indigo-600 text-white px-3 py-2 rounded text-sm">????</button>
                        </div>
                    </div>

                    <div class="sheet-header">
                        <div class="sheet-meta">
                            <span id="pl-date"></span>
                        </div>
                        <div class="sheet-title">????? ????? ???????</div>
                        <div class="sheet-meta">
                            <span id="pl-customer-name"></span>
                        </div>
                    </div>

                    <div id="pl-sheet-container" class="overflow-auto"></div>

                    <!-- ?????: ??? ???? ??????? (?? ??? ??????? ?????? ?????? ??? ??????) -->
                    <div id="all-price-lists-container" class="grid md:grid-cols-2 gap-4" style="display:none"></div>
                </div>
            </div>

            

            <script>
                // ===== Thermal HTML Fallback Print =====
                (function(){
                    const CSS_ID = 'thermal-print-style';
                    function ensurePrintCss(){
                        if (document.getElementById(CSS_ID)) return;
                        const style = document.createElement('style');
                        style.id = CSS_ID;
                        style.textContent = `@media print {
  body * { visibility: hidden !important; }
  #thermal-print-root, #thermal-print-root * { visibility: visible !important; }
  #thermal-print-root { position: absolute; left:0; top:0; width:80mm; padding:4px 2px; font-family: 'Cairo', Arial, sans-serif; font-size:12px; line-height:1.25; direction:rtl; }
  #thermal-print-root .row { display:flex; justify-content:space-between; }
  #thermal-print-root .center { text-align:center; }
  #thermal-print-root hr { border:0; border-top:1px dashed #000; margin:4px 0; }
}
@page { margin:2mm; size:80mm auto; }`;
                        document.head.appendChild(style);
                    }
                    
                    // ???? ?????: ????? ??????? ???????? ???????? ???????
                    // ???? ????? ??????? (?????? - ???? ????)
                    async function printAsImageForThermal(saleArg){                        try {
                            // ??? ?? ????? sale? ???????? ???? ?????? ???? ??????
                            let sale = saleArg;
                            if (!sale) {
                                sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                            }
                            if (!sale) throw new Error('?? ???? ?????? ???????');
                            
                            // ????? ???? ???? ???????? (????? ???? ?????)
                            const tempDiv = document.createElement('div');
                            tempDiv.style.cssText = 'position:fixed;left:-9999px;top:0;width:280px;background:white;padding:8px;font-family:Cairo,Arial;direction:rtl;';
                            
                            const customer = findCustomer(sale.customerId);
                            const dateStr = formatArabicDate(sale.date);
                            const custName = customer ? customer.name : '????';
                            
                            let itemsHtml = '';
                            (sale.items||[]).forEach(it => {
                                const p = findProduct(it.productId);
                                const name = (p ? p.name : (it.name || '????')).substring(0, 20);
                                const qty = it.quantity || it.qty || 0;
                                const price = Number(it.price||0);
                                const total = qty * price * (1 - (it.discountPercent||0)/100);
                                itemsHtml += `<div style="display:flex;justify-content:space-between;padding:1px 0;font-size:10px;"><span style="flex:1;">${name}</span><span style="width:30px;text-align:center;">${qty}</span><span style="width:60px;text-align:left;">${formatCurrency(total)}</span></div>`;
                            });
                            
                            tempDiv.innerHTML = `<div style="text-align:center;border:2px solid #000;padding:6px;background:white;">
                                <div style="font-size:16px;font-weight:800;margin-bottom:2px;">Delente</div>
                                <div style="font-size:12px;font-weight:700;margin-bottom:6px;">?????? ??????</div>
                                <div style="border-top:1px dashed #000;margin:4px 0;"></div>
                                <div style="font-size:10px;text-align:right;line-height:1.4;">
                                    <div style="display:flex;justify-content:space-between;"><span style="font-weight:600;">${sale.invoiceNumber || sale.id}</span><span>: ???</span></div>
                                    <div style="display:flex;justify-content:space-between;"><span>${dateStr}</span><span>: ???????</span></div>
                                    <div style="display:flex;justify-content:space-between;"><span>${custName.substring(0,20)}</span><span>: ??????</span></div>
                                </div>
                                <div style="border-top:1px dashed #000;margin:4px 0;"></div>
                                ${itemsHtml}
                                <div style="border-top:2px solid #000;margin:6px 0;"></div>
                                <div style="font-size:13px;font-weight:800;display:flex;justify-content:space-between;">
                                    <span>${formatCurrency(sale.total||0)} ?.?</span><span>: ????????</span>
                                </div>
                                <div style="font-size:10px;display:flex;justify-content:space-between;margin:2px 0;">
                                    <span>${formatCurrency((((sale.paidAmount !== undefined && sale.paidAmount !== null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0))} ?.?</span><span>: ???????</span>
                                </div>
                                <div style="font-size:10px;display:flex;justify-content:space-between;">
                                    <span>${formatCurrency(((sale.total||0) - (((sale.paidAmount !== undefined && sale.paidAmount !== null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0)))} ?.?</span><span>: ???????</span>
                                </div>
                                <div style="border-top:1px dashed #000;margin:6px 0;"></div>
                                <div style="font-size:9px;text-align:center;">????? ???????? ????</div>
                            </div>`;
                            
                            document.body.appendChild(tempDiv);
                            
                            // ????? ????? (???? ?????? html2canvas ?? ?? ????)
                            if (typeof html2canvas === 'undefined') {
                                document.body.removeChild(tempDiv);
                                throw new Error('????? html2canvas ??? ?????');
                            }
                            
                            const canvas = await html2canvas(tempDiv, {
                                backgroundColor: '#ffffff',
                                scale: 2,
                                logging: false,
                                width: 280
                            });
                            
                            document.body.removeChild(tempDiv);
                            
                            // ??? ????? ?????
                            const w = window.open('', '', 'width=300,height=500');
                            if (!w) throw new Error('???? ?????? ???????? ????????');
                            
                            w.document.open();
                            w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>?????</title><style>@page{size:80mm auto;margin:0;}body{margin:0;padding:0;}img{width:100%;display:block;}</style></head><body><img src="${canvas.toDataURL('image/png')}"/></body></html>`);
                            w.document.close();
                            
                            setTimeout(() => { try{w.focus();w.print();}catch(_){} }, 300);
                            if('onafterprint' in w) w.onafterprint = () => { try{w.close();}catch(_){} };
                            
                        } catch(e) { 
                            console.error('Print failed:', e);
                            alert('??? ???????: '+ (e.message || e)); 
                        }
                    }
                    
                    async function printHtmlReceiptLatest(){
                        try {
                            const sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                            if (!sale) throw new Error('?? ???? ?????? ???????');
                            const html = (typeof buildReceiptHtml58mm === 'function') ? buildReceiptHtml58mm(sale) : '';
                            const w = window.open('', '', 'width=500,height=700');
                            if (!w) { alert('???? ?????? ???????? ???????? ???????'); return; }
                            w.document.open();
                            w.document.write(html);
                            w.document.close();
                            const doPrint = ()=>{ try{ w.focus(); }catch(_){} try{ w.print(); }catch(_){} };
                            if ('onload' in w) { w.onload = ()=> setTimeout(doPrint, 100); } else { setTimeout(doPrint, 300); }
                            if ('onafterprint' in w) { w.onafterprint = ()=>{ try{ w.close(); }catch(_){} }; }
                        } catch(e){ alert('??? ??????? ???????: '+ e.message); }
                    }
                    
                    window.printAsImageForThermal = printAsImageForThermal;
                    window.printHtmlReceiptLatest = printHtmlReceiptLatest;
                })();

                // Smart mobile printing: chooses best method for Arabic text
                (function(){
                    window.smartMobilePrintInvoice = async function(sale){
                        try {
                            const isAndroid = /Android/i.test(navigator.userAgent || '');
                            const hasArabic = /[\u0600-\u06FF]/.test(JSON.stringify(sale||{}));

                            // Prefer RawBT on Android if available (handles Arabic via app fonts)
                            if (isAndroid && typeof window.printViaRawBT === 'function') {
                                try { window.printViaRawBT(sale); return; } catch(_){}
                            }

                            // Prefer image printing when Arabic is present
                            if (hasArabic && typeof window.printAsImageForThermal === 'function') {
                                try { await window.printAsImageForThermal(sale); return; } catch(_){}
                            }

                            // Fallbacks: HTML print, then ASCII Bluetooth
                            if (typeof window.printHtmlReceiptLatest === 'function') {
                                try { window.printHtmlReceiptLatest(); return; } catch(_){}
                            }
                            if (typeof window.printInvoiceViaBluetooth === 'function') {
                                try { await window.printInvoiceViaBluetooth(sale); return; } catch(_){}
                            }
                            if (typeof window.printInvoiceBluetooth === 'function') {
                                try { await window.printInvoiceBluetooth(sale); return; } catch(_){}
                            }

                            alert('?? ???? ????? ????? ????? ??????');
                        } catch(e){ console.warn('smartMobilePrintInvoice failed', e); }
                    };
                })();

                // ===== Thermal Receipt Builder (simplified ESC/POS) =====
                // NOTE: This encodes a very basic Arabic receipt; adjust per printer specs.
                function buildEscPosReceipt(sale){
                    const enc = new TextEncoder();
                    const lines = [];
                    const center = (t)=>"\x1B\x61\x01"+t+"\n"; // ESC a 1 (center)
                    const left = (t)=>"\x1B\x61\x00"+t+"\n";  // ESC a 0 (left)
                    lines.push(center("*** ?????? ??? ***"));
                    if (sale && sale.invoiceNumber) lines.push(center("???: "+sale.invoiceNumber));
                    if (sale && sale.date) lines.push(left("???????: "+(sale.date.split('T')[0])));
                    if (sale && sale.customerName) lines.push(left("??????: "+sale.customerName));
                    lines.push(left("------------------------------"));
                    if (sale && Array.isArray(sale.items)){
                        sale.items.forEach(it=>{
                            const name = (it.name||it.productName||it.productId||"???").slice(0,12);
                            const qty = it.qty || it.quantity || 0;
                            const price = it.price || it.unitPrice || 0;
                            const total = (qty*price).toFixed(2);
                            lines.push(left(name+" "+qty+"x"+price+"="+total));
                        });
                    }
                    lines.push(left("------------------------------"));
                    const totalAmt = sale ? (sale.total || sale.net || sale.amount || 0) : 0;
                    lines.push(center("????????: "+Number(totalAmt).toFixed(2)+" ?.?"));
                    lines.push(center("????? ???"));
                    // Feed & cut (if supported) \x1D V 0
                    lines.push("\n\n\x1D\x56\x00");
                    const all = lines.join("");
                    return enc.encode(all);
                }

                async function bluetoothPrintLatest(){
                    if (!('bluetooth' in navigator)){
                        alert('??????? ?? ???? Web Bluetooth (??? Chrome ?? Edge ??? ???????).');
                        return;
                    }
                    // ???? ??????
                    const sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                    const payload = buildEscPosReceipt(sale);
                    // UUIDs ?????? ??????? ?????? BLE ????? (?? ????? ?????)
                    const SERVICE_UUIDS = [0xFFE0,'0000ffe0-0000-1000-8000-00805f9b34fb','0000ff00-0000-1000-8000-00805f9b34fb'];
                    const CHAR_UUIDS = ['ffe1','0000ffe1-0000-1000-8000-00805f9b34fb','0000ff01-0000-1000-8000-00805f9b34fb'];
                    let device;
                    try {
                        // ?????? acceptAllDevices ?????? ??? ??? ?????? ?? ????? ??????? ??? ???????
                        device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices: SERVICE_UUIDS });
                    } catch(e){
                        alert('???? ?????? ???? ??????: '+ e.message);
                        return;
                    }
                    let gatt;
                    try { gatt = await device.gatt.connect(); } catch(e){ alert('??? ??????? ????????: '+e.message); return; }
                    let characteristic = null;
                    for (const su of SERVICE_UUIDS){
                        try {
                            const service = await gatt.getPrimaryService(su);
                            for (const cu of CHAR_UUIDS){
                                try {
                                    characteristic = await service.getCharacteristic(cu);
                                    if (characteristic) break;
                                } catch(_){ }
                            }
                            if (characteristic) break;
                        } catch(_){ }
                    }
                    if (!characteristic){
                        alert('?? ??? ?????? ??? ????? ??????? ??????? (??? ????? ????? UUID ?? ???? ?? ??????? BLE).');
                        try { gatt.disconnect(); } catch(_){ }
                        return;
                    }
                    try {
                        const CHUNK = 20;
                        for (let i=0;i<payload.length;i+=CHUNK){
                            const slice = payload.slice(i,i+CHUNK);
                            await characteristic.writeValue(slice);
                            await new Promise(r=>setTimeout(r,12));
                        }
                        alert('?? ????? ???????? ??????? (??????).');
                    } catch(e){
                        console.error('Bluetooth write failed', e);
                        alert('??? ????? ???????? ???????: '+ e.message);
                    } finally {
                        try { gatt.disconnect(); } catch(_){ }
                    }
                }

                document.addEventListener('DOMContentLoaded', ()=>{
                    const btBtn = document.getElementById('sales-bt-print-btn');
                    if (btBtn) btBtn.addEventListener('click', bluetoothPrintLatest);
                    
                    // ???? ?????? ??????? ???????? ??? ???????? (??? ????? ?? ????????)
                    const quickPrintBtn = document.getElementById('sales-quick-print-btn');
                    if (quickPrintBtn) quickPrintBtn.addEventListener('click', async () => {
                        const latestSale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                        if (!latestSale) {
                            alert('?? ???? ?????? ???????');
                            return;
                        }
                        // Prefer image-based printing to ensure Arabic text renders correctly on mobile
                        if (typeof window.printAsImageForThermal === 'function') {
                            try { await window.printAsImageForThermal(latestSale); } catch(e){ alert('???? ??????? ?????: '+(e&&e.message)); }
                        } else if (typeof window.printHtmlReceiptLatest === 'function') {
                            window.printHtmlReceiptLatest();
                        } else if (typeof printInvoiceViaBluetooth === 'function') {
                            await printInvoiceViaBluetooth(latestSale);
                        } else {
                            alert('???? ??????? ??? ??????');
                        }
                    });
                    
                    const htmlBtn = document.getElementById('sales-html-print-btn');
                    if (htmlBtn) htmlBtn.addEventListener('click', window.printHtmlReceiptLatest);
                    
                    // ?? ??????? ?????? ??????
                    const scrollBtn = document.getElementById('scroll-to-bottom-btn');
                    if (scrollBtn) {
                        scrollBtn.addEventListener('click', () => {
                            const salesList = document.getElementById('sales-list');
                            if (salesList) {
                                // ????? ??? ??????
                                window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
                            }
                        });
                    }
                });

                // ===== END Bluetooth Print Section =====

                // Invoice quick-search: slide-in/out from left wall with lens handle
                document.addEventListener('DOMContentLoaded', function(){
                    const wrap = document.getElementById('invoice-quick-search-wrap');
                    const content = document.getElementById('invoice-quick-search-content');
                    const toggle = document.getElementById('invoice-quick-search-toggle');
                    if (!wrap || !content || !toggle) return;
                    let open = false; // start hidden in the wall
                    function apply(){
                        // Hide completely: translate by full width
                        content.style.transform = open ? 'translateX(0%)' : 'translateX(-100%)';
                    }
                    toggle.addEventListener('click', function(){ open = !open; apply(); try { updateIcons(); } catch(_){} });
                    apply();
                    // Keep the handle visible above content
                    try { wrap.style.zIndex = '50'; } catch(_){}
                });

                // Invoice quick-search wiring (searches `state.sales` for invoice number)
                document.addEventListener('DOMContentLoaded', function(){
                    const input = document.getElementById('invoice-search-input');
                    const btn = document.getElementById('invoice-search-btn');
                    const clearBtn = document.getElementById('invoice-clear-btn');

                    function formatMoney(n){
                        try{ if (typeof formatCurrency === 'function') return formatCurrency(n); }catch(e){}
                        if (n == null) return '0';
                        return (Number(n) || 0).toLocaleString();
                    }

                    // Return a short date string (YYYY-MM-DD) for a variety of input shapes
                    function formatShortDate(val){
                        if (!val && val !== 0) return '';
                        try {
                            // If already an ISO-like string with time, take the date portion
                            if (typeof val === 'string'){
                                if (val.indexOf('T') !== -1) return val.split('T')[0];
                                if (/^\d{4}-\d{2}-\d{2}/.test(val)) return val.slice(0,10);
                                // common DD/MM/YYYY or D/M/YYYY -> parse accordingly
                                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
                                    const parts = val.split('/').map(p=>Number(p));
                                    // assume DD/MM/YYYY
                                    const d = new Date(parts[2], parts[1]-1, parts[0]);
                                    if (!isNaN(d)) return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                                }
                            }
                            // If already a Date
                            if (val instanceof Date) {
                                const d = val;
                                return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                            }
                            // Try constructing Date from value
                            const dd = new Date(val);
                            if (!isNaN(dd) && dd.getFullYear() > 1900) return dd.getFullYear() + '-' + String(dd.getMonth()+1).padStart(2,'0') + '-' + String(dd.getDate()).padStart(2,'0');
                        } catch(e) {}
                        // fallback to original string representation
                        return String(val);
                    }

                    function findInvoice(num){
                        if (!num) return null;
                        if (!window.state || !Array.isArray(state.sales)) return null;
                        // match invoiceNumber, nested invoice.number, id, number, ref, etc.
                        const s = state.sales.find(item => {
                            const candidates = [
                                item.invoiceNumber,
                                (item.invoice && item.invoice.number),
                                (item.invoice && item.invoice.id),
                                item.invoice,
                                item.id,
                                item.number,
                                item.ref,
                                item.invoice_no,
                                item.invoiceNumberString
                            ];
                            return candidates.some(c => c != null && String(c) === String(num));
                        });
                        return s || null;
                    }

                    function renderResult(sale){
                        const dateEl = document.getElementById('invoice-result-date');
                        const custEl = document.getElementById('invoice-result-customer');
                        const totalEl = document.getElementById('invoice-result-total');
                        const typeEl = document.getElementById('invoice-result-type');
                        const noData = document.getElementById('invoice-no-data');
                        // New compact panel fields
                        const vNumber = document.getElementById('invoice-val-number');
                        const vTotal = document.getElementById('invoice-val-total');
                        const vReturn = document.getElementById('invoice-val-return');
                        const vNet = document.getElementById('invoice-val-net');
                        const vCname = document.getElementById('invoice-val-cname');
                        const vDate = document.getElementById('invoice-val-date');

                        if(!sale){
                            if (dateEl) dateEl.textContent = '--';
                            if (custEl) custEl.textContent = '--';
                            if (totalEl) totalEl.textContent = '--';
                            if (typeEl) typeEl.textContent = '--';
                            if (vNumber) vNumber.textContent = '--';
                            if (vTotal) vTotal.textContent = '--';
                            if (vReturn) vReturn.textContent = '--';
                            if (vNet) vNet.textContent = '--';
                            if (vCname) vCname.textContent = '--';
                            if (vDate) vDate.textContent = '--';
                            return;
                        }
                            var cname = '--';
                            try {
                                // Direct string-ish fields (many possible names)
                                cname = sale.customerName || sale.clientName || sale.cname || sale.customer_name || sale.customer_fullname || sale.customerNameAr || sale.customer_name_ar || sale.partyName || sale.contactName || sale.contact_name || sale.buyerName || sale.customerDisplay || sale.customer || sale.client || sale.client_name || sale.clientName || cname;

                                // If sale.customer is an object, extract its name-like fields
                                if (cname && typeof cname === 'object') {
                                    var co = cname;
                                    cname = co.name || co.fullName || co.displayName || co.title || (co.company && co.company.name) || co.customerName || co.customer_name || co.label || co.customerDisplay || '--';
                                }

                                // Check nested well-known objects
                                if ((cname === '--' || cname == null || typeof cname === 'number')) {
                                    if (sale.customerObj && typeof sale.customerObj === 'object') cname = sale.customerObj.name || sale.customerObj.fullName || sale.customerObj.displayName || cname;
                                    if ((cname === '--' || cname == null || typeof cname === 'number') && sale.client && typeof sale.client === 'object') cname = sale.client.name || sale.client.displayName || cname;
                                    if ((cname === '--' || cname == null || typeof cname === 'number') && sale.account && typeof sale.account === 'object') cname = sale.account.name || sale.account.title || cname;
                                }

                                // If sale contains phone/tax fields, try to find matching customer by those
                                if ((cname === '--' || cname == null || typeof cname === 'number') && window.state && Array.isArray(window.state.customers)) {
                                    var possibleIds = [sale.customerId, sale.customer_id, sale.clientId, sale.client_id, sale.customer_ref, sale.customerRef, sale.accountId, sale.account_id, sale.partyId, sale.party_id, sale.customerCode, sale.clientCode, sale.ref, sale.customerMobile, sale.customerPhone, sale.mobile, sale.phone, sale.taxNumber, sale.tax_number];
                                    // flatten and remove nulls
                                    possibleIds = possibleIds.filter(x=> x != null && x !== '');
                                    var found = null;
                                    if (possibleIds.length > 0) {
                                        found = window.state.customers.find(function(c){
                                            var keys = [c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode, c.mobile, c.phone, c.taxNumber, c.tax_number, c.phoneNumber, c.msisdn];
                                            return possibleIds.some(function(pid){
                                                return keys.some(function(k){ return k != null && String(k) === String(pid); });
                                            });
                                        });
                                    }
                                    // If none by ids, try fuzzy match by mobile/tax if sale has those
                                    if (!found && sale.customerPhone) {
                                        found = window.state.customers.find(function(c){ return String(c.mobile) === String(sale.customerPhone) || String(c.phone) === String(sale.customerPhone); });
                                    }
                                    if (!found && sale.customerMobile) {
                                        found = window.state.customers.find(function(c){ return String(c.mobile) === String(sale.customerMobile) || String(c.phone) === String(sale.customerMobile); });
                                    }
                                    if (!found && sale.taxNumber) {
                                        found = window.state.customers.find(function(c){ return String(c.taxNumber) === String(sale.taxNumber) || String(c.tax_number) === String(sale.taxNumber); });
                                    }
                                    if (found) {
                                        cname = found.name || found.customerName || found.fullName || found.displayName || found.title || (found.company && found.company.name) || found.customer_name || cname;
                                    }
                                }

                                // If sale.customerId is present, attempt a direct lookup using helper or by id
                                try {
                                    if ((cname === '--' || cname == null || typeof cname === 'number' || cname === '??? ?????') && sale && (sale.customerId || sale.customer_id)) {
                                        var cidVal = sale.customerId || sale.customer_id;
                                        // try central helper first
                                        try {
                                            if (typeof findCustomer === 'function') {
                                                var f = findCustomer(cidVal);
                                                if (f && (f.name || f.customerName || f.displayName)) {
                                                    cname = f.name || f.customerName || f.fullName || f.displayName || cname;
                                                }
                                            }
                                        } catch(e) { /* ignore */ }
                                        // fallback: lookup in state.customers by id-like fields
                                        if ((cname === '--' || cname == null || cname === '??? ?????' || typeof cname === 'number') && window.state && Array.isArray(window.state.customers)) {
                                            var found2 = window.state.customers.find(function(c){
                                                return [c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode].some(function(k){ return k != null && String(k) === String(cidVal); });
                                            });
                                            if (found2) cname = found2.name || found2.customerName || found2.displayName || found2.fullName || cname;
                                        }
                                    }
                                } catch (e) { /* ignore */ }

                                // final fallback: if cname is still an object or null, stringify a safe field or use '??? ?????'
                                if (cname && typeof cname === 'object') {
                                    cname = cname.name || cname.displayName || JSON.stringify(cname).slice(0,60) || '??? ?????';
                                }
                                if (!cname || cname === '--') cname = '??? ?????';
                            } catch (e) { cname = '??? ?????'; }
                            vCname.textContent = (cname == null ? '??? ?????' : cname);
                        if (vDate) {
                            var rawDate = sale.date || sale.createdAt || sale.timestamp || '';
                            vDate.textContent = rawDate ? formatShortDate(rawDate) : '--';
                        }
                    }

                    if (btn) btn.addEventListener('click', function(){
                        const v = input ? input.value.trim() : '';
                        if (!v) { renderResult(null); return; }
                        const res = findInvoice(v);
                        renderResult(res);
                    });

                    if (input) input.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); btn && btn.click(); } });

                    if (clearBtn) clearBtn.addEventListener('click', function(){ if (input) input.value = ''; renderResult(null); });

                    // initialize with empty view
                    renderResult(null);

                    // Ensure there is at least one sample sale so the quick-search can be tested
                    try {
                        if (!window.state) window.state = {};
                        if (!Array.isArray(window.state.sales)) window.state.sales = [];
                        if (window.state.sales.length === 0) {
                            window.state.sales.push({
                                id: '148556',
                                invoiceNumber: '148556',
                                customerName: '????? ????',
                                total: 21252,
                                net: 21252,
                                isReturn: false,
                                date: '12/11/2025'
                            });
                        }
                    } catch (e) { console.warn('sample sale init failed', e); }
                    
                    // Wire the export button to show the sale object in a textarea for easy copy
                    try {
                        const exportBtn = document.getElementById('invoice-export-btn');
                        const exportModal = document.getElementById('invoice-export-modal');
                        const exportTextarea = document.getElementById('invoice-export-textarea');
                        const exportClose = document.getElementById('invoice-export-close-btn');
                        const exportCopy = document.getElementById('invoice-export-copy-btn');

                        function showSaleObjectForCurrentInput(){
                            try{
                                const user = AuthSystem.getCurrentUser(); if (!user) return 'guest';
                                if (!num) {
                                    exportTextarea.value = '?? ??? ????? ??? ????????.';
                                } else {
                        // ===== Cost Lists: Force Cloud Sync on Edit (Raw & Packaging) =====
                        (function(){
                            // Helper to bump timestamp and trigger cloud save
                            function bumpAndSave(){
                                try {
                                    if (window.isUpdatingFromCloud) return; // avoid echoing cloud updates
                                } catch(_){}
                                try {
                                    if (!window.costLists) window.costLists = {};
                                    window.costLists.timestamp = new Date().toISOString();
                                } catch(_){ }
                                try {
                                    if (typeof window.saveCostListsToFirebase === 'function') {
                                        // Prefer immediate save to avoid logout loss
                                        window.saveCostListsToFirebase(window.costLists);
                                    } else if (typeof window.saveCostListsDebounced === 'function') {
                                        window.saveCostListsDebounced();
                                    }
                                } catch(e){ console.warn('bumpAndSave failed', e); }
                            }

                            // Monkey-patch updateRawGridState to enforce cloud sync
                            try {
                                if (typeof window.updateRawGridState === 'function' && !window.__patched_updateRawGridState){
                                    const __orig = window.updateRawGridState;
                                    window.updateRawGridState = function(){
                                        try { __orig.apply(this, arguments); } catch(e){ console.warn('updateRawGridState orig failed', e); }
                                        // After local updates, force timestamp and cloud save
                                        bumpAndSave();
                                    };
                                    window.__patched_updateRawGridState = true;
                                }
                            } catch(e){ /* ignore */ }

                            // Monkey-patch updatePackagingGridState to enforce cloud sync
                            try {
                                if (typeof window.updatePackagingGridState === 'function' && !window.__patched_updatePackagingGridState){
                                    const __orig = window.updatePackagingGridState;
                                    window.updatePackagingGridState = function(){
                                        try { __orig.apply(this, arguments); } catch(e){ console.warn('updatePackagingGridState orig failed', e); }
                                        bumpAndSave();
                                    };
                                    window.__patched_updatePackagingGridState = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();

                        // ===== Cost Lists: Prefer Cloud on Fresh Sessions =====
                        (function(){
                            try {
                                if (typeof window.tryLoadCostListsFromCloud === 'function' && !window.__patched_tryLoadCostListsFromCloud){
                                    const __origLoadCloud = window.tryLoadCostListsFromCloud;
                                    window.tryLoadCostListsFromCloud = async function(){
                                        // Always attempt cloud fetch; if local missing or older, overlay cloud
                                        const localTs = (window.costLists && window.costLists.timestamp) || null;
                                        try {
                                            const res = await __origLoadCloud.apply(this, arguments);
                                            // If original loader refuses due to timestamp, enforce preference for cloud when session looks fresh
                                            const justLoggedIn = !!(window.auth && auth.currentUser); // heuristic: logged-in state
                                            const localEmpty = !window.costLists || (!Array.isArray(window.costLists.raw) && !Array.isArray(window.costLists.pack));
                                            if (localEmpty || !localTs || justLoggedIn) {
                                                // Startup alignment is disabled to prevent unintended seeding
                                                try {
                                                    if (!window.__DISABLE_AUTO_SEED_COST_LISTS && typeof window.ensureRawAndPackFromState === 'function') {
                                                        window.ensureRawAndPackFromState();
                                                    } else {
                                                        console.log('?? Skipped ensureRawAndPackFromState (auto-seed disabled)');
                                                    }
                                                } catch(_){ }
                                            }
                                            return res;
                                        } catch(e){
                                            console.warn('tryLoadCostListsFromCloud patched load failed; falling back to original behavior', e);
                                            return __origLoadCloud.apply(this, arguments);
                                        }
                                    };
                                    window.__patched_tryLoadCostListsFromCloud = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();

                        // ===== Finished Products: Enforce Local Persistence in renderFinishedProducts =====
                        (function(){
                            try {
                                if (typeof window.renderFinishedProducts === 'function' && !window.__patched_renderFinishedProducts){
                                    const __origRenderFinished = window.renderFinishedProducts;
                                    window.renderFinishedProducts = function(){
                                        // Always load latest local state at start
                                        try { window._finishedGridState = JSON.parse(localStorage.getItem('finished_products_grid')||'{}') || {}; } catch(e){ if (!window._finishedGridState) window._finishedGridState = {}; }
                                        const result = __origRenderFinished.apply(this, arguments);
                                        // Attach input handler for finished grid cells
                                        try {
                                            const container = document.getElementById('finished-products-grid') || document;
                                            container.removeEventListener && container.removeEventListener('__fp_input_dummy', function(){});
                                            container.addEventListener('input', function(e){
                                                const el = e.target;
                                                if (!el || !el.dataset) return;
                                                if (el.dataset.grid === 'finished' && el.dataset.id && el.dataset.field){
                                                    const productId = el.dataset.id;
                                                    const field = el.dataset.field;
                                                    const value = parseFloat(el.value) || 0;
                                                    if (!window._finishedGridState[productId]) window._finishedGridState[productId] = {};
                                                    window._finishedGridState[productId][field] = value;
                                                    try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){ }
                                                    try { if (typeof window.saveFinishedProductsDebounced === 'function') window.saveFinishedProductsDebounced(); } catch(_){ }
                                                }
                                            });
                                        } catch(e){ /* ignore wiring errors */ }
                                        return result;
                                    };
                                    window.__patched_renderFinishedProducts = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();

                        // ===== Price Sync: Force Immediate Cloud Save on unitPrice changes =====
                        (function(){
                            function forcePriceSave(itemName, value, listKey){
                                try {
                                    if (!window.costLists) window.costLists = {};
                                    const arr = (listKey === 'pack') ? (window.costLists.costPack || []) : (window.costLists.costRaw || []);
                                    const costItem = Array.isArray(arr) ? arr.find(i => i && i.name === itemName) : null;
                                    if (costItem){
                                        costItem.price = parseFloat(value) || 0;
                                        costItem.lastPriceDate = new Date().toISOString();
                                        window.costLists.timestamp = costItem.lastPriceDate;
                                        try {
                                            if (typeof window.forceFullCloudSync === 'function') window.forceFullCloudSync();
                                            else if (typeof window.saveCostListsToFirebase === 'function') window.saveCostListsToFirebase(window.costLists);
                                        } catch(_){ }
                                        try { console.log('?? Forced Price Save for:', itemName); } catch(_){ }
                                    }
                                } catch(e){ console.warn('forcePriceSave failed', e); }
                            }

                            // Patch renderRawMaterials to hook unitPrice changes
                            try {
                                if (typeof window.renderRawMaterials === 'function' && !window.__patched_renderRawMaterials){
                                    const __origRenderRaw = window.renderRawMaterials;
                                    window.renderRawMaterials = function(){
                                        const res = __origRenderRaw.apply(this, arguments);
                                        try {
                                            const container = document.getElementById('raw-materials-grid') || document;
                                            container.addEventListener('input', function(e){
                                                const el = e.target;
                                                if (!el || !el.dataset) return;
                                                if (el.dataset.grid === 'raw' && el.dataset.field === 'unitPrice' && el.dataset.name){
                                                    forcePriceSave(el.dataset.name, el.value, 'raw');
                                                }
                                            });
                                        } catch(_){}
                                        return res;
                                    };
                                    window.__patched_renderRawMaterials = true;
                                }
                            } catch(e){ /* ignore */ }

                            // Patch renderPackaging similarly
                            try {
                                if (typeof window.renderPackaging === 'function' && !window.__patched_renderPackaging){
                                    const __origRenderPack = window.renderPackaging;
                                    window.renderPackaging = function(){
                                        const res = __origRenderPack.apply(this, arguments);
                                        try {
                                            const container = document.getElementById('packaging-grid') || document;
                                            container.addEventListener('input', function(e){
                                                const el = e.target;
                                                if (!el || !el.dataset) return;
                                                if (el.dataset.grid === 'pack' && el.dataset.field === 'unitPrice' && el.dataset.name){
                                                    forcePriceSave(el.dataset.name, el.value, 'pack');
                                                }
                                            });
                                        } catch(_){}
                                        return res;
                                    };
                                    window.__patched_renderPackaging = true;
                                }
                            } catch(e){ /* ignore */ }
                        })();
                        // ===== Finished Products: Force Local Save + Debounced Cloud Sync =====
                        (function(){
                            try {
                                // ????? ???? ?????? ?????? ????? ?? ?? ??? ??????
                                if (typeof window.saveFinishedProductsDebounced !== 'function'){
                                    let __fpTimer = null; const DEBOUNCE_MS = 800;
                                    window.saveFinishedProductsDebounced = function(){
                                        try { if (__fpTimer) clearTimeout(__fpTimer); } catch(_){ }
                                        __fpTimer = setTimeout(async function(){
                                            try {
                                                if (window.db && typeof window.syncFinishedProductsToCloud === 'function') {
                                                    await window.syncFinishedProductsToCloud(window._finishedGridState || {});
                                                }
                                            } catch(e){ console.warn('saveFinishedProductsDebounced sync failed', e); }
                                        }, DEBOUNCE_MS);
                                    };
                                }

                                // ????? ??? ???? ??????? ?? ???? ???????? ??????
                                document.addEventListener('input', function(e){
                                    try {
                                        const el = e.target;
                                        if (!el || !el.dataset) return;
                                        // ????? ??? ???? data-grid="finished" ? data-id ? data-field ?? ????? ??????
                                        if (el.dataset.grid === 'finished' && el.dataset.id && el.dataset.field){
                                            const productId = el.dataset.id;
                                            const field = el.dataset.field;
                                            const val = parseFloat(el.value) || 0;

                                            if (!window._finishedGridState) window._finishedGridState = {};
                                            if (!window._finishedGridState[productId]) window._finishedGridState[productId] = {};
                                            window._finishedGridState[productId][field] = val;

                                            // ??? ???? ???? ????? ??????????? ??? ?? CLOUD_ONLY ?????
                                            try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){ }

                                            // ?????? ?????? ????? ?? ???????
                                            try { if (typeof window.saveFinishedProductsDebounced === 'function') window.saveFinishedProductsDebounced(); } catch(_){ }
                                        }
                                    } catch(err){ /* ignore */ }
                                });
                            } catch(e){ /* ignore top-level */ }
                        })();
                                    const sale = findInvoice(num) || null;
                                    exportTextarea.value = sale ? JSON.stringify(sale, null, 2) : '?? ??? ?????? ??? ?????? ????: ' + num;
                                }
                                exportModal.style.display = 'block';
                                exportTextarea.select();
                            }catch(e){ exportTextarea.value = '??? ????? ????? ??????:\n'+String(e); exportModal.style.display='block'; }
                        }

                        if (exportBtn) exportBtn.addEventListener('click', function(){ showSaleObjectForCurrentInput(); });
                        if (exportClose) exportClose.addEventListener('click', function(){ exportModal.style.display = 'none'; });
                        if (exportCopy) exportCopy.addEventListener('click', function(){ try{ exportTextarea.select(); document.execCommand('copy'); exportCopy.textContent = '?? ?????'; setTimeout(()=> exportCopy.textContent = '???', 1200); }catch(e){ alert('??? ?? ????? ???? ???? ??????.'); } });
                    } catch (e) { console.warn('invoice export wiring failed', e); }
                });
            </script>
            <script>
                // Anchor the invoice quick-search panel as a fixed element next to the totals card
                (function(){
                    // ?????? ?????? ?? ????? ?????? ????? ??????
                    if (typeof window.INVOICE_PANEL_OFFSET_TOP === 'undefined') {
                        window.INVOICE_PANEL_OFFSET_TOP = 48; // ?????? ?????? ???? ?????? ???????
                    }
                        function positionInvoicePanel(){
                            try{
                            // Resolve DOM nodes locally to avoid referencing undefined globals
                            const totalEl = document.getElementById('invoice-result-total');
                            const panel = document.getElementById('invoice-quick-search-panel') || document.getElementById('invoice-quick-search-global') || document.getElementById('invoice-quick-search-wrap');
                            // Safety: if required elements are missing, bail out to avoid ReferenceError
                            if (!totalEl || !panel) return;

                            // Try to get bounding rect if available
                            let rect = null;
                            try { rect = totalEl.getBoundingClientRect(); } catch(e){ rect = null; }

                            // set fixed positioning
                            panel.style.position = 'fixed';
                            panel.style.zIndex = '2147483646';
                            panel.style.maxHeight = 'calc(100vh - 120px)';

                            // vertical: try to sit under the header (if present) or align with totals card
                            try {
                                var headerEl = document.querySelector('header');
                                var headerBottom = headerEl ? headerEl.getBoundingClientRect().bottom : 56;
                                var topFromTotals = rect ? rect.top : (headerBottom + 8);
                                var topVal = Math.max((headerBottom + 8), topFromTotals + 0) + (window.INVOICE_PANEL_OFFSET_TOP||0);
                                panel.style.top = (Math.round(topVal) || 64) + 'px';
                            } catch(e) { panel.style.top = '64px'; }

                            // horizontal: keep panel at a fixed left offset to avoid covering invoice rows
                            try {
                                panel.style.left = '12px';
                                panel.style.right = 'auto';
                            } catch(e) {
                                try { panel.style.left = '12px'; } catch(_){}
                            }
                        }catch(e){ console.warn('positionInvoicePanel failed', e); }
                    }
                    window.addEventListener('load', function(){ setTimeout(positionInvoicePanel, 50); });
                    window.addEventListener('resize', function(){ setTimeout(positionInvoicePanel, 60); });
                    // keep panel fixed; still recalc occasionally when scrolling
                    window.addEventListener('scroll', function(){ setTimeout(positionInvoicePanel, 120); });
                    // expose helper
                    window.positionInvoicePanel = positionInvoicePanel;
                })();
            </script>
            
            <div id="page-dispatch" class="page">
                <!-- Local tabs inside dispatch page -->
                <div class="mb-4 flex gap-2 no-print" style="display:flex;gap:8px;margin-bottom:16px;">
                    <button id="dispatch-notes-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#3b82f6;color:white;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">????????</button>
                    <button id="receipt-local-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#d1d5db;color:#374151;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">??? ???????</button>
                </div>

                <!-- Tab content: ???????? -->
                <div id="dispatch-notes-tab-content" class="dispatch-local-tab-content" style="display:block;">
                <div id="new-dispatch-note-section" class="bg-gray-100 p-4 rounded-lg border mb-6">
                    <h3 class="text-lg font-bold mb-3">????? ??? ?????? ????</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="new-dispatch-note-number" class="block text-sm font-medium text-gray-700">??? ????? (????)</label>
                            <input type="number" id="new-dispatch-note-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="new-dispatch-rep" class="block text-sm font-medium text-gray-700">???????</label>
                            <select id="new-dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="new-dispatch-date" class="block text-sm font-medium text-gray-700">????? ?????</label>
                            <input type="date" id="new-dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>

                    <div class="overflow-x-auto bg-white rounded-lg shadow mt-4 border">
                        <table id="new-dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">??????</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">????? (????)</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">????? ????</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">????? ????</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">?????</th>
                                    <th class="px-2 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="new-dispatch-items-container" class="divide-y divide-gray-200">
                                <!-- New item rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                         <button type="button" id="add-new-dispatch-item-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            ????? ???
                        </button>
                        <button type="button" id="save-new-dispatch-note-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            ??? ????? ??????
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <hr class="my-6 border-t-2 border-dashed">

                <!-- Existing Dispatch Notes List -->
                <h3 class="text-lg font-bold mb-3">???????? ???????</h3>
                <div id="dispatch-notes-list" class="space-y-4"></div>
                <!-- ???? ????? ??????? (??? ???) -->
                <div id="rep-dispatch-summary" class="hidden mt-8 bg-white border rounded-lg p-4">
                    <h4 class="font-bold mb-3 flex items-center gap-2 text-indigo-700"><i data-lucide="clipboard-list" class="w-5 h-5"></i> ???? ??????? ???????</h4>
                    <div id="rep-dispatch-summary-content" class="text-sm"></div>
                </div>
                </div> <!-- end dispatch-notes-tab-content -->

                <!-- Tab content: ??? ??????? -->
                <div id="receipt-local-tab-content" class="dispatch-local-tab-content" style="display:none;">
                    <h2 class="text-xl font-bold mb-4">??? ???????</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Left: Receipt List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-4 rounded shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">?? ?????:</label>
                                        <input type="date" id="receipt-from-date-local" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">??? ?????:</label>
                                        <input type="date" id="receipt-to-date-local" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2"></label>
                                        <button id="receipt-filter-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">????? ???????</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto bg-white rounded-lg shadow">
                                    <table class="w-full border-collapse border border-gray-300">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="border p-2 text-right">???????</th>
                                                <th class="border p-2 text-right">??? ????????</th>
                                                <th class="border p-2 text-right">??????</th>
                                                <th class="border p-2 text-right">??? ???????</th>
                                                <th class="border p-2 text-right">??????</th>
                                                <th class="border p-2 text-right">??????</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receipt-table-body-local" class="text-sm"></tbody>
                                    </table>
                                </div>
                                <div class="mt-4 p-4 bg-gray-50 rounded border">
                                    <div class="grid grid-cols-3 gap-4 text-lg font-bold">
                                        <div>????????: <span id="receipt-total-local" class="text-green-600">0</span></div>
                                        <div>?????: <span id="receipt-count-local" class="text-blue-600">0</span></div>
                                        <div>???????: <span id="receipt-avg-local" class="text-purple-600">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Rep Receipt Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-4 rounded shadow-md sticky top-20">
                                <h3 class="text-lg font-bold mb-4 text-right">???????? ??????????</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">???? ???????:</label>
                                    <select id="receipt-rep-dropdown-local" class="w-full p-2 border rounded text-right">
                                        <option value="">-- ???? ??????? --</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">????????:</label>
                                    <input type="number" id="rep-credit-transactions-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">?????????:</label>
                                    <input type="number" id="rep-expenses-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">???????:</label>
                                    <textarea id="rep-notes-local" class="w-full p-2 border rounded text-right" rows="4" placeholder="??????? ??????..."></textarea>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button id="receipt-print-btn-local" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold">????? ??? ???????</button>
                                    <button id="receipt-save-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">??? ????????</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- end receipt-local-tab-content -->
            </div>
            
            <!-- RE-ACTIVATED REPORTS PAGE -->
            <div id="page-reports" class="page" style="padding-bottom: 50px;">
                <h2 class="text-xl font-bold mb-4 no-print">???????? ?????????</h2>
                
                <div id="report-filter-container" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                    <!-- Daily Report Content -->
                    <div data-report-content="daily" class="space-y-4 active">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">????? ???????? ??????</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="daily-report-date" class="block text-sm font-medium text-gray-700">???????:</label>
                                <input type="date" id="daily-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="daily-report-rep" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="daily-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="daily-report-chain" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="daily-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">???? ???????</option></select>
                            </div>
                        </div>
                        <button id="generate-daily-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">??? ??????? ??????</button>
                    </div>

                    <!-- Date Range Report Content (Hidden by default) -->
                    <div data-report-content="range" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">????? ?????? ???? ?????</h3>
                         <!-- Reuse date range form logic but simplified -->
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="range-start-date" class="block text-sm font-medium text-gray-700">?? ?????:</label>
                                <input type="date" id="range-start-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-end-date" class="block text-sm font-medium text-gray-700">??? ?????:</label>
                                <input type="date" id="range-end-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-report-chain" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="range-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">???? ???????</option></select>
                            </div>
                        </div>
                        <div>
                             <label for="range-report-rep" class="block text-sm font-medium text-gray-700">???????:</label>
                             <select id="range-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <button id="generate-range-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">??? ????? ??????</button>
                    </div>

                    <!-- Monthly Report Content (Hidden by default) -->
                    <div data-report-content="monthly" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">???? ???????? ??????</h3>
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="monthly-report-month" class="block text-sm font-medium text-gray-700">?????:</label>
                                <input type="month" id="monthly-report-month" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="monthly-report-rep" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="monthly-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="monthly-report-chain" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="monthly-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">???? ???????</option></select>
                            </div>
                        </div>
                        <button id="generate-monthly-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">??? ??????? ??????</button>
                    </div>

                    <!-- Reconciliation Report Content (Hidden by default) -->
                    <div data-report-content="reconciliation" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">????? ??????? (????? ????????)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="recon-report-date" class="block text-sm font-medium text-gray-700">????? ??? ????????:</label>
                                <input type="date" id="recon-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="recon-report-rep" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="recon-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="recon-report-chain" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="recon-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">???? ???????</option></select>
                            </div>
                        </div>
                        <button id="generate-recon-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">????? ????? ???????</button>
                    </div>

                    <div data-report-content="targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">????? ????? ??????? ?????? ??? ?????</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="targets-month" class="block text-sm font-medium text-gray-700">?????:</label>
                                <input type="month" id="targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="targets-rep-filter" class="block text-sm font-medium text-gray-700">??? ????? (???????):</label>
                                <select id="targets-rep-filter" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="all">??? ?? ????????</option>
                                </select>
                            </div>
                            <div>
                                <label for="targets-chain-filter" class="block text-sm font-medium text-gray-700">???????:</label>
                                <select id="targets-chain-filter" class="mt-1 block w-full p-2 border rounded-md"><option value="">???? ???????</option></select>
                            </div>
                        </div>
                        <button id="generate-targets-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">??? ????? ???????</button>
                        <p class="text-xs text-gray-600">???? ?????? ???? ???????? ??????? ??? ?????? ??????? ????? ???????? ?? ?????? ???????? ??? ????? ????? ??????? ??????? ???????.</p>
                    </div>

                    <div data-report-content="customer-targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">????? ??????? (?????? / ???? / ?????)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="customer-targets-month" class="block text-sm font-medium text-gray-700">?????:</label>
                                <input type="month" id="customer-targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="customer-targets-category" class="block text-sm font-medium text-gray-700">?????:</label>
                                <select id="customer-targets-category" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="multi">?????</option>
                                    <option value="dairy">?????</option>
                                    <option value="both" selected>??????? ????</option>
                                </select>
                            </div>
                        </div>
                        <button id="generate-customer-targets-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold mb-4">??? ????? ???????</button>
                        <div class="flex gap-3">
                            <button id="save-customer-targets-btn" type="button" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">??? ???????</button>
                            <button id="refresh-customer-targets-btn" type="button" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">????? ???????</button>
                        </div>
                        <p class="text-xs text-gray-600">??? ??? ??????? ?? ??????? ?? ???? ???. ??????? ???? ?????? ???????? ????? ??????? ??? ???? ??? ????? ????????.</p>
                        <div id="customer-targets-report-output" class="mt-2"></div>
                    </div>

                </div>

                <div id="report-output-area" class="mt-6">
                    <p class="text-center text-gray-500 mt-8">???? ??? ??????? ????? "???" ?????.</p>
                </div>
            </div>
            <!-- END RE-ACTIVATED REPORTS PAGE -->


            <!-- ########## PROMOTIONS PAGE ########## -->
            <div id="page-promotions" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">?????? ?????????</h2>
                    <div class="flex items-center gap-2">
                        <!-- Notify dropdown (?????) -->
                        <div class="relative" id="promotions-notify-root">
                            <button id="promotions-notify-btn" class="bg-white border px-3 py-1 rounded-md text-sm flex items-center gap-2" aria-haspopup="true" aria-expanded="false">
                                <span class="text-sm font-semibold">?????</span>
                                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
                            </button>
                            <div id="promotions-notify-menu" class="hidden absolute right-0 mt-2 w-52 bg-white border rounded shadow-lg z-50">
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="prices">????? ?????? ?????</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="new-item">????? ???? ????</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="promotions">????? ?????</button>
                            </div>
                        </div>

                        <button id="add-promotion-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 flex items-center gap-2">
                            <i data-lucide="percent"></i>
                            <span>????? ??? ????</span>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <button id="promotions-view-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm">??????</button>
                    <button id="notifications-view-btn" class="px-3 py-1 bg-white text-gray-700 rounded-md text-sm border">?????????</button>
                </div>

                <!-- Batch Promotions Editor (Create many rows exactly like screenshot) -->
                <div class="bg-white border rounded-md p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <label class="text-sm">??????</label>
                            <select id="batch-promo-customer" class="p-2 border rounded-md min-w-[220px]"></select>
                            <label class="text-sm">??</label>
                            <input id="batch-promo-from" type="date" class="p-2 border rounded-md">
                            <label class="text-sm">???</label>
                            <input id="batch-promo-to" type="date" class="p-2 border rounded-md">
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="batch-promo-add-row" class="px-3 py-1 bg-amber-600 text-white rounded-md text-sm">????? ??</button>
                            <button id="batch-promo-save" class="px-3 py-1 bg-green-600 text-white rounded-md text-sm">??? ??????</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full" id="batch-promo-table" style="border-collapse:separate;border-spacing:0 6px;">
                            <thead>
                                <tr>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Price</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">To</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">From</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Item Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Code</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Customer Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">???</th>
                                </tr>
                            </thead>
                            <tbody id="batch-promo-rows"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">???? ??? ????? ??????? ???? ????? ????? ???????? ??? ?????? ??????? ?? ???? ????? ??????? ??? ????????.</p>
                </div>

                <div id="promotions-list" class="space-y-3">
                    <p class="text-gray-500 text-center mt-8">?? ???? ???? ????? ??????.</p>
                </div>

                <div id="notifications-list" class="space-y-3 hidden">
                    <p class="text-gray-500 text-center mt-8">?? ???? ??????? ???. ?????? ?? "?????" ?????? ????.</p>
                </div>
            </div>
            <!-- ########## END PROMOTIONS PAGE ########## -->


            <div id="page-customers" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">????? ???????</h2>
                    <div class="flex items-center gap-2">
                        <button id="add-chain-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg shadow hover:bg-gray-300 flex items-center gap-2 text-sm">
                            <i data-lucide="layers"></i>
                            <span>????? ?????</span>
                        </button>
                        <button id="add-customer-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                            <i data-lucide="user-plus"></i>
                            <span>????? ????</span>
                        </button>
                    </div>
                </div>
                <div id="chains-display" class="mb-4"></div>
                <input id="search-customers" type="text" placeholder="???? ?? ????..." class="w-full p-2 border rounded-md mb-4">
                <div id="customers-list" class="space-y-3"></div>
            </div>

            <div id="page-reps" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">????? ????????</h2>
                    <button id="add-rep-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="user-plus"></i>
                        <span>????? ?????</span>
                    </button>
                </div>
                <div id="reps-list" class="space-y-3"></div>
            </div>

            <!-- ########## SPREADSHEET ENTRY PAGE (????? ????) ########## -->
            <div id="page-spreadsheet-entry" class="page">
                <h2 class="text-lg font-bold mb-4">????? ???? ??????? ?????</h2>
                <div class="bg-gray-100 p-3 rounded-lg border mb-4">
                    <!-- Modified grid layout to accommodate the new field -->
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <div>
                            <label for="spreadsheet-rep" class="block text-sm font-medium text-gray-700">???????</label>
                            <select id="spreadsheet-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-customer" class="block text-sm font-medium text-gray-700">??????</label>
                            <select id="spreadsheet-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-date" class="block text-sm font-medium text-gray-700">????? ????????</label>
                            <input type="date" id="spreadsheet-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <!-- NEW: Unified Invoice Number Field -->
                        <div>
                            <label for="unified-invoice-number" class="block text-sm font-medium text-gray-700">??? ???????? (????)</label>
                            <input type="number" id="unified-invoice-number" class="mt-1 block w-full p-2 border border-blue-400 bg-blue-50 rounded-md font-bold" placeholder="????? ??? ?? ??????">
                        </div>
                        <!-- END NEW -->
                    </div>
                </div>

                <div class="overflow-x-auto shadow rounded-lg border">
                    <table id="spreadsheet-entry-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">??? ????????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">?????</th> <!-- NEW CODE COLUMN -->
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 uppercase min-w-[150px]">?????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">??????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">?????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">??? ????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">??? %</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">?????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[100px]">???????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px] spreadsheet-tax-header" style="display: none;">????????</th> <!-- NEW TAX FILING COLUMN -->
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[80px]">????????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase"></th> <!-- Delete button -->
                            </tr>
                        </thead>
                        <tbody id="spreadsheet-entry-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be added by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-between items-center flex-wrap gap-3">
                    <button id="spreadsheet-add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-1 text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>????? ?? ????</span>
                    </button>
                    <button id="spreadsheet-save-all-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold flex items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span>??? ?? ????????</span>
                    </button>
                </div>

            </div>
             <!-- ########## END SPREADSHEET ENTRY PAGE ########## -->
            
            <!-- ########## DEBTS PAGE (??????????) ########## -->
            <div id="page-debts" class="page" style="display: none;">
                <!-- Tabs for Debts and Collection Receipt -->
                <div class="mb-4 flex gap-2 no-print" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button id="debts-tab-btn" class="debts-tab-button active" style="padding: 8px 16px; background-color: #3b82f6; color: white; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; border: none;">??????????</button>
                    <button id="receipt-debts-tab-btn" class="debts-tab-button" style="padding: 8px 16px; background-color: #d1d5db; color: #374151; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; border: none;">??? ???????</button>
                </div>

                <!-- Debts Tab Content -->
                <div id="debts-tab-content" class="debts-tab-content active">
                <div class="mb-4 flex flex-col items-end">
                    <h1 class="text-2xl font-bold text-right flex items-center gap-2">
                        <i data-lucide="file-warning" class="w-7 h-7 text-amber-600"></i>
                        <span>???????? ????????</span>
                    </h1>
                    <p class="text-sm text-gray-600 text-right flex items-center gap-1">
                        <span>??? ?????? ??????????</span>
                    </p>
                </div>

                <!-- debug banner removed -->

                <div class="debts-container mb-6">
                    <!-- Left sidebar: actions + stacked summary cards -->
                    <aside class="debts-sidebar">
                        <div class="debts-actions">
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-print-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">?????</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-csv-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">????? CSV</span>
                            </button>
                            <!-- Quick navigation: show reps/customers directly from debts page -->
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-reps-btn" title="??? ???? ????????">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11c1.657 0 3-1.343 3-3S17.657 5 16 5s-3 1.343-3 3 1.343 3 3 3zM8 11c1.657 0 3-1.343 3-3S9.657 5 8 5 5 6.343 5 8s1.343 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zM16 13c-.29 0-.62.02-.97.05C15.7 13.35 17 14.5 17 16v3h5v-2.5C22 14.17 17.33 13 16 13z"/></svg>
                                <span class="ml-1">??? ????????</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-customers-btn" title="??? ???? ???????">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.62 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0zM19.938 7.124A4 4 0 1116 3a4 4 0 013.938 4.124z"/></svg>
                                <span class="ml-1">??? ???????</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-refresh-btn" title="????? ??????????">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M20 4v6h-6M4 20v-6h6"/></svg>
                                <span class="ml-1">?????</span>
                            </button>
                        </div>

                        <!-- Debug banner removed as per user request -->

                        <div class="debt-card">
                            <div class="title">SUB TOTAL</div>
                            <div id="debts-subtotal" class="value">91,295 ?.?</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">??????</div>
                            <div id="debts-paid" class="value">76,336 ?.?</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">??? ????????</div>
                            <div id="debts-invoices-count" class="value">14,959</div>
                        </div>

                        <div class="debt-card big">
                            <div class="title">??????????</div>
                            <div id="debts-total-debt" class="value">2,025 ?.?</div>
                        </div>
                    </aside>

                    <!-- Right main area: filters + table -->
                    <section class="debts-main">
                        <!-- Search Filters -->
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block mb-1 text-sm">??? ???? ??????</label>
                                <!-- Show only customers who have invoices (either paid or due) -->
                                <select id="debt-customer-filter" class="w-full p-2 border rounded-md text-sm filter-input">
                                    <option value="">???? ???????</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">??? ???? ???????</label>
                                <select id="debt-rep-filter" class="w-full p-2 border rounded-md text-sm bg-white filter-input">
                                    <option value="">???? ????????</option>
                                    <option value="5/11/25">5/11/25</option>
                                    <option value="7/11/25">7/11/25</option>
                                    <option value="">????? ??? ???????</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">?? ?????</label>
                                <input type="date" id="debt-start-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">??? ?????</label>
                                <input type="date" id="debt-end-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                        </div>

                        <div class="mb-4 flex items-center gap-4">
                            <button id="apply-debts-filters-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">????? ???????</button>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hide-paid-debts" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="text-sm font-semibold text-gray-700">??? ??? ?????? ???</span>
                            </label>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto bg-white rounded-lg shadow-sm" style="background: #fafafa !important;">
                            <table class="min-w-full" id="debts-detail-table" style="border-collapse: collapse !important;">
                                <thead>
                                            <tr>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:right">
                                                    <span>??? ??????</span>
                                                    <button class="column-filter-btn" data-col="customer" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>???????</span>
                                                    <button class="column-filter-btn" data-col="date" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>??? ????????</span>
                                                    <button class="column-filter-btn" data-col="invoice" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>?????? ????????</span>
                                                    <button class="column-filter-btn" data-col="total" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>??????</span>
                                                    <button class="column-filter-btn" data-col="paid" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>???????</span>
                                                    <button class="column-filter-btn" data-col="remaining" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>???????</span>
                                                    <button class="column-filter-btn" data-col="rep" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button>
                                                </th>
                                            </tr>
                                </thead>
                                <tbody id="debts-detail-body" class="divide-y divide-gray-200">
                                    <!-- ???? ????? ?????? ?????????? -->
                                </tbody>
                            </table>
                            <div id="debts-empty-message" class="text-center text-gray-500 p-6 hidden">
                                ?? ???? ?????? ?????? ???????
                            </div>
                        </div>
                    </section>
                </div>
                </div> <!-- End of debts-tab-content -->

                <!-- Collection Receipt Tab Content -->
                <div id="receipt-debts-tab-content" class="debts-tab-content" style="display:none;">
                    <h2 class="text-xl font-bold mb-4">??? ???????</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Left: Receipt List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-4 rounded shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">?? ?????:</label>
                                        <input type="date" id="receipt-from-date" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">??? ?????:</label>
                                        <input type="date" id="receipt-to-date" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2"></label>
                                        <button id="receipt-filter-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">????? ???????</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto bg-white rounded-lg shadow">
                                    <table class="w-full border-collapse border border-gray-300">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="border p-2 text-right">???????</th>
                                                <th class="border p-2 text-right">??? ????????</th>
                                                <th class="border p-2 text-right">??????</th>
                                                <th class="border p-2 text-right">??? ???????</th>
                                                <th class="border p-2 text-right">??????</th>
                                                <th class="border p-2 text-right">??????</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receipt-table-body" class="text-sm">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 p-4 bg-gray-50 rounded border">
                                    <div class="grid grid-cols-3 gap-4 text-lg font-bold">
                                        <div>????????: <span id="receipt-total" class="text-green-600">0</span></div>
                                        <div>?????: <span id="receipt-count" class="text-blue-600">0</span></div>
                                        <div>???????: <span id="receipt-avg" class="text-purple-600">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Rep Receipt Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-4 rounded shadow-md sticky top-20">
                                <h3 class="text-lg font-bold mb-4 text-right">???????? ??????????</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">???? ???????:</label>
                                    <select id="receipt-rep-dropdown" class="w-full p-2 border rounded text-right">
                                        <option value="">-- ???? ??????? --</option>
                                    </select>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">????????:</label>
                                    <input type="number" id="rep-credit-transactions" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">?????????:</label>
                                    <input type="number" id="rep-expenses" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2 text-right">???????:</label>
                                    <textarea id="rep-notes" class="w-full p-2 border rounded text-right" rows="4" placeholder="??????? ??????..."></textarea>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <button id="receipt-print-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold">????? ??? ???????</button>
                                    <button id="receipt-save-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">??? ????????</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End of receipt-debts-tab-content -->
            </div>
            <!-- ########## END DEBTS PAGE ########## -->
            
            <!-- ########## CASH PAGE (?????) ########## -->
            <div id="page-cash" class="page" style="display:none;">
                <div id="cash-content-wrapper">
                        <h2 class="text-xl font-bold mb-4">????? - ??? ???????</h2>

                        <div class="mb-4 flex gap-2 items-center no-print">
                            <div class="ml-auto text-sm text-gray-600">???? ?? ?? ?????? ??????? ???? ?? ?? ???????? ???????</div>
                        </div>

                        <!-- Main grid: table (left) + summary (right) -->
                        <div class="cash-grid flex gap-4 items-start">
                            <div class="cash-table-area flex-1 overflow-x-auto bg-white rounded-lg shadow">
                                <table id="cash-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 text-center">#</th>
                                            <th class="p-2 text-center">??????? <button class="cash-column-filter-btn" data-col="date" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button></th>
                                            <th class="p-2 text-center">??? ???????? <button class="cash-column-filter-btn" data-col="invoice" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button></th>
                                            <th class="p-2 text-right">??? ?????? <button class="cash-column-filter-btn" data-col="customer" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button></th>
                                            <th class="p-2 text-right">??????? <button class="cash-column-filter-btn" data-col="rep" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button></th>
                                            <th class="p-2 text-center">?????? ???????? <button class="cash-column-filter-btn" data-col="total" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button></th>
                                            <th class="p-2 text-center">???</th>
                                            <th class="p-2 text-center">?????? ??????</th>
                                            <th class="p-2 text-center">?????? ???????</th>
                                            <th class="p-2 text-center">?????? ?????? ??? ?????</th>
                                            <th class="p-2 text-center">??????? <button class="cash-column-filter-btn" data-col="remaining" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button></th>
                                            <th class="p-2 text-center">??? ??????? <button class="cash-column-filter-btn" data-col="collection" aria-label="????" title="????" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">?</button></th>
                                            <th class="p-2 text-center">??? ??? ???????</th>
                                            <th class="p-2 text-center">???????</th>
                                            <th class="p-2 text-center">???????</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cash-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows created by renderCash() -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Cash summary panel (totals) - right column -->
                            <aside id="cash-summary-panel" class="w-60 p-2 bg-gray-50 rounded-lg shadow-sm text-right">
                                    <table style="width:100%;border-collapse:collapse;font-size:14px;">
                                        <tbody>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">?????? ????????</td>
                                                                <td id="cash-summary-total" style="padding:6px;font-weight:700;text-align:left">0 ?.?</td>
                                                            </tr>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">??? ????????</td>
                                                                <td id="cash-summary-count" style="padding:6px;font-weight:600;text-align:left">0</td>
                                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">??????? ???????</td>
                                                <td id="cash-summary-paid" style="padding:6px;font-weight:600;color:#047857;text-align:left">0 ?.?</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">??? ???</td>
                                                <td id="cash-summary-discount" style="padding:6px;font-weight:600;color:#b91c1c;text-align:left">0 ?.?</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">???????</td>
                                                <td id="cash-summary-remaining" style="padding:6px;font-weight:700;text-align:left">0 ?.?</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="pt-2 no-print">
                                        <button id="cash-print-btn" class="w-full bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600">????? ??????</button>
                                        <button id="cash-include-all-btn" class="w-full mt-2 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">??? ?? ???????? ?? ?????</button>
                                    </div>
                                </aside>
                        </div>
                    </div>
            </div>

            <!-- ########## END CASH PAGE ########## -->
            <script>
                (function(){
                    function injectCashStyles(){
                        if(document.getElementById('cash-page-styles')) return;
                        const css = `
                            /* Row states */
                            .cash-row-due { background: rgba(254, 226, 226, 0.6); }
                            .cash-row-paid { background: rgba(220, 253, 231, 0.9); }
                            .cash-row-collected { background: rgba(219, 234, 254, 0.95); }
                            .cash-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; display:inline-block; }
                            .cash-action-btn { display:inline-block; padding:4px 6px; border-radius:6px; border:none; cursor:pointer; margin:2px 6px; color:#fff; font-size:13px; }
                            .cash-action-create { background:#2563eb; }
                            .cash-action-safe { background:#059669; }

                            /* Tab styling */
                            .cash-tab-button { transition: all 0.3s ease; }
                            .cash-tab-button.active { background-color: #3b82f6; color: white; }
                            .cash-tab-content { display:none; }
                            .cash-tab-content.active { display:block; }

                            /* Layout: table left, summary right */
                            .cash-grid { display:flex; gap:16px; align-items:flex-start; }
                            .cash-table-area { flex:1 1 auto; max-width: calc(100% - 300px); }
                            #cash-summary-panel { width: 220px; min-width: 160px; max-width: 260px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
                            #cash-summary-panel .text-2xl { line-height:1.1; }

                            /* Make table scroll horizontally but keep summary visible */
                            .cash-table-area table { width:100%; border-collapse:collapse; }

                            /* Responsive: stack on small screens */
                            @media (max-width: 900px) {
                                .cash-grid { display:block; }
                                .cash-table-area { max-width: 100%; }
                                #cash-summary-panel { width: 100%; margin-top: 12px; }
                            }
                            /* Ensure header stays above content so pages scroll under the blue header */
                            header.sticky { z-index: 9999 !important; }

                            /* Debts Tab Styling */
                            .debts-tab-button { transition: all 0.3s ease; }
                            .debts-tab-button.active { background-color: #3b82f6; color: white; }
                            .debts-tab-content { display:none; }
                            .debts-tab-content.active { display:block; }
                        `;
                        const s = document.createElement('style'); s.id = 'cash-page-styles'; s.appendChild(document.createTextNode(css)); document.head.appendChild(s);
                    }

                    function renderCashSummary(sales){
                        try{
                            const total = sales.reduce((sum,s)=> sum + Number(s.total || 0), 0);
                            const paid = sales.reduce((sum,s)=> sum + (Number(s.paidAmount || 0) || ((Number(s.firstPayment||0)+Number(s.secondPayment||0)) || 0)), 0);
                            // Discount should be entered manually when creating a collection report (sale.collectionDiscount)
                            const discount = sales.reduce((sum,s)=> sum + (Number(s.collectionDiscount || 0)), 0);
                            // Remaining should account for manual discounts applied at collection
                            const remaining = total - paid - discount;
                            const elTotal = document.getElementById('cash-summary-total');
                            const elPaid = document.getElementById('cash-summary-paid');
                            const elDiscount = document.getElementById('cash-summary-discount');
                            const elRemaining = document.getElementById('cash-summary-remaining');
                            if(elTotal) elTotal.textContent = formatCurrency(total);
                            if(elPaid) elPaid.textContent = formatCurrency(paid);
                            if(elDiscount) elDiscount.textContent = formatCurrency(discount);
                            if(elRemaining) elRemaining.textContent = formatCurrency(remaining);
                            // show count if element exists
                            const elCount = document.getElementById('cash-summary-count');
                            if(elCount) elCount.textContent = String(Array.isArray(sales) ? sales.length : 0);
                        } catch(e){ console.warn('renderCashSummary error', e); }
                    }

                    // Save Cash data to Firestore
                    window.saveCashToCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.warn('?? saveCashToCloud: DB not ready'); return; }
                            if (!window.state || !window.state.sales) { console.warn('?? saveCashToCloud: no sales'); return; }
                            const payload = {
                                sales: Array.isArray(window.state.sales) ? window.state.sales : [],
                                timestamp: new Date().toISOString(),
                                updatedAt: (typeof serverTs === 'function') ? serverTs() : { _type: 'ServerValue', value: 'TIMESTAMP' }
                            };
                            await db.collection('settings').doc('cashData').set(payload, { merge: true });
                            console.log('? saveCashToCloud: saved', payload.sales.length, 'sales');
                        } catch(e) { console.error('? saveCashToCloud failed', e); }
                    };
                    window.debouncedSaveCash = function(){
                        clearTimeout(window._cashSaveTimer);
                        window._cashSaveTimer = setTimeout(window.saveCashToCloud, 1500);
                    };

                    // Load Cash data from Firestore on startup
                    window.loadCashFromCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.warn('?? loadCashFromCloud: DB not ready'); return false; }
                            const doc = await db.collection('settings').doc('cashData').get();
                            if (!doc.exists) { console.log('?? loadCashFromCloud: no doc found'); return false; }
                            const data = doc.data() || {};
                            if (Array.isArray(data.sales) && data.sales.length > 0) {
                                window.state = window.state || {};
                                window.state.sales = data.sales;
                                try { localStorage.setItem('cache_sales', JSON.stringify(data.sales)); } catch(_){ }
                                console.log('? loadCashFromCloud: restored', data.sales.length, 'sales');
                                return true;
                            }
                        } catch(e) { console.error('? loadCashFromCloud failed', e); }
                        return false;
                    };

                    function renderCash(){
                        try {
                            injectCashStyles();
                            const tbody = document.getElementById('cash-table-body');
                            if(!tbody) return;
                            // Diagnostic: log sales length + invoice numbers to help locate missing invoice
                            try {
                                console.debug('renderCash called', { stateSalesLength: Array.isArray(state.sales) ? state.sales.length : state.sales, invoiceNumbers: Array.isArray(state.sales) ? state.sales.map(s => ({id: s.id, invoiceNumber: s.invoiceNumber, includeInCash: s.includeInCash})) : [] });
                            } catch(e) { /* ignore */ }
                            tbody.innerHTML = '';
                            // Show all sales by default so Cash mirrors Sales automatically
                            const sales = Array.isArray(state.sales) ? state.sales.slice() : [];
                            // Expose the currently rendered sales for the filter menus
                            window._cashFiltersOriginalRenderedSales = sales.slice();
                            window._lastRenderedCashSales = sales.slice();

                            renderCashSummary(sales);

                            if(sales.length === 0){
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td colspan="15" class="p-4 text-center text-gray-500">?? ???? ???? ?? ?????.</td>`;
                                tbody.appendChild(tr);
                                return;
                            }

                            // Sort oldest first (old above, new below)
                            sales.sort((a,b)=> new Date(a.date || a.createdAt) - new Date(b.date || b.createdAt));
                            sales.forEach((s, idx) => {
                                const first = Number(s.firstPayment || 0);
                                const second = Number(s.secondPayment || 0);
                                const paidSum = (first + second) || Number(s.paidAmount || 0) || 0;
                                const total = Number(s.total || 0);
                                // Use explicit invoice discount and a manual collection discount (editable)
                                const invoiceDiscount = Number(s.discount || 0);
                                const collectionDiscount = Number(s.collectionDiscount || 0);
                                // Collected after discount = collected payments minus any collection discount applied
                                const collectedAfter = Math.max(0, Math.round(((first + second) - collectionDiscount) * 100) / 100);
                                // Remaining = total - collected payments - collection discount
                                const remainingAmount = Math.round((total - (first + second) - collectionDiscount) * 100) / 100;
                                const customerName = (findCustomer(s.customerId) || {}).name || s.customerName || '??? ?????';
                                const rep = s.repName || s.rep || '';
                                const tr = document.createElement('tr');
                                // Decide row color: fully paid (remaining <= 0) -> blue, collected flag -> blue, paidToSafe -> green, due -> red
                                let rowClass = '';
                                if (typeof remainingAmount !== 'undefined' && remainingAmount <= 0) rowClass = 'cash-row-collected';
                                else if (s.collectionReportCreated) rowClass = 'cash-row-collected';
                                else if (s.paidToSafe) rowClass = 'cash-row-paid';
                                else if (s.status === 'due') rowClass = 'cash-row-due';
                                tr.className = rowClass;
                                // visibly mark rows explicitly excluded from cash (legacy flag)
                                if (s.includeInCash === false) {
                                    tr.style.opacity = '0.6';
                                    tr.dataset.excludedFromCash = 'true';
                                }
                                tr.dataset.saleId = s.id;
                                // dataset fields for filtering
                                try {
                                    tr.dataset.date = (s.date || s.createdAt || '').split('T')[0] || '';
                                    tr.dataset.invoice = String(s.invoiceNumber || '');
                                    tr.dataset.customer = String(customerName || '');
                                    tr.dataset.rep = String(rep || '');
                                    tr.dataset.total = String(total || 0);
                                    tr.dataset.paid = String(paidSum || Number(s.paidAmount || 0) || 0);
                                    tr.dataset.remaining = String(remainingAmount || 0);
                                } catch(e) { /* ignore */ }

                                tr.innerHTML = `
                                    <td class="p-2 text-center">${idx + 1}</td>
                                    <td class="p-2 text-center">${formatArabicDate(s.date || s.createdAt || new Date().toISOString())}</td>
                                    <td class="p-2 text-center">${s.invoiceNumber || ''}</td>
                                    <td class="p-2 text-right">${customerName}</td>
                                    <td class="p-2 text-right">${rep}</td>
                                    <td class="p-2 text-center">${formatCurrency(total)}</td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-discount" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(collectionDiscount))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-first-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(first))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-second-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(second))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center">${formatCurrency(collectedAfter)}</td>
                                    <td class="p-2 text-center"><span class="cash-remaining" data-id="${s.id}" style="${remainingAmount > 0 ? 'background:#fee2e2;color:#991b1b;font-weight:700;padding:6px;border-radius:6px;display:inline-block;' : 'background:#dcfce7;color:#065f46;font-weight:700;padding:6px;border-radius:6px;display:inline-block;'}">${formatCurrency(remainingAmount)}</span></td>
                                    <td class="p-2 text-center">${s.collectionReportCreated ? '<span class="cash-badge" style="background:#dbeafe;color:#1e40af">??</span>' : '<span class="cash-badge" style="background:#fef3c7;color:#92400e">?? ???</span>'}</td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-number" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(s.collectionNumber || ''))}" placeholder="???"></td>
                                    <td class="p-2 text-center">${s.paidToSafe ? '<span class="cash-badge" style="background:#dcfce7;color:#065f46">???</span>' : '<span class="cash-badge" style="background:#fef2f2;color:#991b1b">?? ????</span>'}</td>
                                    <td class="p-2 text-center">
                                        <button class="cash-action-btn cash-action-create" data-id="${s.id}">${s.collectionReportCreated ? '????? ???' : '????? ???'}</button>
                                        <button class="cash-action-btn cash-action-safe" data-id="${s.id}">${s.paidToSafe ? '????? ?????' : '??? ???????'}</button>
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            });

                            // Attach collection number handlers
                            tbody.querySelectorAll('.cash-collection-number').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    sale.collectionNumber = input.value.trim();
                                    saveState();
                                    // just update summary/rows without full reload to keep cursor stable
                                });
                            });

                            // Attach collection discount handlers (editable in table)
                            tbody.querySelectorAll('.cash-collection-discount').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    const val = parseFloat(input.value.toString().replace(/,/g, '')) || 0;
                                    sale.collectionDiscount = Math.round(val * 100) / 100;
                                    saveState();
                                    try { if (typeof window.debouncedSaveCash === 'function') window.debouncedSaveCash(); } catch(e){}
                                    renderCash();
                                });
                            });

                            // Attach first/second payment handlers (editable in-cash)
                            spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                                const invoiceNumberInput = row.querySelector('.spreadsheet-invoice-number');
                                const productCodeInput = row.querySelector('.spreadsheet-product-code');
                                const productNameInput = row.querySelector('.spreadsheet-product-name');
                                const taxStatusInput = row.querySelector('.spreadsheet-tax-status-input');
                                const rawInvoiceNumber = invoiceNumberInput.value.trim();
                                const invoiceNumber = rawInvoiceNumber ? parseInt(rawInvoiceNumber) : null;
                                const productId = row.dataset.productId;
                                const productNameValue = productNameInput ? productNameInput.value.trim() : '';
                                const quantity = parseInt(row.querySelector('.spreadsheet-quantity').value) || 0;
                                const originalPrice = parseFloat(row.querySelector('.spreadsheet-price').value);
                                const modifiedPrice = parseFloat(row.querySelector('.spreadsheet-modified-price').value);
                                const safeOriginalPrice = (!isNaN(originalPrice) ? originalPrice : 0);
                                const safeModifiedPrice = (!isNaN(modifiedPrice) ? modifiedPrice : 0);
                                const price = (safeModifiedPrice > 0) ? safeModifiedPrice : safeOriginalPrice;
                                const discount = parseFloat(row.querySelector('.spreadsheet-discount').value);
                                const safeDiscount = (!isNaN(discount) ? discount : 0);
                                const collection = row.querySelector('.spreadsheet-collection').value;
                                const partialAmount = parseFloat(row.querySelector('.spreadsheet-partial-amount')?.value);
                                const safePartialAmount = (!isNaN(partialAmount) ? partialAmount : 0);
                                const taxFilingStatus = taxStatusInput ? taxStatusInput.value.trim() : '';

                                // Track if user manually edited the invoice number for this row
                                const rowManual = invoiceNumberInput && invoiceNumberInput.dataset && invoiceNumberInput.dataset.userEntered === '1';
                                let rowIsValidLocal = true;

                                [invoiceNumberInput, productCodeInput, row.querySelector('.spreadsheet-quantity'), row.querySelector('.spreadsheet-price'), row.querySelector('.spreadsheet-discount')].forEach(el => el.classList.remove('border-red-500', 'border-2'));
                                if (productNameInput) productNameInput.classList.remove('border-red-500', 'border-2');
                                if (taxStatusInput) taxStatusInput.classList.remove('border-red-500', 'border-2');

                                // Special-case: product code '100' is used as a cancelled-invoice placeholder
                                const codeValue = (productCodeInput && productCodeInput.value) ? productCodeInput.value.trim() : '';
                                const isCanceledCode = (codeValue === '100') || (productId === '100');

                                if (isCanceledCode) {
                                    // allow saving a cancelled invoice row even without price/quantity
                                    dataFound = true;

                                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0) {
                                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    }

                                    if (invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).collectionStatus !== collection) {
                                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    }

                                    if (!rowIsValidLocal) {
                                        if (rowManual) {
                                            // accept manual entry and clear visual error
                                            invoiceNumberInput.classList.remove('border-red-500', 'border-2');
                                            rowIsValidLocal = true;
                                        } else {
                                            isValid = false;
                                            return;
                                        }
                                    }

                                    if (!invoicesToSave.has(invoiceNumber)) {
                                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? safePartialAmount : 0, isCanceled: true });
                                    } else {
                                        invoicesToSave.get(invoiceNumber).isCanceled = true;
                                    }

                                    // skip normal item validation for this row
                                    return;
                                }

                                if (productId || productNameValue) {
                                    dataFound = true;
                    
                                    // ?????? ?? ?? ?????? ????? ?????
                                    const product = getProductDetailsByCode(productId);
                                    if (!product) {
                                        if (productNameInput) {
                                            productNameInput.classList.add('border-red-500', 'border-2');
                                        }
                                        if (productCodeInput) {
                                            productCodeInput.classList.add('border-red-500', 'border-2');
                                        }
                                        rowIsValidLocal = false;
                                        if (!rowManual) { isValid = false; return; } else { rowIsValidLocal = true; invoiceNumberInput.classList.remove('border-red-500','border-2'); }
                                    }
                    
                                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0) {
                                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    }

                                    // Validation continues below...

                                    // Quantity cannot be zero (but can be negative)
                                    if (!quantity || quantity === 0) { row.querySelector('.spreadsheet-quantity').classList.add('border-red-500', 'border-2'); rowIsValidLocal = false; }

                                    if (isNaN(price) || price <= 0) { row.querySelector('.spreadsheet-price').classList.add('border-red-500', 'border-2'); rowIsValidLocal = false; }
                                    if (isNaN(discount) || discount < 0 || discount > 100) { row.querySelector('.spreadsheet-discount').classList.add('border-red-500', 'border-2'); rowIsValidLocal = false; }

                                    if (!rowIsValidLocal) {
                                        if (rowManual) {
                                            // Accept manual entry despite row-level validation failures
                                            invoiceNumberInput.classList.remove('border-red-500','border-2');
                                            row.querySelector('.spreadsheet-quantity')?.classList.remove('border-red-500','border-2');
                                            row.querySelector('.spreadsheet-price')?.classList.remove('border-red-500','border-2');
                                            row.querySelector('.spreadsheet-discount')?.classList.remove('border-red-500','border-2');
                                            if (taxStatusInput) taxStatusInput.classList.remove('border-red-500','border-2');
                                            rowIsValidLocal = true;
                                        } else {
                                            isValid = false;
                                            return;
                                        }
                                    }

                                    if (!invoicesToSave.has(invoiceNumber)) {
                                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? safePartialAmount : 0 });
                                    }

                                    const itemSubtotal = price * quantity;
                                    const itemFinalPrice = itemSubtotal * (1 - safeDiscount / 100);
                                    const invoiceData = invoicesToSave.get(invoiceNumber);
                                    invoiceData.items.push({ productId, quantity, price, discountPercent: safeDiscount, itemFinalPrice });
                                    invoiceData.totalSales += itemFinalPrice;
                                    invoiceData.taxFilingStatus = taxFilingStatus;
                                    if (collection === 'partial') invoiceData.partialAmount = safePartialAmount;
                                } else if (productCodeInput.value.trim()) {
                                    productCodeInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal = false;
                                    if (!rowManual) { isValid = false; } else { productCodeInput.classList.remove('border-red-500','border-2'); rowIsValidLocal = true; }
                                }
                
                            });
                        } catch(e) { console.warn('renderCash error', e); }
                    }
                    
                    // Safe stub to avoid ReferenceError if attachCashListeners isn't defined on this page
                    if (typeof window.attachCashListeners !== 'function') {
                        window.attachCashListeners = function(){};
                    }
                    document.addEventListener('DOMContentLoaded', ()=>{
                        try{ if (typeof attachCashListeners === 'function') attachCashListeners(); }
                        catch(e){ console.warn('attachCashListeners error', e); }
                    });

                    // Save Cash data to Firestore
                    window.saveCashToCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.warn('?? saveCashToCloud: DB not ready'); return; }
                            if (!window.state || !window.state.sales) { console.warn('?? saveCashToCloud: no sales'); return; }
                            const payload = {
                                sales: Array.isArray(window.state.sales) ? window.state.sales : [],
                                timestamp: new Date().toISOString(),
                                updatedAt: (typeof serverTs === 'function') ? serverTs() : firebase.firestore.FieldValue.serverTimestamp()
                            };
                            await db.collection('settings').doc('cashData').set(payload, { merge: true });
                            console.log('? saveCashToCloud: saved', payload.sales.length, 'sales to cloud');
                        } catch(e) { console.error('? saveCashToCloud failed', e); }
                    };
                    window.debouncedSaveCash = function(){
                        clearTimeout(window._cashSaveTimer);
                        window._cashSaveTimer = setTimeout(window.saveCashToCloud, 1500);
                    };

                    // Load Cash data from Firestore on startup
                    window.loadCashFromCloud = async function(){
                        try {
                            if (!window.db || typeof db === 'undefined') { console.log('?? loadCashFromCloud: DB not ready'); return false; }
                            const doc = await db.collection('settings').doc('cashData').get();
                            if (!doc.exists) { console.log('?? loadCashFromCloud: no doc found'); return false; }
                            const data = doc.data() || {};
                            if (Array.isArray(data.sales) && data.sales.length > 0) {
                                window.state = window.state || {};
                                window.state.sales = data.sales;
                                try { localStorage.setItem('cache_sales', JSON.stringify(data.sales)); } catch(_){ }
                                console.log('? loadCashFromCloud: restored', data.sales.length, 'sales from cloud');
                                return true;
                            }
                        } catch(e) { console.warn('?? loadCashFromCloud failed', e); }
                        return false;
                    };

                    // expose for manual calls / debugging
                    window.renderCash = renderCash;

                    // ========== TAB SWITCHING AND RECEIPT FUNCTIONALITY ==========
                    // Collection Receipt functionality
                    window.renderCollectionReceipt = function() {
                        try {
                            const fromDate = document.getElementById('receipt-from-date')?.value;
                            const toDate = document.getElementById('receipt-to-date')?.value;
                            const repFilter = document.getElementById('receipt-rep-dropdown')?.value;
                            const tbody = document.getElementById('receipt-table-body');
                            if (!tbody) return;
                            
                            tbody.innerHTML = '';
                            let receipts = [];
                            let totalAmount = 0;
                            let totalCount = 0;
                            
                            // ??? ????????? ?? ?? ????????
                            if (Array.isArray(state.sales)) {
                                state.sales.forEach(sale => {
                                    const saleDate = sale.date ? new Date(sale.date).toISOString().split('T')[0] : null;
                                    if (!saleDate) return;
                                    
                                    // ???? ???????
                                    if (fromDate && saleDate < fromDate) return;
                                    if (toDate && saleDate > toDate) return;
                                    
                                    // ???? ???????
                                    if (repFilter && sale.repName !== repFilter) return;
                                    
                                    // ??? ???? ??? (Cash)
                                    if (sale.status === 'cash') {
                                        const amount = sale.total || sale.totalAfterDiscount || 0;
                                        receipts.push({
                                            date: saleDate,
                                            invoiceNumber: sale.invoiceNumber,
                                            customer: sale.customerName || findCustomer(sale.customerId)?.name || '??? ?????',
                                            type: '???',
                                            amount: amount,
                                            status: '?????'
                                        });
                                        totalAmount += amount;
                                    }
                                    
                                    // ??? ???? ??? ??? (Partial)
                                    if (sale.status === 'partial') {
                                        if (sale.firstPayment && sale.firstPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber + ' (???? ????)',
                                                customer: sale.customerName || findCustomer(sale.customerId)?.name || '??? ?????',
                                                type: '???? ????',
                                                amount: sale.firstPayment,
                                                status: '?????'
                                            });
                                            totalAmount += sale.firstPayment;
                                        }
                                        if (sale.secondPayment && sale.secondPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber + ' (???? ?????)',
                                                customer: sale.customerName || findCustomer(sale.customerId)?.name || '??? ?????',
                                                type: '???? ?????',
                                                amount: sale.secondPayment,
                                                status: '?????'
                                            });
                                            totalAmount += sale.secondPayment;
                                        }
                                    }
                                });
                            }
                            
                            // ????? ????????? ??? ???????
                            receipts.sort((a, b) => new Date(a.date) - new Date(b.date));
                            
                            // ??? ??????
                            if (receipts.length === 0) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = '<td colspan="6" class="p-4 text-center text-gray-500">?? ???? ???????</td>';
                                tbody.appendChild(tr);
                            } else {
                                receipts.forEach((receipt, idx) => {
                                    const tr = document.createElement('tr');
                                    tr.classList.add(idx % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                                    tr.innerHTML = `
                                        <td class="border p-2 text-right">${receipt.date}</td>
                                        <td class="border p-2 text-right">${receipt.invoiceNumber}</td>
                                        <td class="border p-2 text-right">${receipt.customer}</td>
                                        <td class="border p-2 text-right">${receipt.type}</td>
                                        <td class="border p-2 text-right font-semibold">${formatCurrency(receipt.amount)}</td>
                                        <td class="border p-2 text-right"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${receipt.status}</span></td>
                                    `;
                                    tbody.appendChild(tr);
                                });
                                totalCount = receipts.length;
                            }
                            
                            // ????? ??????????
                            const totalEl = document.getElementById('receipt-total');
                            const countEl = document.getElementById('receipt-count');
                            const avgEl = document.getElementById('receipt-avg');
                            if (totalEl) totalEl.textContent = formatCurrency(totalAmount);
                            if (countEl) countEl.textContent = totalCount;
                            if (avgEl) avgEl.textContent = formatCurrency(totalCount > 0 ? totalAmount / totalCount : 0);
                            
                        } catch(e) { console.error('renderCollectionReceipt error', e); }
                    };

                    window.populateReceiptRepDropdown = function() {
                        const select = document.getElementById('receipt-rep-dropdown');
                        if (!select) return;
                        const reps = Array.from(new Set((state.sales || []).map(s => s.repName).filter(Boolean)));
                        select.innerHTML = '<option value="">-- ???? ???????? --</option>';
                        reps.forEach(rep => {
                            const option = document.createElement('option');
                            option.value = rep;
                            option.textContent = rep;
                            select.appendChild(option);
                        });
                    };

                    // Initialize receipt page
                    window.initReceiptPage = function() {
                        const today = new Date().toISOString().split('T')[0];
                        const fromInput = document.getElementById('receipt-from-date');
                        const toInput = document.getElementById('receipt-to-date');
                        if (fromInput && !fromInput.value) fromInput.value = today;
                        if (toInput && !toInput.value) toInput.value = today;
                        window.populateReceiptRepDropdown();
                    };

                    // Receipt filter and print buttons
                    document.addEventListener('DOMContentLoaded', function() {
                        const filterBtn = document.getElementById('receipt-filter-btn');
                        const printBtn = document.getElementById('receipt-print-btn');
                        const saveBtn = document.getElementById('receipt-save-btn');
                        
                        if (filterBtn) {
                            filterBtn.addEventListener('click', () => {
                                window.renderCollectionReceipt();
                            });
                        }
                        
                        if (printBtn) {
                            printBtn.addEventListener('click', () => {
                                // Print only the receipt section
                                const printWindow = window.open('', '', 'height=600,width=800');
                                const repName = document.getElementById('receipt-rep-dropdown')?.value || '???? ?????';
                                const credits = document.getElementById('rep-credit-transactions')?.value || '0';
                                const expenses = document.getElementById('rep-expenses')?.value || '0';
                                const notes = document.getElementById('rep-notes')?.value || '';
                                const totalEl = document.getElementById('receipt-total');
                                const total = totalEl?.textContent || '0';
                                
                                const contentToPrint = `
                                    <html dir="rtl">
                                    <head>
                                        <style>
                                            body { font-family: Arial, sans-serif; text-align: right; margin: 20px; }
                                            h2 { text-align: center; font-size: 18px; margin-bottom: 20px; }
                                            .receipt-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
                                            .receipt-item { margin: 10px 0; padding: 5px 0; border-bottom: 1px solid #ccc; }
                                            .receipt-item label { font-weight: bold; width: 150px; display: inline-block; }
                                            .receipt-item value { margin-right: 10px; }
                                            .receipt-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 16px; }
                                        </style>
                                    </head>
                                    <body>
                                        <h2>??? ???????</h2>
                                        <div class="receipt-header">
                                            <div class="receipt-item"><label>???????:</label> <span>${repName}</span></div>
                                            <div class="receipt-item"><label>???????:</label> <span>${new Date().toLocaleDateString('ar-EG')}</span></div>
                                        </div>
                                        <div class="receipt-item"><label>????????:</label> <span>${credits}</span></div>
                                        <div class="receipt-item"><label>?????????:</label> <span>${expenses}</span></div>
                                        <div class="receipt-item"><label>?????????:</label> <span>${notes}</span></div>
                                        <div class="receipt-total">?????? ?????????: ${total}</div>
                                    </body>
                                    </html>`;
                                printWindow.document.write(contentToPrint);
                                printWindow.document.close();
                                printWindow.print();
                            });
                        }
                        
                        if (saveBtn) {
                            saveBtn.addEventListener('click', () => {
                                try {
                                    const repName = document.getElementById('receipt-rep-dropdown')?.value;
                                    const credits = document.getElementById('rep-credit-transactions')?.value;
                                    const expenses = document.getElementById('rep-expenses')?.value;
                                    const notes = document.getElementById('rep-notes')?.value;
                                    
                                    if (!repName) {
                                        alert('?????? ?????? ????? ?????');
                                        return;
                                    }
                                    
                                    const receiptData = {
                                        repName,
                                        credits: parseFloat(credits) || 0,
                                        expenses: parseFloat(expenses) || 0,
                                        notes,
                                        timestamp: new Date().toISOString(),
                                        date: new Date().toISOString().split('T')[0]
                                    };
                                    
                                    // Save to localStorage
                                    localStorage.setItem(`rep_receipt_${repName}_${receiptData.date}`, JSON.stringify(receiptData));
                                    
                                    // Save to cloud
                                    if (window.db && typeof db !== 'undefined') {
                                        db.collection('settings').doc('repReceipts').collection(receiptData.date).doc(repName).set(receiptData, { merge: true })
                                            .then(() => {
                                                alert('?? ??? ???????? ?????');
                                            })
                                            .catch(e => console.warn('Failed to save to cloud', e));
                                    }
                                } catch(e) {
                                    console.error('Error saving receipt data', e);
                                    alert('??? ?? ??? ????????');
                                }
                            });
                        }

                        // Setup tab switching for Debts page
                        const debtsTabBtn = document.getElementById('debts-tab-btn');
                        const receiptDebtsTabBtn = document.getElementById('receipt-debts-tab-btn');
                        const debtsTabContent = document.getElementById('debts-tab-content');
                        const receiptDebtsTabContent = document.getElementById('receipt-debts-tab-content');
                        
                        if (debtsTabBtn && receiptDebtsTabBtn && debtsTabContent && receiptDebtsTabContent) {
                            debtsTabBtn.addEventListener('click', () => {
                                debtsTabBtn.style.backgroundColor = '#3b82f6';
                                debtsTabBtn.style.color = 'white';
                                receiptDebtsTabBtn.style.backgroundColor = '#d1d5db';
                                receiptDebtsTabBtn.style.color = '#374151';
                                debtsTabContent.style.display = '';
                                debtsTabContent.classList.add('active');
                                receiptDebtsTabContent.style.display = 'none';
                                receiptDebtsTabContent.classList.remove('active');
                            });
                            
                            receiptDebtsTabBtn.addEventListener('click', () => {
                                receiptDebtsTabBtn.style.backgroundColor = '#3b82f6';
                                receiptDebtsTabBtn.style.color = 'white';
                                debtsTabBtn.style.backgroundColor = '#d1d5db';
                                debtsTabBtn.style.color = '#374151';
                                receiptDebtsTabContent.style.display = '';
                                receiptDebtsTabContent.classList.add('active');
                                debtsTabContent.style.display = 'none';
                                debtsTabContent.classList.remove('active');
                                window.initReceiptPage();
                                window.renderCollectionReceipt();
                            });
                        }

                        // Local tab switching inside dispatch page
                        const dispatchNotesTabBtn = document.getElementById('dispatch-notes-tab-btn');
                        const receiptLocalTabBtn = document.getElementById('receipt-local-tab-btn');
                        const dispatchNotesTabContent = document.getElementById('dispatch-notes-tab-content');
                        const receiptLocalTabContent = document.getElementById('receipt-local-tab-content');
                        
                        if (dispatchNotesTabBtn && receiptLocalTabBtn && dispatchNotesTabContent && receiptLocalTabContent) {
                            dispatchNotesTabBtn.addEventListener('click', () => {
                                dispatchNotesTabBtn.style.backgroundColor = '#3b82f6';
                                dispatchNotesTabBtn.style.color = 'white';
                                receiptLocalTabBtn.style.backgroundColor = '#d1d5db';
                                receiptLocalTabBtn.style.color = '#374151';
                                dispatchNotesTabContent.style.display = 'block';
                                receiptLocalTabContent.style.display = 'none';
                            });
                            
                            receiptLocalTabBtn.addEventListener('click', () => {
                                receiptLocalTabBtn.style.backgroundColor = '#3b82f6';
                                receiptLocalTabBtn.style.color = 'white';
                                dispatchNotesTabBtn.style.backgroundColor = '#d1d5db';
                                dispatchNotesTabBtn.style.color = '#374151';
                                receiptLocalTabContent.style.display = 'block';
                                dispatchNotesTabContent.style.display = 'none';
                                // Initialize receipt page with local IDs
                                try {
                                    const today = new Date().toISOString().split('T')[0];
                                    const fromInput = document.getElementById('receipt-from-date-local');
                                    const toInput = document.getElementById('receipt-to-date-local');
                                    if (fromInput && !fromInput.value) fromInput.value = today;
                                    if (toInput && !toInput.value) toInput.value = today;
                                    const repDropdown = document.getElementById('receipt-rep-dropdown-local');
                                    if (repDropdown) {
                                        const reps = Array.from(new Set((state.sales || []).map(s => s.repName).filter(Boolean)));
                                        repDropdown.innerHTML = '<option value="">-- ???? ???????? --</option>';
                                        reps.forEach(rep => {
                                            const option = document.createElement('option');
                                            option.value = rep;
                                            option.textContent = rep;
                                            repDropdown.appendChild(option);
                                        });
                                    }
                                    // Render receipt with local IDs
                                    if (typeof renderCollectionReceiptLocal === 'function') renderCollectionReceiptLocal();
                                } catch(e) { console.warn('receipt init failed', e); }
                            });
                        }
                        
                        // Filter button for local receipt
                        const filterBtnLocal = document.getElementById('receipt-filter-btn-local');
                        if (filterBtnLocal) {
                            filterBtnLocal.addEventListener('click', () => {
                                if (typeof renderCollectionReceiptLocal === 'function') renderCollectionReceiptLocal();
                            });
                        }
                        
                        // Print button for local receipt
                        const printBtnLocal = document.getElementById('receipt-print-btn-local');
                        if (printBtnLocal) {
                            printBtnLocal.addEventListener('click', () => {
                                const repName = document.getElementById('receipt-rep-dropdown-local')?.value || '???? ?????';
                                const credits = document.getElementById('rep-credit-transactions-local')?.value || '0';
                                const expenses = document.getElementById('rep-expenses-local')?.value || '0';
                                const notes = document.getElementById('rep-notes-local')?.value || '';
                                const totalEl = document.getElementById('receipt-total-local');
                                const total = totalEl?.textContent || '0';
                                
                                const contentToPrint = `
                                    <html dir="rtl">
                                    <head>
                                        <style>
                                            body { font-family: Arial, sans-serif; text-align: right; margin: 20px; }
                                            h2 { text-align: center; font-size: 18px; margin-bottom: 20px; }
                                            .receipt-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
                                            .receipt-item { margin: 10px 0; padding: 5px 0; border-bottom: 1px solid #ccc; }
                                            .receipt-item label { font-weight: bold; width: 150px; display: inline-block; }
                                            .receipt-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 16px; }
                                        </style>
                                    </head>
                                    <body>
                                        <h2>??? ???????</h2>
                                        <div class="receipt-header">
                                            <div class="receipt-item"><label>???????:</label> <span>${repName}</span></div>
                                            <div class="receipt-item"><label>???????:</label> <span>${new Date().toLocaleDateString('ar-EG')}</span></div>
                                        </div>
                                        <div class="receipt-item"><label>????????:</label> <span>${credits}</span></div>
                                        <div class="receipt-item"><label>?????????:</label> <span>${expenses}</span></div>
                                        <div class="receipt-item"><label>?????????:</label> <span>${notes}</span></div>
                                        <div class="receipt-total">?????? ?????????: ${total}</div>
                                    </body>
                                    </html>`;
                                const printWindow = window.open('', '', 'height=600,width=800');
                                printWindow.document.write(contentToPrint);
                                printWindow.document.close();
                                printWindow.print();
                            });
                        }
                        
                        // Save button for local receipt
                        const saveBtnLocal = document.getElementById('receipt-save-btn-local');
                        if (saveBtnLocal) {
                            saveBtnLocal.addEventListener('click', () => {
                                try {
                                    const repName = document.getElementById('receipt-rep-dropdown-local')?.value;
                                    const credits = document.getElementById('rep-credit-transactions-local')?.value;
                                    const expenses = document.getElementById('rep-expenses-local')?.value;
                                    const notes = document.getElementById('rep-notes-local')?.value;
                                    
                                    if (!repName) {
                                        alert('?????? ?????? ????? ?????');
                                        return;
                                    }
                                    
                                    const receiptData = {
                                        repName,
                                        credits: parseFloat(credits) || 0,
                                        expenses: parseFloat(expenses) || 0,
                                        notes,
                                        timestamp: new Date().toISOString(),
                                        date: new Date().toISOString().split('T')[0]
                                    };
                                    
                                    localStorage.setItem(`rep_receipt_${repName}_${receiptData.date}`, JSON.stringify(receiptData));
                                    
                                    if (window.db && typeof db !== 'undefined') {
                                        db.collection('settings').doc('repReceipts').collection(receiptData.date).doc(repName).set(receiptData, { merge: true })
                                            .then(() => { alert('?? ??? ???????? ?????'); })
                                            .catch(e => console.warn('Failed to save to cloud', e));
                                    }
                                } catch(e) {
                                    console.error('Error saving receipt data', e);
                                    alert('??? ?? ??? ????????');
                                }
                            });
                        }
                        
                        // Render function for local receipt
                        window.renderCollectionReceiptLocal = function() {
                            try {
                                const tbody = document.getElementById('receipt-table-body-local');
                                if (!tbody) return;
                                tbody.innerHTML = '';
                                
                                const fromDate = document.getElementById('receipt-from-date-local')?.value;
                                const toDate = document.getElementById('receipt-to-date-local')?.value;
                                const selectedRep = document.getElementById('receipt-rep-dropdown-local')?.value;
                                
                                let receipts = [];
                                let totalAmount = 0;
                                let totalCount = 0;
                                
                                if (Array.isArray(state.sales)) {
                                    state.sales.forEach(sale => {
                                        const saleDate = (sale.date || sale.createdAt || '').split('T')[0];
                                        if (fromDate && saleDate < fromDate) return;
                                        if (toDate && saleDate > toDate) return;
                                        if (selectedRep && sale.repName !== selectedRep) return;
                                        
                                        const customer = (typeof findCustomer === 'function' ? findCustomer(sale.customerId) : null) || {};
                                        const customerName = customer.name || sale.customerName || '??? ?????';
                                        
                                        if (sale.firstPayment && sale.firstPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber || '',
                                                customer: customerName,
                                                type: '???? ????',
                                                amount: sale.firstPayment,
                                                status: '?????'
                                            });
                                            totalAmount += sale.firstPayment;
                                        }
                                        if (sale.secondPayment && sale.secondPayment > 0) {
                                            receipts.push({
                                                date: saleDate,
                                                invoiceNumber: sale.invoiceNumber || '',
                                                customer: customerName,
                                                type: '???? ?????',
                                                amount: sale.secondPayment,
                                                status: '?????'
                                            });
                                            totalAmount += sale.secondPayment;
                                        }
                                    });
                                }
                                
                                receipts.sort((a, b) => new Date(a.date) - new Date(b.date));
                                
                                if (receipts.length === 0) {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = '<td colspan="6" class="p-4 text-center text-gray-500">?? ???? ???????</td>';
                                    tbody.appendChild(tr);
                                } else {
                                    receipts.forEach((receipt, idx) => {
                                        const tr = document.createElement('tr');
                                        tr.classList.add(idx % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                                        tr.innerHTML = `
                                            <td class="border p-2 text-right">${receipt.date}</td>
                                            <td class="border p-2 text-right">${receipt.invoiceNumber}</td>
                                            <td class="border p-2 text-right">${receipt.customer}</td>
                                            <td class="border p-2 text-right">${receipt.type}</td>
                                            <td class="border p-2 text-right font-semibold">${formatCurrency(receipt.amount)}</td>
                                            <td class="border p-2 text-right"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${receipt.status}</span></td>
                                        `;
                                        tbody.appendChild(tr);
                                    });
                                    totalCount = receipts.length;
                                }
                                
                                const totalEl = document.getElementById('receipt-total-local');
                                const countEl = document.getElementById('receipt-count-local');
                                const avgEl = document.getElementById('receipt-avg-local');
                                if (totalEl) totalEl.textContent = formatCurrency(totalAmount);
                                if (countEl) countEl.textContent = totalCount;
                                if (avgEl) avgEl.textContent = formatCurrency(totalCount > 0 ? totalAmount / totalCount : 0);
                                
                            } catch(e) { console.error('renderCollectionReceiptLocal error', e); }
                        }
                    });
                })();
            </script>

            <!-- Rep Debts Page removed per user request -->

            <!-- removed separate sub-pages; their markup is embedded as subviews inside stock-control -->

            <div id="page-stock-control" class="page">
                <style>
                    /* Enhanced Tab Styling */
                    .inv-tab-btn { 
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                        border-bottom: 4px solid transparent; 
                        cursor: pointer;
                        position: relative;
                    }
                    .inv-tab-btn:hover {
                        background-color: rgba(255, 255, 255, 0.7);
                        transform: translateY(-2px);
                    }
                    .inv-tab-btn.active { 
                        background-color: #ffffff; 
                        color: #2563eb; 
                        border-bottom-color: #2563eb;
                        box-shadow: 0 -2px 8px rgba(37, 99, 235, 0.1);
                    }
                    
                    /* Smooth Fade Animation */
                    .fade-in { 
                        animation: fadeIn 0.4s ease-in-out; 
                    }
                    @keyframes fadeIn { 
                        from { opacity: 0; transform: translateY(10px); } 
                        to { opacity: 1; transform: translateY(0); } 
                    }
                    
                    /* Item Card Modal */
                    #itemCardModal { 
                        display: none; 
                        position: fixed; 
                        z-index: 9999; 
                        left: 0; 
                        top: 0; 
                        width: 100%; 
                        height: 100%; 
                        overflow: auto; 
                        background-color: rgba(0,0,0,0.6); 
                        backdrop-filter: blur(4px);
                    }
                    .modal-content-inv { 
                        margin: 5% auto; 
                        background: white; 
                        border-radius: 16px; 
                        overflow: hidden; 
                        animation: slideDown 0.3s ease-out; 
                        max-width: 600px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }
                    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                </style>

                <div id="warehouse-section" class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 mb-8">
                    <!-- Header -->
                    <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-gray-50 to-blue-50">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                ?? ????? ???????
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-normal">Cloud Synced ??</span>
                            </h2>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="if(window.migrateInventoryToCloud) window.migrateInventoryToCloud()" class="bg-purple-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow hover:bg-purple-700 transition">?? ??? ????????</button>
                            <button onclick="if(window.inventorySystem && window.inventorySystem.showAddItemModal) window.inventorySystem.showAddItemModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition">+ ??? ????</button>
                        </div>
                    </div>

                    <!-- Search & Total Value -->
                    <div class="p-5 bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="w-full md:flex-1 md:max-w-lg">
                            <div class="relative">
                                <input type="text" id="inventorySearch" onkeyup="filterInventory()" placeholder="?? ??? ?? ???..." class="w-full px-4 py-3 pr-10 border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition" dir="rtl">
                                <div class="absolute left-3 top-3 text-blue-400">??</div>
                            </div>
                        </div>
                        <div class="bg-white px-6 py-3 rounded-xl shadow-md border-2 border-blue-200">
                            <div class="text-xs text-gray-500 mb-1 text-center">?????? ???? ???????</div>
                            <div id="total-inventory-value" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-blue-600">0 ?.?</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b-2 border-gray-200 bg-gray-50">
                        <div onclick="switchInvTab('finished')" id="btn-finished" class="inv-tab-btn active flex-1 py-4 text-center font-bold text-gray-600 hover:bg-white cursor-pointer transition-all duration-200">?? ???? ???</div>
                        <div onclick="switchInvTab('raw')" id="btn-raw" class="inv-tab-btn flex-1 py-4 text-center font-bold text-gray-600 hover:bg-white cursor-pointer transition-all duration-200">?? ?????</div>
                        <div onclick="switchInvTab('packing')" id="btn-packing" class="inv-tab-btn flex-1 py-4 text-center font-bold text-gray-600 hover:bg-white cursor-pointer transition-all duration-200">?? ?????</div>
                    </div>

                    <!-- Tables Container -->
                    <div class="p-4 min-h-[400px]">
                        <div id="tab-finished-content" class="fade-in">
                            <table class="w-full text-right border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-sm">
                                    <tr><th class="p-3">?????</th><th class="p-3">??????</th><th class="p-3">??????</th><th class="p-3">???????</th></tr>
                                </thead>
                                <tbody id="table-finished" class="divide-y text-gray-700"></tbody>
                            </table>
                        </div>
                        <div id="tab-raw-content" class="hidden fade-in">
                            <table class="w-full text-right border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-sm">
                                    <tr><th class="p-3">?????</th><th class="p-3">??????</th><th class="p-3">??????</th><th class="p-3">???????</th></tr>
                                </thead>
                                <tbody id="table-raw" class="divide-y text-gray-700"></tbody>
                            </table>
                        </div>
                        <div id="tab-packing-content" class="hidden fade-in">
                            <table class="w-full text-right border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-sm">
                                    <tr><th class="p-3">?????</th><th class="p-3">??????</th><th class="p-3">??????</th><th class="p-3">???????</th></tr>
                                </thead>
                                <tbody id="table-packing" class="divide-y text-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Item Details Modal - Rich Card Design -->
                <div id="itemCardModal">
                    <div class="modal-content-inv w-11/12 md:w-2/3 lg:w-1/2" style="max-width: 700px;">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-5 flex justify-between items-center rounded-t-2xl">
                            <div>
                                <h3 id="modal-title" class="text-2xl font-bold mb-1">???? ????? (?????)</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span id="modal-category" class="text-sm text-slate-300">?? ???? ???</span>
                                    <span class="text-xs text-slate-400">�</span>
                                    <span id="modal-code" class="text-xs text-slate-400">FP-001</span>
                                </div>
                            </div>
                            <button onclick="document.getElementById('itemCardModal').style.display='none'" class="text-3xl hover:text-red-300 transition w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-600">&times;</button>
                        </div>

                        <!-- Stats Cards Grid -->
                        <div class="p-6 bg-gray-50">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <!-- Min Stock -->
                                <div class="bg-gradient-to-br from-pink-50 to-rose-100 p-4 rounded-xl border border-rose-200 text-center">
                                    <div class="text-xs text-rose-600 mb-1 font-semibold">?? ????? (Min)</div>
                                    <div id="modal-min" class="text-3xl font-bold text-rose-700">10</div>
                                    <div class="text-xs text-rose-500 mt-1">???? ??????</div>
                                </div>
                                
                                <!-- Total Value -->
                                <div class="bg-gradient-to-br from-amber-50 to-yellow-100 p-4 rounded-xl border border-yellow-200 text-center">
                                    <div class="text-xs text-amber-700 mb-1 font-semibold">?????? ?????????</div>
                                    <div id="modal-total-value" class="text-2xl font-bold text-amber-800">42,500</div>
                                    <div class="text-xs text-amber-600 mt-1">?.?</div>
                                </div>
                                
                                <!-- Unit Cost -->
                                <div class="bg-gradient-to-br from-emerald-50 to-green-100 p-4 rounded-xl border border-green-200 text-center">
                                    <div class="text-xs text-emerald-700 mb-1 font-semibold">???/?????</div>
                                    <div id="modal-cost" class="text-2xl font-bold text-emerald-800">850</div>
                                    <div class="text-xs text-emerald-600 mt-1">?.?</div>
                                </div>
                                
                                <!-- Current Stock -->
                                <div class="bg-gradient-to-br from-sky-50 to-blue-100 p-4 rounded-xl border border-blue-200 text-center">
                                    <div class="text-xs text-blue-700 mb-1 font-semibold">?????? ??????</div>
                                    <div id="modal-stock" class="text-3xl font-bold text-blue-800">50</div>
                                    <div id="modal-unit" class="text-xs text-blue-600 mt-1">?????</div>
                                </div>
                            </div>

                            <!-- Movement History Table -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4">
                                <div class="bg-slate-700 text-white px-4 py-3 flex items-center gap-2">
                                    <span class="text-lg">??</span>
                                    <h4 class="font-bold">??? ??????? (??? 5 ?????)</h4>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm" dir="rtl">
                                        <thead class="bg-gray-100 border-b">
                                            <tr>
                                                <th class="px-4 py-2 text-right text-gray-600 font-semibold">???????</th>
                                                <th class="px-4 py-2 text-center text-gray-600 font-semibold">??????</th>
                                                <th class="px-4 py-2 text-center text-gray-600 font-semibold">??? ??????</th>
                                                <th class="px-4 py-2 text-right text-gray-600 font-semibold">??????</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modal-movements" class="divide-y divide-gray-100">
                                            <!-- Will be populated dynamically -->
                                            <tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">?? ???? ????? ?????</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-3">
                                <button onclick="document.getElementById('itemCardModal').style.display='none'" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-bold shadow transition">
                                    ?????
                                </button>
                                <button onclick="openEditItemModal()" class="bg-gray-400 hover:bg-gray-500 text-white py-3 px-6 rounded-lg font-bold shadow transition">
                                    ????? ??????
                                </button>
                                <button onclick="openEditPriceModal()" class="bg-amber-500 hover:bg-amber-600 text-white py-3 px-6 rounded-lg font-bold shadow transition">
                                    ????? ?????
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Item Modal - NEW RICH DESIGN -->
                <div id="addItemModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); backdrop-filter:blur(3px);">
                    <div class="bg-white w-11/12 md:w-1/2 mx-auto mt-10 rounded-xl shadow-2xl overflow-hidden animate-slideDown" style="max-width:600px;">
                        
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold flex items-center gap-2">? ????? ??? ????</h2>
                            <button onclick="closeAddModal()" class="text-2xl hover:text-red-200 transition">&times;</button>
                        </div>

                        <!-- Body -->
                        <div class="p-6 grid gap-5">
                            <!-- Name -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-2 text-sm">??? ?????</label>
                                <input type="text" id="newItemName" placeholder="????: ???? ????? ????..." class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none transition" dir="rtl">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Category -->
                                <div>
                                    <label class="block text-gray-700 font-bold mb-2 text-sm">?????</label>
                                    <select id="newItemCat" class="w-full border-2 border-gray-200 p-3 rounded-lg bg-gray-50 focus:border-blue-500 focus:outline-none" dir="rtl">
                                        <option value="raw">?? ?????</option>
                                        <option value="packing">?? ?????</option>
                                        <option value="finished">?? ???? ???</option>
                                    </select>
                                </div>
                                <!-- Unit -->
                                <div>
                                    <label class="block text-gray-700 font-bold mb-2 text-sm">??????</label>
                                    <select id="newItemUnit" class="w-full border-2 border-gray-200 p-3 rounded-lg bg-gray-50 focus:border-blue-500 focus:outline-none" dir="rtl">
                                        <option value="????">????</option>
                                        <option value="????" selected>????</option>
                                        <option value="???">???</option>
                                        <option value="??????">??????</option>
                                        <option value="??????">??????</option>
                                        <option value="?????">?????</option>
                                        <option value="????">????</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Opening Stock -->
                                <div>
                                    <label class="block text-gray-700 font-bold mb-2 text-sm">???? ??? ?????</label>
                                    <input type="number" id="newItemStock" value="0" step="0.01" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none">
                                </div>
                                <!-- Cost -->
                                <div>
                                    <label class="block text-gray-700 font-bold mb-2 text-sm">??????? / ????? (?.?)</label>
                                    <input type="number" id="newItemCost" value="0" step="0.01" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Footer Buttons -->
                        <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                            <button onclick="closeAddModal()" class="px-6 py-2 rounded-lg font-bold text-gray-600 bg-white border border-gray-300 hover:bg-gray-100 transition">????? ?</button>
                            <button onclick="saveNewItemAction()" class="px-8 py-2 rounded-lg font-bold text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 shadow-lg transform hover:scale-105 transition">??? ?</button>
                        </div>
                    </div>
                </div>

                <!-- Edit/Adjust Stock Modal -->
                <div id="editItemModal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); backdrop-filter:blur(4px);">
                    <div class="bg-white w-11/12 md:w-96 mx-auto mt-32 rounded-2xl shadow-2xl overflow-hidden animate-slideDown">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-5 text-center">
                            <h3 class="text-xl font-bold mb-1">????? ??????</h3>
                            <p id="edit-item-name" class="text-sm text-slate-300">??? ?????</p>
                        </div>

                        <!-- Body -->
                        <div class="p-6">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6 text-center">
                                <div class="text-sm text-blue-600 mb-2">?????? ??????</div>
                                <div id="edit-current-stock" class="text-4xl font-bold text-blue-700">0</div>
                                <div id="edit-unit" class="text-xs text-blue-500 mt-1">????</div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <!-- Add Stock Button -->
                                <button onclick="performStockAdjust('add')" class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                                    <div class="text-3xl mb-1">?</div>
                                    <div class="text-sm">????? ????</div>
                                </button>

                                <!-- Subtract Stock Button -->
                                <button onclick="performStockAdjust('subtract')" class="bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                                    <div class="text-3xl mb-1">?</div>
                                    <div class="text-sm">??? ?? ??????</div>
                                </button>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="p-4 bg-gray-50 border-t text-center">
                            <button onclick="closeEditModal()" class="px-8 py-2 rounded-lg font-bold text-gray-600 bg-white border border-gray-300 hover:bg-gray-100 transition">
                                ?????
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Edit Price Modal - NEW -->
                <div id="editPriceModal" style="display:none; position:fixed; z-index:10001; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); backdrop-filter:blur(4px);">
                    <div class="bg-white w-11/12 md:w-96 mx-auto mt-32 rounded-2xl shadow-2xl overflow-hidden animate-slideDown">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-amber-600 to-amber-700 text-white p-5 text-center">
                            <h3 class="text-xl font-bold mb-1">?? ????? ?????/???????</h3>
                            <p id="price-item-name" class="text-sm text-amber-200">??? ?????</p>
                        </div>

                        <!-- Body -->
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-gray-700 font-bold mb-2">?????/??????? ??????? (?.?)</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="editPriceInput" placeholder="0" class="flex-1 border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <span class="text-2xl font-bold text-amber-600">?.?</span>
                                </div>
                                <p id="price-old-value" class="text-xs text-gray-500 mt-2">????? ??????: 0</p>
                            </div>

                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <p class="text-sm text-amber-700">
                                    <strong>??????:</strong> ??? ????? ???????? ????? ?????? ????????? (?????? � ?????)
                                </p>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="p-4 bg-gray-50 border-t flex gap-3">
                            <button onclick="closeEditPriceModal()" class="flex-1 px-4 py-2 rounded-lg font-bold text-gray-600 bg-white border border-gray-300 hover:bg-gray-100 transition">
                                ?????
                            </button>
                            <button onclick="saveEditedPrice()" class="flex-1 px-4 py-2 rounded-lg font-bold text-white bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 shadow transition">
                                ?? ???
                            </button>
                        </div>
                    </div>
                </div>

                <script>
                    // PRICE EDIT FUNCTIONS
                    window.openEditPriceModal = function() {
                        if (!window.inventorySystem || !window.inventorySystem.currentItem) {
                            return alert('? ?? ??? ????? ???');
                        }
                        const item = window.inventorySystem.currentItem;
                        const cost = item.cost || item.price || item.avgCost || 0;
                        
                        document.getElementById('price-item-name').textContent = item.name || '???';
                        document.getElementById('price-old-value').textContent = `????? ??????: ${cost} ?.?`;
                        document.getElementById('editPriceInput').value = cost;
                        document.getElementById('editPriceModal').style.display = 'block';
                        
                        setTimeout(() => document.getElementById('editPriceInput').focus(), 100);
                    };

                    window.closeEditPriceModal = function() {
                        document.getElementById('editPriceModal').style.display = 'none';
                    };

                    window.saveEditedPrice = async function() {
                        if (!window.inventorySystem || !window.inventorySystem.currentItem) {
                            return alert('? ???: ?? ??? ????? ?????');
                        }

                        const newPrice = Number(document.getElementById('editPriceInput').value);
                        if (isNaN(newPrice) || newPrice < 0) {
                            return alert('?? ???? ????? ??????');
                        }

                        try {
                            const item = window.inventorySystem.currentItem;
                            const tab = window.inventorySystem.currentTab;

                            // 1. Update Firestore immediately
                            await db.collection('inventory_items').doc(item.id).set({
                                cost: newPrice,
                                price: newPrice,
                                avgCost: newPrice,
                                updatedAt: serverTs()
                            }, { merge: true });
                            
                            console.log(`? ??? ???? ?? ???????: ${item.name} ? ${newPrice}`);

                            // 2. Update array immediately
                            const array = tab === 'raw' ? window.costRaw :
                                          tab === 'packing' ? window.costPack :
                                          window.costFinished;
                            
                            if (Array.isArray(array)) {
                                const idx = array.findIndex(i => i && (i.id === item.id || i.name === item.name));
                                if (idx >= 0) {
                                    array[idx].cost = newPrice;
                                    array[idx].price = newPrice;
                                    localStorage.setItem(
                                        tab === 'raw' ? 'cost_raw' : tab === 'packing' ? 'cost_pack' : 'cost_finished',
                                        JSON.stringify(array)
                                    );
                                }
                            }

                            // 3. Save to costLists immediately (same as stock update)
                            const payload = {};
                            if (tab === 'raw') {
                                payload.raw = window.costRaw;
                            } else if (tab === 'packing') {
                                payload.pack = window.costPack;
                            } else if (tab === 'finished') {
                                payload.finished = window.costFinished;
                            }
                            payload.updatedAt = serverTs();
                            await db.collection('settings').doc('costLists').set(payload, { merge: true });

                            // 4. Close modal and refresh UI
                            closeEditPriceModal();
                            window.inventorySystem.currentItem.cost = newPrice;
                            window.inventorySystem.currentItem.price = newPrice;
                            window.inventorySystem.currentItem.avgCost = newPrice;
                            
                            // Update modal display
                            document.getElementById('modal-cost').textContent = newPrice;
                            if (typeof window.inventorySystem.loadInventoryData === 'function') {
                                window.inventorySystem.loadInventoryData(tab);
                            }
                            
                            if (typeof window.updateTotalValue === 'function') {
                                setTimeout(() => window.updateTotalValue(), 300);
                            }

                            alert(`? ?? ????? ????? ?????!\n${item.name}: ${newPrice} ?.?`);

                        } catch(e) {
                            console.error('Error saving price:', e);
                            alert(`? ??? ?? ?????: ${e.message}`);
                        }
                    };

                    // MOVEMENT HISTORY FUNCTIONS
                    window.logMovement = async function(itemId, itemName, qty, type, tab) {
                        try {
                            if (!window.db || !navigator.onLine) return;
                            
                            const movementData = {
                                itemId: itemId,
                                itemName: itemName,
                                quantity: Math.abs(qty),
                                type: type, // 'add' or 'subtract'
                                category: tab, // raw, packing, finished
                                timestamp: serverTs(),
                                date: new Date().toISOString(),
                                user: '????' // Can be enhanced with actual user
                            };

                            // Save to movements subcollection
                            await db.collection('inventory_items').doc(itemId).collection('movements').add(movementData);
                            console.log(`?? ???? ?????: ${itemName} ? ${qty} (${type})`);
                        } catch(e) {
                            console.warn('Could not log movement:', e.message);
                        }
                    };

                    window.loadMovementHistory = async function(itemId) {
                        try {
                            if (!window.db || !navigator.onLine) {
                                console.log('Offline - cannot load movements');
                                return [];
                            }

                            const snapshot = await db.collection('inventory_items')
                                .doc(itemId)
                                .collection('movements')
                                .orderBy('timestamp', 'desc')
                                .limit(5)
                                .get();

                            const movements = [];
                            snapshot.forEach(doc => {
                                movements.push(doc.data());
                            });

                            return movements;
                        } catch(e) {
                            console.warn('Error loading movements:', e.message);
                            return [];
                        }
                    };

                    window.displayMovementHistory = function(movements) {
                        const tbody = document.getElementById('modal-movements');
                        if (!tbody) return;

                        if (!movements || movements.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">?? ???? ????? ?????</td></tr>';
                            return;
                        }

                        tbody.innerHTML = movements.map(m => {
                            const date = m.timestamp ? new Date(m.timestamp.toDate()).toLocaleDateString('ar-EG', {
                                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                            }) : m.date;
                            const typeLabel = m.type === 'add' ? '? ?????' : '? ???';
                            
                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-right text-sm text-gray-600">${date}</td>
                                    <td class="px-4 py-3 text-center text-sm font-semibold">${m.quantity}</td>
                                    <td class="px-4 py-3 text-center text-sm">${typeLabel}</td>
                                    <td class="px-4 py-3 text-right text-sm text-gray-500">${m.user || '????'}</td>
                                </tr>
                            `;
                        }).join('');
                    };

                    function switchInvTab(tab) {
                        ['finished', 'raw', 'packing'].forEach(t => {
                            const btn = document.getElementById('btn-'+t);
                            if (btn) {
                                btn.classList.remove('active', 'bg-white', 'text-blue-600', 'border-b-4', 'border-blue-600');
                                btn.classList.add('text-gray-600');
                            }
                            document.getElementById('tab-'+t+'-content')?.classList.add('hidden');
                        });
                        
                        const activeBtn = document.getElementById('btn-'+tab);
                        if (activeBtn) {
                            activeBtn.classList.add('active', 'bg-white', 'text-blue-600', 'border-b-4', 'border-blue-600');
                            activeBtn.classList.remove('text-gray-600');
                        }
                        document.getElementById('tab-'+tab+'-content')?.classList.remove('hidden');
                        
                        // Load data when switching tabs
                        if (window.inventorySystem && window.inventorySystem.loadInventoryData) {
                            window.inventorySystem.loadInventoryData(tab);
                        }
                        
                        // Update counters after tab switch
                        if (typeof updateCounters === 'function') {
                            setTimeout(() => updateCounters(), 100);
                        }
                        
                        // Update total value
                        if (typeof updateTotalValue === 'function') {
                            setTimeout(() => updateTotalValue(), 200);
                        }
                    }
                </script>
            </div>

            <!-- PAGE: PRODUCTION RUNS / ????????? -->
            <div id="page-production" class="page" style="padding-bottom: 80px;">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="settings" class="w-6 h-6 text-green-600"></i>
                        ????? ????????? (????? ???????)
                    </h3>
                    <button id="create-production-btn" onclick="window.openCreateProductionModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> ?????? ?????
                    </button>
                </div>

                <div class="p-4 rounded-lg bg-green-50 border border-green-200 text-sm leading-relaxed mb-6">
                    ????? ??????? ????? ????? ????? ??? ???????. ?? ?????? ????? ?? ????? ??? ????????? ?? ????? ??????? ????? ??????? ???????? ????????.
                </div>

                <!-- Tabs for viewing productions -->
                <div class="flex gap-2 mb-4 border-b">
                    <button id="tab-active-productions" class="px-4 py-2 font-semibold text-green-600 border-b-2 border-green-600">????????? ???????</button>
                    <button id="tab-completed-productions" class="px-4 py-2 font-semibold text-gray-600 hover:text-gray-800">????????? ????????</button>
                </div>

                <!-- Active Productions Table -->
                <div id="active-productions-section" class="mb-6">
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">??? ????????</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">??????</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">??????</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">????? ?????</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">?????? ????????</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">??????</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">?????????</th>
                                </tr>
                            </thead>
                            <tbody id="active-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="no-active-productions" class="text-center py-6 text-gray-500">?? ???? ??????? ????? ??????</div>
                </div>

                <!-- Completed Productions Table -->
                <div id="completed-productions-section" class="mb-6 hidden">
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">??? ????????</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">??????</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">?????? ????????</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">??????? ?????????</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">??? ?????</th>
                                    <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">?????/???????</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">????? ????????</th>
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">?????????</th>
                                </tr>
                            </thead>
                            <tbody id="completed-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="no-completed-productions" class="text-center py-6 text-gray-500">?? ???? ??????? ?????? ??????</div>
                </div>
            </div>

            <div id="page-total-bills" class="page">
                <div id="total-bills-content-wrapper">
                    <h2 class="text-xl font-bold mb-4">?????? ????????</h2>

                    <!-- Filter Controls -->
                    <div id="total-bills-filters" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label for="filter-from-date" class="block text-sm font-medium text-gray-700">?? ?????</label>
                                <input type="date" id="filter-from-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-to-date" class="block text-sm font-medium text-gray-700">??? ?????</label>
                                <input type="date" id="filter-to-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-customer-name" class="block text-sm font-medium text-gray-700">??? ??????</label>
                                <input type="text" id="filter-customer-name" placeholder="???..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-invoice-number" class="block text-sm font-medium text-gray-700">??? ????????</label>
                                <input type="number" id="filter-invoice-number" placeholder="???..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="flex flex-col gap-1">
                                <button id="reset-to-current-month-btn" class="bg-gray-500 text-white py-1 px-2 rounded-lg hover:bg-gray-600 text-sm">????? ??????</button>
                                <button id="apply-filters-btn" class="bg-blue-600 text-white py-1 px-2 rounded-lg hover:bg-blue-700">????? ???????</button>
                            </div>
                        </div>
                    </div>

                    <!-- Total Display -->
                    <div id="total-bills-summary-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg mb-4 text-center shadow-md flex items-center justify-center gap-4">
                        <div>
                            <span class="font-semibold">?????? ???????? ????????:</span>
                            <span id="total-bills-summary-amount" class="font-bold text-green-800">0 ?.?</span>
                        </div>
                        <div class="flex items-center border-r-2 border-green-300 pr-4">
                            <input type="checkbox" id="include-total-in-export" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                            <label for="include-total-in-export" class="mr-2 text-sm font-medium text-green-900">????? ????????</label>
                        </div>
                    </div>

                    <!-- Bills Table -->
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table id="total-bills-table" class="min-w-full divide-y divide-gray-200">
                                                                            <thead class="bg-gray-50">
                                                                                <tr>
                                                                                    <th class="p-4"><input type="checkbox" id="select-all-total-bills"></th>
                                                                                    <th data-sort="date" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">???????</th>                                                            <th data-sort="invoiceNumber" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">??? ????????</th>
                                                            <th data-sort="customerName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">??? ??????</th>
                                                            <th data-sort="repName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">??? ???????</th>
                                                            <th data-sort="total" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">?????? ????????</th>
                                                            <th data-sort="status" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">?????/??????</th>
                                                            <th data-sort="category" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">?????/?????</th>
                                                        </tr>
                                                    </thead>                            <tbody id="total-bills-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be injected by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('total-bills-content-wrapper')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> ????? ????</button>
                    <button onclick="generateReportImage('total-bills-content-wrapper')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> ??? ???? ?????</button>
                </div>
                <div class="mt-2 p-3 border-t-2 border-dashed no-print">
                    <div class="flex gap-2">
                        <button onclick="exportSelectedRows('print')" class="w-1/2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> ????? ??????</button>
                        <button onclick="exportSelectedRows('image')" class="w-1/2 bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> ??? ?????? ?????</button>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="space-y-6">
                    <!-- ???? ???? ???? ???? ????????? -->
                    <!-- ???? ?????? ?????? ???????? ?? ?????? ????? ????? ???????? -->
                    <div class="flex items-center justify-end gap-2 no-print">
                        <button id="open-user-management-btn" class="bg-purple-600 text-white px-3 py-2 rounded-md text-sm hover:bg-purple-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            ????? ??????????
                        </button>
                    </div>
                    <!-- ????? ?????????? ???????? (??????? ???) -->
                    <div id="user-management-section" class="p-4 border rounded-lg bg-white hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">????? ??????????</h3>
                            <button id="refresh-users-btn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-gray-300">?????</button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">????? ????? ?????? ?? ?????? (admin, rep, viewer). ????????? ????? ????? ?? Firestore.</p>
                        <div id="user-role-warning" class="p-2 mb-2 rounded border border-yellow-300 bg-yellow-50 text-yellow-800 hidden"></div>
                        <div class="mb-3 flex flex-wrap gap-2 items-center">
                            <button id="seed-missing-roles-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-plus"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M9 12h6"/><path d="M12 9v6"/></svg>
                                ????? ??????? ???????
                            </button>
                            <span id="seed-roles-status" class="text-xs text-gray-600"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-right">?????</th>
                                        <th class="px-2 py-2 text-right">??????</th>
                                        <th class="px-2 py-2 text-center">?????</th>
                                        <th class="px-2 py-2 text-center">???????</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="bg-white divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- ???? ?????: ?????? ???? ????? ??????? -->
                    <div>
                        <h3 class="text-lg font-bold mb-1">?????? ??????? ????????</h3>
                        <p class="text-xs text-gray-500 mb-2">???? ????? ???????? ???????. ???? ??????? ???????? ?????? ??????? ?????? ?????? ??? ??? ???? ?? ???.</p>
                        <div class="flex items-center gap-2">
                            <input type="month" id="active-period-input" class="p-2 border rounded-md" />
                            <button id="active-period-today-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-300">????? ??????</button>
                            <span id="active-period-indicator" class="text-sm text-gray-600 ml-auto"></span>
                        </div>
                    </div>

                    <!-- ???? ???? ???????? (GPS) -->
                    <div id="gps-settings" class="p-4 border rounded-lg bg-white">
                        <h3 class="text-lg font-bold mb-2">???? ???? ???????? (GPS)</h3>
                        <div class="flex items-center gap-2 mb-1">
                            <input type="checkbox" id="gps-share-toggle" class="w-4 h-4">
                            <label for="gps-share-toggle" class="text-sm">?????? ????? ?? ??? ??????</label>
                            <span id="gps-share-status" class="text-xs text-gray-600 ml-auto"></span>
                        </div>
                        <p class="text-xs text-gray-500">??? ???????? ????? ??????? ??? ?????? ?????? ???? ????? ?????????? ?????? ?? ???????.</p>
                        <div id="admin-gps-list" class="mt-3 hidden">
                            <h4 class="font-semibold mb-1">????? ???????? ????</h4>
                            <div id="rep-locations-list" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2">????? ?????? ????? ????????</h3>
                        <p class="text-xs text-gray-500 mb-2">??? ?? ????? ????????? (?????? ?? ??? ??? ?????? ????? ???? ?? ???? ?????????).</p>
                        <div class="flex items-center gap-2">
                            <input type="number" id="sales-target-input" class="w-full p-2 border rounded-md" placeholder="???? ????? ??????">
                            <button id="save-target-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">???</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold">???? ??????</h3>
                        <p class="text-xs text-gray-500 mb-2">???? ???? ?????? (URL) ????? ?? ??? ??????? ?????????. ????? ??????? ???? ??? ???? ????? file:///C:/... ??? ????? ??????? ??????? ?? ??? ?????? ??? ??????? ?? ??? ?????? ???.</p>
                        <div class="flex items-center gap-2">
                            <input type="text" id="company-logo-input" class="w-full p-2 border rounded-md" placeholder="https://example.com/logo.jpg ?? file:///C:/Users/.../logo.jpg">
                            <button id="save-company-logo-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">???</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">?????: ?????? ?????? ??? ????? ????? ?????? ????? ??? imgur.com ?? GitHub (repo ?? gist) ?? ?? ??????? ??? ????.</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">?????? ????????</h3>
                            <button id="add-product-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">????? ????</button>
                        </div>
                        <input id="search-products" type="text" placeholder="???? ?? ????..." class="w-full p-2 border rounded-md mb-2">
                        <div id="products-list" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>
                    
                    <!-- ????? ??????? (??????? ??? ?? ????????? ??? ???? ??? ???????) -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">????? ???????</h3>
                            <button id="add-price-list-btn" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700">????? ?????</button>
                        </div>
                        <div id="price-lists-container" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-2">????? ????????? ??????????</h3>
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-4">
                            <div>
                                <h4 class="font-semibold mb-2">1. ??? ???????? (Backup) </h4>
                                <p class="text-xs text-gray-600 mb-2">???? ?????? ??? ????? ??? ?? ??????? (?????? ??????? ??????? ??????). ???? ??? ????? ?????? ?? ?? ???? ???.</p>
                                <button id="backup-data-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-2">????? ???? ???????? ????</button>
                                <textarea id="backup-data-textarea" class="w-full p-2 border rounded-md bg-gray-200" readonly placeholder="????? ??? ?????? ?????????? ???..."></textarea>
                                <button id="copy-backup-btn" class="w-full mt-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 hidden">??? ?????</button>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-2">2. ??????? ???????? (Restore)</h4>
                                <p class="text-xs text-gray-600 mb-2">???? ????? ???? ????? ?????? ??? ???????? ???????. <strong class="text-red-600">?????: ??? ??????? ???? ???????? ???????.</strong></p>
                                <textarea id="restore-data-textarea" class="w-full p-2 border rounded-md" style="height: 100px;" placeholder="???? ??? ?????? ?????????? ???..."></textarea>
                                <button id="restore-data-btn" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">??????? ????????</button>
                            </div>
                        </div>
                    </div>

                    <!-- ???? ??????? ??? ??????? (Firestore) - ?????? ??? -->
                    <div id="admin-cloud-import-section" class="p-4 border-2 border-yellow-300 rounded-lg bg-yellow-50 space-y-3 no-print hidden">
                        <h3 class="text-lg font-bold">??????? ???? ????? ??? ??????? (Firestore)</h3>
                        <p class="text-xs text-gray-700">??? ?????? ???? ??????? ??? ?????? ?????????? ?????? (JSON ?? TXT) ??????? ??? ????? Firestore (customers, products, priceLists, reps, sales...). ???? ??? ?????????? ??? ?????? admin.</p>
                        <div class="flex items-center gap-2">
                            <input id="admin-import-file" type="file" accept=".json,.txt,application/json,text/plain" class="flex-1 p-2 border rounded-md bg-white" />
                            <button id="admin-start-import-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed">??? ?????????</button>
                        </div>
                        <div id="admin-import-status" class="text-sm text-gray-700"></div>
                    </div>
                </div>
            <!-- (????? ??????? ???? ?????? ?? ???? ????????? - ?? ????? ??????? ??? ?????? ???? ?????????) -->
        </main>

        <!-- Reports Subnav (Moved functionality to Dashboard, kept hidden nav item for consistency) -->
        <nav id="reports-subnav" class="fixed left-0 right-0 mx-auto justify-around p-2 no-print">
            <button data-report-section="daily" class="reports-subnav-item active">
                <i data-lucide="calendar"></i><span>????</span>
            </button>
            <button data-report-section="range" class="reports-subnav-item">
                <i data-lucide="calendar-range"></i><span>????</span>
            </button>
            <button data-report-section="monthly" class="reports-subnav-item">
                <i data-lucide="calendar"></i><span>????</span>
            </button>
            <button data-report-section="reconciliation" class="reports-subnav-item">
                <i data-lucide="scale"></i><span>??????? ????????</span>
            </button>
            <button data-report-section="targets" class="reports-subnav-item">
                <i data-lucide="target"></i><span>????? ????????</span>
            </button>
            <button data-report-section="customer-targets" class="reports-subnav-item">
                <i data-lucide="users"></i><span>????? ???????</span>
            </button>
        </nav>

        <!-- Costs Page: ???????? (?????) -->
            <div id="page-costs" class="page" style="display:none; padding-bottom: 80px;">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="flask-conical" class="w-6 h-6 text-blue-600"></i>
                        ???? ????? ??????
                    </h3>
                    <div class="flex items-center gap-2">
                    <button id="add-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> ???? ????
                    </button>
                    <button id="save-and-produce-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1" style="display:none;">
                        <i data-lucide="check" class="w-4 h-4"></i> ??? ?????? ??????
                    </button>
                    <!-- ????? ????? ????????? ?????? ????????. ????????? ????? ?????? ??? ?????? ?????? ?? ???. -->
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm leading-relaxed mb-6">
                    ???? ??????? (?????)? ???? ?????? ??????? ????? ??? <span class="font-bold">???? ?????</span>. ???? ?????? ??????? ????????? ?????? ??????/?????? ????????.
                    ????: ???? "???? ????" ???? 50 ??? ?? ????? ???? ????? (???? ??? ???? ?????)? ???????? ?????? ?? ??????? (?????? ??????)? ?? ????? ??????? (??????? ????) ??????? ?????????.
                </div>
                <!-- Price Manager (Raw, Pack, Ops) -->

                <!-- Unified Price Grid (Printable Overview) -->
                <details id="unified-price-grid-block" class="mb-6 bg-white rounded-lg border">
                    <summary class="cursor-pointer select-none px-4 py-3 flex items-center gap-2 text-sm font-semibold">
                        <i data-lucide="table" class="w-4 h-4 text-indigo-600"></i>
                        ???? ????? ??? ???????
                        <span id="unified-grid-summary" class="ml-auto text-gray-500 text-xs"></span>
                    </summary>
                    <div class="px-4 pb-4 pt-2 space-y-3">
                        <div class="flex flex-wrap gap-2 text-xs">
                            <button type="button" id="unified-refresh-btn" class="px-3 py-1 rounded bg-indigo-600 text-white">?????</button>
                            <button type="button" id="unified-print-btn" class="px-3 py-1 rounded bg-gray-200 text-gray-800">?????</button>
                            <button type="button" id="unified-export-json-btn" class="px-3 py-1 rounded bg-green-600 text-white">????? JSON</button>
                            <button type="button" id="unified-export-csv-btn" class="px-3 py-1 rounded bg-emerald-500 text-white">????? CSV</button>
                        </div>
                        <div class="overflow-x-auto border rounded">
                            <table id="unified-price-grid" class="min-w-full divide-y divide-gray-200 text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-right px-2 py-1">?????</th>
                                        <th class="text-center px-2 py-1">?????</th>
                                        <th class="text-center px-2 py-1">?????</th>
                                        <th class="text-center px-2 py-1">??????</th>
                                        <th class="text-center px-2 py-1">????? ??????</th>
                                        <th class="text-center px-2 py-1">??? ????</th>
                                        <th class="text-center px-2 py-1">??? ?????</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="text-[11px] text-gray-500">??? ?????? ????? ?????? ?? ?????? ?????? ???????. ?? ????? ??????? ??? ?? ???? ??? ????? ??????? ?????.</div>
                    </div>
                </details>
                <div id="recipes-list" class="space-y-6"></div>
            </div>

            <!-- Taxes Page -->
            <div id="page-taxes" class="page" style="display:none; padding-bottom:80px;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="percent" class="w-6 h-6 text-blue-600"></i>
                        <span>???????</span>
                    </h2>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-medium">???? ?????</label>
                        <input id="tax-month-input" type="month" class="p-2 border rounded-md">
                        <button id="tax-refresh-btn" class="bg-blue-600 text-white px-3 py-2 rounded-md">???</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex gap-2 mb-3">
                        <button id="tax-tab-report" class="px-3 py-2 bg-gray-100 rounded">????? ?????? ???????</button>
                        <button id="tax-tab-einvoices" class="px-3 py-2 bg-white rounded">??? ????????</button>
                    </div>

                    <div id="tax-tab-content">
                        <!-- Report Tab -->
                        <div id="tax-report-tab">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">?????? ???????? ???????</div>
                                    <div id="tax-total-sales" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">??????? ??????? (Output VAT)</div>
                                    <div id="tax-output-vat" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">??????? ??????? (Input VAT)</div>
                                    <div id="tax-input-vat" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="p-4 border rounded text-center">
                                    <div class="text-sm text-gray-500">?????? ???????</div>
                                    <div id="tax-net-payable" class="text-2xl font-bold">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- E-Invoice Log Tab -->
                        <div id="tax-einvoices-tab" style="display:none;">
                            <div class="overflow-x-auto mt-3">
                                <table class="w-full table-auto border-collapse">
                                    <thead>
                                        <tr class="text-sm text-gray-600">
                                            <th class="p-2 text-left">Invoice #</th>
                                            <th class="p-2 text-left">Date</th>
                                            <th class="p-2 text-left">Customer</th>
                                            <th class="p-2 text-right">Total</th>
                                            <th class="p-2 text-left">UUID</th>
                                            <th class="p-2 text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="einvoice-log-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Main Bottom Nav - Adjusted buttons after moving reports -->
        <nav id="main-nav-bar" class="bottom-nav fixed bottom-0 left-0 right-0 mx-auto bg-white border-t shadow-t p-2 flex justify-around no-print">
            <button data-page="dashboard" class="bottom-nav-item active flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                <span class="text-xs">????????</span>
            </button>
            <button data-page="spreadsheet-entry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-table"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                <span class="text-xs">????? ????</span>
            </button>
            <!-- BUTTON FOR SALES PAGE (Search, view all invoices) -->
            <button data-page="sales" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6"/><path d="M16 12h-6"/><path d="M16 16h-6"/></svg>
                <span class="text-xs">????????</span>
            </button>
            <button data-page="dispatch" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>
                <span class="text-xs">????????</span>
            </button>
            <!-- REPORTS BUTTON RETAINED, NOW GOES TO DEDICATED REPORTS PAGE -->
            <button data-page="reports" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                <span class="text-xs">????????</span>
            </button>
            <!-- TAXES Button -->
            <button data-page="taxes" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><path d="M21 12A9 9 0 1 1 3 12 9 9 0 0 1 21 12z"/><path d="M9 9h.01"/><path d="M15 15h.01"/><path d="M7 17l10-10"/></svg>
                <span class="text-xs">???????</span>
            </button>
            <!-- COSTS / ???????? Button -->
            <button id="costs-nav-btn" data-page="costs" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layers"><path d="M12 2 1 7l11 5 11-5L12 2z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                <span class="text-xs">????????</span>
            </button>
            <!-- NEW: Production / ????????? Button -->
            <button id="production-nav-btn" data-page="production" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.08 5.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08-5.08l4.24-4.24"/></svg>
                <span class="text-xs">?????????</span>
            </button>
            <button data-page="promotions" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
                <span class="text-xs">??????</span>
            </button>
            <button data-page="customers" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span class="text-xs">???????</span>
            </button>
            <button data-page="reps" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2"><path d="M14 19a6 6 0 0 0-12 0"/><circle cx="8" cy="9" r="4"/><path d="M22 19a6 6 0 0 0-6-6 4 4 0 1 0 0-8"/></svg>
                <span class="text-xs">????????</span>
            </button>
            <!-- NEW: Cash (?????) Button -->
            <button id="cash-nav-btn" data-page="cash" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                <span class="text-xs">?????</span>
            </button>

            <!-- NEW: Debts (??????????) Button -->
            <button id="debts-nav-btn" data-page="debts" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <!-- Using a simple wallet/credit icon similar to design -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M21 12v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h14"/><path d="M16 3v4"/><path d="M8 12h.01"/></svg>
                <span class="text-xs">??????????</span>
            </button>
            <button data-page="stock-control" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                <span class="text-xs">???? ??????</span>
            </button>
            <button data-page="total-bills" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                <span class="text-xs">?????? ????????</span>
            </button>
            <!-- NEW: Inquiry (???????) Button -->
            <button data-page="inquiry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-xs">???????</span>
            </button>
            <!-- NEW: Price Lists (????? ???????) Button -->
            <button data-page="price-lists" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-dollar-sign"><path d="M7 21h10"/><path d="M12 17v-6"/><path d="M9 14h6"/><path d="M12 9h.01"/><path d="M12 3 2 9l10 6 10-6Z"/></svg>
                <span class="text-xs">????? ???????</span>
            </button>
            <button data-page="settings" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                <span class="text-xs">?????????</span>
            </button>
        </nav>
    </div>

    <!-- ########## MODALS ########## -->

    <!-- CUSTOM CONFIRMATION/ALERT DIALOG -->
    <div id="custom-confirm-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 id="dialog-title" class="text-xl font-bold mb-4">?????</h2>
            <p id="dialog-message" class="text-gray-700 mb-6"></p>
            <div id="dialog-actions" class="flex justify-end gap-3">
                <button id="dialog-cancel-btn" type="button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 hidden">?????</button>
                <button id="dialog-confirm-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">?????</button>
            </div>
        </div>
    </div>

    <!-- PRICE HISTORY MODAL -->
    <div id="price-history-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="ph-title" class="text-xl font-bold">??? ???????</h2>
                <button id="ph-close-btn" type="button" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">?????</button>
            </div>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="text-center px-2 py-1">?????</th>
                            <th class="text-center px-2 py-1">???????</th>
                            <th class="text-right px-2 py-1">??????</th>
                        </tr>
                    </thead>
                    <tbody id="ph-body"></tbody>
                </table>
            </div>
            <div class="flex items-end gap-2">
                <div class="flex-1">
                    <label class="block text-xs text-gray-600 mb-1">??? ????</label>
                    <input id="ph-new-price" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="0.00" />
                </div>
                <div class="flex-[2]">
                    <label class="block text-xs text-gray-600 mb-1">?????? (???????)</label>
                    <input id="ph-new-note" class="w-full p-2 border rounded" placeholder="????/??????" />
                </div>
                <button id="ph-add-btn" class="bg-blue-600 text-white px-3 py-2 rounded h-[42px]">?????</button>
            </div>
        </div>
    </div>
    
    <!-- LOADING MODAL -->
    <div id="loading-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4">
            <div class="loader"></div>
            <p id="loading-message" class="text-lg font-semibold text-gray-700">???? ???????...</p>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 class="text-xl font-bold mb-4">????? ??????</h2>
            <form id="login-modal-form">
                <div class="mb-4">
                    <label for="login-email-modal" class="block text-sm font-medium text-gray-700">?????? ??????????</label>
                    <input type="email" id="login-email-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="login-password-modal" class="block text-sm font-medium text-gray-700">???? ??????</label>
                    <div class="relative">
                        <input type="password" id="login-password-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md pr-10" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password-modal" title="?????/?????">???</button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold">????? ??????</button>
            </form>
        </div>
    </div>

    <!-- DEBTS SUMMARY MODAL (??????????) -->
    <div id="debts-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right" style="display:none !important">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">???? ??????????</h2>
                <button type="button" onclick="closeModal(document.getElementById('debts-summary-modal'))" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">?????</button>
            </div>

            <div id="debts-summary-content" class="space-y-4">
                <div>
                    <h3 class="font-bold">?????????? ??? ???????</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-customer" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">??? ??????</th>
                                    <th class="text-center px-2 py-1">?????? ????????</th>
                                    <th class="text-center px-2 py-1">??????</th>
                                    <th class="text-center px-2 py-1">???????</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
    
                    <!-- MANAGE LISTS MODAL -->
                    <div id="manage-lists-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">????? ???????</h2>
                                <button type="button" onclick="closeManageListsModal()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">?????</button>
                            </div>

                            <!-- progress area: updated while chunked rendering proceeds -->
                            <div id="manage-lists-progress" class="mb-3 text-sm text-gray-600" style="display:none">???? ????? ???????...</div>

                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-bold">???????? ??????</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-finished-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">?????</th><th class="text-center px-2 py-1">??????</th><th class="text-center px-2 py-1">???</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">??????? (???? ?????)</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-raw-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">?????</th><th class="text-center px-2 py-1">??????</th><th class="text-center px-2 py-1">?????</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">???????/???????</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-pack-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">?????</th><th class="text-center px-2 py-1">??????</th><th class="text-center px-2 py-1">?????</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="pt-3 border-t flex justify-between items-center">
                                    <div class="text-sm text-gray-600">????? ??? ?? ???? ?? ??????? ?? ????? ??????? ??????.</div>
                                    <div>
                                        <button id="manage-export-btn" class="bg-green-600 text-white px-3 py-1 rounded">????? ???????</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <div>
                    <h3 class="font-bold">?????????? ??? ???????</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-rep" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">??? ???????</th>
                                    <th class="text-center px-2 py-1">?????? ????????</th>
                                    <th class="text-center px-2 py-1">??????</th>
                                    <th class="text-center px-2 py-1">???????</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="pt-3 border-t">
                    <div class="flex justify-between items-center">
                        <div class="font-bold">?????? ?????????? (???????)</div>
                        <div id="debts-summary-total" class="font-extrabold text-lg">0 ?.?</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW FULL-SCREEN SALE MODAL (for detailed single entry) -->
    <div id="sale-modal" class="modal modal-hidden fixed inset-0 bg-gray-100 z-30 flex flex-col">
        <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center no-print">
            <h2 id="sale-modal-title" class="text-xl font-bold">????? ????? ???</h2>
            <button id="cancel-sale-btn" class="p-2 hover:bg-blue-700 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        </header>

        <main class="flex-grow p-4 overflow-y-auto">
            <form id="sale-form">
                <input type="hidden" id="sale-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="sale-rep" class="block text-sm font-medium text-gray-700">???????</label>
                        <select id="sale-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        <input type="text" id="sale-rep-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
                    </div>
                    <div>
                        <label for="sale-customer" class="block text-sm font-medium text-gray-700">??????</label>
                        <select id="sale-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        <input type="text" id="sale-customer-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
                    </div>
                    <div>
                        <label for="sale-date" class="block text-sm font-medium text-gray-700">????? ????????</label>
                        <input type="date" id="sale-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="sale-invoice-number" class="block text-sm font-medium text-gray-700">??? ???????? (????)</label>
                        <input type="number" id="sale-invoice-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="???? ??? ???????? ?? ??????">
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="sale-items-table min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase w-2/5">??????</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">??????</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">?????</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">????????</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="sale-items-container" class="bg-white divide-y divide-gray-200">
                            <!-- Sale item rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-sale-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    ????? ???? ???
                </button>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="sale-notes" class="block text-sm font-medium text-gray-700">???????</label>
                        <textarea id="sale-notes" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="sale-status" class="block text-sm font-medium text-gray-700">???? ?????</label>
                                <select id="sale-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="paid">????? ???????</option>
                                    <option value="due">???</option>
                                    <option value="partial">????? ??????</option>
                                </select>
                            </div>
                            <div id="paid-amount-container" class="hidden">
                                <label for="sale-paid-amount" class="block text-sm font-medium text-gray-700">?????? ???????</label>
                                <input type="number" id="sale-paid-amount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            </div>
                        </div>
                        <div>
                            <label for="sale-discount" class="block text-sm font-medium text-gray-700">??? ??? ???????? (%)</label>
                            <input type="number" id="sale-discount" placeholder="????: 2 ?? 3.5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                        </div>
                        <div>
                            <label for="sale-addition" class="block text-sm font-medium text-gray-700">????? ??? ???????? (%)</label>
                            <input type="number" id="sale-addition" placeholder="????: 14" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            <p class="text-xs text-gray-500 mt-1">??? ?????? ?????? ??? ???????? ?????? (??? ?????).</p>
                        </div>
                    </div>
                </div>
            </form>
        </main>

        <footer class="p-4 bg-white border-t no-print">
            <div id="sale-summary" class="max-w-md ml-auto text-lg space-y-2">
                <div class="flex justify-between"><span>???????? ??????:</span><span id="sale-subtotal-text">0 ?.?</span></div>
                <div class="flex justify-between text-red-600"><span>?????:</span><span id="sale-discount-text">0 ?.?</span></div>
                <div class="flex justify-between"><span>????? ?????? ??????? (VAT):</span><span id="sale-vat-text">0 ?.?</span></div>
                <div class="flex justify-between"><span>????????? (1% ?? ??? ?????? ??? ????? ???????):</span><span id="sale-withholding-text">0 ?.?</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold text-2xl"><span>?????? ??? ??????? ???????????:</span><span id="sale-final-text">0 ?.?</span></div>
                <div class="flex justify-between font-bold text-2xl"><span style="opacity:0.75">?????? (??? ????)</span><span id="sale-total-text" style="opacity:0.6">0 ?.?</span></div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="eta-upload-from-modal-btn" class="hidden bg-purple-700 text-white px-6 py-3 rounded-lg hover:bg-purple-800 font-bold text-lg flex items-center gap-2">
                    <i data-lucide="cloud-upload" class="w-5 h-5"></i>
                    ????? ???????
                </button>
                <button type="submit" form="sale-form" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg">??? ????????</button>
            </div>
        </footer>
    </div>
    
    <!-- CUSTOMER MODAL -->
    <div id="customer-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="customer-modal-title" class="text-xl font-bold mb-4">????? ???? ????</h2>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="mb-4">
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">??? ??????</label>
                    <input type="text" id="customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <!-- NEW: Tax Number Input -->
                <div class="mb-4">
                    <label for="customer-tax-number" class="block text-sm font-medium text-gray-700">????? ???????</label>
                    <input type="text" id="customer-tax-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="???? ????? ???????">
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-phone" class="block text-sm font-medium text-gray-700">??? ??????</label>
                    <input type="tel" id="customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="customer-address" class="block text-sm font-medium text-gray-700">??????? (???? ????? ????)</label>
                    <input type="text" id="customer-address" placeholder="???? ???? ????? ???? ???..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <!-- NEW: Requires Tax Filing Checkbox -->
                <div class="mb-4 flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <input type="checkbox" id="customer-requires-tax" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 ml-2">
                    <label for="customer-requires-tax" class="block text-sm font-medium text-orange-800">?????? ????? ??? ??????? ??????? ???????</label>
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-price-list" class="block text-sm font-medium text-gray-700">????? ???????</label>
                    <select id="customer-price-list" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="mb-4">
                    <label for="customer-rep" class="block text-sm font-medium text-gray-700">??????? ???????</label>
                    <select id="customer-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-customer-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">??? ??????</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PLACEHOLDER MODALS -->
    <div id="rep-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="rep-modal-title" class="text-xl font-bold mb-4">????? ?????</h2>
            <form id="rep-form">
                <input type="hidden" id="rep-id">
                <div class="mb-4"><label for="rep-name" class="block text-sm font-medium text-gray-700">??? ???????</label><input type="text" id="rep-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="rep-email" class="block text-sm font-medium text-gray-700">?????? ?????????? ???????</label><input type="email" id="rep-email" class="mt-1 block w-full p-2 border rounded-md" placeholder="example@email.com" required></div>
                <div class="mb-4"><label for="rep-serial" class="block text-sm font-medium text-gray-700">???/??????</label><input type="text" id="rep-serial" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="mb-4"><label for="rep-target" class="block text-sm font-medium text-gray-700">????? ??????</label><input type="number" id="rep-target" class="mt-1 block w-full p-2 border rounded-md" value="0"></div>
                <div class="mb-4"><label for="rep-next-invoice" class="block text-sm font-medium text-gray-700">??? ???????? ???????</label><input type="number" id="rep-next-invoice" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-rep-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">?????</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">??? ???????</button></div>
            </form>
        </div>
    </div>

    <div id="product-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="product-modal-title" class="text-xl font-bold mb-4">????? ????</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="mb-4"><label for="product-code" class="block text-sm font-medium text-gray-700">??? ??????</label><input type="text" id="product-code" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="product-name" class="block text-sm font-medium text-gray-700">??? ??????</label><input type="text" id="product-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="product-price" class="block text-sm font-medium text-gray-700">????? ?????????</label><input type="number" id="product-price" class="mt-1 block w-full p-2 border rounded-md" step="any" required></div>
                <div class="mb-4"><label for="product-category" class="block text-sm font-medium text-gray-700">????? (???????)</label><input type="text" id="product-category" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="mb-4"><label for="product-vat-rate" class="block text-sm font-medium text-gray-700">???? ??????? ??? ???? (%)</label><input type="number" id="product-vat-rate" class="mt-1 block w-full p-2 border rounded-md" step="0.01" value="0"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-product-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">?????</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">??? ??????</button></div>
            </form>
        </div>
    </div>
    
    <div id="price-list-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-4 modal-body">
            <h2 id="price-list-modal-title" class="text-xl font-bold mb-2">????? ????? ?????</h2>
            <!-- Quick discount box (editable) -->
            <div class="flex items-center justify-start gap-3 mb-3">
                <label for="price-list-discount" class="text-sm text-gray-700">???? ????? ??????</label>
                <input id="price-list-discount" type="text" value="5%" class="w-16 p-1 border rounded text-center font-bold bg-white" title="???? ???? ????? ??? 5% ?? 10%" />
                <span class="text-xs text-gray-500">(???? ??? ????? ??? ????? ?? ?????? ??????)</span>
            </div>
            <form id="price-list-form">
                <input type="hidden" id="price-list-id">
                <div class="mb-4"><label for="price-list-name" class="block text-sm font-medium text-gray-700">??? ???????</label><input type="text" id="price-list-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <!-- Replaced products list with an Excel-like table view (keeps same id to preserve JS bindings) -->
                <div id="price-list-products" class="overflow-x-auto max-h-[60vh] border rounded-lg bg-white">
                    <table id="price-list-products-table" class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-right">?</th>
                                <th class="px-3 py-2 text-center">?????</th>
                                <th class="px-3 py-2 text-right">??? ?????</th>
                                <th class="px-3 py-2 text-center">??????</th>
                                <th class="px-3 py-2 text-center">????????</th>
                                <th class="px-3 py-2 text-center">?????</th>
                                <th class="px-3 py-2 text-center">????? ??? ?????</th>
                            </tr>
                        </thead>
                        <tbody id="price-list-products-body" class="bg-white">
                            <tr>
                                <td colspan="7" class="text-center text-gray-500 p-6">???? ????? ????????...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-price-list-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">?????</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">??? ???????</button></div>
            </form>
        </div>
    </div>

    <!-- NEW PROMOTION MODAL -->
    <div id="promotion-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="promotion-modal-title" class="text-xl font-bold mb-4">????? ??? ????</h2>
            <form id="promotion-form">
                <input type="hidden" id="promotion-id">
                <div class="mb-4">
                    <label for="promotion-name" class="block text-sm font-medium text-gray-700">??? ?????</label>
                    <input type="text" id="promotion-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="promotion-product" class="block text-sm font-medium text-gray-700">??????</label>
                    <select id="promotion-product" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                </div>
                <div id="original-price-display" class="mb-2 text-sm text-gray-600 hidden">
                    ????? ????????? ??????: <span id="current-product-price" class="font-bold"></span>
                </div>
                 <div class="mb-4">
                    <label for="promotion-price" class="block text-sm font-medium text-gray-700">??? ?????</label>
                    <input type="number" id="promotion-price" class="mt-1 block w-full p-2 border border-red-400 bg-red-50 rounded-md font-bold" required step="any" placeholder="????? ??????">
                </div>
                <div class="mb-4">
                    <label for="promotion-customer-id" class="block text-sm font-medium text-gray-700">?????? ???????? (???????)</label>
                    <select id="promotion-customer-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    <p class="text-xs text-gray-500 mt-1">??? ?? ???? ??????? ???? ????? ????? ??? **????** ???????.</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="promotion-start-date" class="block text-sm font-medium text-gray-700">????? ???????</label>
                        <input type="date" id="promotion-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="promotion-end-date" class="block text-sm font-medium text-gray-700">????? ????????</label>
                        <input type="date" id="promotion-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-promotion-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">??? ?????</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END PROMOTION MODAL -->

    <!-- NOTIFICATION (?????) MODAL -->
    <div id="notify-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="notify-modal-title" class="text-xl font-bold">?????</h2>
                <button type="button" onclick="closeNotifyModal()" class="p-2 hover:bg-gray-100 rounded-md">?????</button>
            </div>
            <form id="notify-form">
                <input type="hidden" id="notify-type" value="">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-sm font-medium">????? ??????? (??????)</label>
                        <input id="notify-title" type="text" maxlength="40" placeholder="????: ????? ???" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="text-sm font-medium">?????</label>
                        <select id="notify-type-select" class="mt-1 block w-full p-2 border rounded-md">
                            <option value="prices">????? ???</option>
                            <option value="new-item">??? ????</option>
                            <option value="promotions">???</option>
                        </select>
                    </div>
                </div>

                <div id="notify-product-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">???? ???</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-product"></select>
                </div>

                <div id="notify-promo-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">???? ???</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-promo"></select>
                </div>

                <div id="notify-new-item-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">??? ????? ??????</label>
                    <input type="text" id="notify-new-item-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="???? ??? ????? ??????">
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">????? ??????? ???????? (???? ??? Excel)</label>
                    <div class="mt-2 mb-2 grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-500">???? ???? (???????)</label>
                            <select id="notify-customer" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">??? ??? % (????? ??? ?? ??????)</label>
                            <input id="notify-global-discount" type="number" min="0" max="100" step="0.01" placeholder="0" class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <div class="mt-2 mb-2 flex gap-2">
                        <button type="button" id="notify-add-row-btn" class="bg-gray-100 px-3 py-1 rounded-md">????? ??</button>
                        <button type="button" id="notify-paste-btn" class="bg-gray-100 px-3 py-1 rounded-md">??? ?? Excel</button>
                    </div>
                    <div class="overflow-x-auto border rounded">
                        <table class="min-w-full text-sm" id="notify-rows-table">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-right">???</th>
                                <th class="px-2 py-2 text-right">???</th>
                                <th class="px-2 py-2 text-center">???</th>
                                <th class="px-2 py-2 text-center">??? %</th>
                                <th class="px-2 py-2 text-center">??? ??? ?????</th>
                                <th class="px-2 py-2"></th>
                            </tr></thead>
                            <tbody id="notify-rows-body"><tr><td colspan="6" class="text-center text-gray-500 p-4">?? ???? ???? ???.</td></tr></tbody>
                        </table>
                    </div>
                    <textarea id="notify-paste-area" placeholder="???? ?????? Excel ??? (???\t???\t???\t???%)" class="w-full mt-2 p-2 border rounded-md" style="display:none;min-height:80px"></textarea>
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">?? ???? (???????)</label>
                    <input id="notify-short-text" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="??? ???? ???? ?? ??????? ???????? ?? ??????">
                </div>
                <div class="mb-3">
                    <label class="text-sm font-medium">???? ???? ?????? (???????)</label>
                    <input id="notify-logo-url" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="https://example.com/logo.png - ????? ????? ?? ???????">
                    <p class="text-xs text-gray-500 mt-1">??????: ?????? ???? ?????? ??? ?????? ????? ??? ?????? ??? URL ???? ?? ??????? ????? ?????? ?????? ?????. ??? ????? ???? ?????? ???? ????.</p>
                </div>

                <div class="flex justify-between items-center gap-2">
                    <div class="flex gap-2">
                        <button type="button" id="notify-share-wa-btn" class="bg-green-600 text-white px-4 py-2 rounded-md">?????? ??? ??????</button>
                        <button type="button" onclick="closeNotifyModal()" class="bg-gray-300 px-4 py-2 rounded-md">?????</button>
                    </div>
                    <div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">??? ???????</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Safety: force a debts render and make rows visible when the page finishes loading.
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setTimeout(() => {
                    try {
                        if (typeof renderDebts === 'function') {
                            try { renderDebts(); } catch (e) { console.warn('renderDebts call failed', e); }
                        }
                        const tbody = document.getElementById('debts-detail-body');
                        if (tbody) {
                            Array.from(tbody.children).forEach(tr => {
                                try {
                                    tr.style.display = 'table-row';
                                    tr.style.visibility = 'visible';
                                    tr.style.opacity = '1';
                                    Array.from(tr.children).forEach(td => {
                                        td.style.display = 'table-cell';
                                        td.style.color = '#111';
                                        td.style.opacity = '1';
                                        td.style.visibility = 'visible';
                                        td.style.fontSize = '14px';
                                    });
                                } catch (e) {}
                            });
                            console.log('Force-styled debts rows, count=', tbody.children.length);
                        }
                    } catch (e) { console.warn('Debts force-render failed', e); }
                }, 150);
            } catch (e) { console.warn('Debts DOMContentLoaded handler failed', e); }
        });
    </script>

    <!-- Modals for Reports/Dispatch/Statements (Keeping placeholders for compatibility) -->
    <div id="statement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4"></div>
    <div id="date-range-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        	<!-- Date Range Form / Statement Customer List -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-xl font-bold mb-4">??? ???? ????</h2>
            <form id="date-range-form">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">????? ???????</label>
                        <input type="date" id="start-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">????? ????????</label>
                        <input type="date" id="end-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">????? ??? ???:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center"><input type="radio" name="product-category" value="all" checked class="text-blue-600 focus:ring-blue-500 ml-1"> ????</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="dairy" class="text-blue-600 focus:ring-blue-500 ml-1"> ?????</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="multi" class="text-blue-600 focus:ring-blue-500 ml-1"> ?????</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="supermarket-chain-filter" class="block text-sm font-medium text-gray-700">????? ??? ???????</label>
                    <select id="supermarket-chain-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="all">???? ??????</option>
                        <option value="exception">?????? ?????</option>
                        <option value="awladragab">????? ???</option>
                        <option value="samysalama">???? ?????</option>
                        <option value="gomlamarket">???? ?????</option>
                        <option value="dreams">?????</option>
                    </select>
                </div>
                <h3 class="text-lg font-bold mb-3 border-t pt-4">???? ??????? ?????????:</h3>
                <input type="text" id="statement-customer-search" placeholder="???? ???? ??????..." class="w-full p-2 border rounded-md mb-3">
                <div id="statement-customer-list" class="space-y-1 max-h-48 overflow-y-auto border p-2 rounded-md bg-gray-50">
                    <!-- Customers will be injected here -->
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-date-range-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">????? ??? ??????</button>
                </div>
            </form>
        </div>
    </div>
    <div id="dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <h2 id="dispatch-modal-title" class="text-xl font-bold mb-4">????? ??? ?????? ?????</h2>
            <form id="dispatch-note-form">
                <input type="hidden" id="dispatch-note-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="dispatch-rep" class="block text-sm font-medium text-gray-700">???????</label>
                        <select id="dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="dispatch-date" class="block text-sm font-medium text-gray-700">????? ?????</label>
                        <input type="date" id="dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>

                <div class="overflow-x-auto bg-gray-50 rounded-lg shadow mt-4 border">
                    <table id="dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">??????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">????? (????)</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">????? ????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">????? ????</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">?????</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="dispatch-items-container" class="divide-y divide-gray-200">
                            <!-- Dispatch item rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-dispatch-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    ????? ??? ??? ?????
                </button>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-dispatch-note-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">??? ?????</button>
                </div>
            </form>
        </div>
    </div>
    <div id="view-dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Content injected dynamically -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <div id="dispatch-note-view-content">
                <!-- Report details will be injected here -->
            </div>
            <div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
                <button id="close-view-dispatch-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
                <button id="print-dispatch-btn" onclick="printSection('dispatch-note-view-content')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                    <span>????? (Ctrl+P)</span>
                </button>
            </div>
        </div>
    </div>
    <div id="settlement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Adding main content div inside modal placeholder for consistency -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6">
            <h2 id="settlement-modal-title" class="text-xl font-bold mb-4">????? ??????? ??? ????????</h2>
            <div id="settlement-content">
                <!-- Settlement report will be generated here -->
                <p class="text-center text-gray-500 mt-2">??? ????? ?????? ???????...</p>
            </div>
            <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('settlement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
            </div>
        </div>
    </div>
    <div id="reconciliation-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"></div>
    <div id="rep-sales-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body">
             <h2 id="rep-sales-summary-title" class="text-xl font-bold mb-4">??? ???? ???????</h2>
             <div id="rep-sales-summary-content">
                 <!-- Rep Statement content injected dynamically -->
             </div>
             <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('rep-sales-summary-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
            </div>
        </div>
    </div>
    <div id="daily-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="customer-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="ai-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>

    <!-- NEW: Image Preview Modal -->
    <div id="image-preview-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <h2 class="text-xl font-bold mb-4">?????? ??????</h2>
            <p class="text-sm text-gray-600 mb-4">????? ???? ??? ?????? ?????? ????? ????? ?????? (?? ????? ?????? ?? ??????) ??????? "??? ??????"? ?? ??????? ??? ?????.</p>
            <div id="image-preview-container" class="mb-4 border p-2 bg-gray-100 max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal(document.getElementById('image-preview-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">?????</button>
                <button id="download-image-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">????? ??????</button>
            </div>
        </div>
    </div>


    <!-- Removed duplicate Firebase SDK (9.6.10) to avoid double init -->

    <script>
        // ===== Role-based page guard =====
        const ROLE_PAGE_ALLOW = {
            admin: 'ALL',
            // Allow reviewers and managers to view all pages (they remain read-only by DB/UI guards)
            reviewer: 'ALL',
            manager: 'ALL',
            // ?? ????? ?????? ??????? ?? ????????? ???????: ????????? ????? ????? ????????? ?????????? ????????
            rep: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch']),
            user: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch'])
        };
        let lastRequestedPage = null; // ????? ?????? ???? ???? ???????? ????? ??????
        function canAccessPage(pageName){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // ?????? ?????? ????? (??? ????? ??????) ???? ???? ????????? ??? ???? ????? ?????
                if (role === 'guest') {
                    return pageName === 'dashboard';
                }
                if (role === 'admin') return true;
                const set = ROLE_PAGE_ALLOW[role];
                if (!set) return false;
                if (set === 'ALL') return true;
                return set.has(pageName);
            } catch(_) { return false; }
        }

        // Global observer: prevent unauthorized page activation even if toggled elsewhere
        (function(){
            try {
                const obs = new MutationObserver((mutations)=>{
                    try {
                        const actives = Array.from(document.querySelectorAll('.page.active'));
                        actives.forEach(el => {
                            const id = el.id || '';
                            const page = id.startsWith('page-') ? id.slice(5) : null;
                            if (!page) return;
                            if (!canAccessPage(page)) {
                                el.classList.remove('active');
                                el.style.display = 'none';
                                // ?? ???? ??????? ??? ??? ??? ???????? ?? ?? ??? ??????
                                if (lastRequestedPage === page) {
                                    try { customDialog({ title:'??? ????', message:'???????? ?? ???? ???? ??? ??????.' }); } catch(_) { alert('??? ????'); }
                                }
                                try { navigateTo('dashboard'); } catch(_) { }
                            }
                        });
                    } catch(e){}
                });
                obs.observe(document.documentElement, { subtree:true, attributes:true, attributeFilter:['class','style'] });
            } catch(e){}
        })();

        // ????? ????? ?????? ??? ??????? (????? ???? ??? navigateTo)
        function switchPage(pageName) {
            try { lastRequestedPage = pageName; } catch(_){}
            if (typeof navigateTo === 'function') { navigateTo(pageName); return; }
        }

        // ???? ?????? ??? ???? ????? (????????? ?? onclick)
        function navigateToPage(pageName) {
            switchPage(pageName);
        }

        // ??? ????????? ?????? ??????
        document.addEventListener('DOMContentLoaded', function() {
            // ????? ????? ????? ??? ?? ?? ???? ??????
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pageName = this.getAttribute('data-page');
                    if (pageName) {
                        // ????? ?????? ?????? ??? ???????? ??? ???? ????????
                        if (pageName === 'sales' || pageName === 'reports' || pageName === 'debts') {
                            try { ensureDefaultActivePeriod(); } catch(e){}
                        }
                        switchPage(pageName);
                    }
                });
            });
            // ??? ???? ????????? ??? ?? ??? ?????? ??????? ???????? ???? switchPage
            // ????? ??????? ??? ?????? ??? ??????? ?????? ??????? ??????
            setTimeout(()=>{
                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role && role !== 'admin' && ROLE_PAGE_ALLOW[role] && ROLE_PAGE_ALLOW[role] !== 'ALL') {
                        const allowed = ROLE_PAGE_ALLOW[role];
                        document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                            const pg = btn.getAttribute('data-page');
                            if (pg && !allowed.has(pg)) {
                                btn.style.display = 'none';
                            }
                        });
                    }
                } catch(e){}
            }, 400);
            
            // ??? ?????? ???????? ??? ??? ???????
            switchPage('dashboard');

            // ????? ??? ????????? ??? ???????? ????? (?? guest ??? ??? ????) ??? ???????
            let roleCheckCount = 0;
            const roleCheckInterval = setInterval(()=>{
                roleCheckCount++;
                const currentRole = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (currentRole && currentRole !== 'guest') {
                    try {
                        if (currentRole !== 'admin' && ROLE_PAGE_ALLOW[currentRole] && ROLE_PAGE_ALLOW[currentRole] !== 'ALL') {
                            const allowed = ROLE_PAGE_ALLOW[currentRole];
                            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                                const pg = btn.getAttribute('data-page');
                                if (pg && !allowed.has(pg)) btn.style.display = 'none';
                            });
                        }
                    } catch(e){}
                    clearInterval(roleCheckInterval);
                } else if (roleCheckCount > 120) { // ??????? ??????? (120 * 1?)
                    clearInterval(roleCheckInterval);
                }
            }, 1000);
        });

        // ?????? ??????? ??????? ???? ??? ???? ??? ???? ????????? ?????? inline
        // ???????? ???? ??? navigateTo + CSS (.page/.active) ???
    </script>


    <!-- Lucide Icons - Direct CDN Link -->
    
    <!-- ?? ???? ??? auto-start offline ??? ?? ?????? ??????? -->
    <script>
    // Costs / BOM feature (minimal, client-side only)
    (function(){
        const LS_FIN = 'cost_finished';
        const LS_RAW = 'cost_raw';
        const LS_PACK = 'cost_pack';
        const LS_OPS = 'cost_ops';
        const LS_BOM_PREFIX = 'bom_';

        let costFinished = [];
        let costRaw = [];
        let costPack = [];
        let costOps = [];

        function loadLists(){
            // SAFETY: Filter out corrupted localStorage values before parsing
            const safeGetLS = (key) => {
                const val = localStorage.getItem(key);
                if (!val || val === 'undefined' || val === 'null') return '[]';
                return val;
            };
            
            try { costFinished = JSON.parse(safeGetLS(LS_FIN)); } catch(e){ costFinished = []; }
            try { costRaw = JSON.parse(safeGetLS(LS_RAW)); } catch(e){ costRaw = []; }
            try { costPack = JSON.parse(safeGetLS(LS_PACK)); } catch(e){ costPack = []; }
            try { costOps = JSON.parse(safeGetLS(LS_OPS)); } catch(e){ costOps = []; }
            // DEBUG: print what was loaded (with safety check for "undefined" string)
            try {
                const rawFromLS = localStorage.getItem(LS_RAW);
                // SAFETY: Check if the value is the string "undefined" before parsing
                const rawParsed = (rawFromLS && rawFromLS !== 'undefined' && rawFromLS !== 'null') ? JSON.parse(rawFromLS) : [];
                console.log('?? loadLists DEBUG: loaded cost_raw from localStorage', { itemCount: rawParsed.length, firstItem: rawParsed[0], timestamp: localStorage.getItem('costLists_local_ts'), rawStorageKey: LS_RAW });
            } catch(e) { console.warn('?? loadLists DEBUG: error reading cost_raw', e); }
            // Sync to window so simplified recipe quick lists can read them
            try { window.costFinished = costFinished; window.costRaw = costRaw; window.costPack = costPack; window.costOps = costOps; } catch(_){ }
            console.log('loadLists: loaded from localStorage', { costRaw: costRaw.length, costPack: costPack.length, costFinished: costFinished.length });
            // ensure finished products have defaults from app state if empty (disabled by flag)
            try {
                if (!window.__DISABLE_AUTO_SEED_COST_LISTS) {
                    ensureFinishedFromState();
                } else {
                    console.log('?? Auto-seed finished list disabled; skipping ensureFinishedFromState');
                }
            } catch(_){ }
            // ensure raw/pack lists populated from stock-control state if empty (disabled by flag)
            try {
                if (!window.__DISABLE_AUTO_SEED_COST_LISTS) {
                    ensureRawAndPackFromState();
                } else {
                    console.log('?? Auto-seed raw/pack disabled; skipping ensureRawAndPackFromState');
                }
            } catch(_){ }
            console.log('loadLists: after ensure', { costRaw: costRaw.length, costPack: costPack.length, costFinished: costFinished.length });
            renderListsSummary(); renderProductSelect(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable();
            // Try overlay-from-cloud after local load
            console.log('loadLists: about to call tryLoadCostListsFromCloud...');
            try { tryLoadCostListsFromCloud(); } catch(e){ console.warn('loadLists: tryLoadCostListsFromCloud failed', e); }
        }

        function saveLists(suppressCloud){
            // ===== 1. Ensure we're using window globals =====
            try { 
                costFinished = window.costFinished || costFinished; 
                costRaw = window.costRaw || costRaw; 
                costPack = window.costPack || costPack; 
                costOps = window.costOps || costOps; 
            } catch(_){ }
            renderListsSummary(); renderProductSelect(); renderRawPriceTable();

            // ===== 2. Cache locally (non-authoritative) - use WINDOW globals =====
            try {
                // ?? ???? finished ?????? ??? ???? ????? ????? ??????
                try {
                    if (Array.isArray(window.costFinished) && window.costFinished.length > 0) {
                        localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished));
                    } else {
                        const existingFin = JSON.parse(localStorage.getItem(LS_FIN) || '[]');
                        if (Array.isArray(existingFin) && existingFin.length > 0) {
                            // ????? ??????? ???????? ??? ???? ???
                        } else {
                            localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished));
                        }
                    }
                } catch(_){ localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished)); }
                localStorage.setItem(LS_RAW, JSON.stringify(window.costRaw));
                localStorage.setItem(LS_PACK, JSON.stringify(window.costPack));
                localStorage.setItem(LS_OPS, JSON.stringify(window.costOps));
                const timestamp = new Date().toISOString();
                // Do not mark local cache as authoritative timestamp here. Only cache payload.
                console.log('?? saveLists: cached locally (cache only)', { finished: (window.costFinished||[]).length, raw: (window.costRaw||[]).length, pack: (window.costPack||[]).length, ops: (window.costOps||[]).length, timestamp });
            } catch(e){ console.warn('?? saveLists: failed to write local cache', e); }

            // ===== 3. Cloud-first write: push immediately to Firestore (include grid states)
            if (!suppressCloud) {
                try {
                    // ensure window.costLists reflects current arrays
                    window.costLists = window.costLists || {};
                    window.costLists.costRaw = window.costRaw;
                    window.costLists.costPack = window.costPack;
                    window.costLists.costFinished = window.costFinished;
                    // delegate to centralized cloud writer which includes grid states
                    if (typeof window.saveCostListsToFirebase === 'function') {
                        window.saveCostListsToFirebase(true).then(ok => {
                            if (ok) {
                                document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { raw: (window.costRaw||[]).length, pack: (window.costPack||[]).length, finished: (window.costFinished||[]).length } }));
                            }
                        }).catch(e => console.warn('?? saveLists: saveCostListsToFirebase failed', e));
                    } else {
                        console.warn('?? saveLists: saveCostListsToFirebase not available');
                    }
                } catch(e) { console.warn('?? saveLists: cloud write failed', e); }
            }
        }

        // Expose saveLists so other script blocks (earlier in the file) can call it
        try { window.saveLists = saveLists; } catch(_){ }

        // ===== Cloud sync (Firestore) for cost lists - SAFE WITH onSnapshot =====
        let __costDocUnsub = null;
        // ===== CRITICAL FIX: Debounced UI Rendering to prevent Infinite Loops =====
        let renderDebounceTimer = null;
        
        window.safeRenderUI = function() {
            clearTimeout(renderDebounceTimer);
            renderDebounceTimer = setTimeout(() => {
                console.log("?? Debounce: Executing Single Render...");
                
                // 1. Sync Data from localStorage first
                try {
                    if (window.inventorySystem && typeof window.inventorySystem._syncFromLocalStorage === 'function') {
                        window.inventorySystem._syncFromLocalStorage();
                    }
                } catch(e) { console.warn('_syncFromLocalStorage failed:', e); }
                
                // 2. Render Tabs (WITHOUT triggering saves)
                try {
                    window.isUpdatingFromCloud = true; // Prevent save loops
                    if (typeof renderRawMaterials === 'function') renderRawMaterials();
                    if (typeof renderPackaging === 'function') renderPackaging();
                    if (typeof renderFinishedProducts === 'function') renderFinishedProducts();
                    console.log("? UI Rendered (debounced, safe)");
                    
                    // 3. Update counters ONCE after all renders complete
                    if (typeof updateCounters === 'function') updateCounters();
                    
                    // 4. Update total inventory value
                    if (typeof updateTotalValue === 'function') updateTotalValue();
                } catch(e) {
                    console.warn('UI re-render failed:', e);
                } finally {
                    setTimeout(() => { window.isUpdatingFromCloud = false; }, 1000);
                }
            }, 500); // Wait 500ms for data to settle
        };
        
        window.syncCloudDataToUI = function(cloudData) {
            console.log("?? Syncing Cloud Numbers to UI...");

            // Helper: Update local array with cloud stock numbers
            const updateStock = (localList, cloudList) => {
                if (!localList || !cloudList) return;
                localList.forEach(item => {
                    // Find the item in cloud data by Name or ID
                    const cloudItem = cloudList.find(c => c.name === item.name || (c.id && c.id === item.id));
                    if (cloudItem) {
                        item.stock = Number(cloudItem.stock) || 0; // Update Stock
                        item.avgCost = Number(cloudItem.avgCost || cloudItem.cost) || 0; // Update Cost
                        item.cost = Number(cloudItem.cost || cloudItem.avgCost) || 0; // Sync both cost fields
                    }
                });
            };

            // 1. Update Raw Materials with cloud stock numbers
            if (window.costRaw && cloudData.raw) {
                updateStock(window.costRaw, cloudData.raw);
                console.log(`? Updated ${window.costRaw.length} raw materials with cloud stock`);
            }

            // 2. Update Packaging with cloud stock numbers
            if (window.costPack && cloudData.pack) {
                updateStock(window.costPack, cloudData.pack);
                console.log(`? Updated ${window.costPack.length} packaging items with cloud stock`);
            }

            // 3. Update Finished Products with cloud stock numbers
            if (window.costFinished && cloudData.finished) {
                updateStock(window.costFinished, cloudData.finished);
                console.log(`? Updated ${window.costFinished.length} finished products with cloud stock`);
            }

            // 4. ? FIXED: Use DEBOUNCED render instead of direct calls
            window.safeRenderUI();
        };

        // Global flag to ensure initRealtimeSync runs ONLY ONCE (prevent multiple onSnapshot)
        let __realtimeSyncInitialized = false;

        function initRealtimeSync() {
            try {
                // CRITICAL: Prevent multiple calls that cause app to hang
                if (__realtimeSyncInitialized) {
                    console.log('?? Realtime sync ALREADY INITIALIZED - skipping duplicate call');
                    return;
                }
                
                console.log('?? Connecting to Real-time Data Stream (onSnapshot - Safe)...');
                if (!window.firebase || !window.firebase.firestore) {
                    console.warn('Firebase not ready for realtime sync');
                    return;
                }
                
                // Only subscribe once to avoid duplicate listeners
                if (__costDocUnsub) {
                    console.log('?? Realtime sync already active (unsub exists)');
                    __realtimeSyncInitialized = true;
                    return;
                }
                
                // Mark as initialized BEFORE creating listener to prevent race conditions
                __realtimeSyncInitialized = true;
                
                // Use onSnapshot for efficient, safe real-time updates (NO loops)
                __costDocUnsub = firebase.firestore().collection('settings').doc('costLists')
                .onSnapshot((doc) => {
                    if (!doc.exists) {
                        console.log('?? No costLists doc in cloud yet');
                        return;
                    }
                    
                    const source = doc.metadata.hasPendingWrites ? "Local" : "Server";
                    
                    // ?? CRITICAL: Ignore local writes to prevent infinite loops
                    if (source === "Local") {
                        // Don't log or process - this is our own write bouncing back
                        return;
                    }
                    
                    const data = doc.data();
                    console.log(`?? Received update from ${source}`, { hasRaw: !!data.raw, hasPack: !!data.pack, hasFinished: !!data.finished });

                    // Only process SERVER updates (from other devices or initial load)
                    if (source === "Server" || !window.dataLoaded) {
                        
                        // ?? SET FLAG: Prevent save loops during cloud sync
                        window.isUpdatingFromCloud = true;
                        
                        // 1. UPDATE MEMORY
                        window.costLists = window.costLists || {};
                        if (data.raw) window.costLists.costRaw = data.raw;
                        if (data.pack) window.costLists.costPack = data.pack;
                        if (data.finished) window.costLists.costFinished = data.finished;
                        if (data.timestamp) window.costLists.timestamp = data.timestamp;
                        
                        // 2. SYNC TO WINDOW (for inventory system) - ALWAYS UPDATE FROM CLOUD
                        // ? FIXED: Always merge cloud data to ensure fresh stock values show in UI
                        if (Array.isArray(data.raw)) {
                            window.costRaw = data.raw;  // Cloud is authoritative (even if empty)
                            console.log(`? Updated window.costRaw with ${data.raw.length} items from cloud`);
                        }
                        if (Array.isArray(data.pack)) {
                            window.costPack = data.pack;
                            console.log(`? Updated window.costPack with ${data.pack.length} items from cloud`);
                        }
                        if (Array.isArray(data.finished)) {
                            window.costFinished = data.finished;  // Cloud is authoritative (even if empty)
                            window.finishedProducts = data.finished; // Keep legacy alias in sync
                            console.log(`? Updated window.costFinished with ${data.finished.length} items from cloud`);
                        }
                        
                        // 3. SAVE TO LOCAL CACHE (for offline)
                        try {
                            if (data.raw) localStorage.setItem('cost_raw', JSON.stringify(data.raw));
                            if (data.pack) localStorage.setItem('cost_pack', JSON.stringify(data.pack));
                            if (data.finished) localStorage.setItem('cost_finished', JSON.stringify(data.finished));
                        } catch(e) { console.warn('localStorage sync failed:', e); }
                        
                        // 4. ? DEBOUNCED UI REFRESH (prevents infinite loops)
                        try {
                            // Call the sync function to merge cloud stock numbers into UI (uses debounce)
                            if (typeof window.syncCloudDataToUI === 'function') {
                                window.syncCloudDataToUI(data);
                            }
                            
                            // Also refresh inventory tab if open (with debounce)
                            if (window.inventorySystem && window.inventorySystem.currentTab) {
                                console.log(`?? Cloud data arrived, will refresh ${window.inventorySystem.currentTab} tab UI after debounce...`);
                            }
                        } catch(e) { console.warn('UI refresh failed:', e); }
                        
                        window.dataLoaded = true;
                        try {
                            window.__costSnapshotLoaded = true;
                            window.__hasCloudCostDoc = true;
                        } catch(_){ }
                        console.log('? Real-time sync update applied (safe, no loops)');
                        
                        // ?? CLEAR FLAG after delay
                        setTimeout(() => { window.isUpdatingFromCloud = false; }, 1000);
                    }
                }, (error) => {
                    console.error('? Realtime sync error:', error);
                    if (error.code === 'permission-denied') {
                        console.warn('?? Permission denied - check Firestore rules or re-login');
                    }
                });
                
                // ?? Also refresh UI if currently viewing the inventory page
                window.addEventListener('costListsSavedToCloud', () => {
                    try {
                        if (window.inventorySystem && window.inventorySystem.currentTab) {
                            console.log('?? Cloud update detected, refreshing UI...');
                            setTimeout(() => window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab), 100);
                        }
                    } catch(e){ console.warn('UI refresh on cloud update failed:', e); }
                });
            } catch(e) {
                console.error('initRealtimeSync failed:', e);
            }
        }

        // Start realtime sync on Firebase initialization
        setTimeout(() => {
            try { if (typeof initRealtimeSync === 'function') initRealtimeSync(); } catch(e){ console.error('initRealtimeSync error:', e); }
        }, 500);

        async function tryLoadCostListsFromCloud(){
            try {
                console.log("?? Attempting to load and RESTORE data from Cloud...");
                if (!window.firebase || !window.firebase.firestore) {
                    console.warn('?? Firebase not initialized');
                    return false;
                }
                
                const doc = await firebase.firestore().collection('settings').doc('costLists').get();
                
                if (doc.exists) {
                    // Mark that a cloud costLists document exists so we don't accidentally overwrite with zeros
                    try { window.__hasCloudCostDoc = true; } catch(_){}
                    const data = doc.data();
                    console.log("?? Cloud doc found:", { hasRaw: !!data.raw, hasPack: !!data.pack, hasFinished: !!data.finished, hasRawGridState: !!data.rawGridState, hasPackGridState: !!data.packGridState, hasFinishedProducts: !!data.finishedProducts, hasStockEntries: !!data.stockEntries });
                    
                    // 1. Restore Global Lists (Calculated Costs)
                    if (data.raw && Array.isArray(data.raw) && data.raw.length > 0) {
                        window.costLists = window.costLists || {};
                        window.costLists.costRaw = data.raw;
                        console.log("? Restored costRaw:", data.raw.length, "items");
                    }
                    if (data.pack && Array.isArray(data.pack) && data.pack.length > 0) {
                        window.costLists = window.costLists || {};
                        window.costLists.costPack = data.pack;
                        console.log("? Restored costPack:", data.pack.length, "items");
                    }
                    if (data.finished && Array.isArray(data.finished)) {
                        window.costLists = window.costLists || {};
                        window.costLists.costFinished = data.finished;
                        // CRITICAL: Also sync to window.costFinished for inventory system
                        window.costFinished = data.finished;  // Update even if empty - cloud is authoritative
                        window.finishedProducts = data.finished; // Keep legacy alias in sync
                        // Save to localStorage for offline
                        try { localStorage.setItem('cost_finished', JSON.stringify(data.finished)); } catch(_){}
                        console.log("? Restored costFinished:", data.finished.length, "items");
                    }
                    if (data.timestamp) {
                        window.costLists = window.costLists || {};
                        window.costLists.timestamp = data.timestamp;
                    }

                    // 2. CRITICAL: Restore Grid States (The Inputs & Prices)
                    // If the cloud has grid states, inject them into the Window & LocalStorage
                    // RAW: prefer canonical field, fallback to legacy `rawMaterials`
                    if ((data.rawGridState && typeof data.rawGridState === 'object') || (data.rawMaterials && typeof data.rawMaterials === 'object')) {
                        const rawState = (data.rawGridState && typeof data.rawGridState === 'object') ? data.rawGridState : data.rawMaterials;
                        window._rawGridState = data.rawGridState;
                        try { localStorage.setItem('raw_materials_grid', JSON.stringify(rawState)); } catch(_){}
                        console.log("? Restored raw grid state to window and localStorage", { keys: Object.keys(rawState||{}).length });
                        // Migrate legacy field to canonical on cloud
                        try { if (!data.rawGridState && window.db) await db.collection('settings').doc('costLists').set({ rawGridState: rawState, updatedAt: serverTs() }, { merge:true }); } catch(_){}
                    }
                    // PACK: prefer canonical field, fallback to legacy `packaging`
                    if ((data.packGridState && typeof data.packGridState === 'object') || (data.packaging && typeof data.packaging === 'object')) {
                        const packState = (data.packGridState && typeof data.packGridState === 'object') ? data.packGridState : data.packaging;
                        window._packGridState = packState;
                        try { localStorage.setItem('packaging_grid', JSON.stringify(packState)); } catch(_){}
                        console.log("? Restored pack grid state to window and localStorage", { keys: Object.keys(packState||{}).length });
                        // Migrate legacy field to canonical on cloud
                        try { if (!data.packGridState && window.db) await db.collection('settings').doc('costLists').set({ packGridState: packState, updatedAt: serverTs() }, { merge:true }); } catch(_){}
                    }
                    // FIXED: Use finishedProducts field (not finishedGridState)
                    if (data.finishedProducts && typeof data.finishedProducts === 'object') {
                        window._finishedGridState = data.finishedProducts;
                        localStorage.setItem('finished_products_grid', JSON.stringify(data.finishedProducts));
                        console.log("? Restored finishedProducts to window and localStorage:", Object.keys(data.finishedProducts).length, "products");
                    }
                    // FIXED: Restore stock_entries (only when cloud has entries)
                    if (data.stockEntries && typeof data.stockEntries === 'object' && Object.keys(data.stockEntries||{}).length > 0) {
                        if (!window.state) window.state = {};
                        window.state.stockEntries = data.stockEntries;
                        try { localStorage.setItem('stock_entries', JSON.stringify(data.stockEntries)); } catch(_){ }
                        console.log("? Restored stockEntries to window and localStorage:", Object.keys(data.stockEntries).length, "dates");
                    } else {
                        console.log('?? Skipped restoring stockEntries (cloud empty)');
                    }

                    // 3. Force Re-Render to show the data
                    try {
                        if (typeof renderRawMaterials === 'function') {
                            console.log("?? Re-rendering Raw Materials...");
                            renderRawMaterials();
                        }
                    } catch(e){ console.warn('renderRawMaterials re-render failed:', e); }
                    
                    try {
                        if (typeof renderPackaging === 'function') {
                            console.log("?? Re-rendering Packaging...");
                            renderPackaging();
                        }
                    } catch(e){ console.warn('renderPackaging re-render failed:', e); }
                    
                    try {
                        if (typeof renderFinishedProducts === 'function') {
                            console.log("?? Re-rendering Finished Products...");
                            renderFinishedProducts();
                        }
                    } catch(e){ console.warn('renderFinishedProducts re-render failed:', e); }

                    console.log("? Data restored from Cloud successfully!");
                    // ??? ????????? ?? ???????? ???? ?????? ???????? ?? inventory_items ????? ??????
                    try { setTimeout(() => { if (typeof window.normalizeInventoryNow === 'function') window.normalizeInventoryNow(); }, 800); } catch(_){ }
                    return true;
                } else {
                    // No cloud doc yet; note this so startup saves can proceed once local lists are ready
                    try { window.__hasCloudCostDoc = false; } catch(_){}
                    console.log('?? No cloud doc found; using local data');
                    return false;
                }
            } catch (e) {
                console.error("? Failed to load from cloud:", e);
                return false;
            }
        }

        // ===== Recovery Helpers: Restore Balances from Cloud History =====
        async function restoreFinishedFromDaily(maxDays = 14){
            try {
                const now = new Date();
                let restored = false;
                for (let i = 0; i < maxDays; i++) {
                    const d = new Date(now);
                    d.setDate(now.getDate() - i);
                    const dateId = d.toISOString().split('T')[0];
                    let snap;
                    try {
                        const ref = (window.db ? window.db : firebase.firestore());
                        snap = await ref.collection('daily_cost_lists').doc(String(dateId)).get();
                    } catch(e){ console.warn('restoreFinishedFromDaily: fetch failed', e); continue; }
                    if (snap && snap.exists) {
                        const data = snap.data() || {};
                        const arr = Array.isArray(data.finished_products) ? data.finished_products : [];
                        if (arr.length > 0) {
                            window._finishedGridState = window._finishedGridState || {};
                            arr.forEach(fp => {
                                const id = String(fp.id || fp.code || fp.name || '').trim();
                                if (!id) return;
                                const count = Number(fp.count || fp.actual || fp.opening || 0);
                                window._finishedGridState[id] = Object.assign({}, window._finishedGridState[id] || {}, { actual: count, updatedAt: new Date().toISOString() });
                            });
                            try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){}
                            console.log('? ??? ??????? ???? ???????? ?????? ?? ?????:', dateId, ' � ?????:', arr.length);
                            restored = true;
                            break; // ????? ????? ??? ??? ????
                        }
                    }
                }
                if (!restored) console.warn('?? ?? ??? ?????? ??? ???? ?????? ???? ?? ?????? ???????');
                return restored;
            } catch(e){ console.warn('restoreFinishedFromDaily failed', e); return false; }
        }

        // ??? ???? ????????? ?? ???????: ???? ????? ??????? ??????? ???? ???????? ??????
        try {
            window.restoreBalancesFromCloud = async function(){
                try {
                    console.log('?? ??? ??????? ??????? ?? ???????...');
                    // ??? ??????? ?? ????? costLists (???? raw/pack grid states)
                    await tryLoadCostListsFromCloud();
                    // ???? ??????? ???????? ?????? ?? ????? ??????
                    const ok = await restoreFinishedFromDaily(30);
                    // ???? ????? ?????? ????? ?????????
                    try { if (typeof renderFinishedProducts === 'function') renderFinishedProducts(); } catch(_){}
                    try { if (typeof renderPackaging === 'function') renderPackaging(); } catch(_){}
                    try { if (typeof renderRawMaterials === 'function') renderRawMaterials(); } catch(_){}
                    // ???? ?????? ??? ????????? (??? ????? ?????? ???)
                    try { if (typeof window.saveCostListsToFirebase === 'function') await window.saveCostListsToFirebase(); } catch(_){}
                    console.log(ok ? '? ?? ????????? ?????' : '?? ?? ??? ?????? ??? ????? ?????? ??????');
                    return ok;
                } catch(e){ console.warn('restoreBalancesFromCloud failed', e); return false; }
            };
        } catch(_){}
        function queueCloudSave(){
            if (!window.db) { console.warn('?? queueCloudSave: Firebase not initialized'); return; }
            if (__costCloudTimer) clearTimeout(__costCloudTimer);
            __costCloudTimer = setTimeout(async ()=>{ try {
                        console.log('?? Attempting to save cost lists to Firebase (settings/costLists)...');
                        // Build conditional payload to avoid overwriting server arrays with empty locals
                        const qpayload = { ops: costOps || [], updatedAt: serverTs() };
                        if (Array.isArray(costFinished) && costFinished.length>0) qpayload.finished = costFinished;
                        if (Array.isArray(costRaw) && costRaw.length>0) qpayload.raw = costRaw;
                        if (Array.isArray(costPack) && costPack.length>0) qpayload.pack = costPack;
                        await db.collection('settings').doc('costLists').set(qpayload, { merge: true });
                        console.log('? Cost lists saved to Firebase (settings/costLists)', { finished: (costFinished||[]).length, raw: (costRaw||[]).length, pack: (costPack||[]).length, ops: (costOps||[]).length });
                    try{ document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { path: 'settings/costLists' } })); }catch(_){ }
                } catch(e){
                    console.warn('?? Failed to save to settings/costLists:', e);
                    // Fallback: try saving to the user's document
                    try {
                        const uid = (auth && auth.currentUser) ? (auth.currentUser.uid || auth.currentUser.email) : null;
                        if (!uid) { console.warn('? queueCloudSave fallback: no authenticated user available'); return; }
                        console.log('?? Falling back to save at users/{uid}.costLists...');
                        await db.collection('users').doc(uid).set({
                            costLists: {
                                finished: costFinished || [],
                                raw: costRaw || [],
                                pack: costPack || [],
                                ops: costOps || [],
                                updatedAt: serverTs()
                            }
                        }, { merge: true });
                        console.log('? Cost lists saved to Firebase (users/' + uid + '.costLists)');
                        try{ document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { path: 'users/' + uid + '.costLists' } })); }catch(_){ }
                    } catch(e2){
                        console.warn('? Fallback save to users/{uid}.costLists also failed:', e2);
                    }
                }
            }, 800);
        }

        // Helper function to save cost lists to Firebase (called from saveLists)
        window.saveCostListsToFirebase = async function(immediate){
            // ? REMOVED ADMIN CHECK - Allow all logged-in users to save inventory
            // Any authenticated user can now update inventory data
            
            if (!window.db) {
                console.warn('?? saveCostListsToFirebase: Firebase not ready, waiting...');
                try { await waitForDbReady(5000); } catch(e) { console.warn('?? saveCostListsToFirebase: DB wait timed out', e); }
                if (!window.db) { console.warn('?? saveCostListsToFirebase: Firebase still not ready'); return false; }
            }
            
            // CRITICAL: Sync window.costLists with window arrays BEFORE checking conditions
            window.costLists = window.costLists || {};
            if (window.costRaw) window.costLists.costRaw = window.costRaw;
            if (window.costPack) window.costLists.costPack = window.costPack;
            if (window.costFinished) window.costLists.costFinished = window.costFinished;
            if (window.costOps) window.costLists.costOps = window.costOps;
            
            const statusEl = document.getElementById('sync-status');
            const setStatus = (txt, visible=true) => {
                try { if (statusEl) { statusEl.textContent = txt; statusEl.classList.toggle('hidden', !visible); } } catch(_){}
            };

            // ?? CRITICAL FIX: ALWAYS save ALL arrays to prevent data loss
            // Previously: Only saved if "touched" flag was set ? caused data loss after clear cache
            // Now: Always check window arrays first (most up-to-date), fallback to costLists
            const includeRaw = true; // Always save to prevent data loss
            const includePack = true; // Always save to prevent data loss
            const includeFinished = true; // Always save to prevent data loss
            
            // DEBUG: Log what we're about to save
            console.log('?? saveCostListsToFirebase DEBUG:', {
                'window.costRaw length': (window.costRaw||[]).length,
                'window.costPack length': (window.costPack||[]).length,
                'window.costFinished length': (window.costFinished||[]).length,
                'window.costLists.costRaw length': (window.costLists?.costRaw||[]).length,
                'window.costLists.costPack length': (window.costLists?.costPack||[]).length,
                'window.costLists.costFinished length': (window.costLists?.costFinished||[]).length
            });

            const payload = {
                ops: window.costLists?.costOps || [],
                rawGridState: window._rawGridState || {},
                packGridState: window._packGridState || {},
                // Save finishedProducts grid state (object)
                finishedProducts: window._finishedGridState || {},
                // CRITICAL: Also save stock_entries
                stockEntries: window.state?.stockEntries || {},
                timestamp: new Date().toISOString(),
                updatedAt: serverTs()
            };
            
            // ?? CRITICAL: Check window arrays FIRST (most up-to-date), fallback to costLists
            if (includeRaw) {
                payload.raw = window.costRaw || window.costLists?.costRaw || [];
            }
            if (includePack) {
                payload.pack = window.costPack || window.costLists?.costPack || [];
            }
            if (includeFinished) {
                payload.finished = window.costFinished || window.costLists?.costFinished || [];
            }

            // SAFETY GUARD: Never push an all-zero payload that would wipe cloud data
            try {
                const rawCount = Array.isArray(payload.raw) ? payload.raw.length : 0;
                const packCount = Array.isArray(payload.pack) ? payload.pack.length : 0;
                const finishedCount = Array.isArray(payload.finished) ? payload.finished.length : 0;
                const allZero = (rawCount === 0 && packCount === 0 && finishedCount === 0);
                const hasCloudDoc = !!window.__hasCloudCostDoc;
                const ready = !!window.__costListsReady;
                const force = (immediate === 'force') || (immediate && typeof immediate === 'object' && immediate.force === true) || !!window.__allowZeroCloudSave;
                if (allZero && hasCloudDoc && !force) {
                    console.warn('?? saveCostListsToFirebase: Skip zero-save to protect cloud data (doc exists, arrays empty).');
                    return false;
                }
                // Also skip early startup writes when not ready and arrays are empty
                if (allZero && !ready && !force) {
                    console.warn('?? saveCostListsToFirebase: Startup not ready; skipping zero-save.');
                    return false;
                }
            } catch(_){ /* guard evaluation failed; continue */ }

            // Attempt immediate write with token refresh + retries
            let attempts = 0; const MAX_ATTEMPTS = 3; const BASE_DELAY = 800;
            while (attempts < MAX_ATTEMPTS) {
                attempts++;
                try {
                    setStatus('???? ????????...');
                    // attempt token refresh if available (helps with stale tokens)
                    try { if (window.firebase && firebase.auth && firebase.auth().currentUser) await firebase.auth().currentUser.getIdToken(true); } catch(e){ /* ignore token refresh errors */ }
                    await db.collection('settings').doc('costLists').set(payload, { merge: true });
                    const rawCount = Array.isArray(payload.raw) ? payload.raw.length : 0;
                    const packCount = Array.isArray(payload.pack) ? payload.pack.length : 0;
                    // FIXED: Count from payload.finished array (not finishedProducts object)
                    const finishedCount = Array.isArray(payload.finished) ? payload.finished.length : 0;
                    const stockEntriesCount = payload.stockEntries ? Object.keys(payload.stockEntries).length : 0;
                    console.log('? Cost lists saved to Firebase', { raw: rawCount, pack: packCount, finished: finishedCount, stockEntries: stockEntriesCount });
                    // Update local cache timestamp and grid snapshots only after cloud ack
                    try { localStorage.setItem('costLists_local_ts', payload.timestamp); } catch(_){ }
                    try { if (payload.rawGridState && Object.keys(payload.rawGridState||{}).length>0) localStorage.setItem('raw_materials_grid', JSON.stringify(payload.rawGridState||{})); } catch(_){ }
                    try { if (payload.finishedProducts && Object.keys(payload.finishedProducts||{}).length>0) localStorage.setItem('finished_products_grid', JSON.stringify(payload.finishedProducts||{})); } catch(_){ }
                    try { if (payload.stockEntries && Object.keys(payload.stockEntries||{}).length>0) localStorage.setItem('stock_entries', JSON.stringify(payload.stockEntries||{})); } catch(_){ }
                    try { if (payload.packGridState && Object.keys(payload.packGridState||{}).length>0) localStorage.setItem('packaging_grid', JSON.stringify(payload.packGridState||{})); } catch(_){ }
                    // Mirror finished products into daily_cost_lists (best-effort) so dynamic rows can be restored
                    try {
                        const finishedProductsArray = [];
                        try {
                            const fps = window._finishedGridState || {};
                            for (const k in fps) {
                                if (!Object.prototype.hasOwnProperty.call(fps, k)) continue;
                                const it = fps[k] || {};
                                finishedProductsArray.push({
                                    id: k,
                                    name: it.name || ((Array.isArray(window.costFinished) && window.costFinished.find(x=>String(x.id)===String(k))) ? (window.costFinished.find(x=>String(x.id)===String(k)).name) : ''),
                                    count: (it.actual != null ? it.actual : (it.opening != null ? it.opening : 0)),
                                    updatedAt: it.updatedAt || new Date().toISOString()
                                });
                            }
                        } catch(e){ console.warn('build finishedProductsArray failed', e); }
                        // Use the active finished-products date (YYYY-MM-DD) as the shared daily doc id
                        try {
                            const dateEl = document.getElementById('finished-products-date');
                            const dateId = (dateEl && dateEl.value) ? String(dateEl.value) : (new Date().toISOString().split('T')[0]);
                            if (dateId && Array.isArray(finishedProductsArray)) {
                                try { await db.collection('daily_cost_lists').doc(String(dateId)).set({ finished_products: finishedProductsArray, timestamp: payload.timestamp, updatedAt: serverTs() }, { merge:true }); }
                                catch(e){ console.warn('daily_cost_lists write failed', e); }
                            }
                        } catch(e){ console.warn('daily_cost_lists write (dateId) failed', e); }
                    } catch(e){ console.warn('mirror to daily_cost_lists failed', e); }
                    setStatus('?????? ?', true);
                    setTimeout(()=> setStatus('', false), 2500);
                    return true;
                } catch (e) {
                    console.error('? saveCostListsToFirebase failed (attempt ' + attempts + '):', e);
                    if (e && e.code === 'permission-denied') {
                        setStatus('??? ???????; ??? ????? ??????', true);
                        console.warn('?? Permission denied - check Firestore rules or re-login');
                        // Try to refresh auth and retry
                        try { if (firebase && firebase.auth && firebase.auth().currentUser) await firebase.auth().currentUser.getIdToken(true); } catch(_){}
                    }
                    // Exponential backoff before retry
                    if (attempts < MAX_ATTEMPTS) await new Promise(r => setTimeout(r, BASE_DELAY * attempts));
                }
            }
            setStatus('??? ???????? ?', true);
            return false;
        };

        // Optional realtime overlay when other clients update the document
        // REMOVED: Duplicate listener - using initRealtimeSync() instead
        function installCostListsListener(){
            console.log('?? installCostListsListener deprecated - use initRealtimeSync()');
            return;
        }

        // Debug helper: force fetching the cloud doc and print summary alongside local timestamp
        window.forceCostListsFetch = async function(){
            try{
                try { if (!window.db) { console.warn('forceCostListsFetch: no db available'); return; } } catch(_){ console.warn('forceCostListsFetch: window.db check failed'); return; }
                const ref = db.collection('settings').doc('costLists');
                const snap = await ref.get();
                const localTs = localStorage.getItem('costLists_local_ts') || null;
                console.log('forceCostListsFetch: localTs', localTs);
                if(!snap.exists){ console.log('forceCostListsFetch: cloud doc not found'); return; }
                const d = snap.data() || {};
                const cloudTs = d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null;
                console.log('forceCostListsFetch: cloud summary', { cloudTs, finished: Array.isArray(d.finished) ? d.finished.length : 0, raw: Array.isArray(d.raw) ? d.raw.length : 0, pack: Array.isArray(d.pack) ? d.pack.length : 0, ops: Array.isArray(d.ops) ? d.ops.length : 0, doc: d });
            } catch(e){ console.warn('forceCostListsFetch failed', e); }
        };

        function renderListsSummary(){
            const el = document.getElementById('cost-lists-summary');
            if(!el) return;
            el.textContent = `???????? ??????: ${costFinished.length} � ???????: ${costRaw.length} � ?????: ${costPack.length}`;
        }

        // If finished list empty, populate from app state products for convenience
        function ensureFinishedFromState(){
            try{
                if(Array.isArray(costFinished) && costFinished.length === 0){
                    const src = (Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
                    if(src && src.length){
                        src.forEach(p => {
                            const id = p.id || p.code || ('prod-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                            costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || '????', price: Number(p.price||p.sellPrice||0) });
                        });
                        saveLists();
                    }
                }
            }catch(e){ console.warn('ensureFinishedFromState failed', e); }
        }

        // If raw/pack lists empty, try to populate them from `state.products` (stock-control)
        function ensureRawAndPackFromState(){
            try{
                console.log('ensureRawAndPackFromState START: costRaw=' + (costRaw||[]).length + ', costPack=' + (costPack||[]).length);
                if(Array.isArray(state && state.products) && state.products.length){
                    // populate raw
                    if(Array.isArray(costRaw) && costRaw.length === 0){
                        state.products.forEach(p => {
                            const cat = (p && p.category) ? String(p.category).toLowerCase() : '';
                            if(cat.includes('???') || cat.includes('??????') || cat.includes('????')){
                                const id = p.id || p.code || ('raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                                costRaw.push({ id, code: id, name: p.name || p.title || p.code || '', unit: p.unit || p.unitName || '' });
                            }
                        });
                    }
                    // populate pack
                    if(Array.isArray(costPack) && costPack.length === 0){
                        state.products.forEach(p => {
                            const cat = (p && p.category) ? String(p.category).toLowerCase() : '';
                            if(cat.includes('?????') || cat.includes('?????') || cat.includes('????') || cat.includes('???') || cat.includes('???')){
                                const id = p.id || p.code || ('pack-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                                costPack.push({ id, code: id, name: p.name || p.title || p.code || '', unit: p.unit || p.unitName || '' });
                            }
                        });
                    }
                    // persist if we added items
                    if((Array.isArray(costRaw) && costRaw.length>0) || (Array.isArray(costPack) && costPack.length>0)){
                        try{ saveLists(true); }catch(_){ }
                    }
                }
                // Ensure built-in lists are present: add any missing built-in raw/pack names
                const builtInRaw = [
                    '??? ?????',
                    '?????? ????',
                    '???? ????',
                    '??? ???? 200',
                    '??? ???? 100',
                    '?????',
                    '???????',
                    'S20',
                    'B3',
                    '??????',
                    '????????',
                    '?????? ????????',
                    '?????? ???????',
                    '????? ????????',
                    'GDL',
                    '???? ??? 121',
                    '??? ????',
                    '???? ???',
                    '???',
                    '????',
                    '????? ??????',
                    '????? ????',
                    'CR 15',
                    '???????',
                    '?????',
                    '???? ???',
                    '??? ???? 21',
                    '????? 810',
                    '??? ???? ?????',
                    '???? ?????? ????',
                    '???',
                    '???',
                    '??? ??????',
                    '??? ??????',
                    '??? ????',
                    '??? ??????',
                    '??? ?????',
                    '????? ??? ????',
                    '??? ??',
                    '???? ?????',
                    '??? ????',
                    '??? ?????',
                    '????? 815',
                    '????? 825',
                    '??????',
                    '???????',
                    '??? ????',
                    '???? ?????',
                    '??? ???? 500',
                    '??? ????',
                    '??? ???? ?????',
                    '??? ???? ?????',
                    '????',
                    '????? ??????',
                    '??? ??????',
                    '??? ???? ????',
                    '????????',
                    '??? ?????',
                    '???? ???? ?????',
                    '??????200',
                    '??? ????',
                    '????? s33',
                    '??? ??? ????',
                    '????? ????',
                    '???? ??',
                    '??????',
                    '???? ??? ?????',
                    '??? ???????? ????'
                ];
                const builtInPack = [
                    '?????? ????','????? ???','?????? ?? ????? 3?','?????? ?? ????? 8?','?????? ?? ??? 3?','?????? ?? ??? 8?','???? ???? 8?','???? ???? 3?','?????? 800 ??','?????? 500 ??','?????? 300 ??','?????? 200 ??','????? ???? 27*45','??? ??? ????','??? ???? ????','??? ???? ????','????? ??? ???? 1?','????? ??? ???? 2?','????? ??? ???? 500 ??','??? ??????? 1?','??? ??????? 500 ??','???? ??????? ??????? 250 ??','???? ??????? ??????? 125 ??','?????? 40*40','?????? 70-70','??? ?????? 40??','??? ?????? 10 ??','??? ?????','??? ????','???? ???? ????','???? ???? ????','???? ??????? ????','???? ??????? ????','?????? ?????','???? ?????','???? ???','??? ????? ???????','?????? ????','?????? ???','???? ???','???? ??? ????','?????','????','?????? ????','??? ?????? ?????','?????? ???? ???????','?????? ???? ???????','???? ????','??? ????'
                ];
                // add any missing built-in raw names (avoid duplicates, case-insensitive)
                try{
                    let addedRaw = 0;
                    const existingRawNames = new Set((costRaw||[]).map(x => String((x && (x.name||x)) || '').trim().toLowerCase()));
                    builtInRaw.forEach((n,i) => {
                        const key = String(n||'').trim().toLowerCase();
                        if(!key) return;
                        if(!existingRawNames.has(key)){
                            const id = 'builtinraw-' + i + '-' + Date.now().toString(36).slice(4);
                            costRaw.push({ id, code: id, name: n, unit: '' });
                            existingRawNames.add(key);
                            addedRaw++;
                        }
                    });

                    let addedPack = 0;
                    const existingPackNames = new Set((costPack||[]).map(x => String((x && (x.name||x)) || '').trim().toLowerCase()));
                    builtInPack.forEach((n,i) => {
                        const key = String(n||'').trim().toLowerCase();
                        if(!key) return;
                        if(!existingPackNames.has(key)){
                            const id = 'builtinpack-' + i + '-' + Date.now().toString(36).slice(4);
                            costPack.push({ id, code: id, name: n, unit: '' });
                            existingPackNames.add(key);
                            addedPack++;
                        }
                    });

                    if(addedRaw>0 || addedPack>0){
                        try{ saveLists(true); }catch(_){ }
                        console.log('ensureRawAndPackFromState: added built-in items', { addedRaw, addedPack, totalRaw: (costRaw||[]).length, totalPack: (costPack||[]).length });
                    }
                    // Always sync to window for autocomplete access
                    try { window.costRaw = costRaw; window.costPack = costPack; } catch(_){ }
                    console.log('Cost lists synced to window. Totals:', 'costRaw=' + (costRaw||[]).length, 'costPack=' + (costPack||[]).length);
                    // Mark readiness so cloud saves can proceed safely
                    try { window.__costListsReady = true; } catch(_){}
                    // Schedule a safe cloud save if we have any items (prevents zero-wipe on startup)
                    try {
                        const r = (costRaw||[]).length, p = (costPack||[]).length, f = (window.costFinished||[]).length;
                        if ((r + p + f) > 0) {
                            setTimeout(() => { try { if (typeof saveLists === 'function') saveLists(false); } catch(_){} }, 400);
                        }
                    } catch(_){}
                }catch(e){ console.warn('ensureRawAndPackFromState built-in merge failed', e); }
            }catch(e){ console.warn('ensureRawAndPackFromState failed', e); }
        }

        // Expose a helper to manually import raw/pack lists from stock-control (callable from console)
        try {
            window.importCostListsFromStockControl = function(){
                try{
                    ensureRawAndPackFromState();
                    console.log('importCostListsFromStockControl: done.');
                    // renderQuickLists and renderPriceManager removed - features deleted
                } catch(e) { console.warn('importCostListsFromStockControl failed', e); }
            };
            window.clearCostListsAndReimport = function(){
                try {
                    console.log('Clearing cost lists from localStorage and re-importing...');
                    localStorage.removeItem('cost_raw');
                    localStorage.removeItem('cost_pack');
                    // Reset in-memory
                    costRaw = [];
                    costPack = [];
                    window.costRaw = [];
                    window.costPack = [];
                    // Re-trigger the import
                    try{ if (typeof loadLists === 'function') loadLists(); }catch(_){ }
                    try{ if (typeof loadLists === 'function') loadLists(); }catch(_){ }
                    try{ ensureRawAndPackFromState(); }catch(_){ }
                    // renderPriceManager and renderQuickLists removed - features deleted
                    console.log('Re-import complete. Totals:', 'costRaw=' + (window.costRaw||[]).length, 'costPack=' + (window.costPack||[]).length);
                } catch(e) { console.warn('clearCostListsAndReimport failed', e); }
            };
        } catch(e) {}

        function renderProductSelect(){
            const sel = document.getElementById('cost-product-select');
            if(!sel) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="">???? ???? ???...</option>' + costFinished.map(p => `<option value="${escapeHtml(p.id||p.code||p.name)}">${escapeHtml(p.name||p.code)}</option>`).join('');
            if(prev) sel.value = prev;
        }

        // Render left product list (searchable) with quick select buttons
        function renderProductList(filter){
            const container = document.getElementById('cost-product-list'); if(!container) return;
            container.innerHTML = '';
            const q = String(filter || '').trim().toLowerCase();
            const items = (costFinished || []).filter(p => {
                if(!q) return true;
                return (String(p.name||'').toLowerCase().includes(q) || String(p.code||'').toLowerCase().includes(q));
            });
            if(items.length === 0){ container.innerHTML = '<div class="p-2 text-sm text-gray-500">?? ???? ??????</div>'; return; }
            items.forEach(p => {
                const el = document.createElement('div');
                el.className = 'p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                el.innerHTML = `<div><div class="font-medium text-sm">${escapeHtml(p.name)}</div><div class="text-xs text-gray-500">${escapeHtml(p.code||'')}</div></div><div><button class="select-product-btn bg-blue-500 text-white px-2 py-1 rounded" data-id="${escapeHtml(p.id)}">?????</button></div>`;
                container.appendChild(el);
            });
        }

        function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        // Manage lists modal helpers
        function openManageListsModal(){
            console.log('openManageListsModal: start');
            // show modal immediately to avoid perceived freeze, populate tables asynchronously
            const m = document.getElementById('manage-lists-modal');
            if(m){ m.classList.remove('modal-hidden'); m.classList.add('modal-visible'); }
            // render content a bit later so modal appears first
            setTimeout(()=>{ try{ console.log('openManageListsModal: calling renderManageListsTables'); renderManageListsTables(); }catch(e){ console.warn('renderManageListsTables failed', e); } }, 40);
        }
    function closeManageListsModal(){ const m = document.getElementById('manage-lists-modal'); if(m){ m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); } }
    // expose to global so inline onclick works
    try{ window.openManageListsModal = openManageListsModal; window.closeManageListsModal = closeManageListsModal; }catch(e){}

        function renderManageListsTables(){
            // prepare progress UI
            const progressEl = document.getElementById('manage-lists-progress');
            const totalItems = (Array.isArray(costFinished)?costFinished.length:0) + (Array.isArray(costRaw)?costRaw.length:0) + (Array.isArray(costPack)?costPack.length:0);
            let processed = 0;
            if(progressEl){
                if(totalItems === 0){ progressEl.style.display = 'none'; } else { progressEl.style.display = 'block'; progressEl.textContent = `???? ????? ??????? 0 / ${totalItems}`; }
            }

            // chunked renderer with a small immediate batch and small async batches (safer for large lists)
            function chunkRender(items, tbody, rowRenderer, firstSync = 10, batchSize = 20){
                tbody.innerHTML = '';
                if(!items || items.length === 0) return;
                let i = 0;
                // initial synchronous batch
                const initial = Math.min(firstSync, items.length);
                const t0 = Date.now();
                for(; i < initial; i++){
                    const tr = rowRenderer(items[i]);
                    tbody.appendChild(tr);
                    processed++;
                }
                const t1 = Date.now();
                console.log('chunkRender: initial batch', { initial, timeMs: t1 - t0, processed, totalItems });
                if(progressEl) progressEl.textContent = `???? ????? ??????? ${processed} / ${totalItems}`;
                if(i >= items.length) return;

                function nextBatch(){
                    const batchStart = Date.now();
                    const end = Math.min(i + batchSize, items.length);
                    let batchCount = 0;
                    for(; i < end; i++){
                        const tr = rowRenderer(items[i]);
                        tbody.appendChild(tr);
                        processed++; batchCount++;
                    }
                    const batchEnd = Date.now();
                    console.log('chunkRender: batch appended', { batchCount, timeMs: batchEnd - batchStart, processed, totalItems });
                    if(progressEl) progressEl.textContent = `???? ????? ??????? ${processed} / ${totalItems}`;
                    if(i < items.length){
                        setTimeout(nextBatch, 25);
                    }
                }
                setTimeout(nextBatch, 25);
            }

            console.log('renderManageListsTables: starting render', { finished: costFinished.length, raw: costRaw.length, pack: costPack.length });

            const tf = document.querySelector('#manage-finished-table tbody');
            if(tf){ chunkRender(costFinished, tf, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.price||it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="finished" data-id="${escapeHtml(it.id)}">???</button></td>`;
                    return tr;
                }, 10, 20);
            }

            const trw = document.querySelector('#manage-raw-table tbody');
            if(trw){ chunkRender(costRaw, trw, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="raw" data-id="${escapeHtml(it.id)}">???</button></td>`;
                    return tr;
                }, 10, 20);
            }

            const tpk = document.querySelector('#manage-pack-table tbody');
            if(tpk){ chunkRender(costPack, tpk, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="pack" data-id="${escapeHtml(it.id)}">???</button></td>`;
                    return tr;
                }, 10, 20);
            }

            // hide progress once everything is appended (polling check)
            const poll = setInterval(() => {
                if(processed >= totalItems){
                    clearInterval(poll);
                    if(progressEl) { progressEl.textContent = `????? ??????? (${totalItems} ????)`; setTimeout(()=>{ if(progressEl) progressEl.style.display = 'none'; }, 700); }
                    console.log('renderManageListsTables: finished rendering all items', { totalItems });
                }
            }, 200);
        }

        function deleteListItem(listName, id){
            if(!confirm('?? ??? ????? ?? ??? ??? ???????')) return;
            if(listName === 'finished'){ costFinished = costFinished.filter(x=>String(x.id)!==String(id)); }
            if(listName === 'raw'){ costRaw = costRaw.filter(x=>String(x.id)!==String(id)); }
            if(listName === 'pack'){ costPack = costPack.filter(x=>String(x.id)!==String(id)); }
            saveLists(); renderManageListsTables();
        }

        // export lists as JSON for download
        function exportLists(){ const payload = { finished: costFinished, raw: costRaw, pack: costPack, exportedAt: new Date().toISOString() }; const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = 'cost-lists-export.json'; document.body.appendChild(a); a.click(); a.remove(); }

        // Manage modal click handlers
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'manage-export-btn'){ exportLists(); }
            const delBtn = e.target && e.target.closest && e.target.closest('.manage-del-btn');
            if(delBtn){ const list = delBtn.getAttribute('data-list'); const id = delBtn.getAttribute('data-id'); if(list && id) deleteListItem(list, id); }
        });

        // Raw price registry handlers
        function renderRawPriceTable(){
            const tbody = document.querySelector('#raw-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costRaw || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.cost !== undefined ? it.cost : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="raw-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center raw-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="raw-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">???</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderFinishedPriceTable(){
            const tbody = document.querySelector('#finished-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costFinished || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.price !== undefined ? it.price : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="finished-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center finished-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="finished-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">???</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderPackPriceTable(){
            const tbody = document.querySelector('#pack-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costPack || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.cost !== undefined ? it.cost : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="pack-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center pack-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="pack-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">???</button></td>`;
                tbody.appendChild(tr);
            });
        }

        // ===== Price Manager (tables + history) =====
        function pmFormatDate(iso){ try { return iso ? new Date(iso).toLocaleString('ar-EG') : ''; } catch(_){ return ''; } }
        function getListByType(t){ return t==='raw'?costRaw : (t==='pack'?costPack : (t==='finished'?costFinished : costOps)); }
        function setListByType(t, arr){ if(t==='raw') costRaw = arr; else if(t==='pack') costPack = arr; else if(t==='finished') costFinished = arr; else costOps = arr; }
        // Expose helpers globally for other script sections that run outside this IIFE
        try { window.getListByType = getListByType; window.setListByType = setListByType; } catch(_){ }

        // Transient message/toast helper
        function showTransientMessage(msg, ms){
            try{
                const id = 'transient-msg';
                let el = document.getElementById(id);
                if(!el){
                    el = document.createElement('div'); el.id = id;
                    el.style.position = 'fixed'; el.style.right = '16px'; el.style.top = '70px'; el.style.zIndex = 9999;
                    el.style.background = 'rgba(0,0,0,0.8)'; el.style.color = '#fff'; el.style.padding = '8px 12px'; el.style.borderRadius = '6px'; el.style.fontSize = '13px';
                    document.body.appendChild(el);
                }
                el.textContent = msg;
                el.style.display = 'block';
                if(ms && ms>0){ setTimeout(()=>{ try{ el.style.display='none'; }catch(_){ } }, ms); }
            }catch(_){ console.log(msg); }
        }

        // Listen for cloud-save event to show confirmation and debug raw item persistence
        document.addEventListener('costListsSavedToCloud', function(ev){
            try{
                console.log('? ?? ??? ????? ?? ???????', ev && ev.detail);
                showTransientMessage('? ?? ??? ????? ?? ???????', 2500);
                // Debug: if we recently edited a raw item, print it from localStorage and in-memory
                try{
                    const lastId = window.__lastRawEditedId || null;
                    if(lastId){
                        let rawJson = null;
                        try{ rawJson = localStorage.getItem('cost_raw'); }catch(_){ }
                        let parsed = null;
                        try{ parsed = rawJson ? JSON.parse(rawJson) : null; }catch(_){ parsed = null; }
                        const found = Array.isArray(parsed) ? parsed.find(x=>String(x.id)===String(lastId)) : null;
                        console.log('?? post-cloud-save: lastRawEditedId=', lastId, 'inMemory=', (costRaw||[]).find(x=>String(x.id)===String(lastId)), 'localStorage=', found, 'rawLength=', (parsed||[]).length);
                    }
                }catch(_){ }
            }catch(_){ }
        });

        // Enter key handler for raw price inputs: save on Enter and show saving toast
        document.addEventListener('keydown', function(e){
            if(!e) return;
            const key = e.key || (e.keyCode ? (e.keyCode===13 ? 'Enter' : '') : '');
            if(key !== 'Enter') return;
            const target = e.target || document.activeElement;
            if(!target) return;
            if(target.classList && target.classList.contains('raw-price-input')){
                const id = target.getAttribute('data-id');
                if(id){
                    try{ console.log('? Enter pressed in raw input, saving...', { id }); }catch(_){ }
                    try{ showTransientMessage('???? ??? ????? ?? ???????...', 2000); }catch(_){ }
                    try{ saveRawPriceRow(id); }catch(err){ console.warn('saveRawPriceRow failed', err); }
                }
            }
        });

        // Simple history modal
        function openPriceHistory(type, id){
            const list = getListByType(type);
            const it = list.find(x=> String(x.id)===String(id));
            if(!it) return alert('?????? ??? ?????');
            const modal = document.getElementById('price-history-modal'); if(!modal) return;
            const title = modal.querySelector('#ph-title');
            const tbody = modal.querySelector('#ph-body');
            if(title) title.textContent = `??? ??????? � ${it.name||id}`;
            const esc = s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const hist = Array.isArray(it.priceHistory)? it.priceHistory : [];
            tbody.innerHTML = hist.length ? hist.map(h=> `<tr><td class="px-2 py-1 text-center">${Number(h.price||0).toFixed(2)}</td><td class="px-2 py-1 text-center">${esc(pmFormatDate(h.date))}</td><td class="px-2 py-1 text-right">${esc(h.note||'')}</td></tr>`).join('') : '<tr><td colspan="3" class="px-2 py-3 text-center text-gray-500">?? ???? ??? ?????</td></tr>';
            modal.setAttribute('data-type', type);
            modal.setAttribute('data-id', id);
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }
        function closePriceHistory(){ const m = document.getElementById('price-history-modal'); if(!m) return; m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); }
        function addPriceFromModal(){
            const m = document.getElementById('price-history-modal'); if(!m) return;
            const type = m.getAttribute('data-type'); const id = m.getAttribute('data-id');
            const priceInp = m.querySelector('#ph-new-price'); const noteInp = m.querySelector('#ph-new-note');
            const v = parseFloat(priceInp.value||0) || 0; const note = noteInp.value.trim();
            const list = getListByType(type); const it = list.find(x=> String(x.id)===String(id)); if(!it) return;
            const now = new Date().toISOString();
            it.lastPrice = v; it.lastPriceDate = now;
            it.priceHistory = Array.isArray(it.priceHistory) ? it.priceHistory : [];
            it.priceHistory.unshift({ price: v, date: now, note });
            saveLists(); // renderPriceManager() removed - feature deleted
            // refresh modal body
            openPriceHistory(type, id);
            // clear inputs
            priceInp.value = ''; noteInp.value = '';
        }

        // Wire price manager events
        document.addEventListener('click', function(e){
            // New buttons for PM
            // New buttons for PM
            // Price manager buttons removed - feature deleted
            // if(e.target && e.target.id === 'pm-refresh-btn'){ renderPriceManager(); }
            // if(e.target && e.target.id === 'pm-export-json-btn'){ pmExportJSON(); }
            // if(e.target && e.target.id === 'pm-export-csv-btn'){ pmExportCSV(); }
            // if(e.target && e.target.id === 'pm-print-btn'){ pmPrint(); }tem(); }
            // Price manager buttons removed - feature deleted
            // const tabBtn = e.target && e.target.closest && e.target.closest('#price-manager-block .pm-tab');
            // if(tabBtn){ pmSwitchTo(tabBtn.getAttribute('data-pm-tab')); }
            // const addBtn = e.target && e.target.closest && e.target.closest('.pm-add-price'); if(addBtn){ pmAddPrice(addBtn.getAttribute('data-type'), addBtn.getAttribute('data-id')); }
            const histBtn = e.target && e.target.closest && e.target.closest('.pm-view-history'); if(histBtn){ openPriceHistory(histBtn.getAttribute('data-type'), histBtn.getAttribute('data-id')); }
            if(e.target && e.target.id === 'ph-close-btn'){ closePriceHistory(); }
            if(e.target && e.target.id === 'ph-add-btn'){ addPriceFromModal(); }
        });

        // Install cloud listener after Firebase is ready
        function waitForDbReady(timeoutMs = 5000){
            return new Promise((resolve, reject) => {
                const start = Date.now();
                if (window.db) return resolve(window.db);
                const iv = setInterval(() => {
                    if (window.db) { clearInterval(iv); return resolve(window.db); }
                    if (Date.now() - start > timeoutMs) { clearInterval(iv); return reject(new Error('DB ready timeout')); }
                }, 150);
            });
        }

        document.addEventListener('DOMContentLoaded', function(){ 
            // CLEANUP: Remove corrupted localStorage values that cause JSON.parse errors
            try {
                const keysToClean = ['cost_raw', 'cost_pack', 'cost_finished', 'cost_ops'];
                keysToClean.forEach(key => {
                    const val = localStorage.getItem(key);
                    if (val === 'undefined' || val === 'null') {
                        console.log(`?? Cleaned corrupted localStorage key: ${key} (was: ${val})`);
                        localStorage.removeItem(key);
                    }
                });
            } catch(e){ console.warn('localStorage cleanup failed', e); }
            
            // Cloud-first initialization: attach realtime listener immediately so the app
            // receives authoritative data from Firestore (settings/costLists). LocalStorage
            // is kept only as a cache/fallback, not the source of truth.
            console.log('?? DOMContentLoaded: Initializing cost lists (cloud-first realtime listener)...');
            try {
                // Wait a short while for firebase init to complete so we don't register listeners
                // before the Firebase app and `db` are available (avoids app-compat/no-app errors).
                waitForDbReady(3000).then(() => {
                    try {
                        initRealtimeSync();
                    } catch(e){ console.warn('?? DOMContentLoaded: initRealtimeSync() failed', e); }
                }).catch(err => {
                    console.warn('?? DOMContentLoaded: DB not ready, skipping realtime listener:', err);
                    // Fallback: render from local cache if cloud hasn't arrived
                    try { if (!window.dataLoaded) { console.log('?? No cloud data yet, falling back to local cache for UI rendering'); loadLists(); } } catch(e){ console.warn('?? fallback loadLists failed', e); }
                    try { tryLoadCostListsFromCloud().catch(()=>{}); } catch(_){ }
                });

                // If realtime doesn't provide data within a short timeout, fall back to local cache
                setTimeout(() => {
                    try {
                        if (!window.dataLoaded) {
                            console.log('?? No cloud data yet (post-wait), falling back to local cache for UI rendering');
                            try { loadLists(); } catch(e){ console.warn('?? fallback loadLists failed', e); }
                            try { tryLoadCostListsFromCloud().catch(()=>{}); } catch(_){ }
                        }
                    } catch(_){ }
                }, 1200);
            } catch(e){ console.warn('?? DOMContentLoaded: cost lists cloud-first init failed', e); }
        });

        // ===== Unified Price Grid Renderer =====
        function renderUnifiedPriceGrid(){
            const wrap = document.getElementById('unified-price-grid-block'); if(!wrap) return;
            const tbody = document.querySelector('#unified-price-grid tbody'); if(!tbody) return;
            const esc = s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const all = [];
            // Build items from the canonical global arrays (window.*) to ensure latest persisted values are shown
            (window.costRaw || []).forEach(it=> all.push({type:'????', item:it}));
            (window.costPack || []).forEach(it=> all.push({type:'?????', item:it}));
            (window.costOps || []).forEach(it=> all.push({type:'?????', item:it}));
            (window.costFinished || []).forEach(it=> all.push({type:'???? ?????', item:it}));
            // sort alphabetically by type then name (Arabic aware)
            all.sort((a,b)=> {
                const typeCmp = a.type.localeCompare(b.type,'ar');
                if(typeCmp !== 0) return typeCmp;
                return String(a.item.name||'').localeCompare(String(b.item.name||''),'ar');
            });
            tbody.innerHTML = all.map(row => {
                const it = row.item;
                const last = (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:''));
                const date = it.lastPriceDate ? pmFormatDate(it.lastPriceDate) : '';
                return `<tr>
                    <td class="px-2 py-1 text-right">${esc(it.name||'')}</td>
                    <td class="px-2 py-1 text-center">
                        <span class="unified-code inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${esc(it.code||it.id||'')}</span>
                    </td>
                    <td class="px-2 py-1 text-center">${esc(row.type)}</td>
                    <td class="px-2 py-1 text-center">${esc(it.unit||'')}</td>
                    <td class="px-2 py-1 text-center">
                        <span class="unified-current-price inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${last!==''?Number(last).toFixed(2):''}</span>
                    </td>
                    <td class="px-2 py-1 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <input class="unified-new-price w-20 p-1 border rounded text-center text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}" placeholder="0.00" />
                            <button class="unified-save-price bg-blue-600 text-white px-2 py-0.5 rounded text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}">???</button>
                        </div>
                    </td>
                    <td class="px-2 py-1 text-center">${esc(date)}</td>
                </tr>`;
            }).join('');
            const sumEl = document.getElementById('unified-grid-summary');
            if(sumEl) sumEl.textContent = `????????: ${all.length} ????`;
        }

        // Export helpers
        function unifiedExportJSON(){
            const payload = { raw: costRaw, pack: costPack, ops: costOps, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'unified-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function unifiedExportCSV(){
            const rows = [];
            rows.push(['type','name','unit','currentPrice','lastDate']);
            const pushRows = (arr,type)=> (arr||[]).forEach(it=> rows.push([
                type,
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            pushRows(costRaw,'raw'); pushRows(costPack,'pack'); pushRows(costOps,'ops');
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'unified-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function unifiedPrint(){
            const block = document.getElementById('unified-price-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderUnifiedPriceGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        // Export functions for Raw, Pack, Ops unified grids
        function rawUnifiedExportJSON(){
            const payload = { raw: costRaw, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'raw-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function rawUnifiedExportCSV(){
            const rows = [];
            rows.push(['name','unit','currentPrice','lastDate']);
            (costRaw||[]).forEach(it=> rows.push([
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'raw-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function rawUnifiedPrint(){
            const block = document.getElementById('raw-unified-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderRawUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        function packUnifiedExportJSON(){
            const payload = { pack: costPack, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'pack-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function packUnifiedExportCSV(){
            const rows = [];
            rows.push(['name','unit','currentPrice','lastDate']);
            (costPack||[]).forEach(it=> rows.push([
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'pack-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function packUnifiedPrint(){
            const block = document.getElementById('pack-unified-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderPackUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        function opsUnifiedExportJSON(){
            const payload = { ops: costOps, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'ops-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function opsUnifiedExportCSV(){
            const rows = [];
            rows.push(['name','unit','currentPrice','lastDate']);
            (costOps||[]).forEach(it=> rows.push([
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'ops-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function opsUnifiedPrint(){
            const block = document.getElementById('ops-unified-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderOpsUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        // Small helper to show a transient "Saved" indicator next to an element
        function showSavedIndicator(el, text){
            try{
                const label = document.createElement('span');
                label.className = 'unified-saved-indicator';
                label.style.cssText = 'display:inline-block;margin-left:8px;color:#16a34a;font-size:12px;font-weight:600;opacity:0;transition:opacity .18s';
                label.textContent = text || '?? ?????';
                // place after element (if element is inside container) or append to parent
                if(el && el.parentNode){
                    // remove any existing indicator near this element
                    const existing = el.parentNode.querySelector('.unified-saved-indicator');
                    if(existing) existing.remove();
                    el.parentNode.appendChild(label);
                    // force fade-in
                    setTimeout(()=> label.style.opacity = '1', 20);
                    // fade out and remove
                    setTimeout(()=> { label.style.opacity = '0'; setTimeout(()=> { try{ label.remove(); }catch(_){ } }, 220); }, 1400);
                }
            }catch(e){ console.warn('showSavedIndicator failed', e); }
        }

        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'unified-refresh-btn'){ renderUnifiedPriceGrid(); }
            if(e.target && e.target.id === 'unified-export-json-btn'){ unifiedExportJSON(); }
            if(e.target && e.target.id === 'unified-export-csv-btn'){ unifiedExportCSV(); }
            if(e.target && e.target.id === 'unified-print-btn'){ unifiedPrint(); }
            const inlineBtn = e.target && e.target.closest && e.target.closest('.unified-save-price');
            if(inlineBtn){
                const typeLabel = inlineBtn.getAttribute('data-type');
                const id = inlineBtn.getAttribute('data-id');
                const inp = document.querySelector(`.unified-new-price[data-id="${CSS.escape(id)}"][data-type="${CSS.escape(typeLabel)}"]`);
                if(!inp) return;
                const rawVal = inp.value.trim(); 
                if(rawVal==='') { alert('???? ????? ??????'); return; }
                const num = parseFloat(rawVal); 
                if(isNaN(num)){ alert('??? ??? ????'); return; }
                // map Arabic type label to internal key (include finished)
                const mapType = t => t==='????'?'raw': (t==='?????'?'pack': (t==='?????'?'ops': (t==='???? ?????'?'finished':'raw')));
                const tKey = mapType(typeLabel);
                const list = getListByType(tKey) || [];
                const it = list.find(x=> String(x.id) === String(id)); 
                if(!it){ alert('?????? ??? ?????'); return; }
                console.log('?? Inline save price button clicked:', {typeLabel, id, newPrice: num});
                const now = new Date().toISOString();
                it.lastPrice = num; 
                it.lastPriceDate = now; 
                it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; 
                it.priceHistory.unshift({ price: num, date: now, note: '???? ?????' });
                saveLists(); 
                // renderPriceManager() removed - feature deleted
                renderUnifiedPriceGrid();
                inp.value='';
                console.log('? Price saved and grid refreshed');
                console.log('? Price saved and grid refreshed');
            }
        });

        // ??? ????? ????? ?? ???? "?????" (Enter ?? ??? ??????)
        function __commitUnifiedCode(el){
            if(!el) return;
            const typeLabel = el.getAttribute('data-type');
            const id = el.getAttribute('data-id');
            const txt = (el.textContent||'').trim();
            console.log('?? Editing code:', {typeLabel, id, newCode: txt});
            const mapType = t => t==='????'?'raw': (t==='?????'?'pack': (t==='?????'?'ops': (t==='???? ?????'?'finished':'raw')));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); 
            if(!it) { console.warn('? Item not found for code edit'); return; }
            if ((it.code||'') === txt) { console.log('?? Code unchanged'); return; }
            it.code = txt;
            console.log('?? Committing code change to storage...');
            saveLists(); 
            // renderPriceManager() removed - feature deleted
            renderUnifiedPriceGrid();
        }
        document.addEventListener('focusin', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
        });
        document.addEventListener('keydown', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span && e.key === 'Enter'){
                e.preventDefault(); __commitUnifiedCode(span);
                try { span.blur(); } catch(_){}
            }
        });
        document.addEventListener('focusout', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span){ __commitUnifiedCode(span); }
        });

        // ??? ????? ????? ?? ???? "????? ??????" (Enter ?? ??? ??????)
        function __commitUnifiedCurrentPrice(el){
            if(!el) return;
            const typeLabel = el.getAttribute('data-type');
            const id = el.getAttribute('data-id');
            const txt = (el.textContent||'').trim(); 
            if(txt==='') { console.log('?? Price empty, ignoring'); return; } // ?????? ??????
            const val = parseFloat(txt);
            if(isNaN(val)) { 
                console.warn('? Invalid price value:', txt);
                el.textContent = el.getAttribute('data-prev') || el.textContent; 
                return; 
            }
            console.log('?? Editing price:', {typeLabel, id, newPrice: val});
            const mapType = t => t==='????'?'raw': (t==='?????'?'pack': (t==='?????'?'ops': (t==='???? ?????'?'finished':'raw')));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); 
            if(!it) { console.warn('? Item not found for price edit'); return; }
            const prev = (it.lastPrice!=null?Number(it.lastPrice):(it.cost!=null?Number(it.cost):null));
            if(prev!=null && Number(prev).toFixed(2) === Number(val).toFixed(2)) { 
                console.log('?? Price unchanged');
                el.textContent = Number(prev).toFixed(2); 
                return; 
            }
            const now = new Date().toISOString();
            it.lastPrice = val; 
            it.lastPriceDate = now; 
            it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; 
            it.priceHistory.unshift({ price: val, date: now, note: '????? ?????' });
            console.log('?? Committing price change to storage...', {oldPrice: prev, newPrice: val});
            saveLists(); 
            // update only the edited element and show saved indicator; avoid full grid re-render to keep focus
            el.textContent = Number(val).toFixed(2);
            showSavedIndicator(el);
        }
        document.addEventListener('focusin', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
        });
        document.addEventListener('keydown', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span && e.key === 'Enter'){
                e.preventDefault(); __commitUnifiedCurrentPrice(span);
                try { span.blur(); } catch(_){}
            }
        });
        document.addEventListener('focusout', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span){ __commitUnifiedCurrentPrice(span); }
        });

        function saveRawPriceRow(id){
            try{
                console.log('?? saveRawPriceRow: entering', { id });
                const safeId = CSS && CSS.escape ? CSS.escape(id) : id;
                const inp = document.querySelector(`.raw-price-input[data-id="${safeId}"]`);
                if(!inp){ console.warn('saveRawPriceRow: input not found for id', id); return; }
                const v = parseFloat(inp.value || 0) || 0;
                const itIndex = costRaw.findIndex(x => String(x.id) === String(id));
                const it = itIndex >= 0 ? costRaw[itIndex] : null;
                if(!it) { console.warn('saveRawPriceRow: item not found in costRaw', id); return alert('?????? ??? ?????'); }
                // also update name and unit from inputs
                const nameInp = document.querySelector(`.raw-name-input[data-id="${safeId}"]`);
                const unitInp = document.querySelector(`.raw-unit-input[data-id="${safeId}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                console.log('?? saveRawPriceRow: before change', { id, prev, newValue: v });
                if(v !== prev){
                    it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate });
                    // write back to array in case of reference issues
                    costRaw[itIndex] = it;
                    try{ window.__lastRawEditedId = id; }catch(_){ }
                    console.log('?? saveRawPriceRow: item updated in memory', it);
                } else {
                    console.log('?? saveRawPriceRow: price unchanged for', id);
                }
                saveLists();
                try{ console.log('?? saveRawPriceRow: localStorage cost_raw snapshot length', (localStorage.getItem('cost_raw')||'').length); }catch(_){ }
                renderRawPriceTable();
                // also refresh BOM selects so new lastPrice appears in data-lastprice
                renderProductSelect();
                // update any open BOM rows that reference this item (if autofill enabled)
                try{ updateBomRowsAfterPriceChange(id, 'raw'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
            }catch(e){ console.warn('saveRawPriceRow: unexpected error', e); }
        }

        function saveFinishedPriceRow(id){
            const inp = document.querySelector(`.finished-price-input[data-id="${id}"]`);
            if(!inp) return;
            const v = parseFloat(inp.value || 0) || 0;
            const it = costFinished.find(x => String(x.id) === String(id));
            if(!it) return alert('?????? ??? ?????');
            const nameInp = document.querySelector(`.finished-name-input[data-id="${id}"]`);
            const unitInp = document.querySelector(`.finished-unit-input[data-id="${id}"]`);
            if(nameInp) it.name = nameInp.value.trim();
            if(unitInp) it.unit = unitInp.value.trim();
            const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.price||0);
            if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
            saveLists(); renderFinishedPriceTable(); renderProductSelect();
            try{ updateBomRowsAfterPriceChange(id, 'finished'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
        }

        function savePackPriceRow(id){
            const inp = document.querySelector(`.pack-price-input[data-id="${id}"]`);
            if(!inp) return;
            const v = parseFloat(inp.value || 0) || 0;
            const it = costPack.find(x => String(x.id) === String(id));
            if(!it) return alert('?????? ??? ?????');
            const nameInp = document.querySelector(`.pack-name-input[data-id="${id}"]`);
            const unitInp = document.querySelector(`.pack-unit-input[data-id="${id}"]`);
            if(nameInp) it.name = nameInp.value.trim();
            if(unitInp) it.unit = unitInp.value.trim();
            const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
            if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
            saveLists(); renderPackPriceTable(); renderProductSelect();
            try{ updateBomRowsAfterPriceChange(id, 'pack'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
        }

        function saveAllPrices(){
            let changed = 0;
            const changedIds = new Set();
            // finished
            Array.from(document.querySelectorAll('.finished-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costFinished.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.finished-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.finished-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.price||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            // raw
            Array.from(document.querySelectorAll('.raw-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costRaw.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.raw-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.raw-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            // pack
            Array.from(document.querySelectorAll('.pack-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costPack.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.pack-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.pack-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            if(changed > 0){ saveLists(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable(); renderProductSelect();
                // update BOM rows for each changed id
                try{ changedIds.forEach(i=> updateBomRowsAfterPriceChange(i)); }catch(e){console.warn('updateBomRowsAfterPriceChange bulk failed', e); }
                alert('?? ??? ' + changed + ' ?????.');
            } else alert('?? ??????? ?????.');
        }

        // When a price changes, update any visible BOM rows that reference that component
        function updateBomRowsAfterPriceChange(itemId, listType){
            try{
                // only proceed if autofill is enabled
                const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                if(!auto) return;
                if(!itemId) return;
                const tbody = document.getElementById('cost-bom-body'); if(!tbody) return;
                // find the new price from lists
                const findPrice = (id) => {
                    let found = (costRaw||[]).find(x=>String(x.id)===String(id)) || (costPack||[]).find(x=>String(x.id)===String(id)) || (costFinished||[]).find(x=>String(x.id)===String(id));
                    if(!found) return 0;
                    return Number(found.lastPrice !== undefined && found.lastPrice !== null ? found.lastPrice : (found.cost !== undefined ? found.cost : (found.price !== undefined ? found.price : 0)));
                };

                const newPrice = findPrice(itemId);
                Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                    const compSel = tr.querySelector('.cost-comp-select');
                    if(!compSel) return;
                    if(String(compSel.value) === String(itemId)){
                        const unitCostInp = tr.querySelector('.cost-comp-unitcost');
                        const qtyInp = tr.querySelector('.cost-comp-qty');
                        const totalSpan = tr.querySelector('.cost-comp-total');
                        if(unitCostInp){
                            unitCostInp.value = Number(newPrice || 0).toFixed(2);
                        }
                        // update total display for the row
                        const q = parseFloat(qtyInp && qtyInp.value || 0) || 0;
                        const uc = parseFloat(unitCostInp && unitCostInp.value || 0) || 0;
                        const tot = Math.round(q * uc * 100) / 100;
                        if(totalSpan) totalSpan.textContent = tot.toFixed(2);
                    }
                });
                // recalc totals after updating rows
                calculateTotals();
            }catch(e){ console.warn('updateBomRowsAfterPriceChange error', e); }
        }

        function exportPrices(){ const payload = { raw: costRaw || [], exportedAt: new Date().toISOString() }; const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = 'cost-raw-prices.json'; document.body.appendChild(a); a.click(); a.remove(); }

        function importPricesFromJSON(obj){
            if(!obj || !Array.isArray(obj.raw)) return alert('????? ?? ????? ??? ?????? ????? ?????');
            let added = 0, updated = 0;
            obj.raw.forEach(r => {
                const id = r.id || r.code || null; if(!id) return;
                const existing = costRaw.find(x => String(x.id) === String(id));
                if(existing){
                    // update lastPrice if present
                    if(r.lastPrice !== undefined){ existing.lastPrice = r.lastPrice; existing.lastPriceDate = r.lastPriceDate || new Date().toISOString(); existing.priceHistory = existing.priceHistory || []; existing.priceHistory.unshift({ price: existing.lastPrice, date: existing.lastPriceDate }); updated++; }
                } else {
                    // add minimal entry
                    const newItem = { id, code: id, name: r.name||r.title||'', unit: r.unit||'', cost: r.cost||0, lastPrice: r.lastPrice||r.cost||0, lastPriceDate: r.lastPriceDate||new Date().toISOString(), priceHistory: r.priceHistory||[] };
                    costRaw.push(newItem); added++;
                }
            });
            saveLists(); renderRawPriceTable(); renderProductSelect(); alert('?? ???????: ?? ????? ' + added + ' � ?? ????? ' + updated);
        }

        // wire raw price registry UI
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'export-prices-btn'){ exportPrices(); }
            if(e.target && e.target.id === 'import-prices-btn'){ const inp = document.getElementById('import-prices-input'); if(inp) inp.click(); }
            if(e.target && e.target.id === 'save-all-prices-btn'){ saveAllPrices(); }
            const saveBtn = e.target && e.target.closest && e.target.closest('.raw-price-save-btn'); if(saveBtn){ const id = saveBtn.getAttribute('data-id'); if(id) saveRawPriceRow(id); }
        });

        // import file handler
        const importInp = document.getElementById('import-prices-input'); if(importInp) importInp.addEventListener('change', function(e){
            const f = e.target.files && e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = function(ev){ try{ const obj = JSON.parse(String(ev.target.result || '{}')); importPricesFromJSON(obj); }catch(err){ alert('??? ????? ?????: ' + err.message); } }; reader.readAsText(f); e.target.value = '';
        });
        
        // add empty raw row
        function addEmptyRawRow(){
            const id = 'raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
            costRaw.push({ id, code: id, name: '', unit: '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
            saveLists(); renderRawPriceTable();
        }

        // import names from app state (state.products or DEFAULT_PRODUCTS)
        function importRawNamesFromState(){
            const src = (Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
            if(!src || !src.length) return alert('?? ???? ?????? ?? ???? ??????? ?????????.');
            if(!confirm('?? ???? ??????? ????? ???????? ?? ?????? ??????? ??????? ???? ????? ?????? ??? ????? ???????.')) return;
            let added = 0;
            src.forEach(p => {
                const id = p.id || p.code || ('raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                if(!costRaw.some(x => String(x.id) === String(id) || (x.name && x.name.trim() === (p.name||p.title||'').trim()))) {
                    costRaw.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
                    added++;
                }
            });
            saveLists(); renderRawPriceTable(); renderProductSelect(); alert('?? ????? ' + added + ' ???? ?? ?????? ???????.');
        }

        // wire new buttons
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'add-empty-raw-btn'){ addEmptyRawRow(); }
            if(e.target && e.target.id === 'import-raw-from-state-btn'){ importRawNamesFromState(); }
        });

        // Attach direct listener to the manage button (robust against inner elements)
        document.addEventListener('DOMContentLoaded', function(){
            const mb = document.getElementById('cost-manage-lists-btn'); if(mb) mb.addEventListener('click', openManageListsModal);
        });

        // Add list handlers
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'add-finished-btn'){
                const name = document.getElementById('prod-finished-name').value.trim();
                const code = document.getElementById('prod-finished-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-finished-unit').value.trim() || '????';
                const price = parseFloat(document.getElementById('prod-finished-price').value || 0) || 0;
                if(!name) return alert('???? ??? ?????? ?????');
                costFinished.push({ id: code, code, name, unit, price }); saveLists();
                document.getElementById('prod-finished-name').value=''; document.getElementById('prod-finished-code').value=''; document.getElementById('prod-finished-price').value='';
            }
            if(e.target && e.target.id === 'add-raw-btn'){
                const name = document.getElementById('prod-raw-name').value.trim();
                const code = document.getElementById('prod-raw-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-raw-unit').value.trim() || '???';
                const cost = parseFloat(document.getElementById('prod-raw-cost').value || 0) || 0;
                if(!name) return alert('???? ??? ??????');
                costRaw.push({ id: code, code, name, unit, cost }); saveLists();
                document.getElementById('prod-raw-name').value=''; document.getElementById('prod-raw-code').value=''; document.getElementById('prod-raw-cost').value='';
            }
            if(e.target && e.target.id === 'add-pack-btn'){
                const name = document.getElementById('prod-pack-name').value.trim();
                const code = document.getElementById('prod-pack-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-pack-unit').value.trim() || '????';
                const cost = parseFloat(document.getElementById('prod-pack-cost').value || 0) || 0;
                if(!name) return alert('???? ??? ???????');
                costPack.push({ id: code, code, name, unit, cost }); saveLists();
                document.getElementById('prod-pack-name').value=''; document.getElementById('prod-pack-code').value=''; document.getElementById('prod-pack-cost').value='';
            }
        });

        // BOM row creation
        function createComponentOptionHTML(list){ return list.map(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? Number(it.lastPrice) : (it.cost !== undefined ? Number(it.cost) : (it.price !== undefined ? Number(it.price) : 0));
                return `<option value="${escapeHtml(it.id)}" data-unit="${escapeHtml(it.unit||'')}" data-cost="${Number(it.cost||it.price||0)}" data-lastprice="${last}">${escapeHtml(it.name)} (${escapeHtml(it.unit||'')})</option>`;
            }).join(''); }

        function addBOMRow(data){
            const tbody = document.getElementById('cost-bom-body'); if(!tbody) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-2 py-1 text-right">
                    <select class="cost-comp-type p-1 border rounded"><option value="raw">????</option><option value="pack">?????</option></select>
                </td>
                <td class="px-2 py-1 text-right">
                    <select class="cost-comp-select p-1 border rounded"></select>
                </td>
                <td class="px-2 py-1 text-center"><input class="cost-comp-qty p-1 border rounded text-center" value="${data && data.qty ? data.qty : 1}" style="width:90px" /></td>
                <td class="px-2 py-1 text-center"><span class="cost-comp-unit">${data && data.unit?escapeHtml(data.unit):''}</span></td>
                <td class="px-2 py-1 text-center"><input class="cost-comp-unitcost p-1 border rounded text-center" value="${data && data.unitCost?data.unitCost:0}" style="width:110px" /></td>
                <td class="px-2 py-1 text-center"><span class="cost-comp-total">0.00</span></td>
                <td class="px-2 py-1 text-center"><button class="cost-remove-row bg-red-500 text-white px-2 rounded">???</button></td>
            `;
            tbody.appendChild(tr);
            const typeSel = tr.querySelector('.cost-comp-type');
            const compSel = tr.querySelector('.cost-comp-select');
            // ensure row cells allow dropdowns to overflow if needed
            try{ tr.style.overflow = 'visible'; if(typeSel && typeSel.parentElement) typeSel.parentElement.style.overflow = 'visible'; if(compSel && compSel.parentElement) compSel.parentElement.style.overflow = 'visible'; }catch(e){}
            const qtyInp = tr.querySelector('.cost-comp-qty');
            const unitSpan = tr.querySelector('.cost-comp-unit');
            const unitCostInp = tr.querySelector('.cost-comp-unitcost');
            const totalSpan = tr.querySelector('.cost-comp-total');

            function populateOptions(){
                const isRaw = typeSel.value === 'raw';
                compSel.innerHTML = isRaw ? createComponentOptionHTML(costRaw) : createComponentOptionHTML(costPack);
                if(data && data.id) compSel.value = data.id;
                // set unit and unitcost
                const opt = compSel.options[compSel.selectedIndex];
                if(opt){
                    unitSpan.textContent = opt.getAttribute('data-unit') || '';
                    // if auto-fill from last price is enabled and this is a raw item, prefer data-lastprice
                    const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                    if(isRaw && auto){ unitCostInp.value = Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0); }
                    else { unitCostInp.value = Number(opt.getAttribute('data-cost')||0); }
                }
                recalc();
            }

            // Workarounds: ensure the select receives pointer events and is above overlays
            try{
                [compSel, typeSel].forEach(s=>{
                    if(!s) return;
                    s.style.position = 'relative';
                    s.style.zIndex = 9999;
                    s.style.pointerEvents = 'auto';
                    // make native dropdown arrow available across browsers
                    s.style.webkitAppearance = 'menulist';
                    s.style.MozAppearance = 'menulist-button';
                    s.addEventListener('mousedown', function(ev){ ev.stopPropagation(); });
                    s.addEventListener('click', function(ev){ ev.stopPropagation(); });
                    s.addEventListener('focus', ()=>{ s.style.zIndex = 12000; });
                    s.addEventListener('blur', ()=>{ s.style.zIndex = 9999; });
                });
            }catch(e){/* ignore */}

            function recalc(){
                const q = parseFloat(qtyInp.value || 0) || 0;
                const uc = parseFloat(unitCostInp.value || 0) || 0;
                const tot = Math.round((q * uc) * 100) / 100;
                totalSpan.textContent = tot.toFixed(2);
                calculateTotals();
            }

            typeSel.addEventListener('change', populateOptions);
            compSel.addEventListener('change', () => {
                const opt = compSel.options[compSel.selectedIndex];
                if(opt){
                    unitSpan.textContent = opt.getAttribute('data-unit') || '';
                    const isRaw = typeSel.value === 'raw';
                    const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                    if(isRaw && auto) unitCostInp.value = Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0);
                    else unitCostInp.value = Number(opt.getAttribute('data-cost')||0);
                }
                recalc();
            });
            qtyInp.addEventListener('input', recalc);
            unitCostInp.addEventListener('input', recalc);
            tr.querySelector('.cost-remove-row').addEventListener('click', ()=>{ tr.remove(); calculateTotals(); });

            populateOptions();
        }

        function calculateTotals(){
            const rows = Array.from(document.querySelectorAll('#cost-bom-body tr'));
            let rawSum = 0; let packSum = 0;
            rows.forEach(r => {
                const type = (r.querySelector('.cost-comp-type') && r.querySelector('.cost-comp-type').value) || 'raw';
                const q = parseFloat((r.querySelector('.cost-comp-qty') && r.querySelector('.cost-comp-qty').value) || 0) || 0;
                const uc = parseFloat((r.querySelector('.cost-comp-unitcost') && r.querySelector('.cost-comp-unitcost').value) || 0) || 0;
                const tot = Math.round(q * uc * 100) / 100;
                if(type === 'raw') rawSum += tot; else packSum += tot;
            });

            const yieldVal = parseFloat(document.getElementById('cost-yield').value || 1) || 1;

            // overheads
            const overheadFixed = parseFloat(document.getElementById('cost-overhead-fixed') && document.getElementById('cost-overhead-fixed').value || 0) || 0; // fixed per batch
            const overheadPercent = parseFloat(document.getElementById('cost-overhead-percent') && document.getElementById('cost-overhead-percent').value || 0) || 0; // percent of raw materials

            // percent amount is applied on rawSum (total materials) for the whole batch
            const overheadPercentAmount = Math.round((rawSum * (overheadPercent / 100)) * 100) / 100;

            // per-unit fixed overhead = fixed per batch / yield
            const overheadFixedPerUnit = yieldVal ? Math.round((overheadFixed / yieldVal) * 100) / 100 : 0;

            // total per-unit cost = (raw + pack + overheadPercentAmount + overheadFixed) / yield
            const perUnit = Math.round(((rawSum + packSum + overheadPercentAmount + overheadFixed) / yieldVal) * 100) / 100;

            // update UI
            const rawEl = document.getElementById('cost-raw-total'); if(rawEl) rawEl.textContent = rawSum.toFixed(2);
            const packEl = document.getElementById('cost-pack-total'); if(packEl) packEl.textContent = packSum.toFixed(2);
            const fixedPerUnitEl = document.getElementById('cost-overhead-fixed-perunit'); if(fixedPerUnitEl) fixedPerUnitEl.textContent = overheadFixedPerUnit.toFixed(2);
            const percentAmtEl = document.getElementById('cost-overhead-percent-amount'); if(percentAmtEl) percentAmtEl.textContent = overheadPercentAmount.toFixed(2);
            const totalPerUnitEl = document.getElementById('cost-total-per-unit'); if(totalPerUnitEl) totalPerUnitEl.textContent = perUnit.toFixed(2);
        }

        // Save / load BOM for selected product
        function saveBOMForSelected(){
            const sel = document.getElementById('cost-product-select'); if(!sel) return alert('???? ?????? ?????');
            const pid = sel.value; if(!pid) return alert('???? ?????? ?????');
            const rows = Array.from(document.querySelectorAll('#cost-bom-body tr')).map(r => ({ type: r.querySelector('.cost-comp-type').value, id: r.querySelector('.cost-comp-select').value, qty: parseFloat(r.querySelector('.cost-comp-qty').value||0)||0, unit: r.querySelector('.cost-comp-unit').textContent||'', unitCost: parseFloat(r.querySelector('.cost-comp-unitcost').value||0)||0 }));
            const payload = { yield: parseFloat(document.getElementById('cost-yield').value||1)||1, items: rows, savedAt: new Date().toISOString() };
            localStorage.setItem(LS_BOM_PREFIX + pid, JSON.stringify(payload));
            alert('?? ??? BOM ??????');
        }

        function ensureDefaultBOMRows(){ /* legacy BOM disabled after simplification */ return; }

        function loadBOMForProduct(pid){ /* legacy BOM disabled */ return; }

        // UI bindings
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'new-bom-row-btn'){ addBOMRow(); }
            if(e.target && e.target.id === 'cost-save-bom-btn'){ saveBOMForSelected(); }
            if(e.target && e.target.id === 'cost-export-btn'){
                const summary = `????? ????: ${document.getElementById('cost-total-per-unit').textContent} � ?????: ${document.getElementById('cost-raw-total').textContent} � ?????: ${document.getElementById('cost-pack-total').textContent}`;
                navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(summary).then(()=>alert('?? ??? ??????')) : prompt('???? ?????? ??????:', summary);
            }
            if(e.target && e.target.id === 'cost-load-sample'){
                // small sample to help user start
                costFinished.push({ id: 'P-001', code: 'P-001', name: '???? ??????', unit: '????', price: 100 });
                costRaw.push({ id: 'R-001', code: 'R-001', name: '???', unit: '???', cost: 20 });
                costPack.push({ id: 'K-001', code: 'K-001', name: '???? ???????', unit: '????', cost: 1.5 });
                saveLists(); alert('?? ????? ????? ????');
            }
            if(e.target && e.target.id === 'cost-save-all-lists'){ saveLists(); alert('?? ??? ???????'); }
        });

        // when product selection changes, load saved BOM if exists
        document.addEventListener('change', function(e){
            if(e.target && e.target.id === 'cost-product-select'){
                document.getElementById('cost-bom-body').innerHTML='';
                const pid = e.target.value; if(!pid){ ensureDefaultBOMRows(); return; } loadBOMForProduct(pid);
            }
            // recalculations when yield or overhead fields change (change event)
            if(e.target && (e.target.id === 'cost-yield' || e.target.id === 'cost-overhead-fixed' || e.target.id === 'cost-overhead-percent')) calculateTotals();
        });

        // live-update totals while user types overheads
        ['cost-overhead-fixed','cost-overhead-percent'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', () => calculateTotals());
        });

        // Recalculate totals whenever the BOM body changes (delegated)
        const bomObserver = new MutationObserver(()=> calculateTotals());
        const bomBody = document.getElementById('cost-bom-body'); if(bomBody) bomObserver.observe(bomBody, { childList:true, subtree:true });

        // show page handler
        function onShowCostsPage(){
            try{ document.getElementById('header-title').textContent = '????????'; }catch(e){}
            // ?? CRITICAL FIX: Reload lists from localStorage to ensure data persists after refresh
            try { 
                console.log('?? onShowCostsPage: reloading lists from localStorage...'); 
                loadLists(); 
            } catch(e) { 
                console.warn('onShowCostsPage: loadLists() failed', e); 
                // Fallback: just render if loadLists fails
                // renderPriceManager() removed - feature deleted
            }
            // Call simplified cost renderers if available
            // renderQuickLists removed - feature deleted
            if(window.renderRecipes) window.renderRecipes();
            // ????? ??????? ???? ???? ??? ??? ?? ???? ????? ???????? ?????? ????? ????? ?????
            try {
                if (window.autoImportLegacyRecipesOnce) window.autoImportLegacyRecipesOnce();
                if (window.autoRestoreCostListsOnce) window.autoRestoreCostListsOnce();
            } catch(_){ }
        }

        // wire to nav clicks
        document.addEventListener('click', function(e){
            const btn = e.target.closest && e.target.closest('.bottom-nav-item');
            if(btn && btn.getAttribute('data-page') === 'costs'){ setTimeout(onShowCostsPage, 40); }
        });

        // Also detect programmatic navigation
        const pageObserver = new MutationObserver(muts => {
            muts.forEach(m => {
                if(m.target && m.target.id === 'page-costs' && m.attributeName === 'class'){
                    if(m.target.classList.contains('active')) onShowCostsPage();
                }
            });
        });
        const pageCostsEl = document.getElementById('page-costs'); if(pageCostsEl) pageObserver.observe(pageCostsEl, { attributes: true });

        // initialize data on load
        // loadLists() call removed here; initialization centralized earlier to avoid races

        // Restore from price lists: clear any previous Excel import and import finished products from app price lists
        function restoreFromPriceLists(){
            try{
                // clear existing lists (remove any Excel-imported entries)
                costFinished = [];
                costRaw = [];
                costPack = [];

                const src = (Array.isArray(state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
                let added = 0;
                src.forEach(p =>{
                    const id = p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || '????', price: Number(p.price||p.sellPrice||0) });
                    added++;
                });
                saveLists();
                console.log('restoreFromPriceLists: imported', added, 'products');
                alert('?? ??? ?????? ????????? ??????? ???????? ???????? ?? ????? ??????? (' + added + ' ????).');
            } catch(e){ console.warn('restoreFromPriceLists failed', e); alert('??? ??????? ????? ???????: ' + (e && e.message)); }
        }
        // expose for manual usage and UI button
        window.restoreFromPriceLists = restoreFromPriceLists;

        // ????? ????? ??????? ??? ?????: ???? ????? ???????? ?????? ???????? ???????
        window.autoRestoreCostListsOnce = (function(){
            let done = false;
            let retries = 0;
            const maxRetries = 10;
            const retryDelayMs = 500;
            function attempt(){
                if (done) return;
                try {
                    try { if (typeof loadLists === 'function') loadLists(); } catch(_){ }
                    const hasAny = (Array.isArray(window.costFinished) && window.costFinished.length)
                                  || (Array.isArray(window.costRaw) && window.costRaw.length)
                                  || (Array.isArray(window.costPack) && window.costPack.length);
                    if (hasAny) { done = true; return; }
                    const hasProducts = Array.isArray(state.products) && state.products.length;
                    if (hasProducts) {
                        restoreFromPriceLists();
                        // renderQuickLists removed - feature deleted
                        done = true; return;
                    }
                    if (retries < maxRetries) { retries++; setTimeout(attempt, retryDelayMs); return; }
                    // No products after retries; leave it to manual button
                    done = true;
                } catch(_){ done = true; }
            }
            return attempt;
        })();

    // NOTE: auto-restore from price lists was previously executed here on load and caused unwanted alerts.
    // Auto-run has been disabled to avoid automatic popups. To run restore manually, call restoreFromPriceLists() from the console or add a dedicated button.
    // try{ restoreFromPriceLists(); } catch(e){}

        // Add bulk packaging items provided by user into costPack (avoid duplicates)
        (function addDefaultPackItems(){
            const PACK_ITEMS = [
"?????? ????",
"????? ???",
"?????? ?? ????? 3?",
"?????? ?? ????? 8?",
"?????? ?? ??? 3?",
"?????? ?? ??? 8?",
"??????  ??? ???? ????? 8?",
"?????? ??? ???? ????? 8?",
"?????? ???? ????? ????? 8 ?",
"?????? ???? ????? ????? 8 ?",
"?????? ???? ???? ????? 8?",
"?????? ???? ???? ????? 8?",
"?????? ???? ???? ????? 8?",
"?????? ???? ???? ????? 8?",
"?????? ???? ????? 3?",
"?????? ???? ????? 3?",
"?????? ????? 2.5?",
"?????? ????? 300 ??",
"?????? ??? ???? 3?",
"?????? ???? ????? 3?",
"?????? ???????? ????? 4?",
"?????? ???? ??????",
"?????? ???? ????",
"?????? ???? ????",
"?????? ???? ????",
"?????? ???? ?????",
"?????? ???? ????",
"???? ?????? ????",
"???? ?????? ????",
"???? ???? ???? ?????",
"????? ????? 8?",
"?????? 40*40",
"?????? ????",
"?????? ???? ???? ?????",
"?????? ??? ???? ?????",
"?????? ???? ????? ?????",
"?????? ???? ????? ?????",
"?????? ???? 30-30",
"??? ??? ?????",
"?????? ????? 70-70",
"????? ???? 27*45",
"??? ??? ????",
"??? ???? ????",
"??? ???? ????",
"????? ??? ???? 1?",
"?????? 800 ??",
"?????? 500 ??",
"?????? 300 ??",
"??? ??????? 1?",
"???? ???? 8? ???????",
"???? ???? 8?",
"???? ???? 3? ???????",
"???? ???? 3?",
"????  ????? 100 ??",
"???? ?????? ????",
"???? ????? 140 ??",
"?????? ???? ?????? 1?",
"?????? ???? ?????? 900??",
"?????? ???? ??????500??",
"?????? ???? ???? 1?",
"?????? ???? ???? 900??",
"?????? ???? ???? 500??",
"?????? ??? ?????? 800 ??",
"?????? ???? ??? ?????? 800 ??",
"?????? ??? ?????? 500 ??",
"?????? ???? ??? ?????? 500 ??",
"?????? ??? ?????? 200 ??",
"?????? ???? ??? ?????? 200 ??",
"?????? ??? ???? 800 ??",
"?????? ???? ??? ???? 800 ??",
"?????? ??? ???? 500 ??",
"?????? ???? ??? ???? 500 ??",
"?????? ??? ???? 200 ??",
"?????? ???? ??? ???? 200 ??",
"?????? ?? ??? 10?",
"?????? ?? ????? 10?",
"?????? ????? ???",
"?????? ????? ?????",
"?????? ????? ??? 800 ??",
"?????? ????? ??? 500 ??",
"?????? ????? ???-????? 200 ??",
"??? ?????? 40??",
"????? ?????  ??????",
"??? ???? ?? ????",
"??? ???? ?? ????",
"???? ???? ????",
"???? ???? ????",
"????? ??? ???? 2?",
"???? ????",
"???? ??????? ????",
"???? ??????? ????",
"?????? ???? ???? ?????",
"?????? ???? ???? ?????",
"?????? ??? ???? ?????",
"?????? ????? ???????",
"?????? ???????? ????? 4?",
"????? ???? ??????",
"???? ???? 1?",
"???? ??? ??????-????? 500 ??",
"????? ?????",
"???? ??? ????",
"???? ???? 8?",
"???? ???? 3?",
"???? ???",
"?????? ???? ???? ?????",
"???? ?????? ???? ???? ?????",
"???? ?????? ??? ???? ?????",
"???? ?????? ??? 800 / 500 ??",
"???? ?????? ??? 200 ?? / 300 ??",
"?????? 200 ??",
"??? ??????? 500 ??",
"???? ??????? ??????? 250 ??",
"??? ????",
"???? ?????",
"???? ???",
"???? ??????? ??????? 125 ??",
"??? ????? ??????? ??? ?????",
"????? ??? ?????",
"???? ??????",
"????? 1? ???????",
"???? ???? 4? ???????",
"?????? ??? ???? ????? 4?",
"?????? ???? ????? 4?",
"????? ??? ???? 500 ??",
"?????? ????",
"???? ???",
"?????",
"????",
"?????? ???? ???????",
"?????? ???? ???????",
"??? ?????",
"????? ???? ???",
"????? ???? ?????",
"?????? ???",
"?????? ????? ???????",
"??? ?????? ?????",
"?????? ????? ????",
"?????? ??? ????",
"?????? ???????",
"??? ?????? 10 ??",
"???? 4? ???????",
"???? 4?",
"???? ???? 4?",
"???? ????? ???? ???????"
            ];
            try{
                let added = 0;
                PACK_ITEMS.forEach(name => {
                    if(!costPack.some(x => String(x.name).trim() === String(name).trim())){
                        const id = 'pack-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
                        costPack.push({ id, code: id, name: name, unit: '????', cost: 0 });
                        added++;
                    }
                });
                if(added > 0) saveLists();
                console.log('Added packaging items:', added);
                // Don't show an alert on initial population to avoid annoying startup popups.
                // If the user wants confirmation, they can open Manage Lists or export the lists.
            } catch(e){ console.warn('addDefaultPackItems error', e); }
        })();

        // --- Excel Import (SheetJS) ---
        function loadSheetJs() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) return resolve(window.XLSX);
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
                s.onload = () => resolve(window.XLSX);
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        function detectKey(keys, candidates){
            const norm = k => String(k||'').trim().toLowerCase();
            for(const k of keys){
                const n = norm(k);
                for(const c of candidates){ if(n.indexOf(c) !== -1) return k; }
            }
            return null;
        }

        async function handleExcelFile(file) {
            try{
                await loadSheetJs();
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type:'array'});
                const first = wb.SheetNames[0];
                const sheet = wb.Sheets[first];
                const rows = XLSX.utils.sheet_to_json(sheet, {defval: ''});
                if(!rows || !rows.length) return alert('????? ?? ????? ??? ?????? ????? ?????????');

                // detect columns
                const sampleKeys = Object.keys(rows[0]);
                const codeKey = detectKey(sampleKeys, ['code','???']);
                const nameKey = detectKey(sampleKeys, ['name','item','??????','???']);
                const unitKey = detectKey(sampleKeys, ['unit','??????','????']);
                const costKey = detectKey(sampleKeys, ['????','cost']);
                const priceKey = detectKey(sampleKeys, ['???','price','???']);
                const sectionKey = detectKey(sampleKeys, ['???','?????','category','type']);

                let addedFinished = 0, addedRaw = 0, addedPack = 0;
                rows.forEach(r => {
                    const code = String(r[codeKey] || r['Code'] || r['code'] || '').trim() || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    const name = String(r[nameKey] || r['Item Name'] || r['item name'] || '').trim() || '';
                    const unit = String(r[unitKey] || '').trim() || '';
                    const cost = parseFloat(String(r[costKey] || r['??? ???????'] || r['Cost'] || '') || 0) || 0;
                    const price = parseFloat(String(r[priceKey] || r['??? ?????'] || r['Price'] || '') || 0) || 0;
                    const section = String(r[sectionKey] || r['??? ??????'] || r['?????'] || '').trim().toLowerCase();

                    const item = { id: code, code, name, unit, cost, price };
                    // heuristics to classify
                    if(section.includes('?????') || section.includes('???') || section.includes('product') || (name && (name.toLowerCase().indexOf('????')>-1 || name.toLowerCase().indexOf('???')>-1))) {
                        costFinished.push(item); addedFinished++;
                    } else if(section.includes('?????') || section.includes('???') || section.includes('????') || section.includes('raw')){
                        costRaw.push(item); addedRaw++;
                    } else if(section.includes('???') || section.includes('?????') || section.includes('pack') || section.includes('????')){
                        costPack.push(item); addedPack++;
                    } else {
                        // default: finished
                        costFinished.push(item); addedFinished++;
                    }
                });

                saveLists();
                alert(`?? ?????????: ???????? ?????? ${addedFinished} � ??????? ${addedRaw} � ??????? ${addedPack}`);
            } catch(e){ console.error('Excel import failed', e); alert('??? ??????? ?????: ' + (e && e.message)); }
        }

        // wire import controls
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'cost-import-xlsx-btn'){
                const inp = document.getElementById('cost-excel-input'); if(inp) inp.click();
            }
            if(e.target && e.target.id === 'cost-import-from-state-btn'){
                // import existing app products (state.products or DEFAULT_PRODUCTS)
                const src = (Array.isArray(state.products) && state.products.length) ? state.products : DEFAULT_PRODUCTS || [];
                let added = 0;
                src.forEach(p =>{
                    const id = p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    const existing = costFinished.find(x => String(x.id) === String(id));
                    if(!existing){ costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || '????', price: Number(p.price||p.sellPrice||0) }); added++; }
                });
                saveLists();
                alert('?? ??????? ' + added + ' ???? ?? ?????? ???????.');
            }
        });
        document.getElementById('cost-excel-input') && document.getElementById('cost-excel-input').addEventListener('change', function(e){
            const f = e.target.files && e.target.files[0]; if(f) handleExcelFile(f);
            // reset input
            e.target.value = '';
        });
    })();
    </script>
        <!-- Claude client helper: call Netlify proxy at /api/claude -->
        <script>
            (function(){
                if (window.ClaudeAPI) return; // guard
                window.ClaudeAPI = {
                    async chat(opts){
                        const payload = {
                            model: (opts && opts.model) || 'claude-3-5-sonnet-20241022',
                            max_tokens: (opts && opts.max_tokens) || 512,
                            system: opts && opts.system,
                            messages: (opts && opts.messages) || [],
                            stream: !!(opts && opts.stream)
                        };
                        const res = await fetch('/api/claude', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) {
                            const text = await res.text().catch(()=> '');
                            throw new Error('Claude proxy error: HTTP ' + res.status + (text ? ('\n' + text) : ''));
                        }
                        const ct = res.headers.get('content-type')||'';
                        if (ct.includes('application/json')) return res.json();
                        return res.text();
                    },
                    async simple(prompt, extra){
                        const messages = [{ role: 'user', content: prompt }];
                        const data = await this.chat({ ...(extra||{}), messages });
                        try {
                            const parts = Array.isArray(data && data.content) ? data.content : [];
                            const txt = parts.find(p => p && p.type === 'text');
                            return txt ? txt.text : JSON.stringify(data);
                        } catch(e){ return JSON.stringify(data||{}); }
                    }
                };

                // Minimal console test helper (optional)
                window.testClaude = async function(){
                    try {
                        console.time('claude');
                        const out = await window.ClaudeAPI.simple('?? ?????? ??!');
                        console.timeEnd('claude');
                        alert(out);
                    } catch(err){
                        console.error(err);
                        alert('??? ??????? ?? Claude: ' + (err && err.message));
                    }
                };
            })();

            // ================= Simplified Cost (Recipe) Feature =================
            (function(){
                const LS_SIMPLE_RECIPES = 'simple_cost_recipes';
                let simpleRecipes = [];
                let lastFocusedRecipeId = null;
                // timers to debounce input handling per recipe card to avoid rebuilding DOM on every keystroke
                const recipeInputTimers = new Map();

                function loadSimpleRecipes(){
                    try { const raw = localStorage.getItem(LS_SIMPLE_RECIPES); simpleRecipes = raw ? JSON.parse(raw) : []; if(!Array.isArray(simpleRecipes)) simpleRecipes = []; } catch(e){ simpleRecipes = []; }
                    // Also load drafts to restore them if user revisits
                    try { const draftRaw = localStorage.getItem('costDrafts'); if (draftRaw) state.costDrafts = JSON.parse(draftRaw); } catch(e){}
                    // Expose to global window for other functions
                    window.simpleRecipes = simpleRecipes;
                }
                function saveSimpleRecipes(){ try { localStorage.setItem(LS_SIMPLE_RECIPES, JSON.stringify(simpleRecipes)); window.simpleRecipes = simpleRecipes; } catch(e){} }
                function toNum(v){ return parseFloat(v||0) || 0; }
                function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
                function computeRecipe(r){
                    const ingredientsCost = (r.ingredients||[]).reduce((a,x)=> a + (toNum(x.qtyKg) * toNum(x.unitCost)), 0);
                    const packagingCost = (r.packaging||[]).reduce((a,x)=> a + toNum(x.cost), 0);
                    const operationsCost = (r.operations||[]).reduce((a,x)=> a + toNum(x.cost), 0);
                    const totalBatchCost = ingredientsCost + packagingCost + operationsCost;
                    const costPerKg = toNum(r.batchSizeKg) > 0 ? totalBatchCost / toNum(r.batchSizeKg) : 0;
                    return { ingredientsCost, packagingCost, operationsCost, totalBatchCost, costPerKg };
                }
                function ingredientRow(idx, ing){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="ing">\n<input class="ing-name flex-1 p-1 border rounded text-xs" placeholder="???" value="${esc(ing.name)}" />\n<input class="ing-qty w-20 p-1 border rounded text-xs text-center" placeholder="????" value="${esc(ing.qtyKg)}" />\n<input class="ing-cost w-20 p-1 border rounded text-xs text-center" placeholder="???/???" value="${esc(ing.unitCost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">�</button>\n</div>`;
                }
                function packagingRow(idx, pk){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="pack">\n<input class="pack-name flex-1 p-1 border rounded text-xs" placeholder="???" value="${esc(pk.name)}" />\n<input class="pack-cost w-24 p-1 border rounded text-xs text-center" placeholder="????" value="${esc(pk.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">�</button>\n</div>`;
                }
                function operationRow(idx, op){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="op">\n<input class="op-name flex-1 p-1 border rounded text-xs" placeholder="???" value="${esc(op.name)}" />\n<input class="op-cost w-24 p-1 border rounded text-xs text-center" placeholder="????" value="${esc(op.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">�</button>\n</div>`;
                }
                function computeAndCardHTML(r){
                    const c = computeRecipe(r);
                    // Try to restore draft values if they exist
                    if (!state.costDrafts) state.costDrafts = {};
                    const draft = state.costDrafts[r.id] || {};
                    const name = draft.name || r.name || '';
                    const batchSizeKg = draft.batchSizeKg || r.batchSizeKg || '';
                    const notes = draft.notes || r.notes || '';
                    const ingredients = (draft.ingredients && Array.isArray(draft.ingredients) && draft.ingredients.length > 0) ? draft.ingredients : r.ingredients;
                    const packaging = (draft.packaging && Array.isArray(draft.packaging) && draft.packaging.length > 0) ? draft.packaging : r.packaging;
                    const operations = (draft.operations && Array.isArray(draft.operations) && draft.operations.length > 0) ? draft.operations : r.operations;
                    return `<div class="flex items-center gap-2 mb-2">\n<input class="recipe-name w-full p-2 border rounded" placeholder="??? ??????" value="${esc(name)}" />\n<input class="recipe-batch w-28 p-2 border rounded" placeholder="???? ???" value="${esc(batchSizeKg)}" />\n<button class="delete-recipe bg-red-600 text-white px-2 py-1 rounded text-sm">???</button>\n<button class="save-produce-card bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-sm" data-recipe-id="${esc(r.id)}">??? ??????</button>\n</div>\n<div class="grid md:grid-cols-3 gap-4">\n<div>\n<h4 class="font-semibold text-sm mb-1">???????</h4>\n<div class="ingredients space-y-2">${ingredients.map((ing,i)=> ingredientRow(i, ing)).join('')}</div>\n<button class="add-ingredient bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ ????</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">???????</h4>\n<div class="packaging space-y-2">${packaging.map((pk,i)=> packagingRow(i, pk)).join('')}</div>\n<button class="add-packaging bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ ?????</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">???????</h4>\n<div class="operations space-y-2">${operations.map((op,i)=> operationRow(i, op)).join('')}</div>\n<button class="add-operation bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ ?????</button>\n</div>\n</div>\n<div class="text-sm bg-gray-50 border rounded p-3 grid grid-cols-2 md:grid-cols-5 gap-2">\n<div><span class="text-gray-600">?????:</span> <span class="font-bold">${c.ingredientsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">?????:</span> <span class="font-bold">${c.packagingCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">?????:</span> <span class="font-bold">${c.operationsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">?????? ??????:</span> <span class="font-bold">${c.totalBatchCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">??????? / ???:</span> <span class="font-bold">${c.costPerKg.toFixed(2)}</span></div>\n</div>\n<textarea class="recipe-notes w-full p-2 border rounded text-sm" placeholder="???????">${esc(notes)}</textarea>`;
                }
                function renderRecipes(){
                    const listEl = document.getElementById('recipes-list'); if(!listEl) return;
                    listEl.innerHTML = '';
                    if(simpleRecipes.length === 0){
                        listEl.innerHTML = '<div class="p-4 bg-white rounded shadow text-sm text-gray-600">?? ???? ?????? ???. ???? "???? ????".</div>';
                        return;
                    }
                    simpleRecipes.forEach(r => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow border p-4 space-y-3';
                        card.setAttribute('data-id', r.id);
                        card.innerHTML = computeAndCardHTML(r);
                        listEl.appendChild(card);

                // Attach autosave handlers to card inputs for persistent drafts
                        try {
                            const inputs = card.querySelectorAll('input, textarea');
                            inputs.forEach(input => {
                                // Real-time save on input (no debounce for smooth typing)
                                input.addEventListener('input', () => {
                                    saveCostCardDraft(card);
                                });
                                // Save on blur
                                input.addEventListener('blur', () => {
                                    saveCostCardDraft(card);
                                });
                                // Also save when Tab is pressed
                                input.addEventListener('keydown', (ev) => {
                                    if (ev.key === 'Tab') {
                                        saveCostCardDraft(card);
                                    }
                                    // On Enter in ingredient/packaging/operation name field, show autocomplete if appropriate
                                    if (ev.key === 'Enter') {
                                        ev.preventDefault();
                                        saveCostCardDraft(card);
                                        // Move to next focusable element
                                        const focusables = Array.from(card.querySelectorAll('input, textarea, button')).filter(el => !el.disabled && el.offsetParent !== null);
                                        const idx = focusables.indexOf(ev.target);
                                        if (idx >= 0 && idx < focusables.length - 1) {
                                            focusables[idx + 1].focus();
                                        }
                                    }
                                });
                            });

                            // Attach autocomplete handlers for ingredient/packaging names
                            const ingNameInputs = card.querySelectorAll('.ingredients .ing-name');
                            const packNameInputs = card.querySelectorAll('.packaging .pack-name');
                            const opNameInputs = card.querySelectorAll('.operations .op-name');

                            ingNameInputs.forEach(inp => {
                                inp.addEventListener('focus', (e) => {
                                    showCostAutocomplete(e.target, 'ingredient');
                                });
                                inp.addEventListener('input', (e) => {
                                    if (e.target.value.trim().length > 0) {
                                        showCostAutocomplete(e.target, 'ingredient');
                                    }
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });

                            packNameInputs.forEach(inp => {
                                inp.addEventListener('focus', (e) => {
                                    showCostAutocomplete(e.target, 'packaging');
                                });
                                inp.addEventListener('input', (e) => {
                                    if (e.target.value.trim().length > 0) {
                                        showCostAutocomplete(e.target, 'packaging');
                                    }
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });

                            opNameInputs.forEach(inp => {
                                inp.addEventListener('focus', (e) => {
                                    showCostAutocomplete(e.target, 'operation');
                                });
                                inp.addEventListener('input', (e) => {
                                    if (e.target.value.trim().length > 0) {
                                        showCostAutocomplete(e.target, 'operation');
                                    }
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });
                        } catch (err) {
                            console.warn('attach card handlers failed', err);
                        }
                    });
                }
                function addRecipe(){
                    const r = { id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name: '', batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' };
                    simpleRecipes.push(r); 
                    saveSimpleRecipes(); 
                    renderRecipes();
                    lastFocusedRecipeId = r.id;
                    
                    // Show the save and produce button
                    const saveBtn = document.getElementById('save-and-produce-btn');
                    if (saveBtn) saveBtn.style.display = 'inline-flex';
                    
                    // Auto-create a production run for this recipe
                    try {
                        const startDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                        window.createProductionRun(r.id, startDate, null, '?? ??????? ???????? ?? ???? ????????');
                    } catch(err) {
                        console.warn('Failed to auto-create production run:', err);
                    }
                }
                
                function saveAndProduceRecipe() {
                    if (!lastFocusedRecipeId) {
                        alert('?????? ?????? ???? ?????');
                        return;
                    }
                    
                    const recipe = (window.simpleRecipes || []).find(r => r.id === lastFocusedRecipeId);
                    if (!recipe || !recipe.name) {
                        alert('?????? ????? ??? ?????? ?????');
                        return;
                    }
                    
                    // Save the recipe
                    saveSimpleRecipes();
                    alert(`? ?? ??? ??????: ${recipe.name}`);
                    
                    // Create production run and navigate
                    try {
                        const startDate = new Date().toISOString().split('T')[0];
                        const success = window.createProductionRun(recipe.id, startDate, null, `?? ??????? ?? ???? ???????? - ${recipe.name}`);
                        if (success) {
                            // Navigate to production page
                            setTimeout(() => {
                                window.navigateTo('production');
                            }, 300);
                        } else {
                            alert('??? ??? ?? ????? ????????');
                        }
                    } catch(err) {
                        console.warn('Failed to create production run:', err);
                        alert('??? ??? ?? ????? ????????');
                    }
                }
                function importFromOld(){
                    try{ if(typeof loadLists === 'function'){ loadLists(); } }catch(e){}
                    const fins = Array.isArray(window.costFinished)? window.costFinished : [];
                    const raws = Array.isArray(window.costRaw)? window.costRaw : [];
                    const packs = Array.isArray(window.costPack)? window.costPack : [];
                    let created = 0, updated = 0;
                    const byId = (arr,id)=> arr.find(x=> String(x.id) === String(id));
                    const unitCostOfRaw = r => (r && (r.lastPrice!=null?r.lastPrice:r.cost)) || 0;
                    const unitCostOfPack = p => (p && (p.lastPrice!=null?p.lastPrice:p.cost)) || 0;
                    fins.forEach(p => {
                        const name = (p && (p.name||p.code||'')).toString(); if(!name) return;
                        let existing = simpleRecipes.find(r=> (r.name||'') === name);
                        if(!existing){ existing = { id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' }; simpleRecipes.push(existing); created++; }
                        // try read BOM by id, then code, then name
                        const keys = [ p.id, p.code, p.name ].filter(Boolean).map(v => 'bom_' + v);
                        let bomObj = null;
                        for(const k of keys){ try{ const raw = localStorage.getItem(k); if(raw){ bomObj = JSON.parse(raw); break; } }catch(e){} }
                        if(!bomObj || !Array.isArray(bomObj.items)){ updated += 0; return; }
                        const ings = []; const pkgs = [];
                        bomObj.items.forEach(it => {
                            const qty = parseFloat(it.qty||0) || 0;
                            if((it.type||'').toLowerCase() === 'raw'){
                                const r = byId(raws, it.id);
                                ings.push({ name: (r && r.name) || (it.name||'?????'), qtyKg: qty || '', unitCost: unitCostOfRaw(r) });
                            } else if((it.type||'').toLowerCase() === 'pack'){
                                const pk = byId(packs, it.id);
                                const uc = unitCostOfPack(pk);
                                pkgs.push({ name: (pk && pk.name) || (it.name||'?????'), cost: (qty * uc) || 0 });
                            }
                        });
                        // estimate batch size = sum raw qty where unit probably kg if data exists
                        const batch = ings.reduce((a,x)=> a + (parseFloat(x.qtyKg||0)||0), 0);
                        if(batch > 0 && !existing.batchSizeKg) existing.batchSizeKg = batch;
                        // merge by appending if empty
                        if(existing.ingredients.length === 0) existing.ingredients = ings;
                        if(existing.packaging.length === 0) existing.packaging = pkgs;
                        updated++;
                    });
                    saveSimpleRecipes(); renderRecipes();
                    alert(`?? ?????????: ????? ${created} ?????? ??? ????? ${updated}.`);
                }
                // ??????? ???? ???? ??????? (????????? ????? ???)
                function silentImportIfEmpty(){
                    try{ if(typeof loadLists === 'function'){ loadLists(); } }catch(e){}
                    if (simpleRecipes.length > 0) return; // ?? ???? ??? ?? ???? ????? ??????
                    const fins = Array.isArray(window.costFinished)? window.costFinished : [];
                    const raws = Array.isArray(window.costRaw)? window.costRaw : [];
                    const packs = Array.isArray(window.costPack)? window.costPack : [];
                    if (!fins.length && !raws.length && !packs.length) return; // ?? ???? ?????? ?????
                    let created = 0;
                    fins.forEach(p => {
                        const name = (p && (p.name||p.code||'')); if(!name) return;
                        if(!simpleRecipes.some(r => r.name === name)){
                            simpleRecipes.push({ id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg:'', ingredients:[], packaging:[], operations:[], notes:'' });
                            created++;
                        }
                    });
                    if (created){ saveSimpleRecipes(); renderRecipes(); }
                }
                // ????? ??? ????? ??? ??? ??? ??? ????? ????????
                window.autoImportLegacyRecipesOnce = (function(){
                    let done = false;
                    return function(){ if(done) return; try { silentImportIfEmpty(); } catch(_){} done = true; };
                })();
                // ??? ?????? ??????
                window.importOldCosts = importFromOld;
                window.importOldCostsSilent = silentImportIfEmpty;
                function syncCard(card){
                    const id = card.getAttribute('data-id'); const r = simpleRecipes.find(x=>x.id===id); if(!r) return;
                    r.name = card.querySelector('.recipe-name')?.value.trim() || '';
                    r.batchSizeKg = card.querySelector('.recipe-batch')?.value.trim() || '';
                    r.notes = card.querySelector('.recipe-notes')?.value || '';
                    r.ingredients = Array.from(card.querySelectorAll('.ingredients > div')).map(d => ({ name: d.querySelector('.ing-name')?.value.trim() || '', qtyKg: d.querySelector('.ing-qty')?.value.trim() || '', unitCost: d.querySelector('.ing-cost')?.value.trim() || '' }));
                    r.packaging = Array.from(card.querySelectorAll('.packaging > div')).map(d => ({ name: d.querySelector('.pack-name')?.value.trim() || '', cost: d.querySelector('.pack-cost')?.value.trim() || '' }));
                    r.operations = Array.from(card.querySelectorAll('.operations > div')).map(d => ({ name: d.querySelector('.op-name')?.value.trim() || '', cost: d.querySelector('.op-cost')?.value.trim() || '' }));
                    saveSimpleRecipes(); 
                    // DO NOT call renderRecipes() - preserve focus and DOM state
                }

                function saveCostCardDraft(card) {
                    try {
                        const id = card.getAttribute('data-id');
                        if (!id) return;
                        if (!state.costDrafts) state.costDrafts = {};
                        const draft = {
                            name: card.querySelector('.recipe-name')?.value.trim() || '',
                            batchSizeKg: card.querySelector('.recipe-batch')?.value.trim() || '',
                            notes: card.querySelector('.recipe-notes')?.value || '',
                            ingredients: Array.from(card.querySelectorAll('.ingredients > div')).map(d => ({
                                name: d.querySelector('.ing-name')?.value.trim() || '',
                                qtyKg: d.querySelector('.ing-qty')?.value.trim() || '',
                                unitCost: d.querySelector('.ing-cost')?.value.trim() || ''
                            })),
                            packaging: Array.from(card.querySelectorAll('.packaging > div')).map(d => ({
                                name: d.querySelector('.pack-name')?.value.trim() || '',
                                cost: d.querySelector('.pack-cost')?.value.trim() || ''
                            })),
                            operations: Array.from(card.querySelectorAll('.operations > div')).map(d => ({
                                name: d.querySelector('.op-name')?.value.trim() || '',
                                cost: d.querySelector('.op-cost')?.value.trim() || ''
                            }))
                        };
                        state.costDrafts[id] = draft;
                        try { localStorage.setItem('costDrafts', JSON.stringify(state.costDrafts)); } catch (e) {}
                    } catch (e) {
                        console.warn('saveCostCardDraft failed', e);
                    }
                }

                function showCostAutocomplete(input, type) {
                    try {
                        const searchTerm = input.value.trim().toLowerCase();
                        const container = input.parentElement;
                        let suggestionsList = container.querySelector('.cost-suggestions');

                        if (!suggestionsList) {
                            suggestionsList = document.createElement('div');
                            suggestionsList.className = 'cost-suggestions absolute bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-60 overflow-y-auto';
                            suggestionsList.style.display = 'none';
                            suggestionsList.style.direction = 'rtl';
                            suggestionsList.style.top = '100%';
                            suggestionsList.style.right = '0';
                            suggestionsList.style.minWidth = '250px';
                            suggestionsList.style.zIndex = '9999';
                            container.style.position = 'relative';
                            container.appendChild(suggestionsList);
                        }

                        // Build list from available sources: cost lists and app products
                        let predefinedNames = [];
                        try {
                            // From costRaw (raw materials) if present
                            if (type === 'ingredient' && Array.isArray(window.costRaw)) {
                                window.costRaw.forEach(it => {
                                    const n = (typeof it === 'string') ? it : (it && (it.name || it.code)) ? (it.name || it.code) : '';
                                    if (n) predefinedNames.push(String(n).trim());
                                });
                            }
                            // From costPack (packaging) if present
                            if (type === 'packaging' && Array.isArray(window.costPack)) {
                                window.costPack.forEach(it => {
                                    const n = (typeof it === 'string') ? it : (it && (it.name || it.code)) ? (it.name || it.code) : '';
                                    if (n) predefinedNames.push(String(n).trim());
                                });
                            }
                            // Also pull from global state.products filtering by category as fallback/augmentation
                            if (Array.isArray(state.products)) {
                                state.products.forEach(p => {
                                    const name = (p && (p.name || p.title || p.code)) ? String(p.name || p.title || p.code).trim() : '';
                                    const cat = (p && p.category) ? String(p.category).toLowerCase() : '';
                                    if (!name) return;
                                    if (type === 'ingredient') {
                                        if (cat.includes('???') || cat.includes('????') || cat.includes('??????')) predefinedNames.push(name);
                                    } else if (type === 'packaging') {
                                        if (cat.includes('?????') || cat.includes('?????') || cat.includes('????') || cat.includes('???') || cat.includes('???')) predefinedNames.push(name);
                                    } else {
                                        predefinedNames.push(name);
                                    }
                                });
                            }
                        } catch (e) {
                            // ignore and continue with whatever we collected
                        }

                        // Fallback to small built-in lists if nothing found
                        if (predefinedNames.length === 0) {
                            if (type === 'ingredient') {
                                predefinedNames = ['??? ?????','???','????','??? ????'];
                            } else if (type === 'packaging') {
                                predefinedNames = ['?????? ????','?????? 500 ??','???? ???? 3?'];
                            }
                        }

                        // De-duplicate and normalize
                        const seen = new Set();
                        const uniqueNames = [];
                        predefinedNames.forEach(n => {
                            const key = String(n || '').trim();
                            if (!key) return;
                            const lk = key.toLowerCase();
                            if (!seen.has(lk)) { seen.add(lk); uniqueNames.push(key); }
                        });

                        // Filter by search term or show full list on empty
                        let matches = [];
                        if (!searchTerm) {
                            // Show all available names (no limit for full access)
                            matches = uniqueNames;
                        } else {
                            // Filter by search term and show up to 200 results
                            matches = uniqueNames.filter(name => name.toLowerCase().includes(searchTerm)).slice(0, 200);
                        }

                        if (matches.length === 0) {
                            suggestionsList.innerHTML = '<div class="p-2 text-gray-500 text-sm">?? ???? ???????</div>';
                            suggestionsList.style.display = 'block';
                            return;
                        }

                        suggestionsList.innerHTML = matches.map(name => `
                            <div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-product-name="${name}">
                                ${name}
                            </div>
                        `).join('');
                        suggestionsList.style.display = 'block';

                        // Handle suggestion click
                        suggestionsList.removeEventListener('click', () => {});
                        suggestionsList.addEventListener('click', (e) => {
                            const item = e.target.closest('[data-product-name]');
                            if (item) {
                                input.value = item.getAttribute('data-product-name');
                                suggestionsList.style.display = 'none';
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                                saveCostCardDraft(input.closest('[data-id]'));
                            }
                        });
                    } catch (err) {
                        console.warn('showCostAutocomplete failed', err);
                    }
                }

                function hideCostAutocomplete(input) {
                    try {
                        const suggestionsList = input.parentElement?.querySelector('.cost-suggestions');
                        if (suggestionsList) suggestionsList.style.display = 'none';
                    } catch (e) {}
                }
                document.addEventListener('click', function(e){
                    if(e.target && e.target.id === 'add-recipe-btn'){ addRecipe(); }
                    if(e.target && e.target.id === 'save-and-produce-btn'){ try { saveAndProduceRecipe(); } catch(_){ /* ignore */ } }
                    if(e.target && e.target.classList.contains('save-produce-card')){ 
                        const recipeId = e.target.getAttribute('data-recipe-id');
                        if(recipeId && window.simpleRecipes && Array.isArray(window.simpleRecipes)) {
                            const recipe = window.simpleRecipes.find(r => r.id === recipeId);
                            if (recipe && recipe.name) {
                                saveSimpleRecipes();
                                const startDate = new Date().toISOString().split('T')[0];
                                const success = window.createProductionRun(recipeId, startDate, null, `?? ???? ???????? - ${recipe.name}`);
                                if (success) {
                                    alert(`? ?? ??? ?????? ?????? ??????: ${recipe.name}`);
                                    setTimeout(() => window.navigateTo('production'), 300);
                                } else {
                                    alert('??? ??? ?? ????? ????????');
                                }
                            } else {
                                alert('?????? ????? ??? ?????? ?????');
                            }
                        }
                    }
                    if(e.target && e.target.id === 'import-old-costs-btn'){ importFromOld(); }
                    if(e.target && e.target.id === 'restore-costs-from-products-btn'){ try { if (window.restoreFromPriceLists) window.restoreFromPriceLists(); if (window.renderRecipes) window.renderRecipes(); } catch(_){} }
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(card){
                        if(e.target.classList.contains('add-ingredient')){ 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                r.ingredients.push({ name:'', qtyKg:'', unitCost:'' }); 
                                saveSimpleRecipes(); 
                                // Add row to DOM instead of full re-render
                                const ingDiv = card.querySelector('.ingredients');
                                if(ingDiv) {
                                    const idx = r.ingredients.length - 1;
                                    const newRow = document.createElement('div');
                                    newRow.className = 'flex gap-2 items-center';
                                    newRow.setAttribute('data-row', idx);
                                    newRow.setAttribute('data-type', 'ing');
                                    newRow.innerHTML = `<input class="ing-name flex-1 p-1 border rounded text-xs" placeholder="???" value="" /><input class="ing-qty w-20 p-1 border rounded text-xs text-center" placeholder="????" value="" /><input class="ing-cost w-20 p-1 border rounded text-xs text-center" placeholder="???/???" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">�</button>`;
                                    ingDiv.appendChild(newRow);
                                    const newIng = newRow.querySelector('.ing-name');
                                    if(newIng){
                                        newIng.addEventListener('focus', function(){ showCostAutocomplete(this, 'ingredient'); });
                                        newIng.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'ingredient'); });
                                        newIng.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
                                        newIng.focus();
                                    }
                                }
                            } 
                        }
                        if(e.target.classList.contains('add-packaging')){ 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                r.packaging.push({ name:'', cost:'' }); 
                                saveSimpleRecipes(); 
                                // Add row to DOM instead of full re-render
                                const packDiv = card.querySelector('.packaging');
                                if(packDiv) {
                                    const idx = r.packaging.length - 1;
                                    const newRow = document.createElement('div');
                                    newRow.className = 'flex gap-2 items-center';
                                    newRow.setAttribute('data-row', idx);
                                    newRow.setAttribute('data-type', 'pack');
                                    newRow.innerHTML = `<input class="pack-name flex-1 p-1 border rounded text-xs" placeholder="???" value="" /><input class="pack-cost w-24 p-1 border rounded text-xs text-center" placeholder="????" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">�</button>`;
                                    packDiv.appendChild(newRow);
                                    const newPack = newRow.querySelector('.pack-name');
                                    if(newPack){
                                        newPack.addEventListener('focus', function(){ showCostAutocomplete(this, 'packaging'); });
                                        newPack.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'packaging'); });
                                        newPack.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
                                        newPack.focus();
                                    }
                                }
                            } 
                        }
                        if(e.target.classList.contains('add-operation')){ 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                r.operations.push({ name:'', cost:'' }); 
                                saveSimpleRecipes(); 
                                // Add row to DOM instead of full re-render
                                const opsDiv = card.querySelector('.operations');
                                if(opsDiv) {
                                    const idx = r.operations.length - 1;
                                    const newRow = document.createElement('div');
                                    newRow.className = 'flex gap-2 items-center';
                                    newRow.setAttribute('data-row', idx);
                                    newRow.setAttribute('data-type', 'op');
                                    newRow.innerHTML = `<input class="op-name flex-1 p-1 border rounded text-xs" placeholder="???" value="" /><input class="op-cost w-24 p-1 border rounded text-xs text-center" placeholder="????" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">�</button>`;
                                    opsDiv.appendChild(newRow);
                                    const newOp = newRow.querySelector('.op-name');
                                    if(newOp){
                                        newOp.addEventListener('focus', function(){ showCostAutocomplete(this, 'operation'); });
                                        newOp.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'operation'); });
                                        newOp.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
                                        newOp.focus();
                                    }
                                }
                            } 
                        }
                        if(e.target.classList.contains('delete-recipe')){ 
                            if(confirm('??? ???????')){ 
                                const id = card.getAttribute('data-id'); 
                                simpleRecipes = simpleRecipes.filter(x=>x.id!==id); 
                                saveSimpleRecipes(); 
                                card.remove(); // Just remove from DOM
                            } 
                        }
                        if(e.target.classList.contains('row-del')){ 
                            const row = e.target.closest('div[data-row]'); 
                            const type = row.getAttribute('data-type'); 
                            const idx = parseInt(row.getAttribute('data-row')); 
                            const id = card.getAttribute('data-id'); 
                            const r = simpleRecipes.find(x=>x.id===id); 
                            if(r){ 
                                if(type==='ing'){ r.ingredients.splice(idx,1); } 
                                else if(type==='pack'){ r.packaging.splice(idx,1); } 
                                else if(type==='op'){ r.operations.splice(idx,1); } 
                                saveSimpleRecipes(); 
                                row.remove(); // Just remove from DOM
                            } 
                        }
                    }
                });
                document.addEventListener('input', function(e){
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(!card) return;
                    const interesting = e.target.classList && (
                        e.target.classList.contains('recipe-name') ||
                        e.target.classList.contains('recipe-batch') ||
                        e.target.classList.contains('recipe-notes') ||
                        e.target.classList.contains('ing-name') ||
                        e.target.classList.contains('ing-qty') ||
                        e.target.classList.contains('ing-cost') ||
                        e.target.classList.contains('pack-name') ||
                        e.target.classList.contains('pack-cost') ||
                        e.target.classList.contains('op-name') ||
                        e.target.classList.contains('op-cost')
                    );
                    if(!interesting) return;

                    // Debounce removed - drafts now save in real-time via 'input' event listener above
                    // This prevents lag during typing
                });
                document.addEventListener('focusin', function(e){
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(card) lastFocusedRecipeId = card.getAttribute('data-id');
                });
                
                // Prevent unnecessary full re-renders on click - only render when needed
                let renderScheduled = false;
                function scheduleRender() {
                    if (renderScheduled) return;
                    renderScheduled = true;
                    setTimeout(() => {
                        renderRecipes();
                        // renderQuickLists removed - feature deleted
                        renderScheduled = false;
                    }, 100);
                }
                
                document.addEventListener('click', function(e){
                    // Only render if navigating TO costs page for the first time
                    if(e.target && e.target.getAttribute && e.target.getAttribute('data-page')==='costs'){ 
                        scheduleRender();
                    }
                    if(e.target && e.target.classList.contains('quick-add-item')){
                        const name = e.target.getAttribute('data-name')||''; const type = e.target.getAttribute('data-add-type');
                        if(!name) return;
                        // pick target recipe
                        let target = simpleRecipes.find(r=>r.id===lastFocusedRecipeId);
                        if(!target){ target = simpleRecipes.length === 1 ? simpleRecipes[0] : null; }
                        if(!target){ addRecipe(); target = simpleRecipes[simpleRecipes.length-1]; lastFocusedRecipeId = target.id; }
                        if(type === 'ing'){ target.ingredients.push({ name, qtyKg:'', unitCost:'' }); }
                        else if(type === 'pack'){ target.packaging.push({ name, cost:'' }); }
                        saveSimpleRecipes(); 
                        scheduleRender();
                    }
                });
                // expose for legacy navigation handler
                window.renderRecipes = renderRecipes;
                loadSimpleRecipes(); // initial

        })();
        
        // ===== PRODUCTION RUNS FUNCTIONS (GLOBAL SCOPE) =====
        function generateProductionId() {
            const today = new Date();
            const dateStr = today.getFullYear().toString() + String(today.getMonth() + 1).padStart(2, '0') + String(today.getDate()).padStart(2, '0');
            const count = (window.state.productions || []).filter(p => p.id && p.id.startsWith('PROD-' + dateStr)).length + 1;
            return 'PROD-' + dateStr + '-' + String(count).padStart(3, '0');
        }

        function calculateProductionCost(recipe) {
            if (!recipe) return 0;
            let total = 0;
            (recipe.ingredients || []).forEach(ing => { total += parseFloat(ing.cost) || 0; });
            (recipe.packaging || []).forEach(pkg => { total += parseFloat(pkg.cost) || 0; });
            (recipe.operations || []).forEach(op => { total += parseFloat(op.cost) || 0; });
            return total;
        }

        window.renderProductionRuns = function() {
            // This function is now an alias for renderProductionsList
            if (window.renderProductionsList) {
                window.renderProductionsList();
            }
        };
                
        window.openCreateProductionModal = function() {
            const recipeSelect = document.getElementById('production-recipe-select');
            const dateInput = document.getElementById('production-start-date');
            
            if (recipeSelect) {
                recipeSelect.innerHTML = '<option value="">-- ???? ???? --</option>';
                const recipes = window.simpleRecipes || [];
                console.log('Available recipes:', recipes);
                if (recipes.length === 0) {
                    recipeSelect.innerHTML += '<option disabled>?? ???? ????? ?????</option>';
                } else {
                    recipes.forEach(recipe => {
                        const option = document.createElement('option');
                        option.value = recipe.id;
                        option.textContent = recipe.name || '???? ???';
                        recipeSelect.appendChild(option);
                    });
                }
            }
            
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
            
            const modal = document.getElementById('modal-create-production');
            if (modal) {
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            }
            console.log('Opened create production modal');
        };

        // ===== ATTACH EVENT LISTENERS TO PRODUCTION EDIT BUTTONS =====
        function attachProductionButtonListeners() {
            const activeTable = document.getElementById('active-productions-table-body');
            const completedTable = document.getElementById('completed-productions-table-body');

            // Handle clicks on active productions table
            if (activeTable) {
                activeTable.addEventListener('click', function(e) {
                    const btn = e.target.closest('.btn-edit-production');
                    if (btn) {
                        const productionId = btn.dataset.id;
                        console.log('?? ????? ????????:', productionId);
                        window.openEditProductionModal(productionId);
                    }
                });
            }

            // Handle clicks on completed productions table
            if (completedTable) {
                completedTable.addEventListener('click', function(e) {
                    const btn = e.target.closest('.btn-edit-production');
                    if (btn) {
                        const productionId = btn.dataset.id;
                        console.log('?? ??? ???????? ????????:', productionId);
                        window.openEditProductionModal(productionId);
                    }
                });
            }
        }

        window.renderProductionsList = function() {
            try {
                const activeBody = document.getElementById('active-productions-table-body');
                const completedBody = document.getElementById('completed-productions-table-body');
                if (!activeBody || !completedBody) return;

                const productions = window.state.productions || [];
                activeBody.innerHTML = '';
                completedBody.innerHTML = '';

                        const activeProds = productions.filter(p => p.status === 'in-progress');
                        const completedProds = productions.filter(p => p.status !== 'in-progress');

                        // Render active productions
                        activeProds.forEach(prod => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="px-3 py-3 text-right font-semibold text-blue-600">${escapeHtml(prod.id)}</td>
                                <td class="px-3 py-3 text-right">${escapeHtml(prod.productName || prod.recipeName)}</td>
                                <td class="px-3 py-3 text-right">${escapeHtml(prod.recipeName)}</td>
                                <td class="px-3 py-3 text-center text-sm">${prod.startDate || '-'}</td>
                                <td class="px-3 py-3 text-center">${prod.expectedQty || '-'}</td>
                                <td class="px-3 py-3 text-center"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">??? ???????</span></td>
                                <td class="px-3 py-3 text-center">
                                    <button class="btn-edit-production bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" data-id="${escapeHtml(prod.id)}">?????</button>
                                </td>
                            `;
                            activeBody.appendChild(tr);
                        });

                        // Render completed productions
                        completedProds.forEach(prod => {
                            const tr = document.createElement('tr');
                            const profit = (prod.totalRevenue || 0) - (prod.totalCost || 0);
                            const profitClass = profit >= 0 ? 'text-green-600' : 'text-red-600';
                            tr.innerHTML = `
                                <td class="px-3 py-3 text-right font-semibold text-gray-600">${escapeHtml(prod.id)}</td>
                                <td class="px-3 py-3 text-right">${escapeHtml(prod.productName || prod.recipeName)}</td>
                                <td class="px-3 py-3 text-center">${prod.actualQty || prod.finalQty || '-'}</td>
                                <td class="px-3 py-3 text-right">${(prod.totalCost || 0).toFixed(2)}</td>
                                <td class="px-3 py-3 text-right">${(prod.totalRevenue || 0).toFixed(2)}</td>
                                <td class="px-3 py-3 text-right ${profitClass}"><strong>${profit.toFixed(2)}</strong></td>
                                <td class="px-3 py-3 text-center text-sm">${prod.completedDate || '-'}</td>
                                <td class="px-3 py-3 text-center">
                                    <button class="btn-edit-production bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600" data-id="${escapeHtml(prod.id)}">???</button>
                                </td>
                            `;
                            completedBody.appendChild(tr);
                        });

                        document.getElementById('no-active-productions').style.display = activeProds.length ? 'none' : 'block';
                        document.getElementById('no-completed-productions').style.display = completedProds.length ? 'none' : 'block';

                        // ===== Attach event listeners to edit buttons (Event Delegation) =====
                        attachProductionButtonListeners();
            } catch(err) {
                console.warn('renderProductionsList error:', err);
            }
        };

        // ===== LOAD PRODUCTIONS FROM FIREBASE =====
        window.loadProductionsFromFirebase = async function() {
            if (!window.db || !window.auth?.currentUser) {
                console.warn('Firebase not ready, using local productions only');
                return;
            }

            try {
                const uid = window.auth.currentUser.uid;
                // Preferred source: user's appState.productions (allowed by rules)
                try {
                    const udoc = await db.collection('users').doc(uid).get();
                    if (udoc.exists) {
                        const appState = udoc.data() && udoc.data().appState ? udoc.data().appState : null;
                        if (appState && Array.isArray(appState.productions) && appState.productions.length > 0) {
                            window.state.productions = appState.productions;
                            console.log('? Loaded', appState.productions.length, 'productions from users/' + uid + '.appState');
                            saveState();
                            return;
                        }
                    }
                } catch(err) {
                    console.warn('Failed to read users/{uid}.appState for productions:', err);
                }
            } catch(e){ console.warn('loadProductionsFromFirebase failed early', e); }

            // Fallback: try global productions collection
            try {
                const globalProdsSnap = await db.collection('productions').get();
                if (globalProdsSnap.size > 0) {
                    const productions = [];
                    globalProdsSnap.forEach(doc => {
                        productions.push(doc.data());
                    });
                    if (!Array.isArray(window.state.productions)) window.state.productions = [];
                    window.state.productions = productions;
                    console.log('? Loaded', productions.length, 'productions from Firebase (global collection)');
                    saveState();
                    return;
                }
            } catch(err) {
                console.error('Failed to load productions from Firebase (global):', err);
            }
        };

        // Render on page load
        try { window.renderProductionsList(); } catch(e) { console.warn('Initial renderProductionsList failed:', e); }
        
        // Try to load from Firebase in background � defer until auth is ready
        (function(){
            try {
                if (window.db && window.auth && window.auth.currentUser) {
                    window.loadProductionsFromFirebase();
                    return;
                }
                if (window.auth && typeof window.auth.onAuthStateChanged === 'function') {
                    const unsub = window.auth.onAuthStateChanged(function(u){
                        if (u) {
                            try { window.loadProductionsFromFirebase(); } catch(e){ console.warn('Firebase load failed on auth event:', e); }
                            try { if (typeof unsub === 'function') unsub(); } catch(_){ }
                        }
                    });
                    return;
                }
                // Last resort: try again after short delay
                setTimeout(()=>{ try { window.loadProductionsFromFirebase(); } catch(e){ console.warn('Firebase load failed (delayed):', e); } }, 1500);
            } catch(e){ console.warn('Firebase load scheduling failed:', e); }
        })();

        // ===== PRODUCTION RUN CREATION FUNCTION (GLOBAL) =====
        window.createProductionRun = function(recipeId, startDate, expectedQty, notes) {
            try {
                if (!recipeId) {
                    console.error('No recipeId provided');
                    return false;
                }

                // Find recipe
                const recipe = (window.simpleRecipes || []).find(r => r.id === recipeId);
                if (!recipe) {
                    console.error('Recipe not found:', recipeId);
                    return false;
                }

                // Generate auto ID: PROD-YYYYMMDD-###
                const today = new Date();
                const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                const existingToday = (window.state.productions || []).filter(p => p.id && p.id.includes(dateStr));
                const runNumber = String(existingToday.length + 1).padStart(3, '0');
                const productionId = `PROD-${dateStr}-${runNumber}`;

                // Calculate total cost from recipe
                let totalCost = 0;
                (recipe.ingredients || []).forEach(ing => {
                    totalCost += parseFloat(ing.cost || 0);
                });
                (recipe.packaging || []).forEach(pkg => {
                    totalCost += parseFloat(pkg.cost || 0);
                });
                (recipe.operations || []).forEach(op => {
                    totalCost += parseFloat(op.cost || 0);
                });

                // Create production object
                const production = {
                    id: productionId,
                    recipeId: recipeId,
                    recipeName: recipe.name,
                    productName: recipe.name,
                    startDate: startDate,
                    createdAt: new Date().toISOString(),
                    expectedQty: parseFloat(expectedQty) || null,
                    actualQty: null,
                    status: 'in-progress',
                    totalCost: totalCost,
                    sellPrice: 0,
                    totalRevenue: 0,
                    profit: 0,
                    notes: notes,
                    completedDate: null
                };

                // Add to state and save locally FIRST
                if (!Array.isArray(window.state.productions)) window.state.productions = [];
                window.state.productions.push(production);
                
                try {
                    saveState(); // Save to localStorage synchronously
                } catch(err) {
                    console.error('Failed to save state locally:', err);
                }

                console.log('? Production created locally:', productionId);

                // Try to sync to Firebase using helper function
                window.saveProductionToFirebase(production);
                
                return true;
            } catch(err) {
                console.error('Error in createProductionRun:', err);
                return false;
            }
        };

        // ===== HELPER FUNCTION TO SAVE PRODUCTION TO FIREBASE DIRECTLY =====
        window.saveProductionToFirebase = async function(production) {
            if (!production || !production.id) {
                console.warn('Invalid production object');
                return;
            }

            if (!window.db || !window.auth || !auth.currentUser) {
                console.warn('Firebase not initialized or no auth, production will only be saved locally');
                return;
            }

            try {
                const uid = auth.currentUser.uid;
                const userRef = db.collection('users').doc(uid);

                // Read existing appState (if any)
                let existing = null;
                try {
                    const snap = await userRef.get();
                    if (snap.exists) existing = snap.data() && snap.data().appState ? snap.data().appState : null;
                } catch(_){ /* ignore read errors */ }

                const prods = Array.isArray(existing?.productions) ? existing.productions.slice() : (Array.isArray(window.state.productions) ? window.state.productions.slice() : []);
                // Ensure no duplicate
                const idx = prods.findIndex(p => p && p.id === production.id);
                if (idx === -1) prods.push(production); else prods[idx] = production;

                // Write back to users/{uid}.appState.productions
                try {
                    await userRef.set({ appState: { productions: prods }, lastUpdatedBy: uid, updatedAt: serverTs() }, { merge: true });
                    console.log('? Production saved to Firebase (users/' + uid + '.appState.productions):', production.id);
                    return;
                } catch(e){
                    console.warn('Failed to save production into users/{uid}.appState, will try global collection:', e);
                }

                // Last resort: try saving to global productions collection
                try {
                    await db.collection('productions').doc(production.id).set(production);
                    console.log('? Production saved to Firebase (global collection):', production.id);
                    return;
                } catch(e2){
                    console.error('Failed to save production to Firebase (global):', e2);
                }
            } catch(err) {
                console.error('Error in saveProductionToFirebase:', err);
            }
        };

        // ===== EDIT PRODUCTION MODAL FUNCTION (GLOBAL) =====
        window.openEditProductionModal = function(productionId) {
            const production = (window.state.productions || []).find(p => p.id === productionId);
            if (!production) {
                alert('???????? ??? ??????');
                return;
            }

            // Populate form fields
            document.getElementById('edit-production-id').value = productionId;
            document.getElementById('edit-production-final-qty').value = production.actualQty || production.finalQty || '';
            document.getElementById('edit-production-status').value = production.status || 'in-progress';
            document.getElementById('edit-production-sell-price').value = production.sellPrice || '';
            document.getElementById('edit-production-notes').value = production.notes || '';

            // Update summary
            const totalCost = production.totalCost || 0;
            const finalQty = parseFloat(production.actualQty || production.finalQty || 1);
            const sellPrice = parseFloat(production.sellPrice || 0);
            const totalRevenue = finalQty * sellPrice;
            const profit = totalRevenue - totalCost;

            document.getElementById('summary-total-cost').textContent = totalCost.toFixed(2);
            document.getElementById('summary-total-revenue').textContent = totalRevenue.toFixed(2);
            document.getElementById('summary-profit-loss').textContent = profit.toFixed(2);
            document.getElementById('summary-profit-loss').style.color = profit >= 0 ? 'green' : 'red';

            // Show modal
            const modal = document.getElementById('modal-edit-production');
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        };

        // ===== HANDLE CREATE PRODUCTION FORM SUBMIT =====
        const createProductionForm = document.getElementById('form-create-production');
        if (createProductionForm) {
            createProductionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const recipeId = document.getElementById('production-recipe-select').value;
                    const startDate = document.getElementById('production-start-date').value;
                    const expectedQty = document.getElementById('production-expected-qty').value || null;
                    const notes = document.getElementById('production-notes').value || '';
                    
                    if (!recipeId) {
                        alert('?????? ?????? ????');
                        return;
                    }
                    
                    if (!startDate) {
                        alert('?????? ????? ????? ?????');
                        return;
                    }
                    
                    // Call the production creation function
                    const success = window.createProductionRun(recipeId, startDate, expectedQty, notes);
                    
                    if (success) {
                        alert('? ?? ????? ???????? ?????');
                        
                        // Close modal and refresh list
                        document.getElementById('modal-create-production').classList.remove('modal-visible');
                        document.getElementById('modal-create-production').classList.add('modal-hidden');
                        
                        // Reset form
                        createProductionForm.reset();
                        
                        // Refresh productions list
                        window.renderProductionsList();
                    } else {
                        alert('? ??? ??? ?? ????? ????????');
                    }
                } catch(err) {
                    console.error('Error in form submit:', err);
                    alert('? ???: ' + (err.message || '??? ????? ????????'));
                }
            });
        }

        // ===== HANDLE PRODUCTION UPDATE BUTTON CLICK (NOT FORM SUBMIT) =====
        // ???? ?? ????? ????? ??? ????? ??? DOM ???????
        function attachProductionSaveListener() {
            const saveBtn = document.getElementById('btn-save-production-update');
            if (!saveBtn) {
                console.warn('?? ?? ????? ?? ??? ?????? ????? ???? ???????? ??????');
                // ???? ?????? ??? ????
                setTimeout(attachProductionSaveListener, 500);
                return;
            }

            console.log('? ?? ?????? ??? ?? ?????? ???? ??? ???????');

            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('?? Save button clicked');
                
                const productionId = document.getElementById('edit-production-id').value;
                const finalQty = parseFloat(document.getElementById('edit-production-final-qty').value) || 0;
                const status = document.getElementById('edit-production-status').value;
                const sellPrice = parseFloat(document.getElementById('edit-production-sell-price').value) || 0;
                const notes = document.getElementById('edit-production-notes').value;

                console.log('?? ???????? ???????:', { productionId, finalQty, status, sellPrice, notes });

                if (!productionId) {
                    console.error('? ????? ???????? ????');
                    alert('???: ????? ???????? ????');
                    return;
                }

                const production = (window.state.productions || []).find(p => p.id === productionId);
                if (!production) {
                    console.error('? ???????? ??? ??????:', productionId);
                    alert('???????? ??? ??????');
                    return;
                }

                console.log('?? ????? ?????? ????????...');

                // Update production object
                production.actualQty = finalQty;
                production.finalQty = finalQty;
                production.status = status;
                production.sellPrice = sellPrice;
                production.notes = notes;
                production.totalRevenue = finalQty * sellPrice;
                production.profit = production.totalRevenue - production.totalCost;

                if (status === 'completed' && !production.completedDate) {
                    production.completedDate = new Date().toISOString().split('T')[0];
                }

                console.log('?? ???? ???????? ??????:', production);

                // Save to state synchronously FIRST
                try {
                    saveState();
                    console.log('?? ? ?? ????? ?????? ?? localStorage');
                } catch(err) {
                    console.error('?? ? ??? ????? ??????:', err);
                }

                // Save to Firebase using helper function
                if (window.saveProductionToFirebase) {
                    try {
                        window.saveProductionToFirebase(production);
                        console.log('?? ? ?? ????? ??? Firebase');
                    } catch(err) {
                        console.error('?? ? ??? ????? ??? Firebase:', err);
                    }
                } else {
                    console.warn('?? ???? saveProductionToFirebase ??? ??????');
                }

                alert('? ?? ??? ????????? ?????');
                
                // Close modal
                console.log('?? ????? ???????...');
                const modal = document.getElementById('modal-edit-production');
                if (modal) {
                    modal.classList.remove('modal-visible');
                    modal.classList.add('modal-hidden');
                }
                
                // Refresh list
                if (window.renderProductionsList) {
                    console.log('?? ????? ????? ???????...');
                    window.renderProductionsList();
                } else {
                    console.warn('?? ???? renderProductionsList ??? ??????');
                }

                console.log('? ?? ????? ????? ????? ?????');
            });
        }

        // ????? ?????? ??? ????? ?????? ???????
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachProductionSaveListener);
        } else {
            // ??? DOM ???? ??????
            attachProductionSaveListener();
        }
        
        </script>
    <!-- Add Finished Product Modal -->
    <div id="modal-add-finished-product" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">????? ???? ?????</h3>
            <form id="form-add-finished-product" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">??? ??????</label>
                    <input type="text" id="finished-product-code" class="w-full p-2 border rounded-md" placeholder="????: P-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??? ??????</label>
                    <input type="text" id="finished-product-name" class="w-full p-2 border rounded-md" placeholder="????: ??? ?????" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??????</label>
                    <input type="text" id="finished-product-unit" class="w-full p-2 border rounded-md" placeholder="????: ????" value="????">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">????? (???????)</label>
                    <input type="number" id="finished-product-price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">???</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-finished-product').classList.add('hidden')">?????</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Raw Material Modal (force-replaced to include invoice/tax fields) -->
    <div id="modal-add-raw-material" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">????? ????</h3>
            <form id="form-add-raw-material" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium mb-1">??? ??????</label>
                    <input type="text" id="raw-material-code" name="raw_material_code" class="w-full p-2 border rounded-md" placeholder="????: R-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??? ??????</label>
                    <input type="text" id="raw-material-name" name="raw_material_name" class="w-full p-2 border rounded-md" placeholder="????: ???" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??????</label>
                    <input type="text" id="raw-material-unit" name="raw_material_unit" class="w-full p-2 border rounded-md" placeholder="????: ???" value="???">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??? ?????? (??? ?????? ??????)</label>
                    <input type="number" id="raw-material-unit_price" name="raw_material_unit_price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??????</label>
                    <input type="number" id="raw-material-qty" name="raw_material_qty" class="w-full p-2 border rounded-md" placeholder="1" step="any" value="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">?????? ???????</label>
                    <input type="text" id="raw-material-total_cost" name="raw_material_total_cost" class="w-full p-2 border rounded-md bg-gray-50" readonly value="0">
                </div>
                <div>
                    <label class="inline-flex items-center gap-2">
                        <input type="checkbox" id="raw-material-is_tax_invoice" name="raw_material_is_tax_invoice" class="h-4 w-4">
                        <span class="text-sm">?????? ??????? (Tax Invoice?)</span>
                    </label>
                </div>
                <div class="pt-2 border-t">
                    <h4 class="text-sm font-medium">?????? ?????? ?????????</h4>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">??? ????? ?????? (Vendor Tax ID)</label>
                        <input type="text" id="raw-material-vendor_tax_id" name="raw_material_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="????: 123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">??? ????????</label>
                        <input type="text" id="raw-material-invoice_number" name="raw_material_invoice_number" class="w-full p-2 border rounded-md" placeholder="????: INV-001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">????? ????????</label>
                        <input type="date" id="raw-material-invoice_date" name="raw_material_invoice_date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">???? ??????? (VAT/Tax Value)</label>
                        <input type="number" id="raw-material-vat_value" name="raw_material_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">???? ???????? (Invoice Image)</label>
                        <input type="file" id="raw-material-invoice_image" name="raw_material_invoice_image" accept="image/*,application/pdf" class="w-full">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">???</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-raw-material').classList.add('hidden')">?????</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Packaging Modal (force-replaced to include invoice/tax fields) -->
    <div id="modal-add-packaging" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">????? ???? ?????</h3>
            <form id="form-add-packaging" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium mb-1">??? ??????</label>
                    <input type="text" id="packaging-code" name="packaging_code" class="w-full p-2 border rounded-md" placeholder="????: PKG-001" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??? ??????</label>
                    <input type="text" id="packaging-name" name="packaging_name" class="w-full p-2 border rounded-md" placeholder="????: ???? ?????????" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??????</label>
                    <input type="text" id="packaging-unit" name="packaging_unit" class="w-full p-2 border rounded-md" placeholder="????: ????" value="????">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">??????? (???????)</label>
                    <input type="number" id="packaging-cost" name="packaging_cost" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
                </div>
                <div class="pt-2 border-t">
                    <h4 class="text-sm font-medium">?????? ?????? ?????????</h4>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">??? ????? ?????? (Vendor Tax ID)</label>
                        <input type="text" id="packaging-vendor_tax_id" name="packaging_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="????: 123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">??? ????????</label>
                        <input type="text" id="packaging-invoice_number" name="packaging_invoice_number" class="w-full p-2 border rounded-md" placeholder="????: INV-001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">????? ????????</label>
                        <input type="date" id="packaging-invoice_date" name="packaging_invoice_date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">???? ??????? (VAT/Tax Value)</label>
                        <input type="number" id="packaging-vat_value" name="packaging_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">???? ???????? (Invoice Image)</label>
                        <input type="file" id="packaging-invoice_image" name="packaging_invoice_image" accept="image/*,application/pdf" class="w-full">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">???</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-packaging').classList.add('hidden')">?????</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Wire raw material modal total calculation
        (function(){
            function updateRawMaterialTotal(){
                try{
                    const unitEl = document.getElementById('raw-material-unit_price');
                    const qtyEl = document.getElementById('raw-material-qty');
                    const totalEl = document.getElementById('raw-material-total_cost');
                    const unit = parseFloat(unitEl?.value) || 0;
                    const qty = parseFloat(qtyEl?.value) || 0;
                    const total = Math.round((unit * qty) * 100) / 100;
                    if (totalEl) totalEl.value = total.toFixed(2);
                    return total;
                }catch(e){ console.warn('updateRawMaterialTotal failed', e); return 0; }
            }
            document.addEventListener('DOMContentLoaded', function(){
                try{
                    const unitEl = document.getElementById('raw-material-unit_price');
                    const qtyEl = document.getElementById('raw-material-qty');
                    if (unitEl) unitEl.addEventListener('input', updateRawMaterialTotal);
                    if (qtyEl) qtyEl.addEventListener('input', updateRawMaterialTotal);
                    // initial compute
                    updateRawMaterialTotal();
                }catch(e){}
            });
            window.updateRawMaterialTotal = updateRawMaterialTotal;
        })();
    </script>

    <!-- Modal: Create New Production Run -->
    <div id="modal-create-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
            <h3 class="text-lg font-bold mb-4">????? ?????? ?????</h3>
            <form id="form-create-production" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">???? ??????</label>
                    <select id="production-recipe-select" class="w-full p-2 border rounded-md" required>
                        <option value="">-- ???? ???? --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">???? ?????? ?????? ???????? ?? ??????</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">????? ?????</label>
                        <input type="date" id="production-start-date" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">?????? ???????? (???????)</label>
                        <input type="number" id="production-expected-qty" class="w-full p-2 border rounded-md" placeholder="???? ?????? ??????" step="0.01">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">???????</label>
                    <textarea id="production-notes" class="w-full p-2 border rounded-md" rows="3" placeholder="????: ??????? ?? ???????..."></textarea>
                </div>

                <div class="bg-blue-50 border border-blue-200 p-3 rounded-md text-sm text-blue-800">
                    <strong>??????:</strong> ????? ????? ?????? ???????? ??????? ??? ???????? ?? ??????? (24 ???? ???????).
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">????? ????????</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-create-production').classList.remove('modal-visible'); document.getElementById('modal-create-production').classList.add('modal-hidden');">?????</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Production Run -->
    <div id="modal-edit-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
            <h3 class="text-lg font-bold mb-4">????? ????????</h3>
            <form id="form-edit-production" class="space-y-4">
                <input type="hidden" id="edit-production-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">?????? ????????</label>
                        <input type="number" id="edit-production-final-qty" class="w-full p-2 border rounded-md" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">???? ????????</label>
                        <select id="edit-production-status" class="w-full p-2 border rounded-md" required>
                            <option value="in-progress">??? ???????</option>
                            <option value="completed">??????</option>
                            <option value="cancelled">?????</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">??? ????? ?????? (???????)</label>
                    <input type="number" id="edit-production-sell-price" class="w-full p-2 border rounded-md" step="0.01" placeholder="0">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">???????</label>
                    <textarea id="edit-production-notes" class="w-full p-2 border rounded-md" rows="3"></textarea>
                </div>

                <div id="production-summary" class="bg-gray-50 border border-gray-200 p-3 rounded-md text-sm">
                    <p><strong>??????? ?????????:</strong> <span id="summary-total-cost">0</span></p>
                    <p><strong>?????? ?????:</strong> <span id="summary-total-revenue">0</span></p>
                    <p><strong>?????/???????:</strong> <span id="summary-profit-loss" class="font-bold">0</span></p>
                </div>

                <div class="flex gap-2">
                    <button type="button" id="btn-save-production-update" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">??? ?????????</button>
                    <button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-edit-production').classList.remove('modal-visible'); document.getElementById('modal-edit-production').classList.add('modal-hidden');">?????</button>
                </div>
            </form>
        </div>
    </div>

<script src="js/main.js" charset="UTF-8"></script>
</body>
</html>

    <script>
        // Prevent the production edit modal from causing a full restart � attach safe save handler
        (function(){
            // Ensure the DOM is ready or the element exists (script placed at end of body)
            const saveProductionBtn = document.getElementById('btn-save-production-update');
            if (saveProductionBtn) {
                saveProductionBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const productionIdEl = document.getElementById('edit-production-id');
                    const finalQtyEl = document.getElementById('edit-production-final-qty');
                    const statusEl = document.getElementById('edit-production-status');
                    const sellPriceEl = document.getElementById('edit-production-sell-price');
                    const notesEl = document.getElementById('edit-production-notes');

                    const productionId = productionIdEl ? productionIdEl.value : '';
                    const finalQty = parseFloat(finalQtyEl ? finalQtyEl.value : 0) || 0;
                    const status = statusEl ? statusEl.value : '';
                    const sellPrice = parseFloat(sellPriceEl ? sellPriceEl.value : 0) || 0;
                    const notes = notesEl ? notesEl.value : '';

                    const production = (window.state && Array.isArray(window.state.productions) ? window.state.productions : []).find(p => p.id === productionId);
                    if (!production) {
                        alert('???????? ??? ??????');
                        return;
                    }

                    production.actualQty = finalQty;
                    production.finalQty = finalQty;
                    production.status = status;
                    production.sellPrice = sellPrice;
                    production.notes = notes;
                    production.totalRevenue = finalQty * sellPrice;
                    production.profit = (production.totalRevenue || 0) - (production.totalCost || 0);

                    if (status === 'completed' && !production.completedDate) {
                        production.completedDate = new Date().toISOString().split('T')[0];
                    }

                    try { if (typeof saveState === 'function') saveState(); } catch(err) { console.error(err); }

                    try {
                        if (typeof window.saveProductionToFirebase === 'function') {
                            window.saveProductionToFirebase(production);
                        }
                    } catch(err) { console.warn(err); }

                    alert('? ?? ??? ?????????');
                    
                    // Close modal safely
                    try {
                        const modal = document.getElementById('modal-edit-production');
                        if (modal) {
                            modal.classList.remove('modal-visible');
                            modal.classList.add('modal-hidden');
                        }
                    } catch(_){}
                    
                    if (typeof window.renderProductionsList === 'function') window.renderProductionsList();
                });
            }
        })();
    </script>
    <script src="./taxes.js"></script>
    <script>
        async function fixChocolateVatOneTime(silent=false){
            const chocoRe = /chocolate|شيكولاتة|شوكولاتة/i;
            if (!window.db) { alert('Firestore غير جاهز. الرجاء الانتظار أو تسجيل الدخول Firebase.'); return; }
            try{
                const snap = await db.collection('products').get();
                let updated = 0;
                let batch = db.batch();
                let pending = 0;
                const BATCH_LIMIT = 400;
                for (const doc of snap.docs){
                    try{
                        const data = doc.data() || {};
                        const name = (data.name||'').toString();
                        if (chocoRe.test(name)){
                            // only update if different to avoid unnecessary writes
                            if (!data.vat_rate || Number(data.vat_rate) !== 14){
                                batch.set(doc.ref, { vat_rate: 14, updatedAt: serverTs() }, { merge: true });
                                pending++; updated++;
                                if (pending >= BATCH_LIMIT){ await batch.commit(); batch = db.batch(); pending = 0; }
                            }
                        }
                    }catch(e){ console.warn('fixChocolateVatOneTime: doc skipped', doc.id, e); }
                }
                if (pending > 0) await batch.commit();
                if (!silent) alert('Done! Updated ' + updated + ' products'); else console.log('Chocolate VAT auto-fix updated', updated, 'products');
                try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
            }catch(e){ console.error('fixChocolateVatOneTime failed', e); if (!silent) alert('Error: ' + (e && e.message || e)); }
        }

        // ????? ?????? ???? ?????: ??? ????? ?????? ??????? ???
        function autoFixChocolateVatOnce(){
            try {
                const KEY = 'fix_choco_vat_14_done';
                if (localStorage.getItem(KEY) === '1') return;
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (!(role === 'admin' || role === 'manager')) return;
                if (!window.db || !window.auth || !auth.currentUser) return;
                fixChocolateVatOneTime(true).then(()=>{ try { localStorage.setItem(KEY, '1'); } catch(_){} });
            } catch(e){ console.warn('autoFixChocolateVatOnce failed', e); }
        }
    </script>
    <script>
        // Simple Bluetooth test function - tries multiple UUIDs
        async function performSimpleBluetoothTest() {
            console.log('?? BT Test Started');
            const processingMsg = document.createElement('div');
            processingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:10px;z-index:50001;box-shadow:0 4px 6px rgba(0,0,0,0.2);text-align:center;min-width:300px;';
            processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">???? ????? ?? ????????...</div><div style="font-size:14px;color:#666;">?????? ????</div>`;
            document.body.appendChild(processingMsg);
            
            const uuidCombos = [
                { service: '000018f0-0000-1000-8000-00805f9b34fb', char: '00002af1-0000-1000-8000-00805f9b34fb', name: 'BLE' },
                { service: '0000ff00-0000-1000-8000-00805f9b34fb', char: '0000ff01-0000-1000-8000-00805f9b34fb', name: 'FF00' },
                { service: '49535343-fe7d-4ae5-8fa9-9fafd205e455', char: '49535343-8841-43f4-a8d4-ecbe34729bb3', name: 'HM-10' }
            ];
            
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth ??? ????? ?? ??? ???????. ?????? Chrome ?? Edge.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">???? ???????? ?? ???????</div>`;
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: uuidCombos.map(u => u.service)
                });
                
                console.log('? Device selected:', device.name);
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:blue;">???? ??????? ?? ${device.name || '????????'}...</div>`;
                const server = await device.gatt.connect();
                console.log('? Connected to GATT');
                
                let characteristic = null;
                let usedCombo = null;
                
                for (const combo of uuidCombos) {
                    try {
                        processingMsg.innerHTML = `<div style="font-size:14px;color:#666;">??? ${combo.name}...</div>`;
                        const service = await server.getPrimaryService(combo.service);
                        characteristic = await service.getCharacteristic(combo.char);
                        usedCombo = combo;
                        console.log('? Connected using:', combo.name);
                        break;
                    } catch (e) {
                        console.log('? Failed:', combo.name, e.message);
                        continue;
                    }
                }
                
                if (!characteristic) {
                    throw new Error('?? ????? ??? ???? ????????. ??? ?????? ???.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">? ???? (${usedCombo.name})!<br>???? ???????...</div>`;
                
                const escpos = [
                    0x1B, 0x40, // Initialize
                    0x1B, 0x61, 0x01, // Center
                    0x48, 0x65, 0x6C, 0x6C, 0x6F, // Hello
                    0x0A, 0x0A,
                    0x54, 0x65, 0x73, 0x74, // Test
                    0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A,
                    0x1D, 0x56, 0x00 // Full cut
                ];
                
                const data = new Uint8Array(escpos);
                
                for (let i = 0; i < data.length; i += 20) {
                    const chunk = data.slice(i, i + 20);
                    await characteristic.writeValue(chunk);
                    await new Promise(r => setTimeout(r, 100));
                }
                
                console.log('? Data sent successfully');
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">? ?? ??????? ?????!<br><small>UUID: ${usedCombo.name}</small></div><div style="font-size:14px;color:#666;margin-top:10px;">???? ?? ???????? - ??? ????? "Hello Test"</div>`;
                setTimeout(() => {
                    try { document.body.removeChild(processingMsg); } catch(_){}
                    try { device.gatt.disconnect(); } catch(_){}
                }, 5000);
                
            } catch (err) {
                console.error('?? BT Test Error:', err);
                processingMsg.innerHTML = `<div style="font-size:16px;font-weight:bold;color:red;">???:</div><div style="font-size:12px;color:#666;margin:10px 0;">${err.message}</div><button onclick="this.parentElement.remove()" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">?????</button>`;
            }
        }

        // Print invoice via Bluetooth using ESC/POS commands - ASCII ONLY, like test button
        async function printInvoiceViaBluetooth(saleArg) {
            console.log('?? BT Invoice Print Started');
            const processingMsg = document.createElement('div');
            processingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:10px;z-index:50001;box-shadow:0 4px 6px rgba(0,0,0,0.2);text-align:center;min-width:300px;';
            processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">???? ????? ?? ????????...</div>`;
            document.body.appendChild(processingMsg);
            
            const uuidCombos = [
                { service: '000018f0-0000-1000-8000-00805f9b34fb', char: '00002af1-0000-1000-8000-00805f9b34fb', name: 'BLE' },
                { service: '0000ff00-0000-1000-8000-00805f9b34fb', char: '0000ff01-0000-1000-8000-00805f9b34fb', name: 'FF00' },
                { service: '49535343-fe7d-4ae5-8fa9-9fafd205e455', char: '49535343-8841-43f4-a8d4-ecbe34729bb3', name: 'HM-10' }
            ];
            
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth ??? ????? ?? ??? ???????. ?????? Chrome ?? Edge.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">???? ???????? ?? ???????</div>`;
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: uuidCombos.map(u => u.service)
                });
                
                console.log('? Device selected:', device.name);
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:blue;">???? ??????? ?? ${device.name || '????????'}...</div>`;
                const server = await device.gatt.connect();
                console.log('? Connected to GATT');
                
                let characteristic = null;
                let usedCombo = null;
                
                for (const combo of uuidCombos) {
                    try {
                        processingMsg.innerHTML = `<div style="font-size:14px;color:#666;">??? ${combo.name}...</div>`;
                        const service = await server.getPrimaryService(combo.service);
                        characteristic = await service.getCharacteristic(combo.char);
                        usedCombo = combo;
                        console.log('? Connected using:', combo.name);
                        break;
                    } catch (e) {
                        console.log('? Failed:', combo.name, e.message);
                        continue;
                    }
                }
                
                if (!characteristic) {
                    throw new Error('?? ????? ??? ???? ????????. ??? ?????? ???.');
                }
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">? ???? (${usedCombo.name})!<br>???? ???????...</div>`;
                
                // Helper: Convert ASCII string to byte array (OLD-SCHOOL, like test button)
                function stringToAsciiBytes(str) {
                    const bytes = [];
                    for (let i = 0; i < str.length; i++) {
                        const code = str.charCodeAt(i);
                        if (code <= 127) {
                            bytes.push(code);
                        } else {
                            bytes.push(63); // ? for non-ASCII
                        }
                    }
                    return bytes;
                }
                
                // Build invoice data - ASCII ONLY
                const customer = findCustomer(saleArg.customerId);
                const customerName = (customer && customer.name) ? customer.name.substring(0, 15) : 'Customer';
                const invoiceNum = (saleArg.invoiceNumber || '0').toString();
                const dateObj = new Date(saleArg.createdAt);
                const engDate = ('0' + dateObj.getDate()).slice(-2) + '/' + ('0' + (dateObj.getMonth() + 1)).slice(-2) + '/' + dateObj.getFullYear();
                
                // Start building ESC/POS command array
                let escpos = [
                    0x1B, 0x40, // Initialize printer
                    0x1B, 0x61, 0x01 // Center alignment
                ];
                
                // Add store name
                escpos = escpos.concat(stringToAsciiBytes('DELENTE STORE'));
                escpos.push(0x0A, 0x0A);
                
                // Add separator
                escpos = escpos.concat(stringToAsciiBytes('===================='));
                escpos.push(0x0A);
                
                // Left align for invoice details
                escpos.push(0x1B, 0x61, 0x00);
                
                // Invoice number
                escpos = escpos.concat(stringToAsciiBytes('Invoice #' + invoiceNum));
                escpos.push(0x0A);
                
                // Customer name
                escpos = escpos.concat(stringToAsciiBytes('Customer: ' + customerName));
                escpos.push(0x0A);
                
                // Date
                escpos = escpos.concat(stringToAsciiBytes('Date: ' + engDate));
                escpos.push(0x0A);
                
                // Separator
                escpos = escpos.concat(stringToAsciiBytes('--------------------'));
                escpos.push(0x0A);
                
                // Items header
                escpos = escpos.concat(stringToAsciiBytes('ITEMS'));
                escpos.push(0x0A);
                
                // Add each item
                if (saleArg.items && Array.isArray(saleArg.items)) {
                    saleArg.items.forEach((item, idx) => {
                        const product = findProduct(item.productId);
                        const pName = (product && product.name) ? product.name.substring(0, 15) : 'Item';
                        const qty = item.quantity || 0;
                        const price = item.unitPrice || 0;
                        const total = qty * price;
                        
                        escpos = escpos.concat(stringToAsciiBytes((idx + 1) + '. ' + pName));
                        escpos.push(0x0A);
                        escpos = escpos.concat(stringToAsciiBytes('   ' + qty + 'x ' + price.toFixed(2) + '=' + total.toFixed(2)));
                        escpos.push(0x0A);
                    });
                }
                
                // Separator
                escpos = escpos.concat(stringToAsciiBytes('--------------------'));
                escpos.push(0x0A);
                
                // Total
                const totalAmount = saleArg.totalAmount || 0;
                escpos = escpos.concat(stringToAsciiBytes('TOTAL: ' + totalAmount.toFixed(2) + ' EGP'));
                escpos.push(0x0A, 0x0A);
                
                // Footer
                escpos = escpos.concat(stringToAsciiBytes('Thank you!'));
                escpos.push(0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A);
                
                // Full cut
                escpos.push(0x1D, 0x56, 0x00);
                
                const data = new Uint8Array(escpos);
                
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">???? ???????...</div>`;
                
                // Send data in chunks (100ms delay like test button)
                for (let i = 0; i < data.length; i += 20) {
                    const chunk = data.slice(i, i + 20);
                    await characteristic.writeValue(chunk);
                    await new Promise(r => setTimeout(r, 100));
                }
                
                console.log('? Invoice sent successfully');
                processingMsg.innerHTML = `<div style="font-size:18px;font-weight:bold;color:green;">? ??? ??????? ?????!</div>`;
                setTimeout(() => {
                    try { document.body.removeChild(processingMsg); } catch(_){}
                    try { device.gatt.disconnect(); } catch(_){}
                }, 3000);
                
            } catch (err) {
                console.error('?? BT Print Error:', err);
                processingMsg.innerHTML = `<div style="font-size:16px;font-weight:bold;color:red;">???:</div><div style="font-size:12px;color:#666;margin:10px 0;">${err.message}</div><button onclick="this.parentElement.remove()" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">?????</button>`;
            }
        }
        
        // Attach to yellow test button
        document.addEventListener('DOMContentLoaded', function() {
            const testBtn = document.getElementById('sales-bt-test-btn');
            if (testBtn) {
                console.log('? Bluetooth test button found, attaching handler');
                testBtn.addEventListener('click', function() {
                    console.log('?? Yellow test button clicked');
                    performSimpleBluetoothTest().catch(e => {
                        console.error('Test failed:', e);
                        alert('??? ????????: ' + e.message);
                    });
                });
            } else {
                console.warn('?? sales-bt-test-btn not found in DOM');
            }
        });

        // ==================== INVENTORY SYSTEM (Cloud-First) ====================
        window.inventorySystem = {
            currentTab: 'raw',
            currentItem: null,
            
            // ?? CRITICAL: Sync all local data to window globals BEFORE loading
            // This ensures any recent edits in localStorage are in memory
            _syncFromLocalStorage() {
                try {
                    const rawLS = localStorage.getItem('cost_raw');
                    const packLS = localStorage.getItem('cost_pack');
                    const finLS = localStorage.getItem('cost_finished');
                    
                    if (rawLS) window.costRaw = JSON.parse(rawLS);
                    if (packLS) window.costPack = JSON.parse(packLS);
                    if (finLS) window.costFinished = JSON.parse(finLS);
                    
                    console.log('? _syncFromLocalStorage: updated window arrays from localStorage', {
                        raw: (window.costRaw || []).length,
                        pack: (window.costPack || []).length,
                        finished: (window.costFinished || []).length
                    });
                } catch(e) {
                    console.warn('_syncFromLocalStorage failed:', e);
                }
            },
            
            // Load inventory data from Firestore
            async loadInventoryData(category) {
                try {
                    this.currentTab = category || 'raw';
                    
                    // ?? CRITICAL: Sync from localStorage FIRST to get latest edits
                    this._syncFromLocalStorage();
                    
                    const tbody = document.getElementById(`table-${this.currentTab}`);
                    if (!tbody) {
                        console.warn(`?? Table not found: table-${this.currentTab}`);
                        return;
                    }
                    
                    // ?? CRITICAL: Always refresh from localStorage FIRST to get latest edits
                    // This ensures that if user edited stock and switched tabs, they see the latest version
                    try {
                        if (this.currentTab === 'raw') {
                            const lsRaw = localStorage.getItem('cost_raw');
                            if (lsRaw) window.costRaw = JSON.parse(lsRaw);
                        } else if (this.currentTab === 'packing') {
                            const lsPack = localStorage.getItem('cost_pack');
                            if (lsPack) window.costPack = JSON.parse(lsPack);
                        } else if (this.currentTab === 'finished') {
                            const lsFin = localStorage.getItem('cost_finished');
                            if (lsFin) window.costFinished = JSON.parse(lsFin);
                        }
                    } catch(e){ console.warn('Failed to refresh from localStorage:', e); }
                    
                    // First, try to load from local window arrays (faster, offline-capable)
                    let items = [];
                    
                    if (this.currentTab === 'raw') {
                        if (window.costRaw && Array.isArray(window.costRaw)) {
                            items = window.costRaw;
                            console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from window.costRaw`);
                        }
                        if (items.length === 0) {
                            try {
                                const ls = localStorage.getItem('cost_raw');
                                if (ls) {
                                    items = JSON.parse(ls) || [];
                                    window.costRaw = items;
                                    console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from localStorage.cost_raw`);
                                }
                            } catch(_){}
                        }
                    } else if (this.currentTab === 'packing') {
                        if (window.costPack && Array.isArray(window.costPack)) {
                            items = window.costPack;
                            console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from window.costPack`);
                        }
                        if (items.length === 0) {
                            try {
                                const ls = localStorage.getItem('cost_pack');
                                if (ls) {
                                    items = JSON.parse(ls) || [];
                                    window.costPack = items;
                                    console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from localStorage.cost_pack`);
                                }
                            } catch(_){}
                        }
                    } else if (this.currentTab === 'finished') {
                        if (window.costFinished && Array.isArray(window.costFinished)) {
                            items = window.costFinished;
                            window.finishedProducts = window.costFinished; // Keep in sync
                            console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from window.costFinished`);
                        }
                        // Fallback to legacy finishedProducts array
                        if (items.length === 0 && window.finishedProducts && Array.isArray(window.finishedProducts)) {
                            items = window.finishedProducts;
                            console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from window.finishedProducts`);
                        }
                        // Fallback to localStorage key
                        if (items.length === 0) {
                            try {
                                const ls = localStorage.getItem('cost_finished');
                                if (ls) {
                                    items = JSON.parse(ls) || [];
                                    window.costFinished = items;
                                    window.finishedProducts = items;
                                    console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from localStorage.cost_finished`);
                                }
                            } catch(_){}
                        }
                        // Fallback to finished grid state object (derived to array)
                        if (items.length === 0) {
                            try {
                                const gridObj = (window._finishedGridState && typeof window._finishedGridState === 'object')
                                    ? window._finishedGridState
                                    : (function(){ try { return JSON.parse(localStorage.getItem('finished_products_grid')||'{}'); } catch(_) { return {}; } })();
                                const keys = Object.keys(gridObj||{});
                                if (keys.length > 0) {
                                    items = keys.map(id => {
                                        const it = gridObj[id]||{};
                                        return {
                                            id,
                                            name: it.name || id,
                                            stock: (it.actual != null ? it.actual : (it.opening != null ? it.opening : 0)),
                                            unit: '????',
                                            cost: Number(it.cost||0)
                                        };
                                    });
                                    console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from finished_products_grid`);
                                }
                            } catch(e){ console.warn('derive finished from grid failed', e); }
                        }
                        // ? DO NOT FALLBACK TO DEFAULT_PRODUCTS - Cloud is authoritative
                        // If finished products are empty in cloud, they should be empty here too
                        // Fallback to seed data would cause data loss on refresh
                    }
                    
                    // If local arrays are empty, try Firestore (last resort)
                    // Avoid slow retries when offline - DISABLED to prevent hang
                    if (false && items.length === 0 && window.db && navigator.onLine) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">???? ??????? ?? ???????...</td></tr>';
                        try {
                            const snapshot = await db.collection('inventory_items').where('category', '==', this.currentTab).get();
                            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                            console.log(`?? Loaded ${items.length} items for category: ${this.currentTab} from Firestore`);
                        } catch(e) {
                            console.warn(`?? Failed to load from Firestore: ${e.message}`);
                        }
                    }
                    
                    // Display items or empty message
                    if (items.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="text-gray-500 text-sm">?? ???? ????? ?? ??? ?????</div><div class="text-xs text-gray-400 mt-2">???? "+" ?????? ??? ????</div></td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = items.map(item => {
                        const itemName = item.name || '??? ????';
                        const itemStock = item.stock !== undefined ? item.stock : 0;
                        const itemPrice = item.price !== undefined ? item.price : (item.cost || item.avgCost || 0);
                        const itemUnit = item.unit || '????';
                        const itemId = item.id || item.name || 'N/A';
                        
                        return `
                            <tr onclick="window.inventorySystem.openItemModal('${itemId}')" class="hover:bg-blue-50 cursor-pointer transition">
                                <td class="p-3 font-bold">${itemName}</td>
                                <td class="p-3"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">${itemStock}</span></td>
                                <td class="p-3 text-sm text-gray-500">${itemUnit}</td>
                                <td class="p-3 text-sm">${parseFloat(itemPrice || 0).toFixed(2)} ?.?</td>
                            </tr>
                        `;
                    }).join('');
                    
                    console.log(`? Rendered ${items.length} items for category: ${this.currentTab}`);
                } catch (err) {
                    console.error('? Load inventory failed:', err);
                    const tbody = document.getElementById(`table-${this.currentTab}`);
                    if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">? ??? ?? ???????: ' + err.message + '</td></tr>';
                }
            },
            
            // Open item detail modal
            async openItemModal(itemId) {
                try {
                    let item = null;
                    let docId = itemId;
                    
                    // STRATEGY 1: Try to find item in local window arrays first
                    // This handles items loaded from localStorage that may not be in Firestore yet
                    const currentArray = 
                        this.currentTab === 'raw' ? window.costRaw :
                        this.currentTab === 'packing' ? window.costPack :
                        window.costFinished;
                    
                    if (Array.isArray(currentArray)) {
                        // Try to find by ID first
                        item = currentArray.find(i => i && (i.id === itemId || i.id === docId));
                        
                        // If not found, try by name (user might have clicked a name-based row)
                        if (!item) {
                            item = currentArray.find(i => i && i.name === itemId);
                            if (item) docId = item.id || itemId;
                        }
                    }
                    
                    // STRATEGY 2: If not in local array, try Firestore
                    let loadedFromFirestore = false;
                    if (!item && window.db) {
                        const doc = await db.collection('inventory_items').doc(itemId).get();
                        if (doc.exists) {
                            item = doc.data();
                            docId = doc.id;
                            loadedFromFirestore = true;
                        }
                    }
                    
                    // If still not found, show error
                    if (!item) {
                        console.warn(`? Item not found: ${itemId}. Current array:`, currentArray);
                        alert('????? ??? ?????');
                        return;
                    }
                    
                    // CRITICAL: If loaded from Firestore, sync to local array so table displays correct stock
                    if (loadedFromFirestore && Array.isArray(currentArray)) {
                        const idx = currentArray.findIndex(i => i && (i.id === docId || i.name === item.name));
                        if (idx >= 0) {
                            // Update existing item in array
                            currentArray[idx].stock = item.stock || 0;
                            currentArray[idx].avgCost = item.avgCost || item.cost || currentArray[idx].cost || 0;
                            console.log(`?? Synced Firestore stock to array[${idx}]: ${item.name} ? ${item.stock}`);
                        } else {
                            // Add new item to array
                            currentArray.push({
                                id: docId,
                                name: item.name,
                                stock: item.stock || 0,
                                unit: item.unit || '????',
                                cost: item.avgCost || item.cost || 0,
                                avgCost: item.avgCost || item.cost || 0,
                                price: item.price || item.cost || 0,
                                category: this.currentTab
                            });
                            console.log(`? Added Firestore item to array: ${item.name}`);
                        }
                        
                        // Save updated array to localStorage
                        if (this.currentTab === 'finished') {
                            localStorage.setItem('cost_finished', JSON.stringify(window.costFinished));
                            window.__finishedTouched = true;
                        } else if (this.currentTab === 'raw') {
                            localStorage.setItem('cost_raw', JSON.stringify(window.costRaw));
                            window.__rawTouched = true;
                        } else if (this.currentTab === 'packing') {
                            localStorage.setItem('cost_pack', JSON.stringify(window.costPack));
                            window.__packTouched = true;
                        }
                        
                        // Re-render table to show updated stock
                        this.loadInventoryData(this.currentTab);
                    }
                    
                    // Store current item for editing
                    this.currentItem = { id: docId, ...item };
                    
                    // Calculate values
                    const stock = Number(item.stock) || 0;
                    const cost = Number(item.avgCost || item.cost || item.price) || 0;
                    const totalValue = stock * cost;
                    const minStock = Number(item.minStock || item.reorderPoint) || 10; // Default 10
                    const unit = item.unit || '????';
                    
                    // Update modal header
                    document.getElementById('modal-title').textContent = `${item.name || '?????? ?????'} (${unit})`;
                    document.getElementById('modal-code').textContent = item.code || docId || 'FP-001';
                    
                    // Update category badge
                    const categoryNames = {
                        'finished': '?? ???? ???',
                        'raw': '?? ?????',
                        'packing': '?? ?????'
                    };
                    const categoryEl = document.getElementById('modal-category');
                    if (categoryEl) {
                        categoryEl.textContent = categoryNames[this.currentTab] || '?? ???? ???';
                    }
                    
                    // Update stats cards
                    document.getElementById('modal-min').textContent = minStock;
                    document.getElementById('modal-total-value').textContent = totalValue.toLocaleString('en-EG', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    document.getElementById('modal-cost').textContent = cost.toLocaleString('en-EG', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    document.getElementById('modal-stock').textContent = stock;
                    document.getElementById('modal-unit').textContent = unit;
                    
                    // TODO: Load movement history from Firestore
                    // For now, show empty state
                    const movementsTable = document.getElementById('modal-movements');
                    if (movementsTable) {
                        // Load movements if online and have itemId
                        if (navigator.onLine && docId && window.loadMovementHistory) {
                            try {
                                const movements = await window.loadMovementHistory(docId);
                                if (movements && movements.length > 0) {
                                    window.displayMovementHistory(movements);
                                } else {
                                    movementsTable.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">?? ???? ????? ????? ??????</td></tr>';
                                }
                            } catch(e) {
                                console.warn('Could not load movements:', e);
                                movementsTable.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">?? ???? ????? ????? ??????</td></tr>';
                            }
                        } else {
                            movementsTable.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">?? ???? ????? ????? ??????</td></tr>';
                        }
                    }
                    
                    document.getElementById('itemCardModal').style.display = 'block';
                    
                    console.log(`? Opened item modal: ${item.name} (from ${loadedFromFirestore ? 'Firestore' : 'Local Array'})`);
                } catch (err) {
                    console.error('? Open modal failed:', err);
                    alert('??? ?? ??? ????????');
                }
            },
            
            // Adjust stock (add/subtract)
            async adjustStock(action) {
                if (!this.currentItem) {
                    alert('? ?? ??? ????? ???');
                    return;
                }
                const qty = prompt(action === 'add' ? '?? ?????? ?????????' : '?? ?????? ?????????', '0');
                if (!qty || isNaN(qty) || Number(qty) <= 0) return;
                
                try {
                    const newStock = (this.currentItem.stock || 0) + (action === 'add' ? Number(qty) : -Number(qty));
                    if (newStock < 0) { alert('?????? ?? ???? ?? ???? ????'); return; }
                    
                    // Try to update in Firestore if DB is available (create-or-update)
                    if (window.db && this.currentItem.id && navigator.onLine) {
                        try {
                            // 1. Save to inventory_items
                            await db.collection('inventory_items').doc(this.currentItem.id).set({ 
                                stock: newStock, 
                                updatedAt: serverTs(),
                                name: this.currentItem.name || '',
                                unit: this.currentItem.unit || '????',
                                category: this.currentTab || 'packing'
                            }, { merge: true });
                            console.log(`? Stock saved to Firestore: ${this.currentItem.name} ? ${newStock}`);
                            
                            // 2. CRITICAL: Update array in costLists document IMMEDIATELY to prevent onSnapshot overwrite
                            const array = this.currentTab === 'raw' ? window.costRaw :
                                          this.currentTab === 'packing' ? window.costPack :
                                          window.costFinished;
                            
                            if (Array.isArray(array)) {
                                const idx = array.findIndex(i => i && (i.id === this.currentItem.id || i.name === this.currentItem.name));
                                if (idx >= 0) {
                                    array[idx].stock = newStock;
                                }
                                
                                // ?? CRITICAL: Update window.costLists to ensure saveLists() picks up changes
                                if (!window.costLists) window.costLists = {};
                                if (this.currentTab === 'raw') {
                                    window.costLists.costRaw = array;
                                } else if (this.currentTab === 'packing') {
                                    window.costLists.costPack = array;
                                } else if (this.currentTab === 'finished') {
                                    window.costLists.costFinished = array;
                                }
                                
                                // Save to cloud immediately
                                const payload = {};
                                if (this.currentTab === 'raw') {
                                    payload.raw = array;
                                    window.__rawTouched = true;
                                } else if (this.currentTab === 'packing') {
                                    payload.pack = array;
                                    window.__packTouched = true;
                                } else if (this.currentTab === 'finished') {
                                    payload.finished = array;
                                    window.__finishedTouched = true;
                                }
                                payload.timestamp = new Date().toISOString();
                                payload.updatedAt = serverTs();
                                
                                await db.collection('settings').doc('costLists').set(payload, { merge: true });
                                console.log(`?? Immediately updated costLists.${this.currentTab} in cloud to prevent overwrite`);
                            }
                        } catch(dbErr) {
                            console.warn(`?? Could not save to Firestore (offline or missing doc): ${dbErr.message}`);
                            try { if (typeof window.addPendingInventoryUpdate === 'function') window.addPendingInventoryUpdate({ id: this.currentItem.id, category: this.currentTab, stock: newStock, name: this.currentItem.name }); } catch(_){ }
                        }
                    } else {
                        try { if (typeof window.addPendingInventoryUpdate === 'function') window.addPendingInventoryUpdate({ id: this.currentItem.id, category: this.currentTab, stock: newStock, name: this.currentItem.name }); } catch(_){ }
                    }
                    
                    // Update in memory and local arrays
                    this.currentItem.stock = newStock;
                    
                    // CRITICAL: Also update in the appropriate window array so it persists
                    const array = this.currentTab === 'raw' ? window.costRaw :
                                  this.currentTab === 'packing' ? window.costPack :
                                  window.costFinished;
                    
                    if (Array.isArray(array)) {
                        const idx = array.findIndex(i => i && (i.id === this.currentItem.id || i.name === this.currentItem.name));
                        if (idx >= 0) {
                            array[idx].stock = newStock;
                            console.log(`?? Updated array[${idx}].stock = ${newStock} for ${this.currentItem.name}`);
                        } else {
                            // Item not in array - add it
                            const newItem = {
                                id: this.currentItem.id,
                                name: this.currentItem.name,
                                stock: newStock,
                                unit: this.currentItem.unit || '????',
                                cost: this.currentItem.cost || this.currentItem.price || 0,
                                category: this.currentTab
                            };
                            array.push(newItem);
                            console.log(`? Added new item to array: ${this.currentItem.name} with stock ${newStock}`);
                        }
                    }
                    
                    // CRITICAL: Save updated array to localStorage immediately
                    if (this.currentTab === 'raw') {
                        localStorage.setItem('cost_raw', JSON.stringify(window.costRaw));
                        window.__rawTouched = true; // Mark as modified for cloud save
                    } else if (this.currentTab === 'packing') {
                        localStorage.setItem('cost_pack', JSON.stringify(window.costPack));
                        window.__packTouched = true; // Mark as modified for cloud save
                    } else if (this.currentTab === 'finished') {
                        localStorage.setItem('cost_finished', JSON.stringify(window.costFinished));
                        // Also sync to legacy alias
                        window.finishedProducts = window.costFinished;
                        window.__finishedTouched = true; // Mark as modified for cloud save
                    }
                    
                    // Update modal display
                    document.getElementById('modal-stock').textContent = newStock;
                    this.loadInventoryData(this.currentTab); // Refresh table
                    
                    // LOG MOVEMENT TO FIRESTORE
                    if (typeof window.logMovement === 'function') {
                        try {
                            await window.logMovement(this.currentItem.id, this.currentItem.name, Number(qty), action, this.currentTab);
                        } catch(e) {
                            console.warn('Could not log movement:', e.message);
                        }
                    }
                    
                    // Note: Already saved to cloud immediately after Firestore save above
                    
                    // Update total inventory value display
                    if (typeof window.updateTotalValue === 'function') {
                        setTimeout(() => window.updateTotalValue(), 300);
                    }
                    
                    console.log(`? Stock adjusted: ${this.currentItem.name} ? ${newStock}`);
                } catch (err) {
                    console.error('? Adjust stock failed:', err);
                    alert('??? ?? ????? ??????');
                }
            },
            
            showAddItemModal() {
                // Clear form fields
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemStock').value = '0';
                document.getElementById('newItemCost').value = '0';
                
                // Set defaults based on current tab
                const currentCat = this.currentTab || 'finished';
                const catSelect = document.getElementById('newItemCat');
                if (catSelect) catSelect.value = currentCat;
                
                // Show modal and focus name field
                document.getElementById('addItemModal').style.display = 'block';
                setTimeout(() => {
                    const nameInput = document.getElementById('newItemName');
                    if (nameInput) nameInput.focus();
                }, 100);
            },
            
            async saveNewItem() {
                // This is kept for backward compatibility but now calls saveNewItemAction
                if (typeof window.saveNewItemAction === 'function') {
                    await window.saveNewItemAction();
                }
            }
        };
        
        // ===== NEW MODAL HELPER FUNCTIONS =====
        
        window.closeAddModal = function() {
            document.getElementById('addItemModal').style.display = 'none';
        };
        
        window.saveNewItemAction = async function() {
            try {
                const name = document.getElementById('newItemName').value.trim();
                const cat = document.getElementById('newItemCat').value;
                const unit = document.getElementById('newItemUnit').value;
                const stock = Number(document.getElementById('newItemStock').value) || 0;
                const cost = Number(document.getElementById('newItemCost').value) || 0;

                if (!name) {
                    alert("? ???? ????? ??? ?????");
                    return;
                }

                // Close modal first
                window.closeAddModal();

                // Create new item object
                const newItem = { 
                    name, 
                    type: cat,
                    category: cat,
                    unit, 
                    stock, 
                    avgCost: cost,
                    cost: cost,
                    price: cost, 
                    isActive: true,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                };

                // Save to Firestore
                if (window.db) {
                    const docRef = await db.collection('inventory_items').add(newItem);
                    newItem.id = docRef.id;
                    await docRef.update({ id: docRef.id });
                    console.log(`? Saved to Firestore: ${name} (${docRef.id})`);
                }
                
                // Update local arrays
                if (cat === 'raw') {
                    if (!window.costRaw) window.costRaw = [];
                    window.costRaw.push(newItem);
                    localStorage.setItem('cost_raw', JSON.stringify(window.costRaw));
                    window.__rawTouched = true;
                    // Update window.costLists
                    if (!window.costLists) window.costLists = {};
                    window.costLists.costRaw = window.costRaw;
                } else if (cat === 'packing') {
                    if (!window.costPack) window.costPack = [];
                    window.costPack.push(newItem);
                    localStorage.setItem('cost_pack', JSON.stringify(window.costPack));
                    window.__packTouched = true;
                    // Update window.costLists
                    if (!window.costLists) window.costLists = {};
                    window.costLists.costPack = window.costPack;
                } else if (cat === 'finished') {
                    if (!window.costFinished) window.costFinished = [];
                    window.costFinished.push(newItem);
                    localStorage.setItem('cost_finished', JSON.stringify(window.costFinished));
                    window.__finishedTouched = true;
                    // Update window.costLists
                    if (!window.costLists) window.costLists = {};
                    window.costLists.costFinished = window.costFinished;
                }
                
                // ?? CRITICAL: Save IMMEDIATELY to costLists to prevent cloud overwrite
                if (window.db && navigator.onLine) {
                    try {
                        const payload = {};
                        if (cat === 'raw') {
                            payload.raw = window.costRaw;
                        } else if (cat === 'packing') {
                            payload.pack = window.costPack;
                        } else if (cat === 'finished') {
                            payload.finished = window.costFinished;
                        }
                        payload.updatedAt = serverTs();
                        
                        await db.collection('settings').doc('costLists').set(payload, { merge: true });
                        console.log(`?? Immediately saved new item to costLists.${cat}`);
                    } catch(dbErr) {
                        console.warn('Cloud costLists save failed:', dbErr.message);
                    }
                }
                
                // Switch to the category tab and refresh UI
                if (typeof window.switchInvTab === 'function') {
                    window.switchInvTab(cat);
                }
                
                // Render tables
                if (typeof renderRawMaterials === 'function') renderRawMaterials();
                if (typeof renderPackaging === 'function') renderPackaging();
                if (typeof renderFinishedProducts === 'function') renderFinishedProducts();
                
                // Update total value
                if (typeof updateTotalValue === 'function') {
                    setTimeout(() => updateTotalValue(), 300);
                }
                
                alert(`? ?? ??? ?????: ${name}`);

            } catch(e) {
                console.error('saveNewItemAction error:', e);
                alert("? ???: " + e.message);
            }
        };
        
        // ===== EDIT ITEM MODAL (Clear Add/Subtract Buttons) =====
        window.openEditItemModal = function() {
            if (!window.inventorySystem || !window.inventorySystem.currentItem) {
                alert('? ?? ??? ????? ???');
                return;
            }
            
            const item = window.inventorySystem.currentItem;
            
            // Populate modal
            document.getElementById('edit-item-name').textContent = item.name || '???';
            document.getElementById('edit-current-stock').textContent = item.stock || 0;
            document.getElementById('edit-unit').textContent = item.unit || '????';
            
            // Close details modal and show edit modal
            document.getElementById('itemCardModal').style.display = 'none';
            document.getElementById('editItemModal').style.display = 'block';
        };
        
        window.closeEditModal = function() {
            document.getElementById('editItemModal').style.display = 'none';
            // Re-open item details modal
            document.getElementById('itemCardModal').style.display = 'block';
        };
        
        window.performStockAdjust = function(action) {
            // Close edit modal
            document.getElementById('editItemModal').style.display = 'none';
            
            // Call the adjust function
            if (window.inventorySystem && typeof window.inventorySystem.adjustStock === 'function') {
                window.inventorySystem.adjustStock(action);
            }
        };

        // ===== Offline Queue for Inventory Updates =====
        (function(){
            const LS_INV_QUEUE = 'pending_inventory_updates';
            function readQueue(){ try { return JSON.parse(localStorage.getItem(LS_INV_QUEUE) || '[]'); } catch(_) { return []; } }
            function writeQueue(arr){ try { localStorage.setItem(LS_INV_QUEUE, JSON.stringify(arr||[])); } catch(_){} }
            window.addPendingInventoryUpdate = function(op){
                try {
                    const q = readQueue();
                    q.push({ id: op.id, category: op.category, stock: op.stock, name: op.name, ts: new Date().toISOString() });
                    writeQueue(q);
                    console.log('?? queued inventory update', op);
                } catch(e){ console.warn('queue add failed', e); }
            };
            window.flushPendingInventoryUpdates = async function(){
                if (!navigator.onLine || !window.db) return false;
                let q = readQueue(); if (!Array.isArray(q) || q.length===0) return true;
                const remaining = [];
                for (const op of q){
                    try {
                        if (!op.id) { remaining.push(op); continue; }
                        await db.collection('inventory_items').doc(op.id).set({ stock: op.stock, updatedAt: serverTs() }, { merge: true });
                        console.log('?? flushed inventory update', op);
                    } catch(e){ console.warn('flush failed for', op, e); remaining.push(op); }
                }
                writeQueue(remaining);
                return remaining.length===0;
            };
            window.addEventListener('online', function(){ 
                // Re-enabled: Safe auto-flush when back online
                console.log('?? Back online! Auto-flushing pending updates...');
                try { 
                    setTimeout(() => window.flushPendingInventoryUpdates(), 500);
                } catch(e){ console.warn('Auto-flush on online failed:', e); } 
            });
            // Try flushing shortly after page load
            // Disabled: was polling aggressively
            // setTimeout(()=>{ try { window.flushPendingInventoryUpdates(); } catch(_){ } }, 3000);
        })();

        // ==================== DATA MIGRATION (Auto-Run on First Load) ====================
        window.migrateInventoryToCloud = async function() {
            try {
                if (!window.db) { 
                    console.warn('?? Firestore not ready yet, will retry...');
                    return false; 
                }
                
                // Ensure arrays are loaded
                if (!window.costRaw) window.costRaw = [];
                if (!window.costPack) window.costPack = [];
                if (!window.finishedProducts) window.finishedProducts = [];
                
                const migrated = { raw: 0, packing: 0, finished: 0 };
                
                // Helper function to get server timestamp
                const getTimestamp = () => {
                    try {
                        return firebase.firestore.FieldValue.serverTimestamp();
                    } catch(e) {
                        return new Date();
                    }
                };
                
                // Migrate window.costRaw (raw materials)
                if (Array.isArray(window.costRaw) && window.costRaw.length > 0) {
                    console.log(`?? Migrating ${window.costRaw.length} raw materials...`);
                    for (const item of window.costRaw) {
                        try {
                            if (!item || !item.name) continue;
                            
                            const docId = item.id || item.code || `raw_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                            const docRef = db.collection('inventory_items').doc(docId);
                            const existing = await docRef.get();
                            
                            if (!existing.exists) {
                                await docRef.set({
                                    name: item.name || '',
                                    code: item.code || '',
                                    unit: item.unit || '???',
                                    category: 'raw',
                                    stock: 0,
                                    cost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    avgCost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    priceHistory: Array.isArray(item.priceHistory) ? item.priceHistory : [],
                                    lastInvoiceNumber: item.lastInvoiceNumber || '',
                                    lastVendorTaxId: item.lastVendorTaxId || '',
                                    createdAt: getTimestamp(),
                                    updatedAt: getTimestamp()
                                });
                                migrated.raw++;
                            }
                        } catch(itemErr) {
                            console.warn(`?? Failed to migrate raw item: ${item?.name}`, itemErr);
                        }
                    }
                    console.log(`? Migrated ${migrated.raw} raw materials`);
                }
                
                // Migrate window.costPack (packaging)
                if (Array.isArray(window.costPack) && window.costPack.length > 0) {
                    console.log(`?? Migrating ${window.costPack.length} packaging items...`);
                    for (const item of window.costPack) {
                        try {
                            if (!item || !item.name) continue;
                            
                            const docId = item.id || item.code || `pack_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                            const docRef = db.collection('inventory_items').doc(docId);
                            const existing = await docRef.get();
                            
                            if (!existing.exists) {
                                await docRef.set({
                                    name: item.name || '',
                                    code: item.code || '',
                                    unit: item.unit || '????',
                                    category: 'packing',
                                    stock: 0,
                                    cost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    avgCost: parseFloat(item.cost) || parseFloat(item.lastPrice) || 0,
                                    priceHistory: Array.isArray(item.priceHistory) ? item.priceHistory : [],
                                    createdAt: getTimestamp(),
                                    updatedAt: getTimestamp()
                                });
                                migrated.packing++;
                            }
                        } catch(itemErr) {
                            console.warn(`?? Failed to migrate packing item: ${item?.name}`, itemErr);
                        }
                    }
                    console.log(`? Migrated ${migrated.packing} packaging items`);
                }

                // Migrate window.finishedProducts if exists
                if (Array.isArray(window.finishedProducts) && window.finishedProducts.length > 0) {
                    console.log(`?? Migrating ${window.finishedProducts.length} finished products...`);
                    for (const item of window.finishedProducts) {
                        try {
                            if (!item || !item.name) continue;
                            
                            const docId = item.id || `finished_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                            const docRef = db.collection('inventory_items').doc(docId);
                            const existing = await docRef.get();
                            
                            if (!existing.exists) {
                                await docRef.set({
                                    name: item.name || '',
                                    code: item.code || '',
                                    unit: item.unit || '????',
                                    category: 'finished',
                                    stock: 0,
                                    cost: parseFloat(item.cost) || 0,
                                    avgCost: parseFloat(item.cost) || 0,
                                    createdAt: getTimestamp(),
                                    updatedAt: getTimestamp()
                                });
                                migrated.finished++;
                            }
                        } catch(itemErr) {
                            console.warn(`?? Failed to migrate finished product: ${item?.name}`, itemErr);
                        }
                    }
                    console.log(`? Migrated ${migrated.finished} finished products`);
                }
                
                const total = migrated.raw + migrated.packing + migrated.finished;
                if (total > 0) {
                    console.log(`?? Migration completed! Total: ${total} items`);
                    
                    // Show success message to user
                    try {
                        await customDialog({ 
                            title: '? ?? ??? ????????', 
                            message: `?? ??? ${total} ??? ??? ??????? ?????!\n\n� ?????: ${migrated.raw}\n� ?????: ${migrated.packing}\n� ?????? ????: ${migrated.finished}` 
                        });
                    } catch(e) { 
                        console.warn('Dialog failed:', e);
                    }
                    
                    // Auto-refresh inventory view if on stock-control page
                    if (window.inventorySystem && window.inventorySystem.loadInventoryData) {
                        setTimeout(() => window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab || 'raw'), 500);
                    }
                } else {
                    console.log('?? No new items to migrate');
                }
                
                return true;
            } catch (err) {
                console.error('? Migration failed:', err);
                try {
                    await customDialog({ title: '? ???', message: '??? ??? ????????:\n' + (err.message || JSON.stringify(err)) });
                } catch(e) { 
                    console.error('Error dialog failed:', e);
                }
                return false;
            }
        };

        // AUTO-RUN MIGRATION: Check if inventory is empty, then migrate
        window.autoMigrateIfNeeded = async function() {
            try {
                if (!window.db) {
                    console.log('? Waiting for Firestore...');
                    setTimeout(window.autoMigrateIfNeeded, 1000);
                    return;
                }
                // ?? ?????? ??????? ????? ???? ??????? ??? ???? ?? ???? ???????? ??????
                if (window.__migrationAttempted) { console.log('?? Migration already attempted, skipping.'); return; }
                if (!navigator.onLine) { console.log('?? Offline: skipping auto-migration'); window.__migrationAttempted = true; return; }
                
                // Ensure costRaw and costPack are loaded from localStorage if not in window
                if (!window.costRaw || window.costRaw.length === 0) {
                    try {
                        const rawFromLS = localStorage.getItem('cost_raw');
                        if (rawFromLS) {
                            window.costRaw = JSON.parse(rawFromLS);
                            console.log(`?? Loaded ${window.costRaw.length} items from localStorage (cost_raw)`);
                        }
                    } catch(e) {
                        console.warn('Failed to load cost_raw from localStorage:', e);
                    }
                }
                
                if (!window.costPack || window.costPack.length === 0) {
                    try {
                        const packFromLS = localStorage.getItem('cost_pack');
                        if (packFromLS) {
                            window.costPack = JSON.parse(packFromLS);
                            console.log(`?? Loaded ${window.costPack.length} items from localStorage (cost_pack)`);
                        }
                    } catch(e) {
                        console.warn('Failed to load cost_pack from localStorage:', e);
                    }
                }
                
                // Check if inventory_items collection is empty
                const snapshot = await db.collection('inventory_items').limit(1).get();
                
                if (snapshot.empty) {
                    console.log('?? Inventory is empty. Starting auto-migration...');
                    window.__migrationAttempted = true;
                    
                    // Show loading message
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'migration-loading';
                    loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:99999;text-align:center;';
                    loadingDiv.innerHTML = '<div style="font-size:20px;font-weight:bold;color:#2563eb;margin-bottom:10px;">?? ???? ??? ????????...</div><div style="font-size:14px;color:#666;">?????? ????????...</div>';
                    document.body.appendChild(loadingDiv);
                    
                    await window.migrateInventoryToCloud();
                    
                    // Remove loading message
                    try { document.getElementById('migration-loading').remove(); } catch(e) {}
                    
                } else {
                    console.log('? Inventory already has data. Skipping migration.');
                    window.__migrationAttempted = true;
                }
            } catch (err) {
                console.error('? Auto-migration check failed:', err);
            }
        };

        // Auto-load inventory when stock-control page is opened
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to initialize, then check migration
            setTimeout(() => {
                window.autoMigrateIfNeeded();
            }, 2000);
            
            // Load inventory data if stock page is active
            setTimeout(() => {
                const stockPage = document.getElementById('page-stock-control');
                if (stockPage && stockPage.classList.contains('active')) {
                    if (window.inventorySystem) window.inventorySystem.loadInventoryData('raw');
                }
            }, 3000);
        });

        // ==================== BRIDGE OLD RENDER FUNCTIONS TO NEW UI ====================
        // Override old functions to work with new tabbed interface
        
        // Fix Counters - Update tab headers with correct item counts
        function updateCounters() {
            try {
                // Update Raw Materials counter
                if (window.costRaw && Array.isArray(window.costRaw)) {
                    const btnRaw = document.getElementById('btn-raw');
                    if (btnRaw) {
                        btnRaw.innerHTML = `?? ????? <span class="bg-yellow-100 text-yellow-800 text-xs px-2 rounded-full">${window.costRaw.length}</span>`;
                    }
                }
                
                // Update Packaging counter
                if (window.costPack && Array.isArray(window.costPack)) {
                    const btnPack = document.getElementById('btn-packing');
                    if (btnPack) {
                        btnPack.innerHTML = `?? ????? <span class="bg-purple-100 text-purple-800 text-xs px-2 rounded-full">${window.costPack.length}</span>`;
                    }
                }
                
                // Fix Finished Products: count from costFinished, finishedProducts, or derived grid state
                let finishedCount = 0;
                if (window.costFinished && Array.isArray(window.costFinished) && window.costFinished.length > 0) {
                    window.finishedProducts = window.costFinished;
                    finishedCount = window.costFinished.length;
                    // REMOVED: renderFinishedProducts() call here causes infinite loop with render?updateCounters?render
                } else if (window.finishedProducts && Array.isArray(window.finishedProducts) && window.finishedProducts.length > 0) {
                    finishedCount = window.finishedProducts.length;
                } else {
                    try {
                        const derived = (typeof __getFinishedFromGrid === 'function') ? __getFinishedFromGrid() : [];
                        finishedCount = Array.isArray(derived) ? derived.length : 0;
                        // REMOVED: renderFinishedProducts() call here causes infinite loop
                    } catch(_) { finishedCount = 0; }
                }
                
                const btnFinished = document.getElementById('btn-finished');
                if (btnFinished) {
                    btnFinished.innerHTML = `?? ???? ??? <span class="bg-blue-100 text-blue-800 text-xs px-2 rounded-full">${finishedCount}</span>`;
                }
                
                console.log(`? updateCounters: Raw=${window.costRaw?.length || 0}, Pack=${window.costPack?.length || 0}, Finished=${finishedCount}`);
                
                // REMOVED: Automatic save on every counter update (causes infinite loop)
                // Save operations should only happen on user action or data change, not on display update
            } catch(e) {
                console.error('? updateCounters failed:', e);
            }
        }
        
        function renderRawMaterials() {
            try {
                const tbody = document.getElementById('table-raw');
                if (!tbody) {
                    console.warn('?? table-raw not found');
                    return;
                }
                if (!window.costRaw || !Array.isArray(window.costRaw) || window.costRaw.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">?? ???? ?????</td></tr>';
                    return;
                }
                
                tbody.innerHTML = window.costRaw.map((item, idx) => `
                    <tr onclick="window.inventorySystem.openItemModal('${item.id || item.name || 'raw_' + idx}')" class="hover:bg-blue-50 cursor-pointer border-b">
                        <td class="p-3 font-bold">${item.name || '??? ????'}</td>
                        <td class="p-3 text-blue-700 font-bold text-center">${item.stock || 0}</td>
                        <td class="p-3 text-sm text-gray-500 text-center">${item.unit || '???'}</td>
                        <td class="p-3 text-sm text-center">${parseFloat(item.cost || item.avgCost || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                console.log(`? renderRawMaterials: rendered ${window.costRaw.length} items`);
                // REMOVED: updateCounters() call to prevent infinite cascading
            } catch(e) {
                console.error('? renderRawMaterials failed:', e);
            }
        }

        function renderPackaging() {
            try {
                const tbody = document.getElementById('table-packing');
                if (!tbody) {
                    console.warn('?? table-packing not found');
                    return;
                }
                if (!window.costPack || !Array.isArray(window.costPack) || window.costPack.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">?? ???? ???? ?????</td></tr>';
                    return;
                }

                tbody.innerHTML = window.costPack.map((item, idx) => `
                    <tr onclick="window.inventorySystem.openItemModal('${item.id || item.name || 'pack_' + idx}')" class="hover:bg-blue-50 cursor-pointer border-b">
                        <td class="p-3 font-bold">${item.name || '??? ????'}</td>
                        <td class="p-3 text-purple-700 font-bold text-center">${item.stock || 0}</td>
                        <td class="p-3 text-sm text-gray-500 text-center">${item.unit || '????'}</td>
                        <td class="p-3 text-sm text-center">${parseFloat(item.cost || item.avgCost || 0).toFixed(2)}</td>
                    </tr>
                `).join('');

                console.log(`? renderPackaging: rendered ${window.costPack.length} items`);
                // REMOVED: updateCounters() call to prevent infinite cascading
            } catch(e) {
                console.error('? renderPackaging failed:', e);
            }
        }

        // Helper: build finished products array from grid state
        function __getFinishedFromGrid(){
            try {
                const src = (window._finishedGridState && typeof window._finishedGridState === 'object') ? window._finishedGridState : (function(){ try { return JSON.parse(localStorage.getItem('finished_products_grid')||'{}'); } catch(_) { return {}; }})();
                const arr = []; const keys = Object.keys(src||{});
                keys.forEach(id => { const it = src[id]||{}; arr.push({ id, name: it.name || id, stock: (it.actual != null ? it.actual : (it.opening != null ? it.opening : 0)), unit: '????', cost: Number(it.cost||0) }); });
                return arr;
            } catch(_) { return []; }
        }

        function renderFinishedProducts() {
            try {
                const tbody = document.getElementById('table-finished');
                if (!tbody) {
                    console.warn('?? table-finished not found');
                    return;
                }
                
                // ? FIXED: Use ONLY window.costFinished (removed finishedProducts fallback to avoid variable mismatch)
                let products = (window.costFinished && Array.isArray(window.costFinished) && window.costFinished.length > 0) ? window.costFinished : __getFinishedFromGrid();
                
                if (!products || !Array.isArray(products) || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">?? ???? ?????? ????. ???? "+" ?????? ????.</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map((item, idx) => {
                    // Handle both old format (id, name, unit, price) and new format (name, stock, cost)
                    const itemName = item.name || '??? ????';
                    const itemStock = item.stock !== undefined ? item.stock : 0;
                    const itemPrice = item.price !== undefined ? item.price : (item.cost || 0);
                    const itemUnit = item.unit || '????';
                    
                    return `
                        <tr onclick="window.inventorySystem.openItemModal('${item.id || item.name || 'finished_' + idx}')" class="hover:bg-blue-50 cursor-pointer border-b">
                            <td class="p-3 font-bold">${itemName}</td>
                            <td class="p-3 text-green-700 font-bold text-center">${itemStock}</td>
                            <td class="p-3 text-sm text-gray-500 text-center">${itemUnit}</td>
                            <td class="p-3 text-sm text-center">${parseFloat(itemPrice || 0).toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                console.log(`? renderFinishedProducts: rendered ${products.length} items`);
                // REMOVED: updateCounters() call - THIS WAS THE INFINITE LOOP SOURCE
            } catch(e) {
                console.error('? renderFinishedProducts failed:', e);
            }
        }

        // Auto-refresh views after page load
        document.addEventListener('DOMContentLoaded', function() {
            // Disabled: was causing excessive polling and hang
            // setTimeout(() => {
            //     console.log('?? Auto-refreshing inventory views...');
            //     updateCounters();
            //     renderRawMaterials();
            //     renderPackaging();
            //     renderFinishedProducts();
            // }, 4000);
        });

        // ========== WAREHOUSE SEARCH FILTER ==========
        window.filterInventory = function() {
            try {
                const query = document.getElementById('inventorySearch')?.value?.toLowerCase() || '';
                
                // Filter all three tables
                const tables = ['table-finished', 'table-raw', 'table-packing'];
                tables.forEach(tableId => {
                    const tbody = document.getElementById(tableId);
                    if (!tbody) return;
                    
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.innerText.toLowerCase();
                        row.style.display = text.includes(query) ? '' : 'none';
                    });
                });
            } catch(e) {
                console.error('filterInventory error:', e);
            }
        };

        // ========== TOTAL INVENTORY VALUE CALCULATOR ==========
        // --- FIX: Smart Total Value Calculation (Handles Price/Cost mix) ---
        window.updateTotalValue = function() {
            let total = 0;
            
            // Helper to calculate category total safely
            const sumCategory = (items, categoryName) => {
                if (!items || !Array.isArray(items)) return;
                
                items.forEach(item => {
                    const qty = parseFloat(item.stock) || 0;
                    
                    // CRITICAL: Check ALL price fields in priority order
                    const unitPrice = parseFloat(item.price) || parseFloat(item.avgCost) || parseFloat(item.cost) || 0;
                    
                    if (qty > 0 && unitPrice === 0) {
                        console.warn(`?? Item "${item.name}" has Stock but ZERO Price!`);
                    }
                    
                    total += qty * unitPrice;
                });
            };

            // Calculate all lists
            sumCategory(window.costRaw, 'Raw');
            sumCategory(window.costPack, 'Packing');
            // Ensure we read the correct Finished Goods array
            const finished = window.costFinished || window.finishedProducts || [];
            sumCategory(finished, 'Finished');

            // Update the UI Element
            const totalEl = document.getElementById('total-inventory-value');
            if (totalEl) {
                totalEl.innerText = total.toLocaleString('en-EG') + ' ?.?';
                totalEl.style.color = total > 0 ? '#2563eb' : '#dc2626'; // Blue if val, Red if 0
            }
            
            console.log("?? Recalculated Total Value:", total);
        };

        // Trigger calculation every 3 seconds to ensure UI stays synced
        setInterval(window.updateTotalValue, 3000);

        // ========== PERSIST INVENTORY ITEMS FROM GRID STATES ==========
        window.normalizeInventoryNow = async function(){
            try {
                if (!window.db) {
                    console.warn('?? normalizeInventoryNow: Firebase not ready, waiting...');
                    try { await waitForDbReady(5000); } catch(e) { console.warn('?? DB wait timed out', e); }
                    if (!window.db) { console.warn('? normalizeInventoryNow: Firebase still not ready'); return false; }
                }
                const batch = db.batch();
                const sanitizeId = (s) => String(s||'').trim().replace(/[/\\#?%]/g,'-');
                const nowTs = serverTs();

                // Helpers to compute stock from grids (same logic as updateTotalValue)
                const getRawStock = (name) => {
                    const s = (window._rawGridState||{})[name] || {};
                    if (s.actual !== undefined && s.actual !== null && !isNaN(Number(s.actual))) return Number(s.actual);
                    if (s.bookBalance !== undefined && !isNaN(Number(s.bookBalance))) return Number(s.bookBalance);
                    const opening = Number(s.opening)||0, inbound = Number(s.inbound)||0, usage = Number(s.usage)||0;
                    return opening + inbound - usage;
                };
                const getPackStock = (name) => {
                    const s = (window._packGridState||{})[name] || {};
                    if (s.actual !== undefined && s.actual !== null && !isNaN(Number(s.actual))) return Number(s.actual);
                    if (s.bookBalance !== undefined && !isNaN(Number(s.bookBalance))) return Number(s.bookBalance);
                    const opening = Number(s.opening)||0, inbound = Number(s.inbound)||0, usage = Number(s.usage)||0;
                    return opening + inbound - usage;
                };
                const getFinishedStock = (item) => {
                    const grid = window._finishedGridState || {};
                    const candidates = [String(item.id||'').trim(), String(item.code||'').trim(), String(item.name||'').trim()].filter(Boolean);
                    let s = null;
                    for (const k of candidates){ if (grid[k]) { s = grid[k]; break; } }
                    if (s && s.actual !== undefined && s.actual !== null && !isNaN(Number(s.actual))) return Number(s.actual);
                    if (s && s.bookBalance !== undefined && !isNaN(Number(s.bookBalance))) return Number(s.bookBalance);
                    const opening = Number(s && s.opening)||0, inbound = Number(s && s.inbound)||0, usage = Number(s && s.usage)||0;
                    return opening + inbound - usage;
                };
                const getPriceVal = (item) => Number(item.avgCost) || Number(item.price) || Number(item.cost) || 0;

                const addToBatch = (items, type) => {
                    if (!Array.isArray(items)) return;
                    items.forEach(item => {
                        const name = String(item.name||'').trim(); if (!name) return;
                        const docId = sanitizeId(item.id || item.code || item.name);
                        const ref = db.collection('inventory_items').doc(docId);
                        let stock = 0;
                        if (type === 'raw') stock = getRawStock(name);
                        else if (type === 'packing') stock = getPackStock(name);
                        else if (type === 'finished') stock = getFinishedStock(item);
                        const priceVal = getPriceVal(item);
                        const payload = {
                            id: item.id || docId,
                            name: name,
                            unit: item.unit || '',
                            type,
                            stock: Number(stock)||0,
                            avgCost: Number(priceVal)||0,
                            price: Number(priceVal)||0,
                            updatedAt: nowTs
                        };
                        batch.set(ref, payload, { merge: true });
                    });
                };

                addToBatch(window.costRaw, 'raw');
                addToBatch(window.costPack, 'packing');
                addToBatch(window.costFinished, 'finished');

                await batch.commit();
                console.log('? ?? ??? ?????? ???????? ?? ??????? (inventory_items)');
                try { window.updateTotalValue && window.updateTotalValue(); } catch(_){}
                return true;
            } catch(e){ console.warn('normalizeInventoryNow failed', e); return false; }
        };

        // ========== EDIT ITEM PRICE (Simple Prompt + Cloud Save) ==========
        window.editItemPrice = async function(itemName) {
            try {
                // 1. Find the item in any of the arrays
                let item = null;
                let category = '';
                
                if (window.costRaw && Array.isArray(window.costRaw)) {
                    item = window.costRaw.find(i => i && i.name === itemName);
                    if (item) category = 'raw';
                }
                
                if (!item && window.costPack && Array.isArray(window.costPack)) {
                    item = window.costPack.find(i => i && i.name === itemName);
                    if (item) category = 'packing';
                }
                
                if (!item && window.costFinished && Array.isArray(window.costFinished)) {
                    item = window.costFinished.find(i => i && i.name === itemName);
                    if (item) category = 'finished';
                }
                
                if (!item) {
                    return alert("? ????? ??? ?????");
                }

                // 2. Show prompt for new price
                const currentPrice = item.avgCost || item.price || item.cost || 0;
                const newPrice = prompt(
                    `????? ???: ${itemName}\n\n????? ??????: ${currentPrice} ?.?`,
                    currentPrice
                );
                
                if (newPrice === null) return; // User cancelled
                
                const priceVal = Number(newPrice);
                if (isNaN(priceVal) || priceVal < 0) {
                    return alert("? ????? ????? ???!");
                }

                // 3. Update Cloud immediately
                if (window.db && navigator.onLine) {
                    try {
                        // Save to inventory_items
                        await db.collection('inventory_items').doc(itemName).set({
                            avgCost: priceVal,
                            price: priceVal,
                            cost: priceVal,
                            updatedAt: serverTs()
                        }, { merge: true });
                        console.log(`? ??? ????? ?? ???????: ${itemName} ? ${priceVal}`);

                        // Update costLists immediately
                        const array = category === 'raw' ? window.costRaw :
                                      category === 'packing' ? window.costPack :
                                      window.costFinished;
                        
                        if (Array.isArray(array)) {
                            const idx = array.findIndex(i => i && i.name === itemName);
                            if (idx >= 0) {
                                array[idx].avgCost = priceVal;
                                array[idx].price = priceVal;
                                array[idx].cost = priceVal;
                            }

                            // Save to costLists
                            const payload = {};
                            if (category === 'raw') {
                                payload.raw = window.costRaw;
                            } else if (category === 'packing') {
                                payload.pack = window.costPack;
                            } else {
                                payload.finished = window.costFinished;
                            }
                            payload.updatedAt = serverTs();

                            await db.collection('settings').doc('costLists').set(payload, { merge: true });
                            console.log(`?? ?? ????? costLists ??????`);
                        }
                    } catch(dbErr) {
                        console.warn('??? ?? ??? ???????:', dbErr.message);
                    }
                }

                // 4. Update local display
                item.avgCost = priceVal;
                item.price = priceVal;
                item.cost = priceVal;
                
                // Save to localStorage
                try {
                    if (category === 'raw') {
                        localStorage.setItem('cost_raw', JSON.stringify(window.costRaw));
                    } else if (category === 'packing') {
                        localStorage.setItem('cost_pack', JSON.stringify(window.costPack));
                    } else {
                        localStorage.setItem('cost_finished', JSON.stringify(window.costFinished));
                    }
                } catch(e) {
                    console.warn('??? ?? ??? localStorage:', e);
                }

                // 5. Refresh UI
                if (typeof window.updateTotalValue === 'function') {
                    setTimeout(() => window.updateTotalValue(), 100);
                }

                // Refresh table if inventory system is open
                if (window.inventorySystem && window.inventorySystem.loadInventoryData) {
                    window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab || 'raw');
                }

                alert(`? ?? ????? ????? ?????:\n${itemName}: ${priceVal} ?.?`);

            } catch(e) {
                console.error('? ??? ?? ????? ?????:', e);
                alert("? ??? ???????: " + e.message);
            }
        };
    </script>

