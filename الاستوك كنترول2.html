<!-- 
    رسالة إلى المطور / الذكاء الاصطناعي (Note to Developer/AI):
    
    1. هذا هو النظام الجديد (V2) المعتمد على Firebase Firestore.
    2. النظام القديم (Legacy) يعتمد على localStorage بالمفاتيح التالية:
       - 'raw_materials_grid' (لخامات)
       - 'packaging_grid' (للتغليف)
       - 'finished_goods_grid' (للمنتج التام)
    
    3. المطلوب عند الدمج:
       - قم بقراءة البيانات من localStorage في الصفحة القديمة.
       - قم بعمل Loop على هذه البيانات.
       - استخدم دالة `app.addProduct()` الموجودة في هذا الملف لرفعهم إلى Firestore.
       - تأكد من توحيد المسميات (raw_material, packaging, finished_goods) لتطابق الـ schema الجديدة.
    
    4. هيكل قاعدة البيانات الجديد (Firestore Schema):
       Collection: artifacts/{appId}/public/data/products
       Document: {
           name: string,
           category: 'raw_material' | 'packaging' | 'finished_goods',
           unit: string,
           currentStock: number,
           avgCost: number,
           createdAt: timestamp
       }
-->

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Control V2 - نظام المخازن السحابي</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        
        /* UI Components */
        .section-view { display: none; animation: fadeIn 0.3s ease-out; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-item { cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; color: #64748b; }
        .nav-item:hover { background-color: #f1f5f9; }
        .nav-item.active { color: #2563eb; background-color: #fff; border-bottom-color: #2563eb; }

        .badge { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .badge.online { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge.offline { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-sm z-50 sticky top-0">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center border-b border-gray-100">
            <div class="flex items-center gap-2">
                <div class="bg-blue-700 text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-md">
                    <i class="fas fa-cubes"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm leading-tight text-gray-800">إدارة المخزون (V2)</h1>
                    <div id="connectionStatus" class="badge offline w-fit mt-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> جاري الاتصال...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <nav class="flex justify-around bg-white pt-1 shadow-sm border-t border-gray-100">
            <button onclick="app.nav('products')" id="nav-products" class="nav-item active flex-1 py-3 flex flex-col items-center gap-1">
                <i class="fas fa-boxes-stacked text-lg"></i> <span class="text-[10px] font-bold">الأصناف</span>
            </button>
            <button onclick="app.nav('movements')" id="nav-movements" class="nav-item flex-1 py-3 flex flex-col items-center gap-1">
                <i class="fas fa-exchange-alt text-lg"></i> <span class="text-[10px] font-bold">الحركة</span>
            </button>
            <button onclick="app.nav('stocktake')" id="nav-stocktake" class="nav-item flex-1 py-3 flex flex-col items-center gap-1">
                <i class="fas fa-clipboard-check text-lg"></i> <span class="text-[10px] font-bold">الجرد</span>
            </button>
            <button onclick="app.nav('reports')" id="nav-reports" class="nav-item flex-1 py-3 flex flex-col items-center gap-1">
                <i class="fas fa-history text-lg"></i> <span class="text-[10px] font-bold">السجلات</span>
            </button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 overflow-y-auto pb-24">

        <!-- 1. Products View -->
        <section id="view-products" class="section-view active">
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="app.filterProd('all')" class="filter-chip active bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow">الكل</button>
                    <button onclick="app.filterProd('raw_material')" class="filter-chip bg-white border text-gray-600 px-3 py-1 rounded text-xs font-bold">خامات</button>
                    <button onclick="app.filterProd('packaging')" class="filter-chip bg-white border text-gray-600 px-3 py-1 rounded text-xs font-bold">تغليف</button>
                    <button onclick="app.filterProd('finished_goods')" class="filter-chip bg-white border text-gray-600 px-3 py-1 rounded text-xs font-bold">تام</button>
                </div>
                <button onclick="app.toggleModal('productModal')" class="bg-gray-800 text-white w-8 h-8 rounded-lg flex items-center justify-center hover:bg-black transition shadow">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-center">
                <div class="bg-gray-100 p-5 rounded-full mb-3"><i class="fas fa-box-open text-4xl text-gray-400"></i></div>
                <h3 class="text-gray-800 font-bold">المخزن فارغ</h3>
                <p class="text-xs text-gray-500 mb-4">قاعدة البيانات جاهزة لاستقبال الأصناف</p>
                <button onclick="app.toggleModal('productModal')" class="bg-blue-600 text-white px-6 py-2 rounded shadow text-sm font-bold">إضافة صنف يدوياً</button>
            </div>

            <!-- Table -->
            <div id="tableContainer" class="bg-white rounded-lg shadow-sm border overflow-hidden hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-gray-50 text-[10px] text-gray-500 uppercase border-b">
                            <tr>
                                <th class="p-3">اسم الصنف</th>
                                <th class="p-3 text-center">الرصيد</th>
                                <th class="p-3 text-center">التكلفة</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody" class="divide-y text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 2. Movements View -->
        <section id="view-movements" class="section-view">
            <div class="max-w-md mx-auto bg-white rounded-lg shadow border overflow-hidden">
                <div class="bg-slate-800 p-3 text-white flex justify-between items-center">
                    <h2 class="font-bold text-sm">تسجيل إذن حركة</h2>
                    <span id="transBadge" class="bg-green-500 text-[10px] px-2 py-0.5 rounded font-bold">وارد</span>
                </div>
                
                <div class="p-4">
                    <div class="flex gap-2 mb-4">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="mtype" value="inbound" checked class="hidden peer" onchange="app.toggleTrans()">
                            <div class="p-2 border rounded bg-gray-50 text-center text-xs font-bold peer-checked:bg-green-100 peer-checked:border-green-500 peer-checked:text-green-800 transition">
                                <i class="fas fa-arrow-down"></i> شراء / وارد
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="mtype" value="outbound" class="hidden peer" onchange="app.toggleTrans()">
                            <div class="p-2 border rounded bg-gray-50 text-center text-xs font-bold peer-checked:bg-red-100 peer-checked:border-red-500 peer-checked:text-red-800 transition">
                                <i class="fas fa-arrow-up"></i> صرف / بيع
                            </div>
                        </label>
                    </div>

                    <form onsubmit="app.saveTrans(event)">
                        <div id="inboundFields" class="mb-3">
                            <label class="text-[10px] font-bold text-gray-500 block mb-1">المورد</label>
                            <select id="supplierSelect" class="w-full border rounded p-2 text-sm bg-gray-50 outline-none focus:border-blue-500"></select>
                        </div>
                        <div id="outboundFields" class="hidden mb-3">
                            <label class="text-[10px] font-bold text-gray-500 block mb-1">يصرف إلى</label>
                            <select id="destSelect" class="w-full border rounded p-2 text-sm bg-red-50 font-bold outline-none focus:border-red-500">
                                <option>مصنع الجبن</option>
                                <option>مصنع الزبادي</option>
                                <option>مصنع السمنة</option>
                                <option>مندوب مبيعات</option>
                                <option>هالك / تالف</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="text-[10px] font-bold text-gray-500 block mb-1">الصنف</label>
                            <select id="prodSelect" class="w-full border rounded p-2 text-sm bg-white outline-none" required onchange="app.updateHint()"></select>
                            <div id="stockHint" class="text-[10px] text-blue-600 font-bold mt-1 h-4 px-1"></div>
                        </div>

                        <div class="flex gap-2 mb-4">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-gray-500 block mb-1">الكمية</label>
                                <input type="number" id="qty" step="0.01" min="0.01" required class="w-full border rounded p-2 text-center font-bold text-lg outline-none">
                            </div>
                            <div class="flex-1" id="priceDiv">
                                <label class="text-[10px] font-bold text-green-600 block mb-1">السعر</label>
                                <input type="number" id="price" step="0.01" class="w-full border border-green-300 bg-green-50 rounded p-2 text-center font-bold outline-none" placeholder="ج.م">
                            </div>
                        </div>

                        <button id="transBtn" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold shadow hover:bg-black transition">حفظ الحركة</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- 3. Stocktake View -->
        <section id="view-stocktake" class="section-view">
            <div class="bg-white rounded-lg shadow border overflow-hidden">
                <div class="p-3 bg-gray-50 border-b flex justify-between items-center sticky top-0 z-10">
                    <h2 class="font-bold text-sm text-gray-700">جرد المخزن</h2>
                    <div class="flex gap-1">
                        <button onclick="app.filterStock('finished_goods')" class="st-filter active text-[10px] px-2 py-1 rounded bg-blue-600 text-white">تام</button>
                        <button onclick="app.filterStock('raw_material')" class="st-filter text-[10px] px-2 py-1 rounded border bg-white text-gray-500">خام</button>
                        <button onclick="app.filterStock('packaging')" class="st-filter text-[10px] px-2 py-1 rounded border bg-white text-gray-500">تغليف</button>
                    </div>
                </div>
                <div class="max-h-[60vh] overflow-y-auto">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100 text-[10px] uppercase text-gray-500">
                            <tr>
                                <th class="p-2">الصنف</th>
                                <th class="p-2 text-center w-16">نظام</th>
                                <th class="p-2 text-center w-20">فعلي</th>
                                <th class="p-2 text-center w-12">فرق</th>
                            </tr>
                        </thead>
                        <tbody id="stockBody" class="text-xs font-bold divide-y"></tbody>
                    </table>
                </div>
                <div class="p-3 border-t bg-gray-50">
                    <button onclick="app.submitStock()" class="w-full bg-green-600 text-white py-2 rounded font-bold shadow hover:bg-green-700 transition text-sm">
                        اعتماد الجرد
                    </button>
                </div>
            </div>
        </section>

        <!-- 4. Reports View -->
        <section id="view-reports" class="section-view">
            <div class="bg-white rounded-lg shadow border overflow-hidden">
                <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-sm text-gray-700">سجل العمليات</h2>
                    <button onclick="app.loadLogs()" class="text-xs bg-white border px-2 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="max-h-[70vh] overflow-y-auto">
                    <table class="w-full text-right text-xs">
                        <thead class="bg-gray-100 text-gray-500 border-b">
                            <tr>
                                <th class="p-3 whitespace-nowrap">الوقت</th>
                                <th class="p-3 whitespace-nowrap">الحركة</th>
                                <th class="p-3 whitespace-nowrap">الصنف</th>
                                <th class="p-3 whitespace-nowrap">الكمية</th>
                                <th class="p-3 whitespace-nowrap">الجهة</th>
                            </tr>
                        </thead>
                        <tbody id="logsBody" class="divide-y">
                            <tr><td colspan="5" class="p-4 text-center text-gray-400">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal -->
    <div id="productModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-[100] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-11/12 max-w-sm rounded-lg shadow-xl p-5">
            <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">إضافة صنف جديد</h3>
            <form onsubmit="app.addProduct(event)">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">اسم الصنف</label>
                        <input id="newProdName" class="w-full border rounded p-2 text-sm focus:border-blue-500 outline-none" required placeholder="مثال: لبن خام">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">القسم</label>
                        <select id="newProdCat" class="w-full border rounded p-2 text-sm bg-white">
                            <option value="raw_material">خامات</option>
                            <option value="finished_goods">منتج تام</option>
                            <option value="packaging">تغليف</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">الوحدة</label>
                        <select id="newProdUnit" class="w-full border rounded p-2 text-sm bg-white">
                            <option value="كجم">كجم</option>
                            <option value="طن">طن</option>
                            <option value="قطعة">قطعة</option>
                            <option value="كرتونة">كرتونة</option>
                            <option value="شكارة">شكارة</option>
                            <option value="لتر">لتر</option>
                            <option value="رول">رول</option>
                            <option value="صفيحة">صفيحة</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-5">
                    <button type="button" onclick="app.toggleModal('productModal')" class="text-gray-500 text-sm font-bold px-3 py-2 hover:bg-gray-100 rounded">إلغاء</button>
                    <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded text-sm font-bold hover:bg-blue-700">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, runTransaction, writeBatch, onSnapshot, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Config - Auto Injected from parent app
        const appId = window.__app_id || window.state?.appId || '1:646706509650:web:1eaa4b94d2990b6be9ac8b';
        let db, auth, products = [];

        window.app = {
            async init() {
                try {
                    // Use parent app's Firebase instance if available
                    if (window.db && window.auth) {
                        db = window.db;
                        auth = window.auth;
                        console.log('✅ Using parent app Firebase instance');
                    } else {
                        // Fallback to independent initialization
                        const config = JSON.parse(window.__firebase_config || '{}');
                        const app = initializeApp(config);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        
                        const token = window.__initial_auth_token;
                        if (token) await signInWithCustomToken(auth, token);
                        else await signInAnonymously(auth);
                        console.log('⚠️ Using independent Firebase instance');
                    }

                    onAuthStateChanged(auth, user => {
                        const badge = document.getElementById('connectionStatus');
                        if (user) {
                            badge.className = "badge online w-fit mt-1";
                            badge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-600"></span> متصل';
                            this.startListeners();
                            this.loadLogs();
                        } else {
                            badge.className = "badge offline w-fit mt-1";
                            badge.innerHTML = 'غير متصل';
                        }
                    });
                } catch (err) { console.error(err); }
            },

            startListeners() {
                const ref = collection(db, 'products');
                onSnapshot(ref, (snapshot) => {
                    products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    products.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                    
                    if (products.length === 0) {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('tableContainer').classList.add('hidden');
                    } else {
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('tableContainer').classList.remove('hidden');
                        this.renderProducts();
                        this.updateDropdowns();
                        if(document.getElementById('view-stocktake').style.display !== 'none') this.renderStock();
                    }
                });
            },

            async addProduct(e) {
                e.preventDefault();
                const name = document.getElementById('newProdName').value;
                const cat = document.getElementById('newProdCat').value;
                const unit = document.getElementById('newProdUnit').value;
                try {
                    await addDoc(collection(db, 'products'), {
                        name, category: cat, unit, currentStock: 0, avgCost: 0, createdAt: serverTimestamp()
                    });
                    alert("تمت الإضافة"); this.toggleModal('productModal'); e.target.reset();
                } catch (err) { alert("خطأ: " + err.message); }
            },

            filterProd(cat) {
                this.currentProdFilter = cat;
                document.querySelectorAll('.filter-chip').forEach(btn => {
                    btn.className = btn.getAttribute('onclick').includes(cat) 
                        ? "filter-chip active bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow" 
                        : "filter-chip bg-white border text-gray-600 px-3 py-1 rounded text-xs font-bold";
                });
                this.renderProducts();
            },

            renderProducts() {
                const tbody = document.getElementById('productsBody');
                tbody.innerHTML = '';
                const filter = this.currentProdFilter || 'all';
                const list = products.filter(p => filter === 'all' || p.category === filter);
                
                list.forEach(p => {
                    const row = `
                        <tr class="hover:bg-blue-50 border-b last:border-0">
                            <td class="p-3 font-bold text-gray-700">${p.name} <span class="block text-[10px] text-gray-400 font-normal">${this.getCatName(p.category)}</span></td>
                            <td class="p-3 text-center dir-ltr font-mono text-gray-600 font-bold">${this.formatNum(p.currentStock)} ${p.unit}</td>
                            <td class="p-3 text-center text-blue-600 font-mono text-xs bg-yellow-50/50">${this.formatNum(p.avgCost)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            },

            async saveTrans(e) {
                e.preventDefault();
                const btn = document.getElementById('transBtn'); btn.disabled = true; btn.innerText = "جاري الحفظ...";
                const type = document.querySelector('input[name="mtype"]:checked').value;
                const pid = document.getElementById('prodSelect').value;
                const qty = parseFloat(document.getElementById('qty').value);
                const price = parseFloat(document.getElementById('price').value) || 0;

                try {
                    await runTransaction(db, async (t) => {
                        const ref = doc(db, 'products', pid);
                        const s = await t.get(ref);
                        if (!s.exists()) throw "Error";
                        const p = s.data();
                        let ns = p.currentStock || 0, nc = p.avgCost || 0, party = "";

                        if (type === 'inbound') {
                            const ov = ns * nc, nv = qty * price;
                            ns += qty; if(ns>0) nc = (ov + nv) / ns;
                            party = document.getElementById('supplierSelect').value;
                        } else {
                            if (ns < qty) throw "الرصيد لا يكفي";
                            ns -= qty; party = document.getElementById('destSelect').value;
                        }
                        t.update(ref, { currentStock: ns, avgCost: nc });
                        t.set(doc(collection(db, 'transactions')), {
                            date: serverTimestamp(), type, productId: pid, prodName: p.name, qty, party, stockAfter: ns
                        });
                    });
                    alert("تم الحفظ"); e.target.reset(); this.toggleTrans();
                } catch (err) { alert("خطأ: " + err); } 
                finally { btn.disabled = false; btn.innerText = "حفظ الحركة"; }
            },

            filterStock(cat) {
                this.stockCategory = cat;
                document.querySelectorAll('.st-filter').forEach(btn => {
                    btn.className = btn.getAttribute('onclick').includes(cat) 
                        ? "st-filter active text-[10px] px-2 py-1 rounded bg-blue-600 text-white" 
                        : "st-filter text-[10px] px-2 py-1 rounded border bg-white text-gray-500";
                });
                this.renderStock();
            },

            renderStock() {
                const tbody = document.getElementById('stockBody'); tbody.innerHTML = '';
                const cat = this.stockCategory || 'finished_goods';
                products.filter(p => p.category === cat).forEach(p => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2 text-[11px] font-bold text-gray-700">${p.name}</td>
                            <td class="p-2 text-center text-[10px] text-gray-400 font-mono">${this.formatNum(p.currentStock)}</td>
                            <td class="p-2 text-center"><input type="number" step="0.01" class="w-16 border rounded text-center p-1 text-xs outline-none focus:border-blue-500 st-inp" data-pid="${p.id}" data-sys="${p.currentStock}" oninput="app.calcDiff(this)"></td>
                            <td class="p-2 text-center text-[10px] font-bold text-gray-300 diff-cell">-</td>
                        </tr>
                    `;
                });
            },

            calcDiff(input) {
                const sys = parseFloat(input.dataset.sys);
                const actual = parseFloat(input.value);
                const cell = input.closest('tr').querySelector('.diff-cell');
                if (isNaN(actual)) { cell.innerText = '-'; return; }
                const diff = actual - sys;
                cell.innerText = diff > 0 ? `+${this.formatNum(diff)}` : this.formatNum(diff);
                cell.className = `diff-cell p-2 text-center text-[10px] font-bold ${diff < 0 ? 'text-red-600' : (diff > 0 ? 'text-green-600' : 'text-gray-400')}`;
            },

            async submitStock() {
                const inputs = document.querySelectorAll('.st-inp');
                const batch = writeBatch(db);
                let count = 0;
                inputs.forEach(inp => {
                    if (inp.value !== "") {
                        const pid = inp.dataset.pid, actual = parseFloat(inp.value), sys = parseFloat(inp.dataset.sys);
                        if (actual !== sys) {
                            batch.update(doc(db, 'products', pid), { currentStock: actual });
                            batch.set(doc(collection(db, 'transactions')), {
                                date: serverTimestamp(), type: 'adjustment', productId: pid, prodName: 'تسوية جرد', qty: actual - sys, party: 'جرد دوري'
                            });
                            count++;
                        }
                    }
                });
                if (count > 0 && confirm(`اعتماد ${count} أصناف؟`)) {
                    try { await batch.commit(); alert("تم الترحيل"); inputs.forEach(i=>i.value=''); this.renderStock(); } catch (e) { alert(e.message); }
                } else alert("لا توجد تغييرات");
            },

            loadLogs() {
                const tbody = document.getElementById('logsBody');
                const q = query(collection(db, 'transactions'), orderBy('date', 'desc'), limit(50));
                onSnapshot(q, (snap) => {
                    tbody.innerHTML = '';
                    if (snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400 text-xs">لا توجد حركات</td></tr>'; return; }
                    snap.forEach(doc => {
                        const d = doc.data();
                        const date = d.date ? d.date.toDate().toLocaleDateString('ar-EG') : '-';
                        const type = d.type === 'inbound' ? 'وارد' : (d.type === 'outbound' ? 'صادر' : 'تسوية');
                        const color = d.type === 'inbound' ? 'text-green-600' : (d.type === 'outbound' ? 'text-red-600' : 'text-gray-600');
                        tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="p-3 text-gray-500 dir-ltr font-mono text-[10px]">${date}</td><td class="p-3 text-[10px] font-bold ${color}">${type}</td><td class="p-3 font-bold text-gray-700">${d.prodName || '-'}</td><td class="p-3 font-mono dir-ltr font-bold text-xs">${d.qty}</td><td class="p-3 text-xs text-gray-500">${d.party || '-'}</td></tr>`;
                    });
                }, err => console.log(err));
            },

            nav(id) {
                document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-' + id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('nav-' + id).classList.add('active');
                if(id === 'stocktake') this.renderStock();
            },
            
            toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); },
            toggleTrans() {
                const t = document.querySelector('input[name="mtype"]:checked').value;
                document.getElementById('inboundFields').style.display = t === 'inbound' ? 'block' : 'none';
                document.getElementById('outboundFields').style.display = t === 'outbound' ? 'block' : 'none';
                document.getElementById('priceDiv').style.visibility = t === 'inbound' ? 'visible' : 'hidden';
                const b = document.getElementById('transBadge');
                b.innerText = t === 'inbound' ? 'وارد' : 'صادر';
                b.className = t === 'inbound' ? 'bg-green-500 text-[10px] px-2 py-0.5 rounded font-bold text-white' : 'bg-red-500 text-[10px] px-2 py-0.5 rounded font-bold text-white';
            },
            
            updateDropdowns() {
                const sel = document.getElementById('prodSelect'); sel.innerHTML = '<option value="">اختر...</option>';
                products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
                const sup = document.getElementById('supplierSelect');
                if (sup.children.length === 0) ["مزارع الوادي", "مورد الملح", "شركة التغليف"].forEach(s => sup.innerHTML += `<option>${s}</option>`);
            },
            
            updateHint() {
                const p = products.find(x => x.id === document.getElementById('prodSelect').value);
                document.getElementById('stockHint').innerText = p ? `رصيد: ${p.currentStock} ${p.unit}` : '';
            },
            getCatName(c) { return c === 'raw_material' ? 'خامات' : (c === 'packaging' ? 'تغليف' : 'منتج تام'); },
            formatNum(n) { return parseFloat((n || 0).toFixed(2)); }
        };

        window.app.init();
    </script>
</body>
</html>