rules_version = '2';
service cloud.firestore {
	match /databases/{database}/documents {
		// Basic helpers
		function authed() { return request.auth != null; }
		function role() {
			return exists(/databases/$(database)/documents/roles/$(request.auth.uid))
				? get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role
				: (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role);
		}
		function isAdmin() { return authed() && role() == 'admin'; }
		function isRep()   { return authed() && role() == 'rep'; }
		function isSales() { return authed() && role() == 'sales'; }
		function isReviewer(){ return authed() && role() == 'reviewer'; }

		// users: owner may create/update their own doc (but not change 'role'); admins can write everything
		match /users/{uid} {
			allow read: if authed();
			allow create: if authed() && request.auth.uid == uid;
			allow update: if authed() && request.auth.uid == uid && !(request.resource.data.keys().hasAny(['role']));
			allow write: if isAdmin();
		}

		match /roles/{uid} {
			allow read: if authed();
			allow write: if isAdmin();
		}

		// Public collections: read for authenticated users, write reserved for admins
		match /products/{id}        { allow read: if authed(); allow write: if isAdmin(); }
		match /reps/{id}            { allow read: if authed(); allow write: if isAdmin(); }
		match /priceLists/{id}      { allow read: if authed(); allow write: if isAdmin(); }
		match /promotions/{id}      { allow read: if authed(); allow write: if isAdmin(); }
		match /dispatchNotes/{id}   { allow read: if authed(); allow write: if isAdmin(); }
		match /openingBalances/{id} { allow read: if authed(); allow write: if isAdmin(); }
		match /settings/{docId}     { allow read: if authed(); allow write: if isAdmin(); }

		// customers: list allowed, per-doc ops guarded by role/assignedRepId
		match /customers/{cid} {
			allow list: if authed();
			allow get: if isAdmin() || isReviewer() || isSales() || (isRep() && (
				!('assignedRepId' in resource.data) || resource.data.assignedRepId == '' || resource.data.assignedRepId == request.auth.uid
			));
			allow create: if isAdmin() || (isRep() && (
				!('assignedRepId' in request.resource.data) || request.resource.data.assignedRepId == '' || request.resource.data.assignedRepId == request.auth.uid
			));
			allow update: if isAdmin() || (isRep() && (
				(resource.data.assignedRepId == request.auth.uid && request.resource.data.assignedRepId == request.auth.uid) ||
				((!('assignedRepId' in resource.data) || resource.data.assignedRepId == '') && request.resource.data.assignedRepId == request.auth.uid)
			));
			allow delete: if isAdmin();
		}

		// sales: read for auth users; creation allowed for reps/sales/admin; updates/deletes admin only
		match /sales/{sid} {
			allow read: if authed();
			allow create: if isAdmin() || isRep() || isSales();
			allow update, delete: if isAdmin();
		}

		// presence: users may write their own presence (not reviewers); admins may delete
		match /presence/{uid} {
			allow read: if authed();
			allow create, update: if authed() && request.auth.uid == uid && !isReviewer();
			allow delete: if isAdmin();
		}

		// Fallback: authenticated reads allowed across other top-level collections; writes denied by default
		match /{collection}/{docId} {
			allow read: if authed();
			allow write: if false;
		}
	}
}
