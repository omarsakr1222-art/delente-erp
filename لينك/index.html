<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق ديلينت لإدارة المبيعات</title>
    <script>
                // ساعة رقمية في الهيدر تظهر في كل الصفحات
                function updateGlobalClock() {
                    const clockEl = document.getElementById('global-clock-time');
                    if (!clockEl) return;
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const dateStr = now.toLocaleDateString('ar-EG');
                    clockEl.textContent = `${dateStr} - ${timeStr}`;
                }
                setInterval(updateGlobalClock, 1000);
                document.addEventListener('DOMContentLoaded', updateGlobalClock);
        // إظهار صفحة الـ Dashboard كافتراضي عند التحميل
        window.addEventListener('load', function() {
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
            }
            var dashboard = document.getElementById('page-dashboard');
            if (dashboard) dashboard.classList.add('active');
            var navItems = document.getElementsByClassName('bottom-nav-item');
            for (var j = 0; j < navItems.length; j++) {
                navItems[j].classList.remove('active');
                if (navItems[j].getAttribute('data-page') === 'dashboard') {
                    navItems[j].classList.add('active');
                }
            }
        });
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Note: Using the Tailwind CDN is fine for development only. For production install Tailwind as a PostCSS plugin
         or use the Tailwind CLI per https://tailwindcss.com/docs/installation -->
    <script>
        // Safe fallback for updateIcons to avoid ReferenceError if other scripts call it before icon library loads.
        // If you use Lucide or a similar icon replacer, it will call its replace/scan method when available.
        window.updateIcons = (function(){
            let scheduled = false;
            return function(){
                if (scheduled) return; // debounce rapid calls
                scheduled = true;
                requestAnimationFrame(() => {
                    try {
                        if (window.lucide && typeof window.lucide.replace === 'function') {
                            window.lucide.replace();
                        } else if (window.Lucide && typeof window.Lucide.replace === 'function') {
                            window.Lucide.replace();
                        }
                    } catch(e) { /* silent */ }
                    scheduled = false;
                });
            };
        })();
    </script>
    <script>
        // Global safe guards to prevent early crashes
        // ===== Render Scheduler (performance) =====
        (function(){
            const scheduled = new Map();
            const lastRun = new Map();
            const MIN_INTERVAL = 80; // ms between same-key renders
            function runTask(key, fn){
                scheduled.delete(key);
                try {
                    const start = performance.now();
                    fn();
                    lastRun.set(key, start);
                } catch(e){ console.warn('render task failed', key, e); }
            }
            window.scheduleRender = function(key, fn){
                try {
                    if (typeof key !== 'string') key = 'anon';
                    const now = performance.now();
                    const prev = lastRun.get(key) || 0;
                    if (scheduled.has(key)) return; // already queued
                    if ((now - prev) < MIN_INTERVAL) { // defer a bit more to batch
                        const handle = setTimeout(()=>{ scheduled.delete(key); window.requestIdleCallback ? requestIdleCallback(()=>runTask(key, fn), { timeout: 300 }) : requestAnimationFrame(()=>runTask(key, fn)); }, MIN_INTERVAL);
                        scheduled.set(key, handle);
                        return;
                    }
                    const handle = window.requestIdleCallback ? requestIdleCallback(()=>runTask(key, fn), { timeout: 300 }) : requestAnimationFrame(()=>runTask(key, fn));
                    scheduled.set(key, handle);
                } catch(e){ try { fn(); } catch(_){} }
            };
        })();
        (function(){
            try { window.state = window.state || {}; } catch(e) { window.state = {}; }
            if (typeof window.formatCurrency !== 'function') {
                window.formatCurrency = function(n){ try { return new Intl.NumberFormat('ar-EG',{style:'currency',currency:'EGP',maximumFractionDigits:2}).format(Number(n||0)); } catch(e){ return (Number(n||0)).toFixed(2)+' ج.م'; } };
            }
            if (typeof window.findCustomer !== 'function') {
                window.findCustomer = function(id){ try { return (state.customers||[]).find(c => (c.id||c._id) === id) || null; } catch(e){ return null; } };
            }
            if (typeof window.updateCustomerList !== 'function') {
                window.updateCustomerList = function(){ /* noop safety */ };
            }
            if (typeof window.DEFAULT_PRODUCTS === 'undefined') {
                window.DEFAULT_PRODUCTS = [];
            }
            // Default company logo URL (used when no custom URL is saved)
            if (typeof window.DEFAULT_COMPANY_LOGO_URL === 'undefined') {
                window.DEFAULT_COMPANY_LOGO_URL = 'https://i.ibb.co/YT4114YW/image.jpg';
            }
        })();
    </script>
    <!-- Library to convert HTML to Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- NEW: Include Chart.js library for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Lucide Icons (before other scripts) -->

    <!-- Global error overlay to surface runtime issues to the user -->
    <script>
        (function(){
            function showOverlay(msg, stack){
                try {
                    var ov = document.getElementById('error-overlay');
                    if (!ov) {
                        ov = document.createElement('div');
                        ov.id = 'error-overlay';
                        ov.style.position = 'fixed';
                        ov.style.top = '0';
                        ov.style.left = '0';
                        ov.style.right = '0';
                        ov.style.zIndex = '99999';
                        ov.style.background = 'rgba(220,38,38,0.95)';
                        ov.style.color = '#fff';
                        ov.style.fontFamily = 'Cairo, sans-serif';
                        ov.style.direction = 'rtl';
                        ov.style.padding = '8px 12px';
                        ov.style.fontSize = '12px';
                        ov.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">'
                                     + '<div><strong>حدث خطأ في التطبيق:</strong> <span id="err-msg"></span><div id="err-stack" style="white-space:pre-wrap;opacity:.9;margin-top:4px"></div></div>'
                                     + '<button id="err-close" style="background:#111;border:0;color:#fff;padding:6px 10px;border-radius:6px">إغلاق</button>'
                                     + '</div>';
                        document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(ov); });
                        if (document.readyState === 'complete' || document.readyState === 'interactive') { try { document.body.appendChild(ov); } catch(_){} }
                        document.addEventListener('click', function(e){ if (e.target && e.target.id === 'err-close'){ try { ov.remove(); } catch(_){} } });
                    }
                    var m = ov.querySelector('#err-msg'); if (m) m.textContent = msg || '';
                    var s = ov.querySelector('#err-stack'); if (s) s.textContent = stack || '';
                } catch(e){}
            }
            window.addEventListener('error', function(e){
                try {
                    var msg = (e && (e.message || e.error && e.error.message)) || 'خطأ غير معروف';
                    var stack = (e && e.error && e.error.stack) || '';
                    showOverlay(msg, stack);
                } catch(_){}
            });
            window.addEventListener('unhandledrejection', function(e){
                try {
                    var reason = e && e.reason; var msg = '';
                    if (typeof reason === 'string') msg = reason; else if (reason && reason.message) msg = reason.message; else msg = 'Unhandled rejection';
                    var stack = reason && reason.stack ? reason.stack : '';
                    showOverlay(msg, stack);
                } catch(_){}
            });
        })();
    </script>

    <!-- Leaflet for interactive maps (CDN) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

        <!-- تم إلغاء الاعتماد على الحالة المشتركة القديمة (shared/public_app_state) نهائياً -->

        <!-- Firebase SDK (compat build for simple global usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

        <!-- Firebase Config injected from user-provided settings (modular snippet adapted) -->
        <script>
            window.FIREBASE_CONFIG = {
                apiKey: "AIzaSyDLmZPE9teCYf2rMXd1AwT5yq4xlRSHcSk",
                authDomain: "delente-business.firebaseapp.com",
                projectId: "delente-business",
                // ✅ تصحيح اسم حاوية التخزين: الشكل الصحيح يكون <project-id>.appspot.com
                // القيمة السابقة "delente-business.firebasestorage.app" تسبب أخطاء CORS ورفض طلبات التحميل
                storageBucket: "delente-business.appspot.com",
                messagingSenderId: "646706509650",
                appId: "1:646706509650:web:1eaa4b94d2990b6be9ac8b"
            };
        </script>

    <!-- Firebase Configuration & Authentication System -->
    <script>
        // نظام إدارة المستخدمين والمصادقة مع Firebase
        // (Firebase Config موجود في نهاية الملف - DOMContentLoaded)
        const AuthSystem = {
            // مفتاح تخزين بيانات المستخدمين
            USERS_KEY: 'app_users',
            CURRENT_USER_KEY: 'app_current_user',
            
            // الحصول على جميع المستخدمين المسجلين
            getAllUsers() {
                try {
                    const data = localStorage.getItem(this.USERS_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.warn('Error loading users:', e);
                    return [];
                }
            },
            
            // حفظ قائمة المستخدمين
            saveUsers(users) {
                try {
                    localStorage.setItem(this.USERS_KEY, JSON.stringify(users));
                } catch (e) {
                    console.error('Error saving users:', e);
                }
            },
            
            // البحث عن مستخدم بالبريد الإلكتروني
            findUserByEmail(email) {
                const users = this.getAllUsers();
                return users.find(u => u.email === email.toLowerCase());
            },
            
            // التسجيل (إنشاء حساب جديد)
            async register(email, password, name) {
                if (!window.auth) return { success: false, message: 'Firebase Auth غير جاهز' };
                try {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    try { await cred.user.updateProfile({ displayName: name }); } catch(e) {}
                    try {
                        if (window.db) {
                            await db.collection('users').doc(cred.user.uid).set({
                                email: email.toLowerCase(),
                                name: name,
                                createdAt: new Date().toISOString()
                            }, { merge: true });
                        }
                    } catch(e) { console.warn('تحذير: فشل حفظ وثيقة المستخدم في Firestore', e); }
                    const newUser = { id: cred.user.uid, email: email.toLowerCase(), name, firebase: true, createdAt: new Date().toISOString(), data: {} };
                    this.setCurrentUser(newUser);
                    return { success: true, message: 'تم إنشاء الحساب بنجاح', user: newUser };
                } catch (err) {
                    let msg = 'فشل إنشاء الحساب';
                    if (err.code === 'auth/email-already-in-use') msg = 'البريد مستخدم بالفعل';
                    else if (err.code === 'auth/weak-password') msg = 'كلمة المرور ضعيفة';
                    else if (err.code === 'auth/invalid-email') msg = 'البريد غير صالح';
                    return { success: false, message: msg };
                }
            },
            
            // تسجيل الدخول
            async login(email, password) {
                if (!window.auth) return { success: false, message: 'Firebase Auth غير جاهز' };
                try {
                    const cred = await auth.signInWithEmailAndPassword(email, password);
                    const displayName = cred.user.displayName || (cred.user.email ? cred.user.email.split('@')[0] : 'مستخدم');
                    const currentUser = { id: cred.user.uid, email: cred.user.email.toLowerCase(), name: displayName, firebase: true, data: {} };
                    this.setCurrentUser(currentUser);
                    return { success: true, message: 'تم الدخول بنجاح', user: currentUser };
                } catch (err) {
                    let msg = 'فشل الدخول';
                    if (err.code === 'auth/wrong-password') msg = 'كلمة المرور غير صحيحة';
                    else if (err.code === 'auth/user-not-found') msg = 'المستخدم غير موجود';
                    else if (err.code === 'auth/invalid-email') msg = 'البريد غير صالح';
                    else if (err.code === 'auth/too-many-requests') msg = 'محاولات كثيرة، انتظر قليلاً';
                    return { success: false, message: msg };
                }
            },
            
            // حفظ المستخدم الحالي
            setCurrentUser(user) {
                try {
                    localStorage.setItem(this.CURRENT_USER_KEY, JSON.stringify(user));
                } catch (e) {
                    console.error('Error saving current user:', e);
                }
            },
            
            // الحصول على المستخدم الحالي
            getCurrentUser() {
                try {
                    const data = localStorage.getItem(this.CURRENT_USER_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.warn('Error loading current user:', e);
                    return null;
                }
            },
            
            // تسجيل الخروج
            logout() {
                try {
                    localStorage.removeItem(this.CURRENT_USER_KEY);
                } catch (e) {
                    console.error('Error logging out:', e);
                }
            },
            
            // تحديث بيانات المستخدم
            updateUserData(userId, newData) {
                const users = this.getAllUsers();
                const user = users.find(u => u.id === userId);
                
                if (!user) return false;
                
                user.data = { ...user.data, ...newData };
                this.saveUsers(users);
                
                // تحديث المستخدم الحالي إن وجد
                const currentUser = this.getCurrentUser();
                if (currentUser && currentUser.id === userId) {
                    this.setCurrentUser(user);
                }
                
                return true;
            }
        };
        // استخراج دور المستخدم من الحاله المشتركة (يحتاج ملف خارجي يحقن userRoles داخل state.shared.public_app_state)
        // قوائم إجبارية مؤقتة للأدوار الأساسية (يمكن لاحقاً نقلها إلى مجموعة users على Firestore)
        window.FORCED_ADMINS = (window.FORCED_ADMINS || [ 'omarsakr1222@gmail.com', 'yousefsakr1222@gmail.com' ]);
        window.FORCED_REVIEWERS = (window.FORCED_REVIEWERS || [
            'yasserhassan1222@gmail.com',
            'belalhatem1222@gmail.com',
            'mohamedhossein1222@gmail.com'
        ]);
        function getUserRole() {
            try {
                const user = AuthSystem.getCurrentUser();
                if (!user) return 'guest';
                // أولوية 1: إجبار الدور لو البريد ضمن FORCED_ADMINS
                if (window.FORCED_ADMINS.includes((user.email||'').toLowerCase())) return 'admin';
                // أولوية 2: مراجِع قراءة فقط
                if (window.FORCED_REVIEWERS.includes((user.email||'').toLowerCase())) return 'reviewer';
                // أولوية 3: من خريطة الأدوار المحملة من مجموعة roles
                if (window.__rolesMap && window.__rolesMap[user.id]) return window.__rolesMap[user.id];
                // أولوية 2: من مجموعة users التي يتم تزامنها لحظياً (المصدر الوحيد الآن)
                if (window.state && Array.isArray(state.users)) {
                    const byId = state.users.find(u => u._id === user.id);
                    if (byId && byId.role) return byId.role;
                    const byEmail = state.users.find(u => (u.email||'').toLowerCase() === (user.email||'').toLowerCase());
                    if (byEmail && byEmail.role) return byEmail.role;
                }
            } catch(e) { /* ignore */ }
            // افتراضي: أي مستخدم مسجل وليس ضمن القوائم الخاصة يُعامل كمندوب
            return 'rep';
        }

        // إضافة بيانات اختبار إذا لم توجد
        document.addEventListener('DOMContentLoaded', () => {
            if (AuthSystem.getAllUsers().length === 0) {
                AuthSystem.register('test@example.com', 'test123', 'مستخدم تجريبي');
            }
        });
    </script>

    <!-- Firebase initialization + sync helpers -->
    <script>
        /**
         * ملاحظة: لمْ أضع هنا أي firebaseConfig مُدمج — احذف النسخة السابقة من الكود.
         * عند إنشاء مشروع Firebase جديد ضع تكوين المشروع في متغير عالمي قبل تحميل هذا الملف،
         * مثلاً في ملف منفصل أو داخل صفحة HTML قبل هذا السكربت:
         *
         * <script> (example) — if you include this inline, escape the closing tag like `<\/script>`
         *   window.firebaseConfig = {
         *     apiKey: "...",
         *     authDomain: "...",
         *     projectId: "...",
         *     storageBucket: "...",
         *     messagingSenderId: "...",
         *     appId: "..."
         *   };
         *
         * هذا يجعل الملف نظيفاً من معلومات مشروعك وسيبقى جاهزاً لتلقي الكونفج الجديد الذي ستوفّره.
         */

        // If you want to embed the config for local use, provide it here.
        // For safety this only assigns when no config already exists on the page.
        try {
            if (!window.firebaseConfig && window.FIREBASE_CONFIG) {
                window.firebaseConfig = window.FIREBASE_CONFIG;
            }
        } catch(e) { /* ignore */ }

        // If you want me to embed the config you pasted, it will be applied
        // below only if no other `window.firebaseConfig` is present.
        if (!window.firebaseConfig) {
            window.firebaseConfig = {
                apiKey: "AIzaSyDLmZPE9teCYf2rMXd1AwT5yq4xlRSHcSk",
                authDomain: "delente-business.firebaseapp.com",
                projectId: "delente-business",
                // ✅ FIX: تغيير اسم الحاوية إلى الشكل القياسي لتفادي أخطاء الوصول
                storageBucket: "delente-business.appspot.com",
                messagingSenderId: "646706509650",
                appId: "1:646706509650:web:1eaa4b94d2990b6be9ac8b"
            };
            // NOTE: This embeds your Firebase config into the local file. It's
            // safe for local use but if this file will be public, consider
            // removing the literal config and instead set `window.FIREBASE_CONFIG`
            // at runtime or restrict your API key in the Firebase console.
        }

        // السماح بالدخول المجهول أثناء التطوير لفتح التطبيق للجميع
        // ملاحظة: أعدها إلى false عند الإطلاق لو أردت منع الضيوف
        window.ALLOW_ANON = true;

        // === Reviewer (Read-Only) helpers ===
        function isReviewer() {
            try { return typeof getUserRole === 'function' && getUserRole() === 'reviewer'; } catch(e){ return false; }
        }
        function notifyReadOnly(message) {
            const msg = message || 'هذا الحساب في وضع المراجعة (قراءة فقط).';
            try { customDialog({ title: 'وضع المراجعة', message: msg }); } catch(e) { try { alert(msg); } catch(_){} }
        }
        function installReviewerReadOnlyGuards() {
            if (!window.db || window.__REVIEWER_GUARDS_INSTALLED) return;
            window.__REVIEWER_GUARDS_INSTALLED = true;
            try {
                const origCollection = db.collection.bind(db);
                const origDoc = db.doc.bind(db);
                const origBatch = db.batch ? db.batch.bind(db) : null;
                const origRunTx = db.runTransaction ? db.runTransaction.bind(db) : null;

                function wrapDocRef(ref){
                    if (!ref || ref.__wrappedReviewer) return ref;
                    const w = Object.create(ref);
                    ['set','update','delete'].forEach(fn => {
                        if (typeof ref[fn] === 'function') {
                            w[fn] = function(){
                                if (isReviewer()) { notifyReadOnly(); return Promise.reject(new Error('read-only: reviewer')); }
                                return ref[fn].apply(ref, arguments);
                            };
                        }
                    });
                    w.__wrappedReviewer = true;
                    return w;
                }

                function wrapCollectionRef(col){
                    if (!col || col.__wrappedReviewer) return col;
                    const w = Object.create(col);
                    if (typeof col.add === 'function') {
                        w.add = function(){
                            if (isReviewer()) { notifyReadOnly(); return Promise.reject(new Error('read-only: reviewer')); }
                            return col.add.apply(col, arguments);
                        };
                    }
                    if (typeof col.doc === 'function') {
                        w.doc = function(){
                            const d = col.doc.apply(col, arguments);
                            return wrapDocRef(d);
                        };
                    }
                    w.__wrappedReviewer = true;
                    return w;
                }

                db.collection = function(path){
                    const col = origCollection(path);
                    return wrapCollectionRef(col);
                };
                db.doc = function(path){
                    const d = origDoc(path);
                    return wrapDocRef(d);
                };
                if (origBatch) {
                    db.batch = function(){
                        const b = origBatch();
                        const wrapper = {
                            set(){ if (isReviewer()) { notifyReadOnly(); return wrapper; } b.set.apply(b, arguments); return wrapper; },
                            update(){ if (isReviewer()) { notifyReadOnly(); return wrapper; } b.update.apply(b, arguments); return wrapper; },
                            delete(){ if (isReviewer()) { notifyReadOnly(); return wrapper; } b.delete.apply(b, arguments); return wrapper; },
                            commit(){ if (isReviewer()) { notifyReadOnly(); return Promise.reject(new Error('read-only: reviewer')); } return b.commit(); }
                        };
                        return wrapper;
                    };
                }
                if (origRunTx) {
                    db.runTransaction = function(updateFn){
                        if (isReviewer()) { notifyReadOnly(); return Promise.reject(new Error('read-only: reviewer')); }
                        return origRunTx(updateFn);
                    };
                }
            } catch(e) { console.warn('Reviewer guards setup failed', e); }
        }
        function applyReviewerModeUI(){
            const badge = document.getElementById('reviewer-badge');
            if (badge) badge.classList.toggle('hidden', !isReviewer());
        }
        function initFirebase() {
            try {
                if (!window.firebase) {
                    console.warn('Firebase SDK not loaded');
                    return false;
                }
                if (window.__FIREBASE_INIT_DONE) return true;
                // initialize using compat SDK (we included -compat scripts)
                // accept either global name (FIREBASE_CONFIG) or legacy firebaseConfig
                var cfg = window.firebaseConfig || window.FIREBASE_CONFIG || null;
                if (!cfg) {
                    console.warn('No firebaseConfig found on window.firebaseConfig or window.FIREBASE_CONFIG — provide it before loading this file');
                    return false;
                }
                firebase.initializeApp(cfg);
                // expose common helpers and mark cloud-only mode
                try {
                    window.auth = firebase.auth();
                    window.db = firebase.firestore();
                    window.storage = firebase.storage();
                } catch (e) {
                    console.warn('Firebase services not available after init', e);
                }
                window.__FIREBASE_INIT_DONE = true;
                // When Firebase is initialized we enable CLOUD_ONLY mode so localStorage writes are suppressed
                window.CLOUD_ONLY = true;
                console.log('Firebase initialized (compat) — CLOUD_ONLY enabled');

                // Install read-only guards for reviewers (after db is ready)
                try { installReviewerReadOnlyGuards(); } catch(e){ console.warn('installReviewerReadOnlyGuards failed', e); }

                // مراقبة حالة التوثيق
                try {
                    auth.onAuthStateChanged(async function(u){
                        if (u) {
                            const unified = { id: u.uid, email: (u.email||'').toLowerCase(), name: (u.displayName || (u.email ? u.email.split('@')[0] : 'مستخدم')), firebase: true, data: {} };
                            AuthSystem.setCurrentUser(unified);
                            // الاستماع لدور المستخدم من مجموعة roles وتحديث خريطة الأدوار
                            try {
                                window.__rolesMap = window.__rolesMap || {};
                                db.collection('roles').doc(u.uid).onSnapshot(snap => {
                                    if (snap.exists) {
                                        window.__rolesMap[u.uid] = snap.data().role || 'user';
                                        document.dispatchEvent(new Event('role-ready'));
                                    }
                                }, err => console.warn('role doc snapshot error', err));
                            } catch(e){ console.warn('setup role listener failed', e); }
                            try { UIController.showApp(); } catch(e){}
                            try { initializeAppForUser(); } catch(e){}
                            try { setupRealtimeListeners(); } catch(e){ console.warn('setupRealtimeListeners error', e); }
                            // محاولة استرداد تلقائية إذا فشل تحميل البيانات أول مرة (مثلاً خطأ عابر أو ترتيب تحميل السكربتات)
                            try { initRealtimeRecovery(); } catch(e){ console.warn('initRealtimeRecovery error', e); }
                            try { setPresenceOnline(); } catch(e){}
                            // إلغاء الاعتماد على appState القديم: القراءة ستكون فقط من المجموعات العليا (collections)
                            // ثم إن بقيت فارغة تماماً، إبذر الافتراضيات فقط
                            try { if (typeof seedDefaultsIfEmpty === 'function') seedDefaultsIfEmpty(); } catch(e){ console.warn('seedDefaultsIfEmpty error', e); }
                            // في حال البذر لم يجد شيئاً وظهرت مجموعات قديمة
                            try { initLegacyCollectionsIfEmpty(); } catch(e){}
                            // محاولة ضمان تحميل البيانات الأساسية (مكررة زمنياً)
                            try { scheduleEnsureCoreData(); } catch(e){ console.warn('scheduleEnsureCoreData error', e); }
                            // ضبط الفترة النشطة تلقائياً للشهر الحالي + إقفال الشهر السابق تلقائياً (للمشرف)
                            try { maybeAutoClosePreviousMonth(); } catch(e){}
                            try { ensureDefaultActivePeriod(); } catch(e){}
                            // Auto-resume GPS sharing if previously enabled
                            try {
                                if (localStorage.getItem('gps_sharing_enabled') === '1') {
                                    if (typeof startLocationSharing === 'function') startLocationSharing();
                                    else setTimeout(function(){ try { if (typeof startLocationSharing === 'function') startLocationSharing(); } catch(e){} }, 1000);
                                }
                                if (typeof window.__gpsHeaderSync === 'function') window.__gpsHeaderSync();
                            } catch(e){}
                            // Reviewer mode UI updates
                            try { applyReviewerModeUI(); } catch(e){}
                            // إعادة تطبيق قيود التنقل فور تحديد الدور
                            try { applyRoleNavRestrictions(); } catch(e){}
                            // محاولات إضافية خلال أول 10 ثواني بعد تسجيل الدخول لضمان الإخفاء للمندوب
                            let tries = 0; const tmr = setInterval(()=>{ tries++; try { applyRoleNavRestrictions(); } catch(e){} if (tries>10) clearInterval(tmr); },1000);
                        } else {
                            try { AuthSystem.logout(); } catch(e){}
                            try { UIController.showLoginPage(); } catch(e){}
                            try { setPresenceOffline(); } catch(e){}
                        }
                        try { UIController.updateCurrentUserDisplay(); } catch(e){}
                    });
                } catch(e) { console.warn('onAuthStateChanged setup failed', e); }

                return true;
            } catch (e) {
                console.warn('initFirebase error', e);
                return false;
            }
        }

        // Try to initialize automatically if a config exists
        try { initFirebase(); } catch(e) { /* ignore */ }

        // مستمعات لحظية للمجموعات بعد أول نجاح توثيق (يتم استدعاؤها من onAuthStateChanged بعد تسجيل الدخول)
        function setupRealtimeListeners(){
            if (!window.db) { console.warn('Firestore غير جاهز بعد'); return; }
            window.state = window.state || {};
            // المبيعات (Admin/Reviewer: كل الفواتير؛ المندوب: فواتيره فقط)
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = AuthSystem.getCurrentUser();
                const applySnap = function(snap){
                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    arr.sort((a,b)=>{
                        const ta = new Date(a.date || a.createdAt || 0).getTime();
                        const tb = new Date(b.date || b.createdAt || 0).getTime();
                        return tb - ta;
                    });
                    state.sales = arr.slice(0,500);
                    try { localStorage.setItem('cache_sales', JSON.stringify(state.sales)); } catch(e){}
                    try {
                        const textFilter = document.getElementById('search-sales-text')?.value || '';
                        const dateFilter = document.getElementById('search-sales-date')?.value || '';
                        const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                        if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                        else if (typeof renderSalesList === 'function') renderSalesList();
                        if (typeof renderDashboard === 'function') renderDashboard();
                    } catch(e){}
                };
                const onErr = function(err){
                    console.warn('sales snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('sales'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_sales');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.sales || state.sales.length === 0) && Array.isArray(cached) && cached.length) {
                            state.sales = cached;
                            const textFilter = document.getElementById('search-sales-text')?.value || '';
                            const dateFilter = document.getElementById('search-sales-date')?.value || '';
                            const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                            if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                            if (typeof renderDashboard === 'function') renderDashboard();
                        }
                    } catch(e){}
                };

                if (role === 'admin' || role === 'reviewer') {
                    db.collection('sales').onSnapshot(applySnap, onErr);
                } else if ((role === 'rep' || role === 'user') && current && current.id) {
                    const uid = String(current.id);
                    const email = (current.email||'').toLowerCase();
                    const byId = new Map();
                    let salesErrCount = 0;
                    const mergeAndRender = () => {
                        const arr = Array.from(byId.values());
                        arr.sort((a,b)=>{
                            const ta = new Date(a.date || a.createdAt || 0).getTime();
                            const tb = new Date(b.date || b.createdAt || 0).getTime();
                            return tb - ta;
                        });
                        state.sales = arr.slice(0,500);
                        try { localStorage.setItem('cache_sales', JSON.stringify(state.sales)); } catch(e){}
                        try { if (typeof renderAllSales === 'function') renderAllSales('', '', 'all'); } catch(e){}
                        try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                    };
                    // الاستعلامات المتعددة لدعم الأسماء القديمة للحقول
                    db.collection('sales').where('createdBy','==', uid).onSnapshot(snap => {
                        snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); mergeAndRender();
                    }, onErr);
                    db.collection('sales').where('repId','==', uid).onSnapshot(snap => {
                        snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); mergeAndRender();
                    }, onErr);
                    db.collection('sales').where('createdByEmail','==', email).onSnapshot(snap => {
                        snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); }); mergeAndRender();
                    }, onErr);
                    const salesErrorHandler = err => { salesErrCount++; console.warn('sales legacy query error', err); if (salesErrCount >= 3) { tryBroadSalesFallback(); } };
                    // reattach with dedicated handlers (original above kept minimal)
                    db.collection('sales').where('createdBy','==', uid).onSnapshot(()=>{}, salesErrorHandler);
                    db.collection('sales').where('repId','==', uid).onSnapshot(()=>{}, salesErrorHandler);
                    db.collection('sales').where('createdByEmail','==', email).onSnapshot(()=>{}, salesErrorHandler);
                    function tryBroadSalesFallback(){
                        // محاولة أخيرة: قراءة عامة محدودة تعتمد على السماح الانتقالي بالقواعد
                        db.collection('sales').limit(500).onSnapshot(snap => {
                            snap.forEach(doc => { const d = doc.data()||{}; d._id=doc.id; if(!d.id)d.id=doc.id; byId.set(doc.id,d); });
                            mergeAndRender();
                        }, err => console.warn('broad sales fallback failed', err));
                    }
                    // في حال الرفض كله استخدم الكاش المحلي
                    setTimeout(()=>{
                        if ((!state.sales || state.sales.length===0)) {
                            try {
                                const raw = localStorage.getItem('cache_sales');
                                const cached = raw ? JSON.parse(raw): [];
                                if (Array.isArray(cached) && cached.length) {
                                    state.sales = cached;
                                    if (typeof renderDashboard === 'function') renderDashboard();
                                }
                            } catch(e){}
                        }
                    }, 2000);
                } else {
                    db.collection('sales').onSnapshot(applySnap, onErr);
                }
            } catch(e){ console.warn('sales listener init failed', e); }
            // العملاء (تصفية للمندوب حسب القواعد: يرى عملاءه فقط + غير المعيّنين)
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const current = AuthSystem.getCurrentUser();
                if (role === 'admin') {
                    db.collection('customers').onSnapshot(function(snap){
                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                        try { attemptDeleteSpecificCustomersOnce(); } catch(e){}
                    }, err => {
                        console.warn('customers snapshot error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                    });
                } else if ((role === 'rep' || role === 'user') && current && current.id) {
                    const uid = String(current.id);
                    const byId = new Map();
                    let custErrCount = 0;
                    const applyAndRender = () => {
                        const arr = Array.from(byId.values());
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                    };
                    // 1) عملاء المندوب
                    db.collection('customers').where('assignedRepId','==', uid).onSnapshot(function(snap){
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => {
                        console.warn('customers snapshot (rep-owned) error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        // Fallback: use cached customers so المندوب يمكنه العمل أوفلاين
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                        custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback();
                    });
                    // استعلام حقول قديمة محتملة
                    db.collection('customers').where('repId','==', uid).onSnapshot(function(snap){
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => { console.warn('customers snapshot (legacy repId) error', err); custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback(); });
                    db.collection('customers').where('ownerId','==', uid).onSnapshot(function(snap){
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id, d); });
                        applyAndRender();
                    }, err => { console.warn('customers snapshot (legacy ownerId) error', err); custErrCount++; if (custErrCount>=3) tryBroadCustomersFallback(); });
                    function tryBroadCustomersFallback(){
                        db.collection('customers').limit(500).onSnapshot(snap => {
                            snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; byId.set(doc.id,d); });
                            applyAndRender();
                        }, err => console.warn('broad customers fallback failed', err));
                    }
                } else {
                    // أدوار أخرى: حاول القراءة، وإن رُفضت اعتمد على النسخة المحلية
                    db.collection('customers').onSnapshot(function(snap){
                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                        state.customers = arr;
                        try { localStorage.setItem('cache_customers', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(); } catch(e){}
                        try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                    }, err => {
                        console.warn('customers snapshot (other role) error', err);
                        if (err && err.code === 'permission-denied') { try { handlePermissionDenied('customers'); } catch(e){} }
                        try {
                            const raw = localStorage.getItem('cache_customers');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.customers || state.customers.length === 0) && Array.isArray(cached) && cached.length) {
                                state.customers = cached;
                                if (typeof renderCustomerList === 'function') renderCustomerList();
                                if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns();
                            }
                        } catch(e){}
                    });
                }
            } catch(e){ console.warn('customers listener init failed', e); }
            // المنتجات
            try {
                db.collection('products').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        // ضمان وجود الحقل id للتوافق مع واجهات الإدخال السريع وقوائم الأسعار
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        // إذا لا يوجد سعر لكن يوجد productPrices منفصلة أو حقل price داخل قائمة أسعار لاحقاً سيتم استخدامه
                        arr.push(d);
                    });
                    state.products = arr;
                    try { localStorage.setItem('cache_products', JSON.stringify(arr)); } catch(e){}
                    try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                }, err => {
                    console.warn('products snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('products'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_products');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.products || state.products.length === 0) && Array.isArray(cached) && cached.length) {
                            state.products = cached;
                            if (typeof renderProductList === 'function') renderProductList('');
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('products listener init failed', e); }
            // قوائم الأسعار
            try {
                db.collection('priceLists').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => {
                        const d = doc.data() || {};
                        const pl = { id: doc.id, name: d.name || d.title || doc.id, productPrices: {} };
                        if (d.productPrices && typeof d.productPrices === 'object') {
                            pl.productPrices = d.productPrices;
                        } else if (d.prices && typeof d.prices === 'object') {
                            pl.productPrices = d.prices;
                        } else if (d.map && typeof d.map === 'object') {
                            pl.productPrices = d.map;
                        } else {
                            // دعم الشكل الخاطئ: مفاتيح رقمية في المستوى الأعلى
                            const pp = {};
                            Object.keys(d).forEach(k => {
                                if (/^\d+$/.test(k) && typeof d[k] === 'number') pp[k] = d[k];
                            });
                            pl.productPrices = pp;
                        }
                        arr.push(pl);
                    });
                    // لا تمسح السعر إذا كانت المجموعة فارغة؛ احتفظ بالقيمة القادمة من appState/الاستيراد
                    if (arr.length > 0) {
                        state.priceLists = arr;
                        try { localStorage.setItem('cache_priceLists', JSON.stringify(arr)); } catch(e){}
                        try { if (typeof renderSettings === 'function') renderSettings(document.getElementById('search-products')?.value || ''); } catch(e){}
                        try { updateAllPriceListDropdowns(); } catch(e){}
                        try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                        // IMPORTANT: أعِدّ رسم صفحة العملاء فور توفر القوائم حتى لا تظهر "بدون قائمة أسعار"
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                    }
                }, err => {
                    console.warn('priceLists snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('priceLists'); } catch(e){} }
                    // Fallback عند منع الصلاحيات: تحميل القوائم المدمجة محلياً على الأقل للواجهة
                    if (err && err.code === 'permission-denied') {
                        if ((!state.priceLists || !state.priceLists.length) && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025)) {
                            state.priceLists = window.EMBEDDED_PRICE_LISTS_BACKUP_2025.map(pl => ({ id: pl.id, name: pl.name, productPrices: pl.productPrices || {} }));
                            console.log('⚠️ استخدمت النسخة المدمجة للقوائم بسبب رفض الصلاحيات');
                            try { updateAllPriceListDropdowns(); } catch(e){}
                            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                            try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                        }
                    }
                    // Fallback إضافي: النسخة المخبأة محلياً
                    try {
                        const raw = localStorage.getItem('cache_priceLists');
                        const cached = raw ? JSON.parse(raw) : [];
                        if ((!state.priceLists || state.priceLists.length === 0) && Array.isArray(cached) && cached.length) {
                            state.priceLists = cached;
                            try { updateAllPriceListDropdowns(); } catch(e){}
                            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                            try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                        }
                    } catch(e){}
                });
            } catch(e){ console.warn('priceLists listener init failed', e); }
            // المناديب
            try {
                db.collection('reps').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data(); d.id = doc.id; arr.push(d); });
                    state.reps = arr;
                    try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
                    try {
                        const simpleIds = ['sale-rep','customer-rep','new-dispatch-rep','spreadsheet-rep','debt-rep-filter','dashboard-rep-filter'];
                        simpleIds.forEach(id => { const el = document.getElementById(id); if (el && typeof populateRepDropdown === 'function') populateRepDropdown(el); });
                        const reportIds = ['daily-report-rep','range-report-rep','monthly-report-rep','recon-report-rep'];
                        reportIds.forEach(id => { const el = document.getElementById(id); if (el && typeof populateRepDropdownReports === 'function') populateRepDropdownReports(el); });
                    } catch(e){}
                }, err => console.warn('reps snapshot error', err));
                // (Optional) could add permission handler for reps/users/presence if needed
            } catch(e){ console.warn('reps listener init failed', e); }
            // المستخدمون (للأدوار) — Admin only
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') {
                    db.collection('users').onSnapshot(function(snap){
                        const usersArr = [];
                        snap.forEach(doc => {
                            const d = doc.data();
                            d._id = doc.id;
                            if (!d.uid) d.uid = doc.id;
                            if (d.email) { try { d.email = String(d.email).toLowerCase(); } catch(_){} }
                            usersArr.push(d);
                        });
                        state.users = usersArr;
                        try {
                            UIController.updateCurrentUserDisplay();
                            if (typeof renderUsersTable === 'function') renderUsersTable();
                        } catch(e){}
                    }, err => console.warn('users snapshot error', err));
                }
            } catch(e){ console.warn('users listener init failed', e); }

            // تم إلغاء الاستماع للمستند القديم shared/public_app_state نهائياً؛ المصدر الوحيد الآن هو المجموعات العلوية

            // الحضور (presence) — Admin only
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') {
                    db.collection('presence').onSnapshot(function(snap){
                        const arr = [];
                        snap.forEach(doc => { const d = doc.data(); d._id = doc.id; arr.push(d); });
                        state.presence = arr;
                        try {
                            if (Array.isArray(state.users) && state.users.length) {
                                const byId = new Map(arr.map(p => [String(p.uid||p._id||''), p]));
                                state.users = state.users.map(u => {
                                    const p = byId.get(String(u._id||u.uid||''));
                                    const merged = Object.assign({}, u);
                                    if (p) {
                                        // المستخدم لديه وجود في presence
                                        if ((!merged.email || merged.email==='') && p.email) merged.email = String(p.email).toLowerCase();
                                        merged.online = (p.online !== false); // قيمة افتراضية true إذا لم تكن موجودة
                                        try {
                                            if ((!u.email || u.email==='') && p.email && db) {
                                                db.collection('users').doc(String(u._id)).set({ email: String(p.email).toLowerCase() }, { merge: true }).catch(()=>{});
                                            }
                                        } catch(_e){}
                                    } else {
                                        // لا يوجد presence لهذا المستخدم — افرض أنه غير متصل بشكل افتراضي
                                        merged.online = (typeof u.online !== 'undefined') ? !!u.online : false; // افتراضياً false (غير متصل) 
                                    }
                                    return merged;
                                });
                            }
                        } catch(_){ }
                        try { renderRepLocations(); } catch(e){}
                        try { renderRepMap(); } catch(e){}
                        try { if (typeof renderUsersTable === 'function') renderUsersTable(); } catch(e){}
                    }, err => console.warn('presence snapshot error', err));
                }
            } catch(e){ console.warn('presence listener init failed', e); }

            // أذونات الخروج (dispatchNotes)
            try {
                db.collection('dispatchNotes').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d._id = doc.id; if (!d.id) d.id = doc.id; arr.push(d); });
                    // فرز تنازلي بالتاريخ
                    arr.sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
                    state.dispatchNotes = arr;
                    try { localStorage.setItem('cache_dispatchNotes', JSON.stringify(arr)); } catch(e){}
                    try { if (typeof renderDispatchPage === 'function') renderDispatchPage(); } catch(e){}
                }, err => {
                    console.warn('dispatchNotes snapshot error', err);
                    if (err && err.code === 'permission-denied') {
                        try {
                            const raw = localStorage.getItem('cache_dispatchNotes');
                            const cached = raw ? JSON.parse(raw) : [];
                            if ((!state.dispatchNotes || state.dispatchNotes.length===0) && cached.length){
                                state.dispatchNotes = cached; if (typeof renderDispatchPage === 'function') renderDispatchPage();
                            }
                        } catch(e){}
                    }
                });
            } catch(e){ console.warn('dispatchNotes listener init failed', e); }

            // العروض الترويجية (promotions)
            try {
                db.collection('promotions').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.promotions = arr;
                    try { localStorage.setItem('cache_promotions', JSON.stringify(arr)); } catch(e){}
                    try { if (typeof renderPromotions === 'function') renderPromotions(); } catch(e){}
                }, err => {
                    console.warn('promotions snapshot error', err);
                    if (err && err.code === 'permission-denied') { try { handlePermissionDenied('promotions'); } catch(e){} }
                    try {
                        const raw = localStorage.getItem('cache_promotions');
                        if (raw) state.promotions = JSON.parse(raw);
                    } catch(e){}
                });
            } catch(e){ console.warn('promotions listener init failed', e); }

            // الأرصدة الافتتاحية (openingBalances) — تُستخدم للترحيل بين الشهور
            try {
                db.collection('openingBalances').onSnapshot(function(snap){
                    const arr = [];
                    snap.forEach(doc => { const d = doc.data() || {}; d.id = doc.id; arr.push(d); });
                    state.openingBalances = arr;
                    try { localStorage.setItem('cache_openingBalances', JSON.stringify(arr)); } catch(e){}
                }, err => {
                    console.warn('openingBalances snapshot error', err);
                    try {
                        const raw = localStorage.getItem('cache_openingBalances');
                        if (raw) state.openingBalances = JSON.parse(raw);
                    } catch(e){}
                });
            } catch(e){ console.warn('openingBalances listener init failed', e); }

            // الإعدادات العامة (settings) — الهدف الشهري والإعدادات الأخرى
            try {
                db.collection('settings').doc('global-settings').onSnapshot(function(snap){
                    if (snap.exists) {
                        const settings = snap.data() || {};
                        state.settings = state.settings || {};
                        if (settings.salesTarget !== undefined) {
                            state.settings.salesTarget = settings.salesTarget;
                            // تحديث حقل الإدخال دائماً (حتى لو لم تكن الصفحة مفتوحة)
                            try {
                                const input = document.getElementById('sales-target-input');
                                if (input) {
                                    input.value = settings.salesTarget;
                                }
                            } catch(e){}
                            // إعادة رسم لوحة المعلومات إذا تغير الهدف
                            try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
                        }
                        console.log('تم تحديث الإعدادات من السحابة:', settings);
                    }
                }, err => {
                    console.warn('settings snapshot error', err);
                });
            } catch(e){ console.warn('settings listener init failed', e); }
        }

        // ===== GPS Tracking (Presence Location) =====
        (function(){
            const LS_GPS = 'gps_sharing_enabled';
            window.__gpsWatchId = null;
            window.__repsMap = null;
            window.__repMarkers = {};
            window.__gpsHeaderSync = function(){
                try {
                    const btn = document.getElementById('gps-toggle-btn');
                    if (!btn) return;
                    // Remove any neutral/old classes to avoid conflicts
                    btn.classList.remove('bg-gray-200','hover:bg-gray-300','text-gray-800');
                    const enabled = localStorage.getItem(LS_GPS) === '1';
                    btn.textContent = enabled ? 'GPS ON' : 'GPS OFF';
                    btn.classList.toggle('bg-green-500', enabled);
                    btn.classList.toggle('hover:bg-green-600', enabled);
                    btn.classList.toggle('text-white', enabled);
                    // OFF state as red for clear visual cue
                    btn.classList.toggle('bg-red-500', !enabled);
                    btn.classList.toggle('hover:bg-red-600', !enabled);
                    btn.classList.toggle('text-white', !enabled);
                } catch(e){}
            };

            window.startLocationSharing = function(){
                try {
                    const statusEl = document.getElementById('gps-share-status');
                    if (!navigator.geolocation) { if (statusEl) statusEl.textContent = 'المتصفح لا يدعم الموقع'; return; }
                    if (!auth || !auth.currentUser) { if (statusEl) statusEl.textContent = 'لم يتم تسجيل الدخول'; return; }
                    if (window.__gpsWatchId != null) return; // already running
                    const opts = { enableHighAccuracy: true, maximumAge: 15000, timeout: 15000 };
                    window.__gpsWatchId = navigator.geolocation.watchPosition(async function(pos){
                        try {
                            const { latitude:lat, longitude:lng, accuracy } = pos.coords || {};
                            const uid = auth.currentUser.uid;
                            await db.collection('presence').doc(uid).set({
                                uid,
                                email: (auth.currentUser.email||'').toLowerCase(),
                                online: true,
                                location: { lat, lng, accuracy },
                                locationUpdatedAt: serverTs(),
                                sharing: true
                            }, { merge:true });
                            const s = `آخر تحديث: ${new Date().toLocaleTimeString('ar-EG')}`;
                            if (statusEl) statusEl.textContent = s;
                        } catch(e){ /* ignore */ }
                    }, function(err){ if (statusEl) statusEl.textContent = 'تعذر تحديد الموقع'; console.warn('GPS error', err); }, opts);
                    try { localStorage.setItem(LS_GPS, '1'); } catch(e){}
                    try { window.__gpsHeaderSync(); } catch(e){}
                } catch(e){ console.warn('startLocationSharing failed', e); }
            };

            window.stopLocationSharing = function(){
                try {
                    const statusEl = document.getElementById('gps-share-status');
                    if (window.__gpsWatchId != null) { try { navigator.geolocation.clearWatch(window.__gpsWatchId); } catch(e){} window.__gpsWatchId = null; }
                    try { localStorage.removeItem(LS_GPS); } catch(e){}
                    if (statusEl) statusEl.textContent = 'متوقف';
                    if (auth && auth.currentUser && db) {
                        const uid = auth.currentUser.uid;
                        db.collection('presence').doc(uid).set({ sharing:false }, { merge:true }).catch(()=>{});
                    }
                    try { window.__gpsHeaderSync(); } catch(e){}
                } catch(e){ console.warn('stopLocationSharing failed', e); }
            };

            window.setupGpsSharingControls = function(){
                try {
                    const toggle = document.getElementById('gps-share-toggle');
                    const statusEl = document.getElementById('gps-share-status');
                    const adminBox = document.getElementById('admin-gps-list');
                    if (!toggle) return; // settings page not in DOM
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (adminBox) adminBox.classList.toggle('hidden', role !== 'admin');
                    const enabled = localStorage.getItem(LS_GPS) === '1';
                    toggle.checked = enabled;
                    if (enabled) { statusEl && (statusEl.textContent = 'جارٍ المشاركة...'); startLocationSharing(); }
                    toggle.addEventListener('change', function(){
                        if (toggle.checked) { statusEl && (statusEl.textContent = 'جارٍ المشاركة...'); startLocationSharing(); }
                        else { stopLocationSharing(); }
                    });
                    // عرض مواقع المناديب مباشرة عند فتح الإعدادات
                    try { window.renderRepLocations(); } catch(e){}
                    // أيضاً استدعاء renderRepMap إذا كانت الخريطة مفتوحة
                    try { window.renderRepMap(); } catch(e){}
                    // Also wire header button now that DOM is ready
                    try {
                        const hdrBtn = document.getElementById('gps-toggle-btn');
                        if (hdrBtn) {
                            window.__gpsHeaderSync();
                            hdrBtn.addEventListener('click', function(){
                                const isOn = localStorage.getItem(LS_GPS) === '1';
                                if (isOn) {
                                    stopLocationSharing();
                                } else {
                                    statusEl && (statusEl.textContent = 'جارٍ المشاركة...');
                                    startLocationSharing();
                                }
                                // Immediately refresh text to reflect Delente ON/OFF without waiting for async
                                try { window.__gpsHeaderSync(); } catch(e){}
                            });
                        }
                    } catch(e){}
                } catch(e){ console.warn('setupGpsSharingControls failed', e); }
            };

            window.renderRepLocations = function(){
                try {
                    const listEl = document.getElementById('rep-locations-list');
                    const adminBox = document.getElementById('admin-gps-list');
                    if (!listEl || !adminBox || adminBox.classList.contains('hidden')) return;
                    const rows = (state.presence||[])
                        .filter(p => p && p.location && typeof p.location.lat === 'number')
                        .map(p => {
                            const name = (state.users||[]).find(u=>u.uid===p.uid)?.name || (state.reps||[]).find(r=>r.email && p.email && r.email.toLowerCase()===p.email.toLowerCase())?.name || p.email || p.uid;
                            const lat = p.location.lat, lng = p.location.lng, acc = p.location.accuracy;
                            const when = p.locationUpdatedAt && p.locationUpdatedAt.toDate ? p.locationUpdatedAt.toDate() : (p.locationUpdatedAt || null);
                            const timeStr = when ? new Date(when).toLocaleString('ar-EG') : '';
                            const link = `https://www.google.com/maps?q=${lat},${lng}`;
                            return `<div class="flex items-center gap-2 p-2 bg-gray-50 rounded">
                                <span class="font-semibold">${(name||'مندوب')}</span>
                                <span class="text-gray-600">(${lat.toFixed(5)}, ${lng.toFixed(5)}${acc?` • ±${Math.round(acc)}م`:''})</span>
                                <a class="text-blue-600 underline ml-auto" target="_blank" href="${link}">فتح الخريطة</a>
                                <span class="text-xs text-gray-500">${timeStr}</span>
                            </div>`;
                        }).join('');
                    listEl.innerHTML = rows || '<div class="text-sm text-gray-500">لا توجد مواقع مُبلّغ عنها حالياً.</div>';
                } catch(e){ /* ignore */ }
            };

            // Interactive map: initialize and update markers
            window.openRepsMap = function(){
                try {
                    const modal = document.getElementById('reps-map-modal');
                    if (!modal) return;
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    setTimeout(()=>{
                        if (!window.__repsMap) {
                            window.__repsMap = L.map('reps-map', { zoomControl: true });
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: '&copy; OpenStreetMap'
                            }).addTo(window.__repsMap);
                        }
                        renderRepMap();
                    }, 50);
                } catch(e){ console.warn('openRepsMap failed', e); }
            };

            window.closeRepsMap = function(){
                try {
                    const modal = document.getElementById('reps-map-modal');
                    if (!modal) return;
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                } catch(e){}
            };

            window.renderRepMap = function(){
                try {
                    if (!window.__repsMap) return;
                    const presence = (state.presence||[]).filter(p => p && p.location && typeof p.location.lat === 'number' && p.sharing !== false);
                    const bounds = [];
                    // Remove missing markers
                    const currentUids = new Set(presence.map(p=>p.uid||p._id));
                    Object.keys(window.__repMarkers).forEach(uid => {
                        if (!currentUids.has(uid)) {
                            try { window.__repsMap.removeLayer(window.__repMarkers[uid]); } catch(e){}
                            delete window.__repMarkers[uid];
                        }
                    });
                    presence.forEach(p => {
                        const uid = p.uid || p._id || (p.email||'');
                        const lat = p.location.lat, lng = p.location.lng;
                        const name = (state.users||[]).find(u=>u.uid===p.uid)?.name || (state.reps||[]).find(r=>r.email && p.email && r.email.toLowerCase()===p.email.toLowerCase())?.name || p.email || 'مندوب';
                        const when = p.locationUpdatedAt && p.locationUpdatedAt.toDate ? p.locationUpdatedAt.toDate() : (p.locationUpdatedAt || null);
                        const timeStr = when ? new Date(when).toLocaleString('ar-EG') : '';
                        const popupHtml = `<div style="min-width:160px"><div style="font-weight:700">${name}</div><div style="font-size:12px;color:#555">${lat.toFixed(5)}, ${lng.toFixed(5)}</div><div style="font-size:11px;color:#777">${timeStr}</div><a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color:#2563eb;text-decoration:underline">فتح الخريطة</a></div>`;
                        if (!window.__repMarkers[uid]) {
                            window.__repMarkers[uid] = L.marker([lat, lng]).addTo(window.__repsMap).bindPopup(popupHtml);
                        } else {
                            window.__repMarkers[uid].setLatLng([lat, lng]);
                            window.__repMarkers[uid].setPopupContent(popupHtml);
                        }
                        bounds.push([lat, lng]);
                    });
                    if (bounds.length) {
                        try { window.__repsMap.fitBounds(bounds, { padding: [30,30] }); } catch(e){}
                    }
                } catch(e){ console.warn('renderRepMap failed', e); }
            };

            // Wire header map button and modal close
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const openBtn = document.getElementById('open-map-btn');
                    const closeBtn = document.getElementById('close-map-btn');
                    if (openBtn) openBtn.addEventListener('click', openRepsMap);
                    if (closeBtn) closeBtn.addEventListener('click', closeRepsMap);
                    // Wire header GPS toggle regardless of settings page
                    const hdrBtn = document.getElementById('gps-toggle-btn');
                    if (hdrBtn) {
                        try { window.__gpsHeaderSync(); } catch(e){}
                        hdrBtn.addEventListener('click', function(){
                            try {
                                const isOn = localStorage.getItem('gps_sharing_enabled') === '1';
                                if (isOn) stopLocationSharing(); else startLocationSharing();
                            } catch(e){}
                        });
                    }
                } catch(e){}
            });
        })();

        // ===== تعافي تلقائي في حال لم يتم ملء state خلال الثواني الأولى =====
        function initRealtimeRecovery(){
            let attempts = 0;
            const maxAttempts = 5; // محاولات محدودة لتجنب الدوران اللامتناهي
            const intervalMs = 3000;
            if (window.__REALTIME_RECOVERY_STARTED) return; // منع التكرار
            window.__REALTIME_RECOVERY_STARTED = true;
            const iv = setInterval(()=>{
                attempts++;
                try {
                    const salesOk = Array.isArray(state.sales) && state.sales.length > 0;
                    const customersOk = Array.isArray(state.customers) && state.customers.length > 0;
                    const productsOk = Array.isArray(state.products) && state.products.length > 0;
                    // إذا البيانات الأساسية ظهرت، أوقف التعافي
                    if (salesOk || (customersOk && productsOk)) {
                        clearInterval(iv);
                        return;
                    }
                    // إعادة محاولة إعداد المستمعات
                    console.warn('Realtime recovery attempt', attempts, '— إعادة تشغيل setupRealtimeListeners');
                    setupRealtimeListeners();
                    // قراءة من النسخ المحلية كدعم مؤقت
                    try { preloadCachedCollections(); ensureCachedDataRendered(); } catch(e){}
                } catch(e){ console.warn('initRealtimeRecovery loop error', e); }
                if (attempts >= maxAttempts) {
                    clearInterval(iv);
                    console.warn('Realtime recovery stopped بعد بلوغ الحد الأقصى للمحاولات');
                }
            }, intervalMs);
        }

        /* ================================================================
           📦 مخطط البيانات (Schema) المعتمد في Firestore (تدريجي)
           ---------------------------------------------------------------
           users: {
             uid (doc id), email, name, role, createdAt, lastLoginAt
           }
           customers: {
             id (doc id), name, phone, taxNumber, requiresTaxFiling, priceListId,
             balance (اختياري), createdAt, updatedAt
           }
           products: {
             id (doc id), name, sku, price, cost, unit, active, createdAt, updatedAt
           }
           sales: {
             id (doc id), invoiceNumber, customerId, repId/repName, items:[{productId, qty, price}],
             total, paidAmount, status (paid|partial|due|return), discountPercent,
             taxFilingStatus, date (ISO), createdAt, updatedAt
           }
           presence (اختياري لاحقاً): {
             uid (doc id), email, lastActive: serverTimestamp(), online: true
           }
           ---------------------------------------------------------------
           جميع العمليات يجب أن تستخدم هذه الدوال CRUD بدلاً من التعديل المباشر
           داخل state. التحديثات ستصل لحظياً عبر onSnapshot.
        ================================================================ */

        // دوال مساعدة للوقت من السيرفر
        function serverTs(){
            try { return firebase.firestore.FieldValue.serverTimestamp(); } catch(e){ return new Date(); }
        }

        // ===== CRUD: المنتجات =====
        async function addProduct(data){
            const obj = {
                name: data.name || '',
                sku: data.sku || data.id || Date.now().toString(),
                price: Number(data.price||0),
                cost: Number(data.cost||0),
                unit: data.unit || 'وحدة',
                active: data.active !== false,
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            return db.collection('products').add(obj);
        }
        async function updateProduct(id, partial){
            return db.collection('products').doc(id).set({ ...partial, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteProduct(id){ return db.collection('products').doc(id).delete(); }

        // ===== CRUD: العملاء =====
        async function addCustomer(data){
            const obj = {
                name: data.name || '',
                phone: data.phone || '',
                taxNumber: data.taxNumber || '',
                address: data.address || '',
                repName: data.repName || '',
                requiresTaxFiling: !!data.requiresTaxFiling,
                priceListId: data.priceListId || '',
                balance: Number(data.balance||0),
                // تعيين المندوب المسؤول عن العميل (اختياري). إن لم يُحدّد يبقى متاحاً لجميع المناديب.
                assignedRepId: (function(){
                    try {
                        if (data.assignedRepId) return data.assignedRepId;
                        // إذا كان الدور مندوب اجعل التعيين لنفسه افتراضياً لضمان التوافق مع القواعد الجديدة
                        const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                        if (role === 'rep' && window.auth && auth.currentUser) return auth.currentUser.uid;
                        if (data.repName) {
                            const r = window.findRep ? window.findRep(data.repName) : null;
                            return r ? r.id : '';
                        }
                    } catch(e){}
                    return '';
                })(),
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            return db.collection('customers').add(obj);
        }
        async function updateCustomer(id, partial){
            const obj = { ...partial };
            try {
                if (!obj.assignedRepId && obj.repName) {
                    const r = window.findRep ? window.findRep(obj.repName) : null;
                    if (r) obj.assignedRepId = r.id;
                }
            } catch(e){}
            return db.collection('customers').doc(id).set({ ...obj, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteCustomer(id){ return db.collection('customers').doc(id).delete(); }

        // ===== CRUD: قوائم الأسعار =====
        async function addPriceListDoc(id, data){
            const ref = id ? db.collection('priceLists').doc(String(id)) : db.collection('priceLists').doc();
            const obj = {
                id: id || ref.id,
                name: data.name || '',
                productPrices: data.productPrices || {},
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            await ref.set(obj, { merge:false });
            return ref;
        }
        async function updatePriceListDoc(id, partial){
            return db.collection('priceLists').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
        }
        async function deletePriceListDoc(id){ return db.collection('priceLists').doc(String(id)).delete(); }

        // ===== CRUD: المناديب =====
        async function addRepDoc(id, data){
            const ref = id ? db.collection('reps').doc(String(id)) : db.collection('reps').doc();
            const obj = {
                id: id || ref.id,
                name: data.name || '',
                serial: data.serial || '',
                target: Number(data.target||0),
                nextInvoiceNumber: data.nextInvoiceNumber || null,
                createdAt: serverTs(),
                updatedAt: serverTs()
            };
            await ref.set(obj, { merge:false });
            return ref;
        }
        async function updateRepDoc(id, partial){
            return db.collection('reps').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
        }
        async function deleteRepDoc(id){ return db.collection('reps').doc(String(id)).delete(); }

        // صلاحيات إدارة العملاء: المندوب يرى ويعدّل فقط عملاؤه أو العملاء غير المعيّنين
        function canManageCustomer(c){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'admin') return true;
                if (role === 'rep') {
                    if (!c) return false;
                    const assigned = c.assignedRepId || '';
                    if (!assigned) return true; // غير معيّن => متاح للجميع
                    const current = AuthSystem.getCurrentUser();
                    if (current && current.id === assigned) return true;
                    return false;
                }
                // أدوار أخرى (viewer/user) ليس لها تعديل لكن لا نحجب العرض حالياً
                return true;
            } catch(e){ return true; }
        }
        // ملاحظة هامة: هذه القيود واجهة فقط. يجب إضافة قواعد أمان Firestore للتحقق من أن المندوب لا يقرأ أو يعدّل إلا عملاءه.

        // ===== CRUD: المبيعات =====
        async function addSale(data){
            const obj = {
                id: data.id || undefined,
                invoiceNumber: data.invoiceNumber || null,
                customerId: data.customerId || null,
                repName: data.repName || data.repId || '',
                items: Array.isArray(data.items) ? data.items : [],
                total: Number(data.total||0),
                paidAmount: Number(data.paidAmount||0),
                status: data.status || 'due',
                discountPercent: Number(data.discountPercent||0),
                taxFilingStatus: data.taxFilingStatus || '',
                date: data.date || new Date().toISOString(),
                repEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
                createdBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
                createdAt: serverTs(),
                updatedAt: serverTs(),
                updatedBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null
            };
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // افتراض: المندوب/المبيعات => تحت المراجعة، غير ذلك تُعتبر مُراجَعة
                if (role === 'sales' || role === 'rep') obj.reviewStatus = 'pending';
                else obj.reviewStatus = 'reviewed';
            } catch(_) { obj.reviewStatus = 'pending'; }
            const ref = data && data.id
                ? db.collection('sales').doc(String(data.id))
                : db.collection('sales').doc();
            if (!data.id) obj.id = ref.id;
            try {
                console.log('addSale: writing doc', obj.id, 'invoice:', obj.invoiceNumber);
                await ref.set(obj, { merge: false });
                console.log('addSale: write success', obj.id);
            } catch (e) {
                console.warn('addSale: write failed', e);
                throw e;
            }
            // Update local cache immediately to survive refresh when reads are blocked
            try { upsertCachedSale(Object.assign({}, obj, { _id: obj.id })); } catch(e){}
            // Optional: update UI quickly if snapshots are blocked
            try {
                if (!window.state) window.state = {};
                if (!Array.isArray(state.sales)) state.sales = [];
                const exists = state.sales.some(s => (s.id||s._id) === obj.id);
                if (!exists) state.sales.unshift(Object.assign({}, obj));
                const textFilter = document.getElementById('search-sales-text')?.value || '';
                const dateFilter = document.getElementById('search-sales-date')?.value || '';
                const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                if (typeof renderDashboard === 'function') renderDashboard();
            } catch(e){}
            return ref;
        }
        // ===== CRUD: أذونات الخروج (dispatchNotes) =====
        async function addDispatchNote(data){
            const base = {
                noteNumber: data.noteNumber || null,
                repName: data.repName || '',
                date: data.date || new Date().toISOString(),
                items: Array.isArray(data.items) ? data.items : [],
                createdAt: serverTs(),
                updatedAt: serverTs(),
                createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null
            };
            const ref = data && data.id ? db.collection('dispatchNotes').doc(String(data.id)) : db.collection('dispatchNotes').doc();
            if (!data.id) base.id = ref.id; else base.id = data.id;
            await ref.set(base, { merge:false });
            // تحديث محلي سريع إذا لم يصل السnapshot بعد
            try {
                if (!state.dispatchNotes) state.dispatchNotes = [];
                const exists = state.dispatchNotes.some(n => (n.id||n._id) === base.id);
                if (!exists) state.dispatchNotes.unshift(Object.assign({}, base));
                if (typeof renderDispatchPage === 'function') renderDispatchPage();
            } catch(e){}
            return ref;
        }
        async function updateDispatchNote(id, partial){
            const meta = { updatedAt: serverTs() };
            await db.collection('dispatchNotes').doc(id).set({ ...partial, ...meta }, { merge:true });
            try {
                if (Array.isArray(state.dispatchNotes)){
                    const i = state.dispatchNotes.findIndex(n => (n.id||n._id) === id);
                    if (i>=0) state.dispatchNotes[i] = Object.assign({}, state.dispatchNotes[i], partial, { id });
                    if (typeof renderDispatchPage === 'function') renderDispatchPage();
                }
            } catch(e){}
        }
        async function deleteDispatchNote(id){
            await db.collection('dispatchNotes').doc(id).delete();
            try {
                state.dispatchNotes = (state.dispatchNotes||[]).filter(n => (n.id||n._id) !== id);
                if (typeof renderDispatchPage === 'function') renderDispatchPage();
            } catch(e){}
        }
        async function updateSale(id, partial){
            // منع تعديل فواتير ضمن شهر مقفول
            try {
                if (Array.isArray(state.sales)){
                    const s = state.sales.find(x => (x.id||x._id) === id);
                    if (s && (s.locked === true || (s.lockPeriod && String(s.lockPeriod).length))) {
                        alert('هذه الفاتورة ضمن شهر مقفول ولا يمكن تعديلها');
                        throw new Error('sale-locked');
                    }
                }
            } catch(e){}
            const meta = { updatedAt: serverTs() };
            try { if (window.auth && auth.currentUser) meta.updatedBy = auth.currentUser.uid; } catch(e){}
            await db.collection('sales').doc(id).set({ ...partial, ...meta }, { merge:true });
            try {
                const list = getCachedSales();
                const idx = list.findIndex(s => (s.id||s._id) === id);
                if (idx >= 0) {
                    list[idx] = Object.assign({}, list[idx], partial, { id, _id: id });
                    setCachedSales(list);
                }
            } catch(e){}
            // Soft update UI if snapshots are blocked
            try {
                if (Array.isArray(state.sales)){
                    const i = state.sales.findIndex(s => (s.id||s._id) === id);
                    if (i >= 0) state.sales[i] = Object.assign({}, state.sales[i], partial, { id });
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    if (typeof renderDashboard === 'function') renderDashboard();
                }
            } catch(e){}
        }
        async function deleteSale(id){
            await db.collection('sales').doc(id).delete();
            try { removeCachedSale(id); } catch(e){}
            try {
                if (Array.isArray(state.sales)){
                    state.sales = state.sales.filter(s => (s.id||s._id) !== id);
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    if (typeof renderDashboard === 'function') renderDashboard();
                }
            } catch(e){}
        }

        // ملاحظة: دوال الأسعار والقوائم والترقيات يمكن إضافتها بنفس النمط عند الحاجة.

        // استبدال أي استخدام مباشر لـ state.*.push في الواجهة باستدعاء هذه الدوال.

        // ===== Seeding: بيانات افتراضية (Admin/First-time) =====
        async function seedDefaultsIfEmpty(){
            try {
                if (!window.db) return;
                // تحكم بالأذونات: اسمح بالزرع إذا كان الدور 'admin' أو إذا كانت المجموعات فارغة تماماً (تشغيل أول)
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const [custSnap, plSnap] = await Promise.all([
                    db.collection('customers').limit(1).get(),
                    db.collection('priceLists').limit(1).get()
                ]);
                // إذا ليس Admin وتوجد بيانات بالفعل، لا تفعل شيء
                if (custSnap && !custSnap.empty && plSnap && !plSnap.empty) return;
                if (role !== 'admin' && !(custSnap.empty && plSnap.empty)) return;

                console.log('Seeding default data: customers, products, priceLists');

                const batch = db.batch();

                // منتجات أساسية بمعرّفات ثابتة لضبط قوائم الأسعار عليها
                const products = [
                    { id: 'P001', name: 'منتج 1', sku: 'SKU-001', price: 100, cost: 70, unit: 'قطعة' },
                    { id: 'P002', name: 'منتج 2', sku: 'SKU-002', price: 150, cost: 110, unit: 'قطعة' },
                    { id: 'P003', name: 'منتج 3', sku: 'SKU-003', price: 200, cost: 140, unit: 'قطعة' }
                ];
                products.forEach(p => {
                    const ref = db.collection('products').doc(p.id);
                    batch.set(ref, {
                        name: p.name,
                        sku: p.sku,
                        price: Number(p.price||0),
                        cost: Number(p.cost||0),
                        unit: p.unit || 'وحدة',
                        active: true,
                        createdAt: serverTs(),
                        updatedAt: serverTs()
                    }, { merge: true });
                });

                // قوائم أسعار بمعرّفات مفهومة (retail / wholesale) مع خريطة أسعار للمنتجات أعلاه
                const retailPrices = { P001: 100, P002: 150, P003: 200 };
                const wholesalePrices = { P001: 90, P002: 135, P003: 180 };

                const plRetailRef = db.collection('priceLists').doc('retail');
                batch.set(plRetailRef, {
                    name: 'قطاعي (retail)',
                    productPrices: retailPrices,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });

                const plWholesaleRef = db.collection('priceLists').doc('wholesale');
                batch.set(plWholesaleRef, {
                    name: 'جملة (wholesale)',
                    productPrices: wholesalePrices,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });

                // عملاء افتراضيون مرتبطون بقوائم الأسعار
                const customers = [
                    { id: 'CUST001', name: 'عميل قطاعي 1', phone: '01000000001', priceListId: 'retail', requiresTaxFiling: false },
                    { id: 'CUST002', name: 'عميل جملة 1',  phone: '01000000002', priceListId: 'wholesale', requiresTaxFiling: true },
                    { id: 'CUST003', name: 'عميل قطاعي 2', phone: '01000000003', priceListId: 'retail', requiresTaxFiling: false }
                ];
                customers.forEach(c => {
                    const ref = db.collection('customers').doc(c.id);
                    batch.set(ref, {
                        name: c.name,
                        phone: c.phone || '',
                        taxNumber: '',
                        requiresTaxFiling: !!c.requiresTaxFiling,
                        priceListId: c.priceListId,
                        balance: 0,
                        createdAt: serverTs(),
                        updatedAt: serverTs()
                    }, { merge: true });
                });

                await batch.commit();
                console.log('✅ Seeding complete');
                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                // بعد البذر حاول تحميل أي مجموعات قديمة بأسماء مختلفة إذا كانت فارغة
                try { initLegacyCollectionsIfEmpty(); } catch(e){}
            } catch (e) {
                console.warn('Seeding failed', e);
            }
        }

        // ===== توافق مع أسماء مجموعات قديمة محتملة (Customers / PriceLists / price_lists) =====
        async function initLegacyCollectionsIfEmpty(){
            if (!window.db) return;
            const needCustomers = !state.customers || state.customers.length === 0;
            const needPriceLists = !state.priceLists || state.priceLists.length === 0;
            if (!needCustomers && !needPriceLists) return;
            console.log('Checking legacy collection names for data...');
            const tasks = [];
            if (needCustomers) tasks.push(db.collection('Customers').get().catch(()=>null));
            if (needCustomers) tasks.push(db.collection('customers_old').get().catch(()=>null));
            if (needPriceLists) tasks.push(db.collection('PriceLists').get().catch(()=>null));
            if (needPriceLists) tasks.push(db.collection('price_lists').get().catch(()=>null));
            const results = await Promise.all(tasks);
            results.forEach(snapshot => {
                if (!snapshot || snapshot.empty) return;
                const firstDoc = snapshot.docs[0];
                const collName = firstDoc && firstDoc.ref && firstDoc.ref.parent && firstDoc.ref.parent.id;
                if (!collName) return;
                if (['Customers','customers_old'].includes(collName)) {
                    const arr = []; snapshot.forEach(doc=>{ const d = doc.data(); d._legacy = true; d._id = doc.id; arr.push(d); });
                    if (arr.length > 0 && (!state.customers || state.customers.length === 0)) {
                        state.customers = arr;
                        console.log('Imported legacy customers from', collName, 'count=', arr.length);
                        try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                    }
                }
                if (['PriceLists','price_lists'].includes(collName)) {
                    const arr = []; snapshot.forEach(doc=>{ const d = doc.data(); d._legacy = true; d.id = doc.id; arr.push(d); });
                    if (arr.length > 0 && (!state.priceLists || state.priceLists.length === 0)) {
                        state.priceLists = arr;
                        console.log('Imported legacy priceLists from', collName, 'count=', arr.length);
                        try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                    }
                }
            });
        }

        // ===== ضمان تحميل البيانات الأساسية (العملاء + قوائم الأسعار) مع استرجاع من النسخ المحلية عند الحاجة =====
        async function ensureCoreData(){
            if (!db) return;
            if (window.__coreDataEnsured) return;
            const needCustomers = !state.customers || state.customers.length === 0;
            const needPriceLists = !state.priceLists || state.priceLists.length === 0;
            const needProducts = !state.products || state.products.length === 0;
            const needReps = !state.reps || state.reps.length === 0;
            if (!needCustomers && !needPriceLists && !needProducts && !needReps) { window.__coreDataEnsured = true; return; }
            console.log('ensureCoreData: محاولة تعبئة البيانات الأساسية');
            try {
                // استيراد النسخة المدمجة أولاً (إذا كانت المجموعات فارغة فعلاً) قبل القراءة السحابية
                try { await importEmbeddedBackupIfNeeded(); } catch(e){ console.warn('importEmbeddedBackupIfNeeded early call failed', e); }
                const [custSnap, plSnap, prodSnap, repsSnap] = await Promise.all([
                    needCustomers ? db.collection('customers').get() : Promise.resolve(null),
                    needPriceLists ? db.collection('priceLists').get() : Promise.resolve(null),
                    needProducts ? db.collection('products').get() : Promise.resolve(null),
                    needReps ? db.collection('reps').get() : Promise.resolve(null)
                ]);
                if (custSnap && !custSnap.empty) {
                    const arr = [];
                    custSnap.forEach(doc => {
                        const d = doc.data();
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    state.customers = arr; console.log('ensureCoreData: customers fetched =', arr.length);
                    try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                    try { if (typeof updateAllCustomerDropdowns === 'function') updateAllCustomerDropdowns(); } catch(e){}
                }
                if (plSnap && !plSnap.empty) {
                    const arr = []; plSnap.forEach(doc => {
                        const d = doc.data() || {};
                        const pl = { id: doc.id, name: d.name || d.title || doc.id, productPrices: {} };
                        if (d.productPrices && typeof d.productPrices === 'object') pl.productPrices = d.productPrices;
                        else if (d.prices && typeof d.prices === 'object') pl.productPrices = d.prices;
                        else if (d.map && typeof d.map === 'object') pl.productPrices = d.map;
                        else {
                            const pp = {}; Object.keys(d).forEach(k => { if (/^\d+$/.test(k) && typeof d[k] === 'number') pp[k] = d[k]; });
                            pl.productPrices = pp;
                        }
                        arr.push(pl);
                    });
                    state.priceLists = arr; console.log('ensureCoreData: priceLists fetched =', arr.length);
                    try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                    try { updateAllPriceListDropdowns(); } catch(e){}
                    // أعِدّ رسم العملاء لأن بطاقات العملاء تعتمد على priceListId
                    try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                }
                if (prodSnap && !prodSnap.empty) {
                    const arr = [];
                    prodSnap.forEach(doc => {
                        const d = doc.data();
                        d._id = doc.id;
                        if (!d.id) d.id = doc.id;
                        arr.push(d);
                    });
                    state.products = arr; console.log('ensureCoreData: products fetched =', arr.length);
                    try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                }
                if (repsSnap && !repsSnap.empty) {
                    const arr = []; repsSnap.forEach(doc => { const d = doc.data(); d.id = doc.id; arr.push(d); });
                    state.reps = arr; console.log('ensureCoreData: reps fetched =', arr.length);
                    try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
                }
            } catch(e){ console.warn('ensureCoreData: فشل قراءة المجموعات القياسية', e); }

            // إذا لا تزال فارغة نحاول أسماء قديمة مجدداً وننسخ للقياسية إن وجدناها
            const stillNeedCust = !state.customers || state.customers.length === 0;
            const stillNeedPL = !state.priceLists || state.priceLists.length === 0;
            if (stillNeedCust || stillNeedPL) {
                console.log('ensureCoreData: محاولة عبر أسماء Legacy مباشرة');
                try {
                    if (stillNeedCust) {
                        const legacyCustNames = ['Customers','customers_old'];
                        for (const cname of legacyCustNames) {
                            try {
                                const snap = await db.collection(cname).get();
                                if (!snap.empty) {
                                    const batch = db.batch(); const arr=[];
                                    snap.forEach(doc => { const d=doc.data(); d._legacy=true; d._id=doc.id; arr.push(d); const ref=db.collection('customers').doc(doc.id); batch.set(ref, { name:d.name||'', phone:d.phone||'', taxNumber:d.taxNumber||'', requiresTaxFiling:!!d.requiresTaxFiling, priceListId:d.priceListId||'', balance:Number(d.balance||0), createdAt: d.createdAt||serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                    await batch.commit();
                                    state.customers = arr; console.log('ensureCoreData: imported legacy customers from', cname, 'count=', arr.length);
                                    try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
                                    break;
                                }
                            } catch(err){ /* ignore */ }
                        }
                    }
                    if (stillNeedPL) {
                        const legacyPLNames = ['PriceLists','price_lists'];
                        for (const cname of legacyPLNames) {
                            try {
                                const snap = await db.collection(cname).get();
                                if (!snap.empty) {
                                    const batch = db.batch(); const arr=[];
                                    snap.forEach(doc => { const d=doc.data(); d._legacy=true; d.id=doc.id; arr.push(d); const ref=db.collection('priceLists').doc(doc.id); batch.set(ref, { name: d.name||d.title||'قائمة', productPrices: d.productPrices||d.prices||{}, createdAt: d.createdAt||serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                    await batch.commit();
                                    state.priceLists = arr; console.log('ensureCoreData: imported legacy priceLists from', cname, 'count=', arr.length);
                                    try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                    try { updateAllPriceListDropdowns(); } catch(e){}
                                    break;
                                }
                            } catch(err){ /* ignore */ }
                        }
                    }
                } catch(e){ console.warn('ensureCoreData legacy phase error', e); }
            }

            // مرحلة أخيرة: استرجاع من النسخ المحلية المخزنة إن ما زال فارغ
            const finalNeedCust = !state.customers || state.customers.length === 0;
            const finalNeedPL = !state.priceLists || state.priceLists.length === 0;
            const finalNeedProd = !state.products || state.products.length === 0;
            if (finalNeedCust || finalNeedPL || finalNeedProd) {
                console.log('ensureCoreData: محاولة من النسخ المحلية');
                try {
                    const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('app_state_backup_')).sort();
                    if (backupKeys.length) {
                        const latest = localStorage.getItem(backupKeys[backupKeys.length-1]);
                        if (latest) {
                            const parsed = JSON.parse(latest);
                            const batch = db.batch();
                            if (finalNeedCust && Array.isArray(parsed.customers) && parsed.customers.length) {
                                parsed.customers.forEach(c => { if (!c || !c.name) return; const id = c.id || c._id || c.name.replace(/\s+/g,'_'); const ref=db.collection('customers').doc(id); batch.set(ref,{ name:c.name, phone:c.phone||'', taxNumber:c.taxNumber||'', requiresTaxFiling:!!c.requiresTaxFiling, priceListId:c.priceListId||'', balance:Number(c.balance||0), createdAt: serverTs(), updatedAt: serverTs() },{ merge:true}); });
                                state.customers = parsed.customers.map(c => ({...c, _id: c.id||c._id||c.name.replace(/\s+/g,'_')}));
                            }
                            if (finalNeedPL && Array.isArray(parsed.priceLists) && parsed.priceLists.length) {
                                parsed.priceLists.forEach(pl => { if (!pl || !pl.name) return; const id = pl.id || pl.name.replace(/\s+/g,'_'); const ref=db.collection('priceLists').doc(id); batch.set(ref,{ name: pl.name, productPrices: pl.productPrices||{}, createdAt: serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                state.priceLists = parsed.priceLists.map(pl => ({...pl, id: pl.id||pl.name.replace(/\s+/g,'_')}));
                            }
                            if (finalNeedProd && Array.isArray(parsed.products) && parsed.products.length) {
                                parsed.products.forEach(p => { if (!p || !p.name) return; const id = p.id || p._id || p.sku || p.name.replace(/\s+/g,'_'); const ref=db.collection('products').doc(id); batch.set(ref,{ name:p.name, sku:p.sku||id, price:Number(p.price||0), cost:Number(p.cost||p.price||0), unit:p.unit||'وحدة', active:p.active!==false, createdAt: serverTs(), updatedAt: serverTs() }, { merge:true }); });
                                state.products = parsed.products.map(p => ({...p, _id: p.id||p._id||p.sku||p.name.replace(/\s+/g,'_')}));
                            }
                            if (!batch._ops || batch._ops.length) { await batch.commit(); }
                            if (state.customers && state.customers.length) { try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){} }
                            if (state.priceLists && state.priceLists.length) { try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){} try { updateAllPriceListDropdowns(); } catch(e){} }
                            if (state.products && state.products.length) { try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){} }
                            console.log('ensureCoreData: استرجاع من النسخ المحلية مكتمل');
                        }
                    }
                    // محاولة إضافية: استخراج مباشرة من مفاتيح قديمة محتملة إذا لا زال ناقص
                    const stillNeedAfterBackupCust = !state.customers || state.customers.length === 0;
                    const stillNeedAfterBackupPL = !state.priceLists || state.priceLists.length === 0;
                    const stillNeedAfterBackupProd = !state.products || state.products.length === 0;
                    if (stillNeedAfterBackupCust || stillNeedAfterBackupPL || stillNeedAfterBackupProd){
                        const legacyRecovered = recoverLegacyLocalData();
                        const batch2 = db.batch();
                        if (stillNeedAfterBackupProd && legacyRecovered.products.length){
                            legacyRecovered.products.forEach(p => {
                                if (!p || !p.name) return; const id = p.id || p._id || p.sku || slugId(p.name);
                                batch2.set(db.collection('products').doc(id), {
                                    name: p.name || p.title || 'منتج',
                                    sku: p.sku || p.code || id,
                                    price: Number(p.price || p.unitPrice || 0),
                                    cost: Number(p.cost || p.purchaseCost || p.price || 0),
                                    unit: p.unit || 'وحدة',
                                    active: p.active !== false,
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.products = legacyRecovered.products.map(p => ({
                                _id: p.id || p._id || p.sku || slugId(p.name),
                                name: p.name || p.title || 'منتج',
                                sku: p.sku || p.code || (p.id || ''),
                                price: Number(p.price || p.unitPrice || 0),
                                cost: Number(p.cost || p.purchaseCost || p.price || 0),
                                unit: p.unit || 'وحدة',
                                active: p.active !== false
                            }));
                        }
                        if (stillNeedAfterBackupPL && legacyRecovered.priceLists.length){
                            legacyRecovered.priceLists.forEach(pl => {
                                const id = pl.id || pl.code || slugId(pl.name,'pl_'+Date.now());
                                batch2.set(db.collection('priceLists').doc(id), {
                                    name: pl.name || pl.title || 'قائمة أسعار',
                                    productPrices: pl.productPrices || pl.prices || pl.map || {},
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.priceLists = legacyRecovered.priceLists.map(pl => ({
                                id: pl.id || pl.code || slugId(pl.name),
                                name: pl.name || pl.title || 'قائمة أسعار',
                                productPrices: pl.productPrices || pl.prices || pl.map || {}
                            }));
                        }
                        const hasCustNow = state.customers && state.customers.length;
                        if (stillNeedAfterBackupCust && !hasCustNow && legacyRecovered.customers && legacyRecovered.customers.length){
                            legacyRecovered.customers.forEach(c => {
                                if (!c || !c.name) return; const id = c.id || c._id || slugId(c.name);
                                batch2.set(db.collection('customers').doc(id), {
                                    name: c.name,
                                    phone: c.phone || '',
                                    taxNumber: c.taxNumber || '',
                                    requiresTaxFiling: !!c.requiresTaxFiling,
                                    priceListId: c.priceListId || '',
                                    balance: Number(c.balance || 0),
                                    createdAt: serverTs(),
                                    updatedAt: serverTs()
                                }, { merge:true });
                            });
                            state.customers = legacyRecovered.customers.map(c => ({...c, _id: c.id || c._id || slugId(c.name)}));
                        }
                        if (batch2._mutations && batch2._mutations.length){
                            await batch2.commit();
                            console.log('تم استرجاع بيانات إضافية من مفاتيح محلية قديمة');
                        }
                        if (state.products && state.products.length){ try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){} }
                        if (state.priceLists && state.priceLists.length){ try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){} try { updateAllPriceListDropdowns(); } catch(e){} }
                        if (state.customers && state.customers.length){ try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){} }
                    }
                    // أولاً: استيراد تلقائي من النسخة المدمجة داخل الملف (إن لم تكن القوائم موجودة في السحابة)
                    let needAfterAllPL = !state.priceLists || state.priceLists.length === 0;
                    if (needAfterAllPL && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025) && window.EMBEDDED_PRICE_LISTS_BACKUP_2025.length){
                        try {
                            const res = await importBackupObject({ priceLists: window.EMBEDDED_PRICE_LISTS_BACKUP_2025 }, {
                                importCustomers:false, importProducts:false, importPriceLists:true,
                                importSales:false, importReps:false, importPromotions:false,
                                importSettings:false, importDispatchNotes:false, importStockEntries:false, importNotifications:false
                            });
                            if (res && res.ok && res.counts && res.counts.priceLists > 0){
                                console.log('✅ تم استيراد قوائم الأسعار من النسخة المدمجة:', res.counts.priceLists);
                                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                try { updateAllPriceListDropdowns(); } catch(e){}
                            }
                        } catch(e){ console.warn('فشل استيراد القوائم من النسخة المدمجة', e); }
                        needAfterAllPL = !state.priceLists || state.priceLists.length === 0;
                    }

                    // محاولة أخيرة: جلب من ملف HTML قديم في نفس المجلد (1458.html)
                    if (needAfterAllPL) {
                        try {
                            const imported = await importPriceListsFromLegacyHtmlFile('1458.html');
                            if (imported > 0) {
                                console.log('✅ تم استيراد قوائم الأسعار من 1458.html:', imported);
                                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                                try { updateAllPriceListDropdowns(); } catch(e){}
                            } else {
                                console.log('لم يتم العثور على قوائم أسعار داخل 1458.html؛ يمكنك استدعاء window.importPriceListsFromLocalFile() لاختيار ملف يدويًا');
                            }
                        } catch(e){ console.warn('فشل استيراد قوائم الأسعار من 1458.html', e); }
                    }
                } catch(e){ console.warn('ensureCoreData local backup phase error', e); }
            }
            if (state.customers && state.customers.length && state.priceLists && state.priceLists.length && state.products && state.products.length && state.reps && state.reps.length) window.__coreDataEnsured = true;
        }
        function scheduleEnsureCoreData(){
            setTimeout(ensureCoreData, 1500);
            // تشغيل هجرة مبيعات من مستند المستخدم (إن وُجدت) بعد تسجيل الدخول بقليل
            setTimeout(function(){ try { migrateSalesFromUserDocIfFound(); } catch(e){} }, 3000);
            setTimeout(ensureCoreData, 5000);
            setTimeout(ensureCoreData, 12000);
        }

        // ===== استيراد من shared/public_app_state.appState إلى المجموعات القياسية (مع تنظيف الافتراضيات) =====
        function slugId(name, fallback){
            try { return (name||'').toString().trim().toLowerCase().replace(/[^a-z0-9\u0600-\u06FF]+/gi,'_').replace(/^_+|_+$/g,'') || fallback || (Date.now()+'');} catch(e){ return fallback || (Date.now()+''); }
        }
        // استرجاع شامل من مفاتيح localStorage المحتملة (منتجات / قوائم أسعار / عملاء)
        function recoverLegacyLocalData(){
            const possibleProductKeys = [ 'products','product_list','app_products','products_data','finished_products','cost_finished' ];
            const possiblePriceListKeys = [ 'priceLists','price_lists','app_priceLists','priceListsData','price_lists_data','pricing_tables' ];
            const possibleCustomerKeys = [ 'customers','customer_list','app_customers','customers_data' ];
            const products = [];
            const priceLists = [];
            const customers = [];
            function tryParse(key){
                try { const raw = localStorage.getItem(key); if (!raw) return null; return JSON.parse(raw); } catch(e){ return null; }
            }
            possibleProductKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(p => { if (p && (p.name||p.title)) products.push(p); }); }
                else if (typeof val === 'object') { Object.keys(val).forEach(id => { const p=val[id]; if (p && (p.name||p.title)) products.push(Object.assign({ id }, p)); }); }
            });
            possiblePriceListKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(pl => { if (pl && (pl.name||pl.title)) priceLists.push(pl); }); }
                else if (typeof val === 'object') {
                    const looksMap = Object.values(val).every(v => typeof v === 'number');
                    if (looksMap) priceLists.push({ name: 'Legacy List', productPrices: val });
                    else Object.keys(val).forEach(id => { const pl=val[id]; if (pl && (pl.name||pl.title)) priceLists.push(Object.assign({ id }, pl)); else if (pl && typeof pl==='object' && Object.values(pl).every(v=>typeof v==='number')) priceLists.push({ id, name:id, productPrices: pl }); });
                }
            });
            possibleCustomerKeys.forEach(k => {
                const val = tryParse(k); if (!val) return;
                if (Array.isArray(val)) { val.forEach(c => { if (c && c.name) customers.push(c); }); }
                else if (typeof val === 'object') { Object.keys(val).forEach(id => { const c=val[id]; if (c && c.name) customers.push(Object.assign({ id }, c)); }); }
            });
            console.log('recoverLegacyLocalData: products=', products.length, 'priceLists=', priceLists.length, 'customers=', customers.length);
            return { products, priceLists, customers };
        }
        // ===== استيراد قوائم الأسعار من ملف HTML قديم (مثلاً 1458.html) =====
        function normalizePriceListsArray(arr){
            try {
                if (!Array.isArray(arr)) return [];
                return arr.map(pl => ({
                    id: pl.id || pl.code || slugId(pl.name, undefined),
                    name: pl.name || pl.title || 'قائمة أسعار',
                    productPrices: pl.productPrices || pl.prices || pl.map || {}
                })).filter(pl => pl && pl.name && pl.productPrices && typeof pl.productPrices === 'object');
            } catch(e){ return []; }
        }

        function tryParseJsonLoose(text){
            try { return JSON.parse(text); } catch(e) {}
            try { return JSON.parse(text.replace(/\,\s*}/g,'}').replace(/\,\s*]/g,']')); } catch(e) {}
            try {
                // replace single quotes cautiously (only around keys/strings)
                const t = text.replace(/"/g,'\"').replace(/'([^']*)'/g,'"$1"');
                return JSON.parse(t);
            } catch(e) { return null; }
        }

        // تم حذف النسخ الاحتياطية والقوائم القديمة بناءً على طلب المستخدم
        window.EMBEDDED_PRICE_LISTS_BACKUP_2025 = [];
        window.EMBEDDED_FULL_BACKUP = { customers:[], products:[], priceLists:[], reps:[], promotions:[], sales:[] };
        async function importEmbeddedBackupIfNeeded(){ return { ok:true, disabled:true }; }
        // تمت إزالة منطق الاستيراد القديم بالكامل هنا حسب الطلب.

        // ===== استيراد نسخة احتياطية كاملة (JSON) إلى المجموعات القياسية =====
        async function importBackupObject(backup, options){
            const opts = Object.assign({
                importCustomers: true,
                importProducts: true,
                importPriceLists: true,
                importSales: true,
                importReps: true,
                importPromotions: true,
                importSettings: true,
                importDispatchNotes: true,
                importStockEntries: true,
                importNotifications: true
            }, options||{});
            if (!db) { console.warn('Firestore غير جاهز'); return { ok:false, reason:'no-db' }; }
            const counts = { customers:0, products:0, priceLists:0, sales:0, reps:0, promotions:0, settings:0, dispatchNotes:0, stockEntries:0, notifications:0 };
            let batch = db.batch();
            let pending = 0;
            async function commitIfNeeded(force){ if (force || pending >= 450) { await batch.commit(); batch = db.batch(); pending = 0; } }

            try {
                if (opts.importCustomers && Array.isArray(backup.customers)){
                    for (const c of backup.customers){
                        const id = c.id || slugId(c.name);
                        const ref = db.collection('customers').doc(id);
                        batch.set(ref, {
                            name: c.name || '',
                            phone: c.phone || '',
                            taxNumber: c.taxNumber || '',
                            requiresTaxFiling: !!c.requiresTaxFiling,
                            priceListId: c.priceListId || '',
                            repName: c.repName || '',
                            address: c.address || '',
                            createdAt: c.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.customers++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importProducts && Array.isArray(backup.products)){
                    for (const p of backup.products){
                        const id = (p.id || slugId(p.name)).toString();
                        const ref = db.collection('products').doc(id);
                        batch.set(ref, {
                            name: p.name || '',
                            sku: p.sku || id,
                            price: Number(p.price||0),
                            cost: Number(p.cost||0),
                            unit: p.unit || 'وحدة',
                            active: p.active !== false,
                            createdAt: p.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.products++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importPriceLists && Array.isArray(backup.priceLists)){
                    for (const pl of backup.priceLists){
                        const id = pl.id || slugId(pl.name);
                        const ref = db.collection('priceLists').doc(id);
                        batch.set(ref, {
                            name: pl.name || id,
                            productPrices: pl.productPrices || pl.prices || {},
                            createdAt: pl.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.priceLists++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importReps && Array.isArray(backup.reps)){
                    for (const r of backup.reps){
                        const id = r.id || slugId(r.name);
                        const ref = db.collection('reps').doc(id);
                        batch.set(ref, {
                            name: r.name || '',
                            serial: r.serial || '',
                            target: Number(r.target||0),
                            nextInvoiceNumber: (r.nextInvoiceNumber==null? null : r.nextInvoiceNumber),
                            createdAt: r.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.reps++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importSales && Array.isArray(backup.sales)){
                    for (const s of backup.sales){
                        const sid = (s.id || '').toString() || undefined;
                        const ref = sid ? db.collection('sales').doc(sid) : db.collection('sales').doc();
                        const items = Array.isArray(s.items) ? s.items.map(it => ({
                            productId: it.productId || it.code || '',
                            qty: Number(it.qty!=null ? it.qty : (it.quantity||0)),
                            price: Number(it.price||0)
                        })) : [];
                        batch.set(ref, {
                            invoiceNumber: s.invoiceNumber || null,
                            customerId: s.customerId || null,
                            repName: s.repName || s.repId || '',
                            items,
                            total: Number(s.total||0),
                            paidAmount: Number(s.paidAmount||0),
                            status: s.status || 'due',
                            discountPercent: Number(s.discountPercent||s.discount||0),
                            taxFilingStatus: s.taxFilingStatus || '',
                            date: s.date || new Date().toISOString(),
                            notes: s.notes || '',
                            includeInCash: !!s.includeInCash,
                            collectionReportCreated: !!s.collectionReportCreated,
                            paidToSafe: !!s.paidToSafe,
                            firstPayment: s.firstPayment!=null ? Number(s.firstPayment) : undefined,
                            secondPayment: s.secondPayment!=null ? Number(s.secondPayment) : undefined,
                            collectionDiscount: s.collectionDiscount!=null ? Number(s.collectionDiscount) : undefined,
                            collectionNumber: s.collectionNumber!=null ? s.collectionNumber : undefined,
                            createdAt: s.createdAt || serverTs(),
                            updatedAt: serverTs()
                        }, { merge:true });
                        counts.sales++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importPromotions && Array.isArray(backup.promotions)){
                    for (const pr of backup.promotions){
                        const id = pr.id || slugId(pr.name);
                        const ref = db.collection('promotions').doc(id);
                        batch.set(ref, Object.assign({}, pr, { updatedAt: serverTs() }), { merge:true });
                        counts.promotions++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importSettings && backup.settings){
                    const sid = backup.settings.id || 'global-settings';
                    const ref = db.collection('settings').doc(sid);
                    batch.set(ref, Object.assign({}, backup.settings, { updatedAt: serverTs() }), { merge:true });
                    counts.settings++; pending++; await commitIfNeeded(false);
                }

                if (opts.importDispatchNotes && Array.isArray(backup.dispatchNotes)){
                    for (const dn of backup.dispatchNotes){
                        const did = (dn.id || '').toString() || undefined;
                        const ref = did ? db.collection('dispatchNotes').doc(did) : db.collection('dispatchNotes').doc();
                        batch.set(ref, Object.assign({}, dn, { updatedAt: serverTs() }), { merge:true });
                        counts.dispatchNotes++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importStockEntries && backup.stockEntries && typeof backup.stockEntries === 'object'){
                    for (const d of Object.keys(backup.stockEntries)){
                        const ref = db.collection('stockEntries').doc(d);
                        batch.set(ref, { date: d, entries: backup.stockEntries[d], updatedAt: serverTs() }, { merge:true });
                        counts.stockEntries++; pending++; await commitIfNeeded(false);
                    }
                }

                if (opts.importNotifications && Array.isArray(backup.notifications)){
                    for (const n of backup.notifications){
                        const idn = n.id || (Date.now()+Math.random()).toString(36);
                        const ref = db.collection('notifications').doc(idn);
                        batch.set(ref, Object.assign({}, n), { merge:true });
                        counts.notifications++; pending++; await commitIfNeeded(false);
                    }
                }

                await commitIfNeeded(true);
            } catch(e){ console.warn('importBackupObject error', e); return { ok:false, error:e, counts }; }

            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
            try { updateAllPriceListDropdowns(); } catch(e){}
            try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
            return { ok:true, counts };
        }

        function parseBackupText(text){
            try { return JSON.parse(text); } catch(e){
                try { return tryParseJsonLoose(text); } catch(e2){ return null; }
            }
        }

        window.importBackupJson = async function(input, options){
            try {
                const backup = (typeof input === 'string') ? parseBackupText(input) : input;
                if (!backup || typeof backup !== 'object') { alert('تعذر قراءة النسخة الاحتياطية'); return false; }
                const res = await importBackupObject(backup, options);
                if (res && res.ok) { alert('تم الاستيراد بنجاح'); return true; }
                alert('فشل الاستيراد'); return false;
            } catch(e){ console.warn('importBackupJson failed', e); alert('حدث خطأ أثناء الاستيراد'); return false; }
        };

        window.importBackupFromLocalFile = function(){
            try {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json,.txt,.html';
                input.onchange = async function(){
                    const f = this.files && this.files[0]; if (!f) return;
                    const reader = new FileReader();
                    reader.onload = async function(){
                        const txt = reader.result;
                        const ok = await window.importBackupJson(txt);
                        if (ok) console.log('Backup imported successfully');
                    };
                    reader.readAsText(f, 'utf-8');
                };
                input.click();
            } catch(e){ console.warn('importBackupFromLocalFile failed', e); }
        };
        async function importFromSharedAppState(options){
            const opts = Object.assign({ force: true, cleanupDefaults: true }, options||{});
            if (!db) { console.warn('Firestore غير جاهز'); return false; }
            const doc = await db.collection('shared').doc('public_app_state').get().catch(()=>null);
            if (!doc || !doc.exists) { console.log('shared/public_app_state غير موجود'); return false; }
            const data = doc.data() || {}; const as = data.appState || {};
            const custArr = Array.isArray(as.customers) ? as.customers : [];
            const plArr = Array.isArray(as.priceLists) ? as.priceLists : [];
            const repsArr = Array.isArray(as.reps) ? as.reps : [];
            if (custArr.length === 0 && plArr.length === 0 && repsArr.length === 0) { console.log('لا يوجد customers/priceLists/reps داخل appState'); return false; }

            // اجلب الموجود حالياً لتحديد ما إذا كنا سننظف الافتراضيات
            const [currCustSnap, currPlSnap, currRepsSnap] = await Promise.all([
                db.collection('customers').get(), db.collection('priceLists').get(), db.collection('reps').get()
            ]);
            const existingCustIds = new Set(currCustSnap.docs.map(d=>d.id));
            const existingPlIds = new Set(currPlSnap.docs.map(d=>d.id));
            const existingRepIds = new Set(currRepsSnap.docs.map(d=>d.id));

            const batch = db.batch();
            const targetCustIds = new Set();
            const targetPlIds = new Set();
            const targetRepIds = new Set();

            custArr.forEach(c => {
                const id = c.id || c._id || slugId(c.name, undefined);
                if (!id) return;
                targetCustIds.add(id);
                batch.set(db.collection('customers').doc(id), {
                    name: c.name || '',
                    phone: c.phone || '',
                    taxNumber: c.taxNumber || '',
                    requiresTaxFiling: !!c.requiresTaxFiling,
                    priceListId: c.priceListId || '',
                    balance: Number(c.balance||0),
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            plArr.forEach(pl => {
                const id = pl.id || slugId(pl.name, undefined);
                if (!id) return;
                targetPlIds.add(id);
                batch.set(db.collection('priceLists').doc(id), {
                    name: pl.name || 'قائمة',
                    productPrices: pl.productPrices || {},
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            repsArr.forEach(r => {
                const id = r.id || slugId(r.name, undefined);
                if (!id) return;
                targetRepIds.add(id);
                batch.set(db.collection('reps').doc(id), {
                    name: r.name || '',
                    serial: r.serial || r.code || '',
                    target: Number(r.target||0),
                    nextInvoice: Number(r.nextInvoice||r.next_invoice||0),
                    active: r.active !== false,
                    createdAt: serverTs(),
                    updatedAt: serverTs()
                }, { merge: true });
            });

            // تنظيف الافتراضيات التي أضفناها سابقاً إذا لم تكن ضمن البيانات الحقيقة
            if (opts.cleanupDefaults) {
                const defaultCustIds = ['CUST001','CUST002','CUST003'];
                defaultCustIds.forEach(id => { if (existingCustIds.has(id) && !targetCustIds.has(id)) batch.delete(db.collection('customers').doc(id)); });
                const defaultPlIds = ['retail','wholesale'];
                defaultPlIds.forEach(id => { if (existingPlIds.has(id) && !targetPlIds.has(id)) batch.delete(db.collection('priceLists').doc(id)); });
                ['REP1','REP2','REP3'].forEach(id => { if (existingRepIds.has(id) && !targetRepIds.has(id)) batch.delete(db.collection('reps').doc(id)); });
            }

            await batch.commit();
            // حدّث الحالة المحلية للعرض الفوري
            state.customers = custArr.map(c => ({...c, _id: c.id || c._id || slugId(c.name)}));
            state.priceLists = plArr.map(pl => ({...pl, id: pl.id || slugId(pl.name)}));
            state.reps = repsArr.map(r => ({...r, id: r.id || slugId(r.name)}));
            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
            try { updateAllPriceListDropdowns(); } catch(e){}
            try { if (typeof renderReps === 'function') renderReps(); } catch(e){}
            console.log('استيراد appState -> المجموعات اكتمل');
            return true;
        }
        window.importFromSharedAppState = importFromSharedAppState;

        // ===== هجرة البيانات القديمة (تشغيل يدوي أو عند الحاجة) =====
        async function migrateLegacyCollections(){
            if (!db) { console.warn('Firestore غير جاهز'); return; }
            const role = getUserRole();
            if (role !== 'admin') { alert('هذه العملية للمشرف فقط'); return; }
            console.log('بدء هجرة البيانات القديمة إلى المجموعات القياسية');
            const legacySets = [
                { src: 'Customers', dest: 'customers', map: d => ({
                    name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
                    priceListId: d.priceListId || d.pricelist || d.price_list_id || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'customers_old', dest: 'customers', map: d => ({
                    name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
                    priceListId: d.priceListId || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'PriceLists', dest: 'priceLists', map: d => ({
                    name: d.name||d.title||'قائمة', productPrices: d.productPrices || d.prices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })},
                { src: 'price_lists', dest: 'priceLists', map: d => ({
                    name: d.name||'قائمة', productPrices: d.productPrices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
                })}
            ];
            let migratedCustomers = 0, migratedPriceLists = 0;
            for (const set of legacySets) {
                try {
                    const snap = await db.collection(set.src).get();
                    if (snap.empty) continue;
                    for (const doc of snap.docs) {
                        const data = doc.data() || {};
                        const destRef = db.collection(set.dest).doc(doc.id);
                        const exists = await destRef.get();
                        if (exists.exists) continue; // تجنب التكرار
                        await destRef.set(set.map(data), { merge: true });
                        if (set.dest === 'customers') migratedCustomers++; else if (set.dest === 'priceLists') migratedPriceLists++;
                    }
                } catch(e){ console.warn('فشل قراءة المجموعة القديمة', set.src, e); }
            }
            console.log(`انتهت الهجرة: عملاء +=${migratedCustomers}, قوائم أسعار +=${migratedPriceLists}`);
            alert(`انتهت الهجرة بنجاح\nعملاء تمت إضافتهم: ${migratedCustomers}\nقوائم أسعار تمت إضافتها: ${migratedPriceLists}`);
            try { if (typeof renderCustomerList === 'function') renderCustomerList(''); } catch(e){}
            try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
        }
        window.migrateLegacyCollections = migrateLegacyCollections; // إتاحة في الكونسول

        // ===== الحضور Presence كتابة وتحديث =====
        function setPresenceOnline(){
            try {
                if (!db || !auth || !auth.currentUser) return;
                // لا تكتب حضوراً لو المستخدم مراجِع (قراءة فقط)
                try { if (typeof getUserRole === 'function' && getUserRole() === 'reviewer') return; } catch(_){}
                const u = auth.currentUser;
                db.collection('presence').doc(u.uid).set({
                    uid: u.uid,
                    email: (u.email||'').toLowerCase(),
                    online: true,
                    lastActive: serverTs()
                }, { merge: true }).catch(e=>console.warn('presence set error', e));
            } catch(e){ console.warn('setPresenceOnline failed', e); }
        }
        function setPresenceOffline(){
            try {
                if (!db || !auth || !auth.currentUser) return;
                try { if (typeof getUserRole === 'function' && getUserRole() === 'reviewer') return; } catch(_){}
                const u = auth.currentUser;
                db.collection('presence').doc(u.uid).set({
                    online: false,
                    lastActive: serverTs()
                }, { merge: true }).catch(e=>console.warn('presence unset error', e));
            } catch(e){ console.warn('setPresenceOffline failed', e); }
        }
        window.addEventListener('beforeunload', function(){ try { setPresenceOffline(); } catch(e){} });


        // Firebase save/load helpers for cloud sync are defined later in the file
        // (they are implemented with Firebase Auth + Firestore where available).

        // LocalStorage access helpers — these suppress local reads/writes when CLOUD_ONLY is enabled.
        function lsGet(key) {
            try {
                if (window.CLOUD_ONLY) return null;
                return localStorage.getItem(key);
            } catch (e) { return null; }
        }
        function lsSet(key, value) {
            try {
                if (window.CLOUD_ONLY) {
                    console.debug('CLOUD_ONLY: suppressed localStorage.setItem', key);
                    return;
                }
                localStorage.setItem(key, value);
            } catch (e) { /* ignore */ }
        }
        function lsRemove(key) {
            try {
                if (window.CLOUD_ONLY) {
                    console.debug('CLOUD_ONLY: suppressed localStorage.removeItem', key);
                    return;
                }
                localStorage.removeItem(key);
            } catch (e) { /* ignore */ }
        }

        // ===== Helpers: Sales cache (used when reads are blocked) =====
        function getCachedSales(){
            try { const raw = localStorage.getItem('cache_sales'); return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
        }
        function setCachedSales(arr){
            try { localStorage.setItem('cache_sales', JSON.stringify(Array.isArray(arr)? arr : [])); } catch(e){}
        }
        function upsertCachedSale(sale){
            try {
                if (!sale || !sale.id) return;
                const list = getCachedSales();
                const idx = list.findIndex(s => s && (s.id === sale.id || s._id === sale.id));
                if (idx >= 0) list[idx] = sale; else list.unshift(sale);
                if (list.length > 500) list.length = 500;
                setCachedSales(list);
            } catch(e){}
        }
        function removeCachedSale(id){
            try {
                const list = getCachedSales().filter(s => s && s.id !== id && s._id !== id);
                setCachedSales(list);
            } catch(e){}
        }

        // ===== Permission-denied resilience =====
        window.__permissionErrorCounts = window.__permissionErrorCounts || {};
        function handlePermissionDenied(coll){
            try {
                const c = window.__permissionErrorCounts;
                c[coll] = (c[coll] || 0) + 1;
                const core = ['sales','customers','products','priceLists'];
                const coreFailures = core.filter(x => c[x] && c[x] > 0).length;
                // If all core collections failed at least once, render cached data immediately
                if (coreFailures === core.length) {
                    ensureCachedDataRendered();
                    showPermissionBanner();
                } else if (c[coll] >= 2) {
                    // After 2 failures of same coll, still show banner
                    showPermissionBanner();
                }
            } catch(e){ /* ignore */ }
        }
        function preloadCachedCollections(){
            try {
                if (!window.state) window.state = {};
                // Load cached customers/products/priceLists if empty
                if (!state.customers || !state.customers.length){
                    const raw = localStorage.getItem('cache_customers');
                    if (raw){ try { state.customers = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.products || !state.products.length){
                    const raw = localStorage.getItem('cache_products');
                    if (raw){ try { state.products = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.priceLists || !state.priceLists.length){
                    const raw = localStorage.getItem('cache_priceLists');
                    if (raw){ try { state.priceLists = JSON.parse(raw)||[]; } catch(e){} }
                }
                if (!state.sales || !state.sales.length){
                    const s = getCachedSales();
                    if (s && s.length) state.sales = s;
                }
                // Render quickly if we hydrated anything
                try { if (typeof renderCustomerList === 'function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                try { if (typeof renderProductList === 'function') renderProductList(''); } catch(e){}
                try { if (typeof renderPriceListsPage === 'function') renderPriceListsPage(); } catch(e){}
                try {
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    if (typeof renderAllSales === 'function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
                } catch(e){}
            } catch(e){ /* ignore */ }
        }
        function ensureCachedDataRendered(){
            preloadCachedCollections();
        }
        function showPermissionBanner(){
            try {
                let bn = document.getElementById('permission-banner');
                if (!bn){
                    bn = document.createElement('div');
                    bn.id = 'permission-banner';
                    bn.style.cssText = 'position:fixed;top:72px;left:0;right:0;z-index:120;background:#fee;border:1px solid #f99;padding:6px 10px;font-size:14px;text-align:center;font-weight:600;color:#b00000';
                    bn.innerHTML = '⚠️ مشكلة صلاحيات Firestore: يتم عرض البيانات من النسخة المحلية فقط. حدث القواعد ثم أعد التحميل.';
                    document.body.appendChild(bn);
                }
            } catch(e){ /* ignore */ }
        }

        // تحديث جميع قوائم اختيار قوائم الأسعار في الواجهة
        function updateAllPriceListDropdowns(){
            try {
                const els = [
                    document.getElementById('customer-price-list')
                ].filter(Boolean);
                els.forEach(el => { if (typeof populatePriceListDropdown === 'function') populatePriceListDropdown(el, el.value || ''); });
            } catch(e){ /* ignore */ }
        }

        // تحديث جميع قوائم اختيار العملاء في الواجهة
        function updateAllCustomerDropdowns(){
            try {
                const els = [
                    document.getElementById('sale-customer'),
                    document.getElementById('spreadsheet-customer') || document.getElementById('spreadsheet-customer-select') || document.getElementById('spreadsheetCustomerSelect')
                ].filter(Boolean);
                els.forEach(el => {
                    const current = el.value || '';
                    if (typeof populateCustomerDropdown === 'function') populateCustomerDropdown(el, current);
                });
            } catch(e){ /* ignore */ }
        }

        // ===== إقفال شهر وترحيل الديون =====
        function __formatPeriod(dateObj){
            const y = dateObj.getFullYear();
            const m = (dateObj.getMonth()+1).toString().padStart(2,'0');
            return `${y}-${m}`;
        }
        function defaultPrevMonthPeriod(){
            const d = new Date(); d.setDate(1); d.setMonth(d.getMonth()-1);
            return __formatPeriod(d);
        }
        function periodToRange(period){
            // period: 'YYYY-MM'
            try {
                const [y,m] = period.split('-').map(Number);
                const start = new Date(y, m-1, 1, 0,0,0,0);
                const end = new Date(y, m, 0, 23,59,59,999); // last day of month
                return { startISO: start.toISOString(), endISO: end.toISOString() };
            } catch(e){
                const d = new Date();
                return { startISO: new Date(d.getFullYear(), d.getMonth(), 1).toISOString(), endISO: new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999).toISOString() };
            }
        }
        function nextPeriod(period){
            try {
                const [y,m] = period.split('-').map(Number);
                const d = new Date(y, m-1, 1); d.setMonth(d.getMonth()+1);
                return __formatPeriod(d);
            } catch(e){ return defaultPrevMonthPeriod(); }
        }

        async function computeClosingBalances(period){
            if (!db) throw new Error('Firestore غير جاهز');
            const { endISO } = periodToRange(period);
            const snap = await db.collection('sales').where('date','<=', endISO).get();
            const byCustomer = new Map();
            snap.forEach(doc => {
                const s = doc.data() || {};
                const cid = s.customerId || 'UNKNOWN';
                if (s.status === 'return') return;
                const total = Number(s.total||0);
                const paid = Number(s.paidAmount||0);
                const out = Math.max(total - paid, 0);
                if (!byCustomer.has(cid)) byCustomer.set(cid, 0);
                byCustomer.set(cid, byCustomer.get(cid) + out);
            });
            const result = [];
            let totalOutstanding = 0;
            byCustomer.forEach((amt, cid) => {
                const rounded = Math.round(amt*100)/100;
                totalOutstanding += rounded;
                const cu = (state.customers||[]).find(c => (c.id||c._id) === cid) || {};
                result.push({ customerId: cid, customerName: cu.name || cid, closing: rounded });
            });
            result.sort((a,b)=> (b.closing - a.closing));
            return { period, endISO, customers: result, totalOutstanding: Math.round(totalOutstanding*100)/100 };
        }

        async function lockMonthSales(period){
            const { startISO, endISO } = periodToRange(period);
            // قفل فواتير هذا الشهر فقط (ليس كل ما قبل نهاية الشهر)
            const snap = await db.collection('sales').where('date','>=', startISO).where('date','<=', endISO).get();
            let batch = db.batch(); let pending = 0; const BATCH_LIMIT = 450;
            for (const doc of snap.docs){
                batch.set(doc.ref, { locked: true, lockPeriod: period, lockedAt: serverTs(), lockedBy: (auth&&auth.currentUser)?auth.currentUser.uid:null }, { merge:true });
                pending++; if (pending >= BATCH_LIMIT){ await batch.commit(); batch = db.batch(); pending = 0; }
            }
            if (pending>0) await batch.commit();
        }

        async function performMonthClose(period){
            const role = getUserRole();
            if (role !== 'admin') { alert('إقفال الشهر متاح للمشرف فقط'); return { ok:false, reason:'not-admin' }; }
            const summary = await computeClosingBalances(period);
            const next = nextPeriod(period);
            // منع الإقفال المكرر لنفس الفترة
            const existing = await db.collection('monthlyClosings').doc(period).get().catch(()=>null);
            if (existing && existing.exists) { alert('تم إقفال هذا الشهر مسبقاً'); return { ok:false, reason:'already-closed' }; }

            // كتابة مستند الإقفال + تفاصيل العملاء كتصنيف فرعي
            await db.collection('monthlyClosings').doc(period).set({
                period,
                closedAt: serverTs(),
                closedBy: (auth&&auth.currentUser)? auth.currentUser.uid : null,
                totalCustomers: summary.customers.length,
                totalOutstanding: summary.totalOutstanding
            }, { merge:true });
            // كتابة تفاصيل العملاء
            {
                let batch = db.batch(); let pending = 0; const LIM = 450;
                for (const row of summary.customers){
                    const ref = db.collection('monthlyClosings').doc(period).collection('customers').doc(row.customerId || slugId(row.customerName));
                    batch.set(ref, { customerId: row.customerId, customerName: row.customerName, closing: row.closing }, { merge:true });
                    pending++; if (pending>=LIM){ await batch.commit(); batch = db.batch(); pending = 0; }
                }
                if (pending>0) await batch.commit();
            }
            // إنشاء أرصدة افتتاحية للشهر التالي
            {
                let batch = db.batch(); let pending = 0; const LIM = 450;
                for (const row of summary.customers){
                    const amount = Math.round(Number(row.closing||0)*100)/100;
                    if (!amount) continue;
                    const oid = `${row.customerId||slugId(row.customerName)}_${next}`;
                    const ref = db.collection('openingBalances').doc(oid);
                    batch.set(ref, {
                        customerId: row.customerId,
                        customerName: row.customerName,
                        period: next,
                        sourcePeriod: period,
                        amount,
                        createdAt: serverTs(),
                        createdBy: (auth&&auth.currentUser)?auth.currentUser.uid:null
                    }, { merge:true });
                    pending++; if (pending>=LIM){ await batch.commit(); batch = db.batch(); pending = 0; }
                }
                if (pending>0) await batch.commit();
            }

            // قفل فواتير الشهر
            await lockMonthSales(period);
            if (!arguments[1] || !arguments[1].silent) {
                alert('تم إقفال الشهر وترحيل الأرصدة الافتتاحية للشهر التالي');
            }
            return { ok:true, summary };
        }

        // إقفال الشهر السابق تلقائياً عند الدخول (Admin فقط)
        async function maybeAutoClosePreviousMonth(){
            try {
                if (getUserRole() !== 'admin') return;
                const now = new Date();
                const currentPeriod = __formatPeriod(now);
                const prevPeriod = defaultPrevMonthPeriod();
                // لا تُغلق إذا كنا في اليوم الأول ولم تُسجّل أي فواتير بعد (اختياري) — سنسمح بالإقفال دائماً إذا لم يوجد مستند إقفال
                const docRef = db.collection('monthlyClosings').doc(prevPeriod);
                const doc = await docRef.get();
                if (!doc.exists) {
                    await performMonthClose(prevPeriod, { silent: true });
                }
            } catch(e){ console.warn('maybeAutoClosePreviousMonth failed', e); }
        }

        // الفترة النشطة في الواجهة: يحفظها محلياً ويضبط فلاتر الصفحات (المبيعات)
        function setActivePeriod(period){
            try {
                window.state = window.state || {};
                state.activePeriod = period;
                try { localStorage.setItem('active_period', String(period)); } catch(e){}
                
                // اضبط فلتر تاريخ المبيعات لليوم الأول من الشهر المطلوب
                const salesDateInput = document.getElementById('search-sales-date');
                if (salesDateInput) {
                    salesDateInput.value = `${period}-01`;
                    try { salesDateInput.dispatchEvent(new Event('change')); } catch(e){}
                }
                
                // أعد رسم قائمة المبيعات مع الفلاتر النشطة
                try {
                    const textFilter = document.getElementById('search-sales-text')?.value || '';
                    const dateFilter = document.getElementById('search-sales-date')?.value || '';
                    const taxStatusFilter = document.getElementById('tax-status-filter')?.value || 'all';
                    
                    // إعادة تحديث الفواتير بناءً على الفترة النشطة الجديدة
                    if (typeof renderAllSales === 'function') {
                        renderAllSales(textFilter, dateFilter, taxStatusFilter);
                    }
                    if (typeof renderDashboard === 'function') renderDashboard();
                    if (typeof renderDebts === 'function') renderDebts();
                    if (typeof renderRepDebts === 'function') renderRepDebts();
                    
                    // تسجيل التحديث
                    console.log(`Active period changed to: ${period}`);
                } catch(e){ 
                    console.warn('Error while rendering after period change', e);
                }
            } catch(e){ console.warn('setActivePeriod error', e); }
        }
        function ensureDefaultActivePeriod(){
            try {
                const saved = localStorage.getItem('active_period');
                const now = new Date();
                const current = __formatPeriod(now);
                
                // التحقق من state.activePeriod أيضاً
                const stateActive = (window.state && state.activePeriod) ? String(state.activePeriod) : '';
                
                // إذا كانت أي من القيم مختلفة عن الحالية → حدّث الكل
                if (!saved || saved !== current || stateActive !== current) { 
                    console.log(`ensureDefaultActivePeriod: Updating from saved=${saved}, stateActive=${stateActive} to ${current}`);
                    setActivePeriod(current); 
                }
            } catch(e){ console.warn('ensureDefaultActivePeriod error', e); }
        }

        // دالة مساعدة لمسح الذاكرة المحلية وإعادة تعيين الفترة النشطة
        window.resetActivePeriod = function() {
            try {
                const current = __formatPeriod(new Date());
                localStorage.setItem('active_period', current);
                if (window.state) window.state.activePeriod = current;
                console.log(`Reset active period to: ${current}`);
                if (typeof ensureDefaultActivePeriod === 'function') ensureDefaultActivePeriod();
                return current;
            } catch(e) {
                console.error('resetActivePeriod error', e);
                return null;
            }
        };

        // === PERIODIC ACTIVE PERIOD CHECK (Every hour) ===
        // تحديث دوري للفترة النشطة كل ساعة للتأكد من تحديثها عند انتقال الشهر الجديد
        (function(){
            const CHECK_INTERVAL = 3600000; // 1 hour in ms
            setInterval(()=>{
                try {
                    ensureDefaultActivePeriod();
                } catch(e){ console.warn('Periodic active period check failed', e); }
            }, CHECK_INTERVAL);
            // تحديث فوري على الفور عند بدء التطبيق
            try {
                ensureDefaultActivePeriod();
                console.log('Initial activePeriod check executed');
            } catch(e){ console.warn('Initial active period check failed', e); }
        })();

        // (manual month close UI removed — handled automatically and via settings calendar)
    </script>

    <style>
        
        /* watermark removed - body::before deleted per user request */

        #app-container {
            background-color: #ffffff !important; /* reset to white after watermark removal */
            padding-bottom: 120px; /* Ensure content doesn't hide behind bottom nav */
            padding-top: 72px; /* Offset for fixed header height so content is visible */
        }
        /* Extra safety: ensure pages have at least header offset if used outside app-container */
        .page { padding-top: 8px; }
        /* Fix main header to top so it doesn't scroll away */
        header {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            z-index: 70;
        }
        
        .page { display: none; }
        .page.active { display: block; }

        /* Main Bottom Nav Styling */
        .bottom-nav {
            position: fixed !important;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60; /* Ensure main nav is above other content */
            background: #ffffff;
        }
        .bottom-nav-item { 
            width: 7.69%; /* Adjusted for 13 items */
            transition: all 0.2s ease;
            color: #6b7280; /* Gray-500 default */
            padding: 8px 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
        } 
        
        /* Simple Active State (Default blue on click/active page) */
        .bottom-nav-item.active {
            color: #2563eb; /* Blue-600 */
            font-weight: 600;
        }

        /* Icon styling - Improved specificity and defaults */
        .lucide-icon {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
        }

        /* Bottom nav specific icon styling */
        .bottom-nav-item svg {
            display: inline-block !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
            vertical-align: middle !important;
            margin: 0 auto !important;
        }

        .bottom-nav-item.active svg {
            color: #2563eb !important; 
        }

        /* Ensure all Lucide icons have consistent styling */
        [data-lucide] {
            display: inline-block !important;
            vertical-align: middle !important;
            width: 24px !important;
            height: 24px !important;
            stroke-width: 2 !important;
            stroke: currentColor !important;
            fill: none !important;
            pointer-events: none !important;
        }

        /* Additional size variations */
        [data-lucide].icon-sm {
            width: 16px !important;
            height: 16px !important;
        }
        
        /* Debts Table Styling to match screenshot */
        #debts-detail-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-family: Arial, sans-serif !important;
            direction: rtl !important;
        }
        
        #debts-detail-table th {
            background: #5c3317 !important;
            color: white !important;
            font-weight: bold !important;
            padding: 8px !important;
            border: 1px solid #3e2211 !important;
            text-align: center !important;
        }
        
        #debts-detail-table td {
            padding: 8px !important;
            border: 1px solid #ddd !important;
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            text-align: center !important;
            color: black !important;
            font-weight: bold !important;
        }
        
        #debts-detail-table td:first-child {
            text-align: right !important;
        }
        
        /* Force visibility of table elements */
        #debts-detail-table, #debts-detail-table thead, #debts-detail-table tbody,
        #debts-detail-table tr, #debts-detail-table th, #debts-detail-table td {
            display: revert !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        [data-lucide].icon-lg {
            width: 32px !important;
            height: 32px !important;
        }

        /* Allow specific size overrides through classes */
        [data-lucide].w-4 { width: 16px; height: 16px; }
        [data-lucide].w-5 { width: 20px; height: 20px; }
        [data-lucide].w-6 { width: 24px; height: 24px; }

        /* (removed) Floating action button for Month Close */

        /* تكبير خاص للتصدير في تقرير التسوية النهائية */
        .recon-export-scale { width:1800px !important; }
        .recon-export-scale table { width:100% !important; }
        .recon-export-scale th, .recon-export-scale td { padding:10px !important; font-size:16px !important; }

        /* Inquiry page table styling */
        #inq-report-table th { background:#041635;color:#fff;padding:6px 8px;text-align:center;font-weight:700; }
        #inq-report-table td { padding:5px 6px;text-align:center;border-bottom:1px solid #e0e7ef; }
        #inq-report-table td.prod-name { text-align:right;font-weight:600;background:#f8fafc; }
        #inq-report-table tr:nth-child(even) td { background:#ffffff; }
        #inq-report-table tr:nth-child(odd) td { background:#f3f6fa; }
        #inq-report-table .qty-cell { font-weight:600;color:#0b3d91; }
        #inq-report-table .total-cell { font-weight:600;color:#064e3b; }
        #inq-summary .card { background:#041a3f;color:#fff;padding:12px 10px;border-radius:8px;display:flex;flex-direction:column;gap:4px; }
        #inq-summary .card span.val { font-size:16px;font-weight:700; }

        /* Price list sheet (match Excel-like style) */
        .price-sheet { width:100%; border-collapse:collapse; direction:rtl; font-size:12px; }
        .price-sheet thead th { background:#efefef; border:1px solid #c1c1d0; padding:6px 8px; text-align:center; font-weight:800; }
        .price-sheet tbody td { border:1px solid #d4d4e0; padding:6px 8px; text-align:center; }
        .price-sheet tbody tr:nth-child(odd) td { background:#f9f9fb; }
        .price-sheet tbody tr:nth-child(even) td { background:#ffffff; }
        .price-sheet td.name { text-align:right; font-weight:600; }
        .sheet-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .sheet-title { font-weight:800; font-size:16px; border:2px solid #888; padding:4px 10px; border-radius:4px; }
        .sheet-meta { display:flex; gap:12px; color:#374151; font-size:12px; }
        .pl-controls .label { font-weight:700; font-size:12px; }

        /* Column filter menu (Debts / Cash tables) */
        .column-filter-menu { position:absolute; background:#ffffff; border:1px solid #c4a300; box-shadow:0 4px 10px rgba(0,0,0,0.12); border-radius:6px; padding:8px; width:220px; max-height:340px; overflow:auto; font-size:12px; z-index:9999; direction:rtl; }
        .column-filter-menu .filter-search { width:100%; padding:4px 6px; border:1px solid #ddd; border-radius:4px; margin-bottom:6px; font-size:12px; }
        .column-filter-menu .filter-list label { cursor:pointer; line-height:1.4; }
        .column-filter-menu .filter-list input { vertical-align:middle; }
        .column-filter-menu .filter-actions { display:flex; gap:6px; margin-top:8px; }
        .column-filter-menu .filter-actions button { flex:1; background:linear-gradient(180deg,#ffd700,#daa520); color:#000; font-weight:600; padding:6px 4px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
        .column-filter-menu .filter-actions button:hover { filter:brightness(1.05); }
        .column-filter-btn { position:relative; }
        .column-filter-btn.filtered { color:#1d4ed8 !important; font-weight:700; }
        .column-filter-btn.filtered::after { content:''; position:absolute; top:2px; inset-inline-end:2px; width:7px; height:7px; background:#1d4ed8; border-radius:50%; box-shadow:0 0 0 1px #ffffff; }
        


        /* Reports SubNav Styling - Active only when reports page is active */
        /* Reports subnav is hidden by default and only shown when .active is added by navigation */
        #reports-subnav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 65px; /* Above main nav (60px high) */
            height: 50px; /* Define height */
            background-color: #f3f4f6; /* Gray-100 */
            border-top: 1px solid #e5e7eb;
            display: none;
            justify-content: space-around;
            padding: 0;
        }

        #reports-subnav.active {
            display: flex !important;
        }
        
        .reports-subnav-item {
            width: 25%; /* 4 items */
            padding: 0.5rem 0.25rem; /* Equivalent to p-2 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-600 */
            font-size: 0.75rem; /* text-xs */
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        /* Style for Lucide icons inside subnav buttons */
        .reports-subnav-item svg {
            color: #4b5563; /* Default icon color */
            width: 16px;
            height: 16px;
        }
        .reports-subnav-item.active svg,
        .reports-subnav-item.active span {
            color: #dc2626; /* red-600 */
            font-weight: 600; /* font-semibold */
        }


    .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        #backup-data-textarea, #restore-data-textarea {
            resize: none;
            height: 150px;
            font-family: monospace;
            font-size: 12px;
            direction: ltr;
            text-align: left;
        }

        .only-print {
            display: none;
        }

        #sale-modal.modal-visible {
            transform: none; /* Override for full screen modal */
        }
        
        /* Spreadsheet Entry Styles (Matching user request image and color theme) */
        #spreadsheet-entry-table input,
        #spreadsheet-entry-table select {
            width: 100%;
            padding: 4px;
            font-size: 0.875rem; /* text-sm */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            min-width: 60px; /* Ensure minimum width */
            text-align: center;
            transition: background-color 0.1s ease;
        }
        
        /* Style for read-only fields */
        #spreadsheet-entry-table input[readonly], 
        #spreadsheet-entry-table .spreadsheet-product-name {
            background-color: #f3f4f6; /* gray-100 */
            cursor: default;
        }
        
        /* Highlighting specific input fields (No alternating rows, only cell colors) */
        .spreadsheet-invoice-number {
            background-color: #e0f2fe; /* Light Blue 100 */
            font-weight: 600;
        }
        .spreadsheet-product-code, 
        .spreadsheet-product-name {
            background-color: #d1fae5; /* Light Green 100 */
            font-weight: 500;
        }
        /* Style for required select fields in spreadsheet row */
        .spreadsheet-collection {
            background-color: #e5e7eb; /* Gray-200 slightly darker background */
        }
        .spreadsheet-total {
            background-color: #fce7f3; /* Pink-100 for totals */
            font-weight: 700;
            color: #9d174d; /* Rose-700 */
        }


        #spreadsheet-entry-table .spreadsheet-product-name,
        #spreadsheet-entry-table .spreadsheet-collection {
            text-align: right;
            padding-right: 8px; /* Give some space for Arabic text */
        }
        #spreadsheet-entry-table th,
        #spreadsheet-entry-table td {
            padding: 4px 6px;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        /* New styles for Promotion Price Highlight */
        #spreadsheet-entry-table .spreadsheet-price.promotion-price-applied {
            background-color: #fef3c7 !important; /* Yellow-100 */
            color: #b91c1c !important; /* Red-700 */
            font-weight: 800;
            border: 2px solid #f59e0b; /* Amber-500 */
        }
        /* Style for Tax Filing Status field */
        .spreadsheet-tax-status-input {
            background-color: #fef2f2; /* Red-50 */
            text-align: center;
        }
        /* Style for Sales List Not Filed Tax Status */
        .tax-not-filed-badge {
            background-color: #fef2f2; /* Red-50 */
            color: #991b1b; /* Red-800 */
            font-weight: 700;
            border: 2px solid #dc2626; /* Red-600 */
            padding: 2px 8px;
        }

        /* NEW: Styling for Detailed Sales Table View */
        .sale-detail-grid {
            grid-template-columns: 1fr 3fr 1fr; /* Total | Details | Actions */
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sale-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 10px;
        }
        .sale-items-table th, .sale-items-table td {
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        .sale-items-table th {
            font-weight: 600;
            color: #4b5563;
            background-color: #f9fafb;
        }

        /* --- NEW SALES LIST CELL COLORS (Matching Spreadsheet) --- */
        .sale-item-name-cell, .sale-item-code-cell {
            background-color: #d1fae5; /* Green-100 */
        }
        .sale-item-total-cell {
            background-color: #fce7f3; /* Pink-100 */
            color: #9d174d; /* Pink-700 for high contrast */
        }
        .sale-item-qty-cell, .sale-item-price-cell {
            background-color: #e0f2fe; /* Blue-100 */
        }
        /* -------------------------------------------------------- */


        /* NEW: Styles for dedicated printing */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }

        /* Invoice quick-search fixed sidebar (only on Sales page, desktop) */
        /* Make the invoice quick-search visible and fixed inside Sales page by default
           (always visible so user can test easily). Change media query later if you want
           to hide on small screens. */
        #page-sales #invoice-quick-search {
            display: block !important;
            position: fixed;
            left: 12px; /* position at left side like the screenshot */
            top: 96px; /* a bit lower under the sticky header */
            width: 190px;
            height: calc(100vh - 120px);
            overflow: auto;
            z-index: 9; /* stay below header (header uses z-10) */
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            background: #ffffff;
        }
        
        /* Dispatch Item Inputs Styling */
        #dispatch-items-table input {
            padding: 2px 4px !important;
            font-size: 0.75rem !important;
        }

        /* Stock Control Column Colors */
        .stock-col-initial { background-color: #e0f2fe; } /* Light Blue */
        .stock-col-inward { background-color: #dcfce7; } /* Light Green */
        .stock-col-production { background-color: #f3e8ff; } /* Light Purple */
        .stock-col-outbound { background-color: #fef9c3; } /* Light Yellow */
        .stock-col-book { background-color: #e5e7eb; } /* Gray */
        .stock-col-actual { background-color: #fee2e2; } /* Light Red */
        .stock-col-diff { background-color: #ffedd5; } /* Light Orange */
        
        /* NEW: Custom Highlight Colors for Manual Review */
        .invoice-cell {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 8px;
            display: inline-block;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 700;
        }
        .invoice-cell.highlight-blue {
            background-color: #93c5fd !important; /* Blue-300 */
            color: #1e3a8a !important; /* Blue-900 */
        }
        .invoice-cell.highlight-green {
            background-color: #86efac !important; /* Green-300 */
            color: #14532d !important; /* Green-900 */
        }
        .invoice-cell.highlight-purple {
            background-color: #c4b5fd !important; /* Violet-300 */
            color: #4c1d95 !important; /* Violet-900 */
        }
        .invoice-cell.highlight-orange {
            background-color: #fed7aa !important; /* Orange-300 */
            color: #7c2d12 !important; /* Orange-900 */
        }
        .invoice-cell.highlight-teal {
            background-color: #99f6e4 !important; /* Teal-300 */
            color: #0f766e !important; /* Teal-800 */
        }
        /* ===== Debts page custom layout (matches provided screenshot) ===== */
        #debts-detail-table th {
    background: linear-gradient(180deg,#ffd700,#daa520) !important;
    color: black !important;
    font-weight: bold !important;
    padding: 8px !important;
    border: 1px solid #c4a300 !important;
    text-align: center !important;
}

.debts-container {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        .debts-sidebar {
            width: 320px; /* fixed left column */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .debts-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }
        .debt-card {
            border-radius: 10px;
            padding: 22px 16px;
            margin-bottom: 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
            background: linear-gradient(180deg, #fff7ed, #fef3c7);
        }
        .debt-card .title {
            font-weight: 700;
            color: #7c4a00;
            margin-bottom: 6px;
        }
        .debt-card .value {
            font-size: 28px;
            font-weight: 800;
            color: #3b2a0d;
        }
        .debt-card.big {
            background: linear-gradient(180deg,#7a4300,#3b2300);
            color: #fff;
            padding: 26px 18px;
        }

        /* Make the debts table header gold gradient */
        .gold-header th {
            background: linear-gradient(180deg,#f6d06a,#d59d00);
            color: #3b2a04;
            font-weight: 800;
            padding: 14px;
            border-right: 1px solid rgba(255,255,255,0.15);
        }
        /* Adjust table to take remaining space */
        .debts-main {
            flex: 1 1 auto;
        }
        /* Small adjustments for date inputs and filters to match screenshot */
        .filter-input { height:44px; padding:10px 12px; }
        
        /* Fix for debts table visibility: ensure table elements use proper table display types
           and prevent parent overflow from clipping rows when rendering under some environments. */
          #debts-detail-table { display: table !important; width: 100% !important; table-layout: auto !important; position: relative !important; z-index: 5 !important; }
        #debts-detail-table thead { display: table-header-group !important; }
        #debts-detail-table tbody { display: table-row-group !important; }
        #debts-detail-table tr { display: table-row !important; visibility: visible !important; opacity: 1 !important; }
        #debts-detail-table td, #debts-detail-table th { display: table-cell !important; color: inherit !important; }
        .debts-main .overflow-x-auto { overflow: auto !important; }

        /* Stronger visibility rules for debts rows in case theme/global CSS hides them */
        #debts-detail-table tbody tr td {
            color: #111 !important;
            background: transparent !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: table-cell !important;
            font-size: 14px !important;
        }
        #debts-detail-table tbody {
            min-height: 120px !important;
        }
        /* Allow JS filtering to hide rows even with the base !important rules */
        #debts-detail-table tr.hidden-by-filter { display: none !important; }
        /* Ensure debts main content sits above any large background watermark */
        .debts-main { position: relative !important; z-index: 6 !important; }

        /* Column filter UI removed (restored original header behavior) */
        /* Re-introduced column filter UI styles */
        .column-filter-btn {
            display:inline-block;
            background:transparent;
            border:0;
            cursor:pointer;
            padding:2px 6px;
            margin-inline-start:6px;
            border-radius:4px;
            font-size:14px;
        }
        .column-filter-btn:hover { background: rgba(0,0,0,0.04); }
        .column-filter-menu {
            position: absolute;
            z-index: 99999;
            background: #fff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            padding: 8px;
            width: 260px;
            max-height: 340px;
            overflow: hidden;
            direction: rtl;
            display: none;
            border-radius: 6px;
        }
        .column-filter-menu .filter-search { width:100%; padding:8px; border:1px solid #e5e7eb; margin-bottom:6px; border-radius:4px; }
        .column-filter-menu .filter-list { max-height:200px; overflow:auto; padding-right:6px; }
        .column-filter-menu .filter-list label { display:block; padding:4px 2px; font-size:13px; }
        .column-filter-menu .filter-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
        .column-filter-menu .filter-actions button { padding:6px 10px; border-radius:6px; border:0; cursor:pointer; }
        .column-filter-menu .apply-btn { background:#f97316; color:white; }
        .column-filter-menu .clear-btn { background:#f3f4f6; color:#111; }

        /* Alternating row colors to match the screenshot */
        /* Even rows - lighter gold */
        #debts-detail-table tbody tr:nth-child(even) td {
            background: linear-gradient(180deg, #fff5d5, #ffd868) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }
        
        /* Odd rows - darker gold */
        #debts-detail-table tbody tr:nth-child(odd) td {
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: normal !important;
            padding: 8px !important;
        }

        /* Money columns - all centered */
        #debts-detail-table tbody tr td.total,
        #debts-detail-table tbody tr td.paid,
        #debts-detail-table tbody tr td.remaining {
            text-align: center !important;
        }

        /* Text alignment */
        #debts-detail-table tbody tr td {
            text-align: center !important;
        }
        #debts-detail-table tbody tr td.customer-name {
            text-align: right !important;
        }

        /* Header styling to match screenshot */
        #debts-detail-table thead th {
            background: linear-gradient(180deg, #ffd700, #ffb700) !important;
            border: 1px solid #e6c200 !important;
            color: black !important;
            font-weight: bold !important;
            padding: 8px !important;
            text-align: center !important;
        }

        /* Summary boxes styling - different gold gradients */
        .debt-card {
            padding: 20px !important;
            border-radius: 8px !important;
            margin: 8px !important;
        }

        /* اجمالي الفواتير */
        .debt-card:nth-child(1) {
            background: linear-gradient(180deg, #ffd700, #daa520) !important;
            color: black !important;
        }

        /* المسدد */
        .debt-card:nth-child(2) {
            background: linear-gradient(180deg, #f0c233, #cc9900) !important;
            color: black !important;
        }

        /* SUB TOTAL */
        .debt-card:nth-child(3) {
            background: linear-gradient(180deg, #ffdb4d, #e6b800) !important;
            color: black !important;
        }

        /* اجمالي المديونيات - lighter brown */
        .debt-card.big {
            background: linear-gradient(180deg, #8b6914, #654b0f) !important;
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        }

        /* Hover effect - lighter gold for both odd and even rows */
        #debts-detail-table tbody tr:hover td {
            background: linear-gradient(180deg, #fff7e6, #ffe180) !important;
        }

    </style>
</head>
<body class="bg-gray-100">
    <script>
        // Ensure a safe updateIcons exists early to prevent ReferenceError when other scripts call it.
        if (!window.updateIcons) {
            window.updateIcons = function(){
                try {
                    if (window.lucide && typeof window.lucide.replace === 'function') {
                        window.lucide.replace();
                        return;
                    }
                    if (window.Lucide && typeof window.Lucide.replace === 'function') {
                        window.Lucide.replace();
                        return;
                    }
                } catch(e) {
                    // ignore
                }
            };
        }

        // Debug helper: reveal invoice sidebar (type manually in Console if needed)
        window.showInvoiceQuickSearch = function(){
            try {
                var el = document.getElementById('invoice-quick-search-panel') || document.getElementById('invoice-quick-search-global');
                if (el) el.style.display = '';
                return !!el;
            } catch(e){ return false; }
        };
    </script>
    <style>
        /* Targets table grid: soft horizontal lines + clear vertical separators */
        .targets-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .targets-table th, .targets-table td { padding: 6px 8px; font-size: 12px; text-align: center; }
        .targets-table tbody td { border-bottom: 1px solid rgba(17,24,39,0.06); }
        .targets-table td + td, .targets-table th + th { border-left: 2px solid rgba(59,130,246,0.25); }
        .targets-col-day { background:#e8f2ff; color:#0b1b34; }
        .targets-col-total { background:#ffe4e6; color:#0b1b34; font-weight:700; }
        /* Customer targets visual style (approximate to provided Excel screenshot) */
        .customer-targets-table { border-collapse: separate; border-spacing:0; width:100%; font-size:12px; }
        .customer-targets-table th { padding:6px 6px; font-weight:700; color:#fff; text-align:center; }
        .cth-name { background:#2f2f34; }
        .cth-multi-target, .cth-dairy-target { background:#b66a00; }
        .cth-multi-ach, .cth-dairy-ach { background:#0f2d64; }
        .cth-total-target { background:#004d40; }
        .cth-total-ach { background:#003366; }
        .cth-rem, .cth-rem-total { background:#5a3d00; }
        .cth-pct, .cth-pct-total { background:#2c3e50; }
        .customer-targets-table tbody tr:nth-child(even) td { background:#f9fafb; }
        .customer-targets-table tbody tr:nth-child(odd) td { background:#fff; }
        .customer-targets-table td { padding:5px 6px; text-align:center; border-bottom:1px solid #e5e7eb; }
        .customer-targets-table td.name { text-align:right; font-weight:600; }
        .customer-targets-table input.cust-target-input { background:#fff; font-size:11px; }
        .customer-targets-table .ach-cell { font-weight:600; color:#0d47a1; }
        .customer-targets-table .rem-pos { color:#b45309; font-weight:600; }
        .customer-targets-table .rem-zero { color:#059669; font-weight:600; }
        .customer-targets-table .pct-ok { color:#047857; font-weight:600; }
        .customer-targets-table .pct-low { color:#374151; font-weight:600; }
        .ghost-zero::before { content:'0'; opacity:0.35; }
    </style>
    <style>
        /* Hide accidental visible code blocks that may appear at top of page */
        body > pre, body > code, .top-debug-text { display: none !important; }
    </style>
    <!-- Removed duplicate global quick-search; using page-local panel inside #page-sales -->
    <script>
        // التأكد من عرض الصفحة الرئيسية فقط - تم تحسين الكود
        function showDashboardPage() {
            // إخفاء جميع الصفحات أولاً
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
                pages[i].style.display = 'none';
            }
            
            // إظهار صفحة لوحة المعلومات
            var dashboard = document.getElementById('page-dashboard');
            if (dashboard) {
                dashboard.classList.add('active');
                dashboard.style.display = 'block';
            }
            
            // تحديث الأيقونات في شريط التنقل
            var navItems = document.getElementsByClassName('bottom-nav-item');
            for (var i = 0; i < navItems.length; i++) {
                navItems[i].classList.remove('active');
                if (navItems[i].getAttribute('data-page') === 'dashboard') {
                    // ضع حالة الاكتف للداشبورد
                    navItems[i].classList.add('active');
                }
            }

            // تعامل دفاعي مع عناصر البيان (قد لا تكون عناصر DOM معرفة عند هذه النقطة)
            var statementCustomerListEl = document.getElementById('statement-customer-list');
            var statementCustomerSearchEl = document.getElementById('statement-customer-search');
            if (statementCustomerListEl && statementCustomerSearchEl) {
                statementCustomerSearchEl.value = '';
                try { updateCustomerList(''); } catch (e) { console.warn('updateCustomerList failed during dashboard init', e); }
            }

            // تحديث الأيقونات والانتهاء من تهيئة الصفحة
            try { updateIcons(); } catch (e) { console.warn('updateIcons failed', e); }

            // Keep the Cash page synchronized whenever main UI re-renders (e.g., after save/delete)
            try { if (typeof renderCash === 'function') renderCash(); } catch (e) { console.warn('renderCash failed from renderAll', e); }
        }

        // تنفيذ الدالة عند تحميل المستند
        document.addEventListener('DOMContentLoaded', showDashboardPage);
        
        // تنفيذ الدالة بعد تحميل الصفحة بالكامل
        window.addEventListener('load', showDashboardPage);
        
        // تنفيذ فوري للتأكد
        showDashboardPage();
    </script>

    <!-- UI Navigation & Authentication Handler -->
    <script>
        const UIController = {
            // عرض صفحة تسجيل الدخول
            showLoginPage() {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('register-page').classList.add('hidden');
                document.getElementById('app-container').classList.add('hidden');
            },

            // عرض صفحة التسجيل
            showRegisterPage() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('register-page').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            },

            // عرض التطبيق الرئيسي
            showApp() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('register-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                this.updateCurrentUserDisplay();
            },

            // تحديث عرض المستخدم الحالي
            updateCurrentUserDisplay() {
                const user = AuthSystem.getCurrentUser();
                const userDisplay = document.getElementById('current-user-display');
                if (user && userDisplay) {
                    const role = getUserRole();
                    userDisplay.textContent = `مرحباً، ${user.name} (${role})`;
                    try {
                        // Toggle admin map button visibility based on role
                        const mapBtn = document.getElementById('open-map-btn');
                        if (mapBtn) mapBtn.classList.toggle('hidden', role !== 'admin');
                    } catch(e){}
                }
            },

            // إخفاء كل الصفحات ثم عرض الصفحة المحددة
            showPage(pageId) {
                const pages = document.querySelectorAll('.page');
                pages.forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                const page = document.getElementById(pageId);
                if (page) {
                    page.classList.add('active');
                    page.style.display = 'block';
                }
            }
        };

        // معالجات نماذج تسجيل الدخول
        document.addEventListener('DOMContentLoaded', () => {
            // إظهار/إخفاء كلمة المرور
            try {
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-target');
                        const input = document.getElementById(id);
                        if (!input) return;
                        input.type = input.type === 'password' ? 'text' : 'password';
                        btn.textContent = input.type === 'password' ? '👁️' : '🙈';
                    });
                });
            } catch(e) { /* ignore */ }
            // معالج نموذج تسجيل الدخول (صفحة كاملة)
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const rememberEl = document.getElementById('login-remember');
                    const remember = rememberEl ? rememberEl.checked : false;
                    
                    const result = await AuthSystem.login(email, password);
                    
                    if (result.success) {
                        if (remember) {
                            localStorage.setItem('app_remember_email', email);
                        }
                        loginForm.reset();
                        // onAuthStateChanged سيكمل المعالجة
                    } else {
                        alert('❌ خطأ: ' + result.message);
                    }
                });
            }

            // معالج نموذج تسجيل الدخول (المودال)
            const loginFormModal = document.getElementById('login-modal-form');
            if (loginFormModal) {
                loginFormModal.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailEl = document.getElementById('login-email-modal');
                    const passEl = document.getElementById('login-password-modal');
                    const email = emailEl ? emailEl.value : '';
                    const password = passEl ? passEl.value : '';
                    const result = await AuthSystem.login(email, password);
                    if (result.success) {
                        loginFormModal.reset();
                        try { closeModal(document.getElementById('login-modal')); } catch(_){}
                    } else {
                        alert('❌ خطأ: ' + result.message);
                    }
                });
            }

            // معالج نموذج التسجيل
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const confirmPassword = document.getElementById('register-password-confirm').value;
                    
                    // التحقق من تطابق كلمات المرور
                    if (password !== confirmPassword) {
                        alert('❌ كلمات المرور غير متطابقة');
                        return;
                    }
                    
                    // التحقق من طول كلمة المرور
                    if (password.length < 6) {
                        alert('❌ كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                        return;
                    }
                    
                    const result = await AuthSystem.register(email, password, name);
                    
                    if (result.success) {
                        alert('✅ ' + result.message + '\n\nيمكنك الآن تسجيل الدخول');
                        
                        // مسح النموذج
                        registerForm.reset();
                        
                        // العودة إلى صفحة تسجيل الدخول
                        UIController.showLoginPage();
                    } else {
                        alert('❌ خطأ: ' + result.message);
                    }
                });
            }

            // الأزرار للتبديل بين صفحات تسجيل الدخول والتسجيل
            const goToRegisterBtn = document.getElementById('go-to-register-btn');
            if (goToRegisterBtn) {
                goToRegisterBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    UIController.showRegisterPage();
                });
            }

            const goToLoginBtn = document.getElementById('go-to-login-btn');
            if (goToLoginBtn) {
                goToLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    UIController.showLoginPage();
                });
            }

            // معالج زر تسجيل الخروج
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if (confirm('هل تريد تسجيل الخروج؟')) {
                        AuthSystem.logout();
                        localStorage.removeItem('app_remember_email');
                        UIController.showLoginPage();
                    }
                });
            }

            // فحص إذا كان المستخدم مسجل دخول بالفعل
            // الاعتماد على onAuthStateChanged فقط، تجهيز البريد إن كان محفوظاً
            const rememberEmail = localStorage.getItem('app_remember_email');
            if (rememberEmail) {
                const pageEmail = document.getElementById('login-email');
                if (pageEmail) pageEmail.value = rememberEmail;
                const modalEmail = document.getElementById('login-email-modal');
                if (modalEmail) modalEmail.value = rememberEmail;
            }
            UIController.showLoginPage();
        });

        // دالة لتهيئة التطبيق للمستخدم الحالي
        async function initializeAppForUser() {
            // تهيئة مبسطة: نعتمد فقط على المستمعات اللحظية التي ستملأ state.
            // تحديد activePeriod: استخدم التاريخ الحالي دائماً، لا تعتمد على localStorage المحفوظ
            const currentPeriod = __formatPeriod(new Date());
            if (!window.state) window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 }, activePeriod: currentPeriod };
            else {
                // تحديث activePeriod دائماً للتاريخ الحالي عند إعادة التهيئة
                window.state.activePeriod = currentPeriod;
            }
            // حفظ الفترة النشطة في localStorage
            try { localStorage.setItem('active_period', currentPeriod); } catch(e){}
            console.log(`initializeAppForUser: Set activePeriod to ${currentPeriod}`);
            try { UIController.updateCurrentUserDisplay(); } catch(e){}
            
            // إجبار تحديث الفترة النشطة بعد قصير من التهيئة
            setTimeout(()=>{
                try { 
                    ensureDefaultActivePeriod();
                    console.log(`Forced activePeriod check: current=${currentPeriod}, saved=${localStorage.getItem('active_period')}`);
                } catch(e){}
            }, 500);
        }

        // نظام حفظ البيانات الموحد (يحفظ حسب المستخدم الحالي عند ربطه بـ Firebase)
        const DataManager = {
            // حفظ البيانات بشكل آمن حسب المستخدم
            saveAppState(stateObj) {
                const user = AuthSystem.getCurrentUser();
                if (!user) {
                    console.warn('Cannot save state: no current user logged in');
                    return false;
                }
                
                try {
                    // حفظ البيانات محلياً للآن
                    localStorage.setItem('app_state', JSON.stringify(stateObj));
                    
                    // حفظ نسخة احتياطية في بيانات المستخدم
                    user.data.lastAppState = stateObj;
                    AuthSystem.setCurrentUser(user);

                    // حاول أيضاً حفظ الحالة في Firebase (إن تم تهيئته)
                    try {
                        if (typeof saveStateToFirebase === 'function') {
                            saveStateToFirebase(stateObj).then(ok => {
                                if (ok) console.log('✅ saved state to Firebase');
                            }).catch(e => console.warn('Failed to save state to Firebase', e));
                        }
                    } catch(e) { console.warn('saveStateToFirebase error', e); }

                    return true;
                } catch (e) {
                    console.error('Error saving app state:', e);
                    return false;
                }
            },

            // تحميل البيانات حسب المستخدم
            loadAppState() {
                const user = AuthSystem.getCurrentUser();
                
                try {
                    // جرب تحميل البيانات المحلية
                    const localData = localStorage.getItem('app_state');
                    if (localData) {
                        return JSON.parse(localData);
                    }
                    
                    // إذا لم توجد، جرب من بيانات المستخدم
                    if (user && user.data && user.data.lastAppState) {
                        return user.data.lastAppState;
                    }
                    
                    return null;
                } catch (e) {
                    console.error('Error loading app state:', e);
                    return null;
                }
            },

            // حذف جميع البيانات الشخصية للمستخدم
            clearUserData() {
                const user = AuthSystem.getCurrentUser();
                if (!user) return false;
                
                try {
                    user.data = {};
                    AuthSystem.setCurrentUser(user);
                    localStorage.removeItem('app_state');
                    return true;
                } catch (e) {
                    console.error('Error clearing user data:', e);
                    return false;
                }
            }
        };

        // إدارة المستخدمين والأدوار (واجهة + ربط Firestore)
        function canManageUsers(){ try { return getUserRole() === 'admin'; } catch(e){ return false; } }

        function updateUserManagementVisibility(){
            const sec = document.getElementById('user-management-section');
            if (!sec) return;
            if (canManageUsers()) {
                sec.classList.remove('hidden');
                try { renderUsersTable(); } catch(e){}
            } else {
                sec.classList.add('hidden');
            }
        }

        function renderUsersTable(){
            const tbody = document.getElementById('users-table-body');
            const warn = document.getElementById('user-role-warning');
            if (!tbody) return;
            if (!canManageUsers()) { if (warn){ warn.textContent = 'هذه الميزة مخصصة للمشرفين فقط.'; warn.classList.remove('hidden'); } return; }
            if (warn) warn.classList.add('hidden');
            const list = Array.isArray(window.state && state.users) ? state.users : [];
            if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="px-2 py-3 text-center text-gray-500">لا يوجد مستخدمون بعد.</td></tr>'; return; }
            const current = AuthSystem.getCurrentUser();
            tbody.innerHTML = list.map(u => {
                const role = (u.role || 'user');
                const disabled = (current && current.id === u._id) ? 'data-self="1"' : '';
                const pres = (window.state && Array.isArray(state.presence)) ? state.presence.find(p => (p._id===u._id) || (p.uid===u._id) || ((p.email||'').toLowerCase() === (u.email||'').toLowerCase())) : null;
                const online = (typeof u.online !== 'undefined') ? !!u.online : !!(pres && pres.online === true); // فقط true، ليس !== false
                const emailStr = ((u.email||'').toLowerCase()) || ((pres && pres.email) ? (pres.email||'').toLowerCase() : '');
                return `<tr>
                    <td class="px-2 py-2">${u.name || '-'}</td>
                    <td class="px-2 py-2 flex items-center gap-2">
                        <span class="inline-block w-2.5 h-2.5 rounded-full ${online ? 'bg-green-500' : 'bg-gray-400'}" title="${online ? 'متصل الآن' : 'غير متصل'}"></span>
                        <span>${emailStr}</span>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <select class="user-role-select p-1 border rounded" data-uid="${u._id}" ${disabled}>
                            <option value="admin" ${role==='admin'?'selected':''}>admin</option>
                            <option value="rep" ${role==='rep'?'selected':''}>rep</option>
                            <option value="viewer" ${role==='viewer'?'selected':''}>viewer</option>
                            <option value="user" ${role==='user'?'selected':''}>user</option>
                        </select>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="apply-role-btn bg-blue-600 text-white px-3 py-1 rounded text-xs" data-uid="${u._id}">تطبيق</button>
                            ${emailStr ? '' : `<button class="set-user-email-btn bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs" title="إضافة بريد" data-uid="${u._id}">إضافة بريد</button>`}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // أحداث التغيير والحفظ
        document.addEventListener('click', async function(e){
            const btn = e.target && e.target.closest ? e.target.closest('.apply-role-btn') : null;
            if (!btn) return;
            if (!canManageUsers()) { alert('ليست لديك صلاحية التعديل'); return; }
            const uid = btn.getAttribute('data-uid');
            const sel = document.querySelector(`select.user-role-select[data-uid="${uid}"]`);
            if (!uid || !sel) return;
            const role = sel.value;
            const current = AuthSystem.getCurrentUser();
            if (current && current.id === uid && role !== 'admin') {
                if (!confirm('أنت تحاول إزالة صلاحية المشرف عن نفسك، قد تفقد إمكانية الإدارة. هل أنت متأكد؟')) return;
            }
            try {
                // تحديث users/{uid}.role
                await db.collection('users').doc(uid).set({ role: role }, { merge: true });
                // تحديث roles/{uid}.role ليتوافق مع قواعد Firestore على السيرفر
                try { await db.collection('roles').doc(uid).set({ role: role }, { merge: true }); } catch(_e){}
                alert('تم تحديث الدور بنجاح');
            } catch (err) {
                console.warn('فشل تحديث الدور', err);
                alert('تعذر تحديث الدور، تحقق من اتصالك والصلاحيات');
            }
        });

        document.addEventListener('click', function(e){
            const r = e.target && e.target.id === 'refresh-users-btn';
            if (!r) return;
            try { renderUsersTable(); } catch(e){}
        });

        // إضافة/تعديل بريد المستخدم يدوياً من الجدول
        document.addEventListener('click', async function(e){
            const btn = e.target && e.target.closest ? e.target.closest('.set-user-email-btn') : null;
            if (!btn) return;
            if (!canManageUsers()) { alert('ليست لديك صلاحية التعديل'); return; }
            const uid = btn.getAttribute('data-uid');
            const currentEmail = (state.users||[]).find(u=>String(u._id)===String(uid))?.email || '';
            const val = prompt('أدخل بريد المستخدم', currentEmail || '');
            if (!val) return;
            const email = String(val).trim().toLowerCase();
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('صيغة بريد غير صحيحة'); return; }
            try {
                await db.collection('users').doc(uid).set({ email }, { merge: true });
                // حدّث الذاكرة وأعد رسم الجدول
                try {
                    const i = (state.users||[]).findIndex(u=>String(u._id)===String(uid));
                    if (i>=0) { state.users[i] = Object.assign({}, state.users[i], { email }); }
                } catch(_){ }
                renderUsersTable();
            } catch(err){
                alert('تعذر حفظ البريد');
                console.warn('set email failed', err);
            }
        });

        // زر فتح إدارة المستخدمين أعلى الإعدادات
        document.addEventListener('click', function(e){
            const openBtn = e.target && (e.target.id === 'open-user-management-btn' || (e.target.closest && e.target.closest('#open-user-management-btn')));
            if (!openBtn) return;
            if (!canManageUsers()) { alert('هذه الميزة للمشرفين فقط'); return; }
            const sec = document.getElementById('user-management-section');
            if (sec) {
                sec.classList.remove('hidden');
                try { sec.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e){}
            }
        });

        // أظهر/أخفِ قسم الإدارة عند تحميل الصفحة وعند تحديث المستخدم الحالي
        document.addEventListener('DOMContentLoaded', updateUserManagementVisibility);
        try { UIController.updateCurrentUserDisplay = (function(orig){ return function(){ try { orig.call(UIController); } catch(e){}; try { updateUserManagementVisibility(); } catch(e){}; }; })(UIController.updateCurrentUserDisplay); } catch(e){}
    </script>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">مرحباً</h1>
                <p class="text-gray-600 mt-2">نظام إدارة المبيعات</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل بريدك الإلكتروني" required>
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10" placeholder="أدخل كلمة المرور" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password" title="إظهار/إخفاء">
                            👁️
                        </button>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="login-remember" class="h-4 w-4 text-blue-600 rounded">
                    <label for="login-remember" class="mr-2 text-sm text-gray-600">تذكرني</label>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">دخول</button>

                <div class="text-center text-sm text-gray-600">
                    <p>لا تملك حساب؟ <button type="button" id="go-to-register-btn" class="text-blue-600 hover:underline font-semibold">إنشاء حساب جديد</button></p>
                </div>
            </form>

            <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                <p><strong>للاختبار السريع:</strong></p>
                <p>البريد: test@example.com</p>
                <p>كلمة المرور: test123</p>
            </div>
        </div>
    </div>

    <!-- REGISTER PAGE -->
    <div id="register-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">إنشاء حساب جديد</h1>
                <p class="text-gray-600 mt-2">نظام إدارة المبيعات</p>
            </div>
            
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل</label>
                    <input type="text" id="register-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل اسمك الكامل" required>
                </div>

                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل بريدك الإلكتروني" required>
                </div>

                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                    <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل كلمة مرور قوية" required>
                </div>

                <div>
                    <label for="register-password-confirm" class="block text-sm font-medium text-gray-700 mb-1">تأكيد كلمة المرور</label>
                    <input type="password" id="register-password-confirm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أعد كتابة كلمة المرور" required>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">إنشاء الحساب</button>

                <div class="text-center text-sm text-gray-600">
                    <p>لديك حساب بالفعل؟ <button type="button" id="go-to-login-btn" class="text-blue-600 hover:underline font-semibold">دخول</button></p>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="mx-auto bg-white shadow-lg min-h-screen hidden">
        
        <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 no-print flex justify-between items-center">
            <div class="flex items-center">
                <img id="company-logo-img" src="" alt="شعار" style="height:40px;display:none;margin-left:10px;border-radius:6px;background:white;padding:2px;" />
                <h1 id="header-title" class="text-xl font-bold">لوحة المعلومات</h1>
            </div>
            <!-- الساعة الرقمية في منتصف الهيدر -->
            <div class="flex-1 flex justify-center">
                <div id="digital-clock" class="text-2xl font-mono font-bold text-white tracking-widest" style="letter-spacing:0.1em;">00:00:00</div>
            </div>
            <div class="flex items-center gap-4">
                <!-- GPS quick toggle for reps (no need to open settings) -->
                <button id="gps-toggle-btn" class="px-2 py-1 rounded text-xs font-semibold bg-red-500 text-white hover:bg-red-600" title="تشغيل/إيقاف مشاركة الموقع">GPS OFF</button>
                <!-- Admin-only: open interactive map modal for all reps -->
                <button id="open-map-btn" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-xs font-semibold flex items-center gap-1" title="عرض خريطة المناديب">
                    <span>الخريطة</span>
                </button>
                <span id="reviewer-badge" class="hidden bg-amber-500 text-white px-2 py-1 rounded text-xs font-semibold" title="وضع المراجعة (قراءة فقط)">وضع المراجعة</span>
                <span id="current-user-display" class="text-white text-sm"></span>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">تسجيل الخروج</button>
            </div>
        </header>

        <main class="p-4">
            <!-- Admin Map Modal -->
            <div id="reps-map-modal" class="hidden fixed inset-0 z-40 bg-black bg-opacity-50 items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                        <h3 class="font-bold text-gray-800">خريطة المناديب</h3>
                        <button id="close-map-btn" class="text-gray-600 hover:text-black">إغلاق</button>
                    </div>
                    <div class="p-0">
                        <div id="reps-map" style="height:70vh; width:100%;"></div>
                    </div>
                </div>
            </div>
            <div id="page-dashboard" class="page active">
                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dashboard-rep-filter" class="block text-sm font-medium text-gray-700">عرض إحصائيات المندوب:</label>
                        <select id="dashboard-rep-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div>
                        <label for="dashboard-chain-filter" class="block text-sm font-medium text-gray-700">عرض إحصائيات السلسلة:</label>
                        <select id="dashboard-chain-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <option value="">جميع السلاسل</option>
                        </select>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-green-800 font-semibold">إجمالي المبيعات (الشهر)</h3>
                        <p id="total-sales" class="text-2xl font-bold text-green-900 mt-1">0 ج.م</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-blue-800 font-semibold">المبالغ المحصلة</h3>
                        <p id="total-collected" class="text-2xl font-bold text-blue-900 mt-1">0 ج.م</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-orange-800 font-semibold">المبالغ المستحقة</h3>
                        <p id="total-due" class="text-2xl font-bold text-orange-900 mt-1">0 ج.م</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg shadow">
                        <h3 class="text-sm text-purple-800 font-semibold">عدد الفواتير</h3>
                        <p id="sales-count" class="text-2xl font-bold text-purple-900 mt-1">0</p>
                    </div>
                </div>

                <!-- Target Progress -->
                <div class="mb-6">
                    <h3 id="target-title" class="font-bold text-gray-800 mb-2">الهدف الشهري:</h3>
                    <h4 id="target-amount-display" class="text-blue-600 font-bold text-lg mb-2"></h4>
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="target-progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill text-xs text-white text-center" style="width: 0%;">
                            <span id="target-progress-text">0%</span>
                        </div>
                    </div>
                </div>

                <!-- CHART / GRAPHS SECTION (Kept charts in Dashboard for dual purpose) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <!-- Daily Sales Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">المبيعات خلال 7 أيام</h3>
                        <div class="h-64">
                            <canvas id="sales-7-days-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Reps Chart -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">أفضل المناديب (مبيعات)</h3>
                        <div class="h-64">
                            <canvas id="top-reps-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Products (Quantity/Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">أفضل المنتجات (كمية)</h3>
                         <div class="h-64">
                            <canvas id="top-products-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top Customers (Value) -->
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="font-bold text-gray-800 mb-4">أفضل العملاء (قيمة)</h3>
                         <div class="h-64">
                            <canvas id="top-customers-chart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- END CHART / GRAPHS SECTION -->
                
                <!-- The Reports button is no longer needed in the Dashboard -->
                <div class="mb-6 hidden">
                    <button id="view-reports-btn" class="w-full bg-blue-700 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-blue-800 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        <span>عرض التقارير والرسوم البيانية</span>
                    </button>
                </div>
                
                <div class="mb-6">
                    <button id="manual-statement-btn" class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-gray-700 flex items-center justify-center gap-2 font-bold">
                        <i data-lucide="file-text"></i>
                        <span>كشف حساب يدوي</span>
                    </button>
                </div>

                

                <div>
                    <h3 class="font-bold text-gray-800 mb-3">أحدث عمليات البيع</h3>
                    <div id="recent-sales-list" class="space-y-3">
                        <p class="text-gray-500 text-center">لا توجد عمليات بيع بعد.</p>
                    </div>
                </div>
            </div>

            <div id="page-sales" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="receipt" class="w-6 h-6 text-blue-600"></i>
                        <span>جميع المبيعات</span>
                    </h2>
                    <!-- سهم التمرير السريع للأسفل -->
                    <button id="scroll-to-bottom-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center gap-1 transition" title="انزل لآخر الفواتير">
                        <i data-lucide="arrow-down" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <button id="sales-quick-print-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة فاتورة">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                            <span>طباعة فاتورة</span>
                        </button>
                        <button id="sales-bt-print-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة بلوتوث (تجريبية)">
                            <i data-lucide="bluetooth" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">بلوتوث</span>
                        </button>
                        <button id="sales-html-print-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة حرارية عادية">
                            <i data-lucide="file" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">طباعة عادية</span>
                        </button>
                    </div>
                    <!-- FAB is used for adding sales now -->
                </div>
                <!-- Sales filters bar (restored) -->
                <div id="sales-filters-bar" class="flex flex-col sm:flex-row gap-2 mb-4" style="position:sticky; top:72px; z-index:20; background:#ffffff; padding:8px 0;">
                    <input id="search-sales-text" type="text" placeholder="ابحث باسم العميل أو رقم الفاتورة أو الإجمالي..." class="w-full p-2 border rounded-md">
                    <div class="flex items-center w-full sm:w-auto relative">
                        <input id="search-sales-date" type="date" class="w-full p-2 border border-gray-300 rounded-md appearance-none">
                        <button id="clear-sales-date-btn" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-600 hidden font-bold text-xl leading-none p-1">&times;</button>
                    </div>
                    <select id="tax-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">فلترة بحالة الرفع</option>
                        <option value="filed">تم الرفع</option>
                        <option value="not-filed">لم يتم الرفع</option>
                    </select>
                    <select id="review-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
                        <option value="all">كل الفواتير</option>
                        <option value="pending">قيد المراجعة فقط</option>
                        <option value="reviewed">المعتمدة فقط</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div id="daily-total-container" class="bg-blue-100 border-r-4 border-blue-500 p-3 rounded-lg text-center hidden shadow-md">
                        <span class="font-semibold">إجمالي مبيعات اليوم المحدد:</span>
                        <span id="daily-total-amount" class="font-bold text-blue-800">0 ج.م</span>
                    </div>
                    <!-- Right column: filtered total only (quick-search moved to side drawer) -->
                    <div style="display:flex;gap:12px;align-items:flex-start;">
                        <div id="filtered-total-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg text-center shadow-md" style="flex:1;">
                            <div>
                                <span class="font-semibold">إجمالي الفواتير المعروضة:</span>
                                <span id="filtered-total-amount" class="font-bold text-green-800">0 ج.م</span>
                            </div>
                            <div class="mt-1 text-sm text-green-900">
                                <span class="font-semibold">عدد الفواتير:</span>
                                <span id="filtered-total-count" class="font-bold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Left slide-in drawer for Invoice Quick Search -->
                <div id="invoice-quick-search-wrap" class="fixed z-40 left-0" style="top:120px;width:220px;">
                    <div id="invoice-quick-search-content" class="relative transition-transform duration-200 ease-out">
                        <div id="invoice-quick-search-panel" class="bg-white p-2 rounded-r-lg shadow-lg border border-gray-200" style="width:220px;">
                            <div style="display:flex;flex-direction:column;gap:6px;align-items:stretch;">
                                <div style="background:#111027;color:#fff;padding:6px 8px;border-radius:4px;text-align:center;font-weight:700;">Number<br><div id="invoice-val-number" style="font-size:14px;margin-top:4px;">--</div></div>
                                <div style="background:#f6d8bf;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Total<br><div id="invoice-val-total" style="font-weight:700;">--</div></div>
                                <div style="background:#f4cfa9;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Return<br><div id="invoice-val-return">--</div></div>
                                <div style="background:#eee2d6;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Net amount<br><div id="invoice-val-net">--</div></div>
                                <div style="background:#e6f3e9;color:#0b6b2d;padding:6px 6px;border-radius:4px;text-align:center;">C - Name<br><div id="invoice-val-cname">--</div></div>
                                <div style="background:#2b2b2b;color:#fff;padding:6px 6px;border-radius:4px;text-align:center;">Date<br><div id="invoice-val-date">--</div></div>
                                <div style="text-align:center;margin-top:6px;">
                                    <input id="invoice-search-input" type="text" inputmode="numeric" placeholder="رقم" class="w-full p-1 border rounded-md text-center text-sm" />
                                </div>
                                <div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">
                                    <button id="invoice-search-btn" class="bg-blue-600 text-white px-2 py-1 rounded-md text-sm">بحث</button>
                                    <button id="invoice-clear-btn" class="bg-gray-200 text-gray-700 px-2 py-1 rounded-md text-sm">مسح</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Lens handle (outside the sliding content so it remains visible) -->
                    <button id="invoice-quick-search-toggle" class="fixed left-0 bg-white border border-gray-300 rounded-full w-9 h-9 shadow flex items-center justify-center z-50" style="top:220px" title="بحث">
                        <i data-lucide="search" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>

                <!-- Hidden thermal print root -->
                <div id="thermal-print-root" style="display:none"></div>
                <div id="sales-list" class="space-y-3"></div>
            </div>
            <!-- تمت إزالة شريط التصدير الضريبي حسب الطلب -->

            <!-- Inquiry / استعلام عن مبيعات العملاء (فترة محددة + عملاء متعددين) -->
            <div id="page-inquiry" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="search" class="w-6 h-6 text-blue-600"></i>
                        <span>استعلام عن مبيعات العملاء</span>
                    </h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4 text-sm items-start">
                    <div>
                        <label class="block font-semibold mb-1">من تاريخ</label>
                        <input id="inq-date-from" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">إلى تاريخ</label>
                        <input id="inq-date-to" type="date" class="w-full p-2 border rounded" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">بحث عن عميل</label>
                        <input id="inq-customer-filter" type="text" placeholder="اكتب جزء من الاسم" class="w-full p-2 border rounded" />
                        <p class="text-[11px] text-gray-500 mt-1">استخدم Ctrl أو Shift للاختيار المتعدد في القائمة.</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block font-semibold mb-1">العملاء المختارون</label>
                        <select id="inq-customers" multiple size="8" class="w-full p-2 border rounded"></select>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button id="inq-generate-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2 text-sm"><i data-lucide="play"></i> تنفيذ الاستعلام</button>
                    <button id="inq-print-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 flex items-center gap-2 text-sm"><i data-lucide="printer"></i> طباعة</button>
                    <button id="inq-image-btn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2 text-sm"><i data-lucide="image"></i> صورة</button>
                </div>
                <div id="inq-summary" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 text-sm"></div>
                <div id="inq-report-wrapper" class="bg-white rounded-lg shadow p-3 overflow-auto">
                    <table id="inq-report-table" class="w-full text-xs border-collapse" style="direction:rtl;min-width:820px;">
                        <thead id="inq-report-head"></thead>
                        <tbody id="inq-report-body"></tbody>
                    </table>
                    <div class="mt-6" id="inq-customers-breakdown"></div>
                </div>
            </div>

            <!-- Price Lists / قوائم الأسعار: صفحة مخصصة لعرض قائمة واحدة حسب الاختيار -->
            <div id="page-price-lists" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="badge-dollar-sign" class="w-6 h-6 text-amber-600"></i>
                        <span>قوائم الأسعار</span>
                    </h2>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-3">
                    <div class="pl-controls grid grid-cols-1 md:grid-cols-7 gap-3 mb-4 text-sm items-end">
                        <div>
                            <label class="label block mb-1">طريقة الاختيار</label>
                            <select id="pl-filter-mode" class="w-full p-2 border rounded">
                                <option value="customer">حسب العميل</option>
                                <option value="priceList">حسب القائمة</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="label block mb-1">اختر العميل/القائمة</label>
                            <select id="pl-selector" class="w-full p-2 border rounded"></select>
                        </div>
                        <div>
                            <label class="label block mb-1">خصم % للقائمة</label>
                            <input id="pl-global-discount" type="number" min="0" max="100" step="0.01" value="0" class="w-full p-2 border rounded" />
                        </div>
                        <div class="flex items-end gap-2">
                            <button id="pl-print" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">طباعة</button>
                            <button id="pl-image" class="bg-indigo-600 text-white px-3 py-2 rounded text-sm">صورة</button>
                        </div>
                    </div>

                    <div class="sheet-header">
                        <div class="sheet-meta">
                            <span id="pl-date"></span>
                        </div>
                        <div class="sheet-title">قائمة أسعار المحلات</div>
                        <div class="sheet-meta">
                            <span id="pl-customer-name"></span>
                        </div>
                    </div>

                    <div id="pl-sheet-container" class="overflow-auto"></div>

                    <!-- قديمة: عرض جميع القوائم (لم يعد يستخدم، أبقيته للرجوع عند الحاجة) -->
                    <div id="all-price-lists-container" class="grid md:grid-cols-2 gap-4" style="display:none"></div>
                </div>
            </div>

            

            <script>
                // ===== Thermal HTML Fallback Print =====
                (function(){
                    const CSS_ID = 'thermal-print-style';
                    function ensurePrintCss(){
                        if (document.getElementById(CSS_ID)) return;
                        const style = document.createElement('style');
                        style.id = CSS_ID;
                        style.textContent = `@media print {
  body * { visibility: hidden !important; }
  #thermal-print-root, #thermal-print-root * { visibility: visible !important; }
  #thermal-print-root { position: absolute; left:0; top:0; width:58mm; padding:4px 2px; font-family: 'Cairo', Arial, sans-serif; font-size:11px; line-height:1.25; direction:rtl; }
  #thermal-print-root .row { display:flex; justify-content:space-between; }
  #thermal-print-root .center { text-align:center; }
  #thermal-print-root hr { border:0; border-top:1px dashed #000; margin:4px 0; }
}
@page { margin:2mm; size:58mm auto; }`;
                        document.head.appendChild(style);
                    }
                    function money(n){ try { return (Number(n)||0).toFixed(2); } catch(_) { return '0.00'; } }
                    function buildHtmlReceipt(sale){
                        if (!sale) return '<div class="center">لا توجد فاتورة للعرض</div>';
                        const itemsHtml = (Array.isArray(sale.items)? sale.items: []).map(it => {
                            const name = (it.name||it.productName||it.productId||'صنف');
                            const qty = it.qty||it.quantity||0;
                            const price = it.price||it.unitPrice||0;
                            const total = qty*price;
                            return `<div class='row'><span>${name}</span><span>${qty}x${money(price)}=${money(total)}</span></div>`;
                        }).join('');
                        const total = money(sale.total||sale.net||sale.amount||0);
                        return `<div class='center'><strong>فاتورة بيع</strong></div>
<div class='center'>رقم: ${(sale.invoiceNumber||sale.id||'--')}</div>
<div>التاريخ: ${(sale.date||'').toString().split('T')[0]||'--'}</div>
<div>العميل: ${(sale.customerName||'--')}</div>
<hr>
${itemsHtml}
<hr>
<div class='row'><strong>الإجمالي</strong><strong>${total} ج.م</strong></div>
<div class='center'>شكراً لكم</div>`;
                    }
                    async function printHtmlReceiptLatest(){
                        try {
                            const root = document.getElementById('thermal-print-root');
                            const sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                            root.innerHTML = buildHtmlReceipt(sale);
                            root.style.display = 'block';
                            ensurePrintCss();
                            window.print();
                            setTimeout(()=>{ root.style.display='none'; root.innerHTML=''; }, 400);
                        } catch(e){ alert('فشل الطباعة العادية: '+ e.message); }
                    }
                    window.printHtmlReceiptLatest = printHtmlReceiptLatest;
                })();

                // ===== Thermal Receipt Builder (simplified ESC/POS) =====
                // NOTE: This encodes a very basic Arabic receipt; adjust per printer specs.
                function buildEscPosReceipt(sale){
                    const enc = new TextEncoder();
                    const lines = [];
                    const center = (t)=>"\x1B\x61\x01"+t+"\n"; // ESC a 1 (center)
                    const left = (t)=>"\x1B\x61\x00"+t+"\n";  // ESC a 0 (left)
                    lines.push(center("*** فاتورة بيع ***"));
                    if (sale && sale.invoiceNumber) lines.push(center("رقم: "+sale.invoiceNumber));
                    if (sale && sale.date) lines.push(left("التاريخ: "+(sale.date.split('T')[0])));
                    if (sale && sale.customerName) lines.push(left("العميل: "+sale.customerName));
                    lines.push(left("------------------------------"));
                    if (sale && Array.isArray(sale.items)){
                        sale.items.forEach(it=>{
                            const name = (it.name||it.productName||it.productId||"صنف").slice(0,12);
                            const qty = it.qty || it.quantity || 0;
                            const price = it.price || it.unitPrice || 0;
                            const total = (qty*price).toFixed(2);
                            lines.push(left(name+" "+qty+"x"+price+"="+total));
                        });
                    }
                    lines.push(left("------------------------------"));
                    const totalAmt = sale ? (sale.total || sale.net || sale.amount || 0) : 0;
                    lines.push(center("الإجمالي: "+Number(totalAmt).toFixed(2)+" ج.م"));
                    lines.push(center("شكراً لكم"));
                    // Feed & cut (if supported) \x1D V 0
                    lines.push("\n\n\x1D\x56\x00");
                    const all = lines.join("");
                    return enc.encode(all);
                }

                async function bluetoothPrintLatest(){
                    if (!('bluetooth' in navigator)){
                        alert('المتصفح لا يدعم Web Bluetooth (جرب Chrome أو Edge على أندرويد).');
                        return;
                    }
                    // أحدث فاتورة
                    const sale = (window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
                    const payload = buildEscPosReceipt(sale);
                    // UUIDs محتملة لطابعات حرارية BLE شائعة (قد تحتاج تعديل)
                    const SERVICE_UUIDS = [0xFFE0,'0000ffe0-0000-1000-8000-00805f9b34fb','0000ff00-0000-1000-8000-00805f9b34fb'];
                    const CHAR_UUIDS = ['ffe1','0000ffe1-0000-1000-8000-00805f9b34fb','0000ff01-0000-1000-8000-00805f9b34fb'];
                    let device;
                    try {
                        // نستخدم acceptAllDevices لتفادي خطأ اسم الخدمة ثم نحاول الخدمات بعد الاتصال
                        device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices: SERVICE_UUIDS });
                    } catch(e){
                        alert('تعذر اختيار جهاز بلوتوث: '+ e.message);
                        return;
                    }
                    let gatt;
                    try { gatt = await device.gatt.connect(); } catch(e){ alert('فشل الاتصال بالطابعة: '+e.message); return; }
                    let characteristic = null;
                    for (const su of SERVICE_UUIDS){
                        try {
                            const service = await gatt.getPrimaryService(su);
                            for (const cu of CHAR_UUIDS){
                                try {
                                    characteristic = await service.getCharacteristic(cu);
                                    if (characteristic) break;
                                } catch(_){ }
                            }
                            if (characteristic) break;
                        } catch(_){ }
                    }
                    if (!characteristic){
                        alert('لم يتم العثور على خاصية الكتابة للطابعة (جرب تحديث قائمة UUID أو تأكد أن الطابعة BLE).');
                        try { gatt.disconnect(); } catch(_){ }
                        return;
                    }
                    try {
                        const CHUNK = 20;
                        for (let i=0;i<payload.length;i+=CHUNK){
                            const slice = payload.slice(i,i+CHUNK);
                            await characteristic.writeValue(slice);
                            await new Promise(r=>setTimeout(r,12));
                        }
                        alert('تم إرسال الفاتورة للطابعة (بلوتوث).');
                    } catch(e){
                        console.error('Bluetooth write failed', e);
                        alert('فشل إرسال البيانات للطابعة: '+ e.message);
                    } finally {
                        try { gatt.disconnect(); } catch(_){ }
                    }
                }

                document.addEventListener('DOMContentLoaded', ()=>{
                    const btBtn = document.getElementById('sales-bt-print-btn');
                    if (btBtn) btBtn.addEventListener('click', bluetoothPrintLatest);
                    const htmlBtn = document.getElementById('sales-html-print-btn');
                    if (htmlBtn) htmlBtn.addEventListener('click', window.printHtmlReceiptLatest);
                    
                    // زر التمرير السريع للأسفل
                    const scrollBtn = document.getElementById('scroll-to-bottom-btn');
                    if (scrollBtn) {
                        scrollBtn.addEventListener('click', () => {
                            const salesList = document.getElementById('sales-list');
                            if (salesList) {
                                // تمرير سلس للأسفل
                                window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
                            }
                        });
                    }
                });

                // ===== END Bluetooth Print Section =====

                // Invoice quick-search: slide-in/out from left wall with lens handle
                document.addEventListener('DOMContentLoaded', function(){
                    const wrap = document.getElementById('invoice-quick-search-wrap');
                    const content = document.getElementById('invoice-quick-search-content');
                    const toggle = document.getElementById('invoice-quick-search-toggle');
                    if (!wrap || !content || !toggle) return;
                    let open = false; // start hidden in the wall
                    function apply(){
                        // Hide completely: translate by full width
                        content.style.transform = open ? 'translateX(0%)' : 'translateX(-100%)';
                    }
                    toggle.addEventListener('click', function(){ open = !open; apply(); try { updateIcons(); } catch(_){} });
                    apply();
                    // Keep the handle visible above content
                    try { wrap.style.zIndex = '50'; } catch(_){}
                });

                // Invoice quick-search wiring (searches `state.sales` for invoice number)
                document.addEventListener('DOMContentLoaded', function(){
                    const input = document.getElementById('invoice-search-input');
                    const btn = document.getElementById('invoice-search-btn');
                    const clearBtn = document.getElementById('invoice-clear-btn');

                    function formatMoney(n){
                        try{ if (typeof formatCurrency === 'function') return formatCurrency(n); }catch(e){}
                        if (n == null) return '0';
                        return (Number(n) || 0).toLocaleString();
                    }

                    // Return a short date string (YYYY-MM-DD) for a variety of input shapes
                    function formatShortDate(val){
                        if (!val && val !== 0) return '';
                        try {
                            // If already an ISO-like string with time, take the date portion
                            if (typeof val === 'string'){
                                if (val.indexOf('T') !== -1) return val.split('T')[0];
                                if (/^\d{4}-\d{2}-\d{2}/.test(val)) return val.slice(0,10);
                                // common DD/MM/YYYY or D/M/YYYY -> parse accordingly
                                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
                                    const parts = val.split('/').map(p=>Number(p));
                                    // assume DD/MM/YYYY
                                    const d = new Date(parts[2], parts[1]-1, parts[0]);
                                    if (!isNaN(d)) return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                                }
                            }
                            // If already a Date
                            if (val instanceof Date) {
                                const d = val;
                                return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                            }
                            // Try constructing Date from value
                            const dd = new Date(val);
                            if (!isNaN(dd)) return dd.getFullYear() + '-' + String(dd.getMonth()+1).padStart(2,'0') + '-' + String(dd.getDate()).padStart(2,'0');
                        } catch(e) {}
                        // fallback to original string representation
                        return String(val);
                    }

                    function findInvoice(num){
                        if (!num) return null;
                        if (!window.state || !Array.isArray(state.sales)) return null;
                        // match invoiceNumber, nested invoice.number, id, number, ref, etc.
                        const s = state.sales.find(item => {
                            const candidates = [
                                item.invoiceNumber,
                                (item.invoice && item.invoice.number),
                                (item.invoice && item.invoice.id),
                                item.invoice,
                                item.id,
                                item.number,
                                item.ref,
                                item.invoice_no,
                                item.invoiceNumberString
                            ];
                            return candidates.some(c => c != null && String(c) === String(num));
                        });
                        return s || null;
                    }

                    function renderResult(sale){
                        const dateEl = document.getElementById('invoice-result-date');
                        const custEl = document.getElementById('invoice-result-customer');
                        const totalEl = document.getElementById('invoice-result-total');
                        const typeEl = document.getElementById('invoice-result-type');
                        const noData = document.getElementById('invoice-no-data');
                        // New compact panel fields
                        const vNumber = document.getElementById('invoice-val-number');
                        const vTotal = document.getElementById('invoice-val-total');
                        const vReturn = document.getElementById('invoice-val-return');
                        const vNet = document.getElementById('invoice-val-net');
                        const vCname = document.getElementById('invoice-val-cname');
                        const vDate = document.getElementById('invoice-val-date');

                        if (!sale){
                            if (dateEl) dateEl.textContent = '--';
                            if (custEl) custEl.textContent = '--';
                            if (totalEl) totalEl.textContent = '--';
                            if (typeEl) typeEl.textContent = '--';
                            if (vNumber) vNumber.textContent = '--';
                            if (vTotal) vTotal.textContent = '--';
                            if (vReturn) vReturn.textContent = '--';
                            if (vNet) vNet.textContent = '--';
                            if (vCname) vCname.textContent = '--';
                            if (vDate) vDate.textContent = '--';
                            if (noData) noData.classList.remove('hidden');
                            return;
                        }

                        if (noData) noData.classList.add('hidden');
                        if (dateEl) dateEl.textContent = sale.date || sale.createdAt || sale.timestamp || '--';
                        if (custEl) custEl.textContent = (sale.customerName || sale.customer || (sale.customerObj && sale.customerObj.name) || '--');
                        if (totalEl) totalEl.textContent = formatMoney(sale.total || sale.amount || sale.net || 0) + ' ج.م';
                        if (typeEl) typeEl.textContent = (sale.type || sale.kind || (sale.isReturn ? 'مرتجع' : 'بيع') || (sale.total < 0 ? 'مرتجع' : 'بيع'));
                        // populate compact panel values
                        if (vNumber) vNumber.textContent = (sale.invoiceNumber || sale.id || sale.number || '--');
                        if (vTotal) vTotal.textContent = formatMoney(sale.total || sale.amount || sale.net || 0);
                        if (vReturn) vReturn.textContent = (sale.returnAmount || (sale.total < 0 ? String(Math.abs(sale.total)) : '--'));
                        if (vNet) vNet.textContent = formatMoney(sale.net || sale.total || sale.amount || 0);
                        if (vCname) {
                            // Try many possible property names and object shapes to resolve customer name
                            var cname = '--';
                            try {
                                // Direct string-ish fields (many possible names)
                                cname = sale.customerName || sale.clientName || sale.cname || sale.customer_name || sale.customer_fullname || sale.customerNameAr || sale.customer_name_ar || sale.partyName || sale.contactName || sale.contact_name || sale.buyerName || sale.customerDisplay || sale.customer || sale.client || sale.client_name || sale.clientName || cname;

                                // If sale.customer is an object, extract its name-like fields
                                if (cname && typeof cname === 'object') {
                                    var co = cname;
                                    cname = co.name || co.fullName || co.displayName || co.title || (co.company && co.company.name) || co.customerName || co.customer_name || co.label || co.customerDisplay || '--';
                                }

                                // Check nested well-known objects
                                if ((cname === '--' || cname == null || typeof cname === 'number')) {
                                    if (sale.customerObj && typeof sale.customerObj === 'object') cname = sale.customerObj.name || sale.customerObj.fullName || sale.customerObj.displayName || cname;
                                    if ((cname === '--' || cname == null || typeof cname === 'number') && sale.client && typeof sale.client === 'object') cname = sale.client.name || sale.client.displayName || cname;
                                    if ((cname === '--' || cname == null || typeof cname === 'number') && sale.account && typeof sale.account === 'object') cname = sale.account.name || sale.account.title || cname;
                                }

                                // If sale contains phone/tax fields, try to find matching customer by those
                                if ((cname === '--' || cname == null || typeof cname === 'number') && window.state && Array.isArray(window.state.customers)) {
                                    var possibleIds = [sale.customerId, sale.customer_id, sale.clientId, sale.client_id, sale.customer_ref, sale.customerRef, sale.accountId, sale.account_id, sale.partyId, sale.party_id, sale.customerCode, sale.clientCode, sale.ref, sale.customerMobile, sale.customerPhone, sale.mobile, sale.phone, sale.taxNumber, sale.tax_number];
                                    // flatten and remove nulls
                                    possibleIds = possibleIds.filter(x=> x != null && x !== '');
                                    var found = null;
                                    if (possibleIds.length > 0) {
                                        found = window.state.customers.find(function(c){
                                            var keys = [c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode, c.mobile, c.phone, c.taxNumber, c.tax_number, c.phoneNumber, c.msisdn];
                                            return possibleIds.some(function(pid){
                                                return keys.some(function(k){ return k != null && String(k) === String(pid); });
                                            });
                                        });
                                    }
                                    // If none by ids, try fuzzy match by mobile/tax if sale has those
                                    if (!found && sale.customerPhone) {
                                        found = window.state.customers.find(function(c){ return String(c.mobile) === String(sale.customerPhone) || String(c.phone) === String(sale.customerPhone); });
                                    }
                                    if (!found && sale.customerMobile) {
                                        found = window.state.customers.find(function(c){ return String(c.mobile) === String(sale.customerMobile) || String(c.phone) === String(sale.customerMobile); });
                                    }
                                    if (!found && sale.taxNumber) {
                                        found = window.state.customers.find(function(c){ return String(c.taxNumber) === String(sale.taxNumber) || String(c.tax_number) === String(sale.taxNumber); });
                                    }
                                    if (found) {
                                        cname = found.name || found.customerName || found.fullName || found.displayName || found.title || (found.company && found.company.name) || found.customer_name || cname;
                                    }
                                }

                                // If sale.customerId is present, attempt a direct lookup using helper or by id
                                try {
                                    if ((cname === '--' || cname == null || typeof cname === 'number' || cname === 'غير معروف') && sale && (sale.customerId || sale.customer_id)) {
                                        var cidVal = sale.customerId || sale.customer_id;
                                        // try central helper first
                                        try {
                                            if (typeof findCustomer === 'function') {
                                                var f = findCustomer(cidVal);
                                                if (f && (f.name || f.customerName || f.displayName)) {
                                                    cname = f.name || f.customerName || f.fullName || f.displayName || cname;
                                                }
                                            }
                                        } catch(e) { /* ignore */ }
                                        // fallback: lookup in state.customers by id-like fields
                                        if ((cname === '--' || cname == null || cname === 'غير معروف' || typeof cname === 'number') && window.state && Array.isArray(window.state.customers)) {
                                            var found2 = window.state.customers.find(function(c){
                                                return [c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode].some(function(k){ return k != null && String(k) === String(cidVal); });
                                            });
                                            if (found2) cname = found2.name || found2.customerName || found2.displayName || found2.fullName || cname;
                                        }
                                    }
                                } catch (e) { /* ignore */ }

                                // final fallback: if cname is still an object or null, stringify a safe field or use 'غير معروف'
                                if (cname && typeof cname === 'object') {
                                    cname = cname.name || cname.displayName || JSON.stringify(cname).slice(0,60) || 'غير معروف';
                                }
                                if (!cname || cname === '--') cname = 'غير معروف';
                            } catch (e) { cname = 'غير معروف'; }
                            vCname.textContent = (cname == null ? 'غير معروف' : cname);
                        }
                        if (vDate) {
                            var rawDate = sale.date || sale.createdAt || sale.timestamp || '';
                            vDate.textContent = rawDate ? formatShortDate(rawDate) : '--';
                        }
                    }

                    if (btn) btn.addEventListener('click', function(){
                        const v = input ? input.value.trim() : '';
                        if (!v) { renderResult(null); return; }
                        const res = findInvoice(v);
                        renderResult(res);
                    });

                    if (input) input.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); btn && btn.click(); } });

                    if (clearBtn) clearBtn.addEventListener('click', function(){ if (input) input.value = ''; renderResult(null); });

                    // initialize with empty view
                    renderResult(null);

                    // Ensure there is at least one sample sale so the quick-search can be tested
                    try {
                        if (!window.state) window.state = {};
                        if (!Array.isArray(window.state.sales)) window.state.sales = [];
                        if (window.state.sales.length === 0) {
                            window.state.sales.push({
                                id: '148556',
                                invoiceNumber: '148556',
                                customerName: 'ماركت سفير',
                                total: 21252,
                                net: 21252,
                                isReturn: false,
                                date: '12/11/2025'
                            });
                        }
                    } catch (e) { console.warn('sample sale init failed', e); }
                    
                    // Wire the export button to show the sale object in a textarea for easy copy
                    try {
                        const exportBtn = document.getElementById('invoice-export-btn');
                        const exportModal = document.getElementById('invoice-export-modal');
                        const exportTextarea = document.getElementById('invoice-export-textarea');
                        const exportClose = document.getElementById('invoice-export-close-btn');
                        const exportCopy = document.getElementById('invoice-export-copy-btn');

                        function showSaleObjectForCurrentInput(){
                            try{
                                const num = (input && input.value && input.value.trim()) ? input.value.trim() : (document.getElementById('invoice-val-number') ? document.getElementById('invoice-val-number').textContent.trim() : '');
                                if (!num) {
                                    exportTextarea.value = 'لم يتم تحديد رقم الفاتورة.';
                                } else {
                                    const sale = findInvoice(num) || null;
                                    exportTextarea.value = sale ? JSON.stringify(sale, null, 2) : 'لم يتم العثور على فاتورة برقم: ' + num;
                                }
                                exportModal.style.display = 'block';
                                exportTextarea.select();
                            }catch(e){ exportTextarea.value = 'خطأ أثناء تجهيز الكائن:\n'+String(e); exportModal.style.display='block'; }
                        }

                        if (exportBtn) exportBtn.addEventListener('click', function(){ showSaleObjectForCurrentInput(); });
                        if (exportClose) exportClose.addEventListener('click', function(){ exportModal.style.display = 'none'; });
                        if (exportCopy) exportCopy.addEventListener('click', function(){ try{ exportTextarea.select(); document.execCommand('copy'); exportCopy.textContent = 'تم النسخ'; setTimeout(()=> exportCopy.textContent = 'نسخ', 1200); }catch(e){ alert('نسخ لم ينجح، انسخ النص يدوياً.'); } });
                    } catch (e) { console.warn('invoice export wiring failed', e); }
                });
            </script>
            <script>
                // Anchor the invoice quick-search panel as a fixed element next to the totals card
                (function(){
                    // قابلية التحكم في إزاحة اللوحة لأسفل قليلًا
                    if (typeof window.INVOICE_PANEL_OFFSET_TOP === 'undefined') {
                        window.INVOICE_PANEL_OFFSET_TOP = 48; // بكسلات إضافية لخفض الشريط الجانبي
                    }
                    function positionInvoicePanel(){
                        try{
                            var totalEl = document.getElementById('filtered-total-container');
                            var panel = document.getElementById('invoice-quick-search-panel');
                            if (!totalEl || !panel) return;
                            var rect = totalEl.getBoundingClientRect();
                            var offset = 12; // spacing between totals and panel
                            var isRtl = document.documentElement && document.documentElement.getAttribute('dir') === 'rtl';
                                // set fixed positioning
                                panel.style.position = 'fixed';
                                panel.style.zIndex = '2147483646';
                                panel.style.maxHeight = 'calc(100vh - 120px)';
                                // vertical: try to sit under the header (if present) or align with totals card
                                try {
                                    var headerEl = document.querySelector('header');
                                    var headerBottom = headerEl ? headerEl.getBoundingClientRect().bottom : 56;
                                    // compute top as the greater of header bottom + small gap and totals rect top
                                    var topFromTotals = rect.top;
                                    var topVal = Math.max((headerBottom + 8), topFromTotals + 0) + (window.INVOICE_PANEL_OFFSET_TOP||0);
                                    panel.style.top = (Math.round(topVal) || 64) + 'px';
                                } catch(e) { panel.style.top = '64px'; }
                                // horizontal: place next to totals card (to avoid covering invoice rows)
                                var offset = 12; // spacing between totals and panel
                                // Force the panel to the extreme left of the viewport as requested
                                try {
                                    panel.style.left = '12px';
                                    panel.style.right = 'auto';
                                } catch(e) {
                                    panel.style.left = '12px';
                                }
                        }catch(e){ console.warn('positionInvoicePanel failed', e); }
                    }
                    window.addEventListener('load', function(){ setTimeout(positionInvoicePanel, 50); });
                    window.addEventListener('resize', function(){ setTimeout(positionInvoicePanel, 60); });
                    // keep panel fixed; still recalc occasionally when scrolling
                    window.addEventListener('scroll', function(){ setTimeout(positionInvoicePanel, 120); });
                    // expose helper
                    window.positionInvoicePanel = positionInvoicePanel;
                })();
            </script>
            
            <div id="page-dispatch" class="page">
                <div id="new-dispatch-note-section" class="bg-gray-100 p-4 rounded-lg border mb-6">
                    <h3 class="text-lg font-bold mb-3">إضافة إذن استلام جديد</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="new-dispatch-note-number" class="block text-sm font-medium text-gray-700">رقم الإذن (يدوي)</label>
                            <input type="number" id="new-dispatch-note-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="new-dispatch-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                            <select id="new-dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="new-dispatch-date" class="block text-sm font-medium text-gray-700">تاريخ الإذن</label>
                            <input type="date" id="new-dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>

                    <div class="overflow-x-auto bg-white rounded-lg shadow mt-4 border">
                        <table id="new-dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">المنتج</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مستلم (كمية)</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع سليم</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع تالف</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مجاني</th>
                                    <th class="px-2 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="new-dispatch-items-container" class="divide-y divide-gray-200">
                                <!-- New item rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                         <button type="button" id="add-new-dispatch-item-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            إضافة صنف
                        </button>
                        <button type="button" id="save-new-dispatch-note-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            حفظ الإذن الجديد
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <hr class="my-6 border-t-2 border-dashed">

                <!-- Existing Dispatch Notes List -->
                <h3 class="text-lg font-bold mb-3">الأذونات السابقة</h3>
                <div id="dispatch-notes-list" class="space-y-4"></div>
                <!-- ملخص أصناف المندوب (عرض فقط) -->
                <div id="rep-dispatch-summary" class="hidden mt-8 bg-white border rounded-lg p-4">
                    <h4 class="font-bold mb-3 flex items-center gap-2 text-indigo-700"><i data-lucide="clipboard-list" class="w-5 h-5"></i> ملخص البضاعة الحالية</h4>
                    <div id="rep-dispatch-summary-content" class="text-sm"></div>
                </div>
            </div>
            
            <!-- RE-ACTIVATED REPORTS PAGE -->
            <div id="page-reports" class="page" style="padding-bottom: 50px;">
                <h2 class="text-xl font-bold mb-4 no-print">التقارير التفصيلية</h2>
                
                <div id="report-filter-container" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                    <!-- Daily Report Content -->
                    <div data-report-content="daily" class="space-y-4 active">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير المبيعات اليومي</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="daily-report-date" class="block text-sm font-medium text-gray-700">التاريخ:</label>
                                <input type="date" id="daily-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="daily-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                                <select id="daily-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="daily-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="daily-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <button id="generate-daily-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض التقرير اليومي</button>
                    </div>

                    <!-- Date Range Report Content (Hidden by default) -->
                    <div data-report-content="range" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير مبيعات فترة زمنية</h3>
                         <!-- Reuse date range form logic but simplified -->
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="range-start-date" class="block text-sm font-medium text-gray-700">من تاريخ:</label>
                                <input type="date" id="range-start-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-end-date" class="block text-sm font-medium text-gray-700">إلى تاريخ:</label>
                                <input type="date" id="range-end-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="range-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="range-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <div>
                             <label for="range-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                             <select id="range-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <button id="generate-range-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض تقرير الفترة</button>
                    </div>

                    <!-- Monthly Report Content (Hidden by default) -->
                    <div data-report-content="monthly" class="space-y-4 hidden">
                         <h3 class="font-bold text-lg text-red-600 border-b pb-2">ملخص المبيعات الشهري</h3>
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="monthly-report-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
                                <input type="month" id="monthly-report-month" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="monthly-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                                <select id="monthly-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="monthly-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="monthly-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <button id="generate-monthly-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض التقرير الشهري</button>
                    </div>

                    <!-- Reconciliation Report Content (Hidden by default) -->
                    <div data-report-content="reconciliation" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير التسوية (العجز والزيادة)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label for="recon-report-date" class="block text-sm font-medium text-gray-700">تاريخ إذن الاستلام:</label>
                                <input type="date" id="recon-report-date" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="recon-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
                                <select id="recon-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="recon-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="recon-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <button id="generate-recon-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">إنشاء تقرير التسوية</button>
                    </div>

                    <div data-report-content="targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير تحقيق التارجت الشهري لكل مندوب</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="targets-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
                                <input type="month" id="targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="targets-rep-filter" class="block text-sm font-medium text-gray-700">بحث مندوب (اختياري):</label>
                                <select id="targets-rep-filter" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="all">عرض كل المناديب</option>
                                </select>
                            </div>
                            <div>
                                <label for="targets-chain-filter" class="block text-sm font-medium text-gray-700">السلسلة:</label>
                                <select id="targets-chain-filter" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600">يعرض الجدول صافي المبيعات اليومية لكل مندوب، ومقارنة الشهر بالتارجت مع النسبة المفترضة حتى تاريخ اليوم والنسبة المحققة الفعلية.</p>
                    </div>

                    <div data-report-content="customer-targets" class="space-y-4 hidden">
                        <h3 class="font-bold text-lg text-red-600 border-b pb-2">تارجت العملاء (اكسبشن / سفير / الضحى)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="customer-targets-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
                                <input type="month" id="customer-targets-month" class="mt-1 block w-full p-2 border rounded-md" />
                            </div>
                            <div>
                                <label for="customer-targets-category" class="block text-sm font-medium text-gray-700">الفئة:</label>
                                <select id="customer-targets-category" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="multi">مالتي</option>
                                    <option value="dairy">البان</option>
                                    <option value="both" selected>الاثنين معاً</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex items-end gap-3">
                                <button id="save-customer-targets-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">حفظ التارجت</button>
                                <button id="refresh-customer-targets-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">تحديث التقرير</button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600">عدل قيم التارجت في الخلايا ثم اضغط حفظ. التقرير يحسب المحقق والمتبقي ونسبة الإنجاز لكل عميل حسب الفئة المختارة.</p>
                        <div id="customer-targets-report-output" class="mt-2"></div>
                    </div>

                </div>

                <div id="report-output-area" class="mt-6">
                    <p class="text-center text-gray-500 mt-8">اختر نوع التقرير واضغط "عرض" للبدء.</p>
                </div>
            </div>
            <!-- END RE-ACTIVATED REPORTS PAGE -->


            <!-- ########## PROMOTIONS PAGE ########## -->
            <div id="page-promotions" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">العروض الترويجية</h2>
                    <div class="flex items-center gap-2">
                        <!-- Notify dropdown (اخطار) -->
                        <div class="relative" id="promotions-notify-root">
                            <button id="promotions-notify-btn" class="bg-white border px-3 py-1 rounded-md text-sm flex items-center gap-2" aria-haspopup="true" aria-expanded="false">
                                <span class="text-sm font-semibold">اخطار</span>
                                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
                            </button>
                            <div id="promotions-notify-menu" class="hidden absolute right-0 mt-2 w-52 bg-white border rounded shadow-lg z-50">
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="prices">اخطار باسعار اصناف</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="new-item">اخطار بصنف جديد</button>
                                <button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="promotions">اخطار بعروض</button>
                            </div>
                        </div>

                        <button id="add-promotion-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 flex items-center gap-2">
                            <i data-lucide="percent"></i>
                            <span>إضافة عرض جديد</span>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <button id="promotions-view-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm">العروض</button>
                    <button id="notifications-view-btn" class="px-3 py-1 bg-white text-gray-700 rounded-md text-sm border">الاخطارات</button>
                </div>

                <!-- Batch Promotions Editor (Create many rows exactly like screenshot) -->
                <div class="bg-white border rounded-md p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <label class="text-sm">العميل</label>
                            <select id="batch-promo-customer" class="p-2 border rounded-md min-w-[220px]"></select>
                            <label class="text-sm">من</label>
                            <input id="batch-promo-from" type="date" class="p-2 border rounded-md">
                            <label class="text-sm">إلى</label>
                            <input id="batch-promo-to" type="date" class="p-2 border rounded-md">
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="batch-promo-add-row" class="px-3 py-1 bg-amber-600 text-white rounded-md text-sm">إضافة صف</button>
                            <button id="batch-promo-save" class="px-3 py-1 bg-green-600 text-white rounded-md text-sm">حفظ العروض</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full" id="batch-promo-table" style="border-collapse:separate;border-spacing:0 6px;">
                            <thead>
                                <tr>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Price</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">To</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">From</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Item Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Code</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Customer Name</th>
                                    <th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">حذف</th>
                                </tr>
                            </thead>
                            <tbody id="batch-promo-rows"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">أدخل كود الصنف والسعر؛ سيتم تطبيق العرض تلقائياً على الفترة المحددة ثم يعود السعر الطبيعي بعد انتهائها.</p>
                </div>

                <div id="promotions-list" class="space-y-3">
                    <p class="text-gray-500 text-center mt-8">لا توجد عروض مسجلة حالياً.</p>
                </div>

                <div id="notifications-list" class="space-y-3 hidden">
                    <p class="text-gray-500 text-center mt-8">لا توجد اخطارات بعد. استخدم زر "اخطار" لإنشاء واحد.</p>
                </div>
            </div>
            <!-- ########## END PROMOTIONS PAGE ########## -->


            <div id="page-customers" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">قائمة العملاء</h2>
                    <div class="flex items-center gap-2">
                        <button id="add-chain-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg shadow hover:bg-gray-300 flex items-center gap-2 text-sm">
                            <i data-lucide="layers"></i>
                            <span>إضافة سلسلة</span>
                        </button>
                        <button id="add-customer-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                            <i data-lucide="user-plus"></i>
                            <span>إضافة عميل</span>
                        </button>
                    </div>
                </div>
                <div id="chains-display" class="mb-4"></div>
                <input id="search-customers" type="text" placeholder="ابحث عن عميل..." class="w-full p-2 border rounded-md mb-4">
                <div id="customers-list" class="space-y-3"></div>
            </div>

            <div id="page-reps" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">إدارة المناديب</h2>
                    <button id="add-rep-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="user-plus"></i>
                        <span>إضافة مندوب</span>
                    </button>
                </div>
                <div id="reps-list" class="space-y-3"></div>
            </div>

            <!-- ########## SPREADSHEET ENTRY PAGE (إدخال سريع) ########## -->
            <div id="page-spreadsheet-entry" class="page">
                <h2 class="text-xl font-bold mb-4">إدخال سريع لعمليات البيع</h2>
                <div class="bg-gray-100 p-3 rounded-lg border mb-4">
                    <!-- Modified grid layout to accommodate the new field -->
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <div>
                            <label for="spreadsheet-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                            <select id="spreadsheet-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-customer" class="block text-sm font-medium text-gray-700">العميل</label>
                            <select id="spreadsheet-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                        </div>
                        <div>
                            <label for="spreadsheet-date" class="block text-sm font-medium text-gray-700">تاريخ الفواتير</label>
                            <input type="date" id="spreadsheet-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <!-- NEW: Unified Invoice Number Field -->
                        <div>
                            <label for="unified-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة (موحد)</label>
                            <input type="number" id="unified-invoice-number" class="mt-1 block w-full p-2 border border-blue-400 bg-blue-50 rounded-md font-bold" placeholder="تطبيق على كل الصفوف">
                        </div>
                        <!-- END NEW -->
                    </div>
                </div>

                <div class="overflow-x-auto shadow rounded-lg border">
                    <table id="spreadsheet-entry-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">رقم الفاتورة</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">الكود</th> <!-- NEW CODE COLUMN -->
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 uppercase min-w-[150px]">الصنف</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">الكمية</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">السعر</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">سعر معدل</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">خصم %</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">القسم</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[100px]">التحصيل</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px] spreadsheet-tax-header" style="display: none;">المنظومة</th> <!-- NEW TAX FILING COLUMN -->
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[80px]">الإجمالي</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase"></th> <!-- Delete button -->
                            </tr>
                        </thead>
                        <tbody id="spreadsheet-entry-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be added by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-between items-center flex-wrap gap-3">
                    <button id="spreadsheet-add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-1 text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>إضافة صف جديد</span>
                    </button>
                    <button id="spreadsheet-save-all-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold flex items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span>حفظ كل المدخلات</span>
                    </button>
                </div>

            </div>
             <!-- ########## END SPREADSHEET ENTRY PAGE ########## -->
            
            <!-- ########## DEBTS PAGE (المديونيات) ########## -->
            <div id="page-debts" class="page" style="display: none;">
                <div class="mb-4 flex flex-col items-end">
                    <h1 class="text-2xl font-bold text-right flex items-center gap-2">
                        <i data-lucide="file-warning" class="w-7 h-7 text-amber-600"></i>
                        <span>مديونيات المناديب</span>
                    </h1>
                    <p class="text-sm text-gray-600 text-right flex items-center gap-1">
                        <span>عرض وإدارة المديونيات</span>
                    </p>
                </div>

                <!-- debug banner removed -->

                <div class="debts-container mb-6">
                    <!-- Left sidebar: actions + stacked summary cards -->
                    <aside class="debts-sidebar">
                        <div class="debts-actions">
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-print-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">طباعة</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-csv-btn">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="ml-1">تحميل CSV</span>
                            </button>
                            <!-- Quick navigation: show reps/customers directly from debts page -->
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-reps-btn" title="عرض جميع المناديب">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11c1.657 0 3-1.343 3-3S17.657 5 16 5s-3 1.343-3 3 1.343 3 3 3zM8 11c1.657 0 3-1.343 3-3S9.657 5 8 5 5 6.343 5 8s1.343 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zM16 13c-.29 0-.62.02-.97.05C15.7 13.35 17 14.5 17 16v3h5v-2.5C22 14.17 17.33 13 16 13z"/></svg>
                                <span class="ml-1">عرض المناديب</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-customers-btn" title="عرض جميع العملاء">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.62 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0zM19.938 7.124A4 4 0 1116 3a4 4 0 013.938 4.124z"/></svg>
                                <span class="ml-1">عرض العملاء</span>
                            </button>
                            <button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-refresh-btn" title="تحديث المديونيات">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M20 4v6h-6M4 20v-6h6"/></svg>
                                <span class="ml-1">تحديث</span>
                            </button>
                        </div>

                        <!-- Debug banner removed as per user request -->

                        <div class="debt-card">
                            <div class="title">SUB TOTAL</div>
                            <div id="debts-subtotal" class="value">91,295 ج.م</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">المسدد</div>
                            <div id="debts-paid" class="value">76,336 ج.م</div>
                        </div>

                        <div class="debt-card">
                            <div class="title">عدد الفواتير</div>
                            <div id="debts-invoices-count" class="value">14,959</div>
                        </div>

                        <div class="debt-card big">
                            <div class="title">المديونيات</div>
                            <div id="debts-total-debt" class="value">2,025 ج.م</div>
                        </div>
                    </aside>

                    <!-- Right main area: filters + table -->
                    <section class="debts-main">
                        <!-- Search Filters -->
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block mb-1 text-sm">بحث باسم العميل</label>
                                <!-- Show only customers who have invoices (either paid or due) -->
                                <select id="debt-customer-filter" class="w-full p-2 border rounded-md text-sm filter-input">
                                    <option value="">جميع العملاء</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">بحث باسم المندوب</label>
                                <select id="debt-rep-filter" class="w-full p-2 border rounded-md text-sm bg-white filter-input">
                                    <option value="">جميع المناديب</option>
                                    <option value="5/11/25">5/11/25</option>
                                    <option value="7/11/25">7/11/25</option>
                                    <option value="">ترتيب حسب المندوب</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">من تاريخ</label>
                                <input type="date" id="debt-start-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm">إلى تاريخ</label>
                                <input type="date" id="debt-end-date" class="w-full p-2 border rounded-md text-sm filter-input">
                            </div>
                        </div>

                        <div class="mb-4">
                            <button id="apply-debts-filters-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">تطبيق الفلترة</button>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto bg-white rounded-lg shadow-sm" style="background: #fafafa !important;">
                            <table class="min-w-full" id="debts-detail-table" style="border-collapse: collapse !important;">
                                <thead>
                                            <tr>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:right">
                                                    <span>اسم العميل</span>
                                                    <button class="column-filter-btn" data-col="customer" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>التاريخ</span>
                                                    <button class="column-filter-btn" data-col="date" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>رقم الفاتورة</span>
                                                    <button class="column-filter-btn" data-col="invoice" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>اجمالى الفاتورة</span>
                                                    <button class="column-filter-btn" data-col="total" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>المسدد</span>
                                                    <button class="column-filter-btn" data-col="paid" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>المتبقى</span>
                                                    <button class="column-filter-btn" data-col="remaining" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                                <th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
                                                    <span>المندوب</span>
                                                    <button class="column-filter-btn" data-col="rep" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
                                                </th>
                                            </tr>
                                </thead>
                                <tbody id="debts-detail-body" class="divide-y divide-gray-200">
                                    <!-- سيتم إضافة الصفوف ديناميكياً -->
                                </tbody>
                            </table>
                            <div id="debts-empty-message" class="text-center text-gray-500 p-6 hidden">
                                لا توجد فواتير مطابقة للفلاتر
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            <!-- ########## END DEBTS PAGE ########## -->
            
            <!-- ########## CASH PAGE (الكاش) ########## -->
            <div id="page-cash" class="page" style="display:none;">
                <div id="cash-content-wrapper">
                        <h2 class="text-xl font-bold mb-4">الكاش - كشف التحصيل</h2>

                        <div class="mb-4 flex gap-2 items-center no-print">
                            <div class="ml-auto text-sm text-gray-600">اختر صف ثم استخدم الأزرار داخل كل صف لإجراءات المندوب</div>
                        </div>

                        <!-- Main grid: table (left) + summary (right) -->
                        <div class="cash-grid flex gap-4 items-start">
                            <div class="cash-table-area flex-1 overflow-x-auto bg-white rounded-lg shadow">
                                <table id="cash-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 text-center">#</th>
                                            <th class="p-2 text-center">التاريخ <button class="cash-column-filter-btn" data-col="date" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">رقم الفاتورة <button class="cash-column-filter-btn" data-col="invoice" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-right">اسم العميل <button class="cash-column-filter-btn" data-col="customer" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-right">المندوب <button class="cash-column-filter-btn" data-col="rep" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">إجمالي الفاتورة <button class="cash-column-filter-btn" data-col="total" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">خصم</th>
                                            <th class="p-2 text-center">الدفعة الأولى</th>
                                            <th class="p-2 text-center">الدفعة الثانية</th>
                                            <th class="p-2 text-center">إجمالي المحصل بعد الخصم</th>
                                            <th class="p-2 text-center">المتبقي <button class="cash-column-filter-btn" data-col="remaining" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">كشف التحصيل <button class="cash-column-filter-btn" data-col="collection" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
                                            <th class="p-2 text-center">رقم كشف التحصيل</th>
                                            <th class="p-2 text-center">الخزينة</th>
                                            <th class="p-2 text-center">إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cash-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows created by renderCash() -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Cash summary panel (totals) - right column -->
                            <aside id="cash-summary-panel" class="w-60 p-2 bg-gray-50 rounded-lg shadow-sm text-right">
                                    <table style="width:100%;border-collapse:collapse;font-size:14px;">
                                        <tbody>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">إجمالي الفواتير</td>
                                                                <td id="cash-summary-total" style="padding:6px;font-weight:700;text-align:left">0 ج.م</td>
                                                            </tr>
                                                            <tr>
                                                                <td style="padding:6px;color:#6b7280">عدد الفواتير</td>
                                                                <td id="cash-summary-count" style="padding:6px;font-weight:600;text-align:left">0</td>
                                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">الدفعات المسددة</td>
                                                <td id="cash-summary-paid" style="padding:6px;font-weight:600;color:#047857;text-align:left">0 ج.م</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">خصم خاص</td>
                                                <td id="cash-summary-discount" style="padding:6px;font-weight:600;color:#b91c1c;text-align:left">0 ج.م</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:6px;color:#6b7280">المتبقي</td>
                                                <td id="cash-summary-remaining" style="padding:6px;font-weight:700;text-align:left">0 ج.م</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="pt-2 no-print">
                                        <button id="cash-print-btn" class="w-full bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600">طباعة المحدد</button>
                                        <button id="cash-include-all-btn" class="w-full mt-2 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">شمل كل الفواتير في الكاش</button>
                                    </div>
                                </aside>
                        </div>
                    </div>
            </div>

            <!-- ########## END CASH PAGE ########## -->
            <script>
                (function(){
                    function injectCashStyles(){
                        if(document.getElementById('cash-page-styles')) return;
                        const css = `
                            /* Row states */
                            .cash-row-due { background: rgba(254, 226, 226, 0.6); }
                            .cash-row-paid { background: rgba(220, 253, 231, 0.9); }
                            .cash-row-collected { background: rgba(219, 234, 254, 0.95); }
                            .cash-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; display:inline-block; }
                            .cash-action-btn { display:inline-block; padding:4px 6px; border-radius:6px; border:none; cursor:pointer; margin:2px 6px; color:#fff; font-size:13px; }
                            .cash-action-create { background:#2563eb; }
                            .cash-action-safe { background:#059669; }

                            /* Layout: table left, summary right */
                            .cash-grid { display:flex; gap:16px; align-items:flex-start; }
                            .cash-table-area { flex:1 1 auto; max-width: calc(100% - 300px); }
                            #cash-summary-panel { width: 220px; min-width: 160px; max-width: 260px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
                            #cash-summary-panel .text-2xl { line-height:1.1; }

                            /* Make table scroll horizontally but keep summary visible */
                            .cash-table-area table { width:100%; border-collapse:collapse; }

                            /* Responsive: stack on small screens */
                            @media (max-width: 900px) {
                                .cash-grid { display:block; }
                                .cash-table-area { max-width: 100%; }
                                #cash-summary-panel { width: 100%; margin-top: 12px; }
                            }
                            /* Ensure header stays above content so pages scroll under the blue header */
                            header.sticky { z-index: 9999 !important; }
                        `;
                        const s = document.createElement('style'); s.id = 'cash-page-styles'; s.appendChild(document.createTextNode(css)); document.head.appendChild(s);
                    }

                    function renderCashSummary(sales){
                        try{
                            const total = sales.reduce((sum,s)=> sum + Number(s.total || 0), 0);
                            const paid = sales.reduce((sum,s)=> sum + (Number(s.paidAmount || 0) || ((Number(s.firstPayment||0)+Number(s.secondPayment||0)) || 0)), 0);
                            // Discount should be entered manually when creating a collection report (sale.collectionDiscount)
                            const discount = sales.reduce((sum,s)=> sum + (Number(s.collectionDiscount || 0)), 0);
                            // Remaining should account for manual discounts applied at collection
                            const remaining = total - paid - discount;
                            const elTotal = document.getElementById('cash-summary-total');
                            const elPaid = document.getElementById('cash-summary-paid');
                            const elDiscount = document.getElementById('cash-summary-discount');
                            const elRemaining = document.getElementById('cash-summary-remaining');
                            if(elTotal) elTotal.textContent = formatCurrency(total);
                            if(elPaid) elPaid.textContent = formatCurrency(paid);
                            if(elDiscount) elDiscount.textContent = formatCurrency(discount);
                            if(elRemaining) elRemaining.textContent = formatCurrency(remaining);
                            // show count if element exists
                            const elCount = document.getElementById('cash-summary-count');
                            if(elCount) elCount.textContent = String(Array.isArray(sales) ? sales.length : 0);
                        } catch(e){ console.warn('renderCashSummary error', e); }
                    }

                    function renderCash(){
                            try{
                            injectCashStyles();
                            const tbody = document.getElementById('cash-table-body');
                            if(!tbody) return;
                            // Diagnostic: log sales length + invoice numbers to help locate missing invoice
                            try {
                                console.debug('renderCash called', { stateSalesLength: Array.isArray(state.sales) ? state.sales.length : state.sales, invoiceNumbers: Array.isArray(state.sales) ? state.sales.map(s => ({id: s.id, invoiceNumber: s.invoiceNumber, includeInCash: s.includeInCash})) : [] });
                            } catch(e) { /* ignore */ }
                            tbody.innerHTML = '';
                            // Show all sales by default so Cash mirrors Sales automatically
                            const sales = Array.isArray(state.sales) ? state.sales.slice() : [];
                            // Expose the currently rendered sales for the filter menus
                            window._cashFiltersOriginalRenderedSales = sales.slice();
                            window._lastRenderedCashSales = sales.slice();

                            renderCashSummary(sales);

                            if(sales.length === 0){
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td colspan="15" class="p-4 text-center text-gray-500">لا توجد صفوف في الكاش.</td>`;
                                tbody.appendChild(tr);
                                return;
                            }

                            // Sort oldest first (old above, new below)
                            sales.sort((a,b)=> new Date(a.date || a.createdAt) - new Date(b.date || b.createdAt));
                            sales.forEach((s, idx) => {
                                const first = Number(s.firstPayment || 0);
                                const second = Number(s.secondPayment || 0);
                                const paidSum = (first + second) || Number(s.paidAmount || 0) || 0;
                                const total = Number(s.total || 0);
                                // Use explicit invoice discount and a manual collection discount (editable)
                                const invoiceDiscount = Number(s.discount || 0);
                                const collectionDiscount = Number(s.collectionDiscount || 0);
                                // Collected after discount = collected payments minus any collection discount applied
                                const collectedAfter = Math.max(0, Math.round(((first + second) - collectionDiscount) * 100) / 100);
                                // Remaining = total - collected payments - collection discount
                                const remainingAmount = Math.round((total - (first + second) - collectionDiscount) * 100) / 100;
                                const customerName = (findCustomer(s.customerId) || {}).name || s.customerName || 'غير معروف';
                                const rep = s.repName || s.rep || '';
                                const tr = document.createElement('tr');
                                // Decide row color: fully paid (remaining <= 0) -> blue, collected flag -> blue, paidToSafe -> green, due -> red
                                let rowClass = '';
                                if (typeof remainingAmount !== 'undefined' && remainingAmount <= 0) rowClass = 'cash-row-collected';
                                else if (s.collectionReportCreated) rowClass = 'cash-row-collected';
                                else if (s.paidToSafe) rowClass = 'cash-row-paid';
                                else if (s.status === 'due') rowClass = 'cash-row-due';
                                tr.className = rowClass;
                                // visibly mark rows explicitly excluded from cash (legacy flag)
                                if (s.includeInCash === false) {
                                    tr.style.opacity = '0.6';
                                    tr.dataset.excludedFromCash = 'true';
                                }
                                tr.dataset.saleId = s.id;
                                // dataset fields for filtering
                                try {
                                    tr.dataset.date = (s.date || s.createdAt || '').split('T')[0] || '';
                                    tr.dataset.invoice = String(s.invoiceNumber || '');
                                    tr.dataset.customer = String(customerName || '');
                                    tr.dataset.rep = String(rep || '');
                                    tr.dataset.total = String(total || 0);
                                    tr.dataset.paid = String(paidSum || Number(s.paidAmount || 0) || 0);
                                    tr.dataset.remaining = String(remainingAmount || 0);
                                } catch(e) { /* ignore */ }

                                tr.innerHTML = `
                                    <td class="p-2 text-center">${idx + 1}</td>
                                    <td class="p-2 text-center">${formatArabicDate(s.date || s.createdAt || new Date().toISOString())}</td>
                                    <td class="p-2 text-center">${s.invoiceNumber || ''}</td>
                                    <td class="p-2 text-right">${customerName}</td>
                                    <td class="p-2 text-right">${rep}</td>
                                    <td class="p-2 text-center">${formatCurrency(total)}</td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-discount" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(collectionDiscount))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-first-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(first))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-second-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(second))}" placeholder="0.00"></td>
                                    <td class="p-2 text-center">${formatCurrency(collectedAfter)}</td>
                                    <td class="p-2 text-center"><span class="cash-remaining" data-id="${s.id}" style="${remainingAmount > 0 ? 'background:#fee2e2;color:#991b1b;font-weight:700;padding:6px;border-radius:6px;display:inline-block;' : 'background:#dcfce7;color:#065f46;font-weight:700;padding:6px;border-radius:6px;display:inline-block;'}">${formatCurrency(remainingAmount)}</span></td>
                                    <td class="p-2 text-center">${s.collectionReportCreated ? '<span class="cash-badge" style="background:#dbeafe;color:#1e40af">تم</span>' : '<span class="cash-badge" style="background:#fef3c7;color:#92400e">لم يتم</span>'}</td>
                                    <td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-number" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(s.collectionNumber || ''))}" placeholder="رقم"></td>
                                    <td class="p-2 text-center">${s.paidToSafe ? '<span class="cash-badge" style="background:#dcfce7;color:#065f46">دخل</span>' : '<span class="cash-badge" style="background:#fef2f2;color:#991b1b">لم يدخل</span>'}</td>
                                    <td class="p-2 text-center">
                                        <button class="cash-action-btn cash-action-create" data-id="${s.id}">${s.collectionReportCreated ? 'إلغاء كشف' : 'إنشاء كشف'}</button>
                                        <button class="cash-action-btn cash-action-safe" data-id="${s.id}">${s.paidToSafe ? 'إلغاء خزينة' : 'دخل الخزينة'}</button>
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            });

                            // Attach collection number handlers
                            tbody.querySelectorAll('.cash-collection-number').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    sale.collectionNumber = input.value.trim();
                                    saveState();
                                    // just update summary/rows without full reload to keep cursor stable
                                });
                            });

                            // Attach collection discount handlers (editable in table)
                            tbody.querySelectorAll('.cash-collection-discount').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    const val = parseFloat(input.value.toString().replace(/,/g, '')) || 0;
                                    sale.collectionDiscount = Math.round(val * 100) / 100;
                                    saveState();
                                    renderCash();
                                });
                            });

                            // Attach first/second payment handlers (editable in-cash)
                            tbody.querySelectorAll('.cash-first-payment').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    const val = parseFloat(input.value.toString().replace(/,/g, '')) || 0;
                                    sale.firstPayment = Math.round(val * 100) / 100;
                                    saveState();
                                    renderCash();
                                });
                            });

                            tbody.querySelectorAll('.cash-second-payment').forEach(input => {
                                input.addEventListener('change', (ev) => {
                                    const id = input.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if(!sale) return;
                                    const val = parseFloat(input.value.toString().replace(/,/g, '')) || 0;
                                    sale.secondPayment = Math.round(val * 100) / 100;
                                    saveState();
                                    renderCash();
                                });
                            });

                            // Attach handlers for creating/cancelling collection reports
                            tbody.querySelectorAll('.cash-action-create').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const id = btn.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if (!sale) return;
                                    // If not created yet, prompt user to enter first/second payments and collection discount
                                    if (!sale.collectionReportCreated) {
                                        // Prompt for first payment
                                        const firstInput = window.prompt('أدخل قيمة الدفعة الأولى (أرقام فقط، اترك صفر إن لم يوجد):', String(Number(sale.firstPayment || 0)));
                                        if (firstInput === null) return; // cancelled
                                        const firstVal = parseFloat(firstInput.toString().replace(/,/g, '')) || 0;

                                        // Prompt for second payment
                                        const secondInput = window.prompt('أدخل قيمة الدفعة الثانية (أرقام فقط، اترك صفر إن لم يوجد):', String(Number(sale.secondPayment || 0)));
                                        if (secondInput === null) return; // cancelled
                                        const secondVal = parseFloat(secondInput.toString().replace(/,/g, '')) || 0;

                                        // Prompt for collection discount (manual)
                                        const discInput = window.prompt('أدخل قيمة الخصم في كشف التحصيل (أرقام فقط، اترك صفر إن لم يوجد):', String(sale.collectionDiscount || ''));
                                        if (discInput === null) return; // cancelled
                                        const discVal = parseFloat(discInput.toString().replace(/,/g, '')) || 0;

                                        // Save values to sale
                                        sale.firstPayment = Math.round(firstVal * 100) / 100;
                                        sale.secondPayment = Math.round(secondVal * 100) / 100;
                                        sale.collectionDiscount = Math.round(discVal * 100) / 100;
                                        sale.collectionReportCreated = true;

                                        // persist and re-render
                                        saveState();
                                        renderCash();
                                    } else {
                                        // Already created: confirm cancellation and clear collected values
                                        const confirmCancel = await customDialog({ message: 'هل تود إلغاء كشف التحصيل وإزالة قيمة الخصم والمدفوعات؟', title: 'تأكيد', isConfirm: true, confirmText: 'إلغاء كشف', confirmClass: 'bg-red-600 hover:bg-red-700' });
                                        if (!confirmCancel) return;
                                        sale.collectionReportCreated = false;
                                        sale.collectionDiscount = 0;
                                        // Optionally keep payments or clear them — clear to reflect cancellation
                                        sale.firstPayment = 0;
                                        sale.secondPayment = 0;
                                        saveState();
                                        renderCash();
                                    }
                                });
                            });

                            tbody.querySelectorAll('.cash-action-safe').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const id = btn.dataset.id;
                                    const sale = state.sales.find(x => x.id === id);
                                    if (!sale) return;
                                    sale.paidToSafe = !sale.paidToSafe;
                                    saveState();
                                    renderCash();
                                });
                            });

                                // Re-apply any active cash column filters after rendering
                                try { if (typeof window.applyCashColumnFilters === 'function') window.applyCashColumnFilters(); } catch(e) {}

                        } catch (e) {
                            console.warn('renderCash error', e);
                        }
                    }

                    function attachCashListeners(){
                                                        const printBtn = document.getElementById('cash-print-btn');
                                                        if(printBtn) printBtn.addEventListener('click', ()=> { if(typeof printSection === 'function') printSection('cash-content-wrapper'); else window.print(); });
                                                        const includeAllBtn = document.getElementById('cash-include-all-btn');
                                                        if(includeAllBtn) includeAllBtn.addEventListener('click', async () => {
                                                            try {
                                                                // Set includeInCash = true for any legacy excluded invoices
                                                                let changed = 0;
                                                                (state.sales || []).forEach(s => { if (s.includeInCash === false) { s.includeInCash = true; changed++; } });
                                                                if (changed > 0) {
                                                                    saveState();
                                                                    renderCash();
                                                                    await customDialog({ message: `تم شمل ${changed} فاتورة في الكاش.`, title: 'نجاح', confirmClass: 'bg-green-600 hover:bg-green-700' });
                                                                } else {
                                                                    await customDialog({ message: 'جميع الفواتير مُدرجة بالفعل في الكاش.', title: 'ملاحظة' });
                                                                }
                                                            } catch (e) { console.warn('includeAllBtn handler failed', e); }
                                                        });
                    }

                    // Initialise
                    document.addEventListener('DOMContentLoaded', ()=>{
                        try{ attachCashListeners(); }
                        catch(e){ console.warn('attachCashListeners error', e); }
                    });

                    // expose for manual calls / debugging
                    window.renderCash = renderCash;
                })();
            </script>
            <!-- Rep Debts Page removed per user request -->


            <div id="page-stock-control" class="page">
                <h2 class="text-xl font-bold mb-4">التحكم في المخزون</h2>

                <!-- Date Filter -->
                <div class="mb-4">
                    <label for="stock-control-date" class="block text-sm font-medium text-gray-700">عرض المخزون لتاريخ:</label>
                    <input type="date" id="stock-control-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>

                <!-- Stock Control Table -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table id="stock-control-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الصنف</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-initial">رصيد مبدئي</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-inward">اجمالي الوارد</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-production">اجمالي الانتاج</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-outbound">اجمالي المنصرف</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-book">رصيد دفتري</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-actual">رصيد فعلي</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-diff">الفرق</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider stock-col-diff">عجز / زيادة</th>
                            </tr>
                        </thead>
                        <tbody id="stock-control-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be generated by JavaScript -->
                        </tbody>
                        <tfoot class="bg-gray-100">
                            <tr>
                                <td colspan="9" class="text-center p-2">
                                    <button id="save-stock-control-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">حفظ الرصيد الفعلي (ترحيل لليوم التالي)</button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div id="page-total-bills" class="page">
                <div id="total-bills-content-wrapper">
                    <h2 class="text-xl font-bold mb-4">إجمالي الفواتير</h2>

                    <!-- Filter Controls -->
                    <div id="total-bills-filters" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label for="filter-from-date" class="block text-sm font-medium text-gray-700">من تاريخ</label>
                                <input type="date" id="filter-from-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-to-date" class="block text-sm font-medium text-gray-700">إلى تاريخ</label>
                                <input type="date" id="filter-to-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-customer-name" class="block text-sm font-medium text-gray-700">اسم العميل</label>
                                <input type="text" id="filter-customer-name" placeholder="بحث..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="filter-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة</label>
                                <input type="number" id="filter-invoice-number" placeholder="بحث..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="flex items-end">
                                <button id="apply-filters-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">تطبيق الفلترة</button>
                            </div>
                        </div>
                    </div>

                    <!-- Total Display -->
                    <div id="total-bills-summary-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg mb-4 text-center shadow-md flex items-center justify-center gap-4">
                        <div>
                            <span class="font-semibold">إجمالي الفواتير المعروضة:</span>
                            <span id="total-bills-summary-amount" class="font-bold text-green-800">0 ج.م</span>
                        </div>
                        <div class="flex items-center border-r-2 border-green-300 pr-4">
                            <input type="checkbox" id="include-total-in-export" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                            <label for="include-total-in-export" class="mr-2 text-sm font-medium text-green-900">تضمين الإجمالي</label>
                        </div>
                    </div>

                    <!-- Bills Table -->
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table id="total-bills-table" class="min-w-full divide-y divide-gray-200">
                                                                            <thead class="bg-gray-50">
                                                                                <tr>
                                                                                    <th class="p-4"><input type="checkbox" id="select-all-total-bills"></th>
                                                                                    <th data-sort="date" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">التاريخ</th>                                                            <th data-sort="invoiceNumber" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">رقم الفاتورة</th>
                                                            <th data-sort="customerName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">اسم العميل</th>
                                                            <th data-sort="repName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">اسم المندوب</th>
                                                            <th data-sort="total" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">إجمالي الفاتورة</th>
                                                            <th data-sort="status" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">النوع/الحالة</th>
                                                            <th data-sort="category" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">القسم/الصنف</th>
                                                        </tr>
                                                    </thead>                            <tbody id="total-bills-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be injected by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('total-bills-content-wrapper')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> طباعة الكل</button>
                    <button onclick="generateReportImage('total-bills-content-wrapper')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> نسخ الكل كصورة</button>
                </div>
                <div class="mt-2 p-3 border-t-2 border-dashed no-print">
                    <div class="flex gap-2">
                        <button onclick="exportSelectedRows('print')" class="w-1/2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> طباعة المحدد</button>
                        <button onclick="exportSelectedRows('image')" class="w-1/2 bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> نسخ المحدد كصورة</button>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="space-y-6">
                    <!-- شريط تحكم سريع داخل الإعدادات -->
                    <div class="flex items-center justify-end gap-2 no-print">
                        <button id="open-user-management-btn" class="bg-purple-600 text-white px-3 py-2 rounded-md text-sm hover:bg-purple-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            إدارة المستخدمين
                        </button>
                    </div>
                    <!-- إدارة المستخدمين والأدوار (للمدراء فقط) -->
                    <div id="user-management-section" class="p-4 border rounded-lg bg-white hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">إدارة المستخدمين</h3>
                            <button id="refresh-users-btn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-gray-300">تحديث</button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">يمكنك تعديل صلاحية كل مستخدم (admin, rep, viewer). التغييرات تُحفظ فوراً في Firestore.</p>
                        <div id="user-role-warning" class="p-2 mb-2 rounded border border-yellow-300 bg-yellow-50 text-yellow-800 hidden"></div>
                        <div class="mb-3 flex flex-wrap gap-2 items-center">
                            <button id="seed-missing-roles-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-plus"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M9 12h6"/><path d="M12 9v6"/></svg>
                                توليد الأدوار الناقصة
                            </button>
                            <span id="seed-roles-status" class="text-xs text-gray-600"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-right">الاسم</th>
                                        <th class="px-2 py-2 text-right">البريد</th>
                                        <th class="px-2 py-2 text-center">الدور</th>
                                        <th class="px-2 py-2 text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="bg-white divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- محدد الشهر: اختيار فترة العرض الشهرية -->
                    <div>
                        <h3 class="text-lg font-bold mb-1">الفترة الشهرية المعروضة</h3>
                        <p class="text-xs text-gray-500 mb-2">اختر شهراً لاستعراض بياناته. يبدأ التطبيق تلقائياً بالشهر الحالي، ويمكنك الرجوع لأي شهر سابق من هنا.</p>
                        <div class="flex items-center gap-2">
                            <input type="month" id="active-period-input" class="p-2 border rounded-md" />
                            <button id="active-period-today-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-300">الشهر الحالي</button>
                            <span id="active-period-indicator" class="text-sm text-gray-600 ml-auto"></span>
                        </div>
                    </div>

                    <!-- تتبع موقع المناديب (GPS) -->
                    <div id="gps-settings" class="p-4 border rounded-lg bg-white">
                        <h3 class="text-lg font-bold mb-2">تتبع موقع المناديب (GPS)</h3>
                        <div class="flex items-center gap-2 mb-1">
                            <input type="checkbox" id="gps-share-toggle" class="w-4 h-4">
                            <label for="gps-share-toggle" class="text-sm">مشاركة موقعي من هذا الجهاز</label>
                            <span id="gps-share-status" class="text-xs text-gray-600 ml-auto"></span>
                        </div>
                        <p class="text-xs text-gray-500">عند التفعيل، سيطلب المتصفح إذن الوصول للموقع ويتم تحديث الإحداثيات دورياً في السحابة.</p>
                        <div id="admin-gps-list" class="mt-3 hidden">
                            <h4 class="font-semibold mb-1">مواقع المناديب الآن</h4>
                            <div id="rep-locations-list" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2">الهدف الشهري العام للمبيعات</h3>
                        <p class="text-xs text-gray-500 mb-2">هذا هو الهدف الافتراضي (يستخدم في حال عدم اختيار مندوب محدد في لوحة المعلومات).</p>
                        <div class="flex items-center gap-2">
                            <input type="number" id="sales-target-input" class="w-full p-2 border rounded-md" placeholder="أدخل الهدف الشهري">
                            <button id="save-target-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">حفظ</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold">شعار الشركة</h3>
                        <p class="text-xs text-gray-500 mb-2">أدخل رابط الشعار (URL) ليظهر في رأس التطبيق والتقارير. يمكنك استخدام رابط ملف محلي بصيغة file:///C:/... عند تشغيل التطبيق محلياً، أو رفع الصورة إلى استضافة ثم وضع الرابط هنا.</p>
                        <div class="flex items-center gap-2">
                            <input type="text" id="company-logo-input" class="w-full p-2 border rounded-md" placeholder="https://example.com/logo.jpg أو file:///C:/Users/.../logo.jpg">
                            <button id="save-company-logo-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">نصيحة: لتحميل الصورة على الويب بسرعة استخدم خدمات مثل imgur.com أو GitHub (repo أو gist) أو أي استضافة صور لديك.</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">كتالوج المنتجات</h3>
                            <button id="add-product-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">إضافة منتج</button>
                        </div>
                        <input id="search-products" type="text" placeholder="ابحث عن منتج..." class="w-full p-2 border rounded-md mb-2">
                        <div id="products-list" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>
                    
                    <!-- قوائم الأسعار (مُرتجعة هنا في الإعدادات كما كانت قبل التعديل) -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">قوائم الأسعار</h3>
                            <button id="add-price-list-btn" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700">إضافة قائمة</button>
                        </div>
                        <div id="price-lists-container" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-2">النسخ الاحتياطي والاستعادة</h3>
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-4">
                            <div>
                                <h4 class="font-semibold mb-2">1. نسخ البيانات (Backup) </h4>
                                <p class="text-xs text-gray-600 mb-2">اضغط لإنشاء كود يحتوي على كل بياناتك (عملاء، فواتير، منتجات، مناديب). انسخ هذا الكود واحتفظ به في مكان آمن.</p>
                                <button id="backup-data-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-2">إنشاء نسخة احتياطية الآن</button>
                                <textarea id="backup-data-textarea" class="w-full p-2 border rounded-md bg-gray-200" readonly placeholder="سيظهر كود النسخة الاحتياطية هنا..."></textarea>
                                <button id="copy-backup-btn" class="w-full mt-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 hidden">نسخ الكود</button>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-2">2. استعادة البيانات (Restore)</h4>
                                <p class="text-xs text-gray-600 mb-2">الصق الكود الذي نسخته سابقاً هنا لاستعادة بياناتك. <strong class="text-red-600">تحذير: هذا سيستبدل جميع البيانات الحالية.</strong></p>
                                <textarea id="restore-data-textarea" class="w-full p-2 border rounded-md" style="height: 100px;" placeholder="الصق كود النسخة الاحتياطية هنا..."></textarea>
                                <button id="restore-data-btn" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">استعادة البيانات</button>
                            </div>
                        </div>
                    </div>

                    <!-- أداة استيراد إلى السحابة (Firestore) - للمدير فقط -->
                    <div id="admin-cloud-import-section" class="p-4 border-2 border-yellow-300 rounded-lg bg-yellow-50 space-y-3 no-print hidden">
                        <h3 class="text-lg font-bold">استيراد نسخة قديمة إلى السحابة (Firestore)</h3>
                        <p class="text-xs text-gray-700">هذه الأداة ترفع محتويات ملف النسخة الاحتياطية القديم (JSON أو TXT) مباشرةً إلى جداول Firestore (customers, products, priceLists, reps, sales...). تظهر فقط للمستخدمين ذوي صلاحية admin.</p>
                        <div class="flex items-center gap-2">
                            <input id="admin-import-file" type="file" accept=".json,.txt,application/json,text/plain" class="flex-1 p-2 border rounded-md bg-white" />
                            <button id="admin-start-import-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed">بدء الاستيراد</button>
                        </div>
                        <div id="admin-import-status" class="text-sm text-gray-700"></div>
                    </div>
                </div>
            <!-- (قوائم الأسعار الآن مُدارة من صفحة الإعدادات - تم إرجاع الواجهة إلى مكانها داخل الإعدادات) -->
        </main>

        <!-- Reports Subnav (Moved functionality to Dashboard, kept hidden nav item for consistency) -->
        <nav id="reports-subnav" class="fixed left-0 right-0 mx-auto justify-around p-2 no-print">
            <button data-report-section="daily" class="reports-subnav-item active">
                <i data-lucide="calendar"></i><span>يومي</span>
            </button>
            <button data-report-section="range" class="reports-subnav-item">
                <i data-lucide="calendar-range"></i><span>فترة</span>
            </button>
            <button data-report-section="monthly" class="reports-subnav-item">
                <i data-lucide="calendar"></i><span>شهري</span>
            </button>
            <button data-report-section="reconciliation" class="reports-subnav-item">
                <i data-lucide="scale"></i><span>التسوية النهائية</span>
            </button>
            <button data-report-section="targets" class="reports-subnav-item">
                <i data-lucide="target"></i><span>تارجت المناديب</span>
            </button>
            <button data-report-section="customer-targets" class="reports-subnav-item">
                <i data-lucide="users"></i><span>تارجت العملاء</span>
            </button>
        </nav>

        <!-- Costs Page: التكاليف (مبسطة) -->
            <div id="page-costs" class="page" style="display:none; padding-bottom: 80px;">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="flask-conical" class="w-6 h-6 text-blue-600"></i>
                        حساب تكلفة المنتج
                    </h3>
                    <div class="flex items-center gap-2">
                    <button id="add-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> منتج جديد
                    </button>
                    <!-- أزلنا أزرار الاستيراد لتقليل الإزدحام. الاستيراد مازال متاحاً عبر الدوال العامة إن لزم. -->
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm leading-relaxed mb-6">
                    أدخل مكوّنات (خامات)، مواد تعبئة، ومصاريف تشغيل لكل <span class="font-bold">دفعة إنتاج</span>. يحسب النظام التكلفة الإجمالية وتكلفة الكيلو/الوحدة النهائية.
                    مثال: منتج "جبنة قريش" يخرج 50 كجم في دفعة؛ تضيف اللبن (كمية كجم وسعر للكجم)، المنفحة، الملح، ثم التغليف (أكياس، صناديق)، ثم مصروف التشغيل (كهرباء، أجور) بالقيمة الإجمالية.
                </div>
                <!-- Price Manager (Raw, Pack, Ops) -->
                <details id="price-manager-block" class="mb-6 bg-white rounded-lg border">
                    <summary class="cursor-pointer select-none px-4 py-3 flex items-center gap-2 text-sm font-semibold">
                        <i data-lucide="wallet" class="w-4 h-4 text-blue-600"></i>
                        إدارة أسعار الخامات/التغليف/التشغيل
                        <span id="pm-summary" class="ml-auto text-gray-500 text-xs"></span>
                    </summary>
                    <div class="px-4 pb-4 pt-2">
                        <div class="flex gap-2 mb-3">
                            <button type="button" data-pm-tab="raw" class="pm-tab px-3 py-1 rounded bg-blue-600 text-white text-sm">الخامات</button>
                            <button type="button" data-pm-tab="pack" class="pm-tab px-3 py-1 rounded bg-gray-100 text-gray-800 text-sm">التغليف</button>
                            <button type="button" data-pm-tab="ops" class="pm-tab px-3 py-1 rounded bg-gray-100 text-gray-800 text-sm">التشغيل</button>
                            <div class="ml-auto flex gap-2">
                                <button type="button" id="pm-add-item-btn" class="px-3 py-1 rounded bg-green-600 text-white text-sm">إضافة عنصر</button>
                            </div>
                        </div>
                        <div id="pm-tables" class="space-y-4">
                            <div id="pm-table-raw" data-type="raw" class="pm-table">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                                        <thead>
                                            <tr>
                                                <th class="text-right px-2 py-1">الاسم</th>
                                                <th class="text-center px-2 py-1">الوحدة</th>
                                                <th class="text-center px-2 py-1">السعر الحالي</th>
                                                <th class="text-center px-2 py-1">آخر تحديث</th>
                                                <th class="text-center px-2 py-1">إجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="pm-table-pack" data-type="pack" class="pm-table hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                                        <thead>
                                            <tr>
                                                <th class="text-right px-2 py-1">الاسم</th>
                                                <th class="text-center px-2 py-1">الوحدة</th>
                                                <th class="text-center px-2 py-1">السعر الحالي</th>
                                                <th class="text-center px-2 py-1">آخر تحديث</th>
                                                <th class="text-center px-2 py-1">إجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="pm-table-ops" data-type="ops" class="pm-table hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                                        <thead>
                                            <tr>
                                                <th class="text-right px-2 py-1">الاسم</th>
                                                <th class="text-center px-2 py-1">الوحدة</th>
                                                <th class="text-center px-2 py-1">السعر الحالي</th>
                                                <th class="text-center px-2 py-1">آخر تحديث</th>
                                                <th class="text-center px-2 py-1">إجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>
                <!-- Unified Price Grid (Printable Overview) -->
                <details id="unified-price-grid-block" class="mb-6 bg-white rounded-lg border">
                    <summary class="cursor-pointer select-none px-4 py-3 flex items-center gap-2 text-sm font-semibold">
                        <i data-lucide="table" class="w-4 h-4 text-indigo-600"></i>
                        شبكة موحدة لكل الأسعار
                        <span id="unified-grid-summary" class="ml-auto text-gray-500 text-xs"></span>
                    </summary>
                    <div class="px-4 pb-4 pt-2 space-y-3">
                        <div class="flex flex-wrap gap-2 text-xs">
                            <button type="button" id="unified-refresh-btn" class="px-3 py-1 rounded bg-indigo-600 text-white">تحديث</button>
                            <button type="button" id="unified-print-btn" class="px-3 py-1 rounded bg-gray-200 text-gray-800">طباعة</button>
                            <button type="button" id="unified-export-json-btn" class="px-3 py-1 rounded bg-green-600 text-white">تصدير JSON</button>
                            <button type="button" id="unified-export-csv-btn" class="px-3 py-1 rounded bg-emerald-500 text-white">تصدير CSV</button>
                        </div>
                        <div class="overflow-x-auto border rounded">
                            <table id="unified-price-grid" class="min-w-full divide-y divide-gray-200 text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-right px-2 py-1">الاسم</th>
                                        <th class="text-center px-2 py-1">الكود</th>
                                        <th class="text-center px-2 py-1">النوع</th>
                                        <th class="text-center px-2 py-1">الوحدة</th>
                                        <th class="text-center px-2 py-1">السعر الحالي</th>
                                        <th class="text-center px-2 py-1">سعر جديد</th>
                                        <th class="text-center px-2 py-1">آخر تحديث</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="text-[11px] text-gray-500">هذه الشبكة للعرض السريع في المكتب لتقدير التكلفة. أي تعديل للأسعار يتم من خلال قسم إدارة الأسعار أعلاه.</div>
                    </div>
                </details>
                <!-- قوائم سريعة للأسماء القديمة (منتجات / خامات / تغليف) -->
                <div id="recipe-quick-lists" class="mb-6"></div>
                <div id="recipes-list" class="space-y-6"></div>
            </div>

        <!-- Main Bottom Nav - Adjusted buttons after moving reports -->
        <nav id="main-nav-bar" class="bottom-nav fixed bottom-0 left-0 right-0 mx-auto bg-white border-t shadow-t p-2 flex justify-around no-print">
            <button data-page="dashboard" class="bottom-nav-item active flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                <span class="text-xs">الرئيسية</span>
            </button>
            <button data-page="spreadsheet-entry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-table"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                <span class="text-xs">إدخال سريع</span>
            </button>
            <!-- BUTTON FOR SALES PAGE (Search, view all invoices) -->
            <button data-page="sales" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6"/><path d="M16 12h-6"/><path d="M16 16h-6"/></svg>
                <span class="text-xs">المبيعات</span>
            </button>
            <button data-page="dispatch" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>
                <span class="text-xs">الاذونات</span>
            </button>
            <!-- REPORTS BUTTON RETAINED, NOW GOES TO DEDICATED REPORTS PAGE -->
            <button data-page="reports" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                <span class="text-xs">التقارير</span>
            </button>
            <!-- COSTS / التكاليف Button -->
            <button id="costs-nav-btn" data-page="costs" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layers"><path d="M12 2 1 7l11 5 11-5L12 2z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                <span class="text-xs">التكاليف</span>
            </button>
            <button data-page="promotions" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
                <span class="text-xs">العروض</span>
            </button>
            <button data-page="customers" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span class="text-xs">العملاء</span>
            </button>
            <button data-page="reps" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2"><path d="M14 19a6 6 0 0 0-12 0"/><circle cx="8" cy="9" r="4"/><path d="M22 19a6 6 0 0 0-6-6 4 4 0 1 0 0-8"/></svg>
                <span class="text-xs">المناديب</span>
            </button>
            <!-- NEW: Cash (الكاش) Button -->
            <button id="cash-nav-btn" data-page="cash" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                <span class="text-xs">الكاش</span>
            </button>

            <!-- NEW: Debts (المديونيات) Button -->
            <button id="debts-nav-btn" data-page="debts" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <!-- Using a simple wallet/credit icon similar to design -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M21 12v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h14"/><path d="M16 3v4"/><path d="M8 12h.01"/></svg>
                <span class="text-xs">المديونيات</span>
            </button>
            <button data-page="stock-control" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                <span class="text-xs">ستوك كنترول</span>
            </button>
            <button data-page="total-bills" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                <span class="text-xs">إجمالي الفواتير</span>
            </button>
            <!-- NEW: Inquiry (استعلام) Button -->
            <button data-page="inquiry" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-xs">استعلام</span>
            </button>
            <!-- NEW: Price Lists (قوائم الأسعار) Button -->
            <button data-page="price-lists" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-dollar-sign"><path d="M7 21h10"/><path d="M12 17v-6"/><path d="M9 14h6"/><path d="M12 9h.01"/><path d="M12 3 2 9l10 6 10-6Z"/></svg>
                <span class="text-xs">قوائم الأسعار</span>
            </button>
            <button data-page="settings" class="bottom-nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                <span class="text-xs">الإعدادات</span>
            </button>
        </nav>
    </div>

    <!-- ########## MODALS ########## -->

    <!-- CUSTOM CONFIRMATION/ALERT DIALOG -->
    <div id="custom-confirm-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 id="dialog-title" class="text-xl font-bold mb-4">إشعار</h2>
            <p id="dialog-message" class="text-gray-700 mb-6"></p>
            <div id="dialog-actions" class="flex justify-end gap-3">
                <button id="dialog-cancel-btn" type="button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 hidden">إلغاء</button>
                <button id="dialog-confirm-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">تأكيد</button>
            </div>
        </div>
    </div>

    <!-- PRICE HISTORY MODAL -->
    <div id="price-history-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="ph-title" class="text-xl font-bold">سجل الأسعار</h2>
                <button id="ph-close-btn" type="button" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
            </div>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="text-center px-2 py-1">السعر</th>
                            <th class="text-center px-2 py-1">التاريخ</th>
                            <th class="text-right px-2 py-1">ملاحظة</th>
                        </tr>
                    </thead>
                    <tbody id="ph-body"></tbody>
                </table>
            </div>
            <div class="flex items-end gap-2">
                <div class="flex-1">
                    <label class="block text-xs text-gray-600 mb-1">سعر جديد</label>
                    <input id="ph-new-price" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="0.00" />
                </div>
                <div class="flex-[2]">
                    <label class="block text-xs text-gray-600 mb-1">ملاحظة (اختياري)</label>
                    <input id="ph-new-note" class="w-full p-2 border rounded" placeholder="مورد/تفاصيل" />
                </div>
                <button id="ph-add-btn" class="bg-blue-600 text-white px-3 py-2 rounded h-[42px]">إضافة</button>
            </div>
        </div>
    </div>
    
    <!-- LOADING MODAL -->
    <div id="loading-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4">
            <div class="loader"></div>
            <p id="loading-message" class="text-lg font-semibold text-gray-700">جارٍ التحميل...</p>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
            <h2 class="text-xl font-bold mb-4">تسجيل الدخول</h2>
            <form id="login-modal-form">
                <div class="mb-4">
                    <label for="login-email-modal" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                    <input type="email" id="login-email-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="login-password-modal" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                    <div class="relative">
                        <input type="password" id="login-password-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md pr-10" required>
                        <button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password-modal" title="إظهار/إخفاء">👁️</button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold">تسجيل الدخول</button>
            </form>
        </div>
    </div>

    <!-- DEBTS SUMMARY MODAL (المديونيات) -->
    <div id="debts-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right" style="display:none !important">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">ملخص المديونيات</h2>
                <button type="button" onclick="closeModal(document.getElementById('debts-summary-modal'))" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
            </div>

            <div id="debts-summary-content" class="space-y-4">
                <div>
                    <h3 class="font-bold">المديونيات حسب العملاء</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-customer" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">اسم العميل</th>
                                    <th class="text-center px-2 py-1">إجمالي الفواتير</th>
                                    <th class="text-center px-2 py-1">المسدد</th>
                                    <th class="text-center px-2 py-1">المتبقى</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
    
                    <!-- MANAGE LISTS MODAL -->
                    <div id="manage-lists-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">ادارة القوائم</h2>
                                <button type="button" onclick="closeManageListsModal()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
                            </div>

                            <!-- progress area: updated while chunked rendering proceeds -->
                            <div id="manage-lists-progress" class="mb-3 text-sm text-gray-600" style="display:none">جارٍ تحميل العناصر...</div>

                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-bold">المنتجات التامة</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-finished-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">سعر</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">الخامات (مواد إنتاج)</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-raw-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">تكلفة</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold">التغليف/التعبئة</h3>
                                    <div class="overflow-x-auto mt-2">
                                        <table id="manage-pack-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">تكلفة</th><th></th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="pt-3 border-t flex justify-between items-center">
                                    <div class="text-sm text-gray-600">يمكنك حذف أي عنصر من القوائم أو إغلاق النافذة للعودة.</div>
                                    <div>
                                        <button id="manage-export-btn" class="bg-green-600 text-white px-3 py-1 rounded">تصدير القوائم</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <div>
                    <h3 class="font-bold">المديونيات حسب المندوب</h3>
                    <div class="overflow-x-auto mt-2">
                        <table id="debts-by-rep" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr>
                                    <th class="text-right px-2 py-1">اسم المندوب</th>
                                    <th class="text-center px-2 py-1">إجمالي الفواتير</th>
                                    <th class="text-center px-2 py-1">المسدد</th>
                                    <th class="text-center px-2 py-1">المتبقى</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="pt-3 border-t">
                    <div class="flex justify-between items-center">
                        <div class="font-bold">إجمالي المديونيات (المتبقي)</div>
                        <div id="debts-summary-total" class="font-extrabold text-lg">0 ج.م</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW FULL-SCREEN SALE MODAL (for detailed single entry) -->
    <div id="sale-modal" class="modal modal-hidden fixed inset-0 bg-gray-100 z-30 flex flex-col">
        <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center no-print">
            <h2 id="sale-modal-title" class="text-xl font-bold">إضافة عملية بيع</h2>
            <button id="cancel-sale-btn" class="p-2 hover:bg-blue-700 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        </header>

        <main class="flex-grow p-4 overflow-y-auto">
            <form id="sale-form">
                <input type="hidden" id="sale-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="sale-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                        <select id="sale-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="sale-customer" class="block text-sm font-medium text-gray-700">العميل</label>
                        <select id="sale-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="sale-date" class="block text-sm font-medium text-gray-700">تاريخ الفاتورة</label>
                        <input type="date" id="sale-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="sale-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة (يدوي)</label>
                        <input type="number" id="sale-invoice-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="أدخل رقم الفاتورة من الدفتر">
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase w-2/5">المنتج</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الكمية</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">السعر</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الإجمالي</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="sale-items-container" class="bg-white divide-y divide-gray-200">
                            <!-- Sale item rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-sale-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    إضافة منتج آخر
                </button>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="sale-notes" class="block text-sm font-medium text-gray-700">ملاحظات</label>
                        <textarea id="sale-notes" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="sale-status" class="block text-sm font-medium text-gray-700">حالة الدفع</label>
                                <select id="sale-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="paid">مدفوع بالكامل</option>
                                    <option value="due">آجل</option>
                                    <option value="partial">مدفوع جزئياً</option>
                                </select>
                            </div>
                            <div id="paid-amount-container" class="hidden">
                                <label for="sale-paid-amount" class="block text-sm font-medium text-gray-700">المبلغ المدفوع</label>
                                <input type="number" id="sale-paid-amount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            </div>
                        </div>
                        <div>
                            <label for="sale-discount" class="block text-sm font-medium text-gray-700">خصم على الفاتورة (%)</label>
                            <input type="number" id="sale-discount" placeholder="مثال: 2 أو 3.5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                        </div>
                        <div>
                            <label for="sale-addition" class="block text-sm font-medium text-gray-700">إضافة على الفاتورة (%)</label>
                            <input type="number" id="sale-addition" placeholder="مثال: 14" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
                            <p class="text-xs text-gray-500 mt-1">يتم حسابها كزيادة على الإجمالي الفرعي (قبل الخصم).</p>
                        </div>
                    </div>
                </div>
            </form>
        </main>

        <footer class="p-4 bg-white border-t no-print">
            <div id="sale-summary" class="max-w-md ml-auto text-lg space-y-2">
                <div class="flex justify-between"><span>الإجمالي الفرعي:</span><span id="sale-subtotal-text">0 ج.م</span></div>
                <div class="flex justify-between text-red-600"><span>الخصم:</span><span id="sale-discount-text">0 ج.م</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold text-2xl"><span>الإجمالي النهائي:</span><span id="sale-total-text">0 ج.م</span></div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="eta-upload-from-modal-btn" class="hidden bg-purple-700 text-white px-6 py-3 rounded-lg hover:bg-purple-800 font-bold text-lg flex items-center gap-2">
                    <i data-lucide="cloud-upload" class="w-5 h-5"></i>
                    إرسال للضرائب
                </button>
                <button type="submit" form="sale-form" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg">حفظ الفاتورة</button>
            </div>
        </footer>
    </div>
    
    <!-- CUSTOMER MODAL -->
    <div id="customer-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="customer-modal-title" class="text-xl font-bold mb-4">إضافة عميل جديد</h2>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="mb-4">
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">اسم العميل</label>
                    <input type="text" id="customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <!-- NEW: Tax Number Input -->
                <div class="mb-4">
                    <label for="customer-tax-number" class="block text-sm font-medium text-gray-700">الرقم الضريبي</label>
                    <input type="text" id="customer-tax-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="أدخل الرقم الضريبي">
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-phone" class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
                    <input type="tel" id="customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="customer-address" class="block text-sm font-medium text-gray-700">العنوان (رابط خرائط جوجل)</label>
                    <input type="text" id="customer-address" placeholder="الصق رابط خرائط جوجل هنا..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <!-- NEW: Requires Tax Filing Checkbox -->
                <div class="mb-4 flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <input type="checkbox" id="customer-requires-tax" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 ml-2">
                    <label for="customer-requires-tax" class="block text-sm font-medium text-orange-800">العميل يتطلب رفع فواتيره لمنظومة الضرائب</label>
                </div>
                <!-- END NEW -->
                <div class="mb-4">
                    <label for="customer-price-list" class="block text-sm font-medium text-gray-700">قائمة الأسعار</label>
                    <select id="customer-price-list" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="mb-4">
                    <label for="customer-rep" class="block text-sm font-medium text-gray-700">المندوب المسؤول</label>
                    <select id="customer-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-customer-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ العميل</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PLACEHOLDER MODALS -->
    <div id="rep-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="rep-modal-title" class="text-xl font-bold mb-4">إدارة مندوب</h2>
            <form id="rep-form">
                <input type="hidden" id="rep-id">
                <div class="mb-4"><label for="rep-name" class="block text-sm font-medium text-gray-700">اسم المندوب</label><input type="text" id="rep-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="rep-email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني للمندوب</label><input type="email" id="rep-email" class="mt-1 block w-full p-2 border rounded-md" placeholder="example@email.com" required></div>
                <div class="mb-4"><label for="rep-serial" class="block text-sm font-medium text-gray-700">كود/سيريال</label><input type="text" id="rep-serial" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="mb-4"><label for="rep-target" class="block text-sm font-medium text-gray-700">الهدف الشهري</label><input type="number" id="rep-target" class="mt-1 block w-full p-2 border rounded-md" value="0"></div>
                <div class="mb-4"><label for="rep-next-invoice" class="block text-sm font-medium text-gray-700">رقم الفاتورة القادمة</label><input type="number" id="rep-next-invoice" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-rep-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ المندوب</button></div>
            </form>
        </div>
    </div>

    <div id="product-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="product-modal-title" class="text-xl font-bold mb-4">إدارة منتج</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="mb-4"><label for="product-code" class="block text-sm font-medium text-gray-700">كود المنتج</label><input type="text" id="product-code" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="product-name" class="block text-sm font-medium text-gray-700">اسم المنتج</label><input type="text" id="product-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="mb-4"><label for="product-price" class="block text-sm font-medium text-gray-700">السعر الافتراضي</label><input type="number" id="product-price" class="mt-1 block w-full p-2 border rounded-md" step="any" required></div>
                <div class="mb-4"><label for="product-category" class="block text-sm font-medium text-gray-700">الفئة (للتصفية)</label><input type="text" id="product-category" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div class="flex justify-end gap-3"><button type="button" id="cancel-product-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ المنتج</button></div>
            </form>
        </div>
    </div>
    
    <div id="price-list-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-4 modal-body">
            <h2 id="price-list-modal-title" class="text-xl font-bold mb-2">إدارة قائمة أسعار</h2>
            <!-- Quick discount box (editable) -->
            <div class="flex items-center justify-start gap-3 mb-3">
                <label for="price-list-discount" class="text-sm text-gray-700">نسبة الخصم السريع</label>
                <input id="price-list-discount" type="text" value="5%" class="w-16 p-1 border rounded text-center font-bold bg-white" title="اكتب نسبة الخصم مثل 5% أو 10%" />
                <span class="text-xs text-gray-500">(سيتم عرض السعر بعد الخصم في العمود الأخير)</span>
            </div>
            <form id="price-list-form">
                <input type="hidden" id="price-list-id">
                <div class="mb-4"><label for="price-list-name" class="block text-sm font-medium text-gray-700">اسم القائمة</label><input type="text" id="price-list-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <!-- Replaced products list with an Excel-like table view (keeps same id to preserve JS bindings) -->
                <div id="price-list-products" class="overflow-x-auto max-h-[60vh] border rounded-lg bg-white">
                    <table id="price-list-products-table" class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-right">م</th>
                                <th class="px-3 py-2 text-center">الكود</th>
                                <th class="px-3 py-2 text-right">اسم الصنف</th>
                                <th class="px-3 py-2 text-center">الوحدة</th>
                                <th class="px-3 py-2 text-center">الباركود</th>
                                <th class="px-3 py-2 text-center">السعر</th>
                                <th class="px-3 py-2 text-center">السعر بعد الخصم</th>
                            </tr>
                        </thead>
                        <tbody id="price-list-products-body" class="bg-white">
                            <tr>
                                <td colspan="7" class="text-center text-gray-500 p-6">جاري تحميل المنتجات...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-price-list-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ القائمة</button></div>
            </form>
        </div>
    </div>

    <!-- NEW PROMOTION MODAL -->
    <div id="promotion-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="promotion-modal-title" class="text-xl font-bold mb-4">إضافة عرض جديد</h2>
            <form id="promotion-form">
                <input type="hidden" id="promotion-id">
                <div class="mb-4">
                    <label for="promotion-name" class="block text-sm font-medium text-gray-700">اسم العرض</label>
                    <input type="text" id="promotion-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="promotion-product" class="block text-sm font-medium text-gray-700">المنتج</label>
                    <select id="promotion-product" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                </div>
                <div id="original-price-display" class="mb-2 text-sm text-gray-600 hidden">
                    السعر الافتراضي للمنتج: <span id="current-product-price" class="font-bold"></span>
                </div>
                 <div class="mb-4">
                    <label for="promotion-price" class="block text-sm font-medium text-gray-700">سعر العرض</label>
                    <input type="number" id="promotion-price" class="mt-1 block w-full p-2 border border-red-400 bg-red-50 rounded-md font-bold" required step="any" placeholder="السعر المخفض">
                </div>
                <div class="mb-4">
                    <label for="promotion-customer-id" class="block text-sm font-medium text-gray-700">العميل المستهدف (اختياري)</label>
                    <select id="promotion-customer-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                    <p class="text-xs text-gray-500 mt-1">إذا لم تختر عميلاً، سيتم تطبيق العرض على **جميع** العملاء.</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="promotion-start-date" class="block text-sm font-medium text-gray-700">تاريخ البداية</label>
                        <input type="date" id="promotion-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="promotion-end-date" class="block text-sm font-medium text-gray-700">تاريخ الانتهاء</label>
                        <input type="date" id="promotion-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-promotion-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">حفظ العرض</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END PROMOTION MODAL -->

    <!-- NOTIFICATION (اخطار) MODAL -->
    <div id="notify-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
            <div class="flex justify-between items-center mb-3">
                <h2 id="notify-modal-title" class="text-xl font-bold">اخطار</h2>
                <button type="button" onclick="closeNotifyModal()" class="p-2 hover:bg-gray-100 rounded-md">إغلاق</button>
            </div>
            <form id="notify-form">
                <input type="hidden" id="notify-type" value="">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-sm font-medium">عنوان الإخطار (كلمتين)</label>
                        <input id="notify-title" type="text" maxlength="40" placeholder="مثال: تغيير سعر" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="text-sm font-medium">النوع</label>
                        <select id="notify-type-select" class="mt-1 block w-full p-2 border rounded-md">
                            <option value="prices">تغيير سعر</option>
                            <option value="new-item">صنف جديد</option>
                            <option value="promotions">عرض</option>
                        </select>
                    </div>
                </div>

                <div id="notify-product-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">اختر صنف</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-product"></select>
                </div>

                <div id="notify-promo-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">اختر عرض</label>
                    <select class="mt-1 block w-full p-2 border rounded-md" id="notify-promo"></select>
                </div>

                <div id="notify-new-item-container" style="display:none;" class="mb-3">
                    <label class="text-sm font-medium">اسم الصنف الجديد</label>
                    <input type="text" id="notify-new-item-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="ادخل اسم الصنف الجديد">
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">قائمة الأصناف والأسعار (صفوف مثل Excel)</label>
                    <div class="mt-2 mb-2 grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-500">اختر عميل (اختياري)</label>
                            <select id="notify-customer" class="mt-1 block w-full p-2 border rounded-md"></select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">خصم عام % (تطبيق على كل الصفوف)</label>
                            <input id="notify-global-discount" type="number" min="0" max="100" step="0.01" placeholder="0" class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <div class="mt-2 mb-2 flex gap-2">
                        <button type="button" id="notify-add-row-btn" class="bg-gray-100 px-3 py-1 rounded-md">إضافة صف</button>
                        <button type="button" id="notify-paste-btn" class="bg-gray-100 px-3 py-1 rounded-md">لصق من Excel</button>
                    </div>
                    <div class="overflow-x-auto border rounded">
                        <table class="min-w-full text-sm" id="notify-rows-table">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-right">كود</th>
                                <th class="px-2 py-2 text-right">صنف</th>
                                <th class="px-2 py-2 text-center">سعر</th>
                                <th class="px-2 py-2 text-center">خصم %</th>
                                <th class="px-2 py-2 text-center">سعر بعد الخصم</th>
                                <th class="px-2 py-2"></th>
                            </tr></thead>
                            <tbody id="notify-rows-body"><tr><td colspan="6" class="text-center text-gray-500 p-4">لا توجد صفوف بعد.</td></tr></tbody>
                        </table>
                    </div>
                    <textarea id="notify-paste-area" placeholder="الصق بيانات Excel هنا (كود\tاسم\tسعر\tخصم%)" class="w-full mt-2 p-2 border rounded-md" style="display:none;min-height:80px"></textarea>
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">نص موجز (اختياري)</label>
                    <input id="notify-short-text" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="سطر قصير يظهر مع الإخطار للمستخدم أو العميل">
                </div>
                <div class="mb-3">
                    <label class="text-sm font-medium">رابط شعار الشركة (اختياري)</label>
                    <input id="notify-logo-url" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="https://example.com/logo.png - سيضاف كرابط في الرسالة">
                    <p class="text-xs text-gray-500 mt-1">ملاحظة: لإرسال صورة فعلياً عبر واتساب تحتاج رفع الصورة على URL متاح ثم استخدام واجهة واتساب لإرسال ميديا. هنا سنضيف رابط الشعار داخل النص.</p>
                </div>

                <div class="flex justify-between items-center gap-2">
                    <div class="flex gap-2">
                        <button type="button" id="notify-share-wa-btn" class="bg-green-600 text-white px-4 py-2 rounded-md">مشاركة على واتساب</button>
                        <button type="button" onclick="closeNotifyModal()" class="bg-gray-300 px-4 py-2 rounded-md">إلغاء</button>
                    </div>
                    <div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">حفظ الإخطار</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Safety: force a debts render and make rows visible when the page finishes loading.
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setTimeout(() => {
                    try {
                        if (typeof renderDebts === 'function') {
                            try { renderDebts(); } catch (e) { console.warn('renderDebts call failed', e); }
                        }
                        const tbody = document.getElementById('debts-detail-body');
                        if (tbody) {
                            Array.from(tbody.children).forEach(tr => {
                                try {
                                    tr.style.display = 'table-row';
                                    tr.style.visibility = 'visible';
                                    tr.style.opacity = '1';
                                    Array.from(tr.children).forEach(td => {
                                        td.style.display = 'table-cell';
                                        td.style.color = '#111';
                                        td.style.opacity = '1';
                                        td.style.visibility = 'visible';
                                        td.style.fontSize = '14px';
                                    });
                                } catch (e) {}
                            });
                            console.log('Force-styled debts rows, count=', tbody.children.length);
                        }
                    } catch (e) { console.warn('Debts force-render failed', e); }
                }, 150);
            } catch (e) { console.warn('Debts DOMContentLoaded handler failed', e); }
        });
    </script>

    <!-- Modals for Reports/Dispatch/Statements (Keeping placeholders for compatibility) -->
    <div id="statement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4"></div>
    <div id="date-range-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        	<!-- Date Range Form / Statement Customer List -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-xl font-bold mb-4">كشف حساب يدوي</h2>
            <form id="date-range-form">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">تاريخ البداية</label>
                        <input type="date" id="start-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">تاريخ الانتهاء</label>
                        <input type="date" id="end-date" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">تصفية حسب صنف:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center"><input type="radio" name="product-category" value="all" checked class="text-blue-600 focus:ring-blue-500 ml-1"> الكل</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="dairy" class="text-blue-600 focus:ring-blue-500 ml-1"> ألبان</label>
                        <label class="flex items-center"><input type="radio" name="product-category" value="multi" class="text-blue-600 focus:ring-blue-500 ml-1"> مالتي</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="supermarket-chain-filter" class="block text-sm font-medium text-gray-700">تصفية حسب السلسلة</label>
                    <select id="supermarket-chain-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="all">جميع الفروع</option>
                        <option value="exception">اكسبشن ماركت</option>
                        <option value="awladragab">اولاد رجب</option>
                        <option value="samysalama">سامي سلامه</option>
                        <option value="gomlamarket">جملة ماركت</option>
                        <option value="dreams">دريمز</option>
                    </select>
                </div>
                <h3 class="text-lg font-bold mb-3 border-t pt-4">اختر العملاء المطلوبين:</h3>
                <input type="text" id="statement-customer-search" placeholder="ابحث باسم العميل..." class="w-full p-2 border rounded-md mb-3">
                <div id="statement-customer-list" class="space-y-1 max-h-48 overflow-y-auto border p-2 rounded-md bg-gray-50">
                    <!-- Customers will be injected here -->
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-date-range-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">إنشاء كشف الحساب</button>
                </div>
            </form>
        </div>
    </div>
    <div id="dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <h2 id="dispatch-modal-title" class="text-xl font-bold mb-4">إضافة إذن استلام بضاعة</h2>
            <form id="dispatch-note-form">
                <input type="hidden" id="dispatch-note-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="dispatch-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
                        <select id="dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="dispatch-date" class="block text-sm font-medium text-gray-700">تاريخ الإذن</label>
                        <input type="date" id="dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>

                <div class="overflow-x-auto bg-gray-50 rounded-lg shadow mt-4 border">
                    <table id="dispatch-items-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">المنتج</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مستلم (كمية)</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع سليم</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع تالف</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مجاني</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="dispatch-items-container" class="divide-y divide-gray-200">
                            <!-- Dispatch item rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-dispatch-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    إضافة صنف آخر للإذن
                </button>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-dispatch-note-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ الإذن</button>
                </div>
            </form>
        </div>
    </div>
    <div id="view-dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Content injected dynamically -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
            <div id="dispatch-note-view-content">
                <!-- Report details will be injected here -->
            </div>
            <div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
                <button id="close-view-dispatch-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
                <button id="print-dispatch-btn" onclick="printSection('dispatch-note-view-content')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                    <span>طباعة (Ctrl+P)</span>
                </button>
            </div>
        </div>
    </div>
    <div id="settlement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
        <!-- Adding main content div inside modal placeholder for consistency -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6">
            <h2 id="settlement-modal-title" class="text-xl font-bold mb-4">تسوية مرتجعات إذن الاستلام</h2>
            <div id="settlement-content">
                <!-- Settlement report will be generated here -->
                <p class="text-center text-gray-500 mt-2">يتم تحميل بيانات التسوية...</p>
            </div>
            <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('settlement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="reconciliation-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"></div>
    <div id="rep-sales-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body">
             <h2 id="rep-sales-summary-title" class="text-xl font-bold mb-4">كشف حساب المندوب</h2>
             <div id="rep-sales-summary-content">
                 <!-- Rep Statement content injected dynamically -->
             </div>
             <div class="flex justify-end mt-4">
                 <button onclick="closeModal(document.getElementById('rep-sales-summary-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="daily-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="customer-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
    <div id="ai-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>

    <!-- NEW: Image Preview Modal -->
    <div id="image-preview-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <h2 class="text-xl font-bold mb-4">معاينة الصورة</h2>
            <p class="text-sm text-gray-600 mb-4">يمكنك الآن نسخ الصورة بالضغط عليها بالزر الأيمن (أو الضغط المطول في الجوال) واختيار "نسخ الصورة"، أو تحميلها على جهازك.</p>
            <div id="image-preview-container" class="mb-4 border p-2 bg-gray-100 max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal(document.getElementById('image-preview-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
                <button id="download-image-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">تحميل الصورة</button>
            </div>
        </div>
    </div>


    <!-- Removed duplicate Firebase SDK (9.6.10) to avoid double init -->

    <script>
        // ===== Role-based page guard =====
        const ROLE_PAGE_ALLOW = {
            admin: 'ALL',
            reviewer: new Set(['dashboard','reports','sales','customers','promotions','price-lists','inquiry']),
            // تم توحيد السماح للمندوب مع الأيقونات الظاهرة: الرئيسية، إدخال سريع، المبيعات، الاستعلام، الأذونات
            rep: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch']),
            user: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch'])
        };
        let lastRequestedPage = null; // لتتبع الصفحة التي حاول المستخدم فتحها فعلياً
        function canAccessPage(pageName){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // السماح المؤقت للضيف (قبل تسجيل الدخول) بفتح لوحة المعلومات فقط بدون رسائل مزعجة
                if (role === 'guest') {
                    return pageName === 'dashboard';
                }
                if (role === 'admin') return true;
                const set = ROLE_PAGE_ALLOW[role];
                if (!set) return false;
                if (set === 'ALL') return true;
                return set.has(pageName);
            } catch(_) { return false; }
        }

        // Global observer: prevent unauthorized page activation even if toggled elsewhere
        (function(){
            try {
                const obs = new MutationObserver((mutations)=>{
                    try {
                        const actives = Array.from(document.querySelectorAll('.page.active'));
                        actives.forEach(el => {
                            const id = el.id || '';
                            const page = id.startsWith('page-') ? id.slice(5) : null;
                            if (!page) return;
                            if (!canAccessPage(page)) {
                                el.classList.remove('active');
                                el.style.display = 'none';
                                // لا نظهر الرسالة إلا إذا كان المستخدم هو من طلب الصفحة
                                if (lastRequestedPage === page) {
                                    try { customDialog({ title:'غير مصرح', message:'صلاحياتك لا تسمح بفتح هذه الصفحة.' }); } catch(_) { alert('غير مصرح'); }
                                }
                                try { navigateTo('dashboard'); } catch(_) { }
                            }
                        });
                    } catch(e){}
                });
                obs.observe(document.documentElement, { subtree:true, attributes:true, attributeFilter:['class','style'] });
            } catch(e){}
        })();

        // إضافة وظيفة التنقل بين الصفحات (تفويض كامل إلى navigateTo)
        function switchPage(pageName) {
            try { lastRequestedPage = pageName; } catch(_){}
            if (typeof navigateTo === 'function') { navigateTo(pageName); return; }
        }

        // ربط الأيقونات بوظيفة التنقل
        document.addEventListener('DOMContentLoaded', function() {
            // إضافة مستمع الحدث لكل زر في شريط التنقل
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pageName = this.getAttribute('data-page');
                    if (pageName) {
                        // تحديث الفترة النشطة قبل الانتقال إلى صفحة المبيعات
                        if (pageName === 'sales' || pageName === 'reports' || pageName === 'debts') {
                            try { ensureDefaultActivePeriod(); } catch(e){}
                        }
                        switchPage(pageName);
                    }
                });
            });
            // عرض جميع الأيقونات لكن مع منع التنقل للمندوب بالرسالة داخل switchPage
            // إخفاء العناصر غير المصرح بها للمندوب لتقليل الإرباك البصري
            setTimeout(()=>{
                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role && role !== 'admin' && ROLE_PAGE_ALLOW[role] && ROLE_PAGE_ALLOW[role] !== 'ALL') {
                        const allowed = ROLE_PAGE_ALLOW[role];
                        document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                            const pg = btn.getAttribute('data-page');
                            if (pg && !allowed.has(pg)) {
                                btn.style.display = 'none';
                            }
                        });
                    }
                } catch(e){}
            }, 400);
            
            // عرض الصفحة الرئيسية عند بدء التشغيل
            switchPage('dashboard');

            // إعادة فحص الأيقونات بعد تَحَدُّث الدور (من guest إلى دور فعلي) أول دقيقتين
            let roleCheckCount = 0;
            const roleCheckInterval = setInterval(()=>{
                roleCheckCount++;
                const currentRole = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (currentRole && currentRole !== 'guest') {
                    try {
                        if (currentRole !== 'admin' && ROLE_PAGE_ALLOW[currentRole] && ROLE_PAGE_ALLOW[currentRole] !== 'ALL') {
                            const allowed = ROLE_PAGE_ALLOW[currentRole];
                            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                                const pg = btn.getAttribute('data-page');
                                if (pg && !allowed.has(pg)) btn.style.display = 'none';
                            });
                        }
                    } catch(e){}
                    clearInterval(roleCheckInterval);
                } else if (roleCheckCount > 120) { // تقريباً دقيقتان (120 * 1ث)
                    clearInterval(roleCheckInterval);
                }
            }, 1000);
        });

        // ألغينا التوكيد الإضافي الذي كان يفرض عرض لوحة المعلومات بأسلوب inline
        // الاعتماد الآن على navigateTo + CSS (.page/.active) فقط
    </script>


    <!-- Lucide Icons - Direct CDN Link -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        // debug: avoid blocking alerts during load
        console.log('بدء تحميل الكود');

        let observer;

        const initIcons = () => {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                // Disconnect the observer before making changes to the DOM to prevent infinite loops.
                if (observer) {
                    observer.disconnect();
                }

                window.lucide.createIcons();

                // Reconnect the observer after changes are made.
                if (observer) {
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                    });
                }
            }
        };

        // Create an observer instance to watch for dynamically added icons.
        observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    // Check if any added nodes need icons.
                    const hasLucideIcons = Array.from(mutation.addedNodes).some(
                        (node) =>
                            node.nodeType === Node.ELEMENT_NODE &&
                            (node.hasAttribute('data-lucide') || node.querySelector('[data-lucide]'))
                    );
                    if (hasLucideIcons) {
                        initIcons();
                        // Once icons are initialized for this batch of mutations, we can stop.
                        break;
                    }
                }
            }
        });

        // Initial icon creation and start of observation.
        document.addEventListener('DOMContentLoaded', () => {
            initIcons();
            observer.observe(document.body, {
                childList: true,
                subtree: true,
            });
        });

        // A fallback for any icons that might have been missed.
        window.addEventListener('load', initIcons);
        // زر توليد الأدوار الناقصة (إداري فقط)
        document.addEventListener('click', function(e){
            const btn = e.target.closest('#seed-missing-roles-btn');
            if (!btn) return;
            try {
                const role = (typeof getUserRole==='function')? getUserRole(): 'user';
                if (role !== 'admin') { alert('هذه العملية للمشرف فقط'); return; }
                const statusEl = document.getElementById('seed-roles-status');
                if (statusEl) statusEl.textContent = 'جاري الفحص...';
                if (!window.db) { if (statusEl) statusEl.textContent='Firestore غير جاهز'; return; }
                const users = (window.state && Array.isArray(state.users)) ? window.state.users : [];
                const forcedAdmins = new Set((window.FORCED_ADMINS||[]).map(e=>String(e).toLowerCase()));
                const forcedReviewers = new Set((window.FORCED_REVIEWERS||[]).map(e=>String(e).toLowerCase()));
                const missing = [];
                users.forEach(u => {
                    const uid = u._id || u.uid || u.id; const email = (u.email||'').toLowerCase();
                    if (!uid) return;
                    if (u.role) return; // لديه دور بالفعل في users
                    if (forcedAdmins.has(email) || forcedReviewers.has(email)) return; // أدوار إجبارية
                    missing.push({ uid, email });
                });
                if (missing.length === 0) { if (statusEl) statusEl.textContent='لا توجد أدوار ناقصة.'; return; }
                if (statusEl) statusEl.textContent = 'إنشاء '+missing.length+' مستند دور...';
                const ops = missing.map(m => window.db.collection('roles').doc(m.uid).set({ role: 'rep', email: m.email, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                Promise.allSettled(ops).then(results => {
                    const ok = results.filter(r=>r.status==='fulfilled').length;
                    const fail = results.length - ok;
                    if (statusEl) statusEl.textContent = 'تم إنشاء '+ok+' / '+results.length+'؛ فشل '+fail+'.';
                    document.dispatchEvent(new Event('role-ready'));
                }).catch(err => { if (statusEl) statusEl.textContent='خطأ: '+err.message; });
            } catch(err){ console.warn('seed-missing-roles error', err); }
        });

        // Ensure constants and utility functions are defined at the top level
        const DEFAULT_PRODUCTS = [
             {id: '1', name: 'لبن جاموسى', price: 44.00, category: 'dairy'}, {id: '3', name: 'زبادى بلدى', price: 9.00, category: 'multi'}, {id: '4', name: 'ارز باللبن', price: 17.50, category: 'multi'}, {id: '18', name: 'قريش كاملة الدسم', price: 100.00, category: 'dairy'}, {id: '11', name: 'قريش خالية الدسم', price: 95.00, category: 'dairy'}, {id: '14', name: 'ذبدة جاموسي 900 جم', price: 315.00, category: 'multi'}, {id: '13', name: 'ذبدة بقرى 900', price: 280.00, category: 'multi'}, {id: '30', name: 'مش قطع', price: 150.00, category: 'dairy'}, {id: '32', name: 'مش كريمى', price: 120.00, category: 'dairy'}, {id: '200', name: 'صوص شيدر', price: 200.00, category: 'dairy'}, {id: '201', name: 'نستو', price: 190.00, category: 'dairy'}, {id: '56', name: 'فيتا سادة نباتى', price: 110.00, category: 'dairy'}, {id: '57', name: 'فيتا فلفل نباتى', price: 110.00, category: 'dairy'}, {id: '53', name: 'ملح خفيف نباتى', price: 110.00, category: 'dairy'}, {id: '153', name: 'ملح خفيف طبيعى', price: 170.00, category: 'dairy'}, {id: '156', name: 'فيتا سادة طبيعى', price: 170.00, category: 'dairy'}, {id: '157', name: 'فيتا فلفل طبيعى', price: 170.00, category: 'dairy'}, {id: '59', name: 'سمنة جاموسى 200 جم', price: 100.00, category: 'multi'}, {id: '60', name: 'سمنة بقرى 200 جم', price: 90.00, category: 'multi'}, {id: '154', name: 'جبنة كيري طبيعى', price: 150.00, category: 'dairy'}, {id: '12', name: 'قشطة بلدى', price: 200.00, category: 'dairy'}, {id: '42', name: 'مورتة وزن', price: 150.00, category: 'dairy'}, {id: '52', name: 'مورتة 300 جم', price: 65.00, category: 'multi'}, {id: '41', name: 'سمنة جاموسى 800 جم', price: 360.00, category: 'multi'}, {id: '43', name: 'سمنة جاموسى 500 جم', price: 230.00, category: 'multi'}, {id: '44', name: 'سمنة بقرى 800 جم', price: 340.00, category: 'multi'}, {id: '45', name: 'سمنةة بقرى 500 جم', price: 220.00, category: 'multi'}, {id: '20', name: 'موزوريلا 900 جم طبيعى', price: 190.00, category: 'multi'}, {id: '21', name: 'موزوريلا 350 جم طبيعى', price: 80.00, category: 'multi'}, {id: '61', name: 'موزوريلا وزن طبيعى', price: 170.00, category: 'multi'}, {id: '39', name: 'ارز فخار', price: 25.00, category: 'multi'}, {id: '40', name: 'زبادى فخار', price: 17.50, category: 'multi'}, {id: '98', name: 'لبنة تركى', price: 150.00, category: 'dairy'}
        ];
        
        let state = { 
            customers: [], 
            products: [], 
            sales: [], 
            priceLists: [], 
            dispatchNotes: [], 
            reps: [], 
            promotions: [],
            settings: { salesTarget: 10000 },
            stockEntries: {},
            lastSyncTimestamp: null,
            invoiceHighlights: {},
            highlightCounter: 0 
        };

        // DOM Elements (defined here for wider scope access)
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.bottom-nav-item');
        const headerTitle = document.getElementById('header-title');
        const reportsSubnav = document.getElementById('reports-subnav');
        const loadingModal = document.getElementById('loading-modal');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const dialogTitle = document.getElementById('dialog-title');
        const dialogMessage = document.getElementById('dialog-message');
        const dialogActions = document.getElementById('dialog-actions');
        const dialogConfirmBtn = document.getElementById('dialog-confirm-btn');
        const dialogCancelBtn = document.getElementById('dialog-cancel-btn');

        // Forms (defined here for wider scope access)
        const saleModal = document.getElementById('sale-modal');
        const customerModal = document.getElementById('customer-modal');
        const repModal = document.getElementById('rep-modal'); 
        const productModal = document.getElementById('product-modal');
        const priceListModal = document.getElementById('price-list-modal');
        const promotionModal = document.getElementById('promotion-modal');
        const dateRangeModal = document.getElementById('date-range-modal');
        const dispatchNoteModal = document.getElementById('dispatch-note-modal');
        const viewDispatchNoteModal = document.getElementById('view-dispatch-note-modal');
        const settlementModal = document.getElementById('settlement-modal'); 
        const reconciliationModal = document.getElementById('reconciliation-modal');
        const repSalesSummaryModal = document.getElementById('rep-sales-summary-modal');
        const dailySalesReportModal = document.getElementById('daily-sales-report-modal');
        const customerSalesReportModal = document.getElementById('customer-sales-report-modal');
        const aiModal = document.getElementById('ai-modal'); 
        const loginModal = document.getElementById('login-modal'); // NEW

        // Forms References
        const saleForm = document.getElementById('sale-form');
        const customerForm = document.getElementById('customer-form');
        const repForm = document.getElementById('rep-form'); 
        const productForm = document.getElementById('product-form');
        const priceListForm = document.getElementById('price-list-form');
        const promotionForm = document.getElementById('promotion-form');
        const dateRangeForm = document.getElementById('date-range-form');
        const dispatchNoteForm = document.getElementById('dispatch-note-form');
        // const settlementForm = document.getElementById('settlement-form'); // settlement form might not exist

        // NEW Authentication Elements
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const logoutBtn = document.getElementById('logout-btn');

        // Spreadsheet Entry Elements (defined here for wider scope access)
        const spreadsheetRepSelect = document.getElementById('spreadsheet-rep');
        const spreadsheetCustomerSelect = document.getElementById('spreadsheet-customer');
        const spreadsheetDateInput = document.getElementById('spreadsheet-date');
        const spreadsheetEntryBody = document.getElementById('spreadsheet-entry-body');
        const spreadsheetAddRowBtn = document.getElementById('spreadsheet-add-row-btn');
        const spreadsheetSaveAllBtn = document.getElementById('spreadsheet-save-all-btn');
        const unifiedInvoiceNumberInput = document.getElementById('unified-invoice-number'); // Reference to the unified input
        const reportsSubnavItems = document.querySelectorAll('.reports-subnav-item');
        const dispatchItemsContainer = document.getElementById('dispatch-items-container');
        
        // Report Page Elements
        const reportContentAreas = document.querySelectorAll('#page-reports [data-report-content]');
        const dailyReportDateInput = document.getElementById('daily-report-date');
        const dailyReportRepSelect = document.getElementById('daily-report-rep');
        const rangeStartDateInput = document.getElementById('range-start-date');
        const rangeEndDateInput = document.getElementById('range-end-date');
        const rangeReportRepSelect = document.getElementById('range-report-rep');
        const monthlyReportMonthInput = document.getElementById('monthly-report-month');
        const monthlyReportRepSelect = document.getElementById('monthly-report-rep');
        const reportOutputArea = document.getElementById('report-output-area');

        // Chart instances
        let sales7DaysChart;
        let topRepsChart;
        let topProductsChart;
        let topCustomersChart;

        // Utility Functions
        const arabicMonths = [
            "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
            "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
        ];

        function formatArabicDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatArabicDateTime(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            return `${day}/${month}/${year} ${hour}:${minute}`;
        }

        const formatCurrency = (num) => new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(num || 0);
        const findCustomer = (id) => {
            const sid = id != null ? String(id) : '';
            return state.customers.find(c => String(c.id) === sid || String(c._id) === sid);
        };
        const findProduct = (id) => {
            const sid = id != null ? String(id) : '';
            return state.products.find(p => String(p.id) === sid) ||
                   state.products.find(p => String(p._id) === sid) ||
                   state.products.find(p => String(p.sku) === sid);
        };
        const findPriceList = (id) => state.priceLists.find(pl => pl.id === id);
        const findRep = (name) => state.reps.find(r => r.name === name);
        const openModal = (modal) => {
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            if (modal.id === 'date-range-modal') {
                // Ensure customers are loaded and then update the list
                // Assuming state.customers is already populated by this point
                updateCustomerList();
            }
        }
        const closeModal = (modal) => { modal.classList.add('modal-hidden'); modal.classList.remove('modal-visible'); }

        // Company logo helpers
        function getCompanyLogoUrl() {
            try {
                if (state.settings && state.settings.companyLogo) return state.settings.companyLogo;
                return window.DEFAULT_COMPANY_LOGO_URL || '';
            } catch (e) { return window.DEFAULT_COMPANY_LOGO_URL || ''; }
        }
        function renderCompanyLogo() {
            try {
                const url = getCompanyLogoUrl();
                const img = document.getElementById('company-logo-img');
                if (!img) return;
                if (url) {
                    img.src = url;
                    img.style.display = '';
                    // also apply watermark for the app using this url
                    try { applyWatermark(url); } catch(e) { console.warn('applyWatermark from renderCompanyLogo failed', e); }
                } else {
                    img.src = '';
                    img.style.display = 'none';
                    // remove watermark if exists
                    try { applyWatermark(''); } catch(e) { console.warn('remove watermark failed', e); }
                }
            } catch (e) { console.warn('renderCompanyLogo error', e); }
        }
        // Watermark helper: inject CSS that places the logo as a centered watermark
        function applyWatermark(url) {
            try {
                const head = document.head || document.getElementsByTagName('head')[0];
                let style = document.getElementById('company-watermark-style');
                // if no URL provided, remove existing watermark style and return
                if (!url) {
                    if (style && style.parentNode) style.parentNode.removeChild(style);
                    return;
                }
                const safeUrl = url.replace(/\)/g, '%29');
                const css = `
                    #app-container { position: relative; }
                    /* Full-screen centered faint watermark covering the viewport */
                    #app-container::before {
                        content: "";
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 140vmin;
                        height: 140vmin;
                        background-image: url("${safeUrl}");
                        background-repeat: no-repeat;
                        background-position: center;
                        background-size: contain;
                        opacity: 0.12;
                        pointer-events: none;
                        z-index: 0;
                        filter: saturate(0%) brightness(1.1);
                    }
                    /* Ensure content stacks above watermark */
                    #app-container > * { position: relative; z-index: 1; }
                    /* Print: slightly darker watermark and full-page */
                    @media print {
                        #app-container::before { opacity: 0.15; width: 220vmin; height: 220vmin; background-size: contain; position: fixed; }
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                `;
                if (!style) {
                    style = document.createElement('style');
                    style.id = 'company-watermark-style';
                    style.type = 'text/css';
                    style.appendChild(document.createTextNode(css));
                    head.appendChild(style);
                } else {
                    style.textContent = css;
                }
            } catch (e) {
                console.warn('applyWatermark error', e);
            }
        }

        // --- Debts Summary Utilities ---
        function computeDebtsSummary() {
            // Try state.sales first; fallback to table rows if empty
            const rows = [];
            if (Array.isArray(state.sales) && state.sales.length) {
                state.sales.forEach(s => {
                    // Expecting fields: customerName, repName, total, paid, remaining
                    const total = Number(s.total || 0);
                    const paid = Number(s.paid || 0);
                    const remaining = Number(s.remaining != null ? s.remaining : (total - paid));
                    rows.push({ customer: s.customerName || s.customer || 'غير معروف', rep: s.repName || s.rep || 'غير معروف', total, paid, remaining });
                });
            } else {
                // Parse any existing rows in the debts table
                const tbody = document.getElementById('debts-detail-body');
                if (tbody) {
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                        const tds = tr.querySelectorAll('td');
                        if (!tds || tds.length < 7) return;
                        const customer = tds[0].textContent.trim();
                        const date = tds[1].textContent.trim();
                        const invoice = tds[2].textContent.trim();
                        const total = Number((tds[3].textContent || '').replace(/[^0-9.-]+/g, '')) || 0;
                        const paid = Number((tds[4].textContent || '').replace(/[^0-9.-]+/g, '')) || 0;
                        const remaining = Number((tds[5].textContent || '').replace(/[^0-9.-]+/g, '')) || (total - paid);
                        const rep = tds[6].textContent.trim() || 'غير معروف';
                        rows.push({ customer, rep, total, paid, remaining });
                    });
                }
            }

            // Aggregate by customer and by rep
            const byCustomer = {};
            const byRep = {};
            let totalRemaining = 0;
            rows.forEach(r => {
                if (!byCustomer[r.customer]) byCustomer[r.customer] = { total:0, paid:0, remaining:0 };
                if (!byRep[r.rep]) byRep[r.rep] = { total:0, paid:0, remaining:0 };
                byCustomer[r.customer].total += r.total;
                byCustomer[r.customer].paid += r.paid;
                byCustomer[r.customer].remaining += r.remaining;
                byRep[r.rep].total += r.total;
                byRep[r.rep].paid += r.paid;
                byRep[r.rep].remaining += r.remaining;
                totalRemaining += r.remaining;
            });

            return { byCustomer, byRep, totalRemaining };
        }

        function showDebtsSummaryModal(e) {
            // If called from nav click, allow navigation behavior to occur then open modal after a short delay
            if (e && e.preventDefault) {
                // let normal nav happen (switchPage) but also show modal
            }
            const summary = computeDebtsSummary();

            const custTbody = document.querySelector('#debts-by-customer tbody');
            const repTbody = document.querySelector('#debts-by-rep tbody');
            custTbody.innerHTML = '';
            repTbody.innerHTML = '';

            Object.keys(summary.byCustomer).sort().forEach(name => {
                const item = summary.byCustomer[name];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-right px-2 py-1">${name}</td><td class="text-center px-2 py-1">${formatCurrency(item.total)}</td><td class="text-center px-2 py-1">${formatCurrency(item.paid)}</td><td class="text-center px-2 py-1">${formatCurrency(item.remaining)}</td>`;
                custTbody.appendChild(tr);
            });

            Object.keys(summary.byRep).sort().forEach(name => {
                const item = summary.byRep[name];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-right px-2 py-1">${name}</td><td class="text-center px-2 py-1">${formatCurrency(item.total)}</td><td class="text-center px-2 py-1">${formatCurrency(item.paid)}</td><td class="text-center px-2 py-1">${formatCurrency(item.remaining)}</td>`;
                repTbody.appendChild(tr);
            });

            const totalEl = document.getElementById('debts-summary-total');
            if (totalEl) totalEl.textContent = formatCurrency(summary.totalRemaining);

            openModal(document.getElementById('debts-summary-modal'));
        }

        // Remove auto-popup behavior per user request
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('debts-nav-btn');
            if (btn) {
                // Only handle navigation, no auto-popup
                btn.addEventListener('click', function(ev) {
                    // Default navigation behavior only
                });
            }
        });

        // --- NEW: Manual Review Highlighting Functions ---
        const REVIEW_COLORS = ['highlight-blue', 'highlight-green', 'highlight-purple', 'highlight-orange', 'highlight-teal'];
        const LOCAL_REVIEW_KEY = 'mandoobi_review_state';

        function loadReviewState() {
            try {
                const savedState = localStorage.getItem(LOCAL_REVIEW_KEY);
                return savedState ? JSON.parse(savedState) : {};
            } catch (e) {
                console.error("Failed to load review state:", e);
                return {};
            }
        }

        function saveReviewState(reviewState) {
            try {
                localStorage.setItem(LOCAL_REVIEW_KEY, JSON.stringify(reviewState));
            } catch (e) {
                console.error("Failed to save review state:", e);
            }
        }

        function toggleReviewColor(saleId, element) {
            const reviewState = loadReviewState();
            const existingColor = reviewState[saleId];

            // Remove all palette colors from the element to start fresh.
            element.classList.remove(...REVIEW_COLORS);

            if (existingColor) {
                // If it was already colored, just remove it from the state.
                delete reviewState[saleId];
            } else {
                // If it's a new item to color, use the global counter.
                // Ensure the counter is a number.
                if (typeof state.highlightCounter !== 'number') {
                    state.highlightCounter = 0;
                }
                
                const colorIndex = state.highlightCounter % REVIEW_COLORS.length;
                const nextColor = REVIEW_COLORS[colorIndex];
                
                // Store the class name in the review state.
                reviewState[saleId] = nextColor;
                element.classList.add(nextColor);
                
                // Increment the main state's counter for the next new item.
                state.highlightCounter++;
            }
            
            saveReviewState(reviewState); // Saves the color mapping {saleId: 'class-name'}
            saveState(); // Saves the main state, including the incremented counter
        }


        // --- All Function Definitions START ---
        
        function updateIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function customDialog({ message, title = 'إشعار', isConfirm = false, confirmText = 'تأكيد', confirmClass = 'bg-blue-600 hover:bg-blue-700' }) {
             return new Promise(resolve => {
                let confirmBtn = document.getElementById('dialog-confirm-btn');
                let cancelBtn = document.getElementById('dialog-cancel-btn');

                if (!dialogTitle || !dialogMessage || !confirmBtn || !cancelBtn) {
                    console.error("Custom dialog elements are missing in the DOM.");
                    setTimeout(() => resolve(isConfirm ? false : true), 10);
                    return;
                }
                
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                
                confirmBtn.textContent = confirmText;
                confirmBtn.className = `flex-1 text-white px-4 py-2 rounded-lg font-semibold ${confirmClass}`;
                
                dialogActions.classList.toggle('justify-between', isConfirm);
                dialogActions.classList.toggle('justify-center', !isConfirm);
                cancelBtn.classList.toggle('hidden', !isConfirm);
                cancelBtn.textContent = 'إلغاء';

                const oldConfirmBtn = confirmBtn;
                const newConfirmBtn = oldConfirmBtn.cloneNode(true);
                if (oldConfirmBtn.parentNode) {
                    oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
                }
                
                const oldCancelBtn = cancelBtn;
                const newCancelBtn = oldCancelBtn.cloneNode(true);
                if (oldCancelBtn.parentNode) {
                    oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
                }
                
                newConfirmBtn.addEventListener('click', () => {
                    closeModal(customConfirmModal);
                    resolve(true);
                }, { once: true });

                if (isConfirm) {
                    newCancelBtn.addEventListener('click', () => {
                        closeModal(customConfirmModal);
                        resolve(false);
                    }, { once: true });
                }
                
                openModal(customConfirmModal);
            });
        }
        
        function populateRepDropdown(selectEl, selectedRepName = '') {
            if (!selectEl) return;
            let repNames = (state.reps||[]).map(r => r.name).filter(n => !!n);
            const prev = selectedRepName || selectEl.value;
            // تخصيص زر الإدخال السريع ليظهر فقط اسم المندوب الحالي إذا لم يكن أدمن
            if (selectEl.id === 'spreadsheet-rep') {
                let role = typeof getUserRole === 'function' ? getUserRole() : 'rep';
                let currentEmail = (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null;
                if (role === 'rep' && currentEmail) {
                    // ابحث عن اسم المندوب المرتبط بهذا الإيميل
                    const currentRep = (state.reps||[]).find(r => (r.email||'').toLowerCase() === currentEmail);
                    if (currentRep) {
                        repNames = [currentRep.name];
                    } else {
                        repNames = [];
                    }
                }
            }
            let html = '<option value="">-- جميع المناديب --</option>';
            html += repNames.map(name => `<option value="${name}" ${name === prev ? 'selected' : ''}>${name}</option>`).join('');
            selectEl.innerHTML = html;
            // Restore previous selection if still present
            if (prev && repNames.includes(prev)) selectEl.value = prev;
        }
        
        function populateRepDropdownReports(selectEl, selectedRepName = '') {
            const repNames = state.reps.map(r => r.name);
            selectEl.innerHTML = '<option value="all">-- كل المناديب --</option>' + repNames.map(name => 
                `<option value="${name}" ${name === selectedRepName ? 'selected' : ''}>${name}</option>`
            ).join('');
        }

        // Helper: العثور على مندوب بالاسم أو المعرّف (تجنّب تكرار التعريف)
        if (typeof window.findRep !== 'function') {
            window.findRep = function(name){
                try { return (state.reps||[]).find(r => r.name === name || r.id === name) || null; } catch(e){ return null; }
            };
        }

        // ===== تصحيح مشاكل توقف التطبيق بسبب دوال ناقصة من الكود القديم =====
        // تهيئة آمنة للحالة العامة إن لم تكن موجودة
        window.state = window.state || {};

        // تعريف DEFAULT_PRODUCTS فارغ لتفادي أخطاء ensureFinishedFromState
        if (typeof window.DEFAULT_PRODUCTS === 'undefined') window.DEFAULT_PRODUCTS = [];

        // دالة تنسيق عملة بسيطة (جنيه مصري أو رقم مجرد)
        if (typeof window.formatCurrency !== 'function') {
            window.formatCurrency = function(v){
                try { return Number(v||0).toLocaleString('ar-EG', { minimumFractionDigits: 0 }); } catch(e){ return String(v||'0'); }
            };
        }

        // البحث عن عميل حسب المعرّف
        if (typeof window.findCustomer !== 'function') {
            window.findCustomer = function(id){
                try { return (state.customers||[]).find(c => (c.id||c._id) === id) || null; } catch(e){ return null; }
            };
        }

        // دالة بديلة قديمة كانت تستعمل للاسم updateCustomerList — نجعلها تستدعي renderCustomerList
        if (typeof window.updateCustomerList !== 'function') {
            window.updateCustomerList = function(filter, chain){
                try { if (typeof renderCustomerList === 'function') renderCustomerList(filter||''); } catch(e){ console.warn('updateCustomerList stub failed', e); }
            };
        }

        function updatePromotionOriginalPriceDisplay(productId) {
             const product = findProduct(productId);
             const displayEl = document.getElementById('original-price-display');
             const priceEl = document.getElementById('current-product-price');
             if (product) {
                 priceEl.textContent = formatCurrency(product.price);
                 displayEl.classList.remove('hidden');
             } else {
                 displayEl.classList.add('hidden');
             }
        }



        function getActivePromotionPrice(productId, customerId = null) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const relevantOffers = state.promotions.filter(p => p.productId === productId);
            let activeOffer = relevantOffers.find(p => {
                const isTargetingThisCustomer = p.customerId === customerId;
                if (!isTargetingThisCustomer) return false;
                const startDate = new Date(p.startDate);
                const endDate = new Date(p.endDate);
                endDate.setHours(23, 59, 59, 999);
                return today >= startDate && today <= endDate;
            });
            if (!activeOffer) {
                activeOffer = relevantOffers.find(p => {
                    const isTargetingAll = !p.customerId;
                    if (!isTargetingAll) return false;
                    const startDate = new Date(p.startDate);
                    const endDate = new Date(p.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    return today >= startDate && today <= endDate;
                });
            }
            return activeOffer ? activeOffer.price : null;
        }

        const supermarketChains = {
            exception: ["اكسبشن ماركت"],
            awladragab: ["اولاد رجب"],
            samysalama: ["سامي سلامه"],
            gomlamarket: ["جملة ماركت"],
            dreams: ["دريمز فرع 1", "دريمز فرع 2"]
        };

        const updateCustomerList = (filter = '', chain = 'all') => {
             const statementCustomerList = document.getElementById('statement-customer-list');
             if (!statementCustomerList) return;
             statementCustomerList.innerHTML = '';

             console.log('updateCustomerList called with:', { filter, chain });
             console.log('Initial state.customers:', state.customers);

             let filteredCustomers = state.customers;
             const allChains = loadChains();

             if (chain !== 'all' && supermarketChains[chain]) {
                 const branches = supermarketChains[chain];
                 console.log('Filtering by chain. Branches:', branches);
                 filteredCustomers = filteredCustomers.filter(c => {
                     const match = branches.some(branch => c.name.toLowerCase().includes(branch.toLowerCase()));
                     // console.log(`Customer: ${c.name}, Branch: ${branches}, Match: ${match}`);
                     return match;
                 });
                 console.log('Customers after chain filter:', filteredCustomers);
             }

             if (filter) {
                 filteredCustomers = filteredCustomers.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                 console.log('Customers after text filter:', filteredCustomers);
             }

             if (filteredCustomers.length === 0) {
                 const el = document.createElement('label');
                 el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                 el.innerHTML = `
                      <span class="text-sm text-red-500">لا توجد نتائج مطابقة.</span>
                 `;
                 statementCustomerList.appendChild(el);
             } else {
                 filteredCustomers.forEach(customer => {
                     const el = document.createElement('label');
                     el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                     el.innerHTML = `
                          <input type="checkbox" value="${customer.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                          <span class="text-sm">${customer.name}</span>
                     `;
                     statementCustomerList.appendChild(el);
                 });
                 
                 // Add chains as options
                 if (allChains.length > 0) {
                     allChains.forEach(chain => {
                         const el = document.createElement('label');
                         el.className = 'flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
                         el.innerHTML = `
                              <input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                              <span class="text-sm font-medium">[سلسلة] ${chain.name}</span>
                         `;
                         statementCustomerList.appendChild(el);
                     });
                 }
             }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Event listener for the new select
            const supermarketChainFilter = document.getElementById('supermarket-chain-filter');
            if(supermarketChainFilter) {
                supermarketChainFilter.addEventListener('change', (e) => {
                    const chain = e.target.value;
                    const filter = document.getElementById('statement-customer-search').value;
                    updateCustomerList(filter, chain);
                });
            }

            // Modify the existing event listener for the search input
            const statementCustomerSearch = document.getElementById('statement-customer-search');
            if(statementCustomerSearch){
                statementCustomerSearch.addEventListener('input', (e) => {
                    const filter = e.target.value;
                    const chain = document.getElementById('supermarket-chain-filter') ? document.getElementById('supermarket-chain-filter').value : 'all';
                    
                    // Also filter chains by search text
                    const statementCustomerList = document.getElementById('statement-customer-list');
                    if (!statementCustomerList) return;
                    
                    // Re-build list with search filter for chains too
                    let filteredCustomers = state.customers;
                    const allChains = loadChains();
                    
                    if (chain !== 'all' && supermarketChains[chain]) {
                        const branches = supermarketChains[chain];
                        filteredCustomers = filteredCustomers.filter(c => {
                            const match = branches.some(branch => c.name.toLowerCase().includes(branch.toLowerCase()));
                            return match;
                        });
                    }
                    
                    if (filter) {
                        filteredCustomers = filteredCustomers.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                    }
                    
                    statementCustomerList.innerHTML = '';
                    
                    if (filteredCustomers.length === 0 && (!filter || filter.length === 0)) {
                        const el = document.createElement('label');
                        el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                        el.innerHTML = '<span class="text-sm text-red-500">لا توجد نتائج مطابقة.</span>';
                        statementCustomerList.appendChild(el);
                    } else {
                        filteredCustomers.forEach(customer => {
                            const el = document.createElement('label');
                            el.className = 'flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
                            el.innerHTML = `
                                 <input type="checkbox" value="${customer.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                                 <span class="text-sm">${customer.name}</span>
                            `;
                            statementCustomerList.appendChild(el);
                        });
                        
                        // Add filtered chains
                        if (allChains.length > 0 && (!filter || filter.length === 0)) {
                            allChains.forEach(chain => {
                                const el = document.createElement('label');
                                el.className = 'flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
                                el.innerHTML = `
                                     <input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                                     <span class="text-sm font-medium">[سلسلة] ${chain.name}</span>
                                `;
                                statementCustomerList.appendChild(el);
                            });
                        } else if (allChains.length > 0 && filter) {
                            // Show chains that match the search
                            const filteredChains = allChains.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                            filteredChains.forEach(chain => {
                                const el = document.createElement('label');
                                el.className = 'flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
                                el.innerHTML = `
                                     <input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
                                     <span class="text-sm font-medium">[سلسلة] ${chain.name}</span>
                                `;
                                statementCustomerList.appendChild(el);
                            });
                        }
                    }
                });
            }
        });

        // +++ NEW FUNCTIONS FOR DETAILED SALE MODAL +++

        function populateProductDropdown(selectEl, selectedId = '') {
            selectEl.innerHTML = '<option value="">-- اختر منتج --</option>' + state.products.map(p => 
                `<option value="${p.id}" ${p.id === selectedId ? 'selected' : ''}>${p.name} (${p.id})</option>`
            ).join('');
        }

        function addSaleItemRow(item = {}) {
            const container = document.getElementById('sale-items-container');
            const row = document.createElement('tr');
            row.className = 'sale-item-row';
            row.innerHTML = `
                <td class="px-4 py-2"><select class="sale-item-product w-full p-2 border rounded-md" required>${state.products.length > 0 ? '' : '<option>لا توجد منتجات</option>'}</select></td>
                <td class="px-4 py-2"><input class="sale-item-quantity w-20 p-2 border rounded-md text-center" type="number" value="${(item.quantity != null && item.quantity !== undefined && item.quantity !== '') ? item.quantity : ''}" placeholder="0"></td>
                <td class="px-4 py-2"><input class="sale-item-price w-24 p-2 border rounded-md text-center bg-gray-100" type="number" value="${item.price || 0}" readonly></td>
                <td class="px-4 py-2"><span class="sale-item-total-display font-semibold">0 ج.م</span></td>
                <td class="px-2 py-2 text-center"><button type="button" class="delete-sale-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
            `;

            const productSelect = row.querySelector('.sale-item-product');
            populateProductDropdown(productSelect, item.productId || '');
            
            container.appendChild(row);
            updateIcons();

            // Function to update row price and total
            const updateRow = () => {
                const productId = productSelect.value;
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value) || 0;
                const priceInput = row.querySelector('.sale-item-price');
                const totalDisplay = row.querySelector('.sale-item-total-display');
                
                const customerId = document.getElementById('sale-customer').value;
                let price = 0;

                if (productId) {
                    const product = findProduct(productId);
                    let basePrice = product ? product.price : 0;

                    // Check price list
                    if (customerId) {
                        const customer = findCustomer(customerId);
                        if (customer && customer.priceListId) {
                            const priceList = findPriceList(customer.priceListId);
                            if (priceList && priceList.productPrices[productId] !== undefined) {
                                basePrice = priceList.productPrices[productId];
                            }
                        }
                    }
                    
                    // Check promotion
                    const promotionPrice = getActivePromotionPrice(productId, customerId);
                    price = (promotionPrice !== null) ? promotionPrice : basePrice;
                    try {
                        if (product && /قريش|قريش/i.test(product.name)) {
                            const customer = customerId ? findCustomer(customerId) : null;
                            const priceList = (customer && customer.priceListId) ? findPriceList(customer.priceListId) : null;
                            const listOverride = priceList ? priceList.productPrices[productId] : undefined;
                            console.debug('DEBUG Pricing (sale modal row)', {
                                productId,
                                productName: product ? product.name : '',
                                basePrice: (product ? product.price : 0),
                                priceListId: customer ? customer.priceListId : '',
                                priceListOverride: listOverride,
                                promotionPrice,
                                finalPrice: price
                            });
                        }
                    } catch(_){ }
                }

                priceInput.value = price.toFixed(2);
                const itemTotal = quantity * price;
                totalDisplay.textContent = formatCurrency(itemTotal);
                updateSaleSummary(); // Update grand total
            };

            // Add event listeners
            productSelect.addEventListener('change', updateRow);
            row.querySelector('.sale-item-quantity').addEventListener('input', updateRow);
            row.querySelector('.delete-sale-item-btn').addEventListener('click', () => {
                row.remove();
                updateSaleSummary();
            });

            // Add listener to customer dropdown to update all item prices if customer changes
            document.getElementById('sale-customer').addEventListener('change', updateRow);

            updateRow(); // Initial call to set price/total
        }

        function updateSaleSummary() {
            let subtotal = 0;
            document.querySelectorAll('#sale-items-container .sale-item-row').forEach(row => {
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.sale-item-price').value) || 0;
                subtotal += quantity * price;
            });

            const discountPercent = parseFloat(document.getElementById('sale-discount').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
                const additionPercent = parseFloat(document.getElementById('sale-addition')?.value) || 0;
                const additionAmount = subtotal * (additionPercent / 100);
                const finalTotal = subtotal - discountAmount + additionAmount;

            document.getElementById('sale-subtotal-text').textContent = formatCurrency(subtotal);
            document.getElementById('sale-discount-text').textContent = formatCurrency(discountAmount);
                // إنشاء أو تحديث عنصر الإضافة في الملخص إن لم يوجد
                let additionLine = document.getElementById('sale-addition-line');
                if (!additionLine) {
                    const summary = document.getElementById('sale-summary');
                    if (summary) {
                        additionLine = document.createElement('div');
                        additionLine.id = 'sale-addition-line';
                        additionLine.className = 'flex justify-between text-green-600';
                        additionLine.innerHTML = '<span>الإضافة:</span><span id="sale-addition-text">0 ج.م</span>';
                        // أدخلها بعد الخصم وقبل الخط الفاصل
                        const discountLine = document.getElementById('sale-discount-text')?.parentElement;
                        if (discountLine) {
                            discountLine.insertAdjacentElement('afterend', additionLine);
                        } else {
                            summary.insertBefore(additionLine, summary.querySelector('hr'));
                        }
                    }
                }
                const additionTextEl = document.getElementById('sale-addition-text');
                if (additionTextEl) additionTextEl.textContent = formatCurrency(additionAmount);
            document.getElementById('sale-total-text').textContent = formatCurrency(finalTotal);

            // Update paid amount based on status
            const statusSelect = document.getElementById('sale-status');
            const paidAmountContainer = document.getElementById('paid-amount-container');
            const paidAmountInput = document.getElementById('sale-paid-amount');
            
            if (statusSelect.value === 'paid') {
                paidAmountInput.value = finalTotal.toFixed(2);
                paidAmountContainer.classList.add('hidden');
            } else if (statusSelect.value === 'due') {
                paidAmountInput.value = 0;
                paidAmountContainer.classList.add('hidden');
            } else { // partial
                paidAmountContainer.classList.remove('hidden');
            }
        }

        function openSaleModal(id = null) {
            saleForm.reset();
            document.getElementById('sale-items-container').innerHTML = '';
            populateRepDropdown(document.getElementById('sale-rep'));
            populateCustomerDropdown(document.getElementById('sale-customer'));
            
            const paidAmountContainer = document.getElementById('paid-amount-container');
            const statusSelect = document.getElementById('sale-status');
            const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';

            if (id) {
                // Edit Mode
                const sale = state.sales.find(s => s.id === id);
                if (!sale) {
                    customDialog({ message: 'لم يتم العثور على الفاتورة.', title: 'خطأ' });
                    return;
                }
                document.getElementById('sale-modal-title').textContent = `تعديل فاتورة رقم: ${sale.invoiceNumber}`;
                document.getElementById('sale-id').value = sale.id;
                document.getElementById('sale-rep').value = sale.repName;
                document.getElementById('sale-customer').value = sale.customerId;
                document.getElementById('sale-date').value = new Date(sale.date).toISOString().split('T')[0];
                document.getElementById('sale-invoice-number').value = sale.invoiceNumber;
                document.getElementById('sale-notes').value = sale.notes || '';
                document.getElementById('sale-discount').value = sale.discount || 0;
                document.getElementById('sale-addition').value = sale.additionPercent || sale.addition || 0;
                
                statusSelect.value = sale.status;
                if (sale.status === 'partial') {
                    paidAmountContainer.classList.remove('hidden');
                    document.getElementById('sale-paid-amount').value = sale.paidAmount;
                } else {
                    paidAmountContainer.classList.add('hidden');
                }

                sale.items.forEach(item => addSaleItemRow(item));

                // Show ETA upload button for admin only in edit mode
                try {
                    const etaBtn = document.getElementById('eta-upload-from-modal-btn');
                    if (etaBtn) {
                        if (role === 'admin') {
                            etaBtn.classList.remove('hidden');
                            etaBtn.dataset.id = sale.id;
                            // Remove previous listener if any
                            const newBtn = etaBtn.cloneNode(true);
                            etaBtn.parentNode.replaceChild(newBtn, etaBtn);
                            newBtn.addEventListener('click', async ()=>{
                                try { await window.uploadSaleToEta(sale.id); } catch(e){ console.warn('modal eta upload failed', e); }
                            });
                            updateIcons();
                        } else {
                            etaBtn.classList.add('hidden');
                        }
                    }
                } catch(_){ }

                // إن كان المستخدم مندوباً، نجعل المودال للعرض فقط
                if (role === 'rep') {
                    try {
                        const form = document.getElementById('sale-form');
                        form.querySelectorAll('input, select, textarea, button').forEach(el => {
                            if (el.id === 'cancel-sale-btn') return;
                            if (el.type === 'button' && el.id === 'add-sale-item-btn') { el.style.display = 'none'; return; }
                            if (el.type === 'submit') { el.disabled = true; el.classList.add('opacity-50','cursor-not-allowed'); return; }
                            if (el.tagName === 'BUTTON') { el.disabled = true; el.classList.add('opacity-50','cursor-not-allowed'); return; }
                            el.disabled = true;
                        });
                        const submitBtn = document.querySelector('footer [type="submit"][form="sale-form"]');
                        if (submitBtn) { submitBtn.disabled = true; submitBtn.classList.add('opacity-50','cursor-not-allowed'); }
                    } catch(_){}
                }
                
            } else {
                // Add Mode (User doesn't want this, but the function needs to support it)
                document.getElementById('sale-modal-title').textContent = 'إضافة عملية بيع';
                document.getElementById('sale-id').value = '';
                document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
                statusSelect.value = 'paid';
                paidAmountContainer.classList.add('hidden');
                addSaleItemRow(); // Add one empty row
                try { const etaBtn = document.getElementById('eta-upload-from-modal-btn'); if (etaBtn) etaBtn.classList.add('hidden'); } catch(_){ }
            }
            
            updateSaleSummary();
            openModal(saleModal);
        }

        async function saveSale(e) {
            e.preventDefault();
            const id = document.getElementById('sale-id').value;
            const repName = document.getElementById('sale-rep').value;
            const customerId = document.getElementById('sale-customer').value;
            const date = document.getElementById('sale-date').value;
            const invoiceNumber = document.getElementById('sale-invoice-number').value;

            if (!repName || !customerId || !date || !invoiceNumber) {
                await customDialog({ message: 'الرجاء ملء بيانات المندوب، العميل، التاريخ، ورقم الفاتورة.', title: 'بيانات ناقصة' });
                return;
            }

            const items = [];
            let subtotal = 0;
            const itemRows = document.querySelectorAll('#sale-items-container .sale-item-row');
            if (itemRows.length === 0) {
                await customDialog({ message: 'الرجاء إضافة منتج واحد على الأقل للفاتورة.', title: 'بيانات ناقصة' });
                return;
            }
            
            for (const row of itemRows) {
                const productId = row.querySelector('.sale-item-product').value;
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value);
                const price = parseFloat(row.querySelector('.sale-item-price').value);
                
                // Check quantity for zero, but allow negative for returns
                if (!productId || isNaN(quantity) || quantity === 0 || isNaN(price)) {
                    await customDialog({ message: 'أحد المنتجات في الفاتورة به بيانات غير صحيحة (الكمية يجب أن تكون رقم غير صفري).', title: 'بيانات ناقصة' });
                    return;
                }
                
                const itemTotal = quantity * price;
                items.push({ productId, quantity, price, itemTotal }); // Note: This doesn't store discount per item, only total discount
                subtotal += itemTotal;
            }
            
            const discountPercent = parseFloat(document.getElementById('sale-discount').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const additionPercent = parseFloat(document.getElementById('sale-addition').value) || 0;
            const additionAmount = subtotal * (additionPercent / 100);
            const finalTotal = subtotal - discountAmount + additionAmount;
            
            let status = document.getElementById('sale-status').value;
            let paidAmount = 0;
            
            // If it's a return, paid amount calculation is irrelevant/complex, stick to zero unless manually entered for simplicity
            if (finalTotal < 0) {
                status = 'due'; // Returns are usually 'due' (company owes customer) or simply tracked as returns
                paidAmount = 0;
            } else if (status === 'paid') {
                paidAmount = finalTotal;
            } else if (status === 'due') {
                paidAmount = 0;
            } else { // partial
                paidAmount = parseFloat(document.getElementById('sale-paid-amount').value) || 0;
                if (paidAmount >= finalTotal) {
                    await customDialog({ message: 'المبلغ المدفوع جزئياً يساوي أو أكبر من الإجمالي. سيتم اعتبار الفاتورة "مدفوعة بالكامل".', title: 'تنبيه' });
                    status = 'paid';
                    paidAmount = finalTotal;
                }
            }

            const saleData = {
                id: id || db.collection('sales').doc().id, // Generate Firestore ID if new
                date: new Date(date + 'T12:00:00Z').toISOString(),
                createdAt: id ? (state.sales.find(s=>s.id === id).createdAt || new Date().toISOString()) : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                repName: repName,
                customerId: customerId,
                invoiceNumber: parseInt(invoiceNumber),
                items: items.map(i => ({...i, discountPercent: 0})), // Simplified, spreadsheet saves discount per item
                total: finalTotal,
                status: status,
                paidAmount: paidAmount,
                discount: discountPercent,
                additionPercent: additionPercent,
                notes: document.getElementById('sale-notes').value.trim(),
                taxFilingStatus: id ? (state.sales.find(s=>s.id === id).taxFilingStatus || '') : '' // Preserve tax status on edit
            };

            try {
                showLoading('جارٍ حفظ الفاتورة...');

                // حفظ عبر Firestore بدلاً من push محلي
                saleData.includeInCash = true;
                saleData.collectionReportCreated = saleData.collectionReportCreated || false;
                saleData.paidToSafe = saleData.paidToSafe || false;

                if (id) {
                    await updateSale(id, saleData);
                } else {
                    await addSale(saleData);
                }

                hideLoading();
                closeModal(saleModal);
                // onSnapshot سيعيد تحديث القوائم تلقائياً
                await customDialog({ message: 'تم حفظ الفاتورة بنجاح في السحابة.', title: 'نجاح', confirmClass: 'bg-green-600 hover:bg-green-700' });
            } catch (error) {
                hideLoading(); // Hide loading indicator on error
                console.error('Error saving sale locally:', error);
                await customDialog({ message: 'فشل حفظ الفاتورة: ' + (error && error.message ? error.message : String(error)), title: 'خطأ في الحفظ', confirmClass: 'bg-red-600 hover:bg-red-700' });
            }
        }

        // --- END NEW FUNCTIONS ---

        function loadState() {
            // تم إلغاء التحميل المحلي الكامل. إرجاع حالة افتراضية فقط إن لم تكن موجودة.
            if (!window.state) {
                window.state = { customers: [], products: [], sales: [], priceLists: [], dispatchNotes: [], reps: [], promotions: [], settings: { salesTarget: 10000 }, stockEntries: {}, invoiceHighlights: {}, highlightCounter: 0 };
            }
            return window.state;
        }

        // If we detect an empty sales list but local backups exist, offer to restore the latest one.
        // Previously this immediately prompted the user to restore a local backup
        // when no sales were found. That caused an intrusive modal on startup.
        // We'll skip the interactive restore prompt and instead silently log
        // that backups exist (so the app doesn't interrupt the user).
        (function() {
            try {
                if ((!state.sales || state.sales.length === 0)) {
                    const backupsRaw = localStorage.getItem('mandoobiAppState_backups');
                    const backups = backupsRaw ? JSON.parse(backupsRaw) : [];
                    if (backups && backups.length > 0) {
                        // Do NOT prompt the user automatically. Keep backups available for manual restore.
                        console.info(`Found ${backups.length} local backups; automatic restore prompt suppressed.`);
                    }
                }
            } catch (e) {
                console.warn('Auto-restore check failed', e);
            }
        })();

        function saveState() {
            try {
                // If CLOUD_ONLY is enabled (Firebase initialized and user requested cloud-only), skip all local writes
                if (!window.CLOUD_ONLY) {
                    try {
                        localStorage.setItem('mandoobiAppState', JSON.stringify(state));
                    } catch (e) {
                        console.error('Failed to save main state to localStorage', e);
                    }

                    // Also keep a short rolling history of backups to help recovery
                    try {
                        const key = 'mandoobiAppState_backups';
                        const raw = localStorage.getItem(key);
                        const backups = raw ? JSON.parse(raw) : [];
                        // push latest snapshot (keep small to avoid huge localStorage)
                        backups.unshift({ ts: new Date().toISOString(), data: state });
                        // limit to 12 entries
                        while (backups.length > 12) backups.pop();
                        localStorage.setItem(key, JSON.stringify(backups));
                    } catch (e) {
                        // non-fatal
                        console.warn('Failed to save state backup', e);
                    }
                } else {
                    // In cloud-only mode we intentionally avoid persisting locally.
                    console.debug('CLOUD_ONLY: skipping local save and scheduling cloud save');
                }
            } catch (e) {
                console.warn('saveState wrapper error', e);
            }

            // Schedule a debounced cloud save if Firebase is available
            try {
                if (window.db && window.auth) {
                    scheduleCloudSave();
                } else if (window.CLOUD_ONLY) {
                    console.warn('CLOUD_ONLY enabled but Firebase not initialized; state will not be persisted to cloud yet.');
                }
            } catch (e) { console.warn('Failed to schedule cloud save', e); }
        }

        // Debounced cloud-save scheduler.
        // Ensures auth is available (attempts anonymous sign-in if needed), coalesces rapid saves,
        // and retries once on transient failure with simple backoff.
        function scheduleCloudSave(delayMs = 900) {
            // حفظ الحالة الكامل لم يعد مستخدماً؛ الإبقاء للتوافق فقط بدون دخول مجهول.
            if (!window.db || !window.auth || !auth.currentUser) return;
            if (window.__cloudSaveTimer) clearTimeout(window.__cloudSaveTimer);
            window.__cloudSaveTimer = setTimeout(async ()=>{
                window.__cloudSaveTimer = null;
                try { await saveStateToFirebase(); } catch(e){ console.warn('Deprecated cloud save failed', e); }
            }, delayMs);
        }

        // Function to save state to Firebase
        async function saveStateToFirebase() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    console.log('No user logged in, skipping Firebase save');
                    return;
                }

                // Sanitize state إلى JSON مسموح فقط (بدون دوال / عقد DOM) لتجنب خطأ invalid nested entity
                function safeSerialize(val, depth=0){
                    if (depth > 6) return undefined; // حاجز حماية
                    if (val === null) return null;
                    const t = typeof val;
                    if (t === 'string' || t === 'number' || t === 'boolean') return val;
                    if (Array.isArray(val)) return val.map(v => safeSerialize(v, depth+1)).filter(v => v !== undefined);
                    if (t === 'object') {
                        if (val instanceof Date) return val.toISOString();
                        if (val.nodeType || (val.ownerDocument && val.defaultView)) return undefined; // DOM Node
                        const out = {}; Object.keys(val).forEach(k => {
                            const v = val[k];
                            if (typeof v === 'function') return;
                            const sv = safeSerialize(v, depth+1);
                            if (sv !== undefined) out[k] = sv;
                        });
                        return out;
                    }
                    return undefined; // تخطي رموز ودوال وأشياء خاصة
                }
                const cleanState = safeSerialize(state) || {};
                const userData = {
                    appState: cleanState,
                    lastUpdated: new Date().toISOString(),
                    email: currentUser.email
                };

                await db.collection('users').doc(currentUser.uid).set(userData, { merge: true });
                console.log('✅ State saved to Firebase successfully');
            } catch (error) {
                console.warn('⚠️ Failed to save state to Firebase:', error);
                // Don't block the app if Firebase fails
            }
        }

        // Function to load state from Firebase
        async function loadStateFromFirebase() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    console.log('No user logged in, skipping Firebase load');
                    return null;
                }

                const docSnapshot = await db.collection('users').doc(currentUser.uid).get();
                if (docSnapshot.exists && docSnapshot.data().appState) {
                    console.log('✅ State loaded from Firebase successfully');
                    return docSnapshot.data().appState;
                } else {
                    console.log('No data found in Firebase for this user');
                    return null;
                }
            } catch (error) {
                console.warn('⚠️ Failed to load state from Firebase:', error);
                return null;
            }
        }

        // مهاجره طارئة: لو مجموعة sales فاضية لكن في مبيعات مخزّنة داخل users/{uid}.appState.sales
        // نستوردها مرة واحدة إلى مجموعة sales القياسية.
        async function migrateSalesFromUserDocIfFound(){
            try {
                if (!window.db || !window.auth) return;
                const u = auth.currentUser; if (!u) return;
                // لا تكرر الهجرة أكثر من مرة على هذا الجهاز
                const MIG_KEY = 'migrated_sales_from_userdoc_v1';
                if (localStorage.getItem(MIG_KEY) === 'done') return;

                // لو عندنا بالفعل بيانات مبيعات في الذاكرة أو في المجموعة، لا نعمل هجرة
                if (Array.isArray(window.state?.sales) && window.state.sales.length > 0) return;
                const salesSnap = await db.collection('sales').limit(1).get().catch(()=>null);
                if (salesSnap && !salesSnap.empty) return;

                const userDoc = await db.collection('users').doc(u.uid).get();
                const appState = userDoc.exists ? (userDoc.data() || {}).appState : null;
                const legacySales = Array.isArray(appState?.sales) ? appState.sales : [];
                if (!legacySales.length) return;

                console.warn('Migrating sales from users/' + u.uid + '.appState.sales -> sales collection. Count=', legacySales.length);
                let batch = db.batch(); let pending = 0;
                function commitIfNeeded(force){ return force || pending >= 450 ? batch.commit().then(()=>{ batch = db.batch(); pending = 0; }) : Promise.resolve(); }

                for (const s of legacySales){
                    try {
                        const sid = String(s.id || s.invoiceNumber || db.collection('sales').doc().id);
                        const items = Array.isArray(s.items) ? s.items.map(it => ({
                            productId: it.productId || it.id || it.code || '',
                            qty: Number(it.qty || it.quantity || it.q || 0),
                            price: Number(it.price || it.p || 0)
                        })) : [];
                        const total = Number(s.total || s.finalTotal || s.amount || 0);
                        const paidAmount = Number(s.paidAmount || s.paid || 0);
                        const discountPercent = Number(s.discountPercent || s.discount || 0);
                        const dateIso = s.date ? new Date(s.date).toISOString() : new Date().toISOString();
                        const docRef = db.collection('sales').doc(sid);
                        batch.set(docRef, {
                            id: sid,
                            invoiceNumber: s.invoiceNumber || null,
                            customerId: s.customerId || (s.customer && (s.customer.id || s.customerId)) || null,
                            repName: s.repName || s.repId || '',
                            items,
                            total,
                            paidAmount,
                            status: s.status || 'due',
                            discountPercent,
                            taxFilingStatus: s.taxFilingStatus || '',
                            date: dateIso,
                            createdAt: serverTs(),
                            updatedAt: serverTs()
                        }, { merge: true });
                        pending++; await commitIfNeeded(false);
                    } catch(e){ console.warn('migrate sale record failed', e); }
                }
                await commitIfNeeded(true);
                localStorage.setItem(MIG_KEY, 'done');
                console.log('✅ Migration of legacy sales complete');
            } catch(e){ console.warn('migrateSalesFromUserDocIfFound error', e); }
        }

        function getStatusBadge(status) {
            let text, color; if (status === 'paid') { text = 'مدفوع'; color = 'bg-green-100 text-green-800'; } else if (status === 'due') { text = 'آجل'; color = 'bg-red-100 text-red-800'; } else if (status === 'partial') { text = 'جزئي'; color = 'bg-yellow-100 text-yellow-800'; } else { text = 'غير محدد'; color = 'bg-gray-100 text-gray-800'; } return `<span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${color}">${text}</span>`;
        }
        
        function getTaxStatusBadge(sale) {
            const customer = findCustomer(sale.customerId); 
            // FIX: Use `requiresTaxFiling` which is correctly set in loadState
            const requiresFiling = customer?.requiresTaxFiling;

            if (!requiresFiling) { return ''; } // No badge if not required
            
            const taxStatus = sale.taxFilingStatus;
            const isFiled = taxStatus && taxStatus.trim().toLowerCase() === 'تم';

            if (isFiled) {
                // Blue "Filed" button (to differentiate from 'Paid' green badge)
                return `
                    <button 
                        class="tax-status-toggle-btn text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 flex items-center gap-1"
                        data-id="${sale.id}"
                    >
                        <i data-lucide="check" class="w-3 h-3"></i> تم الرفع
                    </button>
                `;
            } else {
                // Red "Not Filed" button
                const statusText = taxStatus && taxStatus.trim() !== '' ? taxStatus : 'لم يتم الرفع';
                return `
                    <button 
                        class="tax-status-toggle-btn text-xs font-medium px-2.5 py-0.5 rounded-full tax-not-filed-badge flex items-center gap-1"
                        data-id="${sale.id}"
                    >
                        <i data-lucide="x" class="w-3 h-3"></i> ${statusText}
                    </button>
                `;
            }
        }
        
        function populatePriceListDropdown(selectEl, selectedPriceListId = '') {
            selectEl.innerHTML = '<option value="">-- بدون قائمة --</option>' + state.priceLists.map(pl => `<option value="${pl.id}" ${pl.id === selectedPriceListId ? 'selected' : ''}>${pl.name}</option>`).join('');
        }

        function populateCustomerDropdown(selectEl, selectedCustomerId = '') {
            selectEl.innerHTML = '<option value="">-- اختر عميل --</option>' + state.customers.map(c => `<option value="${c.id}" ${c.id === selectedCustomerId ? 'selected' : ''}>${c.name}</option>`).join('');
        }

        function checkAndShowAutoStatement() {
             const today = new Date(); const day = today.getDate(); const year = today.getFullYear(); const month = today.getMonth(); const lastDayOfMonth = new Date(year, month + 1, 0).getDate(); const isStatementDay = [10, 20, lastDayOfMonth].includes(day); if (!isStatementDay) return; const periodIdentifier = `${year}-${month}-${day}`; const lastShownIdentifier = localStorage.getItem('lastStatementShown'); if (lastShownIdentifier === periodIdentifier) return; let startDate, endDate; endDate = new Date(year, month, day); if (day <= 10) startDate = new Date(year, month, 1); else if (day <= 20) startDate = new Date(year, month, 11); else startDate = new Date(year, month, 21); const exceptionCustomerIds = state.customers.filter(c => c.name.includes("اكسبشن ماركت")).map(c => c.id); if (exceptionCustomerIds.length === 0) return; const endDateForCheck = new Date(endDate); endDateForCheck.setHours(23,59,59,999); const hasRelevantSales = state.sales.some(sale => { const saleDate = new Date(sale.date); return exceptionCustomerIds.includes(sale.customerId) && saleDate >= startDate && saleDate <= endDateForCheck; }); if (hasRelevantSales) { localStorage.setItem('lastStatementShown', periodIdentifier); generateAndShowStatement(startDate, endDate, exceptionCustomerIds, 'كشف حساب تلقائي', 'اكسبشن ماركت (جميع الفروع)'); }
        }
        
        function renderPriceListsPage() {
            const container = document.getElementById('all-price-lists-container');
            if (!container) return;
            // Render only when price-lists page is active/visible to avoid heavy work during background updates
            try {
                const page = document.getElementById('page-price-lists');
                const hiddenByDisplay = page && (page.style.display === 'none' || !page.classList.contains('active'));
                if (!page || hiddenByDisplay) { return; }
            } catch(_){}
            // Defensive: make sure container is visible and cleared
            try { container.style.display = ''; } catch(e) {}
            container.innerHTML = '';
            // Debug log
            try { console.log('renderPriceListsPage called — priceLists:', (state.priceLists || []).length, 'products:', (state.products || []).length); } catch(e) {}

            // 1. Find and display customers without a price list
            const customersWithoutPriceList = state.customers.filter(c => !c.priceListId);
            if (customersWithoutPriceList.length > 0) {
                const noListEl = document.createElement('div');
                noListEl.className = 'bg-yellow-50 p-4 rounded-lg border border-yellow-200 shadow-sm mb-6';
                const customerNames = customersWithoutPriceList.map(c => `<span class="bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full">${c.name}</span>`).join('');
                noListEl.innerHTML = `
                    <h3 class="font-bold text-lg text-yellow-800 mb-3">عملاء بدون قائمة أسعار محددة</h3>
                    <p class="text-sm text-gray-600 mb-3">هؤلاء العملاء يستخدمون الأسعار الافتراضية للمنتجات. يمكنك تعيين قائمة أسعار لهم من صفحة "العملاء".</p>
                    <div class="flex flex-wrap gap-2">
                        ${customerNames}
                    </div>
                `;
                container.appendChild(noListEl);
            }

            if (!state.priceLists || state.priceLists.length === 0) {
                container.innerHTML += '<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">لا توجد قوائم أسعار معرفة.</p>';
                return;
            }

            // Create a mapping of which customers use which price list
            const customersByPriceList = {};
            state.customers.forEach(customer => {
                if (customer.priceListId) {
                    if (!customersByPriceList[customer.priceListId]) {
                        customersByPriceList[customer.priceListId] = [];
                    }
                    customersByPriceList[customer.priceListId].push(customer.name);
                }
            });

            state.priceLists.sort((a, b) => a.name.localeCompare(b.name)).forEach(priceList => {
                const productPrices = priceList.productPrices || {};
                const productItems = Object.keys(productPrices).map(productId => {
                    const product = findProduct(productId);
                    const price = productPrices[productId];
                    if (!product) return ''; // Skip if product not found
                    return `
                        <li class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 text-sm">
                            <span>${product.name} <span class="text-xs text-gray-400">(${product.id})</span></span>
                            <span class="font-bold text-blue-600">${formatCurrency(price)}</span>
                        </li>
                    `;
                }).join('');

                // Get customers associated with this price list
                const associatedCustomers = customersByPriceList[priceList.id] || [];
                const customersHtml = associatedCustomers.length > 0
                    ? `<div class="mt-4 pt-3 border-t border-gray-100">
                           <h4 class="font-semibold text-sm text-gray-700 mb-2">العملاء المطبق عليهم هذه القائمة:</h4>
                           <div class="flex flex-wrap gap-2">
                               ${associatedCustomers.map(name => `<span class="bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full">${name}</span>`).join('')}
                           </div>
                       </div>`
                    : '<p class="text-xs text-gray-400 mt-4 pt-3 border-t border-gray-100">هذه القائمة غير مطبقة على أي عميل حالياً.</p>';

                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm mb-4';
                el.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">${priceList.name}</h3>
                    <div class="max-h-60 overflow-y-auto mt-3 pr-2">
                        ${productItems.length > 0 ? `<ul class="divide-y divide-gray-200">${productItems}</ul>` : '<p class="text-sm text-gray-500">لا توجد أسعار خاصة في هذه القائمة.</p>'}
                    </div>
                    ${customersHtml}
                `;
                container.appendChild(el);
            });
            updateIcons();
        }

        // ===== Price Lists Page (single selection) =====
        function normalizeSpaces(s){ return (s||'').toString().replace(/\s+/g,' ').trim(); }
        function initPriceListsPage(){
            try {
                const modeSel = document.getElementById('pl-filter-mode');
                const sel = document.getElementById('pl-selector');
                const printBtn = document.getElementById('pl-print');
                const imageBtn = document.getElementById('pl-image');
                const discountInput = document.getElementById('pl-global-discount');
                if (!modeSel || !sel) return;
                populatePlSelector();
                modeSel.onchange = () => populatePlSelector();
                sel.onchange = () => renderSelectedPriceList();
                if (printBtn) printBtn.onclick = () => printSection('pl-sheet-container');
                if (imageBtn) imageBtn.onclick = () => generateReportImage('pl-sheet-container');
                if (discountInput){
                    discountInput.addEventListener('input', () => renderSelectedPriceList());
                }
                renderSelectedPriceList();
            } catch(e){ console.warn('initPriceListsPage error', e); }
        }
        function populatePlSelector(){
            const modeSel = document.getElementById('pl-filter-mode');
            const sel = document.getElementById('pl-selector');
            if (!modeSel || !sel) return;
            const mode = modeSel.value || 'customer';
            if (mode === 'customer'){
                // Exclude specific customers per request
                const excluded = new Set(['عميل جمله واحد','عميل قطاعي اثنين','عميل  قطاعي اثنين'].map(normalizeSpaces));
                const options = [];
                
                // Add customers
                const list = (state.customers||[])
                  .filter(c => !excluded.has(normalizeSpaces(c.name)))
                  .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                options.push(...list.map(c => `<option value="cust:${c.id}">${escapeHtml(c.name||'')}</option>`));
                
                // Add chains
                const chains = loadChains();
                if (chains.length > 0) {
                    options.push('<optgroup label="السلاسل">');
                    chains.forEach(chain => {
                        options.push(`<option value="chain:${chain.id}">[سلسلة] ${escapeHtml(chain.name||'')}</option>`);
                    });
                    options.push('</optgroup>');
                }
                
                sel.innerHTML = options.join('');
            } else {
                const list = (state.priceLists||[]).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                sel.innerHTML = list.map(pl => `<option value="pl:${pl.id}">${escapeHtml(pl.name||pl.id)}</option>`).join('');
            }
        }
        function renderSelectedPriceList(){
            const modeSel = document.getElementById('pl-filter-mode');
            const sel = document.getElementById('pl-selector');
            const dateEl = document.getElementById('pl-date');
            const custNameEl = document.getElementById('pl-customer-name');
            if (!sel) return;
            const v = sel.value || '';
            if (dateEl) dateEl.textContent = new Date().toLocaleDateString('ar-EG');
            if (v.startsWith('cust:')){
                const cid = v.slice(5);
                const c = (state.customers||[]).find(x => (x.id||x._id) === cid);
                const plId = c?.priceListId || '';
                if (custNameEl) custNameEl.textContent = c ? (c.name||'') : '';
                renderPriceListSheet(plId, c?.name||'');
            } else if (v.startsWith('chain:')){
                const chainId = v.slice(6);
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (custNameEl) custNameEl.textContent = chain ? '[سلسلة] ' + chain.name : '';
                // For chains, we don't have a single price list, so show a message or show first customer's price list
                if (chain && chain.customerIds.length > 0){
                    const firstCustId = chain.customerIds[0];
                    const firstCust = (state.customers||[]).find(x => (x.id||x._id) === firstCustId);
                    const plId = firstCust?.priceListId || '';
                    renderPriceListSheet(plId, chain.name||'');
                } else {
                    renderPriceListSheet('', chain?.name||'');
                }
            } else if (v.startsWith('pl:')){
                const plId = v.slice(3);
                if (custNameEl) custNameEl.textContent = '';
                renderPriceListSheet(plId, '');
            }
            updateIcons();
        }
        // تحديد الأصناف المسموح تعديل باركودها (زبادي / أرز / سمنة / موزاريلا / المعلبات)
        function isBarcodeEditable(name){
            try {
                const n = (name||'').replace(/\s+/g,' ').trim();
                return /(زبادي|زبادى|أرز|رز|سمنة|موزاريلا|موزريلا|مورتة|المورتة|معلبات)/.test(n);
            } catch(e){ return false; }
        }
        function renderPriceListSheet(priceListId, customerName){
            const cont = document.getElementById('pl-sheet-container');
            if (!cont){ return; }
            cont.innerHTML = '';
            const pl = (state.priceLists||[]).find(x => x.id === priceListId) || null;
            if (!pl){
                cont.innerHTML = '<div class="text-center text-gray-500 p-6">لا توجد قائمة أسعار محددة لهذا الاختيار.</div>';
                return;
            }
            const prices = pl.productPrices || {};
            const discountInput = document.getElementById('pl-global-discount');
            const discountPercent = discountInput ? Math.max(0, Number(discountInput.value||0)) : 0;
            const rows = Object.keys(prices).map(pid => {
                const prod = findProduct(pid) || { id: pid, name: pid, unit: '', sku: '' };
                return { pid, name: prod.name||pid, unit: prod.unit||'', barcode: prod.barcode||prod.sku||'', price: Number(prices[pid]||0) };
            }).sort((a,b)=> a.name.localeCompare(b.name));
            const thead = `<thead><tr>
                <th>م</th>
                <th>الكود</th>
                <th>الصنف</th>
                <th>باركود</th>
                <th>الوحدة</th>
                <th>السعر</th>
                <th>ضريبة</th>
                <th>خصم</th>
                <th>صافي السعر</th>
            </tr></thead>`;
            let i = 0; const tbody = rows.map(r => {
                i++;
                const discountAmt = discountPercent ? (r.price * discountPercent / 100) : 0;
                const net = r.price - discountAmt;
                const editable = isBarcodeEditable(r.name);
                const barcodeCell = editable
                    ? `<input type="text" class="barcode-input border rounded px-1 py-0.5 text-sm w-32 focus:outline-none focus:ring-1 focus:ring-blue-400" data-pid="${escapeHtml(r.pid)}" value="${escapeHtml(r.barcode||'')}" placeholder="باركود" />`
                    : `${escapeHtml(r.barcode||'')}`;
                return `<tr>
                    <td>${i}</td>
                    <td>${escapeHtml(r.pid)}</td>
                    <td class="name">${escapeHtml(r.name)}</td>
                    <td>${barcodeCell}</td>
                    <td>${escapeHtml(r.unit||'')}</td>
                    <td>${formatCurrency(r.price)}</td>
                    <td></td>
                    <td>${discountPercent ? formatCurrency(discountAmt) : ''}</td>
                    <td>${formatCurrency(net)}</td>
                </tr>`;
            }).join('');
            cont.innerHTML = `<table class="price-sheet">${thead}<tbody>${tbody}</tbody></table>`;

            // مستمع حفظ الباركود
            function handleBarcodeSave(e){
                const el = e.target;
                if (!el.classList.contains('barcode-input')) return;
                const val = el.value.trim();
                const pid = el.getAttribute('data-pid');
                if (!pid || !window.db) return;
                el.disabled = true;
                updateProduct(pid, { barcode: val }).then(()=>{
                    try {
                        const prod = (state.products||[]).find(p => (p.id||p._id) === pid);
                        if (prod) prod.barcode = val;
                    } catch(e){}
                    el.classList.remove('border-red-400');
                    el.classList.add('border-green-400');
                }).catch(()=>{
                    el.classList.add('border-red-400');
                }).finally(()=>{
                    el.disabled = false;
                });
            }
            cont.querySelectorAll('input.barcode-input').forEach(inp => {
                inp.addEventListener('change', handleBarcodeSave);
                inp.addEventListener('blur', handleBarcodeSave);
            });
        }

        // ===== Remove unwanted customers once (delete from Firestore) =====
        async function attemptDeleteSpecificCustomersOnce(){
            try {
                if (!window.db) return;
                // رفع نسخة المفتاح حتى تُنفّذ العملية مجدداً بناءً على طلب المستخدم
                const FLAG_KEY = 'deleted_named_customers_v3';
                if (localStorage.getItem(FLAG_KEY) === 'done') return;
                const variants = [
                    'عميل جمله واحد','عميل جملة واحد','عميل  جملة واحد','عميل  جمله واحد',
                    'عميل قطاعي اثنين','عميل  قطاعي اثنين','عميل قطاعى اثنين','عميل  قطاعى اثنين'
                ];
                const normSet = new Set(variants.map(v => normalizeSpaces(v)));
                const targets = (state.customers||[]).filter(c => normSet.has(normalizeSpaces(c.name)));
                for (const c of targets){
                    try { await db.collection('customers').doc(c.id||c._id).delete(); } catch(e){ /* ignore */ }
                }
                if (targets.length) localStorage.setItem(FLAG_KEY,'done');
            } catch(e){ /* ignore */ }
        }

        // ===== Inquiry Report Logic (استعلام عن مبيعات العملاء: نطاق تاريخ + عملاء متعددين) =====
        function initInquiryDropdown(){
            try {
                const multiSel = document.getElementById('inq-customers');
                if (!multiSel) return;
                const previous = new Set(Array.from(multiSel.selectedOptions).map(o => o.value));
                
                // Build options: customers + chains
                const options = [];
                
                // Add customers
                (state.customers||[])
                    .filter(c => !/اكسبشن/.test(c.name||'') || !/(حلواني|حلوانى)/.test(c.name||''))
                    .forEach(c => {
                        options.push(`<option value="${c.id||c._id}" ${previous.has(c.id||c._id)?'selected':''}>${escapeHtml(c.name||'')}</option>`);
                    });
                
                // Add chains
                const chains = loadChains();
                if (chains.length > 0) {
                    options.push('<optgroup label="السلاسل">');
                    chains.forEach(chain => {
                        options.push(`<option value="chain-${chain.id}" ${previous.has('chain-'+chain.id)?'selected':''}>[سلسلة] ${escapeHtml(chain.name||'')}</option>`);
                    });
                    options.push('</optgroup>');
                }
                
                multiSel.innerHTML = options.join('');
            } catch(e){ console.warn('initInquiryDropdown failed', e); }
        }
        function generateInquiryReport(){
            const fromStr = document.getElementById('inq-date-from')?.value || '';
            const toStr = document.getElementById('inq-date-to')?.value || '';
            const multiSel = document.getElementById('inq-customers');
            const selectedIds = multiSel ? Array.from(multiSel.selectedOptions).map(o=>o.value) : [];
            const headEl = document.getElementById('inq-report-head');
            const bodyEl = document.getElementById('inq-report-body');
            const summaryEl = document.getElementById('inq-summary');
            const breakdownEl = document.getElementById('inq-customers-breakdown');
            if (!headEl || !bodyEl) return;
            if (!fromStr || !toStr){ bodyEl.innerHTML = '<tr><td colspan="5" class="text-center text-red-600">اختر تاريخ البداية والنهاية.</td></tr>'; return; }
            const start = new Date(fromStr+'T00:00:00');
            const end = new Date(toStr+'T23:59:59');
            if (start > end){ bodyEl.innerHTML = '<tr><td colspan="5" class="text-center text-red-600">النطاق غير صحيح.</td></tr>'; return; }
            
            // Expand chain IDs to actual customer IDs
            let expandedIds = [];
            const chains = loadChains();
            selectedIds.forEach(id => {
                if (id.startsWith('chain-')) {
                    const chainId = id.substring(6);
                    const chain = chains.find(c => c.id === chainId);
                    if (chain) expandedIds.push(...(chain.customerIds || []));
                } else {
                    expandedIds.push(id);
                }
            });
            
            const includeAll = selectedIds.length === 0;
            const idSet = new Set(expandedIds);
            const prodAgg = {}; // pid -> { name, qty, totalValue, unitPrice }
            const filteredSales = (state.sales||[]).filter(s => {
                const d = new Date(s.date);
                if (isNaN(d)) return false;
                if (d < start || d > end) return false;
                if (!includeAll && !idSet.has(s.customerId)) return false;
                return true;
            });
            filteredSales.forEach(s => {
                (s.items||[]).forEach(it => {
                    const pid = it.productId || it.pid || it.productID; const prod = findProduct(pid); if (!prod) return;
                    const qty = Number(it.quantity||it.qty||0);
                    const price = Number(it.unitPrice||it.price||(prod.price||0));
                    if (!prodAgg[pid]) prodAgg[pid] = { name: prod.name||pid, qty:0, totalValue:0, unitPrice: price };
                    prodAgg[pid].qty += qty;
                    prodAgg[pid].totalValue += qty * price;
                });
            });
            const productIds = Object.keys(prodAgg).sort((a,b)=> (prodAgg[a].name||'').localeCompare(prodAgg[b].name||''));
            headEl.innerHTML = '<tr><th>الكود</th><th>اسم الصنف</th><th>الكمية الإجمالية</th><th>متوسط السعر</th><th>المبلغ الإجمالي</th></tr>';
            let totalAll = 0, totalQtyAll = 0;
            const rowsHtml = productIds.map(pid => {
                const p = prodAgg[pid];
                totalAll += p.totalValue; totalQtyAll += p.qty;
                return `<tr><td>${escapeHtml(pid)}</td><td class='prod-name'>${escapeHtml(p.name)}</td><td class='qty-cell'>${p.qty}</td><td>${formatCurrency(p.unitPrice)}</td><td class='total-cell'>${formatCurrency(p.totalValue)}</td></tr>`;
            }).join('');
            bodyEl.innerHTML = rowsHtml || '<tr><td colspan="5" class="text-center text-gray-500">لا توجد بيانات في الفترة المختارة.</td></tr>';
            const distinctCustomers = new Set(filteredSales.map(s=>s.customerId)).size;
            summaryEl.innerHTML = `
                <div class='card'><span>عدد الأصناف</span><span class='val'>${productIds.length}</span></div>
                <div class='card'><span>إجمالي الكمية</span><span class='val'>${totalQtyAll}</span></div>
                <div class='card'><span>إجمالي القيمة</span><span class='val'>${formatCurrency(totalAll)}</span></div>
                <div class='card'><span>عدد العملاء</span><span class='val'>${distinctCustomers}</span></div>`;
            // Breakdown per customer
            if (breakdownEl){
                const custAgg = {};
                filteredSales.forEach(s => {
                    if (!custAgg[s.customerId]) custAgg[s.customerId] = { qty:0, value:0 };
                    (s.items||[]).forEach(it => {
                        const q = Number(it.quantity||it.qty||0);
                        const pr = Number(it.unitPrice||it.price||0);
                        custAgg[s.customerId].qty += q;
                        custAgg[s.customerId].value += q * pr;
                    });
                });
                const rowsCust = Object.entries(custAgg).map(([cid, data]) => {
                    const cObj = (state.customers||[]).find(c => (c.id||c._id) === cid);
                    return `<tr><td>${escapeHtml(cObj?.name||cid||'')}</td><td class='text-center'>${data.qty}</td><td class='text-center'>${formatCurrency(data.value)}</td></tr>`;
                }).join('');
                breakdownEl.innerHTML = rowsCust ? `<h3 class='font-bold mb-2 text-sm'>تفصيل حسب العميل</h3><table class='text-xs w-full border-collapse'><thead><tr class='bg-gray-700 text-white'><th class='p-1 border'>العميل</th><th class='p-1 border'>إجمالي الكمية</th><th class='p-1 border'>إجمالي القيمة</th></tr></thead><tbody>${rowsCust}</tbody></table>` : '';
            }
            updateIcons();
        }
        document.addEventListener('DOMContentLoaded', function(){
            try { initPriceListsPage(); } catch(e){}
            try { initInquiryDropdown(); } catch(e){}
            const genBtn = document.getElementById('inq-generate-btn');
            const printBtn = document.getElementById('inq-print-btn');
            const imgBtn = document.getElementById('inq-image-btn');
            if (genBtn) genBtn.addEventListener('click', generateInquiryReport);
            if (printBtn) printBtn.addEventListener('click', ()=> printSection('page-inquiry'));
            if (imgBtn) imgBtn.addEventListener('click', ()=> generateReportImage('page-inquiry'));
            // live filter
            const filterInput = document.getElementById('inq-customer-filter');
            if (filterInput){
                filterInput.addEventListener('input', () => {
                    const term = filterInput.value.trim();
                    const multiSel = document.getElementById('inq-customers');
                    if (!multiSel) return;
                    const selected = new Set(Array.from(multiSel.selectedOptions).map(o=>o.value));
                    multiSel.innerHTML = (state.customers||[])
                        .filter(c => !/اكسبشن/.test(c.name||'') || !/(حلواني|حلوانى)/.test(c.name||''))
                        .filter(c => !term || (c.name||'').includes(term))
                        .map(c => `<option value="${c.id||c._id}" ${selected.has(c.id||c._id)?'selected':''}>${escapeHtml(c.name||'')}</option>`)
                        .join('');
                });
            }
        });

        // Add quick listeners for debts page action buttons (show reps / show customers)
        document.addEventListener('DOMContentLoaded', () => {
            const showRepsBtn = document.getElementById('debts-show-reps-btn');
            const showCustomersBtn = document.getElementById('debts-show-customers-btn');
            if (showRepsBtn) {
                showRepsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Navigate to rep-debts page which lists all reps and their balances
                    if (typeof navigateTo === 'function') navigateTo('rep-debts');
                });
            }
            if (showCustomersBtn) {
                showCustomersBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Navigate to customers page
                    if (typeof navigateTo === 'function') navigateTo('customers');
                });
            }
        });

        // Refresh button handler: force a re-render of debts table
        document.addEventListener('DOMContentLoaded', () => {
            const refreshBtn = document.getElementById('debts-refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    try {
                        if (typeof renderDebts === 'function') renderDebts();
                    } catch (err) {
                        console.error('Failed to refresh debts:', err);
                    }
                });
            }
        });

        function navigateTo(pageId) {
            // تحديث الفترة النشطة للصفحات التي تتطلب الشهر الحالي
            if (pageId === 'sales' || pageId === 'reports' || pageId === 'debts') {
                try { ensureDefaultActivePeriod(); } catch(e){}
            }
            
            // Restrict pages by role (central guard)
            try {
                if (!canAccessPage(pageId)) {
                    if (typeof lastRequestedPage !== 'undefined' && lastRequestedPage === pageId) {
                        try { customDialog({ title:'غير مصرح', message:'صلاحياتك لا تسمح بفتح هذه الصفحة.' }); } catch(_) { alert('غير مصرح'); }
                    }
                    pageId = 'dashboard';
                }
            } catch(e){}
            // Avoid redundant heavy re-renders when navigating to the same page repeatedly
            try {
                if (window.__currentPage === pageId) { updateIcons(); return; }
                window.__currentPage = pageId;
            } catch(_){}
            // Clear inline display and classes for all pages, rely purely on CSS
            document.querySelectorAll('.page').forEach(p => { p.classList.remove('active'); p.style.display=''; }); 
            const pageEl = document.getElementById(`page-${pageId}`); 
            
            // Handle reports page activation differently
            if (pageId === 'reports') {
                pageEl.classList.add('active');
                reportsSubnav.classList.add('active');
                initializeReportsPage();
            } else {
                 // Deactivate reports subnav for all other pages
                reportsSubnav.classList.remove('active'); 
            }
            
            if (pageEl) { pageEl.classList.add('active'); } else { console.error(`Page element not found for ID: page-${pageId}`); } 
            
            document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active')); 
            const navButton = document.querySelector(`.bottom-nav-item[data-page="${pageId}"]`); 
            if (navButton) navButton.classList.add('active'); 
            
            const titles = { dashboard: 'لوحة المعلومات والتقارير', 'spreadsheet-entry': 'إدخال سريع', sales: 'جميع المبيعات', dispatch: 'أذونات الاستلام', reports: 'التقارير التفصيلية', promotions: 'العروض الترويجية', customers: 'العملاء', reps: 'إدارة المناديب', 'rep-debts': 'مديونات المناديب', 'total-bills': 'إجمالي الفواتير', 'price-lists': 'قوائم الأسعار', settings: 'الإعدادات' }; 
            headerTitle.textContent = titles[pageId] || 'تطبيق مندوبي'; 
            
            if (pageId === 'dashboard') { 
                renderDashboard(); 
                renderSales7DaysChart(); 
                renderTopRepsChart(); 
                renderTopProductsChart(); 
                renderTopCustomersChart(); 
            } else if (pageId === 'sales') {
                // تحديث فوري لصفحة المبيعات مع الفترة النشطة
                try { 
                    renderAllSales('', '', 'all');
                    console.log(`Sales page loaded with activePeriod: ${window.state?.activePeriod}`);
                } catch(e){ console.warn('renderAllSales failed', e); }
            } else if (pageId === 'spreadsheet-entry') { 
                initializeSpreadsheetPage(); 
            } else if (pageId === 'promotions') { 
                renderPromotions(); 
            } else if (pageId === 'debts') { 
                renderDebts(); 
            } else if (pageId === 'rep-debts') { 
                renderRepDebts(); 
            } else if (pageId === 'total-bills'){
                renderTotalBills();
            } else if (pageId === 'stock-control') {
                renderStockLedger();
            } else if (pageId === 'dispatch') {
                try { initializeNewDispatchGrid(); } catch(_){}
                try { renderDispatchPage(); } catch(_){}
            } else if (pageId === 'price-lists') {
                initPriceListsPage();
            }
            updateIcons(); 
        }

        // إخفاء أزرار الصفحات غير المسموح بها حسب الدور
        function applyRoleNavRestrictions(){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const buttons = Array.from(document.querySelectorAll('.bottom-nav .bottom-nav-item'));
                const allow = ROLE_PAGE_ALLOW[role];
                if (!allow || allow === 'ALL') { buttons.forEach(btn => btn.style.display = ''); return; }
                buttons.forEach(btn => {
                    const p = btn.getAttribute('data-page');
                    if (allow.has(p)) btn.style.display = '';
                    else btn.style.display = 'none';
                });
            } catch(_){ }
        }
        document.addEventListener('DOMContentLoaded', applyRoleNavRestrictions);
        // إعادة تطبيق إخفاء الأيقونات بعد 1 و 3 ثوانٍ لضمان أن الدور تم تحميله
        setTimeout(applyRoleNavRestrictions, 1000);
        setTimeout(applyRoleNavRestrictions, 3000);



        function getPreviousDate(dateString) {
            const date = new Date(dateString);
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }

        function renderStockLedger() {
            const date = document.getElementById('stock-control-date').value || new Date().toISOString().split('T')[0];
            const prevDate = getPreviousDate(date);
            const body = document.getElementById('stock-control-table-body');
            body.innerHTML = '';

            const prevDayBalances = state.stockEntries[prevDate] || {};
            const currentDayEntries = state.stockEntries[date] || {};
            const salesForDate = state.sales.filter(s => new Date(s.date).toISOString().split('T')[0] === date);
            const dispatchesForDate = state.dispatchNotes.filter(d => new Date(d.date).toISOString().split('T')[0] === date);

            if (state.products.length === 0) {
                body.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">الرجاء إضافة منتجات أولاً من صفحة الإعدادات.</td></tr>`;
                return;
            }

            state.products.forEach(product => {
                let openingBalanceValue = currentDayEntries[product.id]?.opening;
                if (openingBalanceValue === undefined) {
                    openingBalanceValue = (prevDayBalances[product.id]?.actual !== undefined) ? prevDayBalances[product.id].actual : 0;
                }

                const totalInward = dispatchesForDate.reduce((sum, dispatch) => {
                    const item = dispatch.items.find(i => i.productId === product.id);
                    return sum + (item ? (item.quantity || 0) : 0);
                }, 0);

                const totalOutbound = salesForDate.reduce((sum, sale) => {
                    const item = sale.items.find(i => i.productId === product.id);
                    return sum + (item ? (item.quantity || 0) : 0);
                }, 0);
                
                const row = document.createElement('tr');
                row.dataset.productId = product.id;
                row.innerHTML = `
                    <td class="px-2 py-2 text-sm font-medium text-gray-800 text-right">${product.name}</td>
                    <td class="px-2 py-2 stock-col-initial"><input type="number" class="w-20 p-1 border rounded text-center opening-balance" value="${openingBalanceValue}"></td>
                    <td class="px-2 py-2 text-center text-sm stock-col-inward">${totalInward}</td>
                    <td class="px-2 py-2 stock-col-production"><input type="number" class="w-20 p-1 border rounded text-center production-qty" value="${currentDayEntries[product.id]?.production || 0}"></td>
                    <td class="px-2 py-2 text-center text-sm stock-col-outbound">${totalOutbound}</td>
                    <td class="px-2 py-2 text-center text-sm font-bold stock-col-book">0</td>
                    <td class="px-2 py-2 stock-col-actual"><input type="number" class="w-20 p-1 border rounded text-center actual-balance"></td>
                    <td class="px-2 py-2 text-center text-sm font-bold stock-col-diff">0</td>
                    <td class="px-2 py-2 text-center text-sm font-semibold stock-col-diff"></td>
                `;
                body.appendChild(row);

                const openingBalanceInput = row.querySelector('.opening-balance');
                const productionInput = row.querySelector('.production-qty');
                const actualBalanceInput = row.querySelector('.actual-balance');
                const bookBalanceCell = row.querySelector('.stock-col-book');
                const diffCell = row.querySelector('.stock-col-diff');
                const diffTextCell = row.querySelectorAll('.stock-col-diff')[1];

                function updateRowCalculations() {
                    const openingBalance = parseInt(openingBalanceInput.value) || 0;
                    const productionQty = parseInt(productionInput.value) || 0;
                    const bookBalance = openingBalance + totalInward + productionQty - totalOutbound;
                    bookBalanceCell.textContent = bookBalance;

                    const actualBalance = parseInt(actualBalanceInput.value);
                    if (!isNaN(actualBalance)) {
                        const difference = actualBalance - bookBalance;
                        diffCell.textContent = difference;
                        if (difference > 0) {
                            diffTextCell.textContent = 'زيادة';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-green-700 stock-col-diff';
                        } else if (difference < 0) {
                            diffTextCell.textContent = 'عجز';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-red-700 stock-col-diff';
                        } else {
                            diffTextCell.textContent = 'مطابق';
                            diffTextCell.className = 'px-2 py-2 text-center text-sm font-semibold text-gray-700 stock-col-diff';
                        }
                    } else {
                        diffCell.textContent = '-';
                        diffTextCell.textContent = '';
                    }
                }

                openingBalanceInput.addEventListener('focus', (e) => {
                    e.target.dataset.previousValue = e.target.value;
                });

                openingBalanceInput.addEventListener('change', async (e) => {
                    const confirmed = await customDialog({
                        title: 'تأكيد تعديل الرصيد',
                        message: 'هل أنت متأكد أنك تريد تعديل الرصيد المبدئي يدوياً؟',
                        isConfirm: true,
                        confirmText: 'نعم، عدل',
                        confirmClass: 'bg-orange-500 hover:bg-orange-600'
                    });

                    if (confirmed) {
                        const newValue = parseInt(e.target.value);
                        if (!isNaN(newValue)) {
                            if (!state.stockEntries[date]) state.stockEntries[date] = {};
                            if (!state.stockEntries[date][product.id]) state.stockEntries[date][product.id] = {};
                            state.stockEntries[date][product.id].opening = newValue;
                            saveState();
                            updateRowCalculations();
                        }
                    } else {
                        e.target.value = e.target.dataset.previousValue;
                    }
                });

                productionInput.addEventListener('input', updateRowCalculations);
                actualBalanceInput.addEventListener('input', updateRowCalculations);
                
                // Initial calculation
                updateRowCalculations();
                const bookBalance = parseInt(bookBalanceCell.textContent);
                actualBalanceInput.value = currentDayEntries[product.id]?.actual ?? bookBalance;
                updateRowCalculations();
            });
        }

        function saveStockBalances() {
            const date = document.getElementById('stock-control-date').value;
            if (!date) {
                customDialog({ title: 'خطأ', message: 'الرجاء تحديد تاريخ أولاً.' });
                return;
            }

            if (!state.stockEntries[date]) {
                state.stockEntries[date] = {};
            }

            const rows = document.querySelectorAll('#stock-control-table-body tr');
            rows.forEach(row => {
                const productId = row.dataset.productId;
                const actualBalanceInput = row.querySelector('.actual-balance');
                const productionInput = row.querySelector('.production-qty');
                if (productId) {
                    if (!state.stockEntries[date][productId]) {
                        state.stockEntries[date][productId] = {};
                    }
                    const actualBalance = parseInt(actualBalanceInput.value);
                    if (!isNaN(actualBalance)) {
                        state.stockEntries[date][productId].actual = actualBalance;
                    }
                    const productionQty = parseInt(productionInput.value);
                    if (!isNaN(productionQty)) {
                        state.stockEntries[date][productId].production = productionQty;
                    }
                }
            });

            saveState();
            customDialog({ title: 'تم الحفظ', message: `تم حفظ الرصيد الفعلي والإنتاج لليوم التالي بتاريخ ${formatArabicDate(date)}.` });
        }

        function renderTotalBills(sortKey, sortDirection) {
            const tableBody = document.getElementById('total-bills-table-body');
            const fromDate = document.getElementById('filter-from-date').value;
            const toDate = document.getElementById('filter-to-date').value;
            const customerName = document.getElementById('filter-customer-name').value.toLowerCase();
            const invoiceNumber = document.getElementById('filter-invoice-number').value;

            let filteredSales = state.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                if (fromDate && new Date(sale.date).toISOString().split('T')[0] < fromDate) return false;
                if (toDate && new Date(sale.date).toISOString().split('T')[0] > toDate) return false;
                const customer = findCustomer(sale.customerId);
                if (customerName && customer && !customer.name.toLowerCase().includes(customerName)) return false;
                if (invoiceNumber && sale.invoiceNumber.toString() !== invoiceNumber) return false;
                // تصفية حسب المندوب الحالي إذا كان دوره مندوب
                let role = typeof getUserRole === 'function' ? getUserRole() : 'rep';
                let currentEmail = (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null;
                if (role === 'rep' && currentEmail) {
                    if ((sale.repEmail||'').toLowerCase() !== currentEmail) return false;
                }
                return true;
            });

            // --- NEW: Calculate and display total ---
            const filteredTotal = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const totalAmountEl = document.getElementById('total-bills-summary-amount');
            if (totalAmountEl) {
                totalAmountEl.textContent = formatCurrency(filteredTotal);
            }
            // --- END NEW ---

            if (sortKey && sortDirection) {
                filteredSales.sort((a, b) => {
                    let valA, valB;
                    if (sortKey === 'customerName') {
                        valA = findCustomer(a.customerId)?.name || '';
                        valB = findCustomer(b.customerId)?.name || '';
                    } else {
                        valA = a[sortKey];
                        valB = b[sortKey];
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const reviewState = loadReviewState();
            tableBody.innerHTML = filteredSales.map(sale => {
                const customer = findCustomer(sale.customerId);
                const category = sale.items.length > 0 ? (findProduct(sale.items[0].productId)?.category || 'N/A') : 'N/A';
                const highlightClass = reviewState[sale.id] || '';

                return `
                    <tr>
                        <td class="p-4"><input type="checkbox" class="total-bill-row-checkbox" value="${sale.id}"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-center bg-slate-100">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-bold invoice-cell ${highlightClass}" data-id="${sale.id}">${sale.invoiceNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right bg-purple-100">${customer ? customer.name : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right bg-pink-100">${sale.repName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold bg-cyan-100">${formatCurrency(sale.total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${getStatusBadge(sale.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right bg-orange-100">${category}</td>
                    </tr>
                `;
            }).join('');
        }


        // Populate chains dropdown
        function populateChainsDropdown(selectEl) {
            if (!selectEl) return;
            const chains = loadChains();
            const currentValue = selectEl.value;
            selectEl.innerHTML = '<option value="">جميع السلاسل</option>';
            chains.forEach(chain => {
                const opt = document.createElement('option');
                opt.value = chain.id;
                opt.textContent = chain.name || 'بدون اسم';
                selectEl.appendChild(opt);
            });
            selectEl.value = currentValue;
        }

        function renderDashboard() {
             const now = new Date();
             const selectedRepName = (document.getElementById('dashboard-rep-filter') || {}).value || '';
             const selectedChainId = (document.getElementById('dashboard-chain-filter') || {}).value || '';
             const currentMonthSales = state.sales.filter(s => { const saleDate = new Date(s.date); return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear(); });
            let filteredMonthSales = currentMonthSales;
            
            // Apply chain filter: get all customers in the chain and filter sales
            let allowedCustomerIds = null;
            if (selectedChainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === selectedChainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            // Prefer the global target from settings when no rep is selected. If settings target is missing/zero, fall back to sum of rep targets.
            let currentTarget = Number(state.settings?.salesTarget || 0);
            const targetTitleEl = document.getElementById('target-title');
            if (selectedRepName) {
                filteredMonthSales = currentMonthSales.filter(s => s.repName === selectedRepName);
                const targetRep = findRep(selectedRepName);
                currentTarget = targetRep ? (targetRep.target || 0) : 0;
                if (targetTitleEl) targetTitleEl.innerHTML = `الهدف الشهري لـ <span class="text-blue-600">${selectedRepName}</span>`;
            } else {
                // Use settings.salesTarget as the global monthly target. If it's falsy, fall back to the sum of individual rep targets.
                if (!currentTarget || currentTarget <= 0) {
                    currentTarget = state.reps.reduce((sum, rep) => sum + (rep.target || 0), 0) || 0;
                }
                if (targetTitleEl) targetTitleEl.textContent = `الهدف الشهري (الإجمالي):`;
            }
            
            // Apply chain filter to sales
            if (allowedCustomerIds) {
                filteredMonthSales = filteredMonthSales.filter(s => allowedCustomerIds.includes(s.customerId || s.customerId));
            }
            
            const totalSales = filteredMonthSales.reduce((sum, s) => sum + s.total, 0);
            const totalCollected = filteredMonthSales.reduce((sum, s) => sum + s.paidAmount, 0);
            const totalDue = totalSales - totalCollected;
            if (document.getElementById('total-sales')) document.getElementById('total-sales').textContent = formatCurrency(totalSales);
            if (document.getElementById('total-collected')) document.getElementById('total-collected').textContent = formatCurrency(totalCollected);
            if (document.getElementById('total-due')) document.getElementById('total-due').textContent = formatCurrency(totalDue);
            if (document.getElementById('sales-count')) document.getElementById('sales-count').textContent = filteredMonthSales.length;
            const progress = currentTarget > 0 ? Math.min((totalSales / currentTarget) * 100, 100) : 0;
            if (document.getElementById('target-amount-display')) document.getElementById('target-amount-display').textContent = formatCurrency(currentTarget);
            const progressBar = document.getElementById('target-progress-bar'); if (progressBar) progressBar.style.width = `${progress}%`;
            if (document.getElementById('target-progress-text')) document.getElementById('target-progress-text').textContent = `${Math.round(progress)}%`;
            const recentSalesList = document.getElementById('recent-sales-list'); if (recentSalesList) recentSalesList.innerHTML = '';
            let recentSales = [...state.sales].reverse();
            if (selectedRepName) { recentSales = recentSales.filter(s => s.repName === selectedRepName); }
            if (allowedCustomerIds) { recentSales = recentSales.filter(s => allowedCustomerIds.includes(s.customerId || s.customerId)); }
            recentSales = recentSales.slice(0, 5);
            if (!recentSalesList) return;
            if (recentSales.length === 0) { recentSalesList.innerHTML = '<p class="text-gray-500 text-center">لا توجد عمليات بيع بعد.</p>'; return; }
            recentSales.forEach(sale => { const customer = findCustomer(sale.customerId); 
    // NEW: Return detection for dashboard recent sales
    const isReturn = sale.total < 0;
    const totalAmountClass = isReturn ? 'text-red-700' : 'text-green-700';

    const el = document.createElement('div'); el.className = 'bg-gray-50 p-3 rounded-lg flex justify-between items-center'; 
    el.innerHTML = `<div><p class="font-bold">${customer && customer.name ? customer.name : (sale.customerName || 'غير معروف')}</p><p class="text-sm text-gray-500"><bdo dir="rtl">${formatArabicDateTime(sale.date)}</bdo></p><p class="text-xs text-blue-600 pt-1">${sale.repName || ''}</p></div><div class="text-left space-y-1"><p class="font-bold ${totalAmountClass}">${formatCurrency(sale.total)}</p>${getStatusBadge(sale.status)}</div>`; recentSalesList.appendChild(el); }); updateIcons();
        }
        
        // --- CHART RENDERING FUNCTIONS ---
        function getSalesDataForLast7Days() { 
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dataMap = new Map();
            const labels = [];
            for (let i = 6; i >= 0; i--) { const d = new Date(today); d.setDate(today.getDate() - i); const dateString = d.toISOString().split('T')[0]; labels.push(d.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' })); dataMap.set(dateString, 0); }
            state.sales.forEach(sale => { const saleDateString = new Date(sale.date).toISOString().split('T')[0]; if (dataMap.has(saleDateString)) { dataMap.set(saleDateString, dataMap.get(saleDateString) + sale.total); } });
            return { labels, data: Array.from(dataMap.values()) }; 
        }
        function getTopRepsData(count = 5) { 
            const repSalesMap = new Map(); state.sales.forEach(sale => { const repName = sale.repName || 'غير محدد'; repSalesMap.set(repName, (repSalesMap.get(repName) || 0) + sale.total); }); const sortedReps = Array.from(repSalesMap.entries()).sort((a, b) => b[1] - a[1]).slice(0, count); 
            return { labels: sortedReps.map(r => r[0]), data: sortedReps.map(r => r[1]) }; 
        }
        function getTopProductsData(count = 5) { 
            const productQtyMap = new Map(); state.sales.forEach(sale => { sale.items.forEach(item => { const product = findProduct(item.productId); const productName = product ? product.name : 'منتج محذوف'; productQtyMap.set(productName, (productQtyMap.get(productName) || 0) + item.quantity); }); }); const sortedProducts = Array.from(productQtyMap.entries()).sort((a, b) => b[1] - a[1]).slice(0, count); 
            return { labels: sortedProducts.map(p => p[0]), data: sortedProducts.map(p => p[1]) }; 
        }
        function getTopCustomersData(count = 5) { 
            const customerSalesMap = new Map(); state.sales.forEach(sale => { const customer = findCustomer(sale.customerId); const customerName = customer ? customer.name : 'عميل محذوف'; customerSalesMap.set(customerName, (customerSalesMap.get(customerName) || 0) + sale.total); }); const sortedCustomers = Array.from(customerSalesMap.entries()).sort((a, b) => b[1] - a[1]).slice(0, count); 
            return { labels: sortedCustomers.map(c => c[0]), data: sortedCustomers.map(c => c[1]) }; 
        }
        function createOrUpdateChart(chartInstance, canvasId, type, data, options) { 
             if (chartInstance) { chartInstance.data.labels = data.labels; chartInstance.data.datasets[0].data = data.data; chartInstance.update(); return chartInstance; }
             const ctx = document.getElementById(canvasId)?.getContext('2d'); 
             if (!ctx) return null; // Add check for context
             return new Chart(ctx, { type: type, data: { labels: data.labels, datasets: [{ label: options.label || 'القيمة', data: data.data, backgroundColor: options.backgroundColor || 'rgba(59, 130, 246, 0.5)', borderColor: options.borderColor || 'rgba(59, 130, 246, 1)', borderWidth: options.borderWidth || 1, tension: 0.3, ...options.datasetOverrides }] }, options: { responsive: true, maintainAspectRatio: false, rtl: true, plugins: { legend: { labels: { font: { family: 'Cairo' } } } }, scales: { x: { reverse: true, ticks: { font: { family: 'Cairo' } }, title: { display: !!options.xTitle, text: options.xTitle, font: { family: 'Cairo' } } }, y: { beginAtZero: true, ticks: { font: { family: 'Cairo' } }, title: { display: !!options.yTitle, text: options.yTitle, font: { family: 'Cairo' } } } }, ...options.overrides } }); 
        }
        function renderSales7DaysChart() { const data = getSalesDataForLast7Days(); sales7DaysChart = createOrUpdateChart(sales7DaysChart, 'sales-7-days-chart', 'line', data, { label: 'إجمالي المبيعات (ج.م)', backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', yTitle: 'المبيعات (ج.م)', datasetOverrides: { fill: true } }); }
        function renderTopRepsChart() { const data = getTopRepsData(5); topRepsChart = createOrUpdateChart(topRepsChart, 'top-reps-chart', 'bar', data, { label: 'قيمة المبيعات (ج.م)', backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgba(16, 185, 129, 1)', yTitle: 'قيمة المبيعات', overrides: { indexAxis: 'y' } }); }
        function renderTopProductsChart() { const data = getTopProductsData(5); topProductsChart = createOrUpdateChart(topProductsChart, 'top-products-chart', 'bar', data, { label: 'الكمية (قطع)', backgroundColor: 'rgba(234, 179, 8, 0.7)', borderColor: 'rgba(234, 179, 8, 1)', yTitle: 'الكمية', overrides: { indexAxis: 'y' } }); }
        function renderTopCustomersChart() { const data = getTopCustomersData(5); topCustomersChart = createOrUpdateChart(topCustomersChart, 'top-customers-chart', 'doughnut', data, { label: 'قيمة المبيعات (ج.م)', backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'], borderColor: '#fff', overrides: { parsing: { key: 'data' } }, datasetOverrides: { hoverOffset: 4 } }); }
        // --- END CHART FUNCTIONS ---

        async function salesListClickHandler(e) {
            const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
            // --- Manual Review Highlighting ---
            const reviewCell = e.target.closest('.invoice-cell'); 
            if (reviewCell) {
                const invoiceSpan = reviewCell.closest('.invoice-review-span');
                if (invoiceSpan) {
                    const saleId = invoiceSpan.dataset.id;
                    toggleReviewColor(saleId, reviewCell);
                    return; // Stop further execution to prevent other buttons from firing
                }
            }

            const editBtn = e.target.closest('.edit-sale-btn');
            const deleteBtn = e.target.closest('.delete-sale-btn');
            const printBtn = e.target.closest('.print-sale-btn');
            const shareImageBtn = e.target.closest('.share-sale-image-btn');
            const usbPrintBtn = e.target.closest('.usb-print-sale-btn');
            const etaUploadBtn = e.target.closest('.eta-upload-btn');
            const approveBtn = e.target.closest('.review-sale-btn');
            const reviewOpenBtn = e.target.closest('.review-open-btn');
            const taxToggleBtn = e.target.closest('.tax-status-toggle-btn');

            if (approveBtn) {
                if (role !== 'admin') { await customDialog({ title:'غير مصرح', message:'اعتماد الفاتورة من صلاحيات المشرف فقط.' }); return; }
                try {
                    const saleId = approveBtn.getAttribute('data-id');
                    await updateSale(saleId, { reviewStatus: 'reviewed' });
                } catch(err){ console.warn('approve review failed', err); }
                return;
            }

            if (reviewOpenBtn) {
                const saleId = reviewOpenBtn.getAttribute('data-id');
                openSaleModal(saleId);
                // بعد فتح المودال، أضف زر اعتماد داخلي إن لزم
                setTimeout(() => {
                    try {
                        const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                        const sale = (state.sales||[]).find(s=>s.id===saleId);
                        if (sale && sale.reviewStatus === 'pending' && (role === 'admin')) {
                            const modal = document.getElementById('sale-modal');
                            if (modal && !modal.querySelector('.modal-review-approve-btn')) {
                                const footer = modal.querySelector('form') || modal;
                                const btn = document.createElement('button');
                                btn.type = 'button';
                                btn.className = 'modal-review-approve-btn mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm flex items-center gap-1';
                                btn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> اعتماد الفاتورة';
                                footer.appendChild(btn);
                                btn.addEventListener('click', async ()=>{
                                    try { await updateSale(saleId, { reviewStatus: 'reviewed' }); closeModal(modal); } catch(e){ alert('تعذر الاعتماد'); }
                                });
                                updateIcons();
                            }
                        }
                    } catch(_){ }
                }, 120);
                return;
            }

            if (editBtn) {
                const saleId = editBtn.dataset.id;
                if (role === 'rep') {
                    try {
                        const current = AuthSystem.getCurrentUser();
                        const sale = (state.sales||[]).find(s=>s.id===saleId);
                        const mine = sale && (String(sale.createdBy||'') === String(current?.id||'') || String(sale.repId||'') === String(current?.id||''));
                        const createdAt = sale && sale.createdAt ? new Date(sale.createdAt).getTime() : 0;
                        const ageMs = Date.now() - createdAt;
                        const fresh = createdAt > 0 && ageMs < (30*60*1000); // 30 دقيقة
                        const notReviewed = !sale || (sale.reviewStatus !== 'reviewed');
                        if (mine && fresh && notReviewed) {
                            openSaleModal(saleId);
                        } else {
                            await customDialog({ title:'غير مصرح', message:'المندوب يمكنه تعديل الفاتورة الجديدة لفترة قصيرة فقط وقبل اعتمادها.' });
                        }
                    } catch(_) {
                        await customDialog({ title:'غير مصرح', message:'المندوب لا يملك صلاحية تعديل هذه الفاتورة.' });
                    }
                    return;
                }
                openSaleModal(saleId);
            }

            if (deleteBtn) {
                if (role === 'rep') { await customDialog({ title:'صلاحيات', message:'المندوب لا يملك صلاحية حذف الفواتير.' }); return; }
                const saleId = deleteBtn.dataset.id;
                const confirmed = await customDialog({
                    title: 'تأكيد الحذف',
                    message: 'هل أنت متأكد أنك تريد حذف هذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء.',
                    isConfirm: true,
                    confirmText: 'نعم، احذف',
                    confirmClass: 'bg-red-600 hover:bg-red-700'
                });

                if (confirmed) {
                    try {
                        await deleteSale(saleId);
                        await customDialog({ message: 'تم حذف الفاتورة نهائياً من السحابة.' });
                    } catch (err) {
                        console.warn('Delete failed', err);
                        await customDialog({ message: 'تعذر حذف الفاتورة من السحابة. تحقق من الصلاحيات/الاتصال.' });
                    }
                }
            }

            if (printBtn) {
                const saleId = printBtn.getAttribute('data-id');
                try { await window.printSaleById(saleId); } catch(e){ console.warn('printSaleById failed', e); }
                return;
            }

            if (shareImageBtn) {
                const saleId = shareImageBtn.getAttribute('data-id');
                try { await window.shareSaleReceiptImage(saleId); } catch(e){ console.warn('shareSaleReceiptImage failed', e); }
                return;
            }

            if (usbPrintBtn) {
                const saleId = usbPrintBtn.getAttribute('data-id');
                try {
                    const sale = (state.sales||[]).find(s => s.id === saleId);
                    if (sale && typeof window.printViaUSB === 'function') {
                        await window.printViaUSB(sale);
                    } else {
                        alert('دالة الطباعة عبر USB غير متوفرة');
                    }
                } catch(e){ console.warn('USB print failed', e); alert('خطأ في الطباعة عبر USB: ' + (e && e.message)); }
                return;
            }

            if (etaUploadBtn) {
                const roleNow = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (roleNow !== 'admin') { await customDialog({ title:'غير مصرح', message:'هذا الإجراء مخصص للمشرف فقط.' }); return; }
                const saleId = etaUploadBtn.getAttribute('data-id');
                try { await window.uploadSaleToEta(saleId); } catch(e){ console.warn('uploadSaleToEta failed', e); }
                return;
            }
            
            
            if (taxToggleBtn) {
                const saleId = taxToggleBtn.dataset.id;
                const sale = state.sales.find(s => s.id === saleId);
                if (sale) {
                    const currentStatus = sale.taxFilingStatus || '';
                    const isFiled = currentStatus.trim().toLowerCase() === 'تم';
                    
                    const newStatus = isFiled ? '' : 'تم'; // Toggle status
                    sale.taxFilingStatus = newStatus;
                    sale.updatedAt = new Date().toISOString();
                    
                    renderAll(); // Re-render to show the change
                    saveState(); // Persist the change
                }
            }
        }

        // Quick print button logic (asks for invoice number then prints)
        document.addEventListener('click', async function(e){
            const btn = e.target && (e.target.id === 'sales-quick-print-btn' || (e.target.closest && e.target.closest('#sales-quick-print-btn')));
            if (!btn) return;
            try {
                const inv = prompt('أدخل رقم الفاتورة للطباعة:');
                if (!inv) return;
                const sale = (state.sales||[]).find(s => String(s.invoiceNumber||'') === String(inv));
                if (!sale) { alert('لم يتم العثور على فاتورة بهذا الرقم'); return; }
                await window.printSaleById(sale.id);
            } catch(err){ console.warn('quick print failed', err); }
        });

        function renderAllSales(textFilter = '', dateFilter = '', taxStatusFilter = 'all', reviewFilterArg = null) {
             const salesList = document.getElementById('sales-list'); 
             salesList.innerHTML = '';
             // Defensive guards & debug to diagnose empty-sales regression
             try {
                 console.debug('renderAllSales called', { textFilter, dateFilter, taxStatusFilter, stateSalesLength: Array.isArray(state.sales) ? state.sales.length : state.sales });
             } catch (e) { /* ignore console errors */ }

             if (!Array.isArray(state.sales)) state.sales = [];
             // Normalize filters
             textFilter = (textFilter || '').toString().trim();
             dateFilter = (dateFilter || '').toString().trim();

             let filteredSales = [...state.sales];
             // تصفية حسب المندوب الحالي إذا كان دوره مندوب
             let role = typeof getUserRole === 'function' ? getUserRole() : 'rep';
             let currentEmail = (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null;
             if (role === 'rep' && currentEmail) {
                 filteredSales = filteredSales.filter(sale => (sale.repEmail||'').toLowerCase() === currentEmail);
             }
            // Read review filter from DOM if not passed
            const reviewStatusFilter = reviewFilterArg || (document.getElementById('review-status-filter')?.value || 'all');

                 // MONTHLY PERIOD FILTER (activePeriod) overrides single-day filter
                 const activePeriod = (state && state.activePeriod) ? String(state.activePeriod) : '';
                 if (activePeriod) {
                     // Filter by year-month match
                     filteredSales = filteredSales.filter(sale => {
                          try { return new Date(sale.date).toISOString().slice(0,7) === activePeriod; } catch(e){ return false; }
                     });
                     // Hide daily total (could implement monthly total later)
                     try { document.getElementById('daily-total-container').classList.add('hidden'); } catch(e){}
                 } else if (dateFilter) {
                     // Fallback to legacy daily filter only when no activePeriod enforced
                     const dailyFilteredSales = filteredSales.filter(sale => new Date(sale.date).toLocaleDateString('en-CA') === dateFilter);
                     const dailyTotal = dailyFilteredSales.reduce((sum, s) => sum + s.total, 0);
                     try {
                          document.getElementById('daily-total-amount').textContent = formatCurrency(dailyTotal);
                          document.getElementById('daily-total-container').classList.remove('hidden');
                     } catch(e){}
                     filteredSales = dailyFilteredSales;
                 } else {
                     try { document.getElementById('daily-total-container').classList.add('hidden'); } catch(e){}
                 }

             if (textFilter) { 
                const lowerCaseFilter = textFilter.toLowerCase(); 
                filteredSales = filteredSales.filter(sale => { 
                    const customer = findCustomer(sale.customerId); 
                    const customerNameMatch = customer && customer.name.toLowerCase().includes(lowerCaseFilter); 
                    const invoiceNumberMatch = sale.invoiceNumber.toString().includes(lowerCaseFilter); 
                    const totalMatch = sale.total.toString().includes(lowerCaseFilter) || formatCurrency(sale.total).includes(lowerCaseFilter); 
                    return customerNameMatch || invoiceNumberMatch || totalMatch; 
                }); 
            }

            // --- Review status filter ---
            if (reviewStatusFilter === 'pending') {
                filteredSales = filteredSales.filter(s => String(s.reviewStatus||'').toLowerCase() === 'pending');
            } else if (reviewStatusFilter === 'reviewed') {
                filteredSales = filteredSales.filter(s => String(s.reviewStatus||'').toLowerCase() === 'reviewed');
            }
             
             if (taxStatusFilter === 'filed') {
                filteredSales = filteredSales.filter(sale => {
                    const customer = findCustomer(sale.customerId);
                    if (!customer || !customer.requiresTaxFiling) return false;
                    return sale.taxFilingStatus && sale.taxFilingStatus.trim().toLowerCase() === 'تم';
                });
            } else if (taxStatusFilter === 'not-filed') {
                filteredSales = filteredSales.filter(sale => {
                    const customer = findCustomer(sale.customerId);
                    if (!customer || !customer.requiresTaxFiling) return false;
                    return !sale.taxFilingStatus || sale.taxFilingStatus.trim().toLowerCase() !== 'تم';
                });
            }

            // --- NEW: Calculate and display total of what's being shown ---
            const filteredTotal = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const filteredTotalAmountEl = document.getElementById('filtered-total-amount');
            if (filteredTotalAmountEl) {
                filteredTotalAmountEl.textContent = formatCurrency(filteredTotal);
            }
            const filteredCountEl = document.getElementById('filtered-total-count');
            if (filteredCountEl) {
                filteredCountEl.textContent = String(filteredSales.length);
            }
            // --- END NEW ---

             // ترتيب تصاعدي: الأقدم أولاً والأحدث في الأسفل
             try {
                 filteredSales.sort((a,b)=>{
                     const ta = new Date(a.date||0).getTime();
                     const tb = new Date(b.date||0).getTime();
                     return ta - tb;
                 });
             } catch(_){ /* keep original order as fallback */ }

             if (filteredSales.length === 0) { salesList.innerHTML = '<p class="text-gray-500 text-center mt-8">لا توجد فواتير تطابق بحثك.</p>'; return; }
             
             const reviewState = loadReviewState();
             filteredSales.forEach((sale, index) => { 
                const customer = findCustomer(sale.customerId); 
                
                // NEW: Return Detection and Styling
                const isReturn = sale.total < 0;
                const badgeText = isReturn ? 'مرتجع' : 'فاتورة';
                const badgeColor = isReturn ? 'bg-red-600 text-white' : 'bg-blue-600 text-white';
                const saleBgColor = isReturn ? 'bg-red-50 border-red-200' : `${(index % 2 === 0) ? 'bg-white' : 'bg-gray-50'} border-gray-200`;
                const totalAmountClass = isReturn ? 'text-red-700' : 'text-blue-700';
                
                const itemsList = sale.items.map((item, itemIndex) => { 
                    const product = findProduct(item.productId); 
                    const itemName = product ? product.name : 'منتج محذوف'; 
                    const itemTotal = item.quantity * (item.price || 0) * (1 - (item.discountPercent || 0) / 100); 
                    const itemCode = product ? product.id : 'N/A'; 
                    // Use totalAmountClass for item total display color as well if it's a return
                    const itemTotalColorClass = isReturn ? 'text-red-700' : 'text-pink-700';

                    return `<tr class="text-xs border-b border-gray-100 last:border-b-0"><td class="text-right px-3 py-2 font-semibold sale-item-name-cell">${itemName}</td><td class="text-center px-3 py-2 sale-item-code-cell">${itemCode}</td><td class="text-center px-3 py-2 sale-item-qty-cell font-bold ${item.quantity < 0 ? 'text-red-600' : 'text-gray-800'}">${item.quantity}</td><td class="text-center px-3 py-2 sale-item-price-cell">${formatCurrency(item.price)}</td><td class="text-center px-3 py-2 font-bold sale-item-total-cell ${itemTotalColorClass}">${formatCurrency(itemTotal)}</td></tr>`; 
                }).join(''); 
                
                const customerRequiresFiling = customer?.requiresTaxFiling; 
                
                // +++ NEW: Get Tax Number HTML +++
                const customerTaxNumber = customer ? (customer.taxNumber || 'لا يوجد') : 'لا يوجد';
                const taxNumberHtml = `<div class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-center w-full">\r\n                           <p class="text-xs text-gray-700 font-semibold">الرقم الضريبي:</p>\r\n                           <p class="text-sm font-bold text-gray-900">${customerTaxNumber}</p>\r\n                           <a href="https://invoicing.eta.gov.eg/" target="_blank" class="text-xs text-blue-600 hover:underline">المنظومة الإلكترونية</a>\r\n\r\n                       </div>`;
                // +++ END NEW +++
                
                const el = document.createElement('div'); 
                
                // Use the calculated background color
                el.className = `${saleBgColor} p-4 rounded-xl border shadow-md mb-6 transition duration-300 hover:shadow-lg`; 
                
                el.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-4">\r\n                    <div class="col-span-3">\r\n                        <p class="font-bold text-lg text-gray-800">\r\n                            ${customer ? customer.name : 'عميل محذوف'} \r\n                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${badgeColor} mr-2">${badgeText}</span>\r\n                            ${customerRequiresFiling ? `<i data-lucide="file-text" class="w-4 h-4 inline text-orange-500 mr-2" title="يتطلب رفع ضريبي"></i>` : ''}\r\n                        </p>\r\n                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500 mt-1">
                            <span><i data-lucide="calendar" class="w-3 h-3 inline ml-1"></i> <bdo dir="rtl">فاتورة بتاريخ: ${formatArabicDate(sale.date)}</bdo></span>
                            <span class="invoice-review-span" data-id="${sale.id}" title="اضغط للتلوين">
                                <i data-lucide="hash" class="w-3 h-3 inline ml-1"></i> رقم الفاتورة: 
                                <span class="invoice-cell text-red-600 font-bold ${reviewState[sale.id] || ''}">
                                    ${sale.invoiceNumber || 'N/A'}
                                </span>
                            </span>
                            <span><i data-lucide="user" class="w-3 h-3 inline ml-1"></i> المندوب: <span class="text-blue-600 font-semibold">${sale.repName || 'غير محدد'}</span></span>
                        </div>\r\n                        <div class="overflow-x-auto mt-4 max-h-48 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">\r\n                            <table class="sale-items-table min-w-full">\r\n                                <thead>\r\n                                    <tr class="text-xs">\r\n                                        <th class="w-2/6 px-3 py-2 text-right">الصنف</th>\r\n                                        <th class="w-1/6 px-3 py-2 text-center">الكود</th>\r\n                                        <th class="w-1/6 text-center px-3 py-2">الكمية</th>\r\n                                        <th class="w-1/6 text-center px-3 py-2">السعر</th>\r\n                                        <th class="w-1/6 text-center px-3 py-2">الإجمالي</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>${itemsList}</tbody>\r\n                            </table>\r\n                        </div>\r\n                        <div class="flex gap-4 mt-3 pt-3 border-t">\r\n                            <button data-id="${sale.id}" class="edit-sale-btn text-sm flex items-center gap-1 text-blue-600 hover:text-blue-800"><i data-lucide="edit" class="w-4 h-4"></i> تعديل</button>\r\n                            <button data-id="${sale.id}" class="delete-sale-btn text-sm flex items-center gap-1 text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i> حذف</button>\r\n                        </div>\r\n                    </div>\r\n                    <div class="col-span-1 border-r pr-4 flex flex-col justify-start items-center text-center pt-2">\r\n                        <h4 class="text-sm font-semibold text-gray-600 mb-1">الإجمالي النهائي</h4>\r\n                        <p class="font-bold text-2xl ${totalAmountClass}">${formatCurrency(sale.total)}</p>\r\n                        <div class="flex flex-col gap-1 items-center mt-3">\r\n                            ${getTaxStatusBadge(sale)}\r\n                            ${getStatusBadge(sale.status)}\r\n                        </div>\r\n                        ${taxNumberHtml} <!-- NEW: Inserted variable here -->\r\n                        ${sale.discount > 0 ? `<div class="mt-2 text-xs text-red-600">خصم: ${sale.discount}%</div>` : ''}\r\n                    </div>\r\n                </div>`; 
                try {
                    const sideCol = el.querySelector('.col-span-1.border-r.pr-4.flex.flex-col.justify-start.items-center.text-center.pt-2');
                    const roleSide = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (sideCol) {
                        const printBtnEl = document.createElement('button');
                        printBtnEl.setAttribute('data-id', sale.id);
                        printBtnEl.className = 'print-sale-btn mb-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        printBtnEl.innerHTML = '<i data-lucide="printer" class="w-4 h-4"></i> طباعة';
                        sideCol.insertBefore(printBtnEl, sideCol.firstChild);

                        const shareBtnEl = document.createElement('button');
                        shareBtnEl.setAttribute('data-id', sale.id);
                        shareBtnEl.className = 'share-sale-image-btn mb-2 bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        shareBtnEl.innerHTML = '<i data-lucide="share-2" class="w-4 h-4"></i> صورة';
                        sideCol.insertBefore(shareBtnEl, sideCol.firstChild.nextSibling); // after print

                        // USB/Direct Print button
                        const usbPrintBtnEl = document.createElement('button');
                        usbPrintBtnEl.setAttribute('data-id', sale.id);
                        usbPrintBtnEl.className = 'usb-print-sale-btn mb-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1';
                        usbPrintBtnEl.innerHTML = '<i data-lucide="printer" class="w-4 h-4"></i> USB';
                        sideCol.insertBefore(usbPrintBtnEl, sideCol.firstChild.nextSibling.nextSibling); // after share

                        // تمت إزالة زر الإرسال للضرائب الخارجي؛ يبقى فقط داخل المودال
                    }
                } catch(e){}
                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (sale && String(sale.reviewStatus||'').toLowerCase() === 'pending') {
                        // Visual highlight
                        try { el.classList.add('ring-2','ring-yellow-300'); } catch(_){ }
                        // Add pending badge inside status area
                        const statusArea = el.querySelector('.flex.flex-col.gap-1.items-center.mt-3');
                        if (statusArea) {
                            const pendingTag = document.createElement('span');
                            pendingTag.className = 'text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full px-2 py-0.5';
                            pendingTag.innerHTML = '<i data-lucide="clock" class="w-3 h-3 inline ml-1"></i> قيد المراجعة';
                            statusArea.appendChild(pendingTag);
                        }
                        // Add approve button for admin/reviewer
                        if (role === 'admin' || role === 'reviewer') {
                            const actions = el.querySelector('.flex.gap-4.mt-3.pt-3.border-t');
                            if (actions) {
                                const approve = document.createElement('button');
                                approve.setAttribute('data-id', sale.id);
                                approve.className = 'review-sale-btn text-sm flex items-center gap-1 text-green-700 hover:text-green-900';
                                approve.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> اعتماد';
                                actions.appendChild(approve);
                            }
                        }
                    }
                    // Tax upload status badge
                    try {
                        const statusArea2 = el.querySelector('.flex.flex-col.gap-1.items-center.mt-3');
                        if (statusArea2 && sale) {
                            if (sale.taxUploadStatus === 'uploaded') {
                                const uploadedTag = document.createElement('span');
                                uploadedTag.className = 'text-xs font-semibold bg-green-100 text-green-800 rounded-full px-2 py-0.5 flex items-center gap-1';
                                uploadedTag.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> رفع ضريبي ناجح';
                                statusArea2.appendChild(uploadedTag);
                            } else if (sale.taxUploadStatus === 'error') {
                                const errorTag = document.createElement('span');
                                errorTag.className = 'text-xs font-semibold bg-red-100 text-red-700 rounded-full px-2 py-0.5 flex items-center gap-1';
                                errorTag.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3"></i> فشل الرفع';
                                statusArea2.appendChild(errorTag);
                            }
                        }
                    } catch(_){ }
                } catch(_){ }
                salesList.appendChild(el); 
            }); 
            updateIcons();
        }

        function renderCustomers(filter = '') {
            const customersList = document.getElementById('customers-list');
            customersList.innerHTML = '';
            const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
            const currentUser = AuthSystem.getCurrentUser();
            const filteredCustomers = (state.customers||[]).filter(c => {
                if (!c || !c.name) return false;
                if (!c.name.toLowerCase().includes(filter.toLowerCase())) return false;
                if (role === 'admin') return true;
                if (role === 'rep' && currentUser) {
                    const assigned = c.assignedRepId || '';
                    // المندوب: عرض عملائه أو غير المُعيّنين، بدون إدارة
                    return !assigned || assigned === currentUser.id;
                }
                return true; // أدوار أخرى
            });
            if (filteredCustomers.length === 0) {
                customersList.innerHTML = '<p class="text-gray-500 text-center mt-8">لا يوجد عملاء. اضغط على زر "إضافة عميل" للبدء.</p>';
                return;
            }
            filteredCustomers.forEach(customer => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm';
                const address = customer.address || '';
                const isLink = address.startsWith('http');
                const priceList = findPriceList(customer.priceListId);
                const repName = customer.repName || 'غير محدد';
                const taxRequired = customer.requiresTaxFiling;
                const cid = customer.id || customer._id || '';
                const assignedRepId = customer.assignedRepId || '';
                const isMine = assignedRepId && currentUser && currentUser.id === assignedRepId;
                const assignedBadge = assignedRepId
                    ? (isMine ? '<span class="text-xs font-semibold bg-green-100 text-green-700 rounded-full px-2 py-0.5">مخصص لك</span>' : '<span class="text-xs bg-gray-100 text-gray-600 rounded-full px-2 py-0.5">مخصص</span>')
                    : '<span class="text-xs bg-yellow-100 text-yellow-700 rounded-full px-2 py-0.5">غير مُعيّن</span>';
                const manageAllowed = (typeof canManageCustomer === 'function') ? canManageCustomer(customer) : true;
                let priceListInfoHTML = `<div class="mt-2"><span class="text-sm text-gray-800 bg-gray-100 rounded-full px-2 py-0.5">بدون قائمة أسعار</span></div>`;
                if (priceList) {
                    const discountMatch = priceList.name.match(/\(خصم (.*?)%\)/);
                    const baseName = discountMatch ? priceList.name.replace(discountMatch[0], '').trim() : priceList.name;
                    let baseTag = `<span class="text-sm text-blue-800 bg-blue-100 rounded-full px-2 py-0.5">${baseName}</span>`;
                    let discountTag = discountMatch ? ` <span class="text-sm text-red-800 bg-red-100 rounded-full px-2 py-0.5">خصم ${discountMatch[1]}%</span>` : '';
                    priceListInfoHTML = `<div class="mt-2 flex flex-wrap gap-1 items-center">${baseTag}${discountTag}</div>`;
                }
                const taxTag = taxRequired ? `<span class="text-xs font-semibold bg-orange-100 text-orange-800 rounded-full px-2 py-0.5 flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> يتطلب رفع ضريبي</span>` : '';
                // المندوب لا يملك صلاحية إدارة العملاء (لا تعيين/لا تعديل/لا حذف)
                const claimBtnHtml = (role === 'rep') ? '' : (!assignedRepId ? `<button data-id="${cid}" class="claim-customer-btn text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">تعيين لي</button>` : '');
                const actionsHtml = (role !== 'rep' && manageAllowed)
                    ? `<div class="flex"><button data-id="${cid}" class="edit-customer-btn p-2 text-gray-500 hover:text-blue-600" title="تعديل"><i data-lucide="edit" class="w-5 h-5"></i></button><button data-id="${cid}" class="delete-customer-btn p-2 text-gray-500 hover:text-red-600" title="حذف"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`
                    : `<div class="flex opacity-50 cursor-not-allowed" title="لا تملك صلاحية تعديل هذا العميل"><button data-id="${cid}" class="p-2 text-gray-400" disabled><i data-lucide="edit" class="w-5 h-5"></i></button><button data-id="${cid}" class="p-2 text-gray-400" disabled><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`;

                el.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-lg">${customer.name} ${taxRequired ? `<i data-lucide=\"file-text\" class=\"w-4 h-4 inline text-orange-500 mr-2\" title=\"يتطلب رفع ضريبي\"></i>` : ''}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="landmark" class="w-3 h-3"></i> الرقم الضريبي: ${customer.taxNumber || 'لا يوجد'}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="phone" class="w-3 h-3"></i> ${customer.phone || 'لا يوجد'}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${isLink ? `<a href="${address}" target="_blank" class="text-blue-600 hover:underline">عرض على الخريطة</a>` : address || 'لا يوجد'}</p><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="user" class="w-3 h-3"></i> المندوب: <span class="font-semibold text-gray-700">${repName}</span> ${assignedBadge}</p>${priceListInfoHTML}</div><div class="flex flex-col items-end gap-2">${taxTag}${claimBtnHtml}${actionsHtml}<button data-id="${cid}" class="ai-followup-btn text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-md flex items-center gap-1 hover:bg-purple-200"><span>✨</span> رسالة متابعة</button></div></div>`;
                customersList.appendChild(el);
            });
            updateIcons();
        }

        // --- ETA TAX INTEGRATION STUBS & HELPERS ---
        const taxConfig = {
            vatStandardRate: 0.14,
            taxCodes: {
                T1: { description: 'Value Added Tax', subTypes: { V009: 'General Item sales', V003: 'Exempted good or service' } },
                T4: { description: 'Withholding Tax', subTypes: { W004: 'Services' } }
            },
            uom: { EA: 'Each', KGM: 'Kilogram', LTR: 'Liter', BOX: 'Box', DZ: 'Dozen', M: 'Meter', H: 'Hour', MIN: 'Minute' }
        };

        // Chain Management (local-only storage)
        const CHAINS_LS_KEY = 'customerChains';
        function loadChains() { try { const raw = localStorage.getItem(CHAINS_LS_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; } catch(e){ return []; } }
        function saveChains(chains){ try{ localStorage.setItem(CHAINS_LS_KEY, JSON.stringify(chains || [])); } catch(e){ console.warn('saveChains failed', e); } }

        function renderChainsDisplay(){
            const chains = loadChains();
            const container = document.getElementById('chains-display');
            if(!container) return;
            if(chains.length === 0) { container.innerHTML = ''; return; }
            
            container.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded p-3"><div class="text-sm font-semibold mb-2">السلاسل المحفوظة:</div><div class="space-y-2"></div></div>';
            const chainList = container.querySelector('.space-y-2');
            chains.forEach(chain => {
                const customerNames = chain.customerIds.map(cid => { const c = findCustomer(cid); return c ? c.name : cid; }).join(', ');
                const badge = document.createElement('div');
                badge.className = 'flex justify-between items-center bg-white p-2 rounded border border-blue-200 text-sm';
                badge.innerHTML = `
                    <div class="cursor-pointer flex-1" data-view-chain-id="${chain.id}"><span class="font-medium text-blue-600 hover:underline">${(chain.name||'').replace(/</g,'&lt;')}</span><br><span class="text-xs text-gray-600">${customerNames || 'بدون عملاء'}</span></div>
                    <div class="flex gap-1">
                        <button data-chain-id="${chain.id}" class="edit-chain-btn px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">تعديل</button>
                        <button data-chain-id="${chain.id}" class="delete-chain-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">حذف</button>
                    </div>
                `;
                chainList.appendChild(badge);
            });
        }

        function openViewChainModal(chainId){
            const chains = loadChains();
            const chain = chains.find(c => c.id === chainId);
            if(!chain) return;
            
            const modal = document.createElement('div');
            modal.id = 'view-chain-modal';
            modal.style.position = 'fixed'; modal.style.left = '0'; modal.style.top = '0'; modal.style.right = '0'; modal.style.bottom = '0'; modal.style.zIndex = '9999';
            
            const customerNames = chain.customerIds.map(cid => { const c = findCustomer(cid); return c ? c.name : cid; });
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black/40" id="view-chain-backdrop"></div>
                <div class="fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded shadow-lg p-4 z-50">
                    <h3 class="font-semibold mb-3">السلسلة: ${(chain.name||'').replace(/</g,'&lt;')}</h3>
                    <div class="mb-4"><label class="block text-sm font-medium mb-2">العملاء في هذه السلسلة:</label><div class="border rounded p-3 bg-gray-50">${customerNames.length > 0 ? customerNames.map(n => `<div class="py-1 text-sm">• ${n}</div>`).join('') : '<div class="text-sm text-gray-500">بدون عملاء</div>'}</div></div>
                    <div class="flex justify-end gap-2"><button id="view-chain-edit-btn" data-chain-id="${chainId}" class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">تعديل</button><button id="view-chain-close-btn" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">إغلاق</button></div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#view-chain-close-btn')?.addEventListener('click', () => modal.remove());
            modal.querySelector('#view-chain-backdrop')?.addEventListener('click', () => modal.remove());
            modal.querySelector('#view-chain-edit-btn')?.addEventListener('click', function(){ 
                modal.remove(); 
                openAddChainModal(chainId); 
            });
        }

        function openAddChainModal(chainId){
            const chains = loadChains();
            const editChain = chainId ? chains.find(c => c.id === chainId) : null;
            const modal = document.createElement('div');
            modal.id = 'add-chain-modal';
            modal.style.position = 'fixed'; modal.style.left = '0'; modal.style.top = '0'; modal.style.right = '0'; modal.style.bottom = '0'; modal.style.zIndex = '9999';
            
            const title = editChain ? 'تعديل السلسلة' : 'إضافة سلسلة جديدة';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black/40" id="add-chain-backdrop"></div>
                <div class="fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded shadow-lg p-4 z-50 max-h-80 overflow-y-auto">
                    <h3 class="font-semibold mb-3">${title}</h3>
                    <div class="mb-3"><label class="block text-sm font-medium mb-1">اسم السلسلة</label><input id="chain-name-input" class="w-full p-2 border rounded" placeholder="اسم السلسلة" value="${editChain ? (editChain.name||'').replace(/"/g,'&quot;') : ''}"></div>
                    <div class="mb-3"><label class="block text-sm font-medium mb-1">العملاء:</label><div id="chain-customers-list" class="max-h-48 overflow-y-auto border rounded p-2 bg-gray-50"></div></div>
                    <div class="flex justify-end gap-2"><button id="chain-cancel-btn" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">إلغاء</button><button id="chain-save-btn" class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">حفظ</button></div>
                </div>
            `;
            document.body.appendChild(modal);

            // populate customers
            const listWrap = modal.querySelector('#chain-customers-list');
            const customers = Array.isArray(state.customers) ? state.customers : [];
            if (customers.length === 0) listWrap.innerHTML = '<div class="text-sm text-gray-500">لا يوجد عملاء</div>';
            else {
                const selected = editChain ? (editChain.customerIds || []) : [];
                listWrap.innerHTML = customers.map(c => `<label class="flex items-center gap-2 p-2 hover:bg-blue-100 rounded"><input type="checkbox" data-cid="${c.id}" ${selected.includes(c.id) ? 'checked' : ''} /> <span class="text-sm">${(c.name||'').replace(/</g,'&lt;')}</span></label>`).join('');
            }

            // handlers
            modal.querySelector('#chain-cancel-btn').addEventListener('click', closeAddChainModal);
            modal.querySelector('#add-chain-backdrop')?.addEventListener('click', closeAddChainModal);
            modal.querySelector('#chain-save-btn').addEventListener('click', function(){
                const name = (modal.querySelector('#chain-name-input').value||'').trim();
                if (!name) { alert('الرجاء إدخال اسم السلسلة'); return; }
                const checked = Array.from(modal.querySelectorAll('input[type=checkbox][data-cid]:checked')).map(cb=>cb.getAttribute('data-cid'));
                const allChains = loadChains();
                if (editChain) {
                    const idx = allChains.findIndex(c => c.id === editChain.id);
                    if(idx >= 0) { allChains[idx].name = name; allChains[idx].customerIds = checked; }
                } else {
                    const id = 'chain-' + Date.now().toString(36);
                    allChains.push({ id, name, customerIds: checked });
                }
                saveChains(allChains);
                closeAddChainModal();
                renderChainsDisplay();
            });
        }
        function closeAddChainModal(){ const m = document.getElementById('add-chain-modal'); if(m) m.remove(); }

        // wire the Add Chain button and edit/delete handlers
        document.addEventListener('click', function(e){
            if (e.target.closest && e.target.closest('#add-chain-btn')) { openAddChainModal(); }
            const viewDiv = e.target.closest('[data-view-chain-id]');
            if(viewDiv) { const chainId = viewDiv.getAttribute('data-view-chain-id'); openViewChainModal(chainId); }
            const editBtn = e.target.closest('.edit-chain-btn');
            if(editBtn) { const chainId = editBtn.getAttribute('data-chain-id'); openAddChainModal(chainId); }
            const delBtn = e.target.closest('.delete-chain-btn');
            if(delBtn) {
                const chainId = delBtn.getAttribute('data-chain-id');
                if(confirm('حذف هذه السلسلة؟')) {
                    let chains = loadChains();
                    chains = chains.filter(c => c.id !== chainId);
                    saveChains(chains);
                    renderChainsDisplay();
                }
            }
        });

        // Render chains on page load
        function initializeChainsDisplay() { renderChainsDisplay(); }

        

        // Stable canonicalization per ITIDA rules (alphabetic field ordering, drop null/empty, recurse)
        function stableCanonical(value) {
            if (value === null || value === undefined) return undefined;
            if (typeof value !== 'object') {
                if (value === '') return undefined; // drop empty strings
                return value; // primitive
            }
            if (Array.isArray(value)) {
                const arr = value.map(v => stableCanonical(v)).filter(v => v !== undefined);
                return arr;
            }
            // Object: sort keys alphabetically
            const keys = Object.keys(value).sort();
            const out = {};
            for (const k of keys) {
                const v = stableCanonical(value[k]);
                if (v !== undefined) out[k] = v;
            }
            return out;
        }

        async function sha256Utf8Canonical(obj) {
            const canonicalObj = stableCanonical(obj);
            const json = JSON.stringify(canonicalObj);
            const enc = new TextEncoder();
            const data = enc.encode(json);
            const hashBuf = await crypto.subtle.digest('SHA-256', data);
            const hashArr = Array.from(new Uint8Array(hashBuf));
            return hashArr.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Discount rule placeholder (requires official clarification): beforeVAT or afterVAT
        let discountRule = 'beforeVAT'; // TODO: confirm officially

        function computeLineTotals(item, vatRate) {
            const qty = Number(item.quantity || 0);
            const unitPrice = Number(item.price || 0);
            const discountPercent = Number(item.discountPercent || 0);
            let base = unitPrice * qty;
            if (discountRule === 'beforeVAT') {
                base = base * (1 - discountPercent/100);
            }
            const taxAmount = base * vatRate;
            const total = base + taxAmount;
            return { base: round2(base), taxAmount: round2(taxAmount), total: round2(total) };
        }

        function round2(n){ return Math.round((n + Number.EPSILON)*100)/100; }

        // Transform internal sale to ETA invoice JSON (unsigned)
        function transformSaleToEtaInvoice(sale) {
                const customer = findCustomer(sale.customerId);
                // NEW: Return Detection and Styling
                const isReturn = sale.total < 0;
                const badgeText = isReturn ? 'مرتجع' : 'فاتورة';
                const badgeColor = isReturn ? 'bg-red-600 text-white' : 'bg-blue-600 text-white';
                const saleBgColor = isReturn ? 'bg-red-50 border-red-200' : `${(index % 2 === 0) ? 'bg-white' : 'bg-gray-50'} border-gray-200`;
                const totalAmountClass = isReturn ? 'text-red-700' : 'text-blue-700';
                const itemsList = sale.items.map((item, itemIndex) => {
                    const product = findProduct(item.productId);
                    // تصحيح اسم المنتج ليظهر دائماً إذا كان موجوداً
                    const itemName = product && product.name ? product.name : (item.productName || 'منتج غير معروف');
                    const itemTotal = item.quantity * (item.price || 0) * (1 - (item.discountPercent || 0) / 100);
                    const itemCode = product ? product.id : 'N/A';
                    // Use totalAmountClass for item total display color as well if it's a return
                    const itemTotalColorClass = isReturn ? 'text-red-700' : 'text-pink-700';

                    return `<tr class="text-xs border-b border-gray-100 last:border-b-0"><td class="text-right px-3 py-2 font-semibold sale-item-name-cell">${itemName}</td><td class="text-center px-3 py-2 sale-item-code-cell">${itemCode}</td><td class="text-center px-3 py-2 sale-item-qty-cell font-bold ${item.quantity < 0 ? 'text-red-600' : 'text-gray-800'}">${item.quantity}</td><td class="text-center px-3 py-2 sale-item-price-cell">${formatCurrency(item.price)}</td><td class="text-center px-3 py-2 font-bold sale-item-total-cell ${itemTotalColorClass}">${formatCurrency(itemTotal)}</td></tr>`;
                }).join('');
                const customerRequiresFiling = customer?.requiresTaxFiling;
                // +++ NEW: Get Tax Number HTML +++
                const customerTaxNumber = customer ? (customer.taxNumber || 'لا يوجد') : 'لا يوجد';
            const invoice = {
                invoiceNumber: sale.invoiceNumber || sale.id,
                issueDateTime: new Date(sale.date).toISOString(),
                currency: 'EGP',
                seller: { name: state.companyName || 'الشركة', taxNumber: state.companyTaxId || '000000000' },
                buyer: { name: customer.name || 'عميل', taxNumber: customer.taxNumber || '', type: 'B2B' },
                totals: {
                    totalLines: lines.length,
                    totalTaxable: round2(lines.reduce((s,l)=> s + l.taxableAmount,0)),
                    totalTax: round2(lines.reduce((s,l)=> s + l.taxAmount,0)),
                    totalAmount: round2(lines.reduce((s,l)=> s + l.totalAmount,0))
                },
                lines: lines,
                signature: null // to be filled later by CADES-BES
            };
            return invoice;
        }

        // Export selected tax invoices to JSON
        function exportTaxInvoicesToJson(sales) {
            const invoices = sales.map(transformSaleToEtaInvoice);
            const blob = new Blob([JSON.stringify(invoices, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'eta_invoices.json'; a.click();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }

        function exportTaxInvoicesToCsv(sales) {
            const invoices = sales.map(transformSaleToEtaInvoice);
            const header = ['invoiceNumber','issueDateTime','buyerName','buyerTaxNumber','lines','totalTaxable','totalTax','totalAmount'];
            const rows = invoices.map(inv => {
                const lineSummary = inv.lines.map(l=> `${l.itemCode}:${l.quantity}x${l.unitPrice}=${l.totalAmount}`).join('|');
                return [inv.invoiceNumber, inv.issueDateTime, inv.buyer.name, inv.buyer.taxNumber, lineSummary, inv.totals.totalTaxable, inv.totals.totalTax, inv.totals.totalAmount];
            });
            const csv = [header.join(','), ...rows.map(r=> r.map(x=> '"'+String(x).replace(/"/g,'""')+'"').join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'eta_invoices.csv'; a.click();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }

        function getCandidateSalesForTaxExport(){
            // Use current state: filter customers requiring tax filing
            return (state.sales||[]).filter(s => {
                const c = findCustomer(s.customerId);
                return c && c.requiresTaxFiling;
            });
        }

        document.addEventListener('click', function(e){
            if (e.target.closest && e.target.closest('#tax-export-json-btn')) {
                const candidates = getCandidateSalesForTaxExport();
                if (!candidates.length) { alert('لا توجد فواتير لعملاء يتطلبون رفع ضريبي حالياً.'); return; }
                exportTaxInvoicesToJson(candidates);
            }
            if (e.target.closest && e.target.closest('#tax-export-csv-btn')) {
                const candidates = getCandidateSalesForTaxExport();
                if (!candidates.length) { alert('لا توجد فواتير لعملاء يتطلبون رفع ضريبي حالياً.'); return; }
                exportTaxInvoicesToCsv(candidates);
            }
        });
        // --- END ETA TAX STUBS ---

        // توافق مع الاستدعاءات القديمة: بعض المواضع تنادي renderCustomerList
        // حافظنا على اسم الدالة الجديدة renderCustomers ونوفّر غلافاً بسيطاً.
        function renderCustomerList(filter = '') {
            try { return renderCustomers(filter); } catch(e){ console.warn('renderCustomerList alias failed', e); }
        }

        function renderReps() {
            const repsList = document.getElementById('reps-list');
            repsList.innerHTML = '';
            if (state.reps.length === 0) {
                repsList.innerHTML = '<p class="text-gray-500 text-center mt-8">لا يوجد مناديب. اضغط على زر "إضافة مندوب" للبدء.</p>';
                return;
            }
            state.reps.forEach(rep => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm';
                el.innerHTML = `<div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">${rep.name}</p>
                        <p class="text-sm text-gray-500 mt-1">السيريال: ${rep.serial || 'لا يوجد'}</p>
                        <p class="text-sm text-blue-600 font-semibold mt-1">التارجت: ${formatCurrency(rep.target)}</p>
                        <p class="text-sm text-red-600 font-semibold mt-1">رقم الفاتورة القادمة: ${rep.nextInvoiceNumber || 'N/A'}</p>
                        <p class="text-sm text-gray-700 mt-1">البريد الإلكتروني: <span class="font-mono text-xs">${rep.email || '-'}</span></p>
                    </div>
                    <div class="flex">
                        <button data-id="${rep.id}" class="edit-rep-btn p-2 text-gray-500 hover:text-blue-600"><i data-lucide="edit" class="w-5 h-5"></i></button>
                        <button data-id="${rep.id}" class="delete-rep-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>`;
                repsList.appendChild(el);
            });
            updateIcons();
        }

        function renderSettings(productFilter = '') {
            // Set sales target input
            const salesTargetInput = document.getElementById('sales-target-input');
            if (salesTargetInput && state.settings) salesTargetInput.value = state.settings.salesTarget || '';
                // ربط زر الحفظ بدالة السحابة
                const saveTargetBtn = document.getElementById('save-target-btn');
                if (saveTargetBtn && salesTargetInput) {
                    saveTargetBtn.onclick = function() {
                        const newTarget = Number(salesTargetInput.value);
                        if (isNaN(newTarget) || newTarget <= 0) {
                            alert('يرجى إدخال هدف شهري صحيح أكبر من صفر');
                            return;
                        }
                        if (typeof window.saveSalesTargetToCloud === 'function') {
                            saveTargetBtn.disabled = true;
                            saveTargetBtn.textContent = '...جارٍ الحفظ';
                            window.saveSalesTargetToCloud(newTarget)
                                .then(() => {
                                    saveTargetBtn.textContent = 'تم الحفظ';
                                    setTimeout(() => {
                                        saveTargetBtn.textContent = 'حفظ';
                                        saveTargetBtn.disabled = false;
                                    }, 1200);
                                })
                                .catch(() => {
                                    saveTargetBtn.textContent = 'حفظ';
                                    saveTargetBtn.disabled = false;
                                    alert('تعذر حفظ الهدف الشهري. تحقق من الاتصال أو الصلاحيات.');
                                });
                        }
                    };
                }
            // set company logo input
            try {
                const logoInput = document.getElementById('company-logo-input');
                if (logoInput) logoInput.value = (state.settings && state.settings.companyLogo) ? state.settings.companyLogo : (window.DEFAULT_COMPANY_LOGO_URL || '');
            } catch (e) {}

            // Active period controls (month selector)
            try {
                const apInput = document.getElementById('active-period-input');
                const apBtn = document.getElementById('active-period-today-btn');
                const apInd = document.getElementById('active-period-indicator');
                const current = __formatPeriod(new Date());
                const active = (window.state && state.activePeriod) ? state.activePeriod : (localStorage.getItem('active_period') || current);
                if (apInput) {
                    apInput.value = active;
                    apInput.onchange = (e) => {
                        const val = (e && e.target && e.target.value) ? String(e.target.value) : current;
                        setActivePeriod(val);
                        // keep indicator in sync immediately
                        if (apInd) apInd.textContent = `الشهر: ${val}`;
                    };
                }
                if (apBtn) {
                    apBtn.onclick = () => {
                        const nowVal = __formatPeriod(new Date());
                        if (apInput) apInput.value = nowVal;
                        setActivePeriod(nowVal);
                        if (apInd) apInd.textContent = `الشهر: ${nowVal}`;
                    };
                }
                if (apInd) {
                    apInd.textContent = `الشهر: ${active}`;
                }
            } catch (e) { console.warn('renderSettings active-period wiring failed', e); }

            // Products list
            const productsList = document.getElementById('products-list');
            if (productsList) {
                productsList.innerHTML = '';
                const filteredProducts = state.products.filter(p => p.name.toLowerCase().includes((productFilter || '').toLowerCase()));
                if (filteredProducts.length === 0) {
                    productsList.innerHTML = '<p class="text-gray-500 text-center text-sm p-4">لا توجد منتجات تطابق بحثك.</p>';
                } else {
                    filteredProducts.forEach(product => {
                        const el = document.createElement('div');
                        el.className = 'bg-white p-2 rounded-md flex justify-between items-center border';
                        el.innerHTML = `
                            <div>
                                <p class="font-semibold">${escapeHtml(product.name)} (<span class="text-xs text-blue-500">${escapeHtml(String(product.id))}</span>)</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">${formatCurrency(product.price)}</span>
                                <button data-id="${product.id}" class="edit-product-btn p-1 text-gray-400 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-id="${product.id}" class="delete-product-btn p-1 text-gray-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        productsList.appendChild(el);
                    });
                }
            }

            // Update the small price-lists container only if it still exists (we moved management to dedicated page)
            const priceListsContainer = document.getElementById('price-lists-container');
            if (priceListsContainer) {
                priceListsContainer.innerHTML = '';
                if (!state.priceLists || state.priceLists.length === 0) {
                    priceListsContainer.innerHTML = '<p class="text-gray-500 text-center text-sm p-4">لم تقم بإضافة قوائم أسعار بعد.</p>';
                } else {
                    state.priceLists.forEach(pl => {
                        const el = document.createElement('div');
                        el.className = 'bg-white p-2 rounded-md flex justify-between items-center border';
                        el.innerHTML = `
                            <p class="font-semibold">${escapeHtml(pl.name)}</p>
                            <div class="flex items-center gap-2">
                                <button data-id="${pl.id}" class="edit-price-list-btn p-1 text-gray-400 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-id="${pl.id}" class="delete-price-list-btn p-1 text-gray-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        priceListsContainer.appendChild(el);
                    });
                }
            }

            updateIcons();

            // GPS controls wiring
            try { if (typeof setupGpsSharingControls === 'function') setupGpsSharingControls(); } catch(e){}
            try { if (typeof renderRepLocations === 'function') renderRepLocations(); } catch(e){}
        }

        function renderPromotions() {
            // New: render promotions as a compact table to match requested layout
            const listEl = document.getElementById('promotions-list');
            if (!listEl) return;
            listEl.innerHTML = '';
            // Keep batch editor controls in sync
            try {
                const custSel = document.getElementById('batch-promo-customer');
                if (custSel) {
                    custSel.innerHTML = '<option value="">جميع العملاء</option>' + (state.customers||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
                }
                const from = document.getElementById('batch-promo-from');
                const to = document.getElementById('batch-promo-to');
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                if (from && !from.value) from.value = todayStr;
                if (to && !to.value) { const d = new Date(); d.setMonth(d.getMonth()+1); to.value = d.toISOString().split('T')[0]; }
            } catch(e){}
            if (!state.promotions || state.promotions.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center mt-8">لا توجد عروض مسجلة حالياً.</p>';
                return;
            }

            // Build table HTML
            const headerStyle = 'background:#000;padding:8px;color:#ffd54f;text-align:center;font-weight:700;border-bottom:3px solid #333;font-size:15px;';
            const cellStyle = 'padding:10px;border-bottom:1px solid rgba(0,0,0,0.05);text-align:center;font-size:15px;';
            const codeCellStyle = cellStyle + 'background:linear-gradient(90deg,#e9e8ff,#cbd7ff);font-weight:700;color:#0b3d91;';
            const rows = state.promotions.map(promo => {
                const product = findProduct(promo.productId);
                const customer = promo.customerId ? findCustomer(promo.customerId) : null;
                const name = product ? product.name : 'منتج محذوف';
                const code = product ? product.id : '';
                const custName = customer ? customer.name : 'لجميع العملاء';
                // show start/end dates (when the promo starts/ends)
                const fromVal = promo.startDate ? formatArabicDate(promo.startDate) : (promo.from ?? promo.minQty ?? '');
                const toVal = promo.endDate ? formatArabicDate(promo.endDate) : (promo.to ?? promo.maxQty ?? '');
                const price = formatNumberEN(promo.price);

                // determine expiry
                const isExpired = promo.endDate ? (new Date() > new Date(promo.endDate)) : false;

                // Column accent colors (consistent and visible)
                const priceAccentBg = 'background:linear-gradient(90deg,#fff8e1,#ffe0b2);color:#7a3f00;font-weight:700;';
                const productAccentBg = 'background:linear-gradient(90deg,#e8f7ff,#dbeefd);color:#0b3d91;font-weight:600;';
                const dateAccentBg = 'background:linear-gradient(90deg,#f0fff4,#e6fff0);color:#065f46;font-weight:600;';
                const customerAccentBg = 'background:linear-gradient(90deg,#fffdf6,#fff3e8);color:#3b3b3b;';

                // For visibility add a thin colored stripe on the left of key cells
                const priceCellStyle = `${cellStyle} ${priceAccentBg} border-left:6px solid #f59e0b;`;
                const productCellStyle = `${cellStyle} ${productAccentBg} border-left:6px solid #2563eb;`;
                const dateCellStyle = `${cellStyle} ${dateAccentBg} border-left:6px solid #10b981;`;
                const customerCellStyle = `${cellStyle} ${customerAccentBg}`;

                // expired badge remains but colors apply regardless so the UI looks consistent
                const expiredBadge = isExpired ? `<div style="margin-top:6px;font-size:12px;color:#7a1f1f;font-weight:800">منتهي</div>` : '';
                const priceHtml = `${price}${expiredBadge} <button data-promo-id="${promo.id}" class="edit-promo-btn" style="margin-left:8px;background:#2563eb;color:white;border:none;padding:4px 6px;border-radius:4px;font-size:12px;cursor:pointer">تعديل</button>`;

                // subtle alternating row backgrounds for readability
                const rowAltBg = promo.__rowAlt ? 'background:linear-gradient(90deg, rgba(255,255,255,0.9) 0%, rgba(250,250,250,0.9) 100%);' : '';
                const rowBackground = rowAltBg || 'background:linear-gradient(90deg, rgba(249,224,190,1) 0%, rgba(245,183,77,0.08) 100%);';

                // Toggle alternate rows for nicer banding (based on index if present)
                // (we can't access index inside map easily here, but we can use a fallback plain background)
                return `
                    <tr style="${rowBackground}">
                        <td style="${priceCellStyle};width:90px;">${priceHtml}</td>
                        <td style="${dateCellStyle};width:120px;">${toVal}</td>
                        <td style="${dateCellStyle};width:120px;">${fromVal}</td>
                        <td style="${productCellStyle};">${escapeHtml(name)}</td>
                        <td style="${codeCellStyle};width:62px;">${escapeHtml(code)}</td>
                        <td style="${customerCellStyle};width:200px;">${escapeHtml(custName)}</td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                <div style="overflow:auto;"> 
                    <table style="width:100%;border-collapse:separate;border-spacing:0 6px;font-family:Arial, Helvetica, sans-serif;">
                        <thead>
                            <tr>
                                <th style="${headerStyle};width:90px;">السعر</th>
                                <th style="${headerStyle};width:120px;">حتى</th>
                                <th style="${headerStyle};width:120px;">من</th>
                                <th style="${headerStyle};">اسم الصنف</th>
                                <th style="${headerStyle};width:62px;">كود</th>
                                <th style="${headerStyle};width:200px;">اسم العميل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;

            listEl.innerHTML = tableHtml;
            updateIcons();

            // Wire edit buttons in promotions table to open the promotion modal
            try {
                listEl.querySelectorAll('.edit-promo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.promoId;
                        if (id) openPromotionModal(id);
                    });
                });
            } catch (e) { console.warn('Failed to wire promotion edit buttons', e); }
        }

        // === Batch Promotions logic ===
        function addBatchPromoRow(prefill) {
            const tbody = document.getElementById('batch-promo-rows');
            if (!tbody) return;
            const tr = document.createElement('tr');
            const rowBg = 'background:linear-gradient(90deg, rgba(249,224,190,1) 0%, rgba(245,183,77,0.08) 100%);';
            const cellBase = 'padding:8px;border-bottom:1px solid rgba(0,0,0,0.05);text-align:center;font-size:14px;';
            tr.innerHTML = `
                <td style="${cellBase};background:linear-gradient(90deg,#fff8e1,#ffe0b2);color:#7a3f00;font-weight:700;${rowBg}"><input type="number" class="bp-price p-1 border rounded w-24 text-center" step="any" placeholder="0"></td>
                <td style="${cellBase};${rowBg}"><input type="date" class="bp-to p-1 border rounded"></td>
                <td style="${cellBase};${rowBg}"><input type="date" class="bp-from p-1 border rounded"></td>
                <td style="${cellBase};background:linear-gradient(90deg,#e8f7ff,#dbeefd);color:#0b3d91;font-weight:600;${rowBg}"><input type="text" class="bp-name p-1 border rounded w-64" placeholder="اسم الصنف" readonly></td>
                <td style="${cellBase};background:linear-gradient(90deg,#e9e8ff,#cbd7ff);font-weight:700;color:#0b3d91;${rowBg}"><input type="text" class="bp-code p-1 border rounded w-20 text-center" placeholder="كود"></td>
                <td style="${cellBase};${rowBg}"><span class="bp-customer-display"></span></td>
                <td style="${cellBase};${rowBg}"><button type="button" class="bp-del px-2 py-1 bg-red-600 text-white rounded">حذف</button></td>`;
            tbody.appendChild(tr);

            const fromInput = tr.querySelector('.bp-from');
            const toInput = tr.querySelector('.bp-to');
            const codeInput = tr.querySelector('.bp-code');
            const nameInput = tr.querySelector('.bp-name');
            const priceInput = tr.querySelector('.bp-price');
            const custDisplay = tr.querySelector('.bp-customer-display');
            const custSel = document.getElementById('batch-promo-customer');
            const fromGlobal = document.getElementById('batch-promo-from');
            const toGlobal = document.getElementById('batch-promo-to');
            if (fromGlobal && !fromInput.value) fromInput.value = fromGlobal.value;
            if (toGlobal && !toInput.value) toInput.value = toGlobal.value;
            if (custSel) custDisplay.textContent = custSel.options[custSel.selectedIndex]?.text || 'جميع العملاء';

            codeInput.addEventListener('change', () => {
                const p = getProductDetailsByCode(codeInput.value);
                if (p) { nameInput.value = p.name; nameInput.classList.remove('text-red-600'); }
                else { nameInput.value = 'كود غير صحيح'; nameInput.classList.add('text-red-600'); }
            });
            document.getElementById('batch-promo-customer')?.addEventListener('change', () => {
                const sel = document.getElementById('batch-promo-customer');
                if (sel) custDisplay.textContent = sel.options[sel.selectedIndex]?.text || 'جميع العملاء';
            });
            tr.querySelector('.bp-del').addEventListener('click', ()=> tr.remove());

            if (prefill) {
                if (prefill.code) { codeInput.value = prefill.code; codeInput.dispatchEvent(new Event('change')); }
                if (prefill.price) priceInput.value = prefill.price;
                if (prefill.from) fromInput.value = prefill.from;
                if (prefill.to) toInput.value = prefill.to;
            }
        }

        async function saveBatchPromotions() {
            const custId = document.getElementById('batch-promo-customer')?.value || null;
            const rows = Array.from(document.querySelectorAll('#batch-promo-rows tr'));
            if (!rows.length) { await customDialog({ message:'أضف صفاً واحداً على الأقل.', title:'تنبيه' }); return; }
            if (!window.db) { console.warn('Firestore غير جاهز'); }

            const batch = window.db ? db.batch() : null;
            const toCreateLocal = [];
            let created = 0;
            for (const tr of rows) {
                const code = tr.querySelector('.bp-code').value.trim();
                const nameOk = !tr.querySelector('.bp-name').classList.contains('text-red-600');
                const price = parseFloat(tr.querySelector('.bp-price').value);
                const from = tr.querySelector('.bp-from').value;
                const to = tr.querySelector('.bp-to').value;
                if (!code || !nameOk || !from || !to || isNaN(price) || price <= 0) continue;
                const prod = getProductDetailsByCode(code);
                if (!prod) continue;
                const data = {
                    id: db && db.collection ? db.collection('promotions').doc().id : (Date.now()+''+Math.random()).slice(0,16),
                    name: `عرض ${prod.name}`,
                    productId: String(prod.id),
                    price: Number(price),
                    customerId: custId || null,
                    startDate: from,
                    endDate: to,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                if (batch) {
                    const ref = db.collection('promotions').doc(data.id);
                    batch.set(ref, data, { merge:false });
                } else {
                    toCreateLocal.push(data);
                }
                created++;
            }
            if (!created) { await customDialog({ message:'لا توجد صفوف صالحة للحفظ.', title:'تنبيه' }); return; }
            try {
                if (batch) await batch.commit();
                else {
                    // Local fallback
                    state.promotions = (state.promotions||[]).concat(toCreateLocal);
                }
                await customDialog({ message:`تم حفظ ${created} عرض`, title:'تم' });
                // Clear grid
                document.getElementById('batch-promo-rows').innerHTML = '';
                renderPromotions();
            } catch (e) {
                console.warn('saveBatchPromotions failed', e);
                await customDialog({ message:'فشل الحفظ. حاول مرة أخرى.', title:'خطأ' });
            }
        }

        function calculateCustomerBalances() { 
            // Build balances map from sales only so we show only customers who have invoices
            // Normalize keys to strings to avoid mismatches between numeric/string ids
            const map = new Map();
            try {
                (state.sales || []).forEach(sale => {
                    const key = String(sale.customerId === undefined || sale.customerId === null ? 'unknown' : sale.customerId);
                    const existing = map.get(key) || { name: (findCustomer(sale.customerId)?.name) || ('عميل ' + key), total: 0, paid: 0, balance: 0 };
                    existing.total = (existing.total || 0) + (sale.total || 0);
                    existing.paid = (existing.paid || 0) + ((typeof sale.paidAmount === 'number') ? sale.paidAmount : ((sale.status === 'paid') ? (sale.total || 0) : 0));
                    map.set(key, existing);
                });

                // compute balance for each entry
                map.forEach((v, k) => { v.balance = (v.total || 0) - (v.paid || 0); });
            } catch (e) {
                console.warn('calculateCustomerBalances error', e);
            }
            return map;
        }
        
        // Notification modal flow for Promotions "اخطار"
        function openNotifyModal(type) {
            const modal = document.getElementById('notify-modal');
            if (!modal) return;
            const title = modal.querySelector('#notify-modal-title');
            const typeInput = modal.querySelector('#notify-type');
            const productSelect = document.getElementById('notify-product');
            const promoSelect = document.getElementById('notify-promo');
            const newItemInput = document.getElementById('notify-new-item-name');
            const messageShort = document.getElementById('notify-short-text');
            const rowsBody = document.getElementById('notify-rows-body');
            const pasteArea = document.getElementById('notify-paste-area');
            const productContainer = document.getElementById('notify-product-container');
            const promoContainer = document.getElementById('notify-promo-container');
            const newItemContainer = document.getElementById('notify-new-item-container');

            // reset UI
            productContainer.style.display = 'none';
            promoContainer.style.display = 'none';
            newItemContainer.style.display = 'none';
            pasteArea.style.display = 'none';
            // clear rows
            rowsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">لا توجد صفوف بعد.</td></tr>';

            // set modal according to type
            if (type === 'prices' || type === 'prices-select') {
                title.textContent = 'اخطار — تغيير سعر';
                typeInput.value = 'prices';
                productContainer.style.display = '';
                productSelect.innerHTML = '<option value="">-- اختر صنف --</option>' + (state.products || []).map(p => `<option value="${p.id}">${escapeHtml(p.name)} (${escapeHtml(String(p.id))})</option>`).join('');
            } else if (type === 'new-item') {
                title.textContent = 'اخطار — صنف جديد';
                typeInput.value = 'new-item';
                newItemContainer.style.display = '';
            } else if (type === 'promotions') {
                title.textContent = 'اخطار — عرض';
                typeInput.value = 'promotions';
                promoContainer.style.display = '';
                promoSelect.innerHTML = '<option value="">-- اختر عرض --</option>' + (state.promotions || []).map(pr => `<option value="${pr.id}">${escapeHtml(pr.name || ('عرض ' + pr.id))}</option>`).join('');
            }

            // show modal
            modal.classList.remove('modal-hidden');
            modal.style.display = 'flex';
            // reset customer & global discount
            const notifyCustomer = document.getElementById('notify-customer');
            const notifyGlobal = document.getElementById('notify-global-discount');
            if (notifyCustomer) notifyCustomer.value = '';
            if (notifyGlobal) notifyGlobal.value = '';
            // populate customer select now (ensure it's filled even if state was loaded late)
            try {
                if (notifyCustomer) {
                    notifyCustomer.innerHTML = '<option value="">-- غير محدد --</option>' + (state.customers || []).map(c => `<option value="${c.id}">${escapeHtml(c.name || c.id)}</option>`).join('');
                }
            } catch (e) { console.warn('populate notify-customer failed', e); }
        }

        function closeNotifyModal() {
            const modal = document.getElementById('notify-modal');
            if (!modal) return;
            modal.classList.add('modal-hidden');
            modal.style.display = 'none';
        }

        function sendNotification(e) {
            e.preventDefault();
            const form = document.getElementById('notify-form');
            const type = document.getElementById('notify-type-select')?.value || document.getElementById('notify-type')?.value || 'prices';
            const title = document.getElementById('notify-title')?.value || '';
            const shortText = document.getElementById('notify-short-text')?.value || '';
            const productId = document.getElementById('notify-product')?.value || null;
            const promoId = document.getElementById('notify-promo')?.value || null;
            const newItemName = document.getElementById('notify-new-item-name')?.value || null;
            const customerId = document.getElementById('notify-customer')?.value || null;
            const globalDiscount = parseFloat(document.getElementById('notify-global-discount')?.value) || 0;

            // gather rows from table
            const rows = [];
            const rowsBody = document.getElementById('notify-rows-body');
            if (rowsBody) {
                Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                    const code = tr.querySelector('.nr-code')?.value || '';
                    if (!code) return; // skip empty rows
                    const name = tr.querySelector('.nr-name')?.value || '';
                    const price = parseFloat(tr.querySelector('.nr-price')?.value) || 0;
                    const discount = parseFloat(tr.querySelector('.nr-discount')?.value) || 0;
                    const priceAfter = parseFloat(tr.querySelector('.nr-price-after')?.value) || Math.round((price * (1 - (discount/100))) * 100)/100;
                    rows.push({ code, name, price, discount, priceAfter });
                });
            }

            state.notifications = state.notifications || [];
            const notif = { id: 'n_' + Date.now(), type, title, shortText, productId, promoId, newItemName, customerId, globalDiscount, rows, date: new Date().toISOString() };
            state.notifications.push(notif);
            // persist notifications so they survive reloads
            try { saveState(); } catch (e) { console.warn('saveState failed after creating notification', e); }
            console.log('Notification created:', notif);
            closeNotifyModal();
            try { renderNotifications(); } catch (e) { console.warn('renderNotifications error', e); }
            alert('تم حفظ الإخطار محلياً. يمكنك عرضه من قسم الأخطار داخل صفحة العروض.');
        }

        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            if (!container) return;
            container.innerHTML = '';
            const list = (state.notifications || []).slice().reverse();
            if (list.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center mt-8">لا توجد اخطارات بعد. استخدم زر "اخطار" لإنشاء واحد.</p>';
                return;
            }
            list.forEach(notif => {
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded-lg border shadow-sm';
                const title = escapeHtml(notif.title || (notif.type || 'اخطار'));
                const short = escapeHtml(notif.shortText || '');
                const rowsHtml = (notif.rows || []).map(r => `<tr><td class="px-2 py-1 text-right">${escapeHtml(r.code)}</td><td class="px-2 py-1">${escapeHtml(r.name)}</td><td class="px-2 py-1 text-center">${formatCurrency(r.price)}</td><td class="px-2 py-1 text-center">${r.discount || 0}%</td><td class="px-2 py-1 text-center">${formatCurrency(r.priceAfter)}</td></tr>`).join('');
                const tableHtml = notif.rows && notif.rows.length > 0 ? `<div class="overflow-x-auto mt-2"><table class="min-w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-2 py-1 text-right">كود</th><th class="px-2 py-1">صنف</th><th class="px-2 py-1 text-center">سعر</th><th class="px-2 py-1 text-center">خصم</th><th class="px-2 py-1 text-center">بعد الخصم</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>` : '';
                el.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="font-semibold">${title}</h4><div class="text-xs text-gray-500">${short}</div></div><div class="text-xs text-gray-500">${new Date(notif.date).toLocaleString()}</div></div>${tableHtml}<div class="flex justify-end gap-2 mt-3"><button data-id="${notif.id}" class="view-notif-btn bg-blue-600 text-white px-3 py-1 rounded-md">عرض</button><button data-id="${notif.id}" class="delete-notif-btn bg-red-100 text-red-600 px-3 py-1 rounded-md">حذف</button></div>`;
                container.appendChild(el);
            });

            // wire view & delete
            container.querySelectorAll('.view-notif-btn').forEach(b => b.addEventListener('click', (e) => {
                const id = b.dataset.id;
                const n = (state.notifications || []).find(x => x.id === id);
                if (!n) return alert('الإخطار غير موجود');
                // open a quick display modal (reuse notify modal in read-only)
                openNotifyModal(n.type);
                // fill fields read-only
                setTimeout(() => {
                    document.getElementById('notify-title').value = n.title || '';
                    document.getElementById('notify-short-text').value = n.shortText || '';
                    // restore customer and global discount if present
                    try { if (document.getElementById('notify-customer')) document.getElementById('notify-customer').value = n.customerId || ''; } catch(e){}
                    try { if (document.getElementById('notify-global-discount')) document.getElementById('notify-global-discount').value = n.globalDiscount || ''; } catch(e){}
                    // fill rows
                    const body = document.getElementById('notify-rows-body'); body.innerHTML = '';
                    (n.rows || []).forEach(r => addRowPreview(r));
                }, 120);
            }));
            container.querySelectorAll('.delete-notif-btn').forEach(b => b.addEventListener('click', (e) => {
                const id = b.dataset.id;
                state.notifications = (state.notifications || []).filter(x => x.id !== id);
                try { saveState(); } catch (e) { console.warn('saveState failed after deleting notification', e); }
                renderNotifications();
            }));
        }

        function addRowPreview(r) {
            const body = document.getElementById('notify-rows-body');
            if (!body) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(r.code||'')}</td><td class="px-2 py-1">${escapeHtml(r.name||'')}</td><td class="px-2 py-1 text-center">${formatCurrency(r.price||0)}</td><td class="px-2 py-1 text-center">${r.discount||0}%</td><td class="px-2 py-1 text-center">${formatCurrency(r.priceAfter||0)}</td><td></td>`;
            body.appendChild(tr);
        }

        // Wire dropdown toggle & options
        document.addEventListener('click', (ev) => {
            const root = document.getElementById('promotions-notify-root');
            if (!root) return;
            const btn = document.getElementById('promotions-notify-btn');
            const menu = document.getElementById('promotions-notify-menu');
            if (!btn || !menu) return;
            if (btn.contains(ev.target)) {
                // toggle
                if (menu.classList.contains('hidden')) menu.classList.remove('hidden'); else menu.classList.add('hidden');
                return;
            }
            // if clicked an option
            if (ev.target && ev.target.classList && ev.target.classList.contains('notify-option')) {
                const t = ev.target.dataset.notifyType;
                menu.classList.add('hidden');
                openNotifyModal(t);
                return;
            }
            // click outside: hide menu
            if (!root.contains(ev.target)) {
                menu.classList.add('hidden');
            }
        });

        // Wire notify form submit
        document.addEventListener('DOMContentLoaded', () => {
            const notifyForm = document.getElementById('notify-form');
            if (notifyForm) notifyForm.addEventListener('submit', sendNotification);
            // Wire UI inside notify modal: add row, paste area, type selector
            const addRowBtn = document.getElementById('notify-add-row-btn');
            const pasteBtn = document.getElementById('notify-paste-btn');
            const pasteArea = document.getElementById('notify-paste-area');
            const rowsBody = document.getElementById('notify-rows-body');
            const typeSelect = document.getElementById('notify-type-select');
            const productContainer = document.getElementById('notify-product-container');
            const promoContainer = document.getElementById('notify-promo-container');
            const newItemContainer = document.getElementById('notify-new-item-container');

            function addNotifyRow(data = {}) {
                if (!rowsBody) return;
                // remove placeholder row
                if (rowsBody.children.length === 1 && rowsBody.children[0].querySelector('td') && rowsBody.children[0].querySelector('td').colSpan == 6) rowsBody.innerHTML = '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-2 py-1"><input class="nr-code w-full p-1 border rounded text-sm" value="${escapeHtml(data.code||'')}"></td>
                    <td class="px-2 py-1"><input class="nr-name w-full p-1 border rounded text-sm" value="${escapeHtml(data.name||'')}"></td>
                    <td class="px-2 py-1 text-center"><input type="number" step="any" class="nr-price w-24 p-1 border rounded text-sm text-center" value="${data.price||''}"></td>
                    <td class="px-2 py-1 text-center"><input type="number" step="any" class="nr-discount w-20 p-1 border rounded text-sm text-center" value="${data.discount||0}"></td>
                    <td class="px-2 py-1 text-center"><input readonly class="nr-price-after w-28 p-1 border rounded text-sm text-center bg-gray-50" value="${data.priceAfter||''}"></td>
                    <td class="px-2 py-1 text-center"><button type="button" class="nr-remove text-red-600 px-2 py-1">حذف</button></td>
                `;
                rowsBody.appendChild(tr);
                // attach handlers
                const priceInput = tr.querySelector('.nr-price');
                const discInput = tr.querySelector('.nr-discount');
                const priceAfterInput = tr.querySelector('.nr-price-after');
                const codeInput = tr.querySelector('.nr-code');
                const nameInput = tr.querySelector('.nr-name');
                function recompute() {
                    const p = parseFloat(priceInput.value) || 0;
                    const d = parseFloat(discInput.value) || 0;
                    const after = Math.round((p * (1 - d/100)) * 100) / 100;
                    priceAfterInput.value = after === 0 ? '' : after;
                }
                priceInput.addEventListener('input', recompute);
                discInput.addEventListener('input', recompute);
                // when code changed, try to lookup product name and price (respect customer selection)
                function resolveCodeLookup() {
                    const code = codeInput.value && codeInput.value.trim();
                    if (!code) return;
                    // try find product by id first, fallback to product list search
                    let prod = findProduct(code) || state.products.find(p => String(p.id) === String(code));
                    if (!prod) {
                        // try search by barcode or code property if exists
                        prod = state.products.find(p => p.code && String(p.code) === String(code));
                    }
                    if (prod) {
                        nameInput.value = prod.name || '';
                        // determine base price for selected customer
                        const customerId = document.getElementById('notify-customer')?.value || null;
                        let basePrice = prod.price || 0;
                        if (customerId) {
                            const customer = findCustomer(customerId);
                            if (customer && customer.priceListId) {
                                const pl = findPriceList(customer.priceListId);
                                if (pl && pl.productPrices && pl.productPrices[prod.id] !== undefined) basePrice = pl.productPrices[prod.id];
                            }
                        }
                        // check active promotions
                        const promoPrice = getActivePromotionPrice(prod.id, customerId);
                        let finalPrice = promoPrice !== null ? promoPrice : basePrice;
                        priceInput.value = parseFloat(finalPrice).toFixed(2);
                        recompute();
                    }
                }
                // attach multiple triggers (change, blur, Enter key, and small-debounced input)
                codeInput.addEventListener('change', resolveCodeLookup);
                codeInput.addEventListener('blur', resolveCodeLookup);
                let codeInputTimer = null;
                codeInput.addEventListener('input', () => { clearTimeout(codeInputTimer); codeInputTimer = setTimeout(resolveCodeLookup, 300); });
                codeInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); resolveCodeLookup(); } });
                const removeBtn = tr.querySelector('.nr-remove');
                removeBtn.addEventListener('click', () => { tr.remove(); if (rowsBody.children.length === 0) rowsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">لا توجد صفوف بعد.</td></tr>'; });
            }

            // helper: parse localized number strings (commas, spaces, etc.) to float
            function parseLocalizedNumber(str) {
                if (str === undefined || str === null) return NaN;
                let s = String(str).trim();
                if (s === '') return NaN;
                // remove thousands separators (commas, spaces)
                s = s.replace(/[,\s\u00A0]/g, '');
                // replace comma decimal with dot if user used comma as decimal and dot not present
                // (already removed commas as thousands separators above), but still handle Arabic decimal comma
                s = s.replace(/،/g, '.');
                // if multiple dots exist, keep last dot as decimal separator
                const parts = s.split('.');
                if (parts.length > 2) {
                    const last = parts.pop();
                    s = parts.join('') + '.' + last;
                }
                const v = parseFloat(s);
                return isNaN(v) ? NaN : v;
            }

            // apply global discount to all rows
            const globalDiscountInput = document.getElementById('notify-global-discount');
            if (globalDiscountInput) {
                globalDiscountInput.addEventListener('input', () => {
                    const v = parseLocalizedNumber(globalDiscountInput.value);
                    Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                        const disc = tr.querySelector('.nr-discount');
                        if (disc) {
                            disc.value = isNaN(v) ? '' : v;
                            // trigger recompute by dispatching input
                            disc.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    });
                });
            }

            // when customer selection changes, re-resolve prices for existing rows
            const notifyCustomerSelect = document.getElementById('notify-customer');
            if (notifyCustomerSelect) {
                // populate options
                notifyCustomerSelect.innerHTML = '<option value="">-- غير محدد --</option>' + (state.customers || []).map(c => `<option value="${c.id}">${escapeHtml(c.name || c.id)}</option>`).join('');
                notifyCustomerSelect.addEventListener('change', () => {
                    const cid = notifyCustomerSelect.value || null;
                    Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                        const code = tr.querySelector('.nr-code')?.value?.trim();
                        const priceInput = tr.querySelector('.nr-price');
                        const nameInput = tr.querySelector('.nr-name');
                        const discInput = tr.querySelector('.nr-discount');
                        const priceAfterInput = tr.querySelector('.nr-price-after');
                        if (!code) return;
                        const prod = findProduct(code) || state.products.find(p => String(p.id) === String(code) || (p.code && String(p.code) === String(code)));
                        if (prod) {
                            nameInput.value = prod.name || '';
                            let basePrice = prod.price || 0;
                            if (cid) {
                                const customer = findCustomer(cid);
                                if (customer && customer.priceListId) {
                                    const pl = findPriceList(customer.priceListId);
                                    if (pl && pl.productPrices && pl.productPrices[prod.id] !== undefined) basePrice = pl.productPrices[prod.id];
                                }
                            }
                            const promoPrice = getActivePromotionPrice(prod.id, cid);
                            const finalPrice = promoPrice !== null ? promoPrice : basePrice;
                            priceInput.value = parseFloat(finalPrice).toFixed(2);
                            // re-apply global discount if exists
                            const g = parseLocalizedNumber(globalDiscountInput?.value || '');
                            if (!isNaN(g) && g !== '') discInput.value = g;
                            // recompute
                            const p = parseFloat(priceInput.value) || 0;
                            const d = parseFloat(discInput.value) || 0;
                            priceAfterInput.value = Math.round((p * (1 - d/100)) * 100) / 100 || '';
                        }
                    });
                });
            }

            if (addRowBtn) addRowBtn.addEventListener('click', () => addNotifyRow({price: '', discount: 0}));
            if (pasteBtn && pasteArea) {
                pasteBtn.addEventListener('click', () => { pasteArea.style.display = pasteArea.style.display === 'none' ? '' : 'none'; });
                pasteArea.addEventListener('paste', (ev) => {
                    ev.preventDefault();
                    const text = (ev.clipboardData || window.clipboardData).getData('text');
                    pasteArea.value = text;
                    // parse lines
                    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                    lines.forEach(line => {
                        // split by tab first, fallback to multiple spaces or comma
                        const cols = line.split(/\t|\s{2,}|,/).map(c => c.trim()).filter(c => c !== '');
                        // assume first column is code, second maybe name, third price, fourth discount
                        const code = cols[0] || '';
                        const name = cols[1] || '';
                        const priceRaw = cols[2] || '';
                        const discRaw = cols[3] || cols[2] || '';
                        const price = parseLocalizedNumber(priceRaw) || 0;
                        const discount = parseLocalizedNumber(discRaw) || 0;
                        const priceAfter = Math.round((price * (1 - discount/100)) * 100) / 100;
                        addNotifyRow({ code, name, price: price === 0 ? '' : price, discount: discount === 0 ? 0 : discount, priceAfter });
                        // after adding row, try to auto-resolve product and per-customer price
                        setTimeout(() => {
                            const last = rowsBody.lastElementChild;
                            if (!last) return;
                            const codeVal = last.querySelector('.nr-code')?.value?.trim();
                            if (codeVal) {
                                const prod = findProduct(codeVal) || state.products.find(p => String(p.id) === String(codeVal) || (p.code && String(p.code) === String(codeVal)));
                                if (prod) {
                                    const nameEl = last.querySelector('.nr-name');
                                    if (nameEl && (!nameEl.value || nameEl.value.trim() === '')) nameEl.value = prod.name || '';
                                    const customerId = document.getElementById('notify-customer')?.value || null;
                                    let basePrice = prod.price || 0;
                                    if (customerId) {
                                        const customer = findCustomer(customerId);
                                        if (customer && customer.priceListId) {
                                            const pl = findPriceList(customer.priceListId);
                                            if (pl && pl.productPrices && pl.productPrices[prod.id] !== undefined) basePrice = pl.productPrices[prod.id];
                                        }
                                    }
                                    const promoPrice = getActivePromotionPrice(prod.id, customerId);
                                    const finalPrice = promoPrice !== null ? promoPrice : basePrice;
                                    const priceEl = last.querySelector('.nr-price');
                                    if (priceEl && (!priceEl.value || parseLocalizedNumber(priceEl.value) === 0)) priceEl.value = parseFloat(finalPrice).toFixed(2);
                                    const discEl = last.querySelector('.nr-discount');
                                    const p = parseFloat((priceEl.value && priceEl.value.trim()) ? parseLocalizedNumber(priceEl.value) : finalPrice) || 0;
                                    const d = parseFloat(discEl?.value) || 0;
                                    const afterEl = last.querySelector('.nr-price-after');
                                    if (afterEl) afterEl.value = Math.round((p * (1 - d/100)) * 100) / 100 || '';
                                }
                            }
                        }, 50);
                    });
                });
            }

            if (typeSelect) {
                typeSelect.addEventListener('change', () => {
                    const v = typeSelect.value;
                    productContainer.style.display = v === 'prices' ? '' : 'none';
                    promoContainer.style.display = v === 'promotions' ? '' : 'none';
                    newItemContainer.style.display = v === 'new-item' ? '' : 'none';
                });
            }

            // Render notifications list when the page loads
            renderNotifications();
            // Wire promotions/notifications toggle
            const promosBtn = document.getElementById('promotions-view-btn');
            const notifsBtn = document.getElementById('notifications-view-btn');
            const promosList = document.getElementById('promotions-list');
            const notifsList = document.getElementById('notifications-list');
                if (promosBtn && notifsBtn && promosList && notifsList) {
                    promosBtn.addEventListener('click', () => {
                        promosList.classList.remove('hidden');
                        notifsList.classList.add('hidden');
                        // active = promos
                        promosBtn.classList.add('bg-blue-600','text-white');
                        promosBtn.classList.remove('bg-white','text-gray-700','border');
                        // deactivate notifs
                        notifsBtn.classList.remove('bg-blue-600','text-white');
                        notifsBtn.classList.add('bg-white','text-gray-700','border');
                    });
                    notifsBtn.addEventListener('click', () => {
                        notifsList.classList.remove('hidden');
                        promosList.classList.add('hidden');
                        // active = notifs
                        notifsBtn.classList.add('bg-blue-600','text-white');
                        notifsBtn.classList.remove('bg-white','text-gray-700','border');
                        // deactivate promos
                        promosBtn.classList.remove('bg-blue-600','text-white');
                        promosBtn.classList.add('bg-white','text-gray-700','border');
                    });
                }
            // Wire saving company logo button
            const saveLogoBtn = document.getElementById('save-company-logo-btn');
            if (saveLogoBtn) {
                saveLogoBtn.addEventListener('click', () => {
                    const val = (document.getElementById('company-logo-input') || {}).value || '';
                    state.settings = state.settings || {};
                    state.settings.companyLogo = val.trim();
                    saveState();
                    renderCompanyLogo();
                    try { applyWatermark(state.settings.companyLogo || ''); } catch(e) { console.warn('applyWatermark failed on save', e); }
                    alert('تم حفظ رابط الشعار. سيظهر على صفحات التطبيق والتقارير إذا كان الرابط صحيحًا.');
                });
            }
            // Auto-save logo when user pastes/changes the input (so they don't have to press save each time)
            const logoInput = document.getElementById('company-logo-input');
            if (logoInput) {
                const saveLogoFromInput = () => {
                    const val = (logoInput.value || '').trim();
                    state.settings = state.settings || {};
                    state.settings.companyLogo = val;
                    try { saveState(); } catch(e) { console.warn('saveState failed while auto-saving logo', e); }
                    try { renderCompanyLogo(); } catch(e) {}
                    try { applyWatermark(val || ''); } catch(e) { console.warn('applyWatermark failed while auto-saving logo', e); }
                };
                logoInput.addEventListener('change', saveLogoFromInput);
                logoInput.addEventListener('blur', saveLogoFromInput);
            }
            // render company logo initially
            try { renderCompanyLogo(); } catch(e) {}
            // WhatsApp share button: build message from current modal fields and open wa.me
            const shareBtn = document.getElementById('notify-share-wa-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    // build message from modal
                    const type = document.getElementById('notify-type-select')?.value || document.getElementById('notify-type')?.value || 'prices';
                    const title = document.getElementById('notify-title')?.value || '';
                    const shortText = document.getElementById('notify-short-text')?.value || '';
                    const logoUrl = document.getElementById('notify-logo-url')?.value || '';
                    const customerId = document.getElementById('notify-customer')?.value || '';
                    const customerName = customerId ? (findCustomer(customerId)?.name || customerId) : '';
                    const rows = [];
                    const rowsBody = document.getElementById('notify-rows-body');
                    if (rowsBody) {
                        Array.from(rowsBody.querySelectorAll('tr')).forEach(tr => {
                            const code = tr.querySelector('.nr-code')?.value || '';
                            if (!code) return;
                            const name = tr.querySelector('.nr-name')?.value || '';
                            const price = tr.querySelector('.nr-price')?.value || '';
                            const discount = tr.querySelector('.nr-discount')?.value || '';
                            const after = tr.querySelector('.nr-price-after')?.value || '';
                            rows.push({ code, name, price, discount, after });
                        });
                    }
                    if ((rows || []).length === 0) return alert('لا توجد صفوف للمشاركة. أضف أصنافاً أولاً.');
                    // header by type
                    let header = 'شركة ديلينت لمنتجات الالبان تقدم لسيادتكم '; 
                    if (type === 'prices') header += 'اسعار الاصناف التالية:'; else if (type === 'promotions') header += 'اسعار العروض التالية:'; else if (type === 'new-item') header = 'شركة ديلينت لمنتجات الالبان — اعلان صنف جديد:';
                    let msg = header + '\n';
                    if (customerName) msg += 'العميل: ' + customerName + '\n';
                    if (title) msg += 'عنوان: ' + title + '\n';
                    if (shortText) msg += shortText + '\n';
                    msg += '\n';
                    // rows
                    rows.forEach(r => {
                        // format each row compactly
                        const parts = [];
                        if (r.code) parts.push('كود: ' + r.code);
                        if (r.name) parts.push('صنف: ' + r.name);
                        if (r.price) parts.push('سعر: ' + r.price);
                        if (r.discount) parts.push('خصم: ' + r.discount + '%');
                        if (r.after) parts.push('بعد: ' + r.after);
                        msg += parts.join(' | ') + '\n';
                    });
                    if (logoUrl) msg += '\n' + 'شعار الشركة: ' + logoUrl + '\n';
                    msg += '\n' + '-- من فريق ديلينت';
                    const waUrl = 'https://wa.me/?text=' + encodeURIComponent(msg);
                    window.open(waUrl, '_blank');
                });
            }
        });

    function renderDebts() {
            // Initialize variables
            const customerFilterText = (document.getElementById('debt-customer-filter') || {}).value || '';
            const repFilter = (document.getElementById('debt-rep-filter') || {}).value || '';
            const startDateVal = (document.getElementById('debt-start-date') || {}).value || '';
            const endDateVal = (document.getElementById('debt-end-date') || {}).value || '';

            // Populate rep dropdown
            const repSelect = document.getElementById('debt-rep-filter');
            if (repSelect) {
                repSelect.innerHTML = '<option value="">جميع المناديب</option>';
                [...new Set(state.sales.map(s => s.repName))].filter(name => name).sort().forEach(name => {
                    repSelect.innerHTML += `<option value="${name}" ${name === repFilter ? 'selected' : ''}>${name}</option>`;
                });
            }

            // Populate customer dropdown with only customers that have at least one invoice (paid or due)
            try {
                const custSelect = document.getElementById('debt-customer-filter');
                if (custSelect) {
                    const customerIds = Array.from(new Set((state.sales || []).map(s => s.customerId).filter(id => id !== undefined && id !== null)));
                    // Build options preserving previous selection if any
                    const prevValue = (custSelect.value || '');
                    let options = '<option value="">جميع العملاء</option>';
                    customerIds.sort((a,b) => {
                        const aName = (findCustomer(a) && findCustomer(a).name) ? findCustomer(a).name.toLowerCase() : String(a);
                        const bName = (findCustomer(b) && findCustomer(b).name) ? findCustomer(b).name.toLowerCase() : String(b);
                        return aName.localeCompare(bName);
                    }).forEach(id => {
                        const name = (findCustomer(id) && findCustomer(id).name) ? findCustomer(id).name : ('عميل ' + id);
                        options += `<option value="${id}" ${String(id) === String(prevValue) ? 'selected' : ''}>${name}</option>`;
                    });
                    custSelect.innerHTML = options;
                }
            } catch (e) { console.warn('Failed to populate debt customer select', e); }

            // If no filters provided -> show aggregated debts per customer
            const noFilters = !customerFilterText && !repFilter && !startDateVal && !endDateVal;

            // Small debug output: print counts and show on-screen banner to help diagnose invisible/missing data
            try {
                const debugEl = document.getElementById('debts-debug');
                console.log('renderDebts called', { sales: (state.sales || []).length, customers: (state.customers || []).length, noFilters });
                if (debugEl) {
                    debugEl.style.display = 'block';
                    try {
                        const salesPreview = (state.sales || []).slice(0,5).map(s => ({ invoice: s.invoiceNumber || s.id, date: s.date ? s.date.split('T')[0] : '', total: s.total || 0 }));
                        const customersPreview = (state.customers || []).slice(0,5).map(c => ({ id: c.id, name: c.name }));
                        const lines = [
                            `السجلات: ${(state.sales || []).length} مبيعات، ${(state.customers || []).length} عملاء`,
                            `عرض ملخص: ${noFilters ? 'نعم' : 'لا'}`,
                            `أمثلة مبيعات: ${salesPreview.map(s => `${s.invoice}:${s.total}`).join(' | ') || 'لا توجد'}`,
                            `أمثلة عملاء: ${customersPreview.map(c => c.name).join(' | ') || 'لا يوجد'}`
                        ];
                        debugEl.textContent = lines.join(' — ');
                    } catch (e) {
                        debugEl.textContent = `السجلات: ${(state.sales || []).length} مبيعات، ${(state.customers || []).length} عملاء — عرض ملخص: ${noFilters ? 'نعم' : 'لا'}`;
                    }
                }
            } catch (e) { console.warn('Debts debug banner update failed', e); }

            const tbody = document.getElementById('debts-detail-body');
            const emptyMessage = document.getElementById('debts-empty-message');
            if (!tbody) return;
            // Initialize table with empty content and proper styles
            tbody.innerHTML = '';
            const dataCellStyle = 'padding:8px;border:1px solid #ddd;background:white;color:black;font-size:14px;text-align:center;';
            const rightCellStyle = dataCellStyle + 'text-align:right;';
            const centerCellStyle = dataCellStyle + 'text-align:center;';
            const moneyStyle = dataCellStyle + 'font-weight:bold;color:#1d4f91;';

            // Force table styling
            try {
                const table = document.getElementById('debts-detail-table');
                if (table) {
                    table.style.cssText = 'width:100% !important;border-collapse:collapse !important;font-family:Arial,sans-serif !important;direction:rtl !important;';
                }
            } catch (e) {}

            // If no filters provided -> show invoice-level rows (all invoices)
            let filteredSales = [];
            if (noFilters) {
                filteredSales = (state.sales || []).slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            } 

            // Otherwise, apply filters and show invoice-level rows
            const startDate = startDateVal ? new Date(startDateVal + 'T00:00:00') : null;
            const endDate = endDateVal ? new Date(endDateVal + 'T23:59:59') : null;

            if (!filteredSales.length) {
                filteredSales = state.sales.filter(sale => {
                const saleDate = sale.date ? new Date(sale.date) : null;
                if (startDate && saleDate && saleDate < startDate) return false;
                if (endDate && saleDate && saleDate > endDate) return false;
                if (customerFilterText) {
                    // If the filter control is a select we expect an id value -> match by id
                    const custControl = document.getElementById('debt-customer-filter');
                    if (custControl && custControl.tagName === 'SELECT') {
                        if (String(sale.customerId) !== String(customerFilterText)) return false;
                    } else {
                        const custName = (findCustomer(sale.customerId)?.name || '').toLowerCase();
                        if (!custName.includes(customerFilterText.toLowerCase())) return false;
                    }
                }
                if (repFilter) {
                    if (!sale.repName || sale.repName.toLowerCase() !== repFilter.toLowerCase()) return false;
                }
                return true;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
            }

            // Apply column sort state (Excel-style) before computing stats
            try {
                if (window.debtsSortState && window.debtsSortState.column && window.debtsSortState.direction) {
                    const { column, direction } = window.debtsSortState;
                    const dir = direction === 'desc' ? -1 : 1;
                    const getValue = (sale) => {
                        if (column === 'customer') return (findCustomer(sale.customerId)?.name || '').toLowerCase();
                        if (column === 'rep') return (sale.repName || '').toLowerCase();
                        if (column === 'date') return sale.date ? sale.date.split('T')[0] : '';
                        if (column === 'invoice') return String(sale.invoiceNumber || '');
                        if (column === 'total') return Number(sale.total || 0);
                        if (column === 'paid') return Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0));
                        if (column === 'remaining') return Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)));
                        return '';
                    };
                    filteredSales.sort((a,b)=>{
                        const va = getValue(a);
                        const vb = getValue(b);
                        // Numeric compare if both numbers
                        if (typeof va === 'number' && typeof vb === 'number') {
                            return (va - vb) * dir;
                        }
                        return String(va).localeCompare(String(vb), 'ar') * dir;
                    });
                }
            } catch(e){ console.warn('debts sort failed', e); }

            // Compute stats
            const subtotal = filteredSales.reduce((s, r) => s + (r.total || 0), 0);
            const paidSum = filteredSales.reduce((s, r) => s + (r.paidAmount || (r.status === 'paid' ? (r.total || 0) : 0)), 0);
            const invoicesCount = filteredSales.length;
            const debtsTotal = filteredSales.reduce((s, r) => s + ((r.total || 0) - (r.paidAmount || (r.status === 'paid' ? (r.total || 0) : 0))), 0);

            // Preserve original rendered sales for column filters if any active
            // Support both the old `_columnFilterState` (legacy) and the new `debtsColumnFilters` state.
            const hasActiveColumnFilters = (
                (window.debtsColumnFilters && Object.keys(window.debtsColumnFilters).some(c => window.debtsColumnFilters[c] && window.debtsColumnFilters[c].length > 0)) ||
                (window._columnFilterState && Object.keys(window._columnFilterState).some(c => window._columnFilterState[c] && window._columnFilterState[c].length > 0))
            );
            if (hasActiveColumnFilters) {
                try { window._debtsFiltersOriginalRenderedSales = Array.isArray(filteredSales) ? filteredSales.slice() : filteredSales; } catch (e) { window._debtsFiltersOriginalRenderedSales = filteredSales; }
            } else {
                window._debtsFiltersOriginalRenderedSales = null;
            }
            // Save last rendered for CSV/print
            window._lastRenderedDebtsSales = filteredSales;
            window._lastRenderedDebtsStats = { subtotal, paid: paidSum, count: invoicesCount, debts: debtsTotal };

            // Update summary boxes with formatted numbers (without currency symbol)
            const subtotalEl2 = document.getElementById('debts-subtotal');
            const paidEl2 = document.getElementById('debts-paid');
            const countEl2 = document.getElementById('debts-invoices-count');
            const debtsEl2 = document.getElementById('debts-total-debt');
            
            // Format numbers without currency symbol, just the number with commas
            const formatBoxNumber = (num) => Math.abs(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            if (subtotalEl2) subtotalEl2.textContent = formatBoxNumber(subtotal);
            if (paidEl2) paidEl2.textContent = formatBoxNumber(paidSum);
            if (countEl2) countEl2.textContent = formatBoxNumber(invoicesCount);
            if (debtsEl2) debtsEl2.textContent = formatBoxNumber(debtsTotal);

            if (invoicesCount === 0) {
                if (emptyMessage) emptyMessage.classList.remove('hidden');
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">لا توجد فواتير مطابقة للفلاتر.</td></tr>`;
                return;
            } else {
                if (emptyMessage) emptyMessage.classList.add('hidden');
            }

            // Render invoice-level rows; use inline styles to be robust against external CSS
            filteredSales.forEach((sale, idx) => {
                const tr = document.createElement('tr');
                try { tr.style.display = 'table-row'; tr.style.visibility = 'visible'; tr.style.opacity = '1'; } catch (e) {}
                const custName = findCustomer(sale.customerId)?.name || 'عميل محذوف';
                const dateText = sale.date ? formatArabicDate(sale.date) : '';
                const invoiceNum = sale.invoiceNumber || '';
                const total = formatCurrency(sale.total || 0);
                const paid = formatCurrency(sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0));
                const remaining = formatCurrency((sale.total || 0) - (sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0)));
                const rep = sale.repName || '';
                // Format numbers without currency symbol for table cells
                const formatTableNumber = (num) => Math.abs(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                const formattedTotal = formatTableNumber(sale.total || 0);
                const formattedPaid = formatTableNumber(sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0));
                const formattedRemaining = formatTableNumber((sale.total || 0) - (sale.paidAmount || (sale.status === 'paid' ? (sale.total || 0) : 0)));
                
                const html = `
                    <td style="${rightCellStyle}" class="customer-name">${custName}</td>
                    <td style="${centerCellStyle}" class="date">${dateText}</td>
                    <td style="${centerCellStyle}" class="invoice-number">${invoiceNum}</td>
                    <td style="${moneyStyle}" class="total">${formattedTotal}</td>
                    <td style="${moneyStyle}" class="paid">${formattedPaid}</td>
                    <td style="${moneyStyle}" class="remaining">${formattedRemaining}</td>
                    <td style="${centerCellStyle}" class="rep-name">${rep}</td>
                `;
                tr.innerHTML = html;
                // tag row with sale id for robust mapping
                try {
                    if (sale && (sale.id !== undefined && sale.id !== null)) tr.dataset.saleId = String(sale.id);
                    else if (sale && sale.invoiceNumber) tr.dataset.saleId = String(sale.invoiceNumber);
                    // add raw data attributes for robust filtering
                    if (sale) {
                        try { if (sale.customerId !== undefined && sale.customerId !== null) tr.dataset.customerId = String(sale.customerId); } catch(e){}
                        try { tr.dataset.date = sale.date ? sale.date.split('T')[0] : ''; } catch(e){}
                        try { tr.dataset.invoice = sale.invoiceNumber ? String(sale.invoiceNumber) : ''; } catch(e){}
                        try { tr.dataset.total = String(Number(sale.total || 0)); } catch(e){}
                        try { const paidRaw = Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)); tr.dataset.paid = String(paidRaw); } catch(e){}
                        try { const rem = Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))); tr.dataset.remaining = String(rem); } catch(e){}
                        try { tr.dataset.rep = sale.repName ? String(sale.repName) : ''; } catch(e){}
                    }
                } catch(e){}
                // add alternating classes for gold styling
                // Add visual indicators for balances - using black color now to match screenshot
                const remainingCell = tr.querySelector('.remaining');
                if (remainingCell) {
                    const remainingValue = parseFloat(formattedRemaining.replace(/,/g, ''));
                    remainingCell.style.color = 'black'; // All numbers in black to match screenshot
                }
                tbody.appendChild(tr);
            });

                updateIcons();

            // Re-apply column filters if present (keeps filters working after other filter interactions)
            try {
                if (typeof window.applyDebtsColumnFilters === 'function') {
                    window.applyDebtsColumnFilters();
                }
            } catch (e) { /* ignore */ }
        }
        
        function calculateRepBalances() { 
            const repBalances = new Map(); state.reps.forEach(rep => { repBalances.set(rep.name, { totalSales: 0, totalCollected: 0, balance: 0, repId: rep.id }); }); state.sales.forEach(sale => { const repEntry = repBalances.get(sale.repName); if (repEntry) { repEntry.totalSales += (sale.total || 0); repEntry.totalCollected += (typeof sale.paidAmount === 'number' ? sale.paidAmount : (sale.status === 'paid' ? sale.total : 0)) || 0; } }); repBalances.forEach(entry => { entry.balance = entry.totalSales - entry.totalCollected; }); 
            return repBalances; 
        }

        // --- Debts Column Filters (Excel-style) ---
        (function(){
            const debtsColumnFilters = {};
            let debtsSortState = { column: null, direction: null }; // 'asc' | 'desc'

            function normalizeRaw(v){ return (v === null || typeof v === 'undefined') ? '' : String(v).trim(); }

            function populateMenuList(menu, col){
                const listEl = menu.querySelector('.filter-list');
                listEl.innerHTML = '';
                const rows = window._lastRenderedDebtsSales || [];
                const map = new Map();
                rows.forEach(sale => {
                    let raw = ''; let disp = '';
                    if (col === 'customer') { raw = normalizeRaw(sale.customerId); disp = findCustomer(sale.customerId)?.name || raw; }
                    else if (col === 'date') { raw = sale.date ? sale.date.split('T')[0] : ''; disp = sale.date ? formatArabicDate(sale.date) : ''; }
                    else if (col === 'invoice') { raw = normalizeRaw(sale.invoiceNumber); disp = raw; }
                    else if (col === 'total') { const v = Number(sale.total || 0); raw = normalizeRaw(v); disp = Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'paid') { const v = Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)); raw = normalizeRaw(v); disp = Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'remaining') { const v = Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))); raw = normalizeRaw(v); disp = Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'rep') { raw = normalizeRaw(sale.repName); disp = raw; }
                    if (!map.has(raw)) map.set(raw, disp);
                });
                const items = Array.from(map.entries()).sort((a,b)=> String(a[1]).localeCompare(String(b[1]), 'ar'));
                items.forEach(([raw, disp]) => {
                    const id = 'cf-debts-' + col + '-' + Math.random().toString(36).slice(2,8);
                    const label = document.createElement('label');
                    label.style.display = 'block'; label.style.padding = '4px 2px';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = raw; cb.id = id;
                    if (Array.isArray(debtsColumnFilters[col]) && debtsColumnFilters[col].includes(raw)) cb.checked = true;
                    const txt = document.createTextNode(' ' + String(disp));
                    label.appendChild(cb); label.appendChild(txt);
                    listEl.appendChild(label);
                });
            }

            function syncSelectAll(menu, col){
                const selectAll = menu.querySelector('.select-all-checkbox');
                if (!selectAll) return;
                const boxes = Array.from(menu.querySelectorAll('.filter-list input[type="checkbox"]'));
                const active = debtsColumnFilters[col];
                if (!active || active.length === 0 || active.length === boxes.length) {
                    selectAll.checked = true; boxes.forEach(b => b.checked = true);
                } else {
                    boxes.forEach(b => b.checked = active.includes(b.value));
                    selectAll.checked = active.length === boxes.length;
                }
            }

            function buildMenu(col){
                const btn = document.querySelector(`.column-filter-btn[data-col="${col}"]`);
                if (!btn) return null;
                if (btn._menu) { populateMenuList(btn._menu, col); syncSelectAll(btn._menu, col); return btn._menu; }

                const menu = document.createElement('div');
                menu.className = 'column-filter-menu debts-filter-menu';
                menu.style.display = 'none';
                menu.style.zIndex = '99999';
                menu.style.minWidth = '220px';
                menu.style.paddingTop = '6px';
                menu.innerHTML = `
                    <div style="display:flex;gap:6px;justify-content:space-between;padding:0 8px 6px;">
                        <button type="button" class="sort-asc" style="flex:1;background:#f8fafc;border:1px solid #d1d5db;border-radius:4px;padding:4px 6px;font-size:11px;cursor:pointer;">ترتيب تصاعدي ↑</button>
                        <button type="button" class="sort-desc" style="flex:1;background:#f8fafc;border:1px solid #d1d5db;border-radius:4px;padding:4px 6px;font-size:11px;cursor:pointer;">ترتيب تنازلي ↓</button>
                    </div>
                    <label class="select-all-label" style="display:block;padding:4px 8px;border-top:1px solid #e2e8f0;margin-top:2px;font-size:12px;font-weight:600;">
                        <input type="checkbox" class="select-all-checkbox" checked style="transform:scale(1.1);margin-left:6px;" /> (تحديد الكل)
                    </label>
                    <input class="filter-search" placeholder="بحث..." style="margin:4px 8px;padding:4px 6px;width:calc(100% - 16px);border:1px solid #cbd5e1;border-radius:4px;font-size:12px;" />
                    <div class="filter-list" style="max-height:200px;overflow:auto;padding:4px 8px;"></div>
                    <div class="filter-actions" style="display:flex;gap:6px;padding:8px 8px 6px;border-top:1px solid #e2e8f0;margin-top:4px;">
                        <button class="ok-btn" style="flex:1;background:#2563eb;color:white;border:none;border-radius:4px;padding:6px 4px;font-size:12px;cursor:pointer;font-weight:600;">موافق</button>
                        <button class="cancel-btn" style="flex:1;background:#64748b;color:white;border:none;border-radius:4px;padding:6px 4px;font-size:12px;cursor:pointer;">إلغاء</button>
                        <button class="clear-btn" style="flex:1;background:#dc2626;color:white;border:none;border-radius:4px;padding:6px 4px;font-size:12px;cursor:pointer;">مسح</button>
                    </div>
                `;
                document.body.appendChild(menu);

                // Search filter
                menu.querySelector('.filter-search').addEventListener('input', (e)=>{
                    const q = (e.target.value || '').trim().toLowerCase();
                    menu.querySelectorAll('.filter-list label').forEach(lbl=>{
                        lbl.style.display = (lbl.textContent||'').toLowerCase().includes(q) ? '' : 'none';
                    });
                });

                // Sorting controls
                menu.querySelector('.sort-asc').addEventListener('click', ()=>{
                    debtsSortState = { column: col, direction: 'asc' };
                    try { window.debtsSortState = debtsSortState; } catch(e){}
                    renderDebts();
                    try { applyDebtsColumnFilters(); } catch(e){}
                    hideAllMenus();
                });
                menu.querySelector('.sort-desc').addEventListener('click', ()=>{
                    debtsSortState = { column: col, direction: 'desc' };
                    try { window.debtsSortState = debtsSortState; } catch(e){}
                    renderDebts();
                    try { applyDebtsColumnFilters(); } catch(e){}
                    hideAllMenus();
                });

                // Select all checkbox behavior
                menu.querySelector('.select-all-checkbox').addEventListener('change', (e)=>{
                    const checked = e.target.checked;
                    menu.querySelectorAll('.filter-list input[type="checkbox"]').forEach(cb => cb.checked = checked);
                });

                // OK / Cancel / Clear
                menu.querySelector('.ok-btn').addEventListener('click', ()=>{
                    const allBoxes = Array.from(menu.querySelectorAll('.filter-list input[type="checkbox"]'));
                    const checked = allBoxes.filter(cb => cb.checked).map(cb => cb.value);
                    debtsColumnFilters[col] = (checked.length === 0 || checked.length === allBoxes.length) ? [] : checked;
                    applyDebtsColumnFilters();
                    hideAllMenus();
                });
                menu.querySelector('.cancel-btn').addEventListener('click', ()=> hideAllMenus());
                menu.querySelector('.clear-btn').addEventListener('click', ()=>{
                    debtsColumnFilters[col] = [];
                    applyDebtsColumnFilters();
                    hideAllMenus();
                });

                btn._menu = menu;
                populateMenuList(menu, col);
                syncSelectAll(menu, col);
                return menu;
            }

            function showMenu(btn){
                const col = btn.dataset.col; if (!col) return;
                const menu = buildMenu(col); if (!menu) return;
                hideAllMenus();
                const rect = btn.getBoundingClientRect();
                menu.style.display = 'block';
                requestAnimationFrame(()=>{
                    const left = rect.left + window.scrollX - (menu.offsetWidth - rect.width);
                    menu.style.left = (left < 8 ? 8 : left) + 'px';
                    menu.style.top = (rect.bottom + window.scrollY + 4) + 'px';
                });
            }

            function hideAllMenus(){ document.querySelectorAll('.debts-filter-menu').forEach(m=>m.style.display='none'); }

            function updateDebtsFilterIndicators(){
                const cols = ['customer','date','invoice','total','paid','remaining','rep'];
                cols.forEach(col => {
                    const btn = document.querySelector(`.column-filter-btn[data-col="${col}"]`);
                    if (!btn) return;
                    const active = Array.isArray(debtsColumnFilters[col]) && debtsColumnFilters[col].length > 0;
                    if (active) btn.classList.add('filtered'); else btn.classList.remove('filtered');
                });
            }

            function applyDebtsColumnFilters(){
                const tbody = document.getElementById('debts-detail-body'); if (!tbody) return;
                const trs = Array.from(tbody.querySelectorAll('tr'));
                const activeCols = Object.keys(debtsColumnFilters).filter(c => Array.isArray(debtsColumnFilters[c]) && debtsColumnFilters[c].length>0);
                trs.forEach(tr=>{
                    let show = true;
                    for (const col of activeCols) {
                        const sel = debtsColumnFilters[col] || [];
                        let cellRaw = '';
                        try {
                            if (col === 'customer') cellRaw = normalizeRaw(tr.dataset.customerId);
                            else if (col === 'date') cellRaw = normalizeRaw(tr.dataset.date);
                            else if (col === 'invoice') cellRaw = normalizeRaw(tr.dataset.invoice);
                            else if (col === 'total') cellRaw = normalizeRaw(Number(tr.dataset.total||0));
                            else if (col === 'paid') cellRaw = normalizeRaw(Number(tr.dataset.paid||0));
                            else if (col === 'remaining') cellRaw = normalizeRaw(Number(tr.dataset.remaining||0));
                            else if (col === 'rep') cellRaw = normalizeRaw(tr.dataset.rep);
                        } catch(e){ cellRaw = ''; }
                        if (!sel.includes(String(cellRaw))) { show = false; break; }
                    }
                    if (show) { tr.classList.remove('hidden-by-filter'); tr.style.display = 'table-row'; }
                    else { tr.classList.add('hidden-by-filter'); tr.style.display = 'none'; }
                });

                const source = window._debtsFiltersOriginalRenderedSales || window._lastRenderedDebtsSales || [];
                const visibleSales = source.filter(sale => {
                    for (const col of activeCols) {
                        const sel = debtsColumnFilters[col] || [];
                        let raw = '';
                        if (col === 'customer') raw = normalizeRaw(sale.customerId);
                        else if (col === 'date') raw = sale.date ? sale.date.split('T')[0] : '';
                        else if (col === 'invoice') raw = normalizeRaw(sale.invoiceNumber);
                        else if (col === 'total') raw = normalizeRaw(Number(sale.total || 0));
                        else if (col === 'paid') raw = normalizeRaw(Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)));
                        else if (col === 'remaining') raw = normalizeRaw(Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))));
                        else if (col === 'rep') raw = normalizeRaw(sale.repName);
                        if (!sel.includes(String(raw))) return false;
                    }
                    return true;
                });
                window._lastRenderedDebtsSales = visibleSales;
                updateDebtsFilterIndicators();
            }

            // Open/close behavior
            document.addEventListener('click', (e)=>{
                const btn = e.target.closest('.column-filter-btn');
                if (btn) { e.stopPropagation(); showMenu(btn); return; }
                if (!e.target.closest('.debts-filter-menu')) hideAllMenus();
            });

            // Expose
            window.debtsColumnFilters = debtsColumnFilters;
            window.applyDebtsColumnFilters = applyDebtsColumnFilters;
            window.debtsSortState = debtsSortState;
            window.updateDebtsFilterIndicators = updateDebtsFilterIndicators;
            // Initial indicator paint (in case state restored elsewhere)
            try { updateDebtsFilterIndicators(); } catch(e){}
        })();

        function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        // Format numbers using English (en-US) digits with up to 2 decimals
        function formatNumberEN(v){
            const n = Number(v ?? 0);
            if (isNaN(n)) return '0';
            const hasFraction = Math.abs(n - Math.round(n)) > 0;
            return n.toLocaleString('en-US', { minimumFractionDigits: hasFraction ? 2 : 0, maximumFractionDigits: 2 });
        }
        async function loadReps() {
            const repSelect = document.getElementById('debt-rep-filter');
            // If running from file:// (offline) the browser blocks fetch to absolute/relative endpoints due to CORS.
            // In that case, use the local `state.reps` as a fallback.
            const isFileProtocol = window.location && window.location.protocol === 'file:';
            const fallbackPopulate = (reps) => {
                try {
                    if (!repSelect) return;
                    repSelect.innerHTML = `\n                        <option value="">جميع المناديب</option>\n                        ${reps.map(rep => `<option value="${rep.id}">${rep.name}</option>`).join('')}\n                    `;
                } catch (e) { console.warn('populate reps fallback failed', e); }
            };

            if (isFileProtocol) {
                // Offline mode: populate from local state immediately
                try {
                    const reps = Array.isArray(state.reps) ? state.reps : [];
                    fallbackPopulate(reps);
                    return reps;
                } catch (e) {
                    console.warn('loadReps fallback failed', e);
                    return [];
                }
            }

            // Otherwise attempt network fetch but gracefully fall back to local state on any failure
            try {
                const response = await fetch('/api/representatives', { cache: 'no-store' });
                if (!response.ok) {
                    // Silently fall back for 404 (API endpoint doesn't exist)
                    if (response.status === 404) {
                        console.debug('API /api/representatives not available (404), using local state');
                    } else {
                        throw new Error('HTTP ' + response.status);
                    }
                    const reps = Array.isArray(state.reps) ? state.reps : [];
                    fallbackPopulate(reps);
                    return reps;
                }
                const reps = await response.json();
                fallbackPopulate(Array.isArray(reps) ? reps : []);
                return reps;
            } catch (error) {
                console.debug('Network request failed, falling back to local state:', error.message);
                const reps = Array.isArray(state.reps) ? state.reps : [];
                fallbackPopulate(reps);
                return reps;
            }
        }

        function renderRepDebts() {
            // تحميل قائمة المناديب عند تحميل الصفحة
            loadReps();
             const tbody = document.getElementById('rep-debts-list-body'); if (!tbody) return; tbody.innerHTML = ''; const balances = Array.from(calculateRepBalances().entries()).map(([repName, obj]) => ({ repName, ...obj })).filter(r => r.totalSales > 0).sort((a, b) => b.balance - a.balance); if (balances.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-4">لا توجد مبيعات مسجلة للمناديب بعد.</td></tr>`; return; } balances.forEach(row => { const balanceClass = row.balance > 0 ? 'text-red-700 font-bold' : (row.balance < 0 ? 'text-green-700 font-bold' : 'text-gray-700'); const balanceText = formatCurrency(row.balance); const tr = document.createElement('tr'); tr.className = 'hover:bg-orange-50'; tr.innerHTML = `<td class="px-4 py-3 text-right font-medium text-gray-800">${row.repName}</td><td class="px-4 py-3 text-center">${formatCurrency(row.totalSales)}</td><td class="px-4 py-3 text-center">${formatCurrency(row.totalCollected)}</td><td class="px-4 py-3 text-center ${balanceClass}">${balanceText}</td><td class="px-4 py-3 text-center"><button data-rep-name="${row.repName}" class="view-rep-summary-btn text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-md hover:bg-orange-200 transition">عرض كشف الحساب</button></td>`; tbody.appendChild(tr); }); tbody.querySelectorAll('.view-rep-summary-btn').forEach(button => { button.addEventListener('click', (e) => { const repName = e.currentTarget.dataset.repName; generateAndShowRepSummary(repName); }); }); updateIcons();
        }
        
        function generateAndShowRepSummary(repName) {
            const repSales = state.sales.filter(s => s.repName === repName).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); const repSummaryContent = document.getElementById('rep-sales-summary-content'); const repSummaryTitle = document.getElementById('rep-sales-summary-title'); if (!repSales.length) { repSummaryContent.innerHTML = `<p class="text-center text-gray-500 p-4">لا توجد فواتير مسجلة للمندوب ${repName}.</p>`; repSummaryTitle.textContent = `كشف حساب المندوب: ${repName}`; openModal(repSalesSummaryModal); return; } const repBalances = calculateRepBalances().get(repName) || { totalSales: 0, totalCollected: 0, balance: 0 }; let html = `<div class="space-y-4"><div class="bg-orange-50 p-4 rounded-lg shadow-inner border border-orange-200"><p class="font-bold text-xl text-orange-700">${repName}</p><div class="grid grid-cols-3 gap-4 mt-2 text-sm"><p><strong>إجمالي المبيعات:</strong> <span class="font-semibold text-blue-600">${formatCurrency(repBalances.totalSales)}</span></p><p><strong>الإجمالي المحصل:</strong> <span class="font-semibold text-green-600">${formatCurrency(repBalances.totalCollected)}</span></p><p><strong>المديونية/المستحق:</strong> <span class="font-bold ${repBalances.balance > 0 ? 'text-red-600' : 'text-gray-600'}">${formatCurrency(repBalances.balance)}</span></p></div></div><h3 class="font-bold text-gray-700 border-b pb-2">تفاصيل الفواتير:</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-right">التاريخ</th><th class="px-4 py-2 text-center">رقم الفاتورة</th><th class="px-4 py-2 text-right">العميل</th><th class="px-4 py-2 text-center">الإجمالي</th><th class="px-4 py-2 text-center">المدفوع</th><th class="px-4 py-2 text-center">الحالة</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${repSales.map(sale => `<tr><td class="px-4 py-2 whitespace-nowrap"><bdo dir="rtl">${formatArabicDate(sale.date)}</bdo></td><td class="px-4 py-2 text-center font-bold text-red-600">${sale.invoiceNumber}</td><td class="px-4 py-2 text-right">${findCustomer(sale.customerId)?.name || 'عميل محذوف'}</td><td class="px-4 py-2 text-center font-semibold ${sale.total < 0 ? 'text-red-600' : 'text-blue-600'}">${formatCurrency(sale.total)}</td><td class="px-4 py-2 text-center text-green-600">${formatCurrency(sale.paidAmount)}</td><td class="px-4 py-2 text-center">${getStatusBadge(sale.status)}</td></tr>`).join('')}</tbody></table></div></div>`; repSummaryContent.innerHTML = html; repSummaryTitle.textContent = `كشف حساب المندوب: ${repName}`; updateIcons(); openModal(repSalesSummaryModal);
        }

        function addRowToNewDispatchGrid(item = {}) {
            const container = document.getElementById('new-dispatch-items-container');
            if (!container) return;
            const row = document.createElement('tr');
            row.className = 'dispatch-item-row';
            
            const productOptions = state.products.map(p => 
                `<option value="${p.id}" ${item.productId === p.id ? 'selected' : ''}>${p.name}</option>`
            ).join('');

            // Removed goodReturn, damagedReturn, freebie inputs, added actualReturn input
            row.innerHTML = `
                <td class="px-2 py-1"><select class="dispatch-item-product w-full p-1 border rounded-md text-sm" required><option value="">اختر منتج...</option>${productOptions}</select></td>
                <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="quantity" value="${item.quantity || ''}" placeholder="0" min="0"></td>
                <td><input class="w-full p-1 border rounded-md text-center text-sm actual-return-input" type="number" data-field="actualReturn" value="${item.actualReturn || ''}" placeholder="0" min="0"></td>
                <td class="px-2 py-1 text-center"><button type="button" class="delete-dispatch-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            `;
            
            container.appendChild(row);
            updateIcons();

            row.querySelector('.delete-dispatch-item-btn').addEventListener('click', () => {
                row.remove();
            });
        }

        async function saveNewDispatchNoteFromGrid() {
            const repName = document.getElementById('new-dispatch-rep').value;
            const date = document.getElementById('new-dispatch-date').value;
            const noteNumber = document.getElementById('new-dispatch-note-number').value;

            if (!repName || !date || !noteNumber) {
                await customDialog({ message: 'الرجاء إدخال رقم الإذن والمندوب والتاريخ أولاً.', title: 'بيانات ناقصة' });
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('#new-dispatch-items-container .dispatch-item-row');
            for (const row of itemRows) {
                const productId = row.querySelector('.dispatch-item-product').value;
                const quantity = parseInt(row.querySelector('[data-field="quantity"]').value) || 0;
                const actualReturn = parseInt(row.querySelector('[data-field="actualReturn"]').value) || 0; // NEW

                if (productId && (quantity > 0 || actualReturn > 0)) { // Modified condition
                    items.push({ productId, quantity, actualReturn }); // Modified item object
                }
            }

            if (items.length === 0) {
                await customDialog({ message: 'الرجاء إضافة صنف واحد على الأقل للإذن.', title: 'بيانات ناقصة' });
                return;
            }

            const noteData = {
                id: undefined, // سيُنشأ من Firestore
                noteNumber: parseInt(noteNumber),
                repName,
                date: new Date(date + 'T12:00:00Z').toISOString(),
                items,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null,
                createdByEmail: (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null
            };

            try {
                await addDispatchNote(noteData);
                await customDialog({ message: 'تم حفظ إذن الخروج في السحابة بنجاح.', title: 'نجاح' });
            } catch(e){
                console.warn('Failed to add dispatch note', e);
                await customDialog({ message:'تعذر حفظ الإذن. تحقق من الاتصال أو الصلاحيات.', title:'خطأ' });
            }

            initializeNewDispatchGrid();
        }

        function initializeNewDispatchGrid() {
            const repSelect = document.getElementById('new-dispatch-rep');
            const dateInput = document.getElementById('new-dispatch-date');
            const container = document.getElementById('new-dispatch-items-container');

            if (!repSelect || !dateInput || !container) return;

            populateRepDropdown(repSelect);
            dateInput.value = new Date().toISOString().split('T')[0];
            container.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                addRowToNewDispatchGrid();
            }
        }

        function renderDispatchPage() {
            const listEl = document.getElementById('dispatch-notes-list');
            listEl.innerHTML = '';
            const notesArr = Array.isArray(state.dispatchNotes) ? state.dispatchNotes : [];
            const sortedNotes = notesArr.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedNotes.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center mt-8 bg-white p-4 rounded-lg">لا توجد أذونات استلام سابقة.</p>';
                return;
            }

            sortedNotes.forEach(note => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg border shadow-sm dispatch-note-card';
                el.dataset.noteId = note.id;
                el.innerHTML = `
                    <div class="flex justify-between items-start cursor-pointer dispatch-note-header">
                        <div>
                            <p class="font-bold text-lg">${note.repName}</p>
                            <p class="text-sm text-gray-500">بتاريخ: ${new Date(note.date).toLocaleDateString('ar-EG')}</p>
                            <p class="text-xs text-gray-500 mt-1">${note.items.length} صنف</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">تعديل</span>
                            <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
                        </div>
                    </div>
                    <div class="dispatch-note-details hidden mt-4 pt-4 border-t">
                        <!-- Editable grid will be injected here -->
                    </div>
                `;
                listEl.appendChild(el);
            });
            updateIcons();
            // معالجة إظهار/إخفاء أقسام حسب الدور
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                const createSection = document.getElementById('new-dispatch-note-section');
                const summaryBox = document.getElementById('rep-dispatch-summary');
                if (role === 'rep') {
                    if (createSection) createSection.style.display = 'none';
                    if (summaryBox) { summaryBox.classList.remove('hidden'); renderRepDispatchSummary(); }
                } else {
                    if (createSection) createSection.style.display = '';
                    if (summaryBox) summaryBox.classList.add('hidden');
                }
            } catch(e){ console.warn('dispatch role toggle failed', e); }
        }

        // تجميع ملخص أصناف المندوب (قراءة فقط)
        function renderRepDispatchSummary(){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role !== 'rep') return;
                const box = document.getElementById('rep-dispatch-summary-content');
                if (!box) return;
                const user = (typeof AuthSystem !== 'undefined' && AuthSystem.getCurrentUser) ? AuthSystem.getCurrentUser() : null;
                const repName = user ? (user.displayName || user.name || user.email || '').trim() : '';
                const notes = (Array.isArray(state.dispatchNotes) ? state.dispatchNotes : []).filter(n => (n.repName||'').trim() === repName);
                if (notes.length === 0) { box.innerHTML = '<p class="text-gray-500">لا توجد أذونات مرتبطة بحسابك.</p>'; return; }
                const agg = new Map();
                notes.forEach(n => (n.items||[]).forEach(it => {
                    const key = String(it.productId || it.name || '').trim();
                    if (!agg.has(key)) agg.set(key, { name: it.name || key, received:0, returnOk:0, returnBad:0, freeQty:0 });
                    const o = agg.get(key);
                    o.received += Number(it.receivedQty || it.quantity || 0);
                    o.returnOk += Number(it.returnedOk || it.actualReturn || 0);
                    o.returnBad += Number(it.returnedDamaged || 0);
                    o.freeQty += Number(it.freeQty || 0);
                }));
                const rows = Array.from(agg.values()).map(o => {
                    const remaining = o.received - (o.returnOk + o.returnBad + o.freeQty);
                    return `<tr>
                        <td class='px-2 py-1 text-right'>${escapeHtml(o.name)}</td>
                        <td class='px-2 py-1 text-center'>${o.received}</td>
                        <td class='px-2 py-1 text-center'>${o.returnOk}</td>
                        <td class='px-2 py-1 text-center'>${o.returnBad}</td>
                        <td class='px-2 py-1 text-center'>${o.freeQty}</td>
                        <td class='px-2 py-1 text-center font-semibold'>${remaining}</td>
                    </tr>`;
                }).join('');
                box.innerHTML = `<div class='overflow-x-auto'><table class='min-w-full border divide-y divide-gray-200 text-xs'>
                    <thead class='bg-gray-50'><tr>
                        <th class='px-2 py-1 text-right'>الصنف</th>
                        <th class='px-2 py-1 text-center'>مستلم</th>
                        <th class='px-2 py-1 text-center'>مرتجع سليم</th>
                        <th class='px-2 py-1 text-center'>مرتجع تالف</th>
                        <th class='px-2 py-1 text-center'>مجاني</th>
                        <th class='px-2 py-1 text-center'>المتبقي</th>
                    </tr></thead><tbody>${rows}</tbody></table></div>`;
            } catch(e){ console.warn('renderRepDispatchSummary failed', e); }
        }
        
        // --- CASH column filter menus (per-column dropdowns) ---
        (function(){
            const cashColumnFilters = {};

            function normalizeRaw(v){ return (v === null || typeof v === 'undefined') ? '' : String(v).toString().replace(/\s+/g,' ').trim(); }

            function populateCashMenuList(menu, col){
                const listEl = menu.querySelector('.filter-list');
                listEl.innerHTML = '';
                const rows = window._lastRenderedCashSales || [];
                const map = new Map();
                rows.forEach(sale => {
                    let raw = '';
                    let disp = '';
                    if (col === 'customer') { raw = normalizeRaw(sale.customerId); disp = findCustomer(sale.customerId)?.name || raw; }
                    else if (col === 'date') { raw = sale.date ? sale.date.split('T')[0] : ''; disp = sale.date ? formatArabicDate(sale.date) : ''; }
                    else if (col === 'invoice') { raw = normalizeRaw(sale.invoiceNumber); disp = raw; }
                    else if (col === 'total') { raw = normalizeRaw(Number(sale.total || 0)); disp = Math.abs(sale.total || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'paid') { const p = Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)); raw = normalizeRaw(p); disp = Math.abs(p).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'remaining') { const r = Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))); raw = normalizeRaw(r); disp = Math.abs(r).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
                    else if (col === 'rep') { raw = normalizeRaw(sale.repName); disp = raw; }
                    else if (col === 'collection') { raw = sale.collectionReportCreated ? 'created' : 'not-created'; disp = raw === 'created' ? 'تم' : 'لم يتم'; }
                    if (!map.has(raw)) map.set(raw, disp);
                });

                const items = Array.from(map.entries()).sort((a,b)=> String(a[1]).localeCompare(String(b[1]), 'ar'));
                items.forEach(([raw, disp]) => {
                    const id = 'cf-cash-' + col + '-' + Math.random().toString(36).slice(2,8);
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.padding = '4px 2px';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = raw; cb.id = id;
                    if (Array.isArray(cashColumnFilters[col]) && cashColumnFilters[col].includes(raw)) cb.checked = true;
                    const txt = document.createTextNode(' ' + String(disp));
                    label.appendChild(cb); label.appendChild(txt);
                    listEl.appendChild(label);
                });
            }

            function buildCashMenu(col){
                const btn = document.querySelector(`.cash-column-filter-btn[data-col="${col}"]`);
                if (!btn) return null;
                if (btn._menu) { populateCashMenuList(btn._menu, col); return btn._menu; }

                const menu = document.createElement('div');
                menu.className = 'column-filter-menu cash-filter-menu';
                menu.style.display = 'none';
                menu.innerHTML = `
                    <input class="filter-search" placeholder="بحث..." />
                    <div class="filter-list"></div>
                    <div class="filter-actions">
                        <button class="apply-btn">تطبيق</button>
                        <button class="clear-btn">مسح</button>
                    </div>
                `;
                document.body.appendChild(menu);

                // wire search
                menu.querySelector('.filter-search').addEventListener('input', (e)=>{
                    const q = (e.target.value || '').trim().toLowerCase();
                    menu.querySelectorAll('.filter-list label').forEach(lbl=>{
                        lbl.style.display = lbl.textContent.toLowerCase().includes(q) ? '' : 'none';
                    });
                });

                // apply
                menu.querySelector('.apply-btn').addEventListener('click', ()=>{
                    const checked = Array.from(menu.querySelectorAll('.filter-list input[type="checkbox"]:checked')).map(i=>i.value);
                    cashColumnFilters[col] = checked;
                    applyCashColumnFilters();
                    hideAllCashMenus();
                });

                // clear
                menu.querySelector('.clear-btn').addEventListener('click', ()=>{
                    cashColumnFilters[col] = [];
                    populateCashMenuList(menu, col);
                    applyCashColumnFilters();
                    hideAllCashMenus();
                });

                btn._menu = menu;
                populateCashMenuList(menu, col);
                return menu;
            }

            function showCashMenu(btn){
                const col = btn.dataset.col;
                if (!col) return;
                const menu = buildCashMenu(col);
                if (!menu) return;
                // hide other menus
                hideAllCashMenus();
                const rect = btn.getBoundingClientRect();
                menu.style.display = 'block';
                const left = rect.right - menu.offsetWidth + window.scrollX;
                menu.style.left = (left < 8 ? 8 : left) + 'px';
                menu.style.top = (rect.bottom + window.scrollY + 6) + 'px';
            }

            function hideAllCashMenus(){ document.querySelectorAll('.cash-filter-menu').forEach(m=>m.style.display='none'); }

            function applyCashColumnFilters(){
                const tbody = document.getElementById('cash-table-body'); if (!tbody) return;
                const trs = Array.from(tbody.querySelectorAll('tr'));
                const activeCols = Object.keys(cashColumnFilters).filter(c => Array.isArray(cashColumnFilters[c]) && cashColumnFilters[c].length>0);
                try { console.debug('applyCashColumnFilters start', { filters: cashColumnFilters, activeCols, rowsRendered: (window._lastRenderedCashSales || []).length }); } catch(e){}

                trs.forEach(tr=>{
                    let show = true;
                    for (const col of activeCols) {
                        const sel = cashColumnFilters[col] || [];
                        let cellRaw = '';
                        try {
                            if (col === 'customer') cellRaw = normalizeRaw(tr.dataset.customer);
                            else if (col === 'date') cellRaw = normalizeRaw(tr.dataset.date);
                            else if (col === 'invoice') cellRaw = normalizeRaw(tr.dataset.invoice);
                            else if (col === 'total') cellRaw = normalizeRaw(Number(tr.dataset.total||0));
                            else if (col === 'paid') cellRaw = normalizeRaw(Number(tr.dataset.paid||0));
                            else if (col === 'remaining') cellRaw = normalizeRaw(Number(tr.dataset.remaining||0));
                            else if (col === 'rep') cellRaw = normalizeRaw(tr.dataset.rep);
                            else if (col === 'collection') cellRaw = tr.querySelector('.cash-action-create') ? (tr.querySelector('.cash-action-create').textContent.includes('إلغاء') ? 'created' : 'not-created') : (tr.dataset.collectionReportCreated ? 'created' : 'not-created');
                        } catch(e){ cellRaw = ''; }
                        if (!sel.includes(String(cellRaw))) { show = false; break; }
                    }
                    tr.style.display = show ? 'table-row' : 'none';
                });

                const source = window._cashFiltersOriginalRenderedSales || window._lastRenderedCashSales || [];
                const visibleSales = source.filter(sale => {
                    for (const col of activeCols) {
                        const sel = cashColumnFilters[col] || [];
                        let raw = '';
                        if (col === 'customer') raw = normalizeRaw(sale.customerId);
                        else if (col === 'date') raw = sale.date ? sale.date.split('T')[0] : '';
                        else if (col === 'invoice') raw = normalizeRaw(sale.invoiceNumber);
                        else if (col === 'total') raw = normalizeRaw(Number(sale.total || 0));
                        else if (col === 'paid') raw = normalizeRaw(Number(sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0)));
                        else if (col === 'remaining') raw = normalizeRaw(Number((sale.total || 0) - (sale.paidAmount ?? (sale.status === 'paid' ? (sale.total || 0) : 0))));
                        else if (col === 'rep') raw = normalizeRaw(sale.repName);
                        else if (col === 'collection') raw = sale.collectionReportCreated ? 'created' : 'not-created';
                        if (!sel.includes(String(raw))) return false;
                    }
                    return true;
                });
                window._lastRenderedCashSales = visibleSales;
            }

            // global click handler to open menus for cash
            document.addEventListener('click', (e)=>{
                const btn = e.target.closest('.cash-column-filter-btn');
                if (btn) { e.stopPropagation(); showCashMenu(btn); return; }
                if (!e.target.closest('.cash-filter-menu')) hideAllCashMenus();
            });

            window.cashColumnFilters = cashColumnFilters;
            window.applyCashColumnFilters = applyCashColumnFilters;
        })();

        function renderEditableDispatchGrid(noteId, container) {
            const note = state.dispatchNotes.find(n => n.id === noteId);
            if (!note) return;

            // 1. Fetch Sales Data for the specific rep and date
            const salesForRepAndDate = state.sales.filter(sale =>
                sale.repName === note.repName &&
                new Date(sale.date).toISOString().split('T')[0] === new Date(note.date).toISOString().split('T')[0]
            );

            // 2. Aggregate Sold Quantities by product
            const soldQuantities = {};
            salesForRepAndDate.forEach(sale => {
                sale.items.forEach(item => {
                    soldQuantities[item.productId] = (soldQuantities[item.productId] || 0) + item.quantity;
                });
            });

            // 3. Compute weighted average prices per product for the sales found.
            //    If there are no sales for a product, fall back to customer's price list -> default price list -> product.base price.
            const avgPriceByProduct = {}; // productId -> averagePrice (number)
            // Build price lookup helper for a sale's customer
            const getPriceForProductForCustomer = (productId, customerId) => {
                // 1. Check the customer's assigned price list
                const customer = state.customers.find(c => c.id === customerId);
                if (customer && customer.priceListId) {
                    const pl = findPriceList(customer.priceListId);
                    if (pl && pl.productPrices && pl.productPrices[productId] !== undefined) return Number(pl.productPrices[productId]);
                }
                // 2. fallback to default retail price list if exists
                const retail = state.priceLists.find(p => p.id && p.id.includes('retail'));
                if (retail && retail.productPrices && retail.productPrices[productId] !== undefined) return Number(retail.productPrices[productId]);
                // 3. fallback to product base price
                const prod = findProduct(productId);
                return prod ? Number(prod.price || 0) : 0;
            };

            // Sum quantities * price per product using the sale items (if any)
            const priceSums = {}; // productId -> { qty: totalQty, value: totalQty*price }
            salesForRepAndDate.forEach(sale => {
                sale.items.forEach(item => {
                    const pid = item.productId;
                    const qty = Number(item.quantity || 0);
                    // prefer explicit item.price if present
                    let price = (item.price !== undefined && item.price !== null) ? Number(item.price) : getPriceForProductForCustomer(pid, sale.customerId);
                    if (!price || isNaN(price)) price = getPriceForProductForCustomer(pid, sale.customerId);
                    if (!priceSums[pid]) priceSums[pid] = { qty: 0, value: 0 };
                    priceSums[pid].qty += qty;
                    priceSums[pid].value += qty * price;
                });
            });

            Object.keys(priceSums).forEach(pid => {
                const entry = priceSums[pid];
                avgPriceByProduct[pid] = entry.qty > 0 ? (entry.value / entry.qty) : 0;
            });

            let itemsHtml = note.items.map(item => {
                const productOptions = state.products.map(p =>
                    `<option value="${p.id}" ${item.productId === p.id ? 'selected' : ''}>${p.name}</option>`
                ).join('');

                const takenOut = item.quantity || 0;
                const sold = soldQuantities[item.productId] || 0;
                const expectedReturn = takenOut - sold;
                const actualReturn = item.goodReturn + item.damagedReturn + item.freebie; // Assuming these are the actual returns
                const difference = actualReturn - expectedReturn;

                let differenceClass = '';
                if (difference < 0) {
                    differenceClass = 'text-red-600 font-bold'; // Deficit
                } else if (difference > 0) {
                    differenceClass = 'text-green-600 font-bold'; // Surplus
                }

                return `
                    <tr class="dispatch-item-row" data-product-id="${item.productId}">
                        <td class="px-2 py-1"><select class="dispatch-item-product w-full p-1 border rounded-md text-sm" required><option value="">اختر منتج...</option>${productOptions}</select></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="takenOut" value="${takenOut}" placeholder="0" min="0" readonly></td>
                        <td><span class="w-full p-1 text-center text-sm">${sold}</span></td>
                        <td><span class="w-full p-1 text-center text-sm">${expectedReturn}</span></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm actual-return-input" type="number" data-field="actualReturn" value="${actualReturn}" placeholder="0" min="0"></td>
                        <td><span class="w-full p-1 text-center text-sm ${differenceClass}">${difference}</span></td>
                        <td class="px-2 py-1 text-center"><button type="button" class="delete-dispatch-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-x-auto bg-white rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 editable-dispatch-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase w-2/5">المنتج</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مستلم</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مباع</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع متوقع</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع فعلي</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">الفرق</th>
                                <th class="px-2 py-2"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">${itemsHtml}</tbody>
                    </table>
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <button type="button" class="add-editable-dispatch-item-btn text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1" data-note-id="${noteId}">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        إضافة صنف
                    </button>
                    <div class="flex gap-2">
                        <button type="button" class="copy-dispatch-note-btn bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="image" class="w-5 h-5"></i>
                            نسخ
                        </button>
                        <button type="button" class="print-dispatch-note-btn bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="printer" class="w-5 h-5"></i>
                            طباعة
                        </button>
                        <button type="button" class="delete-dispatch-note-btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="trash" class="w-5 h-5"></i>
                            حذف
                        </button>
                        <button type="button" class="update-dispatch-note-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2" data-note-id="${noteId}">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            حفظ
                        </button>
                    </div>
                </div>
                <div class="mt-4 text-right">
                    <!-- Compute and display permission total based on average prices and takenOut quantities -->
                    ${(()=>{
                        try {
                            let total = 0;
                            note.items.forEach(it => {
                                const qty = Number(it.quantity || 0);
                                const avg = Number(avgPriceByProduct[it.productId] !== undefined ? avgPriceByProduct[it.productId] : getPriceForProductForCustomer(it.productId, null));
                                total += qty * avg;
                            });
                            return `<div class="font-bold">∑: ${formatCurrency(total)}</div>`;
                        } catch (e) { return ''; }
                    })()}
                </div>
            `;
            updateIcons();

            // Add event listeners for actual return input to update difference
            container.querySelectorAll('.actual-return-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const row = e.target.closest('.dispatch-item-row');
                    const takenOut = parseInt(row.querySelector('[data-field="takenOut"]').value) || 0;
                    const sold = parseInt(row.children[2].textContent) || 0; // Get sold from the span
                    const expectedReturn = takenOut - sold;
                    const actualReturn = parseInt(e.target.value) || 0;
                    const difference = actualReturn - expectedReturn;

                    const differenceCell = row.children[5]; // The difference span
                    differenceCell.textContent = difference;
                    differenceCell.classList.remove('text-red-600', 'text-green-600', 'font-bold');
                    if (difference < 0) {
                        differenceCell.classList.add('text-red-600', 'font-bold');
                    } else if (difference > 0) {
                        differenceCell.classList.add('text-green-600', 'font-bold');
                    }
                });
            });
        }

        // Read-only render for dispatch note (for reps)
        function renderReadonlyDispatchGrid(noteId, container) {
            const note = state.dispatchNotes.find(n => n.id === noteId);
            if (!note) { container.innerHTML = '<p class="text-sm text-red-600">لم يتم العثور على الإذن.</p>'; return; }
            const rowsHtml = note.items.map(item => {
                const prod = findProduct(item.productId);
                const name = prod ? prod.name : 'منتج محذوف';
                const takenOut = item.quantity || 0;
                const good = item.goodReturn || 0;
                const damaged = item.damagedReturn || 0;
                const freebie = item.freebie || 0;
                return `<tr class="text-xs border-b last:border-b-0">\n<td class="px-2 py-1 text-right font-semibold">${name}</td>\n<td class="px-2 py-1 text-center">${takenOut}</td>\n<td class="px-2 py-1 text-center text-green-700">${good}</td>\n<td class="px-2 py-1 text-center text-red-700">${damaged}</td>\n<td class="px-2 py-1 text-center text-blue-700">${freebie}</td></tr>`;
            }).join('');
            container.innerHTML = `
                <div class="overflow-x-auto bg-white rounded-lg">
                    <table class="min-w-full">
                        <thead class="bg-gray-200 text-xs">
                            <tr>
                                <th class="px-2 py-2 text-right">الصنف</th>
                                <th class="px-2 py-2 text-center">مستلم</th>
                                <th class="px-2 py-2 text-center">مرتجع سليم</th>
                                <th class="px-2 py-2 text-center">مرتجع تالف</th>
                                <th class="px-2 py-2 text-center">مجاني</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
                <div class="mt-3 flex gap-2 justify-end">
                    <button type="button" class="copy-dispatch-note-btn bg-teal-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1" data-note-id="${noteId}"><i data-lucide="image" class="w-4 h-4"></i> صورة</button>
                    <button type="button" class="print-dispatch-note-btn bg-gray-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1" data-note-id="${noteId}"><i data-lucide="printer" class="w-4 h-4"></i> طباعة</button>
                </div>`;
            updateIcons();
        }

                function generateDispatchNotePrintContent(noteId) {
                    const note = state.dispatchNotes.find(n => n.id === noteId);
                    if (!note) return null;
        
                    // Build average price map (weighted by actual sales prices) for this rep & date
                    const salesForRepAndDate = state.sales.filter(sale =>
                        sale.repName === note.repName &&
                        new Date(sale.date).toISOString().split('T')[0] === new Date(note.date).toISOString().split('T')[0]
                    );

                    const priceSums = {};
                    salesForRepAndDate.forEach(sale => {
                        sale.items.forEach(it => {
                            const pid = it.productId;
                            const qty = Number(it.quantity || 0);
                            const price = (it.price !== undefined && it.price !== null) ? Number(it.price) : (findPriceList(findCustomer(sale.customerId)?.priceListId)?.productPrices?.[pid] ?? findProduct(pid)?.price ?? 0);
                            if (!priceSums[pid]) priceSums[pid] = { qty: 0, value: 0 };
                            priceSums[pid].qty += qty;
                            priceSums[pid].value += qty * price;
                        });
                    });

                    const avgPriceByProduct = {};
                    Object.keys(priceSums).forEach(pid => { const e = priceSums[pid]; avgPriceByProduct[pid] = e.qty > 0 ? (e.value / e.qty) : 0; });

                    let permissionTotal = 0;
                    const itemsHtml = note.items.map(item => {
                        const product = findProduct(item.productId);
                        const avg = Number(avgPriceByProduct[item.productId] !== undefined ? avgPriceByProduct[item.productId] : (findPriceList(findCustomer(null)?.priceListId)?.productPrices?.[item.productId] ?? findProduct(item.productId)?.price ?? 0));
                        const lineValue = (Number(item.quantity || 0) * avg);
                        permissionTotal += lineValue;
                        return `
                            <tr class="border-b">
                                <td class="p-2 text-right">${product ? product.name : 'منتج محذوف'}</td>
                                <td class="p-2 text-center">${item.quantity || 0}</td>
                                <td class="p-2 text-center">${item.actualReturn || 0}</td>
                            </tr>
                        `;
                    }).join('');

                    return `
                        <div class="p-6" style="direction: rtl; position: relative;">
                        <div style="position: relative; z-index: 1;">
                                <div class="flex justify-between items-start mb-4 border-b pb-4">
                                    <div class="text-right">
                                        <div class="flex items-center justify-end gap-4">
                                            <div id="dispatch-note-company" class="text-right">
                                                <h1 class="text-xl font-bold">شركة ديلينت لتصنيع وتوزيع الالبان</h1>
                                            </div>
                                            <div id="dispatch-note-logo">
                                                ${ (getCompanyLogoUrl && getCompanyLogoUrl()) ? `<img src="${getCompanyLogoUrl()}" style="height:48px;margin-left:8px;border-radius:6px;background:#fff;padding:4px;"/>` : '' }
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold">إذن استلام بضاعة</h1>
                                        <p><strong>تاريخ:</strong> ${new Date(note.date).toLocaleDateString('ar-EG')}</p>
                                        <p><strong>رقم الإذن:</strong> ${note.noteNumber || note.id}</p>
                                    </div>
                                </div>
        
                                <div class="text-center my-6">
                                    <h2 class="text-xl font-bold">المندوب: ${note.repName}</h2>
                                </div>
        
                                <table class="min-w-full divide-y divide-gray-200 mb-8">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-right font-semibold">الصنف</th>
                                            <th class="px-4 py-2 text-center font-semibold">المستلم</th>
                                            <th class="px-4 py-2 text-center font-semibold">المرتجع الفعلي</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-100">
                                        ${itemsHtml}
                                    </tbody>
                                </table>
                                <div class="mb-6 text-right font-bold">إجمالي الإذن حسب قوائم الأسعار: ${formatCurrency(permissionTotal)}</div>
        
                                <div style="padding-top: 6rem;">
                                    <div class="flex justify-around items-center text-center">
                                        <p class="border-t-2 pt-2 px-8">توقيع المندوب</p>
                                        <p class="border-t-2 pt-2 px-8">توقيع أمين المخزن</p>
                                        <p class="border-t-2 pt-2 px-8">توقيع الأمن</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
        async function copyDispatchNoteAsImage(noteId) {
            const content = generateDispatchNotePrintContent(noteId);
            if (!content) return;

            const tempElement = document.createElement('div');
            tempElement.id = 'temp-dispatch-print-area';
            tempElement.style.width = '800px'; // Set a fixed width for consistent image size
            tempElement.style.backgroundColor = 'white';
            tempElement.innerHTML = content;
            
            // Append to body to be rendered, but off-screen
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            document.body.appendChild(tempElement);

            await generateReportImage('temp-dispatch-print-area');

            document.body.removeChild(tempElement);
        }

        function printDispatchNote(noteId) {
            const content = generateDispatchNotePrintContent(noteId);
            if (!content) {
                customDialog({ title: 'خطأ', message: 'لم يتم العثور على الإذن لطباعته.' });
                return;
            }
            const w = window.open('', '', 'height=800,width=900');
            if (!w) { customDialog({ title: 'تنبيه', message: 'يرجى السماح بالنوافذ المنبثقة للطباعة.' }); return; }
            w.document.open();
            w.document.write('<html><head><title>إذن صرف</title>');
            w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
            w.document.write('<style>body{font-family: Cairo, sans-serif; direction: rtl; padding: 16px;}</style>');
            w.document.write('</head><body>');
            w.document.write(content);
            w.document.write('</body></html>');
            w.document.close();
            const doPrint = () => { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
            const closeBack = () => { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
            if ('onafterprint' in w) { w.onafterprint = closeBack; } else { setTimeout(closeBack, 1200); }
            if ('onload' in w) { w.onload = () => setTimeout(doPrint, 150); } else { setTimeout(doPrint, 350); }
        }

        async function updateDispatchNote(noteId, tableContainer) {
            const note = state.dispatchNotes.find(n => n.id === noteId);
            if (!note) return;

            const items = [];
            const itemRows = tableContainer.querySelectorAll('.dispatch-item-row');
            for (const row of itemRows) {
                const productId = row.querySelector('.dispatch-item-product').value;
                const quantity = parseInt(row.querySelector('[data-field="quantity"]').value) || 0;
                const actualReturn = parseInt(row.querySelector('[data-field="actualReturn"]').value) || 0; // NEW

                if (productId && (quantity > 0 || actualReturn > 0)) { // Modified condition
                    items.push({ productId, quantity, actualReturn }); // Modified item object
                }
            }

            if (items.length === 0) {
                await customDialog({ message: 'لا يمكن حفظ إذن فارغ. لحذفه، استخدم زر الحذف.', title: 'بيانات ناقصة' });
                return;
            }

            note.items = items;
            note.updatedAt = new Date().toISOString();

            renderAll();
            await customDialog({ message: 'تم حفظ تعديلات الإذن بنجاح.', title: 'نجاح' });
        }

        async function deleteDispatchNote(noteId) {
            const confirmed = await customDialog({
                title: 'تأكيد الحذف',
                message: 'هل أنت متأكد أنك تريد حذف هذا الإذن بالكامل؟',
                isConfirm: true,
                confirmText: 'نعم، احذف',
                confirmClass: 'bg-red-600 hover:bg-red-700'
            });

            if (confirmed) {
                state.dispatchNotes = state.dispatchNotes.filter(n => n.id !== noteId);
                renderAll();
                await customDialog({ message: 'تم حذف الإذن بنجاح.' });
            }
        }

        function getProductDetailsByCode(code) { 
            if (!code) return null;
            const scode = String(code);
            // ابحث بالترتيب: id ثم _id ثم sku (بمطابقة نصية)
            const product = state.products.find(p => String(p.id) === scode) || state.products.find(p => String(p._id) === scode) || state.products.find(p => String(p.sku) === scode);
            if (!product) return null;
            const price = Number(product.price || 0);
            const category = product.category === 'multi' ? 'مالتي' : (product.category === 'dairy' ? 'ألبان' : (product.category || ''));
            return { id: product.id || product._id || product.sku, name: product.name || product.title || code, defaultPrice: price, categoryName: category };
        }
        function updateSpreadsheetPriceAndProductInfo(row, productId, customerId) { 
            const priceInput = row.querySelector('.spreadsheet-price'); const nameInput = row.querySelector('.spreadsheet-product-name'); const categoryCell = row.querySelector('.spreadsheet-category'); const productDetails = getProductDetailsByCode(productId); priceInput.classList.remove('promotion-price-applied'); if (row.querySelector('.spreadsheet-tax-status-input')) { row.querySelector('.spreadsheet-tax-status-input').classList.remove('border-red-500', 'border-2'); } if (!productDetails) { nameInput.value = 'كود غير صحيح'; nameInput.classList.add('text-red-500'); priceInput.value = 0; categoryCell.textContent = ''; row.dataset.productId = ''; return; } nameInput.value = productDetails.name; nameInput.classList.remove('text-red-500'); categoryCell.textContent = productDetails.categoryName; row.dataset.productId = productDetails.id; let finalPrice; let basePrice; basePrice = productDetails.defaultPrice; if(customerId) { const customer = findCustomer(customerId); if(customer && customer.priceListId) { const priceList = findPriceList(customer.priceListId); if(priceList && priceList.productPrices[productDetails.id] !== undefined) { basePrice = priceList.productPrices[productDetails.id]; } } } finalPrice = basePrice; const promotionPrice = getActivePromotionPrice(productId, customerId); if (promotionPrice !== null) { finalPrice = promotionPrice; priceInput.classList.add('promotion-price-applied'); } priceInput.value = parseFloat(finalPrice).toFixed(2); 
            try {
                if (/قريش|قريش/i.test(productDetails.name||'')) {
                    const customer = customerId ? findCustomer(customerId) : null;
                    const priceList = (customer && customer.priceListId) ? findPriceList(customer.priceListId) : null;
                    const listOverride = priceList ? priceList.productPrices[productDetails.id] : undefined;
                    console.debug('DEBUG Pricing (spreadsheet row)', {
                        productId: productDetails.id,
                        productName: productDetails.name,
                        basePrice: productDetails.defaultPrice,
                        priceListId: customer ? customer.priceListId : '',
                        priceListOverride: listOverride,
                        promotionPrice,
                        finalPrice
                    });
                }
            } catch(_){ }
        }
        function updateSpreadsheetTaxVisibility(customerId) { 
            const customer = findCustomer(customerId); const requiresFiling = customer && customer.requiresTaxFiling; const taxHeader = document.querySelector('.spreadsheet-tax-header'); if (taxHeader) { taxHeader.style.display = requiresFiling ? 'table-cell' : 'none'; } spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => { const taxCell = row.querySelector('.spreadsheet-tax-cell'); if (taxCell) { taxCell.style.display = requiresFiling ? 'table-cell' : 'none'; if (!requiresFiling) { const taxInput = row.querySelector('.spreadsheet-tax-status-input'); if (taxInput) taxInput.value = ''; } } }); 
        }
        function calculateSpreadsheetRowTotal(row) {
            const quantity = parseInt(row.querySelector('.spreadsheet-quantity').value) || 0;
            const originalPrice = parseFloat(row.querySelector('.spreadsheet-price').value) || 0;
            const modifiedPrice = parseFloat(row.querySelector('.spreadsheet-modified-price').value); // Don't default to 0, check for NaN

            // Use modified price if it's a valid number, otherwise use the original price
            const finalPrice = !isNaN(modifiedPrice) && modifiedPrice > 0 ? modifiedPrice : originalPrice;
            
            const discount = parseFloat(row.querySelector('.spreadsheet-discount').value) || 0;
            const totalCell = row.querySelector('.spreadsheet-total');
            const itemSubtotal = quantity * finalPrice;
            const itemTotal = itemSubtotal * (1 - discount / 100);
            totalCell.textContent = formatCurrency(itemTotal);
        }
        
        function initializeSpreadsheetPage() {
            populateRepDropdown(spreadsheetRepSelect);
            // إذا كان هناك خيار واحد فقط (مندوب واحد)، يتم اختياره تلقائياً
            if (spreadsheetRepSelect && spreadsheetRepSelect.options.length === 2) {
                // الخيار الأول هو "-- جميع المناديب --"، الثاني هو اسم المندوب
                spreadsheetRepSelect.selectedIndex = 1;
            }
            populateCustomerDropdown(spreadsheetCustomerSelect);
            spreadsheetDateInput.value = new Date().toISOString().split('T')[0];
            spreadsheetEntryBody.innerHTML = '';
            for(let i = 0; i < 5; i++) { addSpreadsheetRow(); }
            updateSpreadsheetTaxVisibility(null);
            spreadsheetCustomerSelect.removeEventListener('change', handleSpreadsheetCustomerChange);
            spreadsheetCustomerSelect.addEventListener('change', handleSpreadsheetCustomerChange);
            spreadsheetEntryBody.removeEventListener('change', handleSpreadsheetRowChange);
            spreadsheetEntryBody.addEventListener('change', handleSpreadsheetRowChange);
            spreadsheetEntryBody.removeEventListener('input', handleSpreadsheetRowInput);
            spreadsheetEntryBody.addEventListener('input', handleSpreadsheetRowInput);
            spreadsheetEntryBody.removeEventListener('click', handleSpreadsheetRowClick);
            spreadsheetEntryBody.addEventListener('click', handleSpreadsheetRowClick);
            // إضافة مستمع الـ autocomplete للمنتجات والعملاء
            setupSpreadsheetAutocomplete();
            // بعد أول تحميل للمنتجات من Firestore، أعد تمرير الأكواد المدخلة إن وُجدت
            setTimeout(() => {
                if (Array.isArray(state.products) && state.products.length) {
                    spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                        const codeInput = row.querySelector('.spreadsheet-product-code');
                        const customerId = spreadsheetCustomerSelect.value;
                        if (codeInput && codeInput.value.trim()) {
                            updateSpreadsheetPriceAndProductInfo(row, codeInput.value.trim(), customerId);
                            calculateSpreadsheetRowTotal(row);
                        }
                    });
                }
            }, 1200);
             // Clear and reset unified invoice number on page load
             unifiedInvoiceNumberInput.value = '';
        }
        
        // دالة لإعداد Autocomplete للمنتجات والعملاء
        function setupSpreadsheetAutocomplete() {
            // أضيف اسمع لحقل اسم العميل العلوي
            const customerNameInput = document.querySelector('input[placeholder*="اسم العميل"]') || document.createElement('input');
            
            // تحقق من وجود حقل اسم العميل (قد لا يكون موجود، لذا سنرتكز على select)
            // بدلاً من ذلك سنضيف autocomplete داخل الجدول مباشرة
            
            // إضافة مستمع على كل صفوف الجدول عند التفريغ
            spreadsheetEntryBody.addEventListener('input', function(e) {
                if (e.target.classList.contains('spreadsheet-product-name')) {
                    showProductAutocomplete(e.target);
                }
            }, true);
            
            // أيضاً إضافة مستمع للعميل في الأعلى (حقل اختيار العميل)
            // سنجعل autocomplete عند كتابة جزء من الاسم
            if (spreadsheetCustomerSelect) {
                // بدلاً من تعديل select، سنضيف حقل إدخال نصي بجانبه
                createCustomerSearchField();
            }
        }
        
        // دالة لإنشاء حقل بحث للعملاء بـ autocomplete
        function createCustomerSearchField() {
            try {
                let existingInput = document.getElementById('spreadsheet-customer-search');
                if (existingInput) return; // بالفعل موجود
                
                const container = spreadsheetCustomerSelect.parentElement;
                const searchDiv = document.createElement('div');
                searchDiv.style.position = 'relative';
                searchDiv.style.marginTop = '4px';
                
                const searchInput = document.createElement('input');
                searchInput.id = 'spreadsheet-customer-search';
                searchInput.type = 'text';
                searchInput.placeholder = 'ابحث باسم العميل (أول حروف الاسم)...';
                searchInput.className = 'w-full p-2 border border-gray-300 rounded-md text-sm';
                searchInput.style.direction = 'rtl';
                
                const suggestionsList = document.createElement('div');
                suggestionsList.id = 'spreadsheet-customer-suggestions';
                suggestionsList.className = 'absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-48 overflow-y-auto';
                suggestionsList.style.display = 'none';
                suggestionsList.style.direction = 'rtl';
                
                searchDiv.appendChild(searchInput);
                searchDiv.appendChild(suggestionsList);
                container.appendChild(searchDiv);
                
                // مستمع على حقل البحث
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    const suggestions = suggestionsList;
                    
                    if (searchTerm.length === 0) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    
                    // البحث عن عملاء مطابقين
                    const matches = state.customers.filter(c => 
                        c.name && c.name.toLowerCase().includes(searchTerm)
                    ).slice(0, 8); // عرض أول 8 نتائج
                    
                    if (matches.length === 0) {
                        suggestions.innerHTML = '<div class="p-2 text-gray-500 text-sm">لا توجد نتائج</div>';
                        suggestions.style.display = 'block';
                        return;
                    }
                    
                    suggestions.innerHTML = matches.map(customer => `
                        <div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-customer-id="${customer.id}" data-customer-name="${customer.name}">
                            ${customer.name}
                        </div>
                    `).join('');
                    suggestions.style.display = 'block';
                });
                
                // مستمع على الاقتراحات
                suggestionsList.addEventListener('click', function(e) {
                    const item = e.target.closest('[data-customer-id]');
                    if (item) {
                        const customerId = item.getAttribute('data-customer-id');
                        const customerName = item.getAttribute('data-customer-name');
                        
                        // تعيين العميل في select
                        spreadsheetCustomerSelect.value = customerId;
                        spreadsheetCustomerSelect.dispatchEvent(new Event('change'));
                        
                        // تنظيف حقل البحث
                        searchInput.value = customerName;
                        suggestionsList.style.display = 'none';
                    }
                });
                
                // إخفاء الاقتراحات عند النقر خارجه
                document.addEventListener('click', function(e) {
                    if (e.target !== searchInput && e.target !== suggestionsList && !suggestionsList.contains(e.target)) {
                        suggestionsList.style.display = 'none';
                    }
                });
            } catch(err) {
                console.warn('createCustomerSearchField error:', err);
            }
        }
        
        // دالة لعرض autocomplete لأسماء المنتجات
        function showProductAutocomplete(input) {
            try {
                const searchTerm = input.value.trim().toLowerCase();
                const td = input.parentElement;
                let suggestionsDiv = td.querySelector('.product-suggestions');
                
                // إنشاء div للاقتراحات إن لم يكن موجود
                if (!suggestionsDiv) {
                    suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'product-suggestions absolute bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-48 overflow-y-auto';
                    suggestionsDiv.style.display = 'none';
                    suggestionsDiv.style.direction = 'rtl';
                    suggestionsDiv.style.top = '100%';
                    suggestionsDiv.style.right = '0';
                    suggestionsDiv.style.minWidth = '200px';
                    td.style.position = 'relative';
                    td.appendChild(suggestionsDiv);
                }
                
                // إذا كان الحقل فارغ، أخفِ الاقتراحات
                if (searchTerm.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                // البحث عن منتجات مطابقة (من البداية)
                const matches = state.products.filter(p => {
                    const productName = p.name ? p.name.toLowerCase() : '';
                    const productCode = p.id ? p.id.toLowerCase() : '';
                    return productName.startsWith(searchTerm) || productCode.startsWith(searchTerm);
                }).slice(0, 8); // عرض أول 8 نتائج
                
                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="p-2 text-gray-500 text-sm">لا توجد منتجات مطابقة</div>';
                    suggestionsDiv.style.display = 'block';
                    return;
                }
                
                suggestionsDiv.innerHTML = matches.map(product => `
                    <div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-product-id="${product.id}" data-product-name="${product.name}">
                        <strong>${product.name}</strong> <span class="text-gray-500">(${product.id})</span>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
                
                // مستمع على الاقتراحات
                suggestionsDiv.removeEventListener('click', handleProductSuggestionClick);
                suggestionsDiv.addEventListener('click', function(e) {
                    handleProductSuggestionClick(e, input);
                });
                
            } catch(err) {
                console.warn('showProductAutocomplete error:', err);
            }
        }
        
        // دالة معالجة اختيار منتج من الاقتراحات
        function handleProductSuggestionClick(e, input) {
            const item = e.target.closest('[data-product-id]');
            if (!item) return;
            
            const productId = item.getAttribute('data-product-id');
            const productName = item.getAttribute('data-product-name');
            const row = input.closest('.spreadsheet-row');
            
            if (!row) return;
            
            // ملء الحقول
            input.value = productName;
            row.dataset.productId = productId;
            
            // تعديل حقل الكود أيضاً
            const codeInput = row.querySelector('.spreadsheet-product-code');
            if (codeInput) {
                codeInput.value = productId;
            }
            
            // تحديث السعر والمعلومات
            const customerId = spreadsheetCustomerSelect.value;
            updateSpreadsheetPriceAndProductInfo(row, productId, customerId);
            calculateSpreadsheetRowTotal(row);
            
            // إغلاق الاقتراحات
            const td = input.parentElement;
            const suggestionsDiv = td.querySelector('.product-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            
            // نقل التركيز للحقل التالي (الكمية)
            const quantityInput = row.querySelector('.spreadsheet-quantity');
            if (quantityInput) {
                quantityInput.focus();
            }
        }
        
        function handleSpreadsheetCustomerChange() { 
            const customerId = spreadsheetCustomerSelect.value; updateSpreadsheetTaxVisibility(customerId); if (!customerId) return; spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => { const productCode = row.querySelector('.spreadsheet-product-code').value.trim(); if (productCode) { updateSpreadsheetPriceAndProductInfo(row, productCode, customerId); } calculateSpreadsheetRowTotal(row); }); 
        }
        function handleSpreadsheetRowChange(e) { 
             if (e.target.classList.contains('spreadsheet-product-code')) { const row = e.target.closest('.spreadsheet-row'); const productCode = e.target.value.trim(); const customerId = spreadsheetCustomerSelect.value; if (!customerId) { customDialog({ message: 'الرجاء اختيار العميل أولاً.', title: 'تنبيه' }); e.target.value = ''; return; } if (productCode) { updateSpreadsheetPriceAndProductInfo(row, productCode, customerId); } else { row.querySelector('.spreadsheet-product-name').value = ''; row.querySelector('.spreadsheet-price').value = 0; row.querySelector('.spreadsheet-category').textContent = ''; row.dataset.productId = ''; row.querySelector('.spreadsheet-price').classList.remove('promotion-price-applied'); } calculateSpreadsheetRowTotal(row); } 
            // If collection type changed, show/hide partial amount input
            if (e.target.classList.contains('spreadsheet-collection')) {
                const row = e.target.closest('.spreadsheet-row');
                const partialInput = row.querySelector('.spreadsheet-partial-amount');
                if (partialInput) {
                    partialInput.style.display = (e.target.value === 'partial') ? 'inline-block' : 'none';
                }
            }
        }
        function handleSpreadsheetRowInput(e) { 
            if (e.target.classList.contains('spreadsheet-invoice-number') || e.target.classList.contains('spreadsheet-quantity') || e.target.classList.contains('spreadsheet-price') || e.target.classList.contains('spreadsheet-modified-price') || e.target.classList.contains('spreadsheet-discount')) { const row = e.target.closest('.spreadsheet-row'); calculateSpreadsheetRowTotal(row); } if (e.target.classList.contains('spreadsheet-invoice-number')) { const currentRow = e.target.closest('.spreadsheet-row'); const nextRow = currentRow.nextElementSibling; const nextInvoiceInput = nextRow ? nextRow.querySelector('.spreadsheet-invoice-number') : null; if (nextInvoiceInput && !nextInvoiceInput.value && e.target.value) { nextInvoiceInput.value = e.target.value; } } if (e.target.classList.contains('spreadsheet-tax-status-input')) { const value = e.target.value.trim(); if (value.toLowerCase() === 'تم') { e.target.value = 'تم'; } } 
        }
        function handleSpreadsheetRowClick(e) { 
            if (e.target.closest('.spreadsheet-delete-row-btn')) { const row = e.target.closest('.spreadsheet-row'); if (spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').length > 1) { row.remove(); updateSpreadsheetTaxVisibility(spreadsheetCustomerSelect.value); } else { customDialog({message: "لا يمكن حذف الصف الأخير.", title: "تنبيه"}); } } 
        }

                function addSpreadsheetRow() {
            const row = document.createElement('tr'); row.className = 'spreadsheet-row'; const customerId = spreadsheetCustomerSelect.value; const customer = findCustomer(customerId); const requiresFiling = customer && customer.requiresTaxFiling; const unifiedInvoiceNumber = unifiedInvoiceNumberInput.value.trim(); const lastRow = spreadsheetEntryBody.lastElementChild; let initialInvoiceNumber = unifiedInvoiceNumber || (lastRow ? lastRow.querySelector('.spreadsheet-invoice-number')?.value || '' : ''); const taxInputHtml = `<td class="spreadsheet-tax-cell" style="display: ${requiresFiling ? 'table-cell' : 'none'};"><input type="text" class="spreadsheet-tax-status-input" placeholder="تم / علامة" value=""></td>`; 
            // NOTE: Removed min="1" from spreadsheet-quantity input
            row.innerHTML = `<td><input type="number" class="spreadsheet-invoice-number" placeholder="رقم..." value="${initialInvoiceNumber}"></td><td><input type="text" class="spreadsheet-product-code" placeholder="الكود" size="5"></td><td><input type="text" class="spreadsheet-product-name" placeholder="اسم الصنف"></td><td><input type="number" class="spreadsheet-quantity" value="" placeholder="0"></td><td><input type="number" class="spreadsheet-price" step="any" placeholder="السعر" readonly></td>
<td><input type="number" class="spreadsheet-modified-price" step="any" placeholder="تعديل..."></td><td><input type="number" class="spreadsheet-discount" step="any" placeholder="%" min="0" max="100"></td><td class="spreadsheet-category text-center text-xs"></td><td><select class="spreadsheet-collection"><option value="paid">كاش</option><option value="due">آجل</option><option value="partial">جزئي</option></select><input type="number" class="spreadsheet-partial-amount" step="any" placeholder="جزئي" style="display:none;width:90px;margin-top:4px;margin-right:6px"></td>${taxInputHtml}<td class="spreadsheet-total text-center font-semibold"></td><td><button type="button" class="spreadsheet-delete-row-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>`; 
            spreadsheetEntryBody.appendChild(row); updateIcons();
        }

        async function saveAllSpreadsheetEntries() {
            const repName = spreadsheetRepSelect.value;
            const customerId = spreadsheetCustomerSelect.value;
            const dateValue = spreadsheetDateInput.value;
            const customer = findCustomer(customerId);
            const requiresTaxFiling = customer?.requiresTaxFiling || false;

            if (!repName || !customerId || !dateValue) {
                await customDialog({ message: 'الرجاء اختيار المندوب والعميل والتاريخ أولاً.', title: 'بيانات ناقصة', confirmClass: 'bg-red-600 hover:bg-red-700' });
                return;
            }

            const invoicesToSave = new Map();
            const existingInvoiceNumbers = new Set(state.sales.map(s => s.invoiceNumber.toString()));
            let isValid = true;
            let dataFound = false;

            spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                const invoiceNumberInput = row.querySelector('.spreadsheet-invoice-number');
                const productCodeInput = row.querySelector('.spreadsheet-product-code');
                const productNameInput = row.querySelector('.spreadsheet-product-name');
                const taxStatusInput = row.querySelector('.spreadsheet-tax-status-input');
                const rawInvoiceNumber = invoiceNumberInput.value.trim();
                const invoiceNumber = rawInvoiceNumber ? parseInt(rawInvoiceNumber) : null;
                const productId = row.dataset.productId;
                const productNameValue = productNameInput ? productNameInput.value.trim() : '';
                const quantity = parseInt(row.querySelector('.spreadsheet-quantity').value);
                const originalPrice = parseFloat(row.querySelector('.spreadsheet-price').value);
                const modifiedPrice = parseFloat(row.querySelector('.spreadsheet-modified-price').value);
                const price = !isNaN(modifiedPrice) && modifiedPrice > 0 ? modifiedPrice : originalPrice;
                const discount = parseFloat(row.querySelector('.spreadsheet-discount').value) || 0;
                const collection = row.querySelector('.spreadsheet-collection').value;
                const partialAmount = parseFloat(row.querySelector('.spreadsheet-partial-amount')?.value) || 0;
                const taxFilingStatus = taxStatusInput ? taxStatusInput.value.trim() : '';

                [invoiceNumberInput, productCodeInput, row.querySelector('.spreadsheet-quantity'), row.querySelector('.spreadsheet-price'), row.querySelector('.spreadsheet-discount')].forEach(el => el.classList.remove('border-red-500', 'border-2'));
                if (productNameInput) productNameInput.classList.remove('border-red-500', 'border-2');
                if (taxStatusInput) taxStatusInput.classList.remove('border-red-500', 'border-2');

                // Special-case: product code '100' is used as a cancelled-invoice placeholder
                const codeValue = (productCodeInput && productCodeInput.value) ? productCodeInput.value.trim() : '';
                const isCanceledCode = (codeValue === '100') || (productId === '100');

                if (isCanceledCode) {
                    // allow saving a cancelled invoice row even without price/quantity
                    dataFound = true;

                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0 || (!invoicesToSave.has(invoiceNumber) && existingInvoiceNumbers.has(rawInvoiceNumber))) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    if (invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).collectionStatus !== collection) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    if (!isValid) return;

                    if (!invoicesToSave.has(invoiceNumber)) {
                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? partialAmount : 0, isCanceled: true });
                    } else {
                        invoicesToSave.get(invoiceNumber).isCanceled = true;
                    }

                    // skip normal item validation for this row
                    return;
                }

                if (productId || productNameValue) {
                    dataFound = true;
                    
                    // التحقق من أن المنتج موجود فعلاً
                    const product = getProductDetailsByCode(productId);
                    if (!product) {
                        if (productNameInput) {
                            productNameInput.classList.add('border-red-500', 'border-2');
                        }
                        if (productCodeInput) {
                            productCodeInput.classList.add('border-red-500', 'border-2');
                        }
                        isValid = false;
                        return;
                    }
                    
                    if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <= 0 || (!invoicesToSave.has(invoiceNumber) && existingInvoiceNumbers.has(rawInvoiceNumber))) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    if (invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).collectionStatus !== collection) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    // If collection is partial, ensure partial amount consistency across rows of same invoice
                    if (collection === 'partial' && invoicesToSave.has(invoiceNumber) && typeof invoicesToSave.get(invoiceNumber).partialAmount !== 'undefined' && invoicesToSave.get(invoiceNumber).partialAmount !== partialAmount) {
                        invoiceNumberInput.classList.add('border-red-500', 'border-2'); isValid = false;
                    }

                    // Quantity cannot be zero (but can be negative)
                    if (!quantity || quantity === 0) { row.querySelector('.spreadsheet-quantity').classList.add('border-red-500', 'border-2'); isValid = false; }

                    if (isNaN(price) || price <= 0) { row.querySelector('.spreadsheet-price').classList.add('border-red-500', 'border-2'); isValid = false; }
                    if (isNaN(discount) || discount < 0 || discount > 100) { row.querySelector('.spreadsheet-discount').classList.add('border-red-500', 'border-2'); isValid = false; }

                    if (requiresTaxFiling && invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).taxFilingStatus !== taxFilingStatus) {
                        taxStatusInput.classList.add('border-red-500', 'border-2'); isValid = false; return;
                    }

                    if (!isValid) return;

                    if (!invoicesToSave.has(invoiceNumber)) {
                        invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection === 'partial' ? partialAmount : 0 });
                    }

                    const itemSubtotal = price * quantity;
                    const itemFinalPrice = itemSubtotal * (1 - discount / 100);
                    const invoiceData = invoicesToSave.get(invoiceNumber);
                    invoiceData.items.push({ productId, quantity, price, discountPercent: discount, itemFinalPrice });
                    invoiceData.totalSales += itemFinalPrice;
                    invoiceData.taxFilingStatus = taxFilingStatus;
                    if (collection === 'partial') invoiceData.partialAmount = partialAmount;
                } else if (productCodeInput.value.trim()) {
                    productCodeInput.classList.add('border-red-500', 'border-2'); isValid = false;
                }
            });

            if (!dataFound) {
                await customDialog({ message: 'الجدول فارغ. الرجاء إدخال بيانات الفواتير أولاً.', title: 'تنبيه' });
                return;
            }

            if (!isValid) {
                await customDialog({ message: 'توجد أخطاء في بعض الحقول (مميزة بالأحمر). الرجاء تصحيحها والتأكد من عدم تكرار رقم فاتورة مسجلة مسبقًا.', title: 'خطأ في الإدخال', confirmClass: 'bg-red-600 hover:bg-red-700' });
                return;
            }

            let savedCount = 0;
            const dateISO = new Date(dateValue + 'T12:00:00Z').toISOString();
            const now = new Date().toISOString();
            const rep = findRep(repName);

            // Persist every built invoice to Firestore so it survives refresh
            for (const [invoiceNumber, invoiceData] of invoicesToSave.entries()) {
                // If this invoice was marked cancelled via special code, force canceled status
                let finalTotal = parseFloat((invoiceData.totalSales || 0).toFixed(2));
                let status;
                if (invoiceData.isCanceled) {
                    status = 'canceled';
                    finalTotal = 0;
                } else {
                    status = finalTotal < 0 ? 'due' : invoiceData.collectionStatus;
                }
                const paidAmount = (status === 'paid') ? finalTotal : (status === 'partial' ? (invoiceData.partialAmount || 0) : 0);

                const newSale = {
                    id: Date.now().toString() + savedCount,
                    date: dateISO,
                    createdAt: now,
                    updatedAt: now,
                    repName: repName,
                    customerId: customerId,
                    invoiceNumber: invoiceNumber,
                    items: invoiceData.items.map(i => ({
                        productId: i.productId,
                        quantity: i.quantity,
                        price: i.price,
                        discountPercent: i.discountPercent,
                        itemTotal: i.itemFinalPrice,
                    })),
                    total: finalTotal,
                    status,
                    isCanceled: !!invoiceData.isCanceled,
                    paidAmount: paidAmount,
                    // Persist partial payment into firstPayment for immediate visibility in Cash
                    firstPayment: status === 'partial' ? (invoiceData.partialAmount || 0) : (paidAmount || 0),
                    discount: 0,
                    notes: 'تم الإدخال عبر الإدخال السريع',
                    taxFilingStatus: invoiceData.taxFilingStatus
                };

                try {
                    await addSale(newSale);
                    savedCount++;
                } catch (e) {
                    console.warn('Bulk save failed for invoice', invoiceNumber, e);
                }
            }

            if (savedCount > 0) {
                const maxInvoiceNumber = Math.max(...Array.from(invoicesToSave.keys()).map(Number));
                if (rep && rep.nextInvoiceNumber <= maxInvoiceNumber) { rep.nextInvoiceNumber = maxInvoiceNumber + 1; }
                renderAll();
                await customDialog({ message: `تم حفظ ${savedCount} فاتورة بنجاح. ${rep ? `رقم الفاتورة القادمة للمندوب ${repName} هو ${rep.nextInvoiceNumber}.` : ''}`, title: 'حفظ ناجح', confirmClass: 'bg-green-600 hover:bg-green-700' });
                initializeSpreadsheetPage();
            } else {
                await customDialog({ message: 'لم يتم حفظ أي فواتير. قد تكون البيانات غير كاملة.', title: 'تنبيه' });
            }
        }

        function renderAll() {
            state.sales.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); saveState(); const repFilterSelect = document.getElementById('dashboard-rep-filter'); const currentFilter = repFilterSelect.value; populateRepDropdown(repFilterSelect, currentFilter);
            const textFilter = document.getElementById('search-sales-text').value; const dateFilter = document.getElementById('search-sales-date').value; const custFilter = document.getElementById('search-customers').value; const prodFilter = document.getElementById('search-products').value;
            scheduleRender('dashboard-main', ()=>{ try { renderDashboard(); } catch(e){} try { renderDispatchPage(); } catch(e){} });
            scheduleRender('sales-list', ()=>{ try { renderAllSales(textFilter, dateFilter); } catch(e){} });
            scheduleRender('customers-list', ()=>{ try { renderCustomers(custFilter); } catch(e){} });
            scheduleRender('reps-list', ()=>{ try { renderReps(); } catch(e){} });
            scheduleRender('settings-products', ()=>{ try { renderSettings(prodFilter); } catch(e){} });
            scheduleRender('promotions', ()=>{ try { renderPromotions(); } catch(e){} });
            scheduleRender('debts', ()=>{ try { renderDebts(); } catch(e){} });
            scheduleRender('rep-debts', ()=>{ try { renderRepDebts(); } catch(e){} });
            // RENDER CHARTS ONCE ON DASHBOARD LOAD, not on every renderAll()
            // if (document.getElementById('page-dashboard').classList.contains('active')) { renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); }
            const statementCustomerList = document.getElementById('statement-customer-list'); const statementCustomerSearch = document.getElementById('statement-customer-search'); if (statementCustomerList && statementCustomerSearch) { statementCustomerSearch.value = ''; updateCustomerList(''); } updateIcons(); 
            // Ensure Cash view stays in sync whenever main UI re-renders (e.g., after background sync / saves)
            try { if (typeof renderCash === 'function') renderCash(); } catch (e) { console.warn('renderAll: renderCash failed', e); }
            // لا تعرض أي لوحة تشخيص/استرجاع محلية عند البداية
            // نعتمد الآن على Firestore فقط للمزامنة.
        }
        
        // --- NEW REPORTING FUNCTIONS ---
        function initializeReportsPage() {
            populateRepDropdownReports(dailyReportRepSelect);
            populateRepDropdownReports(rangeReportRepSelect);
            populateRepDropdownReports(monthlyReportRepSelect);
            populateRepDropdownReports(document.getElementById('recon-report-rep'));
            
            // Set default date/month
            const today = new Date().toISOString().split('T')[0];
            dailyReportDateInput.value = today;
            rangeStartDateInput.value = today;
            rangeEndDateInput.value = today;
            
            const currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
            monthlyReportMonthInput.value = currentMonth;
            const targetsMonthInput = document.getElementById('targets-month');
            if (targetsMonthInput) targetsMonthInput.value = currentMonth;
            const customerTargetsMonthInput = document.getElementById('customer-targets-month');
            if (customerTargetsMonthInput) customerTargetsMonthInput.value = currentMonth;
            
            // Set initial content area based on active subnav item
            const activeReportSection = reportsSubnav.querySelector('.reports-subnav-item.active')?.dataset.reportSection || 'daily';
            showReportContent(activeReportSection);
        }

        function showReportContent(section) {
            reportContentAreas.forEach(area => {
                area.classList.add('hidden');
                area.classList.remove('active');
            });
            const activeArea = document.querySelector(`#page-reports [data-report-content="${section}"]`);
            if (activeArea) {
                activeArea.classList.remove('hidden');
                activeArea.classList.add('active');
            }
            // عرض تلقائي لتقرير التارجت عند فتح التبويب
            if (section === 'targets') {
                try { generateTargetsReport(); return; } catch(e){}
            }
            if (section === 'customer-targets') {
                try { generateCustomerTargetsReport(); return; } catch(e){}
            }
            reportOutputArea.innerHTML = '<p class="text-center text-gray-500 mt-8">اضغط على زر "عرض التقرير" لإنشاء التقرير.</p>';
        }

        function printSection(elementId) {
            const printElement = document.getElementById(elementId);
            if (!printElement) return;

            printElement.classList.add('printable-content');
            
            // Use a timeout to ensure styles are applied before the print dialog blocks the main thread
            setTimeout(() => {
                window.print();
                // Another timeout to remove the class after the print dialog has opened
                setTimeout(() => {
                    printElement.classList.remove('printable-content');
                }, 500);
            }, 50);
        }

        // Internal helper: capture element to canvas with high-quality defaults
        async function captureElementCanvas(element, scale = 2) {
            // احتفظ بالتنسيق الأصلي قدر الإمكان (كان التعديل السابق يسبب إنحراف المحاذاة)
            const prev = {
                boxShadow: element.style.boxShadow,
                filter: element.style.filter,
                transform: element.style.transform
            };
            element.style.boxShadow = 'none';
            element.style.filter = 'none';
            element.style.transform = 'none';
            try {
                await new Promise(r => requestAnimationFrame(r));
                const canvas = await html2canvas(element, {
                    scale,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    ignoreElements: el => el.classList.contains('no-print')
                });
                return canvas;
            } finally {
                element.style.boxShadow = prev.boxShadow;
                element.style.filter = prev.filter;
                element.style.transform = prev.transform;
            }
        }

        // Upload a Blob to Firebase Storage and return a public URL
        async function uploadImageBlobToStorage(blob, pathPrefix = 'shares/exports') {
            // Fallback سريع إذا كان الملف يُفتح من file:// حيث يمنع Firebase طلبات التخزين (CORS origin null)
            if (location.protocol === 'file:') {
                console.warn('uploadImageBlobToStorage: تشغيل من file:// => التخطي وإرجاع null');
                return null; // يسمح للدالة المستدعية ببناء مشاركة بديلة
            }
            if (!window.storage) throw new Error('Firebase Storage غير مهيأ');
            try {
                const uid = (window.auth && auth.currentUser && auth.currentUser.uid) ? auth.currentUser.uid : 'anon';
                const path = `${pathPrefix}/${uid}/${Date.now()}.png`;
                const ref = storage.ref().child(path);
                const metadata = { contentType: 'image/png', cacheControl: 'public, max-age=31536000' };
                const snap = await ref.put(blob, metadata);
                const url = await snap.ref.getDownloadURL();
                return url;
            } catch(e){
                console.warn('uploadImageBlobToStorage: فشل الرفع، سيتم استخدام مشاركة بديلة', e);
                return null;
            }
        }

        async function generateReportImage(elementId) {
            const reportElement = document.getElementById(elementId);
            if (!reportElement) {
                await customDialog({ title: 'خطأ', message: 'لم يتم العثور على محتوى التقرير لنسخه.' });
                return;
            }

            try {
                showLoading('جارٍ تحويل التقرير إلى صورة...');
                const isRecon = elementId === 'recon-report-output';
                let canvas;
                if (isRecon){
                    reportElement.classList.add('recon-export-scale');
                    canvas = await captureElementCanvas(reportElement, 4);
                    reportElement.classList.remove('recon-export-scale');
                } else {
                    canvas = await captureElementCanvas(reportElement, 2);
                }
                hideLoading();

                const imageUrl = canvas.toDataURL('image/png');
                const previewContainer = document.getElementById('image-preview-container');
                const downloadBtn = document.getElementById('download-image-btn');
                const imagePreviewModal = document.getElementById('image-preview-modal');

                if (!previewContainer || !downloadBtn || !imagePreviewModal) {
                    await customDialog({title: 'خطأ', message: 'عناصر واجهة معاينة الصورة غير موجودة.'});
                    return;
                }

                previewContainer.innerHTML = '';
                const img = document.createElement('img');
                img.src = imageUrl;
                // عرض العرض الحقيقي للبكسلات عند التسوية النهائية (قد يكون كبيراً)
                if (isRecon) {
                    img.style.width = canvas.width + 'px';
                    img.style.maxWidth = '100%';
                    previewContainer.style.maxWidth = canvas.width + 'px';
                    previewContainer.style.overflow = 'auto';
                } else {
                    img.className = 'w-full h-auto';
                }
                previewContainer.appendChild(img);

                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = imageUrl;
                    a.download = `report-${elementId}.png`;
                    a.click();
                };

                openModal(imagePreviewModal);

            } catch (err) {
                console.error('html2canvas failed:', err);
                hideLoading();
                await customDialog({ title: 'خطأ', message: 'حدث خطأ أثناء إنشاء صورة التقرير.' });
            }
        }

        // Share settlement report to WhatsApp by uploading to Storage and opening wa.me link
        async function shareSettlementWhatsApp(elementId) {
            const el = document.getElementById(elementId);
            if (!el) { await customDialog({title:'خطأ', message:'لم يتم العثور على تقرير التسوية.'}); return; }
            try {
                showLoading('جارٍ تجهيز مشاركة واتساب...');
                const canvas = await captureElementCanvas(el, 2);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                if (!blob) throw new Error('فشل إنشاء الصورة');
                const url = await uploadImageBlobToStorage(blob, 'shares/settlements');
                hideLoading();

                const date = (window.dailyReportDateInput && dailyReportDateInput.value) ? dailyReportDateInput.value : '';
                const rep = (window.dailyReportRepSelect && dailyReportRepSelect.value && dailyReportRepSelect.value !== 'all') ? dailyReportRepSelect.value : '';
                const msg = `تسوية ${rep ? rep + ' - ' : ''}${date ? date : ''}\n${url}`;

                const wa = `https://wa.me/?text=${encodeURIComponent(msg)}`;
                window.open(wa, '_blank');
            } catch (e) {
                console.error('WhatsApp share failed', e);
                hideLoading();
                await customDialog({title:'خطأ', message:'تعذر مشاركة تقرير التسوية على واتساب.'});
            }
        }

        async function exportSelectedRows(exportType) {
            const checkedBoxes = document.querySelectorAll('#total-bills-table-body input.total-bill-row-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                await customDialog({ title: 'لم يتم التحديد', message: 'الرجاء تحديد صف واحد على الأقل لتصديره.' });
                return;
            }

            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
            const selectedSales = state.sales.filter(s => selectedIds.includes(s.id));

            // Check if total should be included
            const includeTotalCheckbox = document.getElementById('include-total-in-export');
            let totalHtml = '';
            if (includeTotalCheckbox && includeTotalCheckbox.checked) {
                const totalContainer = document.getElementById('total-bills-summary-container');
                if (totalContainer) {
                    const clonedTotal = totalContainer.cloneNode(true);
                    const checkboxDiv = clonedTotal.querySelector('div:last-child');
                    if (checkboxDiv) checkboxDiv.remove(); // Remove the checkbox from the cloned element
                    clonedTotal.classList.add('mb-4');
                    totalHtml = clonedTotal.outerHTML;
                }
            }

            // Re-create the table header, but without the checkbox column
            const originalThead = document.querySelector('#total-bills-table thead');
            const clonedThead = originalThead.cloneNode(true);
            clonedThead.querySelector('th').remove(); // Remove the first th (checkbox)
            
            // Build the new table rows
            const rowsHtml = selectedSales.map(sale => {
                const customer = findCustomer(sale.customerId);
                const category = sale.items.length > 0 ? (findProduct(sale.items[0].productId)?.category || 'N/A') : 'N/A';
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-bold">${sale.invoiceNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${customer ? customer.name : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${sale.repName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold">${formatCurrency(sale.total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${getStatusBadge(sale.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${category}</td>
                    </tr>
                `;
            }).join('');

            // Create a temporary printable element
            const tempExportElement = document.createElement('div');
            tempExportElement.id = 'temp-export-area';
            tempExportElement.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">تقرير الصفوف المحددة</h2>
                ${totalHtml}
                <table class="min-w-full divide-y divide-gray-200" style="direction: rtl;">
                    ${clonedThead.outerHTML}
                    <tbody class="bg-white divide-y divide-gray-200">${rowsHtml}</tbody>
                </table>
            `;
            tempExportElement.style.position = 'absolute';
            tempExportElement.style.left = '-9999px';
            document.body.appendChild(tempExportElement);

            // Call the appropriate export function
            if (exportType === 'print') {
                await printSection('temp-export-area');
            } else if (exportType === 'image') {
                await generateReportImage('temp-export-area');
            }

            // Clean up
            document.body.removeChild(tempExportElement);
        }

        function generateDailyReport() {
            const date = dailyReportDateInput.value;
            const repName = dailyReportRepSelect.value;
            const chainId = document.getElementById('daily-report-chain').value;
            
            if (!date) {
                customDialog({ message: 'الرجاء تحديد تاريخ التقرير اليومي.', title: 'بيانات ناقصة' });
                return;
            }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const salesForDay = state.sales.filter(s => {
                const saleDate = new Date(s.date).toISOString().split('T')[0];
                const matchesDate = saleDate === date;
                const matchesRep = (repName === 'all' || s.repName === repName);
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                return matchesDate && matchesRep && matchesChain;
            }).sort((a, b) => a.invoiceNumber - b.invoiceNumber);

            let totalSales = 0;
            let totalReturns = 0;
            
            const reportRows = salesForDay.map(sale => {
                const customer = findCustomer(sale.customerId);
                const isReturn = sale.total < 0;
                
                if (isReturn) {
                    totalReturns += sale.total;
                } else {
                    totalSales += sale.total;
                }

                const totalClass = isReturn ? 'text-red-600 font-bold' : 'text-green-600 font-bold';

                return `<tr class="border-b ${isReturn ? 'bg-red-100/50' : ''}">
                    <td class="px-4 py-2">${sale.invoiceNumber}</td>
                    <td class="px-4 py-2">${customer?.name || 'عميل محذوف'}</td>
                    <td class="px-4 py-2">${sale.repName || 'غير محدد'}</td>
                    <td class="px-4 py-2 text-center ${totalClass}">${formatCurrency(sale.total)}</td>
                    <td class="px-4 py-2 text-center">${getStatusBadge(sale.status)}</td>
                </tr>`;
            }).join('');
            
            const netSales = totalSales + totalReturns; // Returns are already negative
            const chainName = chainId ? document.querySelector('#daily-report-chain option[value="' + chainId + '"]').textContent : '';

            let outputHTML = `
                <div id="daily-report-output" class="bg-white p-4 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold mb-4">تقرير المبيعات اليومي لـ: ${date} (${repName === 'all' ? 'جميع المناديب' : repName}${chainId ? ' - السلسلة: ' + chainName : ''})</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-700">إجمالي المبيعات:</p>
                            <p class="text-xl font-bold text-green-800">${formatCurrency(totalSales)}</p>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="text-sm text-red-700">إجمالي المرتجعات:</p>
                            <p class="text-xl font-bold text-red-800">${formatCurrency(totalReturns)}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-700">صافي المبيعات:</p>
                            <p class="text-xl font-bold text-blue-800">${formatCurrency(netSales)}</p>
                        </div>
                    </div>
                    
                    ${salesForDay.length > 0 ? `
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">رقم الفاتورة</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">العميل</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المندوب</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الإجمالي</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الحالة</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-100">
                                    ${reportRows}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p class="text-center text-gray-500 p-4">لا توجد فواتير أو مرتجعات مسجلة في هذا التاريخ.</p>'}
                </div>
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('daily-report-output')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> طباعة</button>
                    <button onclick="generateReportImage('daily-report-output')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> نسخ كصورة</button>
                </div>
            `;
            
            reportOutputArea.innerHTML = outputHTML;
            updateIcons();
        }

        // Placeholder for other reports (to be implemented later if requested)
        function generateRangeReport() {
            const start = rangeStartDateInput.value;
            const end = rangeEndDateInput.value;
            const repName = rangeReportRepSelect.value;
            const chainId = document.getElementById('range-report-chain').value;
            
            if (!start || !end) {
                customDialog({ message: 'الرجاء تحديد تاريخ البداية والنهاية.', title: 'بيانات ناقصة' });
                return;
            }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const startDate = new Date(start + 'T00:00:00Z');
            const endDate = new Date(end + 'T23:59:59Z');
            const salesInRange = state.sales.filter(s => {
                const d = new Date(s.date);
                const matchesDate = d >= startDate && d <= endDate;
                const matchesRep = repName === 'all' || s.repName === repName;
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                return matchesDate && matchesRep && matchesChain;
            }).sort((a,b)=> new Date(a.date) - new Date(b.date));

            let totalSales = 0; let totalReturns = 0;
            const rowsHtml = salesInRange.map(sale => {
                const customer = findCustomer(sale.customerId);
                const isReturn = sale.total < 0;
                if (isReturn) totalReturns += sale.total; else totalSales += sale.total;
                const totalClass = isReturn ? 'text-red-600 font-bold' : 'text-green-600 font-bold';
                return `<tr class="border-b ${isReturn ? 'bg-red-50' : ''}">\n                    <td class="px-3 py-1 text-center">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>\n                    <td class="px-3 py-1">${sale.invoiceNumber || ''}</td>\n                    <td class="px-3 py-1">${customer?.name || 'عميل محذوف'}</td>\n                    <td class="px-3 py-1">${sale.repName || ''}</td>\n                    <td class="px-3 py-1 text-center ${totalClass}">${formatCurrency(sale.total)}</td>\n                    <td class="px-3 py-1 text-center">${getStatusBadge(sale.status)}</td>\n                </tr>`;
            }).join('');
            const netSales = totalSales + totalReturns;
            const chainName = chainId ? document.querySelector('#range-report-chain option[value="' + chainId + '"]').textContent : '';

            // تجميع يومي مختصر
            const dailyMap = new Map();
            salesInRange.forEach(s => {
                const dayKey = new Date(s.date).toISOString().split('T')[0];
                const prev = dailyMap.get(dayKey) || { sales:0, returns:0 };
                if (s.total < 0) prev.returns += s.total; else prev.sales += s.total;
                dailyMap.set(dayKey, prev);
            });
            const dailyRows = Array.from(dailyMap.entries()).sort((a,b)=> new Date(a[0]) - new Date(b[0]))
                .map(([day, agg]) => {
                    const net = agg.sales + agg.returns;
                    return `<tr class="border-b">\n                        <td class="px-2 py-1">${day}</td>\n                        <td class="px-2 py-1 text-green-700 font-semibold">${formatCurrency(agg.sales)}</td>\n                        <td class="px-2 py-1 text-red-700 font-semibold">${formatCurrency(agg.returns)}</td>\n                        <td class="px-2 py-1 text-blue-700 font-semibold">${formatCurrency(net)}</td>\n                    </tr>`; }).join('');

            reportOutputArea.innerHTML = `
                <div id="range-report-output" class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">تقرير الفترة من ${start} إلى ${end} (${repName === 'all' ? 'جميع المناديب' : repName})</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                        <div class="p-2 bg-green-50 rounded"><p class="text-xs text-green-700">إجمالي المبيعات</p><p class="text-lg font-bold text-green-800">${formatCurrency(totalSales)}</p></div>
                        <div class="p-2 bg-red-50 rounded"><p class="text-xs text-red-700">إجمالي المرتجعات</p><p class="text-lg font-bold text-red-800">${formatCurrency(totalReturns)}</p></div>
                        <div class="p-2 bg-blue-50 rounded"><p class="text-xs text-blue-700">صافي المبيعات</p><p class="text-lg font-bold text-blue-800">${formatCurrency(netSales)}</p></div>
                    </div>
                    <h4 class="font-semibold mb-2">ملخص يومي</h4>
                    ${dailyRows ? `<table class="min-w-full mb-4 text-sm"><thead class="bg-gray-50"><tr><th class="px-2 py-1 text-right">اليوم</th><th class="px-2 py-1 text-center">مبيعات</th><th class="px-2 py-1 text-center">مرتجعات</th><th class="px-2 py-1 text-center">صافي</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<p class="text-gray-500">لا بيانات في هذه الفترة.</p>'}
                    <h4 class="font-semibold mb-2">الفواتير التفصيلية</h4>
                    ${rowsHtml ? `<div class="overflow-x-auto border rounded"><table class="min-w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-3 py-1">التاريخ</th><th class="px-3 py-1">رقم</th><th class="px-3 py-1">العميل</th><th class="px-3 py-1">المندوب</th><th class="px-3 py-1">الإجمالي</th><th class="px-3 py-1">الحالة</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>` : '<p class="text-gray-500">لا فواتير ضمن النطاق.</p>'}
                </div>
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('range-report-output')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> طباعة</button>
                    <button onclick="generateReportImage('range-report-output')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> نسخ كصورة</button>
                </div>
            `;
            updateIcons();
        }

        function generateMonthlyReport() {
            const month = monthlyReportMonthInput.value; // YYYY-MM
            const repName = monthlyReportRepSelect.value;
            const chainId = document.getElementById('monthly-report-chain').value;
            
            if (!month) { customDialog({ message: 'الرجاء اختيار شهر.', title: 'بيانات ناقصة' }); return; }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const [yearStr, monthStr] = month.split('-');
            const year = parseInt(yearStr,10); const m = parseInt(monthStr,10) - 1;
            const startDate = new Date(Date.UTC(year, m, 1));
            const endDate = new Date(Date.UTC(year, m+1, 0, 23,59,59));
            const monthSales = state.sales.filter(s => {
                const d = new Date(s.date);
                const matchesDate = d >= startDate && d <= endDate;
                const matchesRep = repName === 'all' || s.repName === repName;
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                return matchesDate && matchesRep && matchesChain;
            });
            let totalSales = 0; let totalReturns = 0;
            const byRep = new Map();
            monthSales.forEach(s => {
                const key = s.repName || 'غير محدد';
                const agg = byRep.get(key) || { sales:0, returns:0 };
                if (s.total < 0) { agg.returns += s.total; totalReturns += s.total; } else { agg.sales += s.total; totalSales += s.total; }
                byRep.set(key, agg);
            });
            const netSales = totalSales + totalReturns;
            const repRows = Array.from(byRep.entries()).map(([rep, agg]) => {
                const net = agg.sales + agg.returns;
                return `<tr class="border-b">\n                    <td class="px-3 py-1">${rep}</td>\n                    <td class="px-3 py-1 text-center text-green-700 font-semibold">${formatCurrency(agg.sales)}</td>\n                    <td class="px-3 py-1 text-center text-red-700 font-semibold">${formatCurrency(agg.returns)}</td>\n                    <td class="px-3 py-1 text-center text-blue-700 font-semibold">${formatCurrency(net)}</td>\n                </tr>`; }).join('');
            // أفضل 5 عملاء حسب صافي الإجمالي
            const customerAgg = new Map();
            monthSales.forEach(s => {
                const cid = s.customerId || 'unknown';
                const ag = customerAgg.get(cid) || { net:0 };
                ag.net += s.total; customerAgg.set(cid, ag);
            });
            const chainName = chainId ? document.querySelector('#monthly-report-chain option[value="' + chainId + '"]').textContent : '';
            const topCustomers = Array.from(customerAgg.entries()).sort((a,b)=> b[1].net - a[1].net).slice(0,5)
                .map(([cid, ag]) => `<tr class="border-b"><td class="px-2 py-1">${findCustomer(cid)?.name || 'غير معروف'}</td><td class="px-2 py-1 text-center font-semibold">${formatCurrency(ag.net)}</td></tr>`).join('');

            reportOutputArea.innerHTML = `
                <div id="monthly-report-output" class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">التقرير الشهري ${month} (${repName === 'all' ? 'جميع المناديب' : repName})</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                        <div class="p-2 bg-green-50 rounded"><p class="text-xs text-green-700">إجمالي المبيعات</p><p class="text-lg font-bold text-green-800">${formatCurrency(totalSales)}</p></div>
                        <div class="p-2 bg-red-50 rounded"><p class="text-xs text-red-700">إجمالي المرتجعات</p><p class="text-lg font-bold text-red-800">${formatCurrency(totalReturns)}</p></div>
                        <div class="p-2 bg-blue-50 rounded"><p class="text-xs text-blue-700">صافي المبيعات</p><p class="text-lg font-bold text-blue-800">${formatCurrency(netSales)}</p></div>
                    </div>
                    <h4 class="font-semibold mb-2">ملخص حسب المندوب</h4>
                    ${repRows ? `<table class="min-w-full text-sm mb-4"><thead class="bg-gray-50"><tr><th class="px-3 py-1 text-right">المندوب</th><th class="px-3 py-1 text-center">مبيعات</th><th class="px-3 py-1 text-center">مرتجعات</th><th class="px-3 py-1 text-center">صافي</th></tr></thead><tbody>${repRows}</tbody></table>` : '<p class="text-gray-500">لا بيانات.</p>'}
                    <h4 class="font-semibold mb-2">أفضل العملاء (صافي)</h4>
                    ${topCustomers ? `<table class="text-sm mb-4"><thead class="bg-gray-50"><tr><th class="px-2 py-1 text-right">العميل</th><th class="px-2 py-1 text-center">الصافي</th></tr></thead><tbody>${topCustomers}</tbody></table>` : '<p class="text-gray-500">لا عملاء.</p>'}
                </div>
                <div class="mt-4 flex gap-2 no-print">
                    <button onclick="printSection('monthly-report-output')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> طباعة</button>
                    <button onclick="generateReportImage('monthly-report-output')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> نسخ كصورة</button>
                </div>
            `;
            updateIcons();
        }

        // ===== Targets Report =====
        function generateTargetsReport(){
            const monthVal = (document.getElementById('targets-month')?.value)||'';
            const chainId = (document.getElementById('targets-chain-filter')?.value)||'';
            
            if (!monthVal){ customDialog({title:'بيانات ناقصة', message:'اختر شهر التارجت.'}); return; }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }
            
            const [yearStr, monthStr] = monthVal.split('-');
            const year = parseInt(yearStr,10); const m = parseInt(monthStr,10)-1;
            const monthStart = new Date(Date.UTC(year,m,1));
            const monthEnd = new Date(Date.UTC(year,m+1,0,23,59,59));
            const today = new Date();
            const daysInMonth = new Date(year,m+1,0).getDate();
            const todayDay = (today.getMonth()===m && today.getFullYear()===year) ? today.getDate() : daysInMonth; // إذا شهر سابق اعتبره مكتمل

            // Build reps list and populate filter options
            const repsAll = (state.reps||[]).map(r => ({ id:r.id, name:r.name||r.id, target:Number(r.target||0) }));
            const repFilterEl = document.getElementById('targets-rep-filter');
            if (repFilterEl){
                const selVal = repFilterEl.value || 'all';
                // Rebuild options if counts differ or first time
                if (repFilterEl.dataset.filled !== '1' || repFilterEl.options.length-1 !== repsAll.length){
                    const current = selVal;
                    repFilterEl.innerHTML = '<option value="all">عرض كل المناديب</option>' + repsAll.map(r=>`<option value="${escapeHtml(r.name)}">${escapeHtml(r.name)}</option>`).join('');
                    repFilterEl.dataset.filled = '1';
                    // try keep previous selection
                    if ([...repFilterEl.options].some(o=>o.value===current)) repFilterEl.value = current;
                }
            }
            const selectedRepName = (repFilterEl && repFilterEl.value && repFilterEl.value!=='all') ? repFilterEl.value : null;
            const reps = selectedRepName ? repsAll.filter(r=>r.name===selectedRepName) : repsAll;
            if (reps.length === 0){ reportOutputArea.innerHTML = '<p class="text-center text-gray-500">لا توجد مناديب مسجلة.</p>'; return; }

            const dayAgg = new Map();
            (state.sales||[]).forEach(s => {
                const d = new Date(s.date);
                if (d < monthStart || d > monthEnd) return;
                const matchesChain = !allowedCustomerIds || allowedCustomerIds.includes(s.customerId);
                if (!matchesChain) return;
                const dayKey = d.toISOString().split('T')[0];
                const repName = s.repName || 'غير محدد';
                const net = s.total;
                const mapForDay = dayAgg.get(dayKey) || new Map();
                mapForDay.set(repName, (mapForDay.get(repName)||0) + net);
                dayAgg.set(dayKey, mapForDay);
            });
            // Soft column colors per rep
            const colBgs = ['#f0f9ff','#eef2ff','#f5f3ff','#fdf2f8','#fff7ed','#fefce8','#ecfccb','#f0fdf4','#fafaf9','#e0f2fe'];
            const colBgsStrong = ['#e0f2fe','#e0e7ff','#ede9fe','#fde2f3','#ffedd5','#fef3c7','#d9f99d','#dcfce7','#e7e5e4','#bae6fd'];
            const rows = [];
            const cumulativeByRep = {}; reps.forEach(r => cumulativeByRep[r.name]=0);
            for (let day=1; day<=daysInMonth; day++){
                const isoDay = `${year}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const mapForDay = dayAgg.get(isoDay) || new Map();
                let totalDay = 0;
                const cells = reps.map((r, idx) => {
                    const val = mapForDay.get(r.name)||0;
                    cumulativeByRep[r.name] += val;
                    totalDay += val;
                    const base = colBgs[idx % colBgs.length];
                    const strong = colBgsStrong[idx % colBgsStrong.length];
                    const bg = val ? strong : base;
                    return `<td style='background:${bg};color:#0b1b34;font-size:12px;font-weight:${val? '600':'400'}'>${val? formatCurrency(val):'0.00'}</td>`;
                }).join('');
                // اليوم أول عمود، والإجمالي آخر عمود
                rows.push(`<tr>
                    <td class='targets-col-day'>${String(day).padStart(2,'0')}/${String(m+1).padStart(2,'0')}/${year}</td>${cells}<td class='targets-col-total'>${totalDay? formatCurrency(totalDay):'0.00'}</td>
                </tr>`);
            }
            const achievedRowCells = reps.map((r,idx) => `<td style='background:${colBgsStrong[idx%colBgsStrong.length]};color:#065f46;font-weight:700'>${formatCurrency(cumulativeByRep[r.name])}</td>`).join('');
            const targetRowCells = reps.map((r,idx) => `<td style='background:${colBgs[idx%colBgs.length]};color:#111827;font-weight:700'>${formatCurrency(r.target)}</td>`).join('');
            const remainingRowCells = reps.map(r => {
                const rem = r.target - cumulativeByRep[r.name];
                return `<td style='background:${rem>0?'#fde68a':'#bbf7d0'};color:#111827;font-weight:700'>${formatCurrency(rem)}</td>`;
            }).join('');
            const expectedPct = todayDay / daysInMonth;
            const expectedRowCells = reps.map((r,idx) => `<td style='background:${idx%2===0?'#e0e7ff':'#e0f2fe'};color:#0b1b34;font-weight:700'>${(expectedPct*100).toFixed(1)}%</td>`).join('');
            const achievedPctCells = reps.map(r => {
                const pct = r.target? (cumulativeByRep[r.name]/r.target):0;
                const good = pct >= expectedPct;
                return `<td style='background:${good?'#bbf7d0':'#fecaca'};color:#065f46;font-weight:700'>${(pct*100).toFixed(1)}%</td>`;
            }).join('');

            const totalAchieved = Object.values(cumulativeByRep).reduce((a,b)=>a+b,0);
            const totalTargets = reps.reduce((a,r)=>a+r.target,0);
            const totalRemaining = totalTargets - totalAchieved;

            const tableHtml = `
            <div id='targets-report-output' style='direction:rtl;font-family:Cairo;'>
                <table class='targets-table'>
                    <thead>
                        <tr style='color:#fff;'>
                            <th style='background:#3b82f6;font-weight:bold'>اليوم</th>
                            ${reps.map((r,idx)=>`<th style='background:#2563eb;font-weight:bold'>${r.name}</th>`).join('')}
                            <th style='background:#ef4444;font-weight:bold'>إجمالي اليوم</th>
                        </tr>
                    </thead>
                    <tbody>${rows.join('')}</tbody>
                    <tfoot>
                        <tr><td style='background:#e0f2fe;color:#065f46;font-weight:700'>${(expectedPct*100).toFixed(1)}%</td>${expectedRowCells}<td style='background:#e0f2fe;color:#065f46;font-weight:700'>نسبة مستهدفة حتى اليوم</td></tr>
                        <tr><td style='background:#bbf7d0;color:#065f46;font-weight:700'>${totalTargets? ((totalAchieved/totalTargets)*100).toFixed(1):'0.0'}%</td>${achievedPctCells}<td style='background:#bbf7d0;color:#065f46;font-weight:700'>نسبة المحقق</td></tr>
                        <tr><td style='background:#fef3c7;color:#111827;font-weight:700'>${formatCurrency(totalTargets)}</td>${targetRowCells}<td style='background:#fef3c7;color:#111827;font-weight:700'>التارجت</td></tr>
                        <tr><td style='background:${totalRemaining>0?'#fde68a':'#bbf7d0'};color:#111827;font-weight:700'>${formatCurrency(totalRemaining)}</td>${remainingRowCells}<td style='background:${totalRemaining>0?'#fde68a':'#bbf7d0'};color:#111827;font-weight:700'>المتبقي</td></tr>
                        <tr><td style='background:#bfdbfe;color:#0b1b34;font-weight:700'>${formatCurrency(totalAchieved)}</td>${achievedRowCells}<td style='background:#bfdbfe;color:#0b1b34;font-weight:700'>الإجمالي المحقق</td></tr>
                    </tfoot>
                </table>
                <div style='display:flex;gap:12px;margin-top:12px;' class='no-print'>
                    <button onclick="printSection('targets-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> طباعة</button>
                    <button onclick="generateReportImage('targets-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> صورة</button>
                </div>
            </div>`;
            reportOutputArea.innerHTML = tableHtml;
            updateIcons();
        }

        // ===== Customer Targets Report (اكسبشن / سفير / الضحى) =====
        function getCustomerTargetsStore(){
            state.customerTargets = state.customerTargets || {}; // month -> { customerId: { multi: number, dairy: number } }
            return state.customerTargets;
        }
        function getCustomerTargetsForMonth(month){
            const store = getCustomerTargetsStore();
            if (!store[month]) store[month] = {};
            return store[month];
        }
        function saveCustomerTargetsFromInputs(){
            const monthVal = document.getElementById('customer-targets-month')?.value;
            if (!monthVal){ customDialog({title:'تنبيه', message:'اختر الشهر أولاً.'}); return; }
            const monthKey = monthVal;
            const targetObj = getCustomerTargetsForMonth(monthKey);
            const inputs = document.querySelectorAll('#customer-targets-report-output .cust-target-input');
            inputs.forEach(inp => {
                const cid = inp.dataset.customerId; const cat = inp.dataset.category; const val = parseFloat(inp.value)||0;
                targetObj[cid] = targetObj[cid] || { multi:0, dairy:0 };
                targetObj[cid][cat] = val;
            });
            saveState();
            customDialog({title:'حفظ', message:'تم حفظ قيم التارجت.'});
            generateCustomerTargetsReport();
        }
        function generateCustomerTargetsReport(){
            const monthVal = document.getElementById('customer-targets-month')?.value || '';
            const catVal = document.getElementById('customer-targets-category')?.value || 'both';
            const out = document.getElementById('customer-targets-report-output');
            if (!out) return;
            if (!monthVal){ out.innerHTML = '<p class="text-center text-gray-500">اختر شهر.</p>'; return; }
            const [yStr, mStr] = monthVal.split('-'); const year = parseInt(yStr,10); const m = parseInt(mStr,10)-1;
            const monthStart = new Date(Date.UTC(year,m,1)); const monthEnd = new Date(Date.UTC(year,m+1,0,23,59,59));
            // العملاء المطلوبون بالأسماء المطلوبة
            const nameKeys = ['اكسبشن','سفير','الضحى'];
            // استبعاد أي اسم يحتوي "اكسبشن" و"حلواني/حلوانى" معاً من القائمة (اكسبشن حلواني)
            const customers = (state.customers||[]).filter(c => {
                const nm = (c.name||'');
                const include = nameKeys.some(k => nm.includes(k));
                const isExcluded = /اكسبشن/.test(nm) && /(حلواني|حلوانى)/.test(nm);
                return include && !isExcluded;
            });
            if (customers.length === 0){ out.innerHTML = '<p class="text-center text-gray-500">لا توجد عملاء مستهدفة.</p>'; return; }
            const targetsMonthObj = getCustomerTargetsForMonth(monthVal);
            // تجميع المبيعات مع استبعاد منتجات "شيلي" من اكسبشن
            const agg = {}; // cid -> { multiAch: number, dairyAch: number }
            (state.sales||[]).forEach(sale => {
                const d = new Date(sale.date);
                if (d < monthStart || d > monthEnd) return;
                const cid = sale.customerId;
                const cust = customers.find(c => c.id === cid || c._id === cid);
                if (!cust) return;
                sale.items.forEach(item => {
                    const p = findProduct(item.productId); if (!p) return;
                    // استبعاد شيلي لعملاء اكسبشن
                    const nameLower = (cust.name||'').toLowerCase();
                    const prodLower = (p.name||'').toLowerCase();
                    if (nameLower.includes('اكسبشن') && prodLower.includes('شيلي')) return;
                    const qty = Number(item.quantity||item.qty||0);
                    const price = Number(p.price||0);
                    const value = qty * price;
                    const cat = String(p.category||'').toLowerCase();
                    const isMulti = cat.includes('مالت') || cat.includes('multi');
                    const isDairy = cat.includes('بان') || cat.includes('جبن') || cat.includes('cheese') || cat.includes('dairy');
                    agg[cid] = agg[cid] || { multiAch:0, dairyAch:0 };
                    if (isMulti) agg[cid].multiAch += value; else if (isDairy) agg[cid].dairyAch += value;
                });
            });
            function fmt(v){ return formatCurrency(v||0); }
            const rows = customers.map(c => {
                const cid = c.id || c._id; const a = agg[cid] || { multiAch:0, dairyAch:0 };
                const targetData = targetsMonthObj[cid] || {}; // قد تكون فارغة (أشباح أصفار)
                const hasMultiSaved = Object.prototype.hasOwnProperty.call(targetData,'multi');
                const hasDairySaved = Object.prototype.hasOwnProperty.call(targetData,'dairy');
                const multiTarget = hasMultiSaved ? Number(targetData.multi||0) : 0;
                const dairyTarget = hasDairySaved ? Number(targetData.dairy||0) : 0;
                const multiRem = multiTarget - a.multiAch; const dairyRem = dairyTarget - a.dairyAch;
                const multiPct = multiTarget? (a.multiAch/multiTarget)*100:0; const dairyPct = dairyTarget? (a.dairyAch/dairyTarget)*100:0;
                // إدخال بقيمة فارغة مع placeholder صفر إذا لم يُحفظ بعد (شبح صفر)
                const multiInputVal = hasMultiSaved ? multiTarget : '';
                const dairyInputVal = hasDairySaved ? dairyTarget : '';
                const multiInput = `<input type='number' step='any' class='cust-target-input w-20 p-1 border rounded text-center text-xs' data-category='multi' data-customer-id='${cid}' value='${multiInputVal}' placeholder='0'/>`;
                const dairyInput = `<input type='number' step='any' class='cust-target-input w-20 p-1 border rounded text-center text-xs' data-category='dairy' data-customer-id='${cid}' value='${dairyInputVal}' placeholder='0'/>`;
                if (catVal === 'multi'){
                    return `<tr>
                        <td class='name'>${escapeHtml(c.name)}</td>
                        <td>${multiInput}</td>
                        <td class='ach-cell'>${fmt(a.multiAch)}</td>
                        <td class='${multiRem>0?'rem-pos':'rem-zero'}'>${fmt(multiRem)}</td>
                        <td class='${multiPct>=50?'pct-ok':'pct-low'}'>${multiPct.toFixed(1)}%</td>
                    </tr>`;
                } else if (catVal === 'dairy'){
                    return `<tr>
                        <td class='name'>${escapeHtml(c.name)}</td>
                        <td>${dairyInput}</td>
                        <td class='ach-cell'>${fmt(a.dairyAch)}</td>
                        <td class='${dairyRem>0?'rem-pos':'rem-zero'}'>${fmt(dairyRem)}</td>
                        <td class='${dairyPct>=50?'pct-ok':'pct-low'}'>${dairyPct.toFixed(1)}%</td>
                    </tr>`;
                } else { // both
                    const totalTarget = multiTarget + dairyTarget;
                    const totalAch = a.multiAch + a.dairyAch;
                    const totalRem = totalTarget - totalAch;
                    const totalPct = totalTarget? (totalAch/totalTarget)*100:0;
                    return `<tr>
                        <td class='name'>${escapeHtml(c.name)}</td>
                        <td>${multiInput}</td>
                        <td class='ach-cell'>${fmt(a.multiAch)}</td>
                        <td>${dairyInput}</td>
                        <td class='ach-cell'>${fmt(a.dairyAch)}</td>
                        <td class='ach-cell'>${fmt(totalTarget)}</td>
                        <td class='ach-cell'>${fmt(totalAch)}</td>
                        <td class='${totalRem>0?'rem-pos':'rem-zero'}'>${fmt(totalRem)}</td>
                        <td class='${totalPct>=50?'pct-ok':'pct-low'}'>${totalPct.toFixed(1)}%</td>
                    </tr>`;
                }
            }).join('');
            let thead;
            if (catVal === 'multi'){
                thead = `<tr>
                    <th class='cth-name'>العميل</th>
                    <th class='cth-multi-target'>تارجت مالتي</th>
                    <th class='cth-multi-ach'>محقق مالتي</th>
                    <th class='cth-rem'>متبقي</th>
                    <th class='cth-pct'>% محقق</th>
                </tr>`;
            } else if (catVal === 'dairy'){
                thead = `<tr>
                    <th class='cth-name'>العميل</th>
                    <th class='cth-dairy-target'>تارجت البان</th>
                    <th class='cth-dairy-ach'>محقق البان</th>
                    <th class='cth-rem'>متبقي</th>
                    <th class='cth-pct'>% محقق</th>
                </tr>`;
            } else {
                thead = `<tr>
                    <th class='cth-name'>العميل</th>
                    <th class='cth-multi-target'>تارجت مالتي</th>
                    <th class='cth-multi-ach'>محقق مالتي</th>
                    <th class='cth-dairy-target'>تارجت البان</th>
                    <th class='cth-dairy-ach'>محقق البان</th>
                    <th class='cth-total-target'>إجمالي التارجت</th>
                    <th class='cth-total-ach'>إجمالي المحقق</th>
                    <th class='cth-rem-total'>المتبقي الإجمالي</th>
                    <th class='cth-pct-total'>% إجمالي</th>
                </tr>`;
            }
            out.innerHTML = `<div id='customer-targets-report-wrapper' class='bg-white p-3 rounded-lg shadow'>
                <table class='customer-targets-table'>
                    <thead>${thead}</thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class='flex gap-2 mt-3 no-print'>
                    <button onclick="printSection('customer-targets-report-wrapper')" class='bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm flex items-center gap-1'><i data-lucide='printer'></i> طباعة</button>
                    <button onclick="generateReportImage('customer-targets-report-wrapper')" class='bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm flex items-center gap-1'><i data-lucide='image'></i> صورة</button>
                </div>
            </div>`;
            updateIcons();
        }

                // Settlement (تسوية) report: aggregates dispatch note vs actual sales & returns per product for a rep/date
                function generateSettlementReport(){
                    // استخدم حقول التسوية إن وُجدت، وإلا fallback إلى اليومية
                    const dateInput = document.getElementById('settlement-report-date');
                    const repSelect = document.getElementById('settlement-report-rep');
                    const date = (dateInput && dateInput.value) ? dateInput.value : (dailyReportDateInput ? dailyReportDateInput.value : '');
                    const repName = (repSelect && repSelect.value) ? repSelect.value : (dailyReportRepSelect ? dailyReportRepSelect.value : '');
                    if (!date) { customDialog({ message:'اختر تاريخاً للتسوية.', title:'بيانات ناقصة' }); return; }
                    if (!repName || repName === 'all') { customDialog({ message:'اختر مندوب واحد للتسوية.', title:'تنبيه' }); return; }

                        // Find dispatch note for that rep/day
                        const dispatchNote = state.dispatchNotes.find(n => n.repName === repName && new Date(n.date).toISOString().split('T')[0] === date);
                        // Build product baseline from products list to keep ordering stable
                        const productIds = state.products.map(p => p.id);
                        const salesForDay = state.sales.filter(s => s.repName === repName && new Date(s.date).toISOString().split('T')[0] === date);

                        // Aggregations
                        const agg = {}; // productId -> metrics
                        function ensure(id){ if(!agg[id]) agg[id] = { productId:id, name: (findProduct(id)?.name)||id, dispatched:0, goodReturn:0, damagedReturn:0, freebie:0, sold:0, invoiceReturn:0 }; }
                        // From dispatch note items
                        if (dispatchNote && Array.isArray(dispatchNote.items)) {
                            dispatchNote.items.forEach(it=>{
                                ensure(it.productId);
                                agg[it.productId].dispatched += Number(it.quantity||0);
                                // دعم النموذج الجديد: actualReturn يعامل كمرتجع سليم
                                agg[it.productId].goodReturn += Number(it.actualReturn||it.goodReturn||0);
                                agg[it.productId].damagedReturn += Number(it.damagedReturn||0);
                                agg[it.productId].freebie += Number(it.freebie||0);
                            });
                        }
                        // From sales (positive quantities)
                        salesForDay.forEach(sale => {
                                sale.items.forEach(item => {
                                        ensure(item.productId);
                                        const q = Number(item.quantity||item.qty||0);
                                        if (sale.total < 0 || q < 0) { agg[item.productId].invoiceReturn += Math.abs(q); }
                                        else { agg[item.productId].sold += q; }
                                });
                        });
                        // Include any product ids missing but present in sales/dispatch
                        Object.keys(agg).forEach(id=>{ if(!productIds.includes(id)) productIds.push(id); });
                        // Rows
                        const rowsHtml = productIds.map(pid => {
                                ensure(pid);
                                const m = agg[pid];
                                // Diff = dispatched - (sold + freebie + returns good + returns damaged)
                                const used = m.sold + m.freebie + m.goodReturn + m.damagedReturn + m.invoiceReturn;
                                const diff = m.dispatched - used;
                                return `<tr style="background:#0b2d5e;color:#fff;font-size:12px;">
                                        <td style='text-align:center;background:#1f3f79'>${formatCurrency(0)}</td>
                                        <td style='text-align:center;background:#111'>${diff}</td>
                                        <td style='text-align:center;background:#062c5c'>${m.dispatched}</td>
                                        <td style='text-align:center;background:#094b2e'>${m.goodReturn}</td>
                                        <td style='text-align:center;background:#062c5c'>${m.invoiceReturn}</td>
                                        <td style='text-align:center;background:#051c44'>${m.sold}</td>
                                        <td style='text-align:center;background:#062c5c'>${m.damagedReturn}</td>
                                        <td style='text-align:center;background:#094b2e'>${m.freebie}</td>
                                        <td style='text-align:center;background:#051c44'>${m.dispatched - m.goodReturn - m.damagedReturn}</td>
                                        <td style='text-align:center;background:#041635'>${m.name}</td>
                                </tr>`;
                        }).join('');

                        const billNumber = salesForDay.length ? (salesForDay[0].invoiceNumber||'') : (dispatchNote?.serial||'');
                        const dayNum = date.split('-')[2];
                        const yearNum = date.split('-')[0];
                        const monthNum = date.split('-')[1];

                        reportOutputArea.innerHTML = `
                                <div id='settlement-report-output' style='direction:rtl;font-family:Cairo;'>
                                    <table style='width:100%;border:4px solid #001a3d;font-size:12px;border-collapse:separate;'>
                                        <thead>
                                            <tr style='background:#0b2d5e;color:#fff;'>
                                                <th style='width:60px;background:#331b6d'>قيمة</th>
                                                <th style='background:#0b0b0b'>العجز / الفائض</th>
                                                <th style='background:#041a3f'>الفرق بين اذن السيارة وبيع الفواتير</th>
                                                <th style='background:#094b2e'>هالك واكراميات</th>
                                                <th style='background:#041a3f'>صافي فواتير للمندوب</th>
                                                <th style='background:#051c44'>مرتجع فواتير للمندوب</th>
                                                <th style='background:#041a3f'>صافي بيع الفواتير</th>
                                                <th style='background:#051c44'>مرتجع اذن السيارة</th>
                                                <th style='background:#094b2e'>اذن خروج السيارة</th>
                                                <th style='background:#0b0b0b'>اسم الصنف</th>
                                            </tr>
                                            <tr style='background:#062c5c;color:#fff;'>
                                                <th style='background:#331b6d'>0.00</th>
                                                <th style='background:#111'>${yearNum}</th>
                                                <th style='background:#062c5c'>${monthNum}</th>
                                                <th style='background:#fff;color:#000;font-weight:bold'><img src='' alt='' style='height:20px'></th>
                                                <th style='background:#d49c3b;color:#000;font-weight:bold'>${date.split('-').reverse().join('/')}</th>
                                                <th style='background:#1f3f79'>${repName}</th>
                                                <th style='background:#8d0000;color:#fff'>${billNumber||''}</th>
                                                <th style='background:#b46900;color:#fff'>${dayNum}</th>
                                                <th style='background:#041a3f'>${repName}</th>
                                                <th style='background:#041635'>اسم الصنف</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rowsHtml}</tbody>
                                    </table>
                                    <div style='display:flex;gap:16px;margin-top:12px;'>
                                        <div style='background:#331b6d;color:#fff;padding:8px 24px;font-weight:bold;'>Total</div>
                                        <div style='background:#271056;color:#fff;padding:8px 24px;font-weight:bold;'>0.0</div>
                                        <div style='flex:1;background:linear-gradient(90deg,#008a00,#006400);color:#fff;text-align:center;font-weight:bold;padding:12px 8px;border:2px solid #004c00;'>لا توجد عجوزات وزيادات</div>
                                    </div>
                                    <div class='mt-4 grid grid-cols-3 gap-2 no-print'>
                                        <button onclick="printSection('settlement-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> طباعة</button>
                                        <button onclick="generateReportImage('settlement-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> نسخ كصورة</button>
                                        <button onclick="shareSettlementWhatsApp('settlement-report-output')" class='bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2'><i data-lucide='send'></i> مشاركة واتساب</button>
                                    </div>
                                </div>`;
                        updateIcons();
                }
        
        async function generateReconciliationReport() {
            const date = document.getElementById('recon-report-date').value;
            const repName = document.getElementById('recon-report-rep').value;
            const chainId = document.getElementById('recon-report-chain').value;
            const reportOutputArea = document.getElementById('report-output-area');

            if (!date || !repName) {
                await customDialog({ message: 'الرجاء تحديد التاريخ والمندوب.', title: 'بيانات ناقصة' });
                return;
            }
            
            // Get chain customer IDs if a chain is selected
            let allowedCustomerIds = null;
            if (chainId) {
                const chains = loadChains();
                const chain = chains.find(c => c.id === chainId);
                if (chain) allowedCustomerIds = chain.customerIds || [];
            }

            // 1. Find the dispatch note
            const dispatchNote = state.dispatchNotes.find(n =>
                n.repName === repName && new Date(n.date).toISOString().split('T')[0] === date
            );

            if (!dispatchNote) {
                reportOutputArea.innerHTML = '<p class="text-center text-red-500 p-4">لم يتم العثور على إذن استلام لهذا المندوب في التاريخ المحدد.</p>';
                return;
            }

            // 2. Find all sales for the rep on that day (apply chain filter)
            const sales = state.sales.filter(s =>
                s.repName === repName && new Date(s.date).toISOString().split('T')[0] === date && 
                (!allowedCustomerIds || allowedCustomerIds.includes(s.customerId))
            );

            // 3. Aggregate sales by product ID
            const salesByProduct = {};
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    salesByProduct[item.productId] = (salesByProduct[item.productId] || 0) + item.quantity;
                });
            });

            // 4. Create a master list of all products involved
            const allProductIds = new Set([
                ...dispatchNote.items.map(i => i.productId),
                ...Object.keys(salesByProduct)
            ]);

            // 5. Generate report rows
            let reportRowsHtml = '';
            let totalDeficitValue = 0;
            let totalSurplusValue = 0;

            allProductIds.forEach(productId => {
                const product = findProduct(productId);
                if (!product) return;

                const dispatchItem = dispatchNote.items.find(i => i.productId === productId) || {};
                const takenOut = dispatchItem.quantity || 0;
                const goodReturn = dispatchItem.goodReturn || 0;
                const damagedReturn = dispatchItem.damagedReturn || 0;
                const freebie = dispatchItem.freebie || 0;
                
                const sold = salesByProduct[productId] || 0;

                const expectedReturn = takenOut - sold - freebie;
                const actualReturn = goodReturn + damagedReturn;
                const difference = actualReturn - expectedReturn;

                const differenceValue = difference * (product.price || 0);
                let diffClass = 'text-gray-700';
                if (difference < 0) {
                    diffClass = 'text-red-600 font-bold';
                    totalDeficitValue += differenceValue; // differenceValue will be negative
                } else if (difference > 0) {
                    diffClass = 'text-green-600 font-bold';
                    totalSurplusValue += differenceValue;
                }

                // إعادة ترتيب الأعمدة: الصنف أولاً ثم المستلم (المخرج) .. إلخ + تلوين الخلايا
                reportRowsHtml += `
                    <tr style="border-bottom:1px solid #112b57;">
                        <td style="background:#041635;color:#fff;padding:6px 4px;text-align:right;font-weight:600">${escapeHtml(product.name)}</td>
                        <td style="background:#d49c3b;color:#000;padding:6px 4px;text-align:center;font-weight:600">${takenOut}</td>
                        <td style="background:#0b0b0b;color:#fff;padding:6px 4px;text-align:center">${sold}</td>
                        <td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center">${freebie}</td>
                        <td style="background:#041a3f;color:#fff;padding:6px 4px;text-align:center;font-weight:600">${expectedReturn}</td>
                        <td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center">${goodReturn}</td>
                        <td style="background:#041a3f;color:#fff;padding:6px 4px;text-align:center">${damagedReturn}</td>
                        <td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center;font-weight:600">${actualReturn}</td>
                        <td style="background:#041a3f;color:${difference<0?'#ff2e2e':(difference>0?'#25d366':'#fff')};padding:6px 4px;text-align:center;font-weight:${difference!==0?'700':'400'}">${difference}</td>
                        <td style="background:#062c5c;color:${differenceValue<0?'#ff2e2e':(differenceValue>0?'#25d366':'#fff')};padding:6px 4px;text-align:center;font-weight:${differenceValue!==0?'700':'400'}">${formatCurrency(differenceValue)}</td>
                    </tr>`;
            });

            // 6. Build final report HTML
            const finalHtml = `
                <div id='recon-report-output' style='direction:rtl;font-family:Cairo;'>
                    <div style='display:grid;grid-template-columns:120px 1fr 120px;align-items:center;margin-bottom:4px;'>
                        <div style='background:#3b0d00;color:#fff;padding:12px 8px;text-align:center;font-weight:bold;font-size:20px;border:2px solid #210600;'>${date.split('-')[2]}</div>
                        <div style='background:linear-gradient(90deg,#002aa8,#004dff);color:#fff;text-align:center;padding:12px 8px;font-size:24px;font-weight:bold;border:2px solid #001a3d;'>بيان بعجوزات وزيادات الموزعين</div>
                        <div style='background:#041a3f;color:#fff;padding:12px 8px;text-align:center;font-weight:bold;font-size:20px;border:2px solid #001a3d;'>${repName}</div>
                    </div>
                    <table style='width:100%;border:4px solid #001a3d;font-size:13px;border-collapse:separate;'>
                        <thead>
                            <tr style='color:#fff;'>
                                <th style='background:#041635;text-align:center;font-weight:bold'>الصنف</th>
                                <th style='background:#d49c3b;color:#000;font-weight:bold;width:70px;text-align:center'>المستلم</th>
                                <th style='background:#0b0b0b;text-align:center;font-weight:bold'>المباع</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>المجاني</th>
                                <th style='background:#041a3f;text-align:center;font-weight:bold'>المرتجع المتوقع</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>مرتجع سليم</th>
                                <th style='background:#041a3f;text-align:center;font-weight:bold'>مرتجع تالف</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>المرتجع الفعلي</th>
                                <th style='background:#041a3f;text-align:center;font-weight:bold'>الفرق كمية</th>
                                <th style='background:#062c5c;text-align:center;font-weight:bold'>الفرق قيمة</th>
                            </tr>
                        </thead>
                        <tbody>${reportRowsHtml}</tbody>
                    </table>
                    <div style='display:flex;gap:16px;margin-top:12px;'>
                        <div style='background:#3b0d00;color:#fff;padding:8px 24px;font-weight:bold;'>إجمالي عجز</div>
                        <div style='background:#5c1a00;color:#fff;padding:8px 24px;font-weight:bold;'>${formatCurrency(totalDeficitValue)}</div>
                        <div style='background:#d49c3b;color:#000;padding:8px 24px;font-weight:bold;'>إجمالي زيادة</div>
                        <div style='background:#094b2e;color:#fff;padding:8px 24px;font-weight:bold;'>${formatCurrency(totalSurplusValue)}</div>
                        <div style='flex:1;background:linear-gradient(90deg,#007a00,#00b300);color:#fff;text-align:center;font-weight:bold;padding:12px 8px;border:2px solid #004c00;'>${(totalDeficitValue===0 && totalSurplusValue===0)?'لا توجد عجوزات وزيادات':'مراجعة القيم أعلاه'}</div>
                    </div>
                    <div class='mt-4 grid grid-cols-3 gap-2 no-print'>
                        <button onclick="printSection('recon-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> طباعة</button>
                        <button onclick="generateReportImage('recon-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> صورة HD</button>
                        <button onclick="shareReconciliationWhatsApp('recon-report-output')" class='bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2'><i data-lucide='send'></i> مشاركة واتساب</button>
                    </div>
                </div>`;

            reportOutputArea.innerHTML = finalHtml;
        }

        // مشاركة تقرير التسوية النهائية عبر واتساب
        async function shareReconciliationWhatsApp(elementId){
            const el = document.getElementById(elementId);
            const date = document.getElementById('recon-report-date')?.value || '';
            const rep = document.getElementById('recon-report-rep')?.value || '';
            if (!el){ await customDialog({title:'خطأ', message:'تعذر العثور على التقرير.'}); return; }
            try {
                showLoading('جارٍ تجهيز مشاركة واتساب...');
                // تكبير الصورة لسهولة القراءة داخل واتساب ويب
                el.classList.add('recon-export-scale');
                const canvas = await captureElementCanvas(el, 4);
                el.classList.remove('recon-export-scale');
                const blob = await new Promise(r => canvas.toBlob(r,'image/png'));
                if (!blob) throw new Error('فشل إنشاء الصورة');
                const url = await uploadImageBlobToStorage(blob, 'shares/final_settlements');
                hideLoading(); // أخفِ التحميل قبل فتح النافذة لتجنب المنع
                const msg = `التسوية النهائية للمندوب ${rep} - ${date}\n${url}`;
                const desktopUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
                let popup = window.open(desktopUrl, '_blank');
                // fallback للهواتف أو منع النوافذ المنبثقة
                setTimeout(() => {
                    try {
                        if (!popup || popup.closed) {
                            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                        }
                    } catch(_) {
                        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                    }
                }, 1800);
            } catch(e){
                console.warn('shareReconciliationWhatsApp failed', e);
                hideLoading();
                // بناء مشاركة بديلة في حال فشل الرفع (غالباً origin null أو قواعد التخزين)
                try {
                    const el2 = document.getElementById(elementId);
                    if (el2){
                        el2.classList.add('recon-export-scale');
                        const cnv = await captureElementCanvas(el2, 2);
                        el2.classList.remove('recon-export-scale');
                        const dataUrl = cnv.toDataURL('image/png');
                        // فتح الصورة في نافذة جديدة للحفظ اليدوي
                        const w = window.open('about:blank','_blank');
                        if (w) {
                            w.document.write('<title>صورة التسوية النهائية</title><p style="font-family:sans-serif">احفظ الصورة ثم أرفقها في واتساب.</p><img style="max-width:100%;" src="'+dataUrl+'" />');
                        }
                        // نسخ رسالة نصية بدون رابط (رفع فشل)
                        const altMsg = `التسوية النهائية للمندوب ${rep} - ${date} (مرفق صورة يدوياً)`;
                        try { navigator.clipboard.writeText(altMsg); } catch(_){}
                        await customDialog({title:'مشاركة بديلة', message:'تم تجهيز الصورة. تم فتح نافذة للحفظ، والرسالة نُسخت (إن سمح المتصفح). لتعمل المشاركة التلقائية: شغل الصفحة عبر http:// (خادم محلي) وراجع قواعد Storage.'});
                        return; // خروج بعد مشاركة بديلة
                    }
                } catch(_) { /* ignore secondary failure */ }
                await customDialog({title:'خطأ', message:'تعذر مشاركة أو تجهيز مشاركة بديلة للصورة.'});
            }
        }

        // --- END NEW REPORTING FUNCTIONS ---


        function openCustomerModal(id = null) {
            customerForm.reset();
            document.getElementById('customer-id').value = '';
            populatePriceListDropdown(document.getElementById('customer-price-list'));
            populateRepDropdown(document.getElementById('customer-rep'));

            if (id) {
                // Edit mode
                const sid = String(id);
                const customer = state.customers.find(c => String(c.id) === sid || String(c._id) === sid);
                if (customer) {
                    document.getElementById('customer-modal-title').textContent = 'تعديل بيانات العميل';
                    document.getElementById('customer-id').value = customer.id || customer._id || '';
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-tax-number').value = customer.taxNumber || '';
                    document.getElementById('customer-phone').value = customer.phone || '';
                    document.getElementById('customer-address').value = customer.address || '';
                    document.getElementById('customer-requires-tax').checked = customer.requiresTaxFiling || false;
                    document.getElementById('customer-price-list').value = customer.priceListId || '';
                    document.getElementById('customer-rep').value = customer.repName || '';
                }
            } else {
                // Add mode
                document.getElementById('customer-modal-title').textContent = 'إضافة عميل جديد';
                // في وضع الإضافة: إن كان المستخدم الحالي مندوباً، عيّن حقل المندوب تلقائياً
                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') {
                        const current = AuthSystem.getCurrentUser();
                        if (current) {
                            const myRep = (state.reps||[]).find(r => r.id === current.id);
                            if (myRep && myRep.name) {
                                const repSel = document.getElementById('customer-rep');
                                if (repSel) repSel.value = myRep.name;
                            }
                        }
                    }
                } catch(e) { /* ignore */ }
            }
            openModal(customerModal);
        }

        function openRepModal(id = null) {
            repForm.reset();
            document.getElementById('rep-id').value = '';

            if (id) {
                // Edit mode
                const rep = state.reps.find(r => r.id === id);
                if (rep) {
                    document.getElementById('rep-modal-title').textContent = 'تعديل بيانات المندوب';
                    document.getElementById('rep-id').value = rep.id;
                    document.getElementById('rep-name').value = rep.name;
                    document.getElementById('rep-serial').value = rep.serial || '';
                    document.getElementById('rep-target').value = rep.target || 0;
                    document.getElementById('rep-next-invoice').value = rep.nextInvoiceNumber || '';
                }
            } else {
                // Add mode
                document.getElementById('rep-modal-title').textContent = 'إضافة مندوب جديد';
            }
            openModal(repModal);
        }

        // --- PRODUCT & PRICE-LIST MODALS & SAVERS ---
        function openProductModal(id = null) {
            productForm.reset();
            document.getElementById('product-id').value = '';
            if (id) {
                const product = state.products.find(p => p.id === id);
                if (product) {
                    document.getElementById('product-modal-title').textContent = 'تعديل المنتج';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-code').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-price').value = product.price || 0;
                    document.getElementById('product-category').value = product.category || '';
                }
            } else {
                document.getElementById('product-modal-title').textContent = 'إضافة منتج جديد';
            }
            openModal(productModal);
        }

        function openPriceListModal(id = null) {
            priceListForm.reset();
            document.getElementById('price-list-id').value = '';
            document.getElementById('price-list-name').value = '';
            const container = document.getElementById('price-list-products');
            const tbody = document.getElementById('price-list-products-body');
            const discountInput = document.getElementById('price-list-discount');
            // ensure tbody exists
            if (!tbody) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">خطأ في عرض الجدول</div>';
            } else {
                tbody.innerHTML = '';

                function parseDiscount(str){
                    if (!str) return 0;
                    const n = parseFloat(String(str).replace('%','').trim());
                    return isNaN(n) ? 0 : n;
                }
                function updateAllPricesAfterDiscount(){
                    const d = parseDiscount(discountInput.value);
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
                        const priceInp = tr.querySelector('.price-list-product-input');
                        const afterInp = tr.querySelector('.price-after-discount');
                        if (!priceInp || !afterInp) return;
                        const v = parseFloat(priceInp.value);
                        if (!isNaN(v)) {
                            const newVal = v * (1 - d/100);
                            afterInp.value = formatNumberEN(newVal);
                        } else {
                            afterInp.value = '';
                        }
                    });
                }

                // build rows
                state.products.forEach((p, idx) => {
                    const tr = document.createElement('tr');
                    tr.dataset.pid = p.id;
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-right">${idx+1}</td>
                        <td class="px-3 py-2 text-center">${escapeHtml(String(p.id||''))}</td>
                        <td class="px-3 py-2 text-right">${escapeHtml(String(p.name||''))}</td>
                        <td class="px-3 py-2 text-center">${escapeHtml(String(p.unit||'قطعة'))}</td>
                        <td class="px-3 py-2 text-center">${escapeHtml(String(p.barcode||''))}</td>
                        <td class="px-3 py-2 text-center"><input type="number" step="any" class="price-list-product-input p-1 border rounded w-28 text-center" data-product-id="${p.id}" placeholder="" /></td>
                        <td class="px-3 py-2 text-center"><input type="text" readonly class="price-after-discount p-1 border rounded w-28 text-center bg-gray-50" data-product-id="${p.id}" placeholder="" /></td>
                    `;
                    tbody.appendChild(tr);
                });

                // wire events: update single row on price input change
                tbody.addEventListener('input', (ev) => {
                    const target = ev.target;
                    if (target && target.classList && target.classList.contains('price-list-product-input')) {
                        const d = parseDiscount(discountInput.value);
                        const v = parseFloat(target.value);
                        const row = target.closest('tr');
                        const afterInp = row ? row.querySelector('.price-after-discount') : null;
                        if (afterInp) {
                            if (!isNaN(v)) {
                                afterInp.value = formatNumberEN(v * (1 - d/100));
                            } else {
                                afterInp.value = '';
                            }
                        }
                    }
                });

                // wire discount input
                discountInput.addEventListener('input', () => updateAllPricesAfterDiscount());
            }

            if (id) {
                const pl = state.priceLists.find(x => x.id === id);
                if (pl) {
                    document.getElementById('price-list-modal-title').textContent = 'تعديل قائمة أسعار';
                    document.getElementById('price-list-id').value = pl.id;
                    document.getElementById('price-list-name').value = pl.name;
                    // fill product prices
                    Object.keys(pl.productPrices || {}).forEach(pid => {
                        const inp = container.querySelector(`.price-list-product-input[data-product-id="${pid}"]`);
                        if (inp) inp.value = pl.productPrices[pid];
                    });
                }
            } else {
                document.getElementById('price-list-modal-title').textContent = 'إضافة قائمة أسعار';
            }

            openModal(priceListModal);
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value || document.getElementById('product-code').value.trim();
            const code = document.getElementById('product-code').value.trim();
            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value) || 0;
            const category = document.getElementById('product-category').value.trim();
            if (!code || !name) {
                await customDialog({ title: 'خطأ', message: 'الرجاء إدخال كود واسم المنتج.' });
                return;
            }

            try {
                await updateProduct(code, { name, price, category, active: true });
                closeModal(productModal);
                await customDialog({ title: 'نجاح', message: 'تم حفظ المنتج في السحابة.' });
            } catch (err) {
                console.warn('saveProduct cloud failed', err);
                await customDialog({ title: 'خطأ', message: 'تعذر حفظ المنتج في السحابة. تحقق من الاتصال والصلاحيات.' });
            }
        }

        async function savePriceList(e) {
            e.preventDefault();
            const id = document.getElementById('price-list-id').value || Date.now().toString();
            const name = document.getElementById('price-list-name').value.trim();
            if (!name) { await customDialog({ title: 'خطأ', message: 'الرجاء إدخال اسم قائمة الأسعار.' }); return; }
            const container = document.getElementById('price-list-products');
            const inputs = Array.from(container.querySelectorAll('.price-list-product-input'));
            const productPrices = {};
            inputs.forEach(inp => {
                const pid = inp.dataset.productId;
                const val = parseFloat(inp.value);
                if (!isNaN(val)) productPrices[pid] = val;
            });
            try {
                // Persist to Firestore
                const exists = (state.priceLists||[]).some(pl => pl.id === id);
                if (exists) {
                    await updatePriceListDoc(id, { name, productPrices });
                } else {
                    await addPriceListDoc(id, { name, productPrices });
                }
                closeModal(priceListModal);
                await customDialog({ title: 'نجاح', message: 'تم حفظ قائمة الأسعار في السحابة.' });
            } catch (err) {
                console.warn('savePriceList cloud failed', err);
                await customDialog({ title: 'خطأ', message: 'تعذر حفظ قائمة الأسعار في السحابة. تحقق من الاتصال والصلاحيات.' });
            }
        }

        // Save global monthly sales target from Settings and refresh dashboard
        async function saveSalesTarget(e) {
            if (e && e.preventDefault) e.preventDefault();
            const input = document.getElementById('sales-target-input');
            if (!input) return;
            // tolerate commas and whitespace
            const raw = String(input.value || '').replace(/,/g, '').trim();
            const val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                await customDialog({ title: 'خطأ', message: 'الرجاء إدخال قيمة صحيحة للهدف الشهري (رقم موجب).' });
                return;
            }

            state.settings = state.settings || {};
            state.settings.salesTarget = Number(val);
            saveState();
            
            // حفظ في Firebase Firestore
            try {
                if (window.db) {
                    await db.collection('settings').doc('global-settings').set({
                        salesTarget: Number(val),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    console.log('تم حفظ الهدف الشهري في السحابة:', val);
                }
            } catch(err) {
                console.warn('فشل حفظ الهدف الشهري في السحابة:', err);
            }
            
            renderDashboard();
            await customDialog({ title: 'نجاح', message: 'تم حفظ الهدف الشهري بنجاح في السحابة وعرضه في الصفحة الرئيسية.' });
        }

        // دالة تحديث الساعة الرقمية
        function updateDigitalClock() {
            const clockEl = document.getElementById('digital-clock');
            if (!clockEl) return;
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            clockEl.textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        // تحديث الساعة عند التحميل وكل ثانية
        updateDigitalClock();
        setInterval(updateDigitalClock, 1000);

        function setupNavigationHandlers() {
            const mainNavBar = document.getElementById('main-nav-bar');
            if (mainNavBar) {
                mainNavBar.addEventListener('click', (e) => {
                    const button = e.target.closest('.bottom-nav-item');
                    if (button && button.dataset.page) {
                        const pageId = button.dataset.page;
                        navigateTo(pageId);
                    }
                });
            }

            // Handle Reports Subnav Clicks - query fresh so handlers work even if elements were not present at script parse time
            const _reportsSubnavItems = document.querySelectorAll('.reports-subnav-item');
            _reportsSubnavItems.forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.reports-subnav-item').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const section = e.currentTarget.dataset.reportSection;
                    showReportContent(section);
                    if (section === 'targets') { try { generateTargetsReport(); } catch(e){} }
                });
            });
            updateIcons(); 
        }

        // --- DISPATCH NOTE FUNCTIONS ---

    function generateAndShowDispatchNoteView(noteId) { /* ... */ } 
    function openSettlementModal(noteId) { /* ... */ } 
        
        // --- MANUAL STATEMENT FUNCTION ---
        function generateAndShowStatement(startDate, endDate, customerIds, title, customerNames, category = 'all') {
            const statementModal = document.getElementById('statement-modal');
            endDate.setHours(23, 59, 59, 999); // Include all of the end day

            const salesInRange = state.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= startDate && saleDate <= endDate && customerIds.includes(sale.customerId);
            });

            let filteredSales = salesInRange;
            if (category !== 'all') {
                filteredSales = salesInRange.filter(sale => {
                    return sale.items.some(item => {
                        const product = findProduct(item.productId);
                        // Ensure product exists and has a category property before checking
                        return product && product.category === category;
                    });
                });
            }
            
            // Sort by date
            filteredSales.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = `<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
                <div class="printable-statement-content">
                    <h2 class="text-2xl font-bold mb-2">${title}</h2>
                    <p class="text-sm text-gray-600 mb-2">الفترة من: ${startDate.toLocaleDateString('ar-EG')} إلى: ${endDate.toLocaleDateString('ar-EG')}</p>
                    <p class="text-sm text-gray-600 mb-4">العملاء: ${customerNames}</p>`;

            if (filteredSales.length === 0) {
                html += '<p class="text-center text-gray-500 p-4">لا توجد فواتير في هذه الفترة.</p>';
            } else {
                html += '<div class="overflow-x-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200 text-sm">';
                html += `<thead class="bg-gray-100"><tr>
                    <th class="px-4 py-2 text-right font-semibold">التاريخ</th>
                    <th class="px-4 py-2 text-center font-semibold">رقم الفاتورة</th>
                    <th class="px-4 py-2 text-right font-semibold">العميل</th>
                    <th class="px-4 py-2 text-center font-semibold">الإجمالي</th>
                    <th class="px-4 py-2 text-center font-semibold">المدفوع</th>
                    <th class="px-4 py-2 text-center font-semibold">الحالة</th>
                </tr></thead>`;
                html += '<tbody class="bg-white divide-y divide-gray-100">';
                let totalAmount = 0;
                filteredSales.forEach(sale => {
                    const customer = findCustomer(sale.customerId);
                    totalAmount += sale.total;
                    html += `<tr class="${sale.total < 0 ? 'bg-red-50' : ''}">
                        <td class="px-4 py-2 whitespace-nowrap">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
                        <td class="px-4 py-2 text-center">${sale.invoiceNumber}</td>
                        <td class="px-4 py-2 text-right">${customer ? customer.name : 'عميل محذوف'}</td>
                        <td class="px-4 py-2 text-center font-bold ${sale.total < 0 ? 'text-red-600' : 'text-green-700'}">${formatCurrency(sale.total)}</td>
                        <td class="px-4 py-2 text-center">${formatCurrency(sale.paidAmount)}</td>
                        <td class="px-4 py-2 text-center">${getStatusBadge(sale.status)}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                html += `<div class="text-left mt-4 font-bold text-2xl">الإجمالي النهائي للفترة: <span class="${totalAmount < 0 ? 'text-red-600' : 'text-green-700'}">${formatCurrency(totalAmount)}</span></div>`;
            }
            html += `</div>`; // Closing printable-statement-content
            html += `<div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
                        <button onclick="closeModal(document.getElementById('statement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
                        <button id="print-statement-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                           <i data-lucide="printer" class="w-5 h-5"></i>
                           <span>طباعة</span>
                        </button>
                    </div>`;
            html += '</div>';

            statementModal.innerHTML = html;
            
            // Add print functionality
            const printBtn = statementModal.querySelector('#print-statement-btn');
            if(printBtn) {
                printBtn.addEventListener('click', () => {
                    const contentToPrint = statementModal.querySelector('.printable-statement-content').innerHTML;
                    const w = window.open('', '', 'height=600,width=800');
                    if (!w) { alert('يرجى السماح بالنوافذ المنبثقة للطباعة'); return; }
                    w.document.open();
                    w.document.write('<html><head><title>كشف حساب</title>');
                    w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
                    w.document.write('<style>body { font-family: \'Cairo\', sans-serif; direction: rtl; }</style>');
                    w.document.write('</head><body>');
                    w.document.write(contentToPrint);
                    w.document.write('</body></html>');
                    w.document.close();
                    const doPrint = () => { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
                    const closeBack = () => { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
                    if ('onafterprint' in w) { w.onafterprint = closeBack; } else { setTimeout(closeBack, 1200); }
                    if ('onload' in w) { w.onload = () => setTimeout(doPrint, 100); } else { setTimeout(doPrint, 300); }
                });
            }

            openModal(statementModal);
            updateIcons();
        }

        // ===== INVOICE RECEIPT PRINTING (58mm/80mm) =====
        function buildReceiptHtml58mm(sale){
            try {
            const customer = findCustomer(sale.customerId);
            const company = (state.settings && state.settings.companyName) ? state.settings.companyName : 'اسم الشركة';
            const logo = (state.settings && state.settings.companyLogo) ? state.settings.companyLogo : 'https://i.ibb.co/YT4114YW/image.jpg';
            const registry = (state.settings && (state.settings.companyRegistry||state.settings.commercialRegistry)) || '134175';
            const taxId   = (state.settings && (state.settings.companyTaxId||state.settings.taxCard)) || '762878835';
            const phone   = (state.settings && state.settings.companyPhone) || '01011121457';
            const email   = (state.settings && state.settings.companyEmail) || 'delentemilks@gmail.com';
            const repName = sale.repName || '';
                const dateStr = formatArabicDate(sale.date);
                const inv = sale.invoiceNumber || sale.id || '';
                const rows = (sale.items||[]).map(it => {
                    const p = findProduct(it.productId);
                    const name = p ? p.name : (it.name || 'منتج');
                    const qty = it.quantity || it.qty || 0;
                    const price = Number(it.price||0);
                    const total = qty * price * (1 - (it.discountPercent||0)/100);
                    return `<tr><td class="n">${escapeHtml(name)}</td><td class="q">${qty}</td><td class="t">${formatCurrency(total)}</td></tr>`;
                }).join('');
                const total = formatCurrency(sale.total||0);
                const paid = formatCurrency(sale.paidAmount||0);
                const remain = formatCurrency((sale.total||0) - (sale.paidAmount||0));
                const custName = customer ? customer.name : 'عميل';
                const custPhone = customer ? (customer.phone||'') : '';
                const custTax = customer ? (customer.taxNumber||'') : '';

                                return `<!doctype html><html lang="ar" dir="rtl"><head>
                    <meta charset="utf-8" />
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
                    <title>طباعة فاتورة</title>
                    <style>
                        @page { size: 58mm auto; margin: 2mm; }
                        body { 
                            font-family: 'Cairo', sans-serif; 
                            direction: rtl; 
                            margin:0; 
                            padding:0;
                            -webkit-font-smoothing: antialiased;
                            -moz-osx-font-smoothing: grayscale;
                            text-rendering: optimizeLegibility;
                        }
                        .r { 
                            width: 58mm; 
                            max-width: 58mm; 
                            position: relative; 
                            padding: 2mm 0;
                            font-family: 'Cairo', sans-serif;
                        }
                        .center { text-align:center }
                        .h1 { font-weight:800; font-size:14px; }
                        .h2 { font-weight:700; font-size:12px; }
                        .row { display:flex; justify-content:space-between; font-size:12px }
                        table { width:100%; border-collapse:collapse; font-size:12px }
                        th { background:#f3f4f6; border:1px solid #e5e7eb; padding:2px; font-weight:700; font-size:11px }
                        td { padding:2px; border:1px solid #f1f5f9; font-size:11px; text-align:center }
                        td.n{ text-align:right; font-weight:600 }
                        td.q{ width:18%; }
                        td.t{ width:26%; text-align:left }
                        hr { border:none; border-top:1px dashed #000; margin:6px 0 }
                        .bold { font-weight:700 }
                        .small { font-size:11px }
                        .hdr { display:flex; align-items:center; justify-content:center; gap:6px; margin-bottom:2px }
                        .hdr img { width: 12mm; height:auto }
                        .tag { font-size:10px; font-weight:600; line-height:1; opacity:.9; margin-top:-2px; text-align:center }
                        .wm { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none }
                        .wm img { width:42mm; opacity:.06; }
                        .footer { font-size:10px; line-height:1.5; text-align:right }
                    </style>
                                </head><body>
                  <div class="r">
                                        <div class="wm">${logo ? `<img src="${logo}" />` : ''}</div>
                                                            <div class="hdr">${logo ? `<img src="${logo}" />` : ''}<div><div class="h1">Delente</div><div class="tag">it is just milk</div></div></div>
                    <div class="center h2">فاتورة مبيعات</div>
                    <div class="center small">${new Date().toLocaleString('ar-EG')}</div>
                    <hr />
                    <div class="small"><span class="bold">رقم الفاتورة:</span> ${inv}</div>
                    <div class="small"><span class="bold">التاريخ:</span> <bdo dir="rtl">${dateStr}</bdo></div>
                    <div class="small"><span class="bold">العميل:</span> ${escapeHtml(custName)}</div>
                    ${repName?`<div class="small"><span class="bold">المندوب:</span> ${escapeHtml(repName)}</div>`:''}
                    ${custPhone?`<div class="small"><span class="bold">هاتف العميل:</span> ${escapeHtml(custPhone)}</div>`:''}
                    ${custTax?`<div class="small"><span class="bold">رقم ضريبي للعميل:</span> ${escapeHtml(custTax)}</div>`:''}
                    <hr />
                    <table><thead><tr><th>الصنف</th><th>الكمية</th><th>الإجمالي</th></tr></thead><tbody>${rows}</tbody></table>
                    <hr />
                    <div class="row bold"><span>الإجمالي</span><span>${total}</span></div>
                    <div class="row"><span>المدفوع</span><span>${paid}</span></div>
                    <div class="row"><span>المتبقي</span><span>${remain}</span></div>
                    <hr />
                    <div class="footer">
                        <div>سجل تجاري: ${escapeHtml(String(registry))}</div>
                        <div>بطاقة ضريبية: ${escapeHtml(String(taxId))}</div>
                        <div>هاتف: ${escapeHtml(String(phone))}</div>
                        <div>E: ${escapeHtml(String(email))}</div>
                    </div>
                    <div class="center small" style="margin-top:4px">شكراً لتعاملكم معنا</div>
                                    </div>
                                </body></html>`;
            } catch(e){ return '<html><body>خطأ في تجهيز الفاتورة</body></html>'; }
        }

        window.printSaleById = async function(saleId){
            try {
                const sale = (state.sales||[]).find(s => String(s.id) === String(saleId));
                if (!sale) { alert('تعذر العثور على الفاتورة'); return; }
                const html = buildReceiptHtml58mm(sale);
                const w = window.open('', '', 'width=420,height=640');
                if (!w) { alert('يرجى السماح بالنوافذ المنبثقة للطباعة'); return; }

                // Write content and wait for load to avoid blocking/hangs
                w.document.open();
                w.document.write(html);
                w.document.close();

                const doPrint = () => {
                    try { w.focus(); } catch(_){}
                    try { w.print(); } catch(_){}
                };
                const closeAndReturn = () => {
                    // Close popup and restore focus to the app; also ensure pointer events are enabled
                    try { w.close(); } catch(_){}
                    try { window.focus(); } catch(_){}
                    try { document.body.style.pointerEvents = 'auto'; document.body.style.opacity = '1'; } catch(_){}
                };

                if ('onafterprint' in w) {
                    w.onafterprint = closeAndReturn;
                } else {
                    // Fallback: close after a short delay
                    setTimeout(closeAndReturn, 1200);
                }

                if ('onload' in w) {
                    w.onload = () => setTimeout(doPrint, 100);
                } else {
                    // Fallback if onload not firing
                    setTimeout(doPrint, 300);
                }
            } catch(e){ console.warn('printSaleById error', e); try { alert('تعذر بدء الطباعة'); } catch(_){} }
        }

        // (تمت إزالة الفاتورة المختصرة حسب طلبك؛ تمت إضافة بيانات الشركة داخل الطباعة الأساسية)

        // Optional: Share as image via Web Share on أندرويد
        window.shareSaleReceiptImage = async function(saleId){
            try {
                const sale = (state.sales||[]).find(s => String(s.id) === String(saleId));
                if (!sale) return alert('لم يتم العثور على الفاتورة');
                // Build a temporary DOM node for rendering
                const temp = document.createElement('div');
                temp.style.position = 'fixed';
                temp.style.left = '-10000px';
                temp.style.top = '0';
                temp.style.width = '384px'; /* عرض ثابت لالتقاط أنظف */
                temp.style.background = '#ffffff';
                temp.style.padding = '0';
                temp.style.margin = '0';
                temp.innerHTML = buildReceiptHtml58mm(sale);
                // ضبط العنصر الداخلي للفاتورة ليطابق العرض المطلوب
                const root = temp.querySelector('.r');
                if (root) {
                    root.style.width = '384px';
                    root.style.maxWidth = '384px';
                }
                document.body.appendChild(temp);
                const target = root || temp;
                // رفع الدقة لتقليل التموج والتشوه
                const canvas = await html2canvas(target, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                const file = new File([blob], `invoice-${sale.invoiceNumber||sale.id}.png`, { type: 'image/png' });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    // اطلب تأكيد بسرعة لضمان user gesture قبل استدعاء share
                    const confirmed = await (typeof customDialog === 'function'
                        ? customDialog({ title: 'الصورة جاهزة', message: 'اضغط "مشاركة الآن" لفتح قائمة المشاركة.', isConfirm: true, confirmText: 'مشاركة الآن', confirmClass: 'bg-indigo-600 hover:bg-indigo-700' })
                        : Promise.resolve(true));
                    if (confirmed) {
                        try {
                            await navigator.share({ files:[file] });
                        } catch(shareErr) {
                            console.warn('navigator.share failed, falling back', shareErr);
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a'); a.href = url; a.download = file.name; a.click(); URL.revokeObjectURL(url);
                            alert('تم حفظ صورة الفاتورة على جهازك.');
                        }
                    }
                } else {
                    // Fallback: download so it can be opened ببرنامج الطباعة (RawBT/Xprinter)
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = file.name; a.click(); URL.revokeObjectURL(url);
                    alert('تم حفظ صورة الفاتورة. افتحها في تطبيق الطابعة للطباعة.');
                }
                try { temp.remove(); } catch(_){}
            } catch(e){ console.warn('shareSaleReceiptImage failed', e); alert('تعذر مشاركة الفاتورة'); }
        }

        // Upload single sale to ETA via Netlify function
        window.uploadSaleToEta = async function(saleId){
            try {
                const sale = (state.sales||[]).find(s => String(s.id) === String(saleId));
                if (!sale) return alert('لم يتم العثور على الفاتورة');
                if (sale.taxUploadStatus === 'uploaded') {
                    if (!confirm('هذه الفاتورة مرفوعة بالفعل. إعادة الرفع؟')) return;
                }
                const invoice = transformSaleToEtaInvoice(sale);
                const resp = await fetch('/.netlify/functions/eta-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice })
                });
                let data = null;
                try { data = await resp.json(); } catch(_) { /* text fallback */ }
                if (resp.ok && data && data.accepted) {
                    sale.taxUploadStatus = 'uploaded';
                    sale.taxSubmissionUUID = data.submissionUUID || null;
                    sale.etaStatus = 'submitted';
                    sale.etaLastCheckAt = new Date().toISOString();
                    sale.etaErrors = [];
                    try { saveState(); } catch(_){ }
                    renderAllSales();
                    alert('تم إرسال الفاتورة وقبولها أولياً (202). سيتم التحقق لاحقاً.');
                } else {
                    const txt = (data && data.raw) ? JSON.stringify(data.raw) : await resp.text();
                    sale.taxUploadStatus = 'error';
                    sale.etaStatus = 'error';
                    sale.etaErrors = [txt.slice(0,300)];
                    sale.etaLastCheckAt = new Date().toISOString();
                    try { saveState(); } catch(_){ }
                    renderAllSales();
                    alert('فشل رفع الفاتورة: ' + txt);
                }
            } catch(e){ console.warn('uploadSaleToEta error', e); alert('تعذر رفع الفاتورة للمنظومة.'); }
        }

        // --- PROMOTION MODAL FUNCTION ---
        function openPromotionModal(id = null) {
            promotionForm.reset();
            document.getElementById('promotion-id').value = '';
            populateProductDropdown(document.getElementById('promotion-product'));
            // Use a specific version for the customer dropdown in promotions to include "All Customers"
            const customerSelect = document.getElementById('promotion-customer-id');
            customerSelect.innerHTML = '<option value="">-- جميع العملاء --</option>' + state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            document.getElementById('original-price-display').classList.add('hidden');

            if (id) {
                // Edit mode
                const promotion = state.promotions.find(p => p.id === id);
                if (promotion) {
                    document.getElementById('promotion-modal-title').textContent = 'تعديل العرض';
                    document.getElementById('promotion-id').value = promotion.id;
                    document.getElementById('promotion-name').value = promotion.name;
                    document.getElementById('promotion-product').value = promotion.productId;
                    document.getElementById('promotion-price').value = promotion.price;
                    customerSelect.value = promotion.customerId || '';
                    document.getElementById('promotion-start-date').value = promotion.startDate;
                    document.getElementById('promotion-end-date').value = promotion.endDate;
                    updatePromotionOriginalPriceDisplay(promotion.productId);
                }
            } else {
                // Add mode
                document.getElementById('promotion-modal-title').textContent = 'إضافة عرض جديد';
                // Set default dates
                document.getElementById('promotion-start-date').value = new Date().toISOString().split('T')[0];
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                document.getElementById('promotion-end-date').value = nextMonth.toISOString().split('T')[0];
            }

            openModal(promotionModal);
        }

        // --- BACKUP & RESTORE FUNCTIONS ---
        function copyTextToClipboard(text) {
            if (!text) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    customDialog({ title: 'نسخ', message: 'تم نسخ الكود إلى الحافظة.' });
                }).catch(() => {
                    // fallback
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); customDialog({ title: 'نسخ', message: 'تم نسخ الكود إلى الحافظة.' }); } catch (e) { customDialog({ title: 'خطأ', message: 'فشل نسخ الكود.' }); }
                    ta.remove();
                });
            } else {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); customDialog({ title: 'نسخ', message: 'تم نسخ الكود إلى الحافظة.' }); } catch (e) { customDialog({ title: 'خطأ', message: 'فشل نسخ الكود.' }); }
                ta.remove();
            }
        }

        function createBackup() {
            try {
                const backupTextarea = document.getElementById('backup-data-textarea');
                const copyBtn = document.getElementById('copy-backup-btn');
                const payload = JSON.stringify(state);
                if (backupTextarea) backupTextarea.value = payload;

        
                if (copyBtn) copyBtn.classList.remove('hidden');

                // Also store a timestamped backup in localStorage_backups
                try {
                    const backupsRaw = localStorage.getItem('mandoobiAppState_backups');
                    const backups = backupsRaw ? JSON.parse(backupsRaw) : [];
                    backups.unshift({ ts: new Date().toISOString(), data: state });
                    // Keep only recent 12 backups
                    while (backups.length > 12) backups.pop();
                    localStorage.setItem('mandoobiAppState_backups', JSON.stringify(backups));
                } catch (e) {
                    console.warn('Failed to save local backup list', e);
                }

                customDialog({ title: 'نسخة احتياطية', message: 'تم إنشاء النسخة الاحتياطية محلياً ويمكنك نسخ الكود أو تحميله يدوياً.' });
            } catch (e) {
                console.error('createBackup failed', e);
                customDialog({ title: 'خطأ', message: 'فشل إنشاء النسخة الاحتياطية.' });
            }
        }

        // --- LOCAL-STATE DEBUG & RESTORE PANEL (shows when state is empty) ---
        function showLocalStateDebug() {
            if (document.getElementById('app-local-debug')) return; // already present

            try {
                const panel = document.createElement('div');
                panel.id = 'app-local-debug';
                panel.style.position = 'fixed';
                panel.style.right = '18px';
                panel.style.bottom = '18px';
                panel.style.width = '360px';
                panel.style.maxHeight = '60vh';
                panel.style.overflow = 'auto';
                panel.style.zIndex = '99999';
                panel.style.background = 'linear-gradient(180deg,#fff, #fbfaf8)';
                panel.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
                panel.style.borderRadius = '8px';
                panel.style.padding = '12px';
                panel.style.fontSize = '13px';
                panel.style.direction = 'rtl';
                panel.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <strong style="font-size:14px">تشخيص واسترداد الحالة المحلية</strong>
                        <button id="close-local-debug" style="background:#eee;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">إغلاق</button>
                    </div>
                    <div style="font-size:12px;color:#444;margin-bottom:8px">ملاحظة: عند فتح الملف عبر <code>file://</code>، فإن الـlocalStorage مرتبط بمسار الملف؛ نقل الملف قد يجعل البيانات غير مرئية. إذا كانت لديك نسخة احتياطية، الصقها في الحقل أدناه ثم اضغط استرجاع.</div>
                    <div style="margin-bottom:8px">
                        <div id="local-state-keys" style="background:#fff;padding:8px;border:1px solid #eee;border-radius:6px;max-height:120px;overflow:auto"></div>
                    </div>
                    <div style="margin-bottom:8px">
                        <textarea id="local-state-restore" placeholder="الصق هنا JSON كامل للحالة (مثال: محتوى mandoobiAppState)" style="width:100%;height:120px;border:1px solid #ddd;padding:8px;border-radius:6px;font-size:12px"></textarea>
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-start">
                        <button id="restore-state-btn" style="background:#1f7bd7;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">استرجاع الحالة</button>
                        <button id="download-backups-btn" style="background:#6b7280;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">تنزيل النسخ الاحتياطية</button>
                        <button id="open-storage-btn" style="background:#10b981;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">عرض في Console</button>
                    </div>
                    <div id="local-state-msg" style="margin-top:8px;font-size:12px;color:#444"></div>
                `;

                document.body.appendChild(panel);

                // Populate keys/preview
                const keysEl = document.getElementById('local-state-keys');
                try {
                    const keys = Object.keys(localStorage).filter(k => k.includes('mandoobiAppState') || k.includes('mandoobi'));
                    if (keys.length === 0) {
                        keysEl.textContent = 'لا توجد مفاتيح محلية متعلقة بالتطبيق في localStorage لهذه الصفحة.';
                    } else {
                        keys.forEach(k => {
                            const raw = localStorage.getItem(k);
                            let preview = '';
                            try { const parsed = JSON.parse(raw); if (Array.isArray(parsed.sales)) { preview = `sales:${parsed.sales.length}`; } else if (parsed && parsed.sales) { preview = `sales:${(parsed.sales && parsed.sales.length) || '؟'}`; } else preview = raw ? raw.toString().slice(0,200) : 'empty'; } catch (e) { preview = raw ? raw.toString().slice(0,200) : 'empty'; }
                            const row = document.createElement('div');
                            row.style.padding = '6px 0';
                            row.style.borderBottom = '1px dashed #f0f0f0';
                            row.innerHTML = `<div style="font-weight:600;margin-bottom:4px">${k}</div><div style='font-size:12px;color:#666'>${preview}</div>`;
                            keysEl.appendChild(row);
                        });
                    }
                } catch (e) { keysEl.textContent = 'فشل قراءة localStorage: ' + (e.message || e); }

                document.getElementById('close-local-debug').addEventListener('click', () => panel.remove());

                document.getElementById('open-storage-btn').addEventListener('click', () => {
                    console.log('LocalStorage keys for this origin:');
                    Object.keys(localStorage).forEach(k => console.log(k, localStorage.getItem(k)));
                    const msg = document.getElementById('local-state-msg'); if (msg) msg.textContent = 'تم طباعة المحتوى في Console. افتح DevTools -> Console.';
                });

                document.getElementById('download-backups-btn').addEventListener('click', () => {
                    try {
                        const raw = localStorage.getItem('mandoobiAppState_backups');
                        if (!raw) { document.getElementById('local-state-msg').textContent = 'لا توجد نسخ احتياطية محفوظة.'; return; }
                        const a = document.createElement('a');
                        const blob = new Blob([raw], { type: 'application/json' });
                        a.href = URL.createObjectURL(blob);
                        a.download = 'mandoobiAppState_backups.json';
                        a.click();
                        document.getElementById('local-state-msg').textContent = 'تم تنزيل النسخ الاحتياطية.';
                    } catch (e) { document.getElementById('local-state-msg').textContent = 'فشل تنزيل النسخ الاحتياطية: ' + (e.message || e); }
                });

                document.getElementById('restore-state-btn').addEventListener('click', () => {
                    const ta = document.getElementById('local-state-restore');
                    const msg = document.getElementById('local-state-msg');
                    if (!ta || !ta.value.trim()) { if (msg) msg.textContent = 'الرجاء لصق JSON صالح في الحقل أعلاه.'; return; }
                    try {
                        const parsed = JSON.parse(ta.value);
                        localStorage.setItem('mandoobiAppState', JSON.stringify(parsed));
                        if (msg) msg.textContent = 'تم حفظ الحالة المحلية. سيتم إعادة تحميل الصفحة.';
                        setTimeout(() => location.reload(), 800);
                    } catch (e) {
                        if (msg) msg.textContent = 'خطأ في قراءة JSON: ' + (e.message || e);
                    }
                });

            } catch (e) {
                console.warn('showLocalStateDebug failed', e);
            }
        }

        async function restoreBackup() {
            try {
                const raw = document.getElementById('restore-data-textarea')?.value || '';
                if (!raw) {
                    await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء لصق كود النسخة الاحتياطية في الحقل المخصص.' });
                    return;
                }

                let parsed;
                try { parsed = JSON.parse(raw); } catch (e) { parsed = null; }
                if (!parsed) {
                    await customDialog({ title: 'خطأ', message: 'كود النسخة غير صالح. تأكد أنك قمت بلصق الكود كاملاً.' });
                    return;
                }

                const confirmed = await customDialog({ title: 'تأكيد الاستعادة', message: 'ستُستبدل جميع البيانات الحالية بالنسخة التي ألصقتها. هل تريد المتابعة؟', isConfirm: true, confirmText: 'نعم، استعد الآن', confirmClass: 'bg-red-600 hover:bg-red-700' });
                if (!confirmed) return;

                state = parsed;
                saveState();
                renderAll();
                await customDialog({ title: 'استعادة', message: 'تم استعادة البيانات من النسخة الملصوقة.' });
            } catch (e) {
                console.error('restoreBackup failed', e);
                await customDialog({ title: 'خطأ', message: 'فشل استعادة النسخة. تأكد من صحة الكود وحاول مرة أخرى.' });
            }
        }

        
        // --- All Function Definitions END ---

        // ================================================================
        // ===== INITIALIZATION AND AUTHENTICATION ======================
        // ================================================================

        // --- Firebase Initialization (Compat) ---
        // No firebaseConfig is embedded here. Provide `window.firebaseConfig` before loading this file.
        // When you create the project, add a small inline script before this file that sets `window.firebaseConfig = {...}`
        // تمت إزالة التهيئة المكررة هنا. التهيئة الأصلية تحدث في أعلى الملف عبر initFirebase().
        // إبقاء هذا التعليق للتوضيح فقط.

        // Ensure UI is not accidentally blocked by visible modals/overlays and attach listeners on DOM ready.
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Hide any modals that may be visible due to previous state
                document.querySelectorAll('.modal').forEach(m => {
                    try {
                        m.classList.remove('modal-visible');
                        m.classList.add('modal-hidden');
                    } catch (e) {}
                });

                // Ensure loading modal is hidden
                const lm = document.getElementById('loading-modal');
                if (lm) { lm.classList.remove('modal-visible'); lm.classList.add('modal-hidden'); }

                // Make sure the app container accepts pointer events
                const app = document.getElementById('app-container');
                if (app) app.style.pointerEvents = 'auto';

                // Attach event listeners even when auth is not present (file:// offline case)
                try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed on DOMContentLoaded', e); }

                // Small safety: if page-debts is active, trigger a render to populate rows
                setTimeout(() => {
                    try { if (document.getElementById('page-debts')?.classList.contains('active')) renderDebts(); } catch (e) {}
                }, 80);
            } catch (e) { console.warn('Startup cleanup failed', e); }
        });

        // --- Loading Functions ---
        function showLoading(message = "جارٍ التحميل...") {
            document.getElementById('loading-message').textContent = message;
            openModal(loadingModal);
        }
        function hideLoading() {
            closeModal(loadingModal);
        }

        // --- Event Listener Setup ---
        let eventListenersAttached = false;
        function setupAllEventListeners() {
            if (eventListenersAttached) return;
            console.log("Attaching event listeners for the first time...");

            // Navigation
            setupNavigationHandlers();

            // Dashboard
            document.getElementById('dashboard-rep-filter').addEventListener('change', renderDashboard);
            document.getElementById('dashboard-chain-filter').addEventListener('change', renderDashboard);
            populateChainsDropdown(document.getElementById('dashboard-chain-filter'));


            // Sales Page
            const searchSalesDateInput = document.getElementById('search-sales-date');
            const clearSalesDateBtn = document.getElementById('clear-sales-date-btn');
            const salesSearchHandler = () => {
                const textFilter = document.getElementById('search-sales-text').value;
                const dateFilter = searchSalesDateInput.value;
                const taxStatusFilter = document.getElementById('tax-status-filter').value;
                const reviewFilter = document.getElementById('review-status-filter')?.value || 'all';
                clearSalesDateBtn.classList.toggle('hidden', !dateFilter);
                renderAllSales(textFilter, dateFilter, taxStatusFilter, reviewFilter);
            };
            document.getElementById('search-sales-text').addEventListener('input', salesSearchHandler);
            searchSalesDateInput.addEventListener('input', salesSearchHandler);
            document.getElementById('tax-status-filter').addEventListener('change', salesSearchHandler);
            document.getElementById('review-status-filter').addEventListener('change', salesSearchHandler);
            clearSalesDateBtn.addEventListener('click', () => {
                searchSalesDateInput.value = '';
                salesSearchHandler();
            });

            // Total Bills Page
            document.getElementById('apply-filters-btn').addEventListener('click', () => renderTotalBills());
            // Debts Page - apply filters button (added)
            const applyDebtsBtn = document.getElementById('apply-debts-filters-btn');
            if (applyDebtsBtn) applyDebtsBtn.addEventListener('click', () => renderDebts());
            
            let currentSort = { key: 'date', direction: 'desc' };
            // Highlight handler for Total Bills table
            document.getElementById('total-bills-table-body').addEventListener('click', (e) => {
                const cell = e.target.closest('.invoice-cell');
                if (cell) {
                    const saleId = cell.dataset.id;
                    if (saleId) {
                        toggleReviewColor(saleId, cell);
                    }
                }
            });

            document.getElementById('total-bills-table').querySelector('thead').addEventListener('click', (e) => {
                const header = e.target.closest('th[data-sort]');
                if (!header) return;

                const sortKey = header.dataset.sort;
                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'desc';
                }
                renderTotalBills(currentSort.key, currentSort.direction);
            });

            const selectAllCheckbox = document.getElementById('select-all-total-bills');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    document.querySelectorAll('#total-bills-table-body input.total-bill-row-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                });
            }

            // Stock Control Page
            document.getElementById('stock-control-date').addEventListener('change', renderStockLedger);
            document.getElementById('save-stock-control-btn').addEventListener('click', saveStockBalances);

            // Sale Modal Form
            saleForm.addEventListener('submit', saveSale);
            document.getElementById('cancel-sale-btn').addEventListener('click', () => closeModal(saleModal));
            document.getElementById('add-sale-item-btn').addEventListener('click', () => addSaleItemRow());
            document.getElementById('sale-status').addEventListener('change', updateSaleSummary);
            document.getElementById('sale-discount').addEventListener('input', updateSaleSummary);

            // Other page listeners...
            document.getElementById('search-customers').addEventListener('input', (e) => renderCustomers(e.target.value));
            initializeChainsDisplay(); // Initialize chains display on page load
            document.getElementById('search-products').addEventListener('input', (e) => renderSettings(e.target.value));
            document.getElementById('spreadsheet-save-all-btn').addEventListener('click', saveAllSpreadsheetEntries);
            document.getElementById('spreadsheet-add-row-btn').addEventListener('click', addSpreadsheetRow);
            unifiedInvoiceNumberInput.addEventListener('input', (e) => {
                const unifiedNumber = e.target.value.trim();
                spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row => {
                    const invoiceInput = row.querySelector('.spreadsheet-invoice-number');
                    if (invoiceInput) invoiceInput.value = unifiedNumber;
                });
            });

            // Settings: products & price-lists handlers
            const addProductBtn = document.getElementById('add-product-btn');
            if (addProductBtn) addProductBtn.addEventListener('click', () => openProductModal());
            const addPriceListBtn = document.getElementById('add-price-list-btn');
            if (addPriceListBtn) addPriceListBtn.addEventListener('click', () => openPriceListModal());

            // Product / Price list forms
            if (productForm) productForm.addEventListener('submit', saveProduct);
            const cancelProductBtn = document.getElementById('cancel-product-btn');
            if (cancelProductBtn) cancelProductBtn.addEventListener('click', () => closeModal(productModal));

            if (priceListForm) priceListForm.addEventListener('submit', savePriceList);
            const cancelPriceListBtn = document.getElementById('cancel-price-list-btn');
            if (cancelPriceListBtn) cancelPriceListBtn.addEventListener('click', () => closeModal(priceListModal));

            // Delegated click handlers for edit/delete buttons in Settings
            document.addEventListener('click', async (e) => {
                const editProd = e.target.closest('.edit-product-btn');
                if (editProd) {
                    const id = editProd.dataset.id;
                    if (id) openProductModal(id);
                    return;
                }
                const delProd = e.target.closest('.delete-product-btn');
                if (delProd) {
                    const id = delProd.dataset.id;
                    if (!id) return;
                    const confirmed = await customDialog({ isConfirm: true, message: 'هل متأكد أنك تريد حذف هذا المنتج؟', title: 'تأكيد الحذف', confirmText: 'حذف', confirmClass: 'bg-red-600 hover:bg-red-700' });
                    if (confirmed) {
                        try {
                            await deleteProduct(id);
                            await customDialog({ title: 'تم', message: 'تم حذف المنتج نهائياً.' });
                        } catch (err) {
                            console.warn('deleteProduct failed', err);
                            await customDialog({ title: 'خطأ', message: 'تعذر حذف المنتج من السحابة.' });
                        }
                    }
                    return;
                }

                const editPl = e.target.closest('.edit-price-list-btn');
                if (editPl) {
                    const id = editPl.dataset.id;
                    if (id) openPriceListModal(id);
                    return;
                }
                const delPl = e.target.closest('.delete-price-list-btn');
                if (delPl) {
                    const id = delPl.dataset.id;
                    if (!id) return;
                    const confirmed = await customDialog({ isConfirm: true, message: 'هل متأكد أنك تريد حذف هذه القائمة؟', title: 'تأكيد الحذف', confirmText: 'حذف', confirmClass: 'bg-red-600 hover:bg-red-700' });
                    if (confirmed) {
                        try {
                            await deletePriceListDoc(id);
                            await customDialog({ title: 'تم', message: 'تم حذف القائمة نهائياً.' });
                        } catch (err) {
                            console.warn('deletePriceList failed', err);
                            await customDialog({ title: 'خطأ', message: 'تعذر حذف قائمة الأسعار من السحابة.' });
                        }
                    }
                    return;
                }
            });

            const addCustomerBtn = document.getElementById('add-customer-btn');
            // Customers Page
            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { customDialog({ title: 'صلاحيات', message: 'المندوب لا يملك صلاحية إضافة عميل.' }); return; }
                    openCustomerModal();
                });
                // إخفاء زر الإضافة للمندوب
                try { if ((typeof getUserRole === 'function') && getUserRole() === 'rep') addCustomerBtn.style.display = 'none'; } catch(_){}
            }
            document.getElementById('cancel-customer-btn').addEventListener('click', () => closeModal(customerModal));

            customerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('customer-id').value;
                const payload = {
                    name: document.getElementById('customer-name').value.trim(),
                    taxNumber: document.getElementById('customer-tax-number').value.trim(),
                    phone: document.getElementById('customer-phone').value.trim(),
                    address: document.getElementById('customer-address').value.trim(),
                    requiresTaxFiling: document.getElementById('customer-requires-tax').checked,
                    priceListId: document.getElementById('customer-price-list').value || '',
                    repName: document.getElementById('customer-rep').value || '',
                    assignedRepId: (function(){
                        const repField = document.getElementById('customer-rep').value || '';
                        if (!repField) return '';
                        try { const repObj = window.findRep ? window.findRep(repField) : null; return repObj ? repObj.id : ''; } catch(e){ return ''; }
                    })()
                };

                if (!payload.name) {
                    await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء إدخال اسم العميل.' });
                    return;
                }

                const isDuplicate = Array.isArray(state.customers)
                    ? state.customers.some(c => (c.name||'').trim() === payload.name && (c.id||c._id) !== id)
                    : false;
                if (isDuplicate) {
                    await customDialog({ title: 'اسم مكرر', message: 'يوجد عميل آخر بنفس الاسم. الرجاء استخدام اسم مختلف.' });
                    return;
                }

                try {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { await customDialog({ title:'صلاحيات', message:'المندوب لا يملك صلاحية إضافة/تعديل العملاء.' }); return; }
                    if (id) {
                        await updateCustomer(id, payload);
                    } else {
                        await addCustomer(payload);
                    }
                    closeModal(customerModal);
                    await customDialog({ message: 'تم حفظ بيانات العميل بنجاح.', title: 'نجاح' });
                    // ملاحظة: سيتم تحديث القائمة تلقائياً عبر onSnapshot
                } catch (err) {
                    const msg = (err && err.code === 'permission-denied') ? 'ليست لديك صلاحية تعديل العملاء' : 'فشل حفظ بيانات العميل';
                    await customDialog({ title: 'خطأ', message: msg });
                }
            });

            document.getElementById('customers-list').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-customer-btn');
                const deleteBtn = e.target.closest('.delete-customer-btn');
                const claimBtn = e.target.closest('.claim-customer-btn');

                // مطالبة (تعيين) عميل غير معيّن للمندوب الحالي
                if (claimBtn) {
                    try {
                        const customerId = claimBtn.getAttribute('data-id');
                        const current = AuthSystem.getCurrentUser();
                        if (!current) { await customDialog({ title:'غير مسجل', message:'سجل الدخول أولاً.' }); return; }
                        const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                        if (role !== 'rep') { await customDialog({ title:'ممنوع', message:'هذه الميزة للمندوبين فقط.' }); return; }
                        const customer = (state.customers||[]).find(c => (c.id||c._id) === customerId);
                        if (!customer) return;
                        if (customer.assignedRepId) { await customDialog({ title:'تم التعيين', message:'هذا العميل أصبح مخصصاً بالفعل.' }); return; }
                        const repNameGuess = current.name || (current.email ? current.email.split('@')[0] : 'مندوب');
                        await updateCustomer(customerId, { assignedRepId: current.id, repName: customer.repName || repNameGuess });
                        await customDialog({ title:'تم', message:'تم تعيين العميل لك.' });
                        try { renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
                    } catch(err){ console.warn('claim customer failed', err); }
                    return; // لا تتابع للأزرار الأخرى
                }

                if (editBtn) {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { await customDialog({ title:'صلاحيات', message:'المندوب لا يملك صلاحية تعديل العملاء.' }); return; }
                    const customerId = editBtn.dataset.id;
                    const customer = (state.customers||[]).find(c => (c.id||c._id) === customerId);
                    if (!canManageCustomer(customer)) {
                        await customDialog({ title:'صلاحيات', message:'لا يمكنك تعديل هذا العميل لأنه ليس مخصصاً لك.' });
                        return;
                    }
                    openCustomerModal(customerId);
                }

                if (deleteBtn) {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'rep') { await customDialog({ title:'صلاحيات', message:'المندوب لا يملك صلاحية حذف العملاء.' }); return; }
                    const customerId = deleteBtn.dataset.id;
                    const customer = Array.isArray(state.customers)
                        ? state.customers.find(c => (c.id||c._id) === customerId)
                        : null;
                    if (!customer) return;
                    if (!canManageCustomer(customer)) {
                        await customDialog({ title:'صلاحيات', message:'لا يمكنك حذف هذا العميل لأنه ليس مخصصاً لك.' });
                        return;
                    }

                    const customerHasSales = Array.isArray(state.sales)
                        ? state.sales.some(s => s.customerId === customerId)
                        : false;
                    if (customerHasSales) {
                        await customDialog({
                            title: 'لا يمكن الحذف',
                            message: `لا يمكن حذف العميل "${customer.name}" لأن لديه فواتير مسجلة.`
                        });
                        return;
                    }

                    const confirmed = await customDialog({
                        title: 'تأكيد الحذف',
                        message: `هل أنت متأكد أنك تريد حذف العميل "${customer.name}"؟`,
                        isConfirm: true,
                        confirmText: 'نعم، احذف',
                        confirmClass: 'bg-red-600 hover:bg-red-700'
                    });

                    if (confirmed) {
                        try {
                            await deleteCustomer(customerId);
                            await customDialog({ message: 'تم حذف العميل بنجاح.' });
                            // سيتم تحديث القائمة تلقائياً عبر onSnapshot
                        } catch (err) {
                            const msg = (err && err.code === 'permission-denied') ? 'ليست لديك صلاحية حذف العملاء' : 'فشل حذف العميل';
                            await customDialog({ title: 'خطأ', message: msg });
                        }
                    }
                }
            });

            // Reps Page
            document.getElementById('add-rep-btn').addEventListener('click', () => openRepModal());
            document.getElementById('cancel-rep-btn').addEventListener('click', () => closeModal(repModal));

            repForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('rep-id').value;
                const name = document.getElementById('rep-name').value.trim();
                const serial = document.getElementById('rep-serial').value.trim();
                const target = parseFloat(document.getElementById('rep-target').value) || 0;
                const nextInvoiceNumber = parseInt(document.getElementById('rep-next-invoice').value) || null;

                if (!name) {
                    await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء إدخال اسم المندوب.' });
                    return;
                }

                const isDuplicate = (state.reps||[]).some(r => r.name === name && r.id !== id);
                if (isDuplicate) {
                    await customDialog({ title: 'اسم مكرر', message: 'يوجد مندوب آخر بنفس الاسم. الرجاء استخدام اسم مختلف.' });
                    return;
                }

                try {
                    if (id) {
                        await updateRepDoc(id, { name, serial, target, nextInvoiceNumber });
                    } else {
                        await addRepDoc(undefined, { name, serial, target, nextInvoiceNumber });
                    }
                    closeModal(repModal);
                    await customDialog({ message: 'تم حفظ بيانات المندوب في السحابة.', title: 'نجاح' });
                } catch (err) {
                    console.warn('saveRep cloud failed', err);
                    await customDialog({ title: 'خطأ', message: 'تعذر حفظ بيانات المندوب. تحقق من الاتصال والصلاحيات.' });
                }
            });

            document.getElementById('reps-list').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-rep-btn');
                const deleteBtn = e.target.closest('.delete-rep-btn');

                if (editBtn) {
                    const repId = editBtn.dataset.id;
                    openRepModal(repId);
                }

                if (deleteBtn) {
                    const repId = deleteBtn.dataset.id;
                    const rep = (state.reps||[]).find(r => r.id === repId);
                    if (!rep) return;

                    const repHasSales = (state.sales||[]).some(s => s.repName === rep.name);
                    if (repHasSales) {
                        await customDialog({
                            title: 'لا يمكن الحذف',
                            message: `لا يمكن حذف المندوب "${rep.name}" لأن لديه فواتير مسجلة. يمكنك تعديل بياناته بدلاً من ذلك.`
                        });
                        return;
                    }

                    const confirmed = await customDialog({
                        title: 'تأكيد الحذف',
                        message: `هل أنت متأكد أنك تريد حذف المندوب "${rep.name}"؟`,
                        isConfirm: true,
                        confirmText: 'نعم، احذف',
                        confirmClass: 'bg-red-600 hover:bg-red-700'
                    });

                    if (confirmed) {
                        try {
                            await deleteRepDoc(repId);
                            await customDialog({ message: 'تم حذف المندوب نهائياً.' });
                        } catch (err) {
                            console.warn('deleteRep failed', err);
                            await customDialog({ title: 'خطأ', message: 'تعذر حذف المندوب من السحابة.' });
                        }
                    }
                }
            });

            // Modal and Form Button Handlers
            document.getElementById('cancel-customer-btn').addEventListener('click', () => closeModal(customerModal));
            // ... Add all other modal and form handlers here from the old code

            document.getElementById('add-promotion-btn').addEventListener('click', () => openPromotionModal());
            document.getElementById('cancel-promotion-btn').addEventListener('click', () => closeModal(promotionModal));

            // Batch promotions editor wiring
            const bpAdd = document.getElementById('batch-promo-add-row');
            const bpSave = document.getElementById('batch-promo-save');
            if (bpAdd) bpAdd.addEventListener('click', () => addBatchPromoRow());
            if (bpSave) bpSave.addEventListener('click', saveBatchPromotions);

            promotionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('promotion-id').value;
                const promotionData = {
                    id: id || Date.now().toString(),
                    updatedAt: new Date().toISOString(),
                    name: document.getElementById('promotion-name').value,
                    productId: document.getElementById('promotion-product').value,
                    price: parseFloat(document.getElementById('promotion-price').value),
                    customerId: document.getElementById('promotion-customer-id').value || null,
                    startDate: document.getElementById('promotion-start-date').value,
                    endDate: document.getElementById('promotion-end-date').value,
                };

                if (!promotionData.name || !promotionData.productId || isNaN(promotionData.price) || !promotionData.startDate || !promotionData.endDate) {
                    await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء ملء جميع الحقول المطلوبة (الاسم، المنتج، السعر، التواريخ).' });
                    return;
                }

                try {
                    if (window.db) {
                        // Persist to Firestore
                        if (id) {
                            await db.collection('promotions').doc(id).set({
                                name: promotionData.name,
                                productId: promotionData.productId,
                                price: Number(promotionData.price||0),
                                customerId: promotionData.customerId || null,
                                startDate: promotionData.startDate,
                                endDate: promotionData.endDate,
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                        } else {
                            const ref = db.collection('promotions').doc();
                            promotionData.id = ref.id;
                            await ref.set({
                                id: promotionData.id,
                                name: promotionData.name,
                                productId: promotionData.productId,
                                price: Number(promotionData.price||0),
                                customerId: promotionData.customerId || null,
                                startDate: promotionData.startDate,
                                endDate: promotionData.endDate,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }, { merge: false });
                        }
                    } else {
                        // Fallback: update local state only
                        if (id) {
                            const index = state.promotions.findIndex(p => p.id === id);
                            if (index >= 0) state.promotions[index] = promotionData; else state.promotions.push(promotionData);
                        } else {
                            state.promotions.push(promotionData);
                        }
                    }
                } catch (err) {
                    console.warn('حفظ العرض في Firestore فشل، سيتم الحفظ محلياً فقط', err);
                    if (id) {
                        const index = state.promotions.findIndex(p => p.id === id);
                        if (index >= 0) state.promotions[index] = promotionData; else state.promotions.push(promotionData);
                    } else {
                        state.promotions.push(promotionData);
                    }
                }

                closeModal(promotionModal);
                renderAll();
                await customDialog({ message: 'تم حفظ العرض بنجاح.', title: 'نجاح' });
            });

            document.getElementById('promotion-product').addEventListener('change', (e) => {
                updatePromotionOriginalPriceDisplay(e.target.value);
            });

            document.getElementById('promotions-list').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-promotion-btn');
                const deleteBtn = e.target.closest('.delete-promotion-btn');

                if (editBtn) {
                    const promoId = editBtn.dataset.id;
                    openPromotionModal(promoId);
                }

                if (deleteBtn) {
                    const promoId = deleteBtn.dataset.id;
                    const confirmed = await customDialog({
                        title: 'تأكيد الحذف',
                        message: 'هل أنت متأكد أنك تريد حذف هذا العرض؟',
                        isConfirm: true,
                        confirmText: 'نعم، احذف',
                        confirmClass: 'bg-red-600 hover:bg-red-700'
                    });

                    if (confirmed) {
                        try {
                            if (window.db) {
                                await db.collection('promotions').doc(promoId).delete();
                            }
                        } catch (err) {
                            console.warn('فشل حذف العرض من Firestore، سيُحذف محلياً فقط', err);
                        }
                        state.promotions = state.promotions.filter(p => p.id !== promoId);
                        renderAll();
                        await customDialog({ message: 'تم حذف العرض بنجاح.' });
                    }
                }
            });

            // Dynamic List Click Handlers (delegated)
            document.getElementById('sales-list').addEventListener('click', salesListClickHandler);
            // ... Add all other dynamic list handlers

            // Settings Page
            // Settings: save monthly sales target
            const saveTargetBtn = document.getElementById('save-target-btn');
            if (saveTargetBtn) saveTargetBtn.addEventListener('click', saveSalesTarget);
            document.getElementById('backup-data-btn').addEventListener('click', createBackup);
            document.getElementById('copy-backup-btn').addEventListener('click', () => copyTextToClipboard(document.getElementById('backup-data-textarea').value));
            document.getElementById('restore-data-btn').addEventListener('click', restoreBackup);
            // Admin-only: Cloud import tool wiring
            function showHideAdminImportTool(){
                try {
                    const sec = document.getElementById('admin-cloud-import-section');
                    if (!sec) return;
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                    if (role === 'admin') sec.classList.remove('hidden'); else sec.classList.add('hidden');
                } catch(e) { /* ignore */ }
            }
            async function handleAdminStartImport(){
                const statusEl = document.getElementById('admin-import-status');
                const btn = document.getElementById('admin-start-import-btn');
                const fileInput = document.getElementById('admin-import-file');
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role !== 'admin') { alert('هذه الأداة متاحة للمشرف فقط'); return; }
                if (!window.db) { alert('Firestore غير جاهز. تأكد من تسجيل الدخول.'); return; }
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('من فضلك اختر ملف النسخة أولاً'); return; }
                const file = fileInput.files[0];
                btn.disabled = true;
                if (statusEl) statusEl.textContent = 'جاري قراءة الملف وتحليله...';
                try {
                    const text = await new Promise((resolve, reject) => { const rdr = new FileReader(); rdr.onload = () => resolve(rdr.result); rdr.onerror = reject; rdr.readAsText(file, 'utf-8'); });
                    const backup = (typeof parseBackupText === 'function') ? parseBackupText(text) : JSON.parse(text);
                    if (!backup || typeof backup !== 'object') { throw new Error('صيغة الملف غير صالحة'); }
                    if (statusEl) statusEl.textContent = 'جاري الاستيراد إلى Firestore (قد يستغرق دقائق للملفات الكبيرة)...';
                    const options = {
                        importCustomers: true,
                        importProducts: true,
                        importPriceLists: true,
                        importSales: true,
                        importReps: true,
                        importPromotions: true,
                        importSettings: true,
                        importDispatchNotes: !!backup.dispatchNotes,
                        importStockEntries: !!backup.stockEntries,
                        importNotifications: !!backup.notifications
                    };
                    const res = await importBackupObject(backup, options);
                    if (!res || res.ok !== true) {
                        throw new Error('فشل الاستيراد: ' + (res && res.error ? (res.error.message || String(res.error)) : 'خطأ غير معروف'));
                    }
                    if (statusEl) {
                        const c = res.counts || {};
                        statusEl.textContent = `تم الاستيراد بنجاح ✅ — عملاء: ${c.customers||0}, منتجات: ${c.products||0}, قوائم أسعار: ${c.priceLists||0}, مناديب: ${c.reps||0}, مبيعات: ${c.sales||0}`;
                    }
                    try { scheduleEnsureCoreData(); } catch(e) {}
                } catch (e) {
                    console.warn('Admin cloud import failed', e);
                    alert('فشل الاستيراد: ' + (e && e.message ? e.message : 'خطأ غير معروف'));
                } finally {
                    btn.disabled = false;
                }
            }
            showHideAdminImportTool();
            setTimeout(showHideAdminImportTool, 1200);
            setTimeout(showHideAdminImportTool, 4000);
            const adminStartBtn = document.getElementById('admin-start-import-btn');
            if (adminStartBtn) adminStartBtn.addEventListener('click', handleAdminStartImport);
            



            // Dispatch Notes Page (New Grid Implementation)
            document.getElementById('add-new-dispatch-item-btn').addEventListener('click', () => addRowToNewDispatchGrid());
            document.getElementById('save-new-dispatch-note-btn').addEventListener('click', saveNewDispatchNoteFromGrid);

            document.getElementById('page-dispatch').addEventListener('click', async (e) => {
                    const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                // Expand/collapse note details
                const header = e.target.closest('.dispatch-note-header');
                if (header) {
                    const card = header.closest('.dispatch-note-card');
                    if (!card) return; // safety
                    const details = card.querySelector('.dispatch-note-details');
                    const icon = header.querySelector('i[data-lucide="chevron-down"]');
                    if (!details) return; // safety
                    const noteId = card.dataset.noteId;
                    const isHidden = details.classList.contains('hidden');

                    if (isHidden) {
                            // للمندوب: عرض للقراءة فقط
                            if (role === 'rep') {
                                try { renderReadonlyDispatchGrid(noteId, details); } catch(_) { /* fallback */ renderEditableDispatchGrid(noteId, details); }
                            } else {
                                renderEditableDispatchGrid(noteId, details);
                            }
                        details.classList.remove('hidden');
                        if (icon) icon.style.transform = 'rotate(180deg)';
                    } else {
                        details.classList.add('hidden');
                        details.innerHTML = '';
                        if (icon) icon.style.transform = 'rotate(0deg)';
                    }
                    return;
                }

                // Update an existing note
                const updateBtn = e.target.closest('.update-dispatch-note-btn');
                if (updateBtn && role !== 'rep') {
                    const noteId = updateBtn.dataset.noteId;
                    const table = updateBtn.closest('.dispatch-note-details').querySelector('.editable-dispatch-table');
                    await updateDispatchNote(noteId, table);
                    return;
                }

                // Print a dispatch note
                const printBtn = e.target.closest('.print-dispatch-note-btn');
                if (printBtn) {
                    const noteId = printBtn.dataset.noteId;
                    printDispatchNote(noteId);
                    return;
                }

                const copyBtn = e.target.closest('.copy-dispatch-note-btn');
                if (copyBtn) {
                    const noteId = copyBtn.dataset.noteId;
                    await copyDispatchNoteAsImage(noteId);
                    return;
                }

                // Delete an existing note
                const deleteNoteBtn = e.target.closest('.delete-dispatch-note-btn');
                if (deleteNoteBtn && role !== 'rep') {
                    const noteId = deleteNoteBtn.dataset.noteId;
                    await deleteDispatchNote(noteId);
                    return;
                }
                
                // Add a row to an editable grid
                const addRowBtn = e.target.closest('.add-editable-dispatch-item-btn');
                if (addRowBtn && role !== 'rep') {
                    const tableBody = addRowBtn.closest('.dispatch-note-details').querySelector('tbody');
                    const newRow = document.createElement('tr');
                    newRow.className = 'dispatch-item-row';
                    const productOptions = state.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    newRow.innerHTML = `
                        <td class="px-2 py-1"><select class="dispatch-item-product w-full p-1 border rounded-md text-sm" required><option value="">اختر منتج...</option>${productOptions}</select></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="quantity" placeholder="0" min="0"></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="goodReturn" placeholder="0" min="0"></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="damagedReturn" placeholder="0" min="0"></td>
                        <td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="freebie" placeholder="0" min="0"></td>
                        <td class="px-2 py-1 text-center"><button type="button" class="delete-dispatch-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    `;
                    tableBody.appendChild(newRow);
                    updateIcons();
                    return;
                }

                // Delete a row from any grid (new or editable)
                const deleteRowBtn = e.target.closest('.delete-dispatch-item-btn');
                if (deleteRowBtn && role !== 'rep') {
                    const row = deleteRowBtn.closest('tr');
                    if (row) row.remove();
                    return;
                }
            });

            // Reports Page
            // Initialize chain dropdowns for reports
            populateChainsDropdown(document.getElementById('daily-report-chain'));
            populateChainsDropdown(document.getElementById('range-report-chain'));
            populateChainsDropdown(document.getElementById('monthly-report-chain'));
            populateChainsDropdown(document.getElementById('recon-report-chain'));
            populateChainsDropdown(document.getElementById('targets-chain-filter'));
            
            document.getElementById('generate-daily-report-btn').addEventListener('click', generateDailyReport);
            document.getElementById('generate-recon-report-btn').addEventListener('click', generateReconciliationReport);
            try { document.getElementById('generate-range-report-btn').addEventListener('click', generateRangeReport); } catch(e){}
            try { document.getElementById('generate-monthly-report-btn').addEventListener('click', generateMonthlyReport); } catch(e){}
            // Targets: regenerate on month or rep filter change
            try {
                const tMonth = document.getElementById('targets-month');
                if (tMonth) tMonth.addEventListener('change', generateTargetsReport);
                const tRep = document.getElementById('targets-rep-filter');
                if (tRep) tRep.addEventListener('change', generateTargetsReport);
                const tChain = document.getElementById('targets-chain-filter');
                if (tChain) tChain.addEventListener('change', generateTargetsReport);
            } catch(e){}
            // Add chain change listeners to other reports
            try {
                const dChain = document.getElementById('daily-report-chain');
                if (dChain) dChain.addEventListener('change', generateDailyReport);
                const rChain = document.getElementById('range-report-chain');
                if (rChain) rChain.addEventListener('change', generateRangeReport);
                const mChain = document.getElementById('monthly-report-chain');
                if (mChain) mChain.addEventListener('change', generateMonthlyReport);
                const rcChain = document.getElementById('recon-report-chain');
                if (rcChain) rcChain.addEventListener('change', generateReconciliationReport);
            } catch(e){}
            // Customer Targets: handlers for month/category and save/refresh
            try {
                const cMonth = document.getElementById('customer-targets-month');
                if (cMonth) cMonth.addEventListener('change', generateCustomerTargetsReport);
                const cCat = document.getElementById('customer-targets-category');
                if (cCat) cCat.addEventListener('change', generateCustomerTargetsReport);
                const cRefresh = document.getElementById('refresh-customer-targets-btn');
                if (cRefresh) cRefresh.addEventListener('click', generateCustomerTargetsReport);
                const cSave = document.getElementById('save-customer-targets-btn');
                if (cSave) cSave.addEventListener('click', saveCustomerTargetsFromInputs);
            } catch(e){ console.warn('customer targets handlers failed', e); }
            // تمت إزالة تسوية بسيطة؛ لا حاجة لقوائم خاصة بها

            // Manual statement button
            document.getElementById('manual-statement-btn').addEventListener('click', () => {
                // Set default dates
                document.getElementById('end-date').value = new Date().toISOString().split('T')[0];
                const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
                document.getElementById('start-date').value = thirtyDaysAgo;
                
                openModal(dateRangeModal);
                updateCustomerList();
            });

            

            // Manual statement form submission
            document.getElementById('date-range-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const category = document.querySelector('input[name="product-category"]:checked').value;
                const selectedCustomerNodes = document.querySelectorAll('#statement-customer-list input[type="checkbox"]:checked');
                
                if (!startDate || !endDate) {
                    await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء تحديد تاريخ البداية والنهاية.' });
                    return;
                }
                if (selectedCustomerNodes.length === 0) {
                    await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء اختيار عميل واحد على الأقل.' });
                    return;
                }

                // Expand chain IDs to actual customer IDs
                let expandedIds = [];
                const chains = loadChains();
                Array.from(selectedCustomerNodes).forEach(node => {
                    const val = node.value;
                    if (val.startsWith('chain-')) {
                        const chainId = val.substring(6);
                        const chain = chains.find(c => c.id === chainId);
                        if (chain) expandedIds.push(...(chain.customerIds || []));
                    } else {
                        expandedIds.push(val);
                    }
                });
                
                const customerNames = expandedIds.map(id => findCustomer(id)?.name).filter(n => n).join(', ');
                const title = `كشف حساب يدوي`;

                generateAndShowStatement(new Date(startDate), new Date(endDate), expandedIds, title, customerNames, category);
                closeModal(dateRangeModal);
            });
            
            document.getElementById('cancel-date-range-btn').addEventListener('click', () => {
                closeModal(dateRangeModal);
            });

            // Search in statement customer list
            document.getElementById('statement-customer-search').addEventListener('input', (e) => {
                updateCustomerList(e.target.value);
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    alert('فشل تسجيل الخروج: ' + error.message);
                }
            });

            // Debts Page
            try {
                const debtCustomerInput = document.getElementById('debt-customer-filter');
                const debtRepSelect = document.getElementById('debt-rep-filter');
                const debtStartDate = document.getElementById('debt-start-date');
                const debtEndDate = document.getElementById('debt-end-date');
                const debtStatusSelect = document.getElementById('debt-status-filter');
                const debtsCsvBtn = document.getElementById('debts-csv-btn');
                const debtsPrintBtn = document.getElementById('debts-print-btn');

                if (debtRepSelect) populateRepDropdown(debtRepSelect);

                const debtsRerender = () => renderDebts();

                // debt-customer-filter is now a select populated only with customers that have invoices
                if (debtCustomerInput) debtCustomerInput.addEventListener('change', debtsRerender);
                if (debtRepSelect) debtRepSelect.addEventListener('change', debtsRerender);
                if (debtStartDate) debtStartDate.addEventListener('change', debtsRerender);
                if (debtEndDate) debtEndDate.addEventListener('change', debtsRerender);
                if (debtStatusSelect) debtStatusSelect.addEventListener('change', debtsRerender);

                if (debtsCsvBtn) {
                    debtsCsvBtn.addEventListener('click', () => {
                        const rows = (window._lastRenderedDebtsSales || []);
                        if (!rows.length) {
                            customDialog({ title: 'تنبيه', message: 'لا توجد بيانات لتصديرها.' });
                            return;
                        }
                        const headers = ['اسم العميل', 'التاريخ', 'رقم الفاتورة', 'إجمالي الفاتورة', 'المسدد', 'المتبقي', 'المندوب'];
                        const csv = [headers.join(',')].concat(rows.map(sale => {
                            const cust = findCustomer(sale.customerId)?.name || 'عميل محذوف';
                            const date = formatArabicDate(sale.date);
                            const inv = sale.invoiceNumber || '';
                            const total = (sale.total || 0).toFixed(2);
                            const paid = (sale.paidAmount || 0).toFixed(2);
                            const remaining = ( (sale.total || 0) - (sale.paidAmount || 0) ).toFixed(2);
                            const rep = sale.repName || '';
                            return [`"${cust}"`,`"${date}"`,`"${inv}"`,`"${total}"`,`"${paid}"`,`"${remaining}"`,`"${rep}"`].join(',');
                        })).join('\n');

                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `debts_export_${new Date().toISOString().slice(0,10)}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                    });
                }

                if (debtsPrintBtn) {
                    debtsPrintBtn.addEventListener('click', () => {
                        const rows = (window._lastRenderedDebtsSales || []);
                        const totalStats = window._lastRenderedDebtsStats || {};
                        const w = window.open('', '', 'height=700,width=1000');
                        if (!w) { alert('يرجى السماح بالنوافذ المنبثقة للطباعة'); return; }
                        w.document.open();
                        w.document.write('<html><head><title>طباعة مديونيات</title>');
                        w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
                        w.document.write('<style>body{font-family: Cairo, sans-serif; direction: rtl; padding:20px;} table{width:100%;border-collapse:collapse;} th, td{padding:8px;border:1px solid #e5e7eb;text-align:center;} th{background:#fff7ed;color:#c2410c;}</style>');
                        w.document.write('</head><body>');
                        w.document.write('<h3 style="text-align:right">ملخص المديونيات</h3>');
                        w.document.write(`<p style="text-align:right">إجمالي الفواتير: ${formatCurrency(totalStats.subtotal || 0)}</p>`);
                        w.document.write(`<p style="text-align:right">المسدد: ${formatCurrency(totalStats.paid || 0)}</p>`);
                        w.document.write(`<p style="text-align:right">عدد الفواتير: ${totalStats.count || 0}</p>`);
                        w.document.write(`<p style="text-align:right">المديونيات: ${formatCurrency(totalStats.debts || 0)}</p>`);
                        w.document.write('<hr/>');
                        w.document.write('<table><thead><tr><th>اسم العميل</th><th>التاريخ</th><th>رقم الفاتورة</th><th>الإجمالي</th><th>المسدد</th><th>المتبقي</th><th>المندوب</th></tr></thead><tbody>');
                        rows.forEach(sale => {
                            const cust = findCustomer(sale.customerId)?.name || 'عميل محذوف';
                            const date = formatArabicDate(sale.date);
                            const inv = sale.invoiceNumber || '';
                            const total = formatCurrency(sale.total || 0);
                            const paid = formatCurrency(sale.paidAmount || 0);
                            const remaining = formatCurrency((sale.total || 0) - (sale.paidAmount || 0));
                            const rep = sale.repName || '';
                            w.document.write(`<tr><td>${cust}</td><td>${date}</td><td>${inv}</td><td>${total}</td><td>${paid}</td><td>${remaining}</td><td>${rep}</td></tr>`);
                        });
                        w.document.write('</tbody></table>');
                        w.document.write('</body></html>');
                        w.document.close();
                        const doPrint = () => { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
                        const closeBack = () => { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
                        if ('onafterprint' in w) { w.onafterprint = closeBack; } else { setTimeout(closeBack, 1200); }
                        if ('onload' in w) { w.onload = () => setTimeout(doPrint, 120); } else { setTimeout(doPrint, 300); }
                    });
                }
            } catch (e) {
                console.warn('Debts event listeners setup failed', e);
            }

            // Column filter UI removed; no global toggle handler attached.

            eventListenersAttached = true;
        }

        // --- Auth State Change Handler (guarded) ---
        const internalAuthHandler = async (user) => {
            if (user) {
                // User is signed in
                console.log('User logged in:', user.email);
                showLoading("جاري تحميل البيانات المحلية...");
                logoutBtn.classList.remove('hidden');

                    // 1. Load local data and initialize UI in a robust order:
                    //    - load state
                    //    - attach event listeners (so renders can wire controls)
                    //    - render all UI
                    //    - navigate to dashboard and force dashboard charts to render
                    // loadState() مُلغاة؛ نعتمد على المستمعات اللحظية
                    if (!window.state) window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                    // Preload cached collections so UI shows data even before permissions succeed
                    try { preloadCachedCollections(); } catch(e){ console.warn('preloadCachedCollections (login) failed', e); }
                    try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed during startup', e); }
                    try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed during startup', e); }
                    try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed during startup:', e); }
                    try { renderAll(); } catch (e) { console.warn('renderAll failed during startup:', e); }
                    // Open dashboard by default (show data immediately)
                    try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed during startup:', e); }
                    // Small delayed forcing of dashboard charts to avoid timing issues
                    setTimeout(() => {
                        scheduleRender('charts', ()=>{ try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { /* non-fatal */ } });
                    }, 60);
                    hideLoading(); // App is now usable.
                    try { applyRoleUIRestrictions(); } catch(_){}

                // 2) فعّل مزامنة Firestore الحية + ضمان تعبئة البيانات الأساسية
                try {
                    if (!window.__RT_LISTENERS_ATTACHED) {
                        setupRealtimeListeners();
                        window.__RT_LISTENERS_ATTACHED = true;
                    }
                } catch(e) { console.warn('setupRealtimeListeners (auth handler) failed', e); }
                try { await importEmbeddedBackupIfNeeded(); } catch(e){ console.warn('importEmbeddedBackupIfNeeded (auth handler) failed', e); }
                try { scheduleEnsureCoreData(); } catch(e){ console.warn('scheduleEnsureCoreData (auth handler) failed', e); }

            } else {
                // User is signed out (or auth returned null). Do NOT delete localStorage automatically.
                // Treat this as offline fallback so the app keeps working with local data when opened via file://
                console.log('No authenticated user detected — starting offline/local mode');
                try { logoutBtn.classList.add('hidden'); } catch(e) {}

                try {
                    // Robust offline startup: load local state, attach listeners, render UI and show dashboard
                    if (!window.state) window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                    // Offline / signed-out: also hydrate from caches
                    try { preloadCachedCollections(); } catch(e){ console.warn('preloadCachedCollections (offline) failed', e); }
                    try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed during offline startup', e); }
                    try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed during offline startup', e); }
                    try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed during offline startup:', e); }
                    try { renderAll(); } catch (e) { console.warn('renderAll failed during offline startup:', e); }
                    try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed during offline startup:', e); }
                    setTimeout(() => {
                        scheduleRender('charts', ()=>{ try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { /* non-fatal */ } });
                    }, 60);
                } catch (e) {
                    console.warn('Offline startup failed, falling back to cleared state:', e);
                    // As a last resort, initialize an empty state to keep the UI functional
                    state = { customers: [], products: [], sales: [], priceLists: [], dispatchNotes: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                    renderAll();
                }
                try { applyRoleUIRestrictions(); } catch(_){}
            }
        };

        // Role-based UI restrictions
        function applyRoleUIRestrictions(){
            try {
                const role = (typeof getUserRole === 'function') ? getUserRole() : 'user';
                if (role === 'rep') {
                    const newDispatchSection = document.getElementById('new-dispatch-note-section');
                    if (newDispatchSection) newDispatchSection.style.display = 'none';
                    // Disable edit-related buttons globally on dispatch page
                    document.querySelectorAll('.update-dispatch-note-btn,.delete-dispatch-note-btn,.add-editable-dispatch-item-btn,.delete-dispatch-item-btn,#save-new-dispatch-note-btn,#add-new-dispatch-item-btn').forEach(el=>{
                        el.classList.add('pointer-events-none','opacity-50');
                        if (el.tagName === 'BUTTON' || el.tagName === 'INPUT') el.disabled = true;
                    });
                }
            } catch(e){ console.warn('applyRoleUIRestrictions failed', e); }
        }

        // Register auth listener only if an auth object with a listener method exists
        if (typeof auth !== 'undefined' && auth && typeof auth.onAuthStateChanged === 'function') {
            try {
                auth.onAuthStateChanged(internalAuthHandler);
            } catch (e) {
                console.warn('auth.onAuthStateChanged failed, falling back to safe handler:', e);
                internalAuthHandler(null);
            }
        } else if (typeof onAuthStateChanged === 'function' && window.auth) {
            // support modular firebase export assigned to window.auth
            try {
                onAuthStateChanged(window.auth, internalAuthHandler);
            } catch (e) {
                console.warn('onAuthStateChanged(window.auth) failed, falling back:', e);
                internalAuthHandler(null);
            }
        } else {
            // No auth available (likely opened via file:// or module failed).
            // Fallback: load local state and start app in offline mode instead of clearing state.
            console.warn('No Firebase auth available; loading local data for offline mode.');
            try {
                // Robust offline startup sequence: load -> listeners -> render -> navigate -> force charts
                if (!window.state) window.state = { customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
                try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed in fallback startup', e); }
                try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed in fallback startup', e); }
                try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed in fallback:', e); }
                try { renderAll(); } catch (e) { console.warn('renderAll failed in fallback:', e); }
                try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed in fallback:', e); }
                setTimeout(() => {
                    try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { /* ignore */ }
                }, 60);
            } catch (e) {
                console.error('Fallback UI initialization failed:', e);
            }
        }

        // --- Firestore Sync Function (merge-safe) ---
        async function syncWithFirestore() {
            try {
                const lastSyncTimestamp = state.lastSyncTimestamp;
                console.log(`Starting incremental sync. Fetching changes since: ${lastSyncTimestamp || 'the beginning of time'}`);

                const collections = ['customers', 'products', 'sales', 'priceLists', 'dispatchNotes', 'reps', 'promotions', 'settings'];
                const queries = collections.map(col => {
                    let query = db.collection(col);
                    // For settings, we fetch the whole collection as it's usually one doc
                    if (lastSyncTimestamp && col !== 'settings' && col !== 'sales') {
                        query = query.where('updatedAt', '>', lastSyncTimestamp);
                    }
                    return query.get();
                });

                const snapshots = await Promise.all(queries);
                const newSyncTimestamp = new Date().toISOString();

                let hasChanges = false;
                snapshots.forEach((snapshot, index) => {
                    const collectionName = collections[index];
                    if (!snapshot.empty) {
                        hasChanges = true;
                        console.log(`Found ${snapshot.size} updated document(s) in ${collectionName}.`);
                        snapshot.docs.forEach(doc => {
                            const data = { id: doc.id, ...doc.data() };
                            // Find and update/add the item in the local state
                            const collectionState = state[collectionName];
                            if (Array.isArray(collectionState)) {
                                const existingIndex = collectionState.findIndex(item => item.id === data.id);
                                if (existingIndex > -1) {
                                    collectionState[existingIndex] = data; // Update
                                } else {
                                    collectionState.push(data); // Add
                                }
                            }
                        });
                    } else if (collectionName === 'settings' && !snapshot.empty) {
                         // Special handling for settings (not an array)
                         hasChanges = true;
                         state.settings = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    }
                });

                if (hasChanges) {
                    console.log('Changes found, state will be updated and saved.');
                } else {
                    console.log('No new changes found from Firestore.');
                }

                // Update the sync timestamp regardless, to keep it current
                state.lastSyncTimestamp = newSyncTimestamp;



                // Save the newly synced state to local storage for the next offline load.
                saveState();
                console.log('Firestore sync process finished and state saved locally.');

            } catch (error) {
                console.error('syncWithFirestore failed:', error);
                // Don't update timestamp if sync fails
                throw error; // Re-throw to be caught by the caller's .catch()
            }
        }

        // --- Login Form Handler ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            const loginButton = e.submitter;
            loginButton.disabled = true;
            loginButton.textContent = 'جارٍ تسجيل الدخول...';

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged will handle the rest
                closeModal(loginModal);
            } catch (error) {
                alert('فشل تسجيل الدخول: ' + error.message);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'تسجيل الدخول';
            }
        });

    </script>
    <!-- لا يوجد كود auto-start offline هنا في النسخة الأصلية -->
    <script>
    // Costs / BOM feature (minimal, client-side only)
    (function(){
        const LS_FIN = 'cost_finished';
        const LS_RAW = 'cost_raw';
        const LS_PACK = 'cost_pack';
        const LS_OPS = 'cost_ops';
        const LS_BOM_PREFIX = 'bom_';

        let costFinished = [];
        let costRaw = [];
        let costPack = [];
        let costOps = [];

        function loadLists(){
            try { costFinished = JSON.parse(localStorage.getItem(LS_FIN) || '[]'); } catch(e){ costFinished = []; }
            try { costRaw = JSON.parse(localStorage.getItem(LS_RAW) || '[]'); } catch(e){ costRaw = []; }
            try { costPack = JSON.parse(localStorage.getItem(LS_PACK) || '[]'); } catch(e){ costPack = []; }
            try { costOps = JSON.parse(localStorage.getItem(LS_OPS) || '[]'); } catch(e){ costOps = []; }
            // Sync to window so simplified recipe quick lists can read them
            try { window.costFinished = costFinished; window.costRaw = costRaw; window.costPack = costPack; window.costOps = costOps; } catch(_){ }
            // ensure finished products have defaults from app state if empty
            ensureFinishedFromState();
            renderListsSummary(); renderProductSelect(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable(); renderPriceManager();
            // Try overlay-from-cloud after local load
            try { tryLoadCostListsFromCloud(); } catch(_){ }
        }

        function saveLists(suppressCloud){
            localStorage.setItem(LS_FIN, JSON.stringify(costFinished));
            localStorage.setItem(LS_RAW, JSON.stringify(costRaw));
            localStorage.setItem(LS_PACK, JSON.stringify(costPack));
            localStorage.setItem(LS_OPS, JSON.stringify(costOps));
            // Keep globals in sync for other modules (recipes quick lists)
            try { window.costFinished = costFinished; window.costRaw = costRaw; window.costPack = costPack; window.costOps = costOps; } catch(_){ }
            renderListsSummary(); renderProductSelect(); renderRawPriceTable(); renderPriceManager();
            try { if (window.renderQuickLists) window.renderQuickLists(); } catch(_){ }
            if (!suppressCloud) { queueCloudSave(); }
        }

        // ===== Cloud sync (Firestore) for cost lists =====
        let __costCloudTimer = null;
        async function tryLoadCostListsFromCloud(){
            try {
                if (!window.db) return;
                const ref = db.collection('settings').doc('costLists');
                const snap = await ref.get();
                if (snap.exists) {
                    const d = snap.data() || {};
                    costFinished = Array.isArray(d.finished) ? d.finished : costFinished;
                    costRaw = Array.isArray(d.raw) ? d.raw : costRaw;
                    costPack = Array.isArray(d.pack) ? d.pack : costPack;
                    costOps = Array.isArray(d.ops) ? d.ops : costOps;
                    // persist locally and update UI without writing back immediately
                    saveLists(true);
                }
            } catch(e){ /* ignore cloud load errors */ }
        }
        function queueCloudSave(){
            try { if (!window.db) return; } catch(_){ return; }
            if (__costCloudTimer) clearTimeout(__costCloudTimer);
            __costCloudTimer = setTimeout(async ()=>{
                try {
                    await db.collection('settings').doc('costLists').set({
                        finished: costFinished,
                        raw: costRaw,
                        pack: costPack,
                        ops: costOps,
                        updatedAt: serverTs()
                    }, { merge:true });
                } catch(e){ /* ignore write errors, UI still uses local */ }
            }, 800);
        }

        // Optional realtime overlay when other clients update the document
        let __costDocUnsub = null;
        function installCostListsListener(){
            try {
                if (!db || __costDocUnsub) return;
                __costDocUnsub = db.collection('settings').doc('costLists').onSnapshot(function(snap){
                    try {
                        if (!snap.exists) return;
                        const d = snap.data() || {};
                        costFinished = Array.isArray(d.finished) ? d.finished : costFinished;
                        costRaw = Array.isArray(d.raw) ? d.raw : costRaw;
                        costPack = Array.isArray(d.pack) ? d.pack : costPack;
                        costOps = Array.isArray(d.ops) ? d.ops : costOps;
                        saveLists(true);
                    } catch(_){ }
                }, function(_err){ /* ignore */ });
            } catch(_){ }
        }

        function renderListsSummary(){
            const el = document.getElementById('cost-lists-summary');
            if(!el) return;
            el.textContent = `المنتجات التامة: ${costFinished.length} — الخامات: ${costRaw.length} — تغليف: ${costPack.length}`;
        }

        // If finished list empty, populate from app state products for convenience
        function ensureFinishedFromState(){
            try{
                if(Array.isArray(costFinished) && costFinished.length === 0){
                    const src = (Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
                    if(src && src.length){
                        src.forEach(p => {
                            const id = p.id || p.code || ('prod-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                            costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'قطعة', price: Number(p.price||p.sellPrice||0) });
                        });
                        saveLists();
                    }
                }
            }catch(e){ console.warn('ensureFinishedFromState failed', e); }
        }

        function renderProductSelect(){
            const sel = document.getElementById('cost-product-select');
            if(!sel) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="">اختر منتج تام...</option>' + costFinished.map(p => `<option value="${escapeHtml(p.id||p.code||p.name)}">${escapeHtml(p.name||p.code)}</option>`).join('');
            if(prev) sel.value = prev;
        }

        // Render left product list (searchable) with quick select buttons
        function renderProductList(filter){
            const container = document.getElementById('cost-product-list'); if(!container) return;
            container.innerHTML = '';
            const q = String(filter || '').trim().toLowerCase();
            const items = (costFinished || []).filter(p => {
                if(!q) return true;
                return (String(p.name||'').toLowerCase().includes(q) || String(p.code||'').toLowerCase().includes(q));
            });
            if(items.length === 0){ container.innerHTML = '<div class="p-2 text-sm text-gray-500">لا توجد منتجات</div>'; return; }
            items.forEach(p => {
                const el = document.createElement('div');
                el.className = 'p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                el.innerHTML = `<div><div class="font-medium text-sm">${escapeHtml(p.name)}</div><div class="text-xs text-gray-500">${escapeHtml(p.code||'')}</div></div><div><button class="select-product-btn bg-blue-500 text-white px-2 py-1 rounded" data-id="${escapeHtml(p.id)}">اختار</button></div>`;
                container.appendChild(el);
            });
        }

        function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        // Manage lists modal helpers
        function openManageListsModal(){
            console.log('openManageListsModal: start');
            // show modal immediately to avoid perceived freeze, populate tables asynchronously
            const m = document.getElementById('manage-lists-modal');
            if(m){ m.classList.remove('modal-hidden'); m.classList.add('modal-visible'); }
            // render content a bit later so modal appears first
            setTimeout(()=>{ try{ console.log('openManageListsModal: calling renderManageListsTables'); renderManageListsTables(); }catch(e){ console.warn('renderManageListsTables failed', e); } }, 40);
        }
    function closeManageListsModal(){ const m = document.getElementById('manage-lists-modal'); if(m){ m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); } }
    // expose to global so inline onclick works
    try{ window.openManageListsModal = openManageListsModal; window.closeManageListsModal = closeManageListsModal; }catch(e){}

        function renderManageListsTables(){
            // prepare progress UI
            const progressEl = document.getElementById('manage-lists-progress');
            const totalItems = (Array.isArray(costFinished)?costFinished.length:0) + (Array.isArray(costRaw)?costRaw.length:0) + (Array.isArray(costPack)?costPack.length:0);
            let processed = 0;
            if(progressEl){
                if(totalItems === 0){ progressEl.style.display = 'none'; } else { progressEl.style.display = 'block'; progressEl.textContent = `جارٍ تحميل العناصر 0 / ${totalItems}`; }
            }

            // chunked renderer with a small immediate batch and small async batches (safer for large lists)
            function chunkRender(items, tbody, rowRenderer, firstSync = 10, batchSize = 20){
                tbody.innerHTML = '';
                if(!items || items.length === 0) return;
                let i = 0;
                // initial synchronous batch
                const initial = Math.min(firstSync, items.length);
                const t0 = Date.now();
                for(; i < initial; i++){
                    const tr = rowRenderer(items[i]);
                    tbody.appendChild(tr);
                    processed++;
                }
                const t1 = Date.now();
                console.log('chunkRender: initial batch', { initial, timeMs: t1 - t0, processed, totalItems });
                if(progressEl) progressEl.textContent = `جارٍ تحميل العناصر ${processed} / ${totalItems}`;
                if(i >= items.length) return;

                function nextBatch(){
                    const batchStart = Date.now();
                    const end = Math.min(i + batchSize, items.length);
                    let batchCount = 0;
                    for(; i < end; i++){
                        const tr = rowRenderer(items[i]);
                        tbody.appendChild(tr);
                        processed++; batchCount++;
                    }
                    const batchEnd = Date.now();
                    console.log('chunkRender: batch appended', { batchCount, timeMs: batchEnd - batchStart, processed, totalItems });
                    if(progressEl) progressEl.textContent = `جارٍ تحميل العناصر ${processed} / ${totalItems}`;
                    if(i < items.length){
                        setTimeout(nextBatch, 25);
                    }
                }
                setTimeout(nextBatch, 25);
            }

            console.log('renderManageListsTables: starting render', { finished: costFinished.length, raw: costRaw.length, pack: costPack.length });

            const tf = document.querySelector('#manage-finished-table tbody');
            if(tf){ chunkRender(costFinished, tf, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.price||it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="finished" data-id="${escapeHtml(it.id)}">حذف</button></td>`;
                    return tr;
                }, 10, 20);
            }

            const trw = document.querySelector('#manage-raw-table tbody');
            if(trw){ chunkRender(costRaw, trw, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="raw" data-id="${escapeHtml(it.id)}">حذف</button></td>`;
                    return tr;
                }, 10, 20);
            }

            const tpk = document.querySelector('#manage-pack-table tbody');
            if(tpk){ chunkRender(costPack, tpk, it => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="pack" data-id="${escapeHtml(it.id)}">حذف</button></td>`;
                    return tr;
                }, 10, 20);
            }

            // hide progress once everything is appended (polling check)
            const poll = setInterval(() => {
                if(processed >= totalItems){
                    clearInterval(poll);
                    if(progressEl) { progressEl.textContent = `اكتمل التحميل (${totalItems} عنصر)`; setTimeout(()=>{ if(progressEl) progressEl.style.display = 'none'; }, 700); }
                    console.log('renderManageListsTables: finished rendering all items', { totalItems });
                }
            }, 200);
        }

        function deleteListItem(listName, id){
            if(!confirm('هل أنت متأكد من حذف هذا العنصر؟')) return;
            if(listName === 'finished'){ costFinished = costFinished.filter(x=>String(x.id)!==String(id)); }
            if(listName === 'raw'){ costRaw = costRaw.filter(x=>String(x.id)!==String(id)); }
            if(listName === 'pack'){ costPack = costPack.filter(x=>String(x.id)!==String(id)); }
            saveLists(); renderManageListsTables();
        }

        // export lists as JSON for download
        function exportLists(){ const payload = { finished: costFinished, raw: costRaw, pack: costPack, exportedAt: new Date().toISOString() }; const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = 'cost-lists-export.json'; document.body.appendChild(a); a.click(); a.remove(); }

        // Manage modal click handlers
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'manage-export-btn'){ exportLists(); }
            const delBtn = e.target && e.target.closest && e.target.closest('.manage-del-btn');
            if(delBtn){ const list = delBtn.getAttribute('data-list'); const id = delBtn.getAttribute('data-id'); if(list && id) deleteListItem(list, id); }
        });

        // Raw price registry handlers
        function renderRawPriceTable(){
            const tbody = document.querySelector('#raw-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costRaw || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.cost !== undefined ? it.cost : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="raw-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center raw-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="raw-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">حفظ</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderFinishedPriceTable(){
            const tbody = document.querySelector('#finished-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costFinished || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.price !== undefined ? it.price : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="finished-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center finished-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="finished-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">حفظ</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderPackPriceTable(){
            const tbody = document.querySelector('#pack-price-table tbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (costPack || []).forEach(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? it.lastPrice : (it.cost !== undefined ? it.cost : '');
                const date = it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-2 py-1 text-right"><input class="pack-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center pack-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="pack-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">حفظ</button></td>`;
                tbody.appendChild(tr);
            });
        }

        // ===== Price Manager (tables + history) =====
        function pmFormatDate(iso){ try { return iso ? new Date(iso).toLocaleString('ar-EG') : ''; } catch(_){ return ''; } }
        function getListByType(t){ return t==='raw'?costRaw : t==='pack'?costPack : costOps; }
        function setListByType(t, arr){ if(t==='raw') costRaw = arr; else if(t==='pack') costPack = arr; else costOps = arr; }
        function renderPriceManager(){
            const block = document.getElementById('price-manager-block'); if(!block) return;
            const sumEl = document.getElementById('pm-summary');
            if(sumEl) sumEl.textContent = `خامات: ${costRaw.length} • تغليف: ${costPack.length} • تشغيل: ${costOps.length}`;
            // Render three tables bodies
            [['raw', 'pm-table-raw'], ['pack','pm-table-pack'], ['ops','pm-table-ops']].forEach(([type, id])=>{
                const tbody = document.querySelector(`#${id} tbody`); if(!tbody) return;
                const list = getListByType(type) || [];
                tbody.innerHTML = list.map(it=>{
                    const last = (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:''));
                    const date = pmFormatDate(it.lastPriceDate);
                    const esc = s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    return `<tr>
                        <td class="px-2 py-1 text-right">${esc(it.name||'')}</td>
                        <td class="px-2 py-1 text-center">${esc(it.unit||'')}</td>
                        <td class="px-2 py-1 text-center">${last!==''?Number(last).toFixed(2):''}</td>
                        <td class="px-2 py-1 text-center">${esc(date)}</td>
                        <td class="px-2 py-1 text-center flex gap-2 justify-center">
                            <button class="pm-add-price bg-blue-600 text-white px-2 py-0.5 rounded text-xs" data-type="${type}" data-id="${esc(it.id)}">سعر جديد</button>
                            <button class="pm-view-history bg-gray-200 text-gray-800 px-2 py-0.5 rounded text-xs" data-type="${type}" data-id="${esc(it.id)}">سجل</button>
                        </td>
                    </tr>`;
                }).join('');
            });
            // Keep the active tab styling consistent
            updateIcons();
            renderUnifiedPriceGrid();
        }

        function pmActiveType(){
            const btn = document.querySelector('#price-manager-block .pm-tab.bg-blue-600');
            return btn ? btn.getAttribute('data-pm-tab') : 'raw';
        }
        function pmSwitchTo(type){
            document.querySelectorAll('#price-manager-block .pm-tab').forEach(b=>{
                const t = b.getAttribute('data-pm-tab');
                if(t===type){ b.classList.add('bg-blue-600','text-white'); b.classList.remove('bg-gray-100','text-gray-800'); }
                else { b.classList.remove('bg-blue-600','text-white'); b.classList.add('bg-gray-100','text-gray-800'); }
            });
            document.querySelectorAll('#price-manager-block .pm-table').forEach(sec=>{
                const t = sec.getAttribute('data-type');
                sec.classList.toggle('hidden', t!==type);
            });
        }

        function pmEnsureItem(type){
            const name = prompt('اسم العنصر:'); if(!name) return;
            const unit = prompt('الوحدة (اختياري):') || '';
            const id = (type + '-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
            const list = getListByType(type);
            list.push({ id, code:id, name, unit, cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
            setListByType(type, list);
            saveLists(); renderPriceManager();
        }

        function pmAddPrice(type, id){
            const list = getListByType(type);
            const it = list.find(x=> String(x.id)===String(id));
            if(!it) return alert('العنصر غير موجود');
            const v = prompt('السعر الجديد:', (it.lastPrice!=null?it.lastPrice:(it.cost||0)));
            if(v==null) return;
            const num = parseFloat(v||0) || 0;
            const now = new Date().toISOString();
            it.lastPrice = num; it.lastPriceDate = now;
            it.priceHistory = Array.isArray(it.priceHistory) ? it.priceHistory : [];
            it.priceHistory.unshift({ price: num, date: now });
            saveLists(); renderPriceManager();
            // also refresh registry tables if present
            renderRawPriceTable(); renderPackPriceTable(); renderFinishedPriceTable();
        }

        // Simple history modal
        function openPriceHistory(type, id){
            const list = getListByType(type);
            const it = list.find(x=> String(x.id)===String(id));
            if(!it) return alert('العنصر غير موجود');
            const modal = document.getElementById('price-history-modal'); if(!modal) return;
            const title = modal.querySelector('#ph-title');
            const tbody = modal.querySelector('#ph-body');
            if(title) title.textContent = `سجل الأسعار — ${it.name||id}`;
            const esc = s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const hist = Array.isArray(it.priceHistory)? it.priceHistory : [];
            tbody.innerHTML = hist.length ? hist.map(h=> `<tr><td class="px-2 py-1 text-center">${Number(h.price||0).toFixed(2)}</td><td class="px-2 py-1 text-center">${esc(pmFormatDate(h.date))}</td><td class="px-2 py-1 text-right">${esc(h.note||'')}</td></tr>`).join('') : '<tr><td colspan="3" class="px-2 py-3 text-center text-gray-500">لا يوجد سجل أسعار</td></tr>';
            modal.setAttribute('data-type', type);
            modal.setAttribute('data-id', id);
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }
        function closePriceHistory(){ const m = document.getElementById('price-history-modal'); if(!m) return; m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); }
        function addPriceFromModal(){
            const m = document.getElementById('price-history-modal'); if(!m) return;
            const type = m.getAttribute('data-type'); const id = m.getAttribute('data-id');
            const priceInp = m.querySelector('#ph-new-price'); const noteInp = m.querySelector('#ph-new-note');
            const v = parseFloat(priceInp.value||0) || 0; const note = noteInp.value.trim();
            const list = getListByType(type); const it = list.find(x=> String(x.id)===String(id)); if(!it) return;
            const now = new Date().toISOString();
            it.lastPrice = v; it.lastPriceDate = now;
            it.priceHistory = Array.isArray(it.priceHistory) ? it.priceHistory : [];
            it.priceHistory.unshift({ price: v, date: now, note });
            saveLists(); renderPriceManager();
            // refresh modal body
            openPriceHistory(type, id);
            // clear inputs
            priceInp.value = ''; noteInp.value = '';
        }

        // Wire price manager events
        document.addEventListener('click', function(e){
            const tabBtn = e.target && e.target.closest && e.target.closest('#price-manager-block .pm-tab');
            if(tabBtn){ pmSwitchTo(tabBtn.getAttribute('data-pm-tab')); }
            if(e.target && e.target.id === 'pm-add-item-btn'){ pmEnsureItem(pmActiveType()); }
            const addBtn = e.target && e.target.closest && e.target.closest('.pm-add-price'); if(addBtn){ pmAddPrice(addBtn.getAttribute('data-type'), addBtn.getAttribute('data-id')); }
            const histBtn = e.target && e.target.closest && e.target.closest('.pm-view-history'); if(histBtn){ openPriceHistory(histBtn.getAttribute('data-type'), histBtn.getAttribute('data-id')); }
            if(e.target && e.target.id === 'ph-close-btn'){ closePriceHistory(); }
            if(e.target && e.target.id === 'ph-add-btn'){ addPriceFromModal(); }
        });

        // Install cloud listener after Firebase is ready
        document.addEventListener('DOMContentLoaded', function(){ setTimeout(installCostListsListener, 1200); });

        // ===== Unified Price Grid Renderer =====
        function renderUnifiedPriceGrid(){
            const wrap = document.getElementById('unified-price-grid-block'); if(!wrap) return;
            const tbody = document.querySelector('#unified-price-grid tbody'); if(!tbody) return;
            const esc = s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const all = [];
            (costRaw||[]).forEach(it=> all.push({type:'خامة', item:it}));
            (costPack||[]).forEach(it=> all.push({type:'تغليف', item:it}));
            (costOps||[]).forEach(it=> all.push({type:'تشغيل', item:it}));
            // sort alphabetically by name inside type groups
            all.sort((a,b)=> (a.type.localeCompare(b.type,'ar')) || (String(a.item.name||'').localeCompare(String(b.item.name||''),'ar')));
            tbody.innerHTML = all.map(row => {
                const it = row.item;
                const last = (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:''));
                const date = it.lastPriceDate ? pmFormatDate(it.lastPriceDate) : '';
                return `<tr>
                    <td class="px-2 py-1 text-right">${esc(it.name||'')}</td>
                    <td class="px-2 py-1 text-center">
                        <span class="unified-code inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${esc(it.code||it.id||'')}</span>
                    </td>
                    <td class="px-2 py-1 text-center">${esc(row.type)}</td>
                    <td class="px-2 py-1 text-center">${esc(it.unit||'')}</td>
                    <td class="px-2 py-1 text-center">
                        <span class="unified-current-price inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${last!==''?Number(last).toFixed(2):''}</span>
                    </td>
                    <td class="px-2 py-1 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <input class="unified-new-price w-20 p-1 border rounded text-center text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}" placeholder="0.00" />
                            <button class="unified-save-price bg-blue-600 text-white px-2 py-0.5 rounded text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}">حفظ</button>
                        </div>
                    </td>
                    <td class="px-2 py-1 text-center">${esc(date)}</td>
                </tr>`;
            }).join('');
            const sumEl = document.getElementById('unified-grid-summary');
            if(sumEl) sumEl.textContent = `الإجمالي: ${all.length} عنصر`;
        }

        // Export helpers
        function unifiedExportJSON(){
            const payload = { raw: costRaw, pack: costPack, ops: costOps, exportedAt: new Date().toISOString() };
            const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = 'unified-prices.json'; document.body.appendChild(a); a.click(); a.remove();
        }
        function unifiedExportCSV(){
            const rows = [];
            rows.push(['type','name','unit','currentPrice','lastDate']);
            const pushRows = (arr,type)=> (arr||[]).forEach(it=> rows.push([
                type,
                (it.name||'').replace(/\n/g,' '),
                it.unit||'',
                (it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
                it.lastPriceDate||''
            ]));
            pushRows(costRaw,'raw'); pushRows(costPack,'pack'); pushRows(costOps,'ops');
            const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'unified-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 2000);
        }
        function unifiedPrint(){
            const block = document.getElementById('unified-price-grid-block'); if(!block) return window.print();
            const wasOpen = block.open; block.open = true; renderUnifiedPriceGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open = false; }, 50);
        }

        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'unified-refresh-btn'){ renderUnifiedPriceGrid(); }
            if(e.target && e.target.id === 'unified-export-json-btn'){ unifiedExportJSON(); }
            if(e.target && e.target.id === 'unified-export-csv-btn'){ unifiedExportCSV(); }
            if(e.target && e.target.id === 'unified-print-btn'){ unifiedPrint(); }
            const inlineBtn = e.target && e.target.closest && e.target.closest('.unified-save-price');
            if(inlineBtn){
                const typeLabel = inlineBtn.getAttribute('data-type');
                const id = inlineBtn.getAttribute('data-id');
                const inp = document.querySelector(`.unified-new-price[data-id="${CSS.escape(id)}"][data-type="${CSS.escape(typeLabel)}"]`);
                if(!inp) return;
                const rawVal = inp.value.trim(); if(rawVal==='') { alert('ادخل السعر الجديد'); return; }
                const num = parseFloat(rawVal); if(isNaN(num)){ alert('سعر غير صالح'); return; }
                // map Arabic type label to internal key
                const mapType = t => t==='خامة'?'raw': (t==='تغليف'?'pack': (t==='تشغيل'?'ops': 'raw'));
                const tKey = mapType(typeLabel);
                const list = getListByType(tKey) || [];
                const it = list.find(x=> String(x.id) === String(id)); if(!it){ alert('العنصر غير موجود'); return; }
                const now = new Date().toISOString();
                it.lastPrice = num; it.lastPriceDate = now; it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; it.priceHistory.unshift({ price: num, date: now, note: 'شبكة موحدة' });
                saveLists(); renderPriceManager(); renderUnifiedPriceGrid();
                inp.value='';
            }
        });

        // حفظ تعديل مباشر في خلية "الكود" (Enter أو عند الخروج)
        function __commitUnifiedCode(el){
            if(!el) return;
            const typeLabel = el.getAttribute('data-type');
            const id = el.getAttribute('data-id');
            const txt = (el.textContent||'').trim();
            const mapType = t => t==='خامة'?'raw': (t==='تغليف'?'pack': (t==='تشغيل'?'ops': 'raw'));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); if(!it) return;
            if ((it.code||'') === txt) return;
            it.code = txt;
            saveLists(); renderPriceManager(); renderUnifiedPriceGrid();
        }
        document.addEventListener('focusin', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
        });
        document.addEventListener('keydown', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span && e.key === 'Enter'){
                e.preventDefault(); __commitUnifiedCode(span);
                try { span.blur(); } catch(_){}
            }
        });
        document.addEventListener('focusout', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
            if(span){ __commitUnifiedCode(span); }
        });

        // حفظ تعديل مباشر في خلية "السعر الحالي" (Enter أو عند الخروج)
        function __commitUnifiedCurrentPrice(el){
            if(!el) return;
            const typeLabel = el.getAttribute('data-type');
            const id = el.getAttribute('data-id');
            const txt = (el.textContent||'').trim(); if(txt==='') return; // تجاهُل الفراغ
            const val = parseFloat(txt);
            if(isNaN(val)) { el.textContent = el.getAttribute('data-prev') || el.textContent; return; }
            const mapType = t => t==='خامة'?'raw': (t==='تغليف'?'pack': (t==='تشغيل'?'ops': 'raw'));
            const tKey = mapType(typeLabel);
            const list = getListByType(tKey) || [];
            const it = list.find(x=> String(x.id) === String(id)); if(!it) return;
            const prev = (it.lastPrice!=null?Number(it.lastPrice):(it.cost!=null?Number(it.cost):null));
            if(prev!=null && Number(prev).toFixed(2) === Number(val).toFixed(2)) { el.textContent = Number(prev).toFixed(2); return; }
            const now = new Date().toISOString();
            it.lastPrice = val; it.lastPriceDate = now; it.priceHistory = Array.isArray(it.priceHistory)? it.priceHistory : []; it.priceHistory.unshift({ price: val, date: now, note: 'تعديل مباشر' });
            saveLists(); renderPriceManager(); renderUnifiedPriceGrid();
        }
        document.addEventListener('focusin', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
        });
        document.addEventListener('keydown', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span && e.key === 'Enter'){
                e.preventDefault(); __commitUnifiedCurrentPrice(span);
                try { span.blur(); } catch(_){}
            }
        });
        document.addEventListener('focusout', function(e){
            const span = e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
            if(span){ __commitUnifiedCurrentPrice(span); }
        });

        function saveRawPriceRow(id){
            const inp = document.querySelector(`.raw-price-input[data-id="${id}"]`);
            if(!inp) return;
            const v = parseFloat(inp.value || 0) || 0;
            const it = costRaw.find(x => String(x.id) === String(id));
            if(!it) return alert('العنصر غير موجود');
            // also update name and unit from inputs
            const nameInp = document.querySelector(`.raw-name-input[data-id="${id}"]`);
            const unitInp = document.querySelector(`.raw-unit-input[data-id="${id}"]`);
            if(nameInp) it.name = nameInp.value.trim();
            if(unitInp) it.unit = unitInp.value.trim();
            const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
            if(v !== prev){
                it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate });
            }
            saveLists(); renderRawPriceTable();
            // also refresh BOM selects so new lastPrice appears in data-lastprice
            renderProductSelect();
            // update any open BOM rows that reference this item (if autofill enabled)
            try{ updateBomRowsAfterPriceChange(id, 'raw'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
        }

        function saveFinishedPriceRow(id){
            const inp = document.querySelector(`.finished-price-input[data-id="${id}"]`);
            if(!inp) return;
            const v = parseFloat(inp.value || 0) || 0;
            const it = costFinished.find(x => String(x.id) === String(id));
            if(!it) return alert('العنصر غير موجود');
            const nameInp = document.querySelector(`.finished-name-input[data-id="${id}"]`);
            const unitInp = document.querySelector(`.finished-unit-input[data-id="${id}"]`);
            if(nameInp) it.name = nameInp.value.trim();
            if(unitInp) it.unit = unitInp.value.trim();
            const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.price||0);
            if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
            saveLists(); renderFinishedPriceTable(); renderProductSelect();
            try{ updateBomRowsAfterPriceChange(id, 'finished'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
        }

        function savePackPriceRow(id){
            const inp = document.querySelector(`.pack-price-input[data-id="${id}"]`);
            if(!inp) return;
            const v = parseFloat(inp.value || 0) || 0;
            const it = costPack.find(x => String(x.id) === String(id));
            if(!it) return alert('العنصر غير موجود');
            const nameInp = document.querySelector(`.pack-name-input[data-id="${id}"]`);
            const unitInp = document.querySelector(`.pack-unit-input[data-id="${id}"]`);
            if(nameInp) it.name = nameInp.value.trim();
            if(unitInp) it.unit = unitInp.value.trim();
            const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
            if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
            saveLists(); renderPackPriceTable(); renderProductSelect();
            try{ updateBomRowsAfterPriceChange(id, 'pack'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
        }

        function saveAllPrices(){
            let changed = 0;
            const changedIds = new Set();
            // finished
            Array.from(document.querySelectorAll('.finished-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costFinished.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.finished-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.finished-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.price||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            // raw
            Array.from(document.querySelectorAll('.raw-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costRaw.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.raw-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.raw-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            // pack
            Array.from(document.querySelectorAll('.pack-price-input')).forEach(inp => {
                const id = inp.getAttribute('data-id');
                const v = parseFloat(inp.value || 0) || 0;
                const it = costPack.find(x => String(x.id) === String(id));
                if(!it) return;
                const nameInp = document.querySelector(`.pack-name-input[data-id="${id}"]`);
                const unitInp = document.querySelector(`.pack-unit-input[data-id="${id}"]`);
                if(nameInp) it.name = nameInp.value.trim();
                if(unitInp) it.unit = unitInp.value.trim();
                const prev = it.lastPrice !== undefined ? Number(it.lastPrice) : (it.cost||0);
                if(v !== prev){ it.lastPrice = v; it.lastPriceDate = new Date().toISOString(); it.priceHistory = it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
            });
            if(changed > 0){ saveLists(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable(); renderProductSelect();
                // update BOM rows for each changed id
                try{ changedIds.forEach(i=> updateBomRowsAfterPriceChange(i)); }catch(e){console.warn('updateBomRowsAfterPriceChange bulk failed', e); }
                alert('تم حفظ ' + changed + ' سعراً.');
            } else alert('لا تغييرات للحفظ.');
        }

        // When a price changes, update any visible BOM rows that reference that component
        function updateBomRowsAfterPriceChange(itemId, listType){
            try{
                // only proceed if autofill is enabled
                const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                if(!auto) return;
                if(!itemId) return;
                const tbody = document.getElementById('cost-bom-body'); if(!tbody) return;
                // find the new price from lists
                const findPrice = (id) => {
                    let found = (costRaw||[]).find(x=>String(x.id)===String(id)) || (costPack||[]).find(x=>String(x.id)===String(id)) || (costFinished||[]).find(x=>String(x.id)===String(id));
                    if(!found) return 0;
                    return Number(found.lastPrice !== undefined && found.lastPrice !== null ? found.lastPrice : (found.cost !== undefined ? found.cost : (found.price !== undefined ? found.price : 0)));
                };

                const newPrice = findPrice(itemId);
                Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                    const compSel = tr.querySelector('.cost-comp-select');
                    if(!compSel) return;
                    if(String(compSel.value) === String(itemId)){
                        const unitCostInp = tr.querySelector('.cost-comp-unitcost');
                        const qtyInp = tr.querySelector('.cost-comp-qty');
                        const totalSpan = tr.querySelector('.cost-comp-total');
                        if(unitCostInp){
                            unitCostInp.value = Number(newPrice || 0).toFixed(2);
                        }
                        // update total display for the row
                        const q = parseFloat(qtyInp && qtyInp.value || 0) || 0;
                        const uc = parseFloat(unitCostInp && unitCostInp.value || 0) || 0;
                        const tot = Math.round(q * uc * 100) / 100;
                        if(totalSpan) totalSpan.textContent = tot.toFixed(2);
                    }
                });
                // recalc totals after updating rows
                calculateTotals();
            }catch(e){ console.warn('updateBomRowsAfterPriceChange error', e); }
        }

        function exportPrices(){ const payload = { raw: costRaw || [], exportedAt: new Date().toISOString() }; const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = 'cost-raw-prices.json'; document.body.appendChild(a); a.click(); a.remove(); }

        function importPricesFromJSON(obj){
            if(!obj || !Array.isArray(obj.raw)) return alert('الملف لا يحتوي على بيانات خامات صحيحة');
            let added = 0, updated = 0;
            obj.raw.forEach(r => {
                const id = r.id || r.code || null; if(!id) return;
                const existing = costRaw.find(x => String(x.id) === String(id));
                if(existing){
                    // update lastPrice if present
                    if(r.lastPrice !== undefined){ existing.lastPrice = r.lastPrice; existing.lastPriceDate = r.lastPriceDate || new Date().toISOString(); existing.priceHistory = existing.priceHistory || []; existing.priceHistory.unshift({ price: existing.lastPrice, date: existing.lastPriceDate }); updated++; }
                } else {
                    // add minimal entry
                    const newItem = { id, code: id, name: r.name||r.title||'', unit: r.unit||'', cost: r.cost||0, lastPrice: r.lastPrice||r.cost||0, lastPriceDate: r.lastPriceDate||new Date().toISOString(), priceHistory: r.priceHistory||[] };
                    costRaw.push(newItem); added++;
                }
            });
            saveLists(); renderRawPriceTable(); renderProductSelect(); alert('تم استيراد: تم إضافة ' + added + ' — تم تحديث ' + updated);
        }

        // wire raw price registry UI
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'export-prices-btn'){ exportPrices(); }
            if(e.target && e.target.id === 'import-prices-btn'){ const inp = document.getElementById('import-prices-input'); if(inp) inp.click(); }
            if(e.target && e.target.id === 'save-all-prices-btn'){ saveAllPrices(); }
            const saveBtn = e.target && e.target.closest && e.target.closest('.raw-price-save-btn'); if(saveBtn){ const id = saveBtn.getAttribute('data-id'); if(id) savePriceRow(id); }
        });

        // import file handler
        const importInp = document.getElementById('import-prices-input'); if(importInp) importInp.addEventListener('change', function(e){
            const f = e.target.files && e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = function(ev){ try{ const obj = JSON.parse(String(ev.target.result || '{}')); importPricesFromJSON(obj); }catch(err){ alert('فشل قراءة الملف: ' + err.message); } }; reader.readAsText(f); e.target.value = '';
        });
        
        // add empty raw row
        function addEmptyRawRow(){
            const id = 'raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
            costRaw.push({ id, code: id, name: '', unit: '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
            saveLists(); renderRawPriceTable();
        }

        // import names from app state (state.products or DEFAULT_PRODUCTS)
        function importRawNamesFromState(){
            const src = (Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
            if(!src || !src.length) return alert('لا توجد منتجات في حالة التطبيق للاستيراد.');
            if(!confirm('هل تريد استيراد أسماء المنتجات من بيانات التطبيق كخامات؟ سيتم إضافة الصفوف دون تغيير الأسعار.')) return;
            let added = 0;
            src.forEach(p => {
                const id = p.id || p.code || ('raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
                if(!costRaw.some(x => String(x.id) === String(id) || (x.name && x.name.trim() === (p.name||p.title||'').trim()))) {
                    costRaw.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
                    added++;
                }
            });
            saveLists(); renderRawPriceTable(); renderProductSelect(); alert('تم إضافة ' + added + ' خامة من بيانات التطبيق.');
        }

        // wire new buttons
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'add-empty-raw-btn'){ addEmptyRawRow(); }
            if(e.target && e.target.id === 'import-raw-from-state-btn'){ importRawNamesFromState(); }
        });

        // Attach direct listener to the manage button (robust against inner elements)
        document.addEventListener('DOMContentLoaded', function(){
            const mb = document.getElementById('cost-manage-lists-btn'); if(mb) mb.addEventListener('click', openManageListsModal);
        });

        // Add list handlers
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'add-finished-btn'){
                const name = document.getElementById('prod-finished-name').value.trim();
                const code = document.getElementById('prod-finished-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-finished-unit').value.trim() || 'قطعة';
                const price = parseFloat(document.getElementById('prod-finished-price').value || 0) || 0;
                if(!name) return alert('ادخل اسم المنتج التام');
                costFinished.push({ id: code, code, name, unit, price }); saveLists();
                document.getElementById('prod-finished-name').value=''; document.getElementById('prod-finished-code').value=''; document.getElementById('prod-finished-price').value='';
            }
            if(e.target && e.target.id === 'add-raw-btn'){
                const name = document.getElementById('prod-raw-name').value.trim();
                const code = document.getElementById('prod-raw-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-raw-unit').value.trim() || 'كجم';
                const cost = parseFloat(document.getElementById('prod-raw-cost').value || 0) || 0;
                if(!name) return alert('ادخل اسم الخامة');
                costRaw.push({ id: code, code, name, unit, cost }); saveLists();
                document.getElementById('prod-raw-name').value=''; document.getElementById('prod-raw-code').value=''; document.getElementById('prod-raw-cost').value='';
            }
            if(e.target && e.target.id === 'add-pack-btn'){
                const name = document.getElementById('prod-pack-name').value.trim();
                const code = document.getElementById('prod-pack-code').value.trim() || Date.now().toString();
                const unit = document.getElementById('prod-pack-unit').value.trim() || 'قطعة';
                const cost = parseFloat(document.getElementById('prod-pack-cost').value || 0) || 0;
                if(!name) return alert('ادخل اسم التغليف');
                costPack.push({ id: code, code, name, unit, cost }); saveLists();
                document.getElementById('prod-pack-name').value=''; document.getElementById('prod-pack-code').value=''; document.getElementById('prod-pack-cost').value='';
            }
        });

        // BOM row creation
        function createComponentOptionHTML(list){ return list.map(it => {
                const last = (it.lastPrice !== undefined && it.lastPrice !== null) ? Number(it.lastPrice) : (it.cost !== undefined ? Number(it.cost) : (it.price !== undefined ? Number(it.price) : 0));
                return `<option value="${escapeHtml(it.id)}" data-unit="${escapeHtml(it.unit||'')}" data-cost="${Number(it.cost||it.price||0)}" data-lastprice="${last}">${escapeHtml(it.name)} (${escapeHtml(it.unit||'')})</option>`;
            }).join(''); }

        function addBOMRow(data){
            const tbody = document.getElementById('cost-bom-body'); if(!tbody) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-2 py-1 text-right">
                    <select class="cost-comp-type p-1 border rounded"><option value="raw">خامة</option><option value="pack">تغليف</option></select>
                </td>
                <td class="px-2 py-1 text-right">
                    <select class="cost-comp-select p-1 border rounded"></select>
                </td>
                <td class="px-2 py-1 text-center"><input class="cost-comp-qty p-1 border rounded text-center" value="${data && data.qty ? data.qty : 1}" style="width:90px" /></td>
                <td class="px-2 py-1 text-center"><span class="cost-comp-unit">${data && data.unit?escapeHtml(data.unit):''}</span></td>
                <td class="px-2 py-1 text-center"><input class="cost-comp-unitcost p-1 border rounded text-center" value="${data && data.unitCost?data.unitCost:0}" style="width:110px" /></td>
                <td class="px-2 py-1 text-center"><span class="cost-comp-total">0.00</span></td>
                <td class="px-2 py-1 text-center"><button class="cost-remove-row bg-red-500 text-white px-2 rounded">حذف</button></td>
            `;
            tbody.appendChild(tr);
            const typeSel = tr.querySelector('.cost-comp-type');
            const compSel = tr.querySelector('.cost-comp-select');
            // ensure row cells allow dropdowns to overflow if needed
            try{ tr.style.overflow = 'visible'; if(typeSel && typeSel.parentElement) typeSel.parentElement.style.overflow = 'visible'; if(compSel && compSel.parentElement) compSel.parentElement.style.overflow = 'visible'; }catch(e){}
            const qtyInp = tr.querySelector('.cost-comp-qty');
            const unitSpan = tr.querySelector('.cost-comp-unit');
            const unitCostInp = tr.querySelector('.cost-comp-unitcost');
            const totalSpan = tr.querySelector('.cost-comp-total');

            function populateOptions(){
                const isRaw = typeSel.value === 'raw';
                compSel.innerHTML = isRaw ? createComponentOptionHTML(costRaw) : createComponentOptionHTML(costPack);
                if(data && data.id) compSel.value = data.id;
                // set unit and unitcost
                const opt = compSel.options[compSel.selectedIndex];
                if(opt){
                    unitSpan.textContent = opt.getAttribute('data-unit') || '';
                    // if auto-fill from last price is enabled and this is a raw item, prefer data-lastprice
                    const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                    if(isRaw && auto){ unitCostInp.value = Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0); }
                    else { unitCostInp.value = Number(opt.getAttribute('data-cost')||0); }
                }
                recalc();
            }

            // Workarounds: ensure the select receives pointer events and is above overlays
            try{
                [compSel, typeSel].forEach(s=>{
                    if(!s) return;
                    s.style.position = 'relative';
                    s.style.zIndex = 9999;
                    s.style.pointerEvents = 'auto';
                    // make native dropdown arrow available across browsers
                    s.style.webkitAppearance = 'menulist';
                    s.style.MozAppearance = 'menulist-button';
                    s.addEventListener('mousedown', function(ev){ ev.stopPropagation(); });
                    s.addEventListener('click', function(ev){ ev.stopPropagation(); });
                    s.addEventListener('focus', ()=>{ s.style.zIndex = 12000; });
                    s.addEventListener('blur', ()=>{ s.style.zIndex = 9999; });
                });
            }catch(e){/* ignore */}

            function recalc(){
                const q = parseFloat(qtyInp.value || 0) || 0;
                const uc = parseFloat(unitCostInp.value || 0) || 0;
                const tot = Math.round((q * uc) * 100) / 100;
                totalSpan.textContent = tot.toFixed(2);
                calculateTotals();
            }

            typeSel.addEventListener('change', populateOptions);
            compSel.addEventListener('change', () => {
                const opt = compSel.options[compSel.selectedIndex];
                if(opt){
                    unitSpan.textContent = opt.getAttribute('data-unit') || '';
                    const isRaw = typeSel.value === 'raw';
                    const auto = document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
                    if(isRaw && auto) unitCostInp.value = Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0);
                    else unitCostInp.value = Number(opt.getAttribute('data-cost')||0);
                }
                recalc();
            });
            qtyInp.addEventListener('input', recalc);
            unitCostInp.addEventListener('input', recalc);
            tr.querySelector('.cost-remove-row').addEventListener('click', ()=>{ tr.remove(); calculateTotals(); });

            populateOptions();
        }

        function calculateTotals(){
            const rows = Array.from(document.querySelectorAll('#cost-bom-body tr'));
            let rawSum = 0; let packSum = 0;
            rows.forEach(r => {
                const type = (r.querySelector('.cost-comp-type') && r.querySelector('.cost-comp-type').value) || 'raw';
                const q = parseFloat((r.querySelector('.cost-comp-qty') && r.querySelector('.cost-comp-qty').value) || 0) || 0;
                const uc = parseFloat((r.querySelector('.cost-comp-unitcost') && r.querySelector('.cost-comp-unitcost').value) || 0) || 0;
                const tot = Math.round(q * uc * 100) / 100;
                if(type === 'raw') rawSum += tot; else packSum += tot;
            });

            const yieldVal = parseFloat(document.getElementById('cost-yield').value || 1) || 1;

            // overheads
            const overheadFixed = parseFloat(document.getElementById('cost-overhead-fixed') && document.getElementById('cost-overhead-fixed').value || 0) || 0; // fixed per batch
            const overheadPercent = parseFloat(document.getElementById('cost-overhead-percent') && document.getElementById('cost-overhead-percent').value || 0) || 0; // percent of raw materials

            // percent amount is applied on rawSum (total materials) for the whole batch
            const overheadPercentAmount = Math.round((rawSum * (overheadPercent / 100)) * 100) / 100;

            // per-unit fixed overhead = fixed per batch / yield
            const overheadFixedPerUnit = yieldVal ? Math.round((overheadFixed / yieldVal) * 100) / 100 : 0;

            // total per-unit cost = (raw + pack + overheadPercentAmount + overheadFixed) / yield
            const perUnit = Math.round(((rawSum + packSum + overheadPercentAmount + overheadFixed) / yieldVal) * 100) / 100;

            // update UI
            const rawEl = document.getElementById('cost-raw-total'); if(rawEl) rawEl.textContent = rawSum.toFixed(2);
            const packEl = document.getElementById('cost-pack-total'); if(packEl) packEl.textContent = packSum.toFixed(2);
            const fixedPerUnitEl = document.getElementById('cost-overhead-fixed-perunit'); if(fixedPerUnitEl) fixedPerUnitEl.textContent = overheadFixedPerUnit.toFixed(2);
            const percentAmtEl = document.getElementById('cost-overhead-percent-amount'); if(percentAmtEl) percentAmtEl.textContent = overheadPercentAmount.toFixed(2);
            const totalPerUnitEl = document.getElementById('cost-total-per-unit'); if(totalPerUnitEl) totalPerUnitEl.textContent = perUnit.toFixed(2);
        }

        // Save / load BOM for selected product
        function saveBOMForSelected(){
            const sel = document.getElementById('cost-product-select'); if(!sel) return alert('اختر منتجاً تاماً');
            const pid = sel.value; if(!pid) return alert('اختر منتجاً تاماً');
            const rows = Array.from(document.querySelectorAll('#cost-bom-body tr')).map(r => ({ type: r.querySelector('.cost-comp-type').value, id: r.querySelector('.cost-comp-select').value, qty: parseFloat(r.querySelector('.cost-comp-qty').value||0)||0, unit: r.querySelector('.cost-comp-unit').textContent||'', unitCost: parseFloat(r.querySelector('.cost-comp-unitcost').value||0)||0 }));
            const payload = { yield: parseFloat(document.getElementById('cost-yield').value||1)||1, items: rows, savedAt: new Date().toISOString() };
            localStorage.setItem(LS_BOM_PREFIX + pid, JSON.stringify(payload));
            alert('تم حفظ BOM للمنتج');
        }

        function ensureDefaultBOMRows(){ /* legacy BOM disabled after simplification */ return; }

        function loadBOMForProduct(pid){ /* legacy BOM disabled */ return; }

        // UI bindings
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'new-bom-row-btn'){ addBOMRow(); }
            if(e.target && e.target.id === 'cost-save-bom-btn'){ saveBOMForSelected(); }
            if(e.target && e.target.id === 'cost-export-btn'){
                const summary = `تكلفة وحدة: ${document.getElementById('cost-total-per-unit').textContent} — خامات: ${document.getElementById('cost-raw-total').textContent} — تغليف: ${document.getElementById('cost-pack-total').textContent}`;
                navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(summary).then(()=>alert('تم نسخ الملخص')) : prompt('انسخ الملخص يدوياً:', summary);
            }
            if(e.target && e.target.id === 'cost-load-sample'){
                // small sample to help user start
                costFinished.push({ id: 'P-001', code: 'P-001', name: 'منتج نموذجي', unit: 'قطعة', price: 100 });
                costRaw.push({ id: 'R-001', code: 'R-001', name: 'لبن', unit: 'كجم', cost: 20 });
                costPack.push({ id: 'K-001', code: 'K-001', name: 'عبوة بلاستيك', unit: 'قطعة', cost: 1.5 });
                saveLists(); alert('تم تحميل نموذج بسيط');
            }
            if(e.target && e.target.id === 'cost-save-all-lists'){ saveLists(); alert('تم حفظ القوائم'); }
        });

        // when product selection changes, load saved BOM if exists
        document.addEventListener('change', function(e){
            if(e.target && e.target.id === 'cost-product-select'){
                document.getElementById('cost-bom-body').innerHTML='';
                const pid = e.target.value; if(!pid){ ensureDefaultBOMRows(); return; } loadBOMForProduct(pid);
            }
            // recalculations when yield or overhead fields change (change event)
            if(e.target && (e.target.id === 'cost-yield' || e.target.id === 'cost-overhead-fixed' || e.target.id === 'cost-overhead-percent')) calculateTotals();
        });

        // live-update totals while user types overheads
        ['cost-overhead-fixed','cost-overhead-percent'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', () => calculateTotals());
        });

        // Recalculate totals whenever the BOM body changes (delegated)
        const bomObserver = new MutationObserver(()=> calculateTotals());
        const bomBody = document.getElementById('cost-bom-body'); if(bomBody) bomObserver.observe(bomBody, { childList:true, subtree:true });

        // show page handler
        function onShowCostsPage(){
            try{ document.getElementById('header-title').textContent = 'التكاليف'; }catch(e){}
            // Call simplified cost renderers if available
            if(window.renderQuickLists) window.renderQuickLists();
            try { renderPriceManager(); } catch(_){ }
            if(window.renderRecipes) window.renderRecipes();
            // تشغيل استيراد صامت لأول مرة إذا لا توجد وصفات والتاريخ المحلي يحتوي أسماء قديمة
            try {
                if (window.autoImportLegacyRecipesOnce) window.autoImportLegacyRecipesOnce();
                if (window.autoRestoreCostListsOnce) window.autoRestoreCostListsOnce();
            } catch(_){ }
        }

        // wire to nav clicks
        document.addEventListener('click', function(e){
            const btn = e.target.closest && e.target.closest('.bottom-nav-item');
            if(btn && btn.getAttribute('data-page') === 'costs'){ setTimeout(onShowCostsPage, 40); }
        });

        // Also detect programmatic navigation
        const pageObserver = new MutationObserver(muts => {
            muts.forEach(m => {
                if(m.target && m.target.id === 'page-costs' && m.attributeName === 'class'){
                    if(m.target.classList.contains('active')) onShowCostsPage();
                }
            });
        });
        const pageCostsEl = document.getElementById('page-costs'); if(pageCostsEl) pageObserver.observe(pageCostsEl, { attributes: true });

        // initialize data on load
        document.addEventListener('DOMContentLoaded', () => { try{ loadLists(); }catch(e){} });

        // Restore from price lists: clear any previous Excel import and import finished products from app price lists
        function restoreFromPriceLists(){
            try{
                // clear existing lists (remove any Excel-imported entries)
                costFinished = [];
                costRaw = [];
                costPack = [];

                const src = (Array.isArray(state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
                let added = 0;
                src.forEach(p =>{
                    const id = p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'قطعة', price: Number(p.price||p.sellPrice||0) });
                    added++;
                });
                saveLists();
                console.log('restoreFromPriceLists: imported', added, 'products');
                alert('تم مسح بيانات الاستيراد السابقة واستعادة المنتجات من قوائم الأسعار (' + added + ' عنصر).');
            } catch(e){ console.warn('restoreFromPriceLists failed', e); alert('فشل استعادة قوائم الأسعار: ' + (e && e.message)); }
        }
        // expose for manual usage and UI button
        window.restoreFromPriceLists = restoreFromPriceLists;

        // تشغيل ترميم القوائم مرة واحدة: يعيد أسماء المنتجات لقوائم التكاليف السريعة
        window.autoRestoreCostListsOnce = (function(){
            let done = false;
            let retries = 0;
            const maxRetries = 10;
            const retryDelayMs = 500;
            function attempt(){
                if (done) return;
                try {
                    try { if (typeof loadLists === 'function') loadLists(); } catch(_){ }
                    const hasAny = (Array.isArray(window.costFinished) && window.costFinished.length)
                                  || (Array.isArray(window.costRaw) && window.costRaw.length)
                                  || (Array.isArray(window.costPack) && window.costPack.length);
                    if (hasAny) { done = true; return; }
                    const hasProducts = Array.isArray(state.products) && state.products.length;
                    if (hasProducts) {
                        restoreFromPriceLists();
                        try { if (window.renderQuickLists) window.renderQuickLists(); } catch(_){ }
                        done = true; return;
                    }
                    if (retries < maxRetries) { retries++; setTimeout(attempt, retryDelayMs); return; }
                    // No products after retries; leave it to manual button
                    done = true;
                } catch(_){ done = true; }
            }
            return attempt;
        })();

    // NOTE: auto-restore from price lists was previously executed here on load and caused unwanted alerts.
    // Auto-run has been disabled to avoid automatic popups. To run restore manually, call restoreFromPriceLists() from the console or add a dedicated button.
    // try{ restoreFromPriceLists(); } catch(e){}

        // Add bulk packaging items provided by user into costPack (avoid duplicates)
        (function addDefaultPackItems(){
            const PACK_ITEMS = [
"استيكر قشطة",
"اطباق شرش",
"استيكر مش كريمى 3ك",
"استيكر مش كريمى 8ك",
"استيكر مش قطع 3ك",
"استيكر مش قطع 8ك",
"استيكر  ملح خفيف طبيعى 8ك",
"استيكر ملح خفيف نباتى 8ك",
"استيكر قريش خالية الدسم 8 ك",
"استيكر قريش كاملة الدسم 8 ك",
"استيكر فيتا سادة طبيعى 8ك",
"استيكر فيتا فلفل طبيعى 8ك",
"استيكر فيتا فلفل نباتى 8ك",
"استيكر فيتا سادة نباتى 8ك",
"استيكر كيرى طبيعى 3ك",
"استيكر كيرى نباتى 3ك",
"استيكر مورتة 2.5ك",
"استيكر مورتة 300 جم",
"استيكر صوص شيدر 3ك",
"استيكر نستو طبيعى 3ك",
"استيكر شيكولاتة بيضاء 4ك",
"استيكر كيرى بسطرمة",
"استيكر كيرى شيدر",
"استيكر كيرى رومى",
"استيكر كيرى جودة",
"استيكر كيرى زيتون",
"استيكر كيرى قشطة",
"لوجو الربيع ازرق",
"لوجو الربيع اخضر",
"لوجو فيتا فلفل طبيعى",
"اكياس جرادل 8ك",
"مناديل 40*40",
"جوانتى علبة",
"مناديل فيتا سادة نباتى",
"مناديل ملح خفيف نباتى",
"مناديل قريش خالية الدسم",
"مناديل قريش كاملة الدسم",
"مناديل سادة 30-30",
"رول فرش صوانى",
"مناديل صوانى 70-70",
"اكياس شفاف 27*45",
"شنط وسط سادة",
"شنط كبير سادة",
"شنط صغير سادة",
"اكياس لبن شفاف 1ك",
"برطمان 800 جم",
"برطمان 500 جم",
"برطمان 300 جم",
"طبق بلاستيك 1ك",
"جردل فارغ 8ك بالغطاء",
"غطاء جردل 8ك",
"جردل فارغ 3ك بالغطاء",
"غطاء جردل 3ك",
"غطاء  زبادى 100 جم",
"علبة حلويات شفاف",
"غطاء زبادى 140 جم",
"استيكر زبدة جاموسى 1ك",
"استيكر زبدة جاموسى 900جم",
"استيكر زبدة جاموسى500جم",
"استيكر زبدة بقرى 1ك",
"استيكر زبدة بقرى 900جم",
"استيكر زبدة بقرى 500جم",
"استيكر سمن جاموسى 800 جم",
"كبسولة امان سمن جاموسى 800 جم",
"استيكر سمن جاموسى 500 جم",
"كبسولة امان سمن جاموسى 500 جم",
"استيكر سمن جاموسى 200 جم",
"كبسولة امان سمن جاموسى 200 جم",
"استيكر سمن بقرى 800 جم",
"كبسولة امان سمن بقرى 800 جم",
"استيكر سمن بقرى 500 جم",
"كبسولة امان سمن بقرى 500 جم",
"استيكر سمن بقرى 200 جم",
"كبسولة امان سمن بقرى 200 جم",
"استيكر مش قطع 10ك",
"استيكر مش كريمى 10ك",
"كرتونة تعبأة ارز",
"كرتونة تعبأة زبادى",
"كرتونة تعبأة سمن 800 جم",
"كرتونة تعبأة سمن 500 جم",
"كرتونة تعبأة سمن-مورتة 200 جم",
"رول استرتش 40سم",
"اكياس مورتة  فاكيوم",
"ايس بوكس فل كبير",
"ايس بوكس فل صغير",
"علبة شفاف كبير",
"غطاء شفاف كبير",
"اكياس لبن شفاف 2ك",
"فلتر محلب",
"علبة عاشوراء سادة",
"غطاء عاشوراء سادة",
"مناديل فيتا سادة طبيعى",
"مناديل فيتا فلفل طبيعى",
"مناديل ملح خفيف طبيعى",
"مناديل صوانى مستطيلة",
"استيكر شيكولاتة سوداء 4ك",
"اكياس زبدة فاكيوم",
"علبة فارغ 1ك",
"غطاء ارز باللبن-زبادى 500 جم",
"اكياس قمامة",
"اوفر هيد باكت",
"جردل فارغ 8ك",
"جردل فارغ 3ك",
"افيز كيس",
"مناديل فيتا فلفل نباتى",
"لوجو الربيع فيتا سادة طبيعى",
"لوجو الربيع ملح خفيف طبيعى",
"غطاء برطمان سمن 800 / 500 جم",
"غطاء برطمان سمن 200 جم / 300 جم",
"برطمان 200 جم",
"طبق بلاستيك 500 جم",
"علبة بلاستيك بالغطاء 250 جم",
"كيس شرنك",
"فخار زبادى",
"فخار ارز",
"علبة بلاستيك بالغطاء 125 جم",
"علب زبادى بالغطاء أبو الخير",
"زجاجة لبن فارغة",
"فخار الدوار",
"اطباق 1ك بالغطاء",
"علبة فارغ 4ك بالغطار",
"استيكر ملح خفيف نباتى 4ك",
"استيكر فيتا نباتى 4ك",
"اكياس لبن شفاف 500 جم",
"سلوتيب عريض",
"اوفر شوز",
"كمامه",
"شراب",
"باركود صغير للطباعه",
"باركود كبير للطباعه",
"كيس معالق",
"اكياس شرنك ارز",
"اكياس شرنك زبادى",
"جوانتى كيس",
"كرتونة تعبأة موزريلا",
"بكر باركود حرارى",
"استيكر زبادى فخار",
"استيكر ارز فخار",
"كرتونه موزريلا",
"رول استرتش 10 سم",
"جردل 4ك بالغطاء",
"جردل 4ك",
"غطاء جردل 4ك",
"علبه مفصلي شفاف بالغطاء"
            ];
            try{
                let added = 0;
                PACK_ITEMS.forEach(name => {
                    if(!costPack.some(x => String(x.name).trim() === String(name).trim())){
                        const id = 'pack-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
                        costPack.push({ id, code: id, name: name, unit: 'قطعة', cost: 0 });
                        added++;
                    }
                });
                if(added > 0) saveLists();
                console.log('Added packaging items:', added);
                // Don't show an alert on initial population to avoid annoying startup popups.
                // If the user wants confirmation, they can open Manage Lists or export the lists.
            } catch(e){ console.warn('addDefaultPackItems error', e); }
        })();

        // --- Excel Import (SheetJS) ---
        function loadSheetJs() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) return resolve(window.XLSX);
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
                s.onload = () => resolve(window.XLSX);
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        function detectKey(keys, candidates){
            const norm = k => String(k||'').trim().toLowerCase();
            for(const k of keys){
                const n = norm(k);
                for(const c of candidates){ if(n.indexOf(c) !== -1) return k; }
            }
            return null;
        }

        async function handleExcelFile(file) {
            try{
                await loadSheetJs();
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type:'array'});
                const first = wb.SheetNames[0];
                const sheet = wb.Sheets[first];
                const rows = XLSX.utils.sheet_to_json(sheet, {defval: ''});
                if(!rows || !rows.length) return alert('الملف لا يحتوي على بيانات قابلة للاستيراد');

                // detect columns
                const sampleKeys = Object.keys(rows[0]);
                const codeKey = detectKey(sampleKeys, ['code','كود']);
                const nameKey = detectKey(sampleKeys, ['name','item','البيان','اسم']);
                const unitKey = detectKey(sampleKeys, ['unit','الوحدة','وحدة']);
                const costKey = detectKey(sampleKeys, ['تكلف','cost']);
                const priceKey = detectKey(sampleKeys, ['سعر','price','بيع']);
                const sectionKey = detectKey(sampleKeys, ['قسم','القسم','category','type']);

                let addedFinished = 0, addedRaw = 0, addedPack = 0;
                rows.forEach(r => {
                    const code = String(r[codeKey] || r['Code'] || r['code'] || '').trim() || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    const name = String(r[nameKey] || r['Item Name'] || r['item name'] || '').trim() || '';
                    const unit = String(r[unitKey] || '').trim() || '';
                    const cost = parseFloat(String(r[costKey] || r['سعر التكلفة'] || r['Cost'] || '') || 0) || 0;
                    const price = parseFloat(String(r[priceKey] || r['سعر البيع'] || r['Price'] || '') || 0) || 0;
                    const section = String(r[sectionKey] || r['اسم المخزن'] || r['القسم'] || '').trim().toLowerCase();

                    const item = { id: code, code, name, unit, cost, price };
                    // heuristics to classify
                    if(section.includes('انتاج') || section.includes('تام') || section.includes('product') || (name && (name.toLowerCase().indexOf('جبنة')>-1 || name.toLowerCase().indexOf('لبن')>-1))) {
                        costFinished.push(item); addedFinished++;
                    } else if(section.includes('خامات') || section.includes('خام') || section.includes('مواد') || section.includes('raw')){
                        costRaw.push(item); addedRaw++;
                    } else if(section.includes('تعب') || section.includes('تغليف') || section.includes('pack') || section.includes('عبوة')){
                        costPack.push(item); addedPack++;
                    } else {
                        // default: finished
                        costFinished.push(item); addedFinished++;
                    }
                });

                saveLists();
                alert(`تم الاستيراد: المنتجات التامة ${addedFinished} — الخامات ${addedRaw} — التغليف ${addedPack}`);
            } catch(e){ console.error('Excel import failed', e); alert('فشل استيراد الملف: ' + (e && e.message)); }
        }

        // wire import controls
        document.addEventListener('click', function(e){
            if(e.target && e.target.id === 'cost-import-xlsx-btn'){
                const inp = document.getElementById('cost-excel-input'); if(inp) inp.click();
            }
            if(e.target && e.target.id === 'cost-import-from-state-btn'){
                // import existing app products (state.products or DEFAULT_PRODUCTS)
                const src = (Array.isArray(state.products) && state.products.length) ? state.products : DEFAULT_PRODUCTS || [];
                let added = 0;
                src.forEach(p =>{
                    const id = p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
                    const existing = costFinished.find(x => String(x.id) === String(id));
                    if(!existing){ costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'قطعة', price: Number(p.price||p.sellPrice||0) }); added++; }
                });
                saveLists();
                alert('تم استيراد ' + added + ' منتج من بيانات التطبيق.');
            }
        });
        document.getElementById('cost-excel-input') && document.getElementById('cost-excel-input').addEventListener('change', function(e){
            const f = e.target.files && e.target.files[0]; if(f) handleExcelFile(f);
            // reset input
            e.target.value = '';
        });
    })();
    </script>
        <!-- Claude client helper: call Netlify proxy at /api/claude -->
        <script>
            (function(){
                if (window.ClaudeAPI) return; // guard
                window.ClaudeAPI = {
                    async chat(opts){
                        const payload = {
                            model: (opts && opts.model) || 'claude-3-5-sonnet-20241022',
                            max_tokens: (opts && opts.max_tokens) || 512,
                            system: opts && opts.system,
                            messages: (opts && opts.messages) || [],
                            stream: !!(opts && opts.stream)
                        };
                        const res = await fetch('/api/claude', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) {
                            const text = await res.text().catch(()=> '');
                            throw new Error('Claude proxy error: HTTP ' + res.status + (text ? ('\n' + text) : ''));
                        }
                        const ct = res.headers.get('content-type')||'';
                        if (ct.includes('application/json')) return res.json();
                        return res.text();
                    },
                    async simple(prompt, extra){
                        const messages = [{ role: 'user', content: prompt }];
                        const data = await this.chat({ ...(extra||{}), messages });
                        try {
                            const parts = Array.isArray(data && data.content) ? data.content : [];
                            const txt = parts.find(p => p && p.type === 'text');
                            return txt ? txt.text : JSON.stringify(data);
                        } catch(e){ return JSON.stringify(data||{}); }
                    }
                };

                // Minimal console test helper (optional)
                window.testClaude = async function(){
                    try {
                        console.time('claude');
                        const out = await window.ClaudeAPI.simple('قل مرحباً بك!');
                        console.timeEnd('claude');
                        alert(out);
                    } catch(err){
                        console.error(err);
                        alert('فشل الاتصال بـ Claude: ' + (err && err.message));
                    }
                };
            })();

            // ================= Simplified Cost (Recipe) Feature =================
            (function(){
                const LS_SIMPLE_RECIPES = 'simple_cost_recipes';
                let simpleRecipes = [];
                let lastFocusedRecipeId = null;
                // timers to debounce input handling per recipe card to avoid rebuilding DOM on every keystroke
                const recipeInputTimers = new Map();

                function loadSimpleRecipes(){
                    try { const raw = localStorage.getItem(LS_SIMPLE_RECIPES); simpleRecipes = raw ? JSON.parse(raw) : []; if(!Array.isArray(simpleRecipes)) simpleRecipes = []; } catch(e){ simpleRecipes = []; }
                    // Also load drafts to restore them if user revisits
                    try { const draftRaw = localStorage.getItem('costDrafts'); if (draftRaw) state.costDrafts = JSON.parse(draftRaw); } catch(e){}
                }
                function saveSimpleRecipes(){ try { localStorage.setItem(LS_SIMPLE_RECIPES, JSON.stringify(simpleRecipes)); } catch(e){} }
                function toNum(v){ return parseFloat(v||0) || 0; }
                function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
                function computeRecipe(r){
                    const ingredientsCost = (r.ingredients||[]).reduce((a,x)=> a + (toNum(x.qtyKg) * toNum(x.unitCost)), 0);
                    const packagingCost = (r.packaging||[]).reduce((a,x)=> a + toNum(x.cost), 0);
                    const operationsCost = (r.operations||[]).reduce((a,x)=> a + toNum(x.cost), 0);
                    const totalBatchCost = ingredientsCost + packagingCost + operationsCost;
                    const costPerKg = toNum(r.batchSizeKg) > 0 ? totalBatchCost / toNum(r.batchSizeKg) : 0;
                    return { ingredientsCost, packagingCost, operationsCost, totalBatchCost, costPerKg };
                }
                function ingredientRow(idx, ing){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="ing">\n<input class="ing-name flex-1 p-1 border rounded text-xs" placeholder="اسم" value="${esc(ing.name)}" />\n<input class="ing-qty w-20 p-1 border rounded text-xs text-center" placeholder="كمية" value="${esc(ing.qtyKg)}" />\n<input class="ing-cost w-20 p-1 border rounded text-xs text-center" placeholder="سعر/كجم" value="${esc(ing.unitCost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>\n</div>`;
                }
                function packagingRow(idx, pk){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="pack">\n<input class="pack-name flex-1 p-1 border rounded text-xs" placeholder="اسم" value="${esc(pk.name)}" />\n<input class="pack-cost w-24 p-1 border rounded text-xs text-center" placeholder="قيمة" value="${esc(pk.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>\n</div>`;
                }
                function operationRow(idx, op){
                    return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="op">\n<input class="op-name flex-1 p-1 border rounded text-xs" placeholder="وصف" value="${esc(op.name)}" />\n<input class="op-cost w-24 p-1 border rounded text-xs text-center" placeholder="قيمة" value="${esc(op.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>\n</div>`;
                }
                function computeAndCardHTML(r){
                    const c = computeRecipe(r);
                    // Try to restore draft values if they exist
                    if (!state.costDrafts) state.costDrafts = {};
                    const draft = state.costDrafts[r.id] || {};
                    const name = draft.name || r.name || '';
                    const batchSizeKg = draft.batchSizeKg || r.batchSizeKg || '';
                    const notes = draft.notes || r.notes || '';
                    const ingredients = (draft.ingredients && Array.isArray(draft.ingredients) && draft.ingredients.length > 0) ? draft.ingredients : r.ingredients;
                    const packaging = (draft.packaging && Array.isArray(draft.packaging) && draft.packaging.length > 0) ? draft.packaging : r.packaging;
                    const operations = (draft.operations && Array.isArray(draft.operations) && draft.operations.length > 0) ? draft.operations : r.operations;
                    return `<div class="flex items-center gap-2 mb-2">\n<input class="recipe-name w-full p-2 border rounded" placeholder="اسم المنتج" value="${esc(name)}" />\n<input class="recipe-batch w-28 p-2 border rounded" placeholder="دفعة كجم" value="${esc(batchSizeKg)}" />\n<button class="delete-recipe bg-red-600 text-white px-2 py-1 rounded text-sm">حذف</button>\n</div>\n<div class="grid md:grid-cols-3 gap-4">\n<div>\n<h4 class="font-semibold text-sm mb-1">الخامات</h4>\n<div class="ingredients space-y-2">${ingredients.map((ing,i)=> ingredientRow(i, ing)).join('')}</div>\n<button class="add-ingredient bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ خامة</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">التعبئة</h4>\n<div class="packaging space-y-2">${packaging.map((pk,i)=> packagingRow(i, pk)).join('')}</div>\n<button class="add-packaging bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ تغليف</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">التشغيل</h4>\n<div class="operations space-y-2">${operations.map((op,i)=> operationRow(i, op)).join('')}</div>\n<button class="add-operation bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ تشغيل</button>\n</div>\n</div>\n<div class="text-sm bg-gray-50 border rounded p-3 grid grid-cols-2 md:grid-cols-5 gap-2">\n<div><span class="text-gray-600">خامات:</span> <span class="font-bold">${c.ingredientsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">تغليف:</span> <span class="font-bold">${c.packagingCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">تشغيل:</span> <span class="font-bold">${c.operationsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">إجمالي الدفعة:</span> <span class="font-bold">${c.totalBatchCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">التكلفة / كجم:</span> <span class="font-bold">${c.costPerKg.toFixed(2)}</span></div>\n</div>\n<textarea class="recipe-notes w-full p-2 border rounded text-sm" placeholder="ملاحظات">${esc(notes)}</textarea>`;
                }
                function renderRecipes(){
                    const listEl = document.getElementById('recipes-list'); if(!listEl) return;
                    listEl.innerHTML = '';
                    if(simpleRecipes.length === 0){
                        listEl.innerHTML = '<div class="p-4 bg-white rounded shadow text-sm text-gray-600">لا توجد منتجات بعد. اضغط "منتج جديد".</div>';
                        return;
                    }
                    simpleRecipes.forEach(r => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow border p-4 space-y-3';
                        card.setAttribute('data-id', r.id);
                        card.innerHTML = computeAndCardHTML(r);
                        listEl.appendChild(card);

                        // Attach autosave handlers to card inputs for persistent drafts
                        try {
                            const inputs = card.querySelectorAll('input, textarea');
                            inputs.forEach(input => {
                                // Save on blur
                                input.addEventListener('blur', () => {
                                    saveCostCardDraft(card);
                                });
                                // Also save when Tab is pressed
                                input.addEventListener('keydown', (ev) => {
                                    if (ev.key === 'Tab') {
                                        saveCostCardDraft(card);
                                    }
                                    // On Enter in ingredient/packaging/operation name field, show autocomplete if appropriate
                                    if (ev.key === 'Enter') {
                                        ev.preventDefault();
                                        saveCostCardDraft(card);
                                        // Move to next focusable element
                                        const focusables = Array.from(card.querySelectorAll('input, textarea, button')).filter(el => !el.disabled && el.offsetParent !== null);
                                        const idx = focusables.indexOf(ev.target);
                                        if (idx >= 0 && idx < focusables.length - 1) {
                                            focusables[idx + 1].focus();
                                        }
                                    }
                                });
                            });

                            // Attach autocomplete handlers for ingredient/packaging names
                            const ingNameInputs = card.querySelectorAll('.ingredients .ing-name');
                            const packNameInputs = card.querySelectorAll('.packaging .pack-name');
                            const opNameInputs = card.querySelectorAll('.operations .op-name');

                            ingNameInputs.forEach(inp => {
                                inp.addEventListener('input', (e) => {
                                    showCostAutocomplete(e.target, 'ingredient');
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });

                            packNameInputs.forEach(inp => {
                                inp.addEventListener('input', (e) => {
                                    showCostAutocomplete(e.target, 'packaging');
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });

                            opNameInputs.forEach(inp => {
                                inp.addEventListener('input', (e) => {
                                    showCostAutocomplete(e.target, 'operation');
                                });
                                inp.addEventListener('blur', () => {
                                    setTimeout(() => hideCostAutocomplete(inp), 150);
                                });
                            });
                        } catch (err) {
                            console.warn('attach card handlers failed', err);
                        }
                    });
                }
                function renderQuickLists(){
                    const wrap = document.getElementById('recipe-quick-lists'); if(!wrap) return;
                    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                    const fin = Array.isArray(window.costFinished) ? window.costFinished : [];
                    const raw = Array.isArray(window.costRaw) ? window.costRaw : [];
                    const pack = Array.isArray(window.costPack) ? window.costPack : [];
                    const summary = `القوائم السريعة — منتجات: ${fin.length} • خامات: ${raw.length} • تغليف: ${pack.length}`;
                    const prodHtml = `<div class="bg-white border rounded p-3 shadow"><h4 class="font-semibold text-sm mb-2">المنتجات</h4><div class="flex flex-wrap gap-2">${fin.map(p=>`<button type="button" class="quick-add-item px-2 py-1 rounded text-xs bg-blue-100 hover:bg-blue-200" data-add-type="ing" data-name="${esc(p.name)}">${esc(p.name)}</button>`).join('') || '<span class=\"text-xs text-gray-500\">لا يوجد</span>'}</div></div>`;
                    const rawHtml = `<div class="bg-white border rounded p-3 shadow"><h4 class="font-semibold text-sm mb-2">الخامات</h4><div class="flex flex-wrap gap-2">${raw.map(p=>`<button type="button" class="quick-add-item px-2 py-1 rounded text-xs bg-green-100 hover:bg-green-200" data-add-type="ing" data-name="${esc(p.name)}">${esc(p.name)}</button>`).join('') || '<span class=\"text-xs text-gray-500\">لا يوجد</span>'}</div></div>`;
                    const packHtml = `<div class="bg-white border rounded p-3 shadow"><h4 class="font-semibold text-sm mb-2">التعبئة والتغليف</h4><div class="flex flex-wrap gap-2">${pack.map(p=>`<button type="button" class="quick-add-item px-2 py-1 rounded text-xs bg-purple-100 hover:bg-purple-200" data-add-type="pack" data-name="${esc(p.name)}">${esc(p.name)}</button>`).join('') || '<span class=\"text-xs text-gray-500\">لا يوجد</span>'}</div></div>`;
                    wrap.innerHTML = `<details class="bg-indigo-50 border border-indigo-200 rounded-md">`+
                        `<summary class="cursor-pointer px-3 py-2 text-sm font-semibold text-indigo-800 flex items-center gap-2"><i data-lucide=\"list\" class=\"w-4 h-4\"></i> ${summary}</summary>`+
                        `<div class="p-3 grid md:grid-cols-3 gap-4">${prodHtml}${rawHtml}${packHtml}</div>`+
                    `</details>`;
                    updateIcons();
                }
                function addRecipe(){
                    const r = { id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name: '', batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' };
                    simpleRecipes.push(r); saveSimpleRecipes(); renderRecipes();
                }
                function importFromOld(){
                    try{ if(typeof loadLists === 'function'){ loadLists(); } }catch(e){}
                    const fins = Array.isArray(window.costFinished)? window.costFinished : [];
                    const raws = Array.isArray(window.costRaw)? window.costRaw : [];
                    const packs = Array.isArray(window.costPack)? window.costPack : [];
                    let created = 0, updated = 0;
                    const byId = (arr,id)=> arr.find(x=> String(x.id) === String(id));
                    const unitCostOfRaw = r => (r && (r.lastPrice!=null?r.lastPrice:r.cost)) || 0;
                    const unitCostOfPack = p => (p && (p.lastPrice!=null?p.lastPrice:p.cost)) || 0;
                    fins.forEach(p => {
                        const name = (p && (p.name||p.code||'')).toString(); if(!name) return;
                        let existing = simpleRecipes.find(r=> (r.name||'') === name);
                        if(!existing){ existing = { id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' }; simpleRecipes.push(existing); created++; }
                        // try read BOM by id, then code, then name
                        const keys = [ p.id, p.code, p.name ].filter(Boolean).map(v => 'bom_' + v);
                        let bomObj = null;
                        for(const k of keys){ try{ const raw = localStorage.getItem(k); if(raw){ bomObj = JSON.parse(raw); break; } }catch(e){} }
                        if(!bomObj || !Array.isArray(bomObj.items)){ updated += 0; return; }
                        const ings = []; const pkgs = [];
                        bomObj.items.forEach(it => {
                            const qty = parseFloat(it.qty||0) || 0;
                            if((it.type||'').toLowerCase() === 'raw'){
                                const r = byId(raws, it.id);
                                ings.push({ name: (r && r.name) || (it.name||'مكوّن'), qtyKg: qty || '', unitCost: unitCostOfRaw(r) });
                            } else if((it.type||'').toLowerCase() === 'pack'){
                                const pk = byId(packs, it.id);
                                const uc = unitCostOfPack(pk);
                                pkgs.push({ name: (pk && pk.name) || (it.name||'تغليف'), cost: (qty * uc) || 0 });
                            }
                        });
                        // estimate batch size = sum raw qty where unit probably kg if data exists
                        const batch = ings.reduce((a,x)=> a + (parseFloat(x.qtyKg||0)||0), 0);
                        if(batch > 0 && !existing.batchSizeKg) existing.batchSizeKg = batch;
                        // merge by appending if empty
                        if(existing.ingredients.length === 0) existing.ingredients = ings;
                        if(existing.packaging.length === 0) existing.packaging = pkgs;
                        updated++;
                    });
                    saveSimpleRecipes(); renderRecipes(); renderQuickLists();
                    alert(`تم الاستيراد: أنشئت ${created} وصفات، وتم تحديث ${updated}.`);
                }
                // استيراد صامت بدون تنبيهات (للاستخدام الأول فقط)
                function silentImportIfEmpty(){
                    try{ if(typeof loadLists === 'function'){ loadLists(); } }catch(e){}
                    if (simpleRecipes.length > 0) return; // لا نفعل شيء لو توجد وصفات بالفعل
                    const fins = Array.isArray(window.costFinished)? window.costFinished : [];
                    const raws = Array.isArray(window.costRaw)? window.costRaw : [];
                    const packs = Array.isArray(window.costPack)? window.costPack : [];
                    if (!fins.length && !raws.length && !packs.length) return; // لا توجد بيانات قديمة
                    let created = 0;
                    fins.forEach(p => {
                        const name = (p && (p.name||p.code||'')); if(!name) return;
                        if(!simpleRecipes.some(r => r.name === name)){
                            simpleRecipes.push({ id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg:'', ingredients:[], packaging:[], operations:[], notes:'' });
                            created++;
                        }
                    });
                    if (created){ saveSimpleRecipes(); renderRecipes(); renderQuickLists(); }
                }
                // تشغيل مرة واحدة فقط عند أول فتح لصفحة التكاليف
                window.autoImportLegacyRecipesOnce = (function(){
                    let done = false;
                    return function(){ if(done) return; try { silentImportIfEmpty(); } catch(_){} done = true; };
                })();
                // كشف الدوال يدوياً
                window.importOldCosts = importFromOld;
                window.importOldCostsSilent = silentImportIfEmpty;
                function syncCard(card){
                    const id = card.getAttribute('data-id'); const r = simpleRecipes.find(x=>x.id===id); if(!r) return;
                    r.name = card.querySelector('.recipe-name')?.value.trim() || '';
                    r.batchSizeKg = card.querySelector('.recipe-batch')?.value.trim() || '';
                    r.notes = card.querySelector('.recipe-notes')?.value || '';
                    r.ingredients = Array.from(card.querySelectorAll('.ingredients > div')).map(d => ({ name: d.querySelector('.ing-name')?.value.trim() || '', qtyKg: d.querySelector('.ing-qty')?.value.trim() || '', unitCost: d.querySelector('.ing-cost')?.value.trim() || '' }));
                    r.packaging = Array.from(card.querySelectorAll('.packaging > div')).map(d => ({ name: d.querySelector('.pack-name')?.value.trim() || '', cost: d.querySelector('.pack-cost')?.value.trim() || '' }));
                    r.operations = Array.from(card.querySelectorAll('.operations > div')).map(d => ({ name: d.querySelector('.op-name')?.value.trim() || '', cost: d.querySelector('.op-cost')?.value.trim() || '' }));
                    saveSimpleRecipes(); renderRecipes();
                }

                function saveCostCardDraft(card) {
                    try {
                        const id = card.getAttribute('data-id');
                        if (!id) return;
                        if (!state.costDrafts) state.costDrafts = {};
                        const draft = {
                            name: card.querySelector('.recipe-name')?.value.trim() || '',
                            batchSizeKg: card.querySelector('.recipe-batch')?.value.trim() || '',
                            notes: card.querySelector('.recipe-notes')?.value || '',
                            ingredients: Array.from(card.querySelectorAll('.ingredients > div')).map(d => ({
                                name: d.querySelector('.ing-name')?.value.trim() || '',
                                qtyKg: d.querySelector('.ing-qty')?.value.trim() || '',
                                unitCost: d.querySelector('.ing-cost')?.value.trim() || ''
                            })),
                            packaging: Array.from(card.querySelectorAll('.packaging > div')).map(d => ({
                                name: d.querySelector('.pack-name')?.value.trim() || '',
                                cost: d.querySelector('.pack-cost')?.value.trim() || ''
                            })),
                            operations: Array.from(card.querySelectorAll('.operations > div')).map(d => ({
                                name: d.querySelector('.op-name')?.value.trim() || '',
                                cost: d.querySelector('.op-cost')?.value.trim() || ''
                            }))
                        };
                        state.costDrafts[id] = draft;
                        try { localStorage.setItem('costDrafts', JSON.stringify(state.costDrafts)); } catch (e) {}
                    } catch (e) {
                        console.warn('saveCostCardDraft failed', e);
                    }
                }

                function showCostAutocomplete(input, type) {
                    try {
                        const searchTerm = input.value.trim().toLowerCase();
                        const container = input.parentElement;
                        let suggestionsList = container.querySelector('.cost-suggestions');

                        if (!suggestionsList) {
                            suggestionsList = document.createElement('div');
                            suggestionsList.className = 'cost-suggestions absolute bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-48 overflow-y-auto';
                            suggestionsList.style.display = 'none';
                            suggestionsList.style.direction = 'rtl';
                            suggestionsList.style.top = '100%';
                            suggestionsList.style.right = '0';
                            suggestionsList.style.minWidth = '150px';
                            container.style.position = 'relative';
                            container.appendChild(suggestionsList);
                        }

                        if (searchTerm.length === 0) {
                            suggestionsList.style.display = 'none';
                            return;
                        }

                        // Filter products by type
                        let matches = [];
                        if (state.products && Array.isArray(state.products)) {
                            matches = state.products.filter(p => {
                                const pname = (p.name || '').toLowerCase();
                                const pcat = (p.category || '').toLowerCase();
                                // For ingredients: show raw materials
                                if (type === 'ingredient') {
                                    return (pcat.includes('خام') || pname.startsWith(searchTerm));
                                }
                                // For packaging: show packaging items
                                if (type === 'packaging') {
                                    return (pcat.includes('تغليف') || pcat.includes('تعبئة') || pname.startsWith(searchTerm));
                                }
                                // For operations: no category filtering
                                return pname.startsWith(searchTerm);
                            }).slice(0, 8);
                        }

                        if (matches.length === 0) {
                            suggestionsList.innerHTML = '<div class="p-2 text-gray-500 text-sm">لا توجد مقترحات</div>';
                            suggestionsList.style.display = 'block';
                            return;
                        }

                        suggestionsList.innerHTML = matches.map(p => `
                            <div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-product-name="${p.name}">
                                ${p.name} ${p.category ? `<span class="text-gray-500 text-xs">(${p.category})</span>` : ''}
                            </div>
                        `).join('');
                        suggestionsList.style.display = 'block';

                        // Handle suggestion click
                        suggestionsList.removeEventListener('click', () => {});
                        suggestionsList.addEventListener('click', (e) => {
                            const item = e.target.closest('[data-product-name]');
                            if (item) {
                                input.value = item.getAttribute('data-product-name');
                                suggestionsList.style.display = 'none';
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                                saveCostCardDraft(input.closest('[data-id]'));
                            }
                        });
                    } catch (err) {
                        console.warn('showCostAutocomplete failed', err);
                    }
                }

                function hideCostAutocomplete(input) {
                    try {
                        const suggestionsList = input.parentElement?.querySelector('.cost-suggestions');
                        if (suggestionsList) suggestionsList.style.display = 'none';
                    } catch (e) {}
                }
                document.addEventListener('click', function(e){
                    if(e.target && e.target.id === 'add-recipe-btn'){ addRecipe(); }
                    if(e.target && e.target.id === 'import-old-costs-btn'){ importFromOld(); }
                    if(e.target && e.target.id === 'restore-costs-from-products-btn'){ try { if (window.restoreFromPriceLists) window.restoreFromPriceLists(); if (window.renderQuickLists) window.renderQuickLists(); if (window.renderRecipes) window.renderRecipes(); } catch(_){} }
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(card){
                        if(e.target.classList.contains('add-ingredient')){ const id = card.getAttribute('data-id'); const r = simpleRecipes.find(x=>x.id===id); if(r){ r.ingredients.push({ name:'', qtyKg:'', unitCost:'' }); saveSimpleRecipes(); renderRecipes(); } }
                        if(e.target.classList.contains('add-packaging')){ const id = card.getAttribute('data-id'); const r = simpleRecipes.find(x=>x.id===id); if(r){ r.packaging.push({ name:'', cost:'' }); saveSimpleRecipes(); renderRecipes(); } }
                        if(e.target.classList.contains('add-operation')){ const id = card.getAttribute('data-id'); const r = simpleRecipes.find(x=>x.id===id); if(r){ r.operations.push({ name:'', cost:'' }); saveSimpleRecipes(); renderRecipes(); } }
                        if(e.target.classList.contains('delete-recipe')){ if(confirm('حذف المنتج؟')){ const id = card.getAttribute('data-id'); simpleRecipes = simpleRecipes.filter(x=>x.id!==id); saveSimpleRecipes(); renderRecipes(); } }
                        if(e.target.classList.contains('row-del')){ const row = e.target.closest('div[data-row]'); const type = row.getAttribute('data-type'); const idx = parseInt(row.getAttribute('data-row')); const id = card.getAttribute('data-id'); const r = simpleRecipes.find(x=>x.id===id); if(r){ if(type==='ing'){ r.ingredients.splice(idx,1); } else if(type==='pack'){ r.packaging.splice(idx,1); } else if(type==='op'){ r.operations.splice(idx,1); } saveSimpleRecipes(); renderRecipes(); } }
                    }
                });
                document.addEventListener('input', function(e){
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(!card) return;
                    const interesting = e.target.classList && (
                        e.target.classList.contains('recipe-name') ||
                        e.target.classList.contains('recipe-batch') ||
                        e.target.classList.contains('recipe-notes') ||
                        e.target.classList.contains('ing-name') ||
                        e.target.classList.contains('ing-qty') ||
                        e.target.classList.contains('ing-cost') ||
                        e.target.classList.contains('pack-name') ||
                        e.target.classList.contains('pack-cost') ||
                        e.target.classList.contains('op-name') ||
                        e.target.classList.contains('op-cost')
                    );
                    if(!interesting) return;

                    // debounce per-card so user can type uninterrupted
                    const id = card.getAttribute('data-id');
                    try { if(recipeInputTimers.has(id)) clearTimeout(recipeInputTimers.get(id)); } catch(_){}
                    const t = setTimeout(()=>{
                        try { syncCard(card); } catch(e){ console.warn('syncCard failed', e); }
                        recipeInputTimers.delete(id);
                    }, 350);
                    recipeInputTimers.set(id, t);
                });
                document.addEventListener('focusin', function(e){
                    const card = e.target && e.target.closest && e.target.closest('[data-id]');
                    if(card) lastFocusedRecipeId = card.getAttribute('data-id');
                });
                document.addEventListener('click', function(e){
                    if(e.target && e.target.getAttribute && e.target.getAttribute('data-page')==='costs'){ setTimeout(()=>{ renderRecipes(); renderQuickLists(); }, 80); }
                    if(e.target && e.target.classList.contains('quick-add-item')){
                        const name = e.target.getAttribute('data-name')||''; const type = e.target.getAttribute('data-add-type');
                        if(!name) return;
                        // pick target recipe
                        let target = simpleRecipes.find(r=>r.id===lastFocusedRecipeId);
                        if(!target){ target = simpleRecipes.length === 1 ? simpleRecipes[0] : null; }
                        if(!target){ addRecipe(); target = simpleRecipes[simpleRecipes.length-1]; lastFocusedRecipeId = target.id; }
                        if(type === 'ing'){ target.ingredients.push({ name, qtyKg:'', unitCost:'' }); }
                        else if(type === 'pack'){ target.packaging.push({ name, cost:'' }); }
                        saveSimpleRecipes(); renderRecipes();
                    }
                });
                // expose for legacy navigation handler
                window.renderRecipes = renderRecipes; window.renderQuickLists = renderQuickLists;
                loadSimpleRecipes(); // initial
                // initial quick list render (may be blank until user opens costs page)
                renderQuickLists();
            })();
        </script>
</body>
</html>
