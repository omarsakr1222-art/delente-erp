<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§ØªÙˆØ±Ø© Ø£Ù„Ø¨Ø§Ù† - ØªÙŠØ±Ø¨Ùˆ Ø³Ø±ÙŠØ¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap');
        
        body { font-family: 'Cairo', sans-serif; background: #e2e8f0; padding-bottom: 150px; }
        
        .preview-wrapper {
            width: 100%;
            overflow-x: auto;
            background: #cbd5e1;
            padding: 20px 0;
            display: flex;
            justify-content: center;
        }

        /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ 570px 
           (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø°ÙŠ Ù‚Ù„Øª Ø£Ù†Ù‡ Ù…Ø¶Ø¨ÙˆØ· Ø¨Ø§Ù„Ø¶Ø¨Ø·)
        */
        #invoice-box {
            width: 570px;
            min-width: 570px;
            background: #fff;
            padding: 10px;
            color: #000;
            position: relative;
            overflow: hidden;
        }
        
        /* Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ© */
        #invoice-box::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            transform: translate(-50%, -50%);
            background-image: url('https://i.ibb.co/YT4114YW/image.jpg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.05; /* Ø´ÙØ§ÙÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ */
            z-index: 0;
            pointer-events: none;
        }

        /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
        .invoice-content {
            position: relative;
            z-index: 1;
        }

        .header-title { font-size: 30px; font-weight: 900; text-align: center; margin-bottom: 5px; }
        .sub-header { font-size: 18px; font-weight: 700; text-align: center; }
        
        /* ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        th { border-bottom: 3px solid #000; padding: 8px; font-size: 18px; font-weight: 900; }
        td { border-bottom: 1px dashed #000; padding: 8px 2px; font-size: 18px; font-weight: 800; text-align: center; }
        td:first-child { text-align: right; }
        
        .total-box { 
            border: 3px solid #000; 
            padding: 15px; 
            margin-top: 20px; 
            background: #f1f5f9;
            border-radius: 8px;
        }

        /* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .fixed-btn {
            position: fixed;
            bottom: 20px; left: 10px; right: 10px;
            background: #166534; color: white;
            padding: 20px; border-radius: 15px;
            font-size: 24px; font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 2px solid #fff;
            z-index: 100;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .fixed-btn:disabled { background: #64748b; }
    </style>
</head>
<body>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="p-4 bg-white text-center shadow mb-2 relative z-10">
        <h2 class="font-bold text-gray-700 mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø±ÙŠØ¹ (80mm)</h2>
        <div class="flex gap-4 justify-center">
            <button onclick="connectUSB()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold shadow text-lg">
                ğŸ”Œ USB
            </button>
            <button onclick="connectBluetooth()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow text-lg">
                ğŸ“¡ Ø¨Ù„ÙˆØªÙˆØ«
            </button>
        </div>
        <div id="status" class="mt-2 font-bold text-red-500">ØºÙŠØ± Ù…ØªØµÙ„</div>
    </div>

    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="preview-wrapper">
        <div id="invoice-box">
            <div class="invoice-content">
                <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¹ Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
                <div class="text-center mb-4">
                    <img src="https://i.ibb.co/YT4114YW/image.jpg" alt="Ù„ÙˆØ¬Ùˆ Ø§Ù„Ø´Ø±ÙƒØ©" class="h-24 mx-auto mb-2">
                    <h1 class="header-title">Ø£Ù„Ø¨Ø§Ù† ÙˆÙ…Ø§Ø±ÙƒØª Ø§Ù„ØªÙˆÙÙŠÙ‚</h1>
                    <p class="sub-header">Ø®ÙŠØ±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© - Ù…Ù†ØªØ¬Ø§Øª Ø·Ø§Ø²Ø¬Ø©</p>
                    <div class="border-b-4 border-black my-2 w-2/3 mx-auto"></div>
                </div>
    
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
                <div class="flex justify-between text-lg font-bold mt-2 px-2">
                    <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="date"></span></span>
                    <span>#INV-9921</span>
                </div>
                <div class="text-right font-bold text-lg px-2 mt-1">
                    Ø§Ù„Ø¹Ù…ÙŠÙ„: ÙƒØ§Ø´ÙŠØ± Ø¹Ø§Ù…
                </div>
    
                <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                <table>
                    <thead>
                        <tr>
                            <th width="35%">Ø§Ù„ØµÙ†Ù</th>
                            <th width="10%">Ø¹</th>
                            <th width="20%">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                            <th width="15%">Ø®ØµÙ…</th>
                            <th width="20%">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ù„Ø¨Ù† Ø¬Ø§Ù…ÙˆØ³ÙŠ (Ùƒ)</td>
                            <td>2</td>
                            <td>35.00</td>
                            <td>0.00</td>
                            <td>70.00</td>
                        </tr>
                        <tr>
                            <td>Ø²Ø¨Ø§Ø¯ÙŠ Ø¨Ù„Ø¯ÙŠ ÙˆØ³Ø·</td>
                            <td>5</td>
                            <td>10.00</td>
                            <td>5.00</td>
                            <td>45.00</td>
                        </tr>
                        <tr>
                            <td>Ø¬Ø¨Ù† Ø±ÙˆÙ…ÙŠ Ø¨Ø·Ø§Ø±Ø®</td>
                            <td>1</td>
                            <td>70.00</td>
                            <td>0.00</td>
                            <td>70.00</td>
                        </tr>
                        <tr>
                            <td>Ø³Ù…Ù† Ø¨Ù„Ø¯ÙŠ (Ø¹Ù„Ø¨Ø©)</td>
                            <td>1</td>
                            <td>180.00</td>
                            <td>10.00</td>
                            <td>170.00</td>
                        </tr>
                    </tbody>
                </table>
    
                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                <div class="total-box">
                    <div class="flex justify-between text-xl font-bold mb-1">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span>
                        <span>365.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-gray-600">
                        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…:</span>
                        <span>-15.00</span>
                    </div>
                    <div class="border-t-2 border-black my-3 opacity-20"></div>
                    <div class="flex justify-between text-4xl font-black">
                        <span>Ø§Ù„ØµØ§ÙÙŠ:</span>
                        <span>350 Ø¬.Ù…</span>
                    </div>
                </div>
    
                <!-- Ø§Ù„ÙÙˆØªØ± -->
                <div class="text-center mt-6">
                    <p class="text-xl font-bold">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p>
                    <p class="text-sm font-bold mt-1">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</p>
                    <div class="h-16 bg-black w-full mt-3"></div>
                    <p class="text-sm mt-1">CODE: 123456789</p>
                </div>
            </div>
        </div>
    </div>

    <button id="printBtn" onclick="printTurbo()" disabled class="fixed-btn">
        ğŸš€ Ø·Ø¨Ø§Ø¹Ø© Ø³Ø±ÙŠØ¹Ø©
    </button>

    <script>
        document.getElementById('date').innerText = new Date().toLocaleDateString('ar-EG');
        
        let writer, bleCharacteristic, activeMode;

        // 1. USB Connection (Instant Speed)
        async function connectUSB() {
            if (!navigator.serial) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… USB");
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 }); // Ø³Ø±Ø¹Ø© Ø£Ø¹Ù„Ù‰ Ù„Ù„Ù€ USB
                writer = port.writable.getWriter();
                activeMode = 'USB';
                showStatus(true, 'USB âš¡');
            } catch (e) { alert(e); }
        }

        // 2. Bluetooth Connection (Optimized Speed)
        async function connectBluetooth() {
            if (!navigator.bluetooth) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ«");
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                bleCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                activeMode = 'BLE';
                showStatus(true, 'Bluetooth ğŸš€');
            } catch (e) { alert(e); }
        }

        function showStatus(connected, txt) {
            const el = document.getElementById('status');
            const btn = document.getElementById('printBtn');
            if (connected) {
                el.innerText = "Ù…ØªØµÙ„: " + txt;
                el.className = "mt-2 font-bold text-green-600";
                btn.disabled = false;
            }
        }

        // 3. Printing Logic
        async function printTurbo() {
            const btn = document.getElementById('printBtn');
            btn.disabled = true;
            btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...";

            setTimeout(async () => {
                try {
                    const el = document.getElementById('invoice-box');
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… scale: 1 Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                    const canvas = await html2canvas(el, { 
                        scale: 1,
                        useCORS: true 
                    });

                    const data = getImageData(canvas);

                    if (activeMode === 'USB') {
                        // Ø¥Ø±Ø³Ø§Ù„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„ÙŠÙˆ Ø¥Ø³ Ø¨ÙŠ
                        await writer.write(data);
                    } else if (activeMode === 'BLE') {
                        // Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¨Ù„ÙˆØªÙˆØ«
                        await sendFastChunks(data);
                    }
                    
                } catch (e) {
                    alert("Ø®Ø·Ø£: " + e);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "ğŸš€ Ø·Ø¨Ø§Ø¹Ø© Ø³Ø±ÙŠØ¹Ø©";
                }
            }, 50);
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¨Ù„ÙˆØªÙˆØ«
        async function sendFastChunks(data) {
            // Ø±ÙØ¹ Ø­Ø¬Ù… Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø© (150 Ø¨Ø§ÙŠØª Ø¢Ù…Ù† Ù„Ù…Ø¹Ø¸Ù… Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©)
            const chunkSize = 150; 
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                await bleCharacteristic.writeValue(chunk);
                // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø£Ù‚ØµÙ‰ Ø­Ø¯ (5ms)
                await new Promise(r => setTimeout(r, 5));
            }
        }

        function getImageData(c) {
            const w = c.width;
            const h = c.height;
            const ctx = c.getContext('2d');
            const imgData = ctx.getImageData(0, 0, w, h);
            
            let cmds = [0x1B, 0x40, 0x1B, 0x61, 0x01, 0x1D, 0x76, 0x30, 0x00];
            
            // Width Logic
            const xb = Math.ceil(w / 8);
            cmds.push(xb % 256, Math.floor(xb / 256));
            cmds.push(h % 256, Math.floor(h / 256));

            for (let y = 0; y < h; y++) {
                for (let x = 0; x < xb; x++) {
                    let byte = 0;
                    for (let bit = 0; bit < 8; bit++) {
                        const px = x * 8 + bit;
                        if (px < w) {
                            const i = (y * w + px) * 4;
                            // Ø¹ØªØ¨Ø© Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³ÙˆØ¯ (Ø£ÙŠ Ù„ÙˆÙ† ØºØ§Ù…Ù‚ ÙŠØ¹ØªØ¨Ø± Ø£Ø³ÙˆØ¯)
                            if ((imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3 < 200) {
                                byte |= (1 << (7 - bit));
                            }
                        }
                    }
                    cmds.push(byte);
                }
            }
            cmds.push(0x1D, 0x56, 0x42, 0x00); // Ù‚Øµ Ø§Ù„ÙˆØ±Ù‚Ø©
            return new Uint8Array(cmds);
        }
    </script>
</body>
</html>