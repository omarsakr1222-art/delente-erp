<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style id="fallback-hidden-css">
.hidden { display: none !important; }
</style>
<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- html2canvas for converting receipts to images for thermal printers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<!-- Core initialization & utilities -->
<script src="src/core/init.js" charset="UTF-8"></script>
<!-- Additional utilities -->
<script src="src/utils/helpers-extra.js" charset="UTF-8"></script>
<!-- Bluetooth printer integration -->
<script src="src/utils/bluetooth-printer.js" charset="UTF-8"></script>
<!-- Library to convert HTML to Image -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Charts: revert to Chart.js v3 for legacy look -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Leaflet for interactive maps (CDN) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<!-- Firebase SDK (compat build) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<!-- Firebase Config -->
<script>
window.FIREBASE_CONFIG={
apiKey: "AIzaSyDLmZPE9teCYf2rMXd1AwT5yq4xlRSHcSk",
authDomain: "delente-business.firebaseapp.com",
projectId: "delente-business",
storageBucket: "delente-business.appspot.com",
messagingSenderId: "646706509650",
appId: "1:646706509650:web:1eaa4b94d2990b6be9ac8b"
};
</script>
<!-- Authentication System -->
<script src="src/services/auth-service.js" charset="UTF-8"></script>
<!-- Firebase initialization + sync helpers -->
<script src="src/services/firebase-init.js" charset="UTF-8"></script>
<script src="src/services/realtime-sync.js" charset="UTF-8"></script>
<!-- UI Rendering Functions -->
<script src="src/ui/renderers.js" charset="UTF-8"></script>
<script src="src/ui/renderers-extra.js" charset="UTF-8"></script>
<!-- Features -->
<script src="src/features/promotions-notifications.js" charset="UTF-8"></script>
<script src="src/features/debts-reports.js" charset="UTF-8"></script>
<script src="src/features/reports.js" charset="UTF-8"></script>
<script src="src/features/targets-settlement.js" charset="UTF-8"></script>
<script src="src/features/targets.js" charset="UTF-8"></script>
<script>
let attempts=0;
const maxAttempts=5; 
const intervalMs=3000;
function initRealtimeRecovery(){
  if (window.__REALTIME_RECOVERY_STARTED) return;
  window.__REALTIME_RECOVERY_STARTED = true;
  const iv = setInterval(()=>{
    attempts++;
    try {
      const salesOk = Array.isArray(state.sales) && state.sales.length > 0;
      const customersOk = Array.isArray(state.customers) && state.customers.length > 0;
      const productsOk = Array.isArray(state.products) && state.products.length > 0;
      if (salesOk || (customersOk && productsOk)) {
        clearInterval(iv);
        return;
      }
      console.warn('Realtime recovery attempt', attempts, '— إعادة تشغيل setupRealtimeListeners');
      setupRealtimeListeners();
      try { preloadCachedCollections(); ensureCachedDataRendered(); } catch(e){}
    } catch(e){ console.warn('initRealtimeRecovery loop error', e); }
    if (attempts >= maxAttempts) {
      clearInterval(iv);
      console.warn('Realtime recovery stopped بعد بلوغ الحد الأقصى للمحاولات');
    }
  }, intervalMs);
}
function serverTs(){
try { return firebase.firestore.FieldValue.serverTimestamp(); } catch(e){ return new Date(); }
}

async function addProduct(data){
const obj={
name: data.name || '',
sku: data.sku || data.id || Date.now().toString(),
price: Number(data.price||0),
vat_rate: Number(data.vat_rate||0),
cost: Number(data.cost||0),
unit: data.unit || 'وحدة',
active: data.active !==false,
createdAt: serverTs(),
updatedAt: serverTs()
};
return db.collection('products').add(obj);
}
async function updateProduct(id, partial){
const patched=Object.assign({}, partial);
if (patched.vat_rate !==undefined) patched.vat_rate=Number(patched.vat_rate) || 0;
return db.collection('products').doc(id).set({ ...patched, updatedAt: serverTs() }, { merge:true });
}
async function deleteProduct(id){ return db.collection('products').doc(id).delete(); }
async function addCustomer(data){
const obj={
name: data.name || '',
phone: data.phone || '',
taxNumber: data.taxNumber || '',
address: data.address || '',
repName: data.repName || '',
requiresTaxFiling: !!data.requiresTaxFiling,
priceListId: data.priceListId || '',
balance: Number(data.balance||0),
assignedRepId: (function(){
try {
if (data.assignedRepId) return data.assignedRepId;
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='rep' && window.auth && auth.currentUser) return auth.currentUser.uid;
if (data.repName) {
const r=window.findRep ? window.findRep(data.repName) : null;
return r ? r.id : '';
}
} catch(e){}
return '';
})(),
createdAt: serverTs(),
updatedAt: serverTs()
};
try {
if (!window.state) window.state={};
if (!Array.isArray(window.state.customers)) window.state.customers=[];
const localId=obj.id || obj._id || (Date.now()+''+Math.random().toString(16).slice(2));
const localObj=Object.assign({}, obj, { _id: localId });
window.state.customers.push(localObj);
try { localStorage.setItem('customers', JSON.stringify(window.state.customers)); } catch(_){ }
} catch(e){ }
return db.collection('customers').add(obj);
}
async function updateCustomer(id, partial){
const obj={ ...partial };
try {
if (!obj.assignedRepId && obj.repName) {
const r=window.findRep ? window.findRep(obj.repName) : null;
if (r) obj.assignedRepId=r.id;
}
} catch(e){}
return db.collection('customers').doc(id).set({ ...obj, updatedAt: serverTs() }, { merge:true });
}
async function deleteCustomer(id){ return db.collection('customers').doc(id).delete(); }
async function addPriceListDoc(id, data){
const ref=id ? db.collection('priceLists').doc(String(id)) : db.collection('priceLists').doc();
const obj={
id: id || ref.id,
name: data.name || '',
productPrices: data.productPrices || {},
createdAt: serverTs(),
updatedAt: serverTs()
};
await ref.set(obj, { merge:false });
return ref;
}
async function updatePriceListDoc(id, partial){
return db.collection('priceLists').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
}
async function deletePriceListDoc(id){ return db.collection('priceLists').doc(String(id)).delete(); }
async function addRepDoc(id, data){
const ref=id ? db.collection('reps').doc(String(id)) : db.collection('reps').doc();
const obj={
id: id || ref.id,
name: data.name || '',
serial: data.serial || '',
target: Number(data.target||0),
nextInvoiceNumber: data.nextInvoiceNumber || null,
createdAt: serverTs(),
updatedAt: serverTs()
};
await ref.set(obj, { merge:false });
return ref;
}
async function updateRepDoc(id, partial){
return db.collection('reps').doc(String(id)).set({ ...partial, updatedAt: serverTs() }, { merge:true });
}
async function deleteRepDoc(id){ return db.collection('reps').doc(String(id)).delete(); }
function canManageCustomer(c){
try {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='admin') return true;
if (role==='rep') {
if (!c) return false;
const assigned=c.assignedRepId || '';
if (!assigned) return true; 
const current=AuthSystem.getCurrentUser();
if (current && current.id===assigned) return true;
return false;
}
return true;
} catch(e){ return true; }
}
async function addSale(data){
const obj={
id: data.id || undefined,
invoiceNumber: data.invoiceNumber || null,
customerId: data.customerId || null,
repName: data.repName || data.repId || '',
items: Array.isArray(data.items) ? data.items : [],
subtotal: Number(data.subtotal) || 0,
taxAmount: (data.taxAmount !==undefined) ? Number(data.taxAmount) : (data.vatAmount !==undefined ? Number(data.vatAmount) : 0),
withholdingAmount: (data.withholdingAmount !==undefined) ? Number(data.withholdingAmount) : 0,
total: Number(data.total) || 0,
paidAmount: Number(data.paidAmount||0),
status: data.status || 'due',
discountPercent: Number(data.discountPercent||0),
taxFilingStatus: data.taxFilingStatus || '',
date: data.date || new Date().toISOString(),
repEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
repId: data.repId || null,
createdBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null,
createdByEmail: (window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null,
isAdminEntry: data.isAdminEntry===true,
recordedByName: data.recordedByName || null,
originalCreatorId: data.originalCreatorId || null,
adminEntry: data.adminEntry===true,
adminEnteredBy: data.adminEnteredBy || null,
created_by_admin: (data.created_by_admin===true) || (data.adminEntry===true) || (data.isAdminEntry===true),
entry_source: (data.entry_source) ? data.entry_source : (data.adminEntry===true || data.isAdminEntry===true ? 'admin' : (data.entry_source || null)),
createdAt: serverTs(),
updatedAt: serverTs(),
updatedBy: (window.auth && auth.currentUser) ? auth.currentUser.uid : null
};
try {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='sales' || role==='rep') obj.reviewStatus='pending';
else obj.reviewStatus='reviewed';
} catch(_) { obj.reviewStatus='pending'; }
try {
let anyAdjusted=false;
obj.items=Array.isArray(obj.items) ? obj.items : [];
obj.items=obj.items.map(it=> {
try {
const item=Object.assign({}, it);
const prod=findProduct(item.productId) || {};
item.vat_rate=(item.vat_rate !==undefined && item.vat_rate !==null) ? Number(item.vat_rate) : (prod && prod.vat_rate ? Number(prod.vat_rate) : 0);
return item;
} catch(e){ return it; }
});
obj.items=obj.items.map(it=> {
try {
const item=Object.assign({}, it);
const prod=findProduct(item.productId) || {};
let expectedPrice=(prod.price !=null) ? Number(prod.price) : 0;
try {
const customer=findCustomer(obj.customerId);
if (customer && customer.priceListId) {
const pl=findPriceList(customer.priceListId);
if (pl && pl.productPrices && pl.productPrices[item.productId] !==undefined) expectedPrice=Number(pl.productPrices[item.productId]);
}
} catch(_){ }
try {
const promo=getActivePromotionPrice(item.productId, obj.customerId);
if (promo !==null && promo !==undefined) expectedPrice=Number(promo);
} catch(_){ }
const entered=Number(item.price) || 0;
const diff=Math.abs(entered - (Number(expectedPrice) || 0));
if (diff > 0.005) {
item.adjusted=true;
anyAdjusted=true;
} else {
item.adjusted=item.adjusted===true;
}
item.expectedPrice=expectedPrice;
return item;
} catch(e){ return it; }
});
if (anyAdjusted) {
obj.reviewReason='adjusted';
obj.reviewStatus='pending';
try { obj.reviewRequestedBy=(auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : null; } catch(_){ }
obj.reviewRequestedAt=new Date().toISOString();
console.log('addSale: detected adjusted prices, marking reviewReason=adjusted', { id: obj.id, invoiceNumber: obj.invoiceNumber });
}
} catch(e){ console.warn('addSale: adjusted-detection failed', e); }
const ref=data && data.id
? db.collection('sales').doc(String(data.id))
: db.collection('sales').doc();
if (!data.id) obj.id=ref.id;
try {
console.log('addSale: writing doc', obj.id, 'invoice:', obj.invoiceNumber);
await ref.set(obj, { merge: false });
console.log('addSale: write success', obj.id);
} catch (e) {
console.warn('addSale: write failed', e);
const msg=(e && e.message) ? String(e.message).toLowerCase() : '';
const code=e && e.code ? e.code : null;
const isPerm=(code==='permission-denied' || (typeof code==='string' && code.toLowerCase().includes('permission'))) || msg.includes('permission') || msg.includes('insufficient');
if (isPerm) {
try {
const invoicesRef=db.collection('invoices').doc(obj.id);
await invoicesRef.set(obj, { merge: false });
console.log('addSale: fallback write success to invoices/', obj.id);
ref=invoicesRef;
} catch (e2) {
console.warn('addSale: fallback to invoices failed', e2);
if (obj.repId) {
try {
const userInvRef=db.collection('users').doc(String(obj.repId)).collection('invoices').doc(obj.id);
await userInvRef.set(obj, { merge: false });
console.log('addSale: fallback write success to users/{repId}/invoices/', obj.id);
ref=userInvRef;
} catch (e3) {
console.warn('addSale: fallback to users/{repId}/invoices failed', e3);
throw e;
}
} else {
throw e;
}
}
} else {
throw e;
}
}
try { upsertCachedSale(Object.assign({}, obj, { _id: obj.id })); } catch(e){}
try {
if (!window.state) window.state={};
if (!Array.isArray(state.sales)) state.sales=[];
const exists=state.sales.some(s=> (s.id||s._id)===obj.id);
if (!exists) state.sales.unshift(Object.assign({}, obj));
const textFilter=document.getElementById('search-sales-text')?.value || '';
const dateFilter=document.getElementById('search-sales-date')?.value || '';
const taxStatusFilter=document.getElementById('tax-status-filter')?.value || 'all';
if (typeof renderAllSales==='function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
if (typeof renderDashboard==='function') renderDashboard();
} catch(e){}
return ref;
}
async function addDispatchNote(data){
const base={
noteNumber: data.noteNumber || null,
repName: data.repName || '',
date: data.date || new Date().toISOString(),
items: Array.isArray(data.items) ? data.items : [],
createdAt: serverTs(),
updatedAt: serverTs(),
createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null,
createdByEmail: (auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null
};
const ref=data && data.id ? db.collection('dispatchNotes').doc(String(data.id)) : db.collection('dispatchNotes').doc();
if (!data.id) base.id=ref.id; else base.id=data.id;
await ref.set(base, { merge:false });
try {
if (!state.dispatchNotes) state.dispatchNotes=[];
const exists=state.dispatchNotes.some(n=> (n.id||n._id)===base.id);
if (!exists) state.dispatchNotes.unshift(Object.assign({}, base));
if (typeof renderDispatchPage==='function') renderDispatchPage();
} catch(e){}
return ref;
}
async function updateDispatchNote(id, partial){
const meta={ updatedAt: serverTs() };
await db.collection('dispatchNotes').doc(id).set({ ...partial, ...meta }, { merge:true });
try {
if (Array.isArray(state.dispatchNotes)){
const i=state.dispatchNotes.findIndex(n=> (n.id||n._id)===id);
if (i>=0) state.dispatchNotes[i]=Object.assign({}, state.dispatchNotes[i], partial, { id });
if (typeof renderDispatchPage==='function') renderDispatchPage();
}
} catch(e){}
}
async function deleteDispatchNote(id){
await db.collection('dispatchNotes').doc(id).delete();
try {
if (needAfterAllPL && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025) && window.EMBEDDED_PRICE_LISTS_BACKUP_2025.length){
try {
const res=await importBackupObject({ priceLists: window.EMBEDDED_PRICE_LISTS_BACKUP_2025 }, {
importCustomers:false, importProducts:false, importPriceLists:true,
importSales:false, importReps:false, importPromotions:false,
importSettings:false, importDispatchNotes:false, importStockEntries:false, importNotifications:false
});
if (res && res.ok && res.counts && res.counts.priceLists > 0){
console.log('✅ تم استيراد قوائم الأسعار من النسخة المدمجة:', res.counts.priceLists);
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
try { updateAllPriceListDropdowns(); } catch(e){}
}
} catch(e){ console.warn('فشل استيراد القوائم من النسخة المدمجة', e); }
needAfterAllPL=!state.priceLists || state.priceLists.length===0;
}
if (needAfterAllPL) {
try {
const imported=await importPriceListsFromLegacyHtmlFile('1458.html');
if (imported > 0) {
console.log('✅ تم استيراد قوائم الأسعار من 1458.html:', imported);
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
try { updateAllPriceListDropdowns(); } catch(e){}
} else {
console.log('لم يتم العثور على قوائم أسعار داخل 1458.html؛ يمكنك استدعاء window.importPriceListsFromLocalFile() لاختيار ملف يدويًا');
}
} catch(e){ console.warn('فشل استيراد قوائم الأسعار من 1458.html', e); }
}
} catch(e){ console.warn('ensureCoreData local backup phase error', e); }
}
async function ensureCoreData(){
let needAfterAllPL=!state.priceLists || state.priceLists.length===0;
try {
if (needAfterAllPL && Array.isArray(window.EMBEDDED_PRICE_LISTS_BACKUP_2025) && window.EMBEDDED_PRICE_LISTS_BACKUP_2025.length){
try {
const res=await importBackupObject({ priceLists: window.EMBEDDED_PRICE_LISTS_BACKUP_2025 }, {
importCustomers:false, importProducts:false, importPriceLists:true,
importSales:false, importReps:false, importPromotions:false,
importSettings:false, importDispatchNotes:false, importStockEntries:false, importNotifications:false
});
if (res && res.ok && res.counts && res.counts.priceLists > 0){
console.log('✅ تم استيراد قوائم الأسعار من النسخة المدمجة:', res.counts.priceLists);
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
try { updateAllPriceListDropdowns(); } catch(e){}
}
} catch(e){ console.warn('فشل استيراد القوائم من النسخة المدمجة', e); }
needAfterAllPL=!state.priceLists || state.priceLists.length===0;
}
if (needAfterAllPL) {
try {
const imported=await importPriceListsFromLegacyHtmlFile('1458.html');
if (imported > 0) {
console.log('✅ تم استيراد قوائم الأسعار من 1458.html:', imported);
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
try { updateAllPriceListDropdowns(); } catch(e){}
} else {
console.log('لم يتم العثور على قوائم أسعار داخل 1458.html؛ يمكنك استدعاء window.importPriceListsFromLocalFile() لاختيار ملف يدويًا');
}
} catch(e){ console.warn('فشل استيراد قوائم الأسعار من 1458.html', e); }
}
} catch(e){ console.warn('ensureCoreData local backup phase error', e); }
if (state.customers && state.customers.length && state.priceLists && state.priceLists.length && state.products && state.products.length && state.reps && state.reps.length) window.__coreDataEnsured=true;
}
function scheduleEnsureCoreData(){
setTimeout(ensureCoreData, 1500);
setTimeout(function(){ try { migrateSalesFromUserDocIfFound(); } catch(e){} }, 3000);
setTimeout(function(){ try { if (typeof window.loadCashFromCloud==='function') window.loadCashFromCloud(); } catch(e){ console.warn('loadCashFromCloud on startup failed', e); } }, 2500);
setTimeout(ensureCoreData, 5000);
setTimeout(ensureCoreData, 12000);
}
function slugId(name, fallback){
try { return (name||'').toString().trim().toLowerCase().replace(/[^a-z0-9\u0600-\u06FF]+/gi,'_').replace(/^_+|_+$/g,'') || fallback || (Date.now()+'');} catch(e){ return fallback || (Date.now()+''); }
}
function recoverLegacyLocalData(){
const possibleProductKeys=[ 'products','product_list','app_products','products_data','finished_products','cost_finished' ];
const possiblePriceListKeys=[ 'priceLists','price_lists','app_priceLists','priceListsData','price_lists_data','pricing_tables' ];
const possibleCustomerKeys=[ 'customers','customer_list','app_customers','customers_data' ];
const products=[];
const priceLists=[];
const customers=[];
function tryParse(key){
try { const raw=localStorage.getItem(key); if (!raw) return null; return JSON.parse(raw); } catch(e){ return null; }
}
possibleProductKeys.forEach(k=> {
const val=tryParse(k); if (!val) return;
if (Array.isArray(val)) { val.forEach(p=> { if (p && (p.name||p.title)) products.push(p); }); }
else if (typeof val==='object') { Object.keys(val).forEach(id=> { const p=val[id]; if (p && (p.name||p.title)) products.push(Object.assign({ id }, p)); }); }
});
possiblePriceListKeys.forEach(k=> {
const val=tryParse(k); if (!val) return;
if (Array.isArray(val)) { val.forEach(pl=> { if (pl && (pl.name||pl.title)) priceLists.push(pl); }); }
else if (typeof val==='object') {
const looksMap=Object.values(val).every(v=> typeof v==='number');
if (looksMap) priceLists.push({ name: 'Legacy List', productPrices: val });
else Object.keys(val).forEach(id=> { const pl=val[id]; if (pl && (pl.name||pl.title)) priceLists.push(Object.assign({ id }, pl)); else if (pl && typeof pl==='object' && Object.values(pl).every(v=>typeof v==='number')) priceLists.push({ id, name:id, productPrices: pl }); });
}
});
possibleCustomerKeys.forEach(k=> {
const val=tryParse(k); if (!val) return;
if (Array.isArray(val)) { val.forEach(c=> { if (c && c.name) customers.push(c); }); }
else if (typeof val==='object') { Object.keys(val).forEach(id=> { const c=val[id]; if (c && c.name) customers.push(Object.assign({ id }, c)); }); }
});
console.log('recoverLegacyLocalData: products=', products.length, 'priceLists=', priceLists.length, 'customers=', customers.length);
return { products, priceLists, customers };
}
function normalizePriceListsArray(arr){
try {
if (!Array.isArray(arr)) return [];
return arr.map(pl=> ({
id: pl.id || pl.code || slugId(pl.name, undefined),
name: pl.name || pl.title || 'قائمة أسعار',
productPrices: pl.productPrices || pl.prices || pl.map || {}
})).filter(pl=> pl && pl.name && pl.productPrices && typeof pl.productPrices==='object');
} catch(e){ return []; }
}
function tryParseJsonLoose(text){
try { return JSON.parse(text); } catch(e) {}
try { return JSON.parse(text.replace(/\,\s*}/g,'}').replace(/\,\s*]/g,']')); } catch(e) {}
try {
const t=text.replace(/"/g,'\"').replace(/'([^']*)'/g,'"$1"');
return JSON.parse(t);
} catch(e) { return null; }
}
window.EMBEDDED_PRICE_LISTS_BACKUP_2025=[];
window.EMBEDDED_FULL_BACKUP={ customers:[], products:[], priceLists:[], reps:[], promotions:[], sales:[] };
async function importEmbeddedBackupIfNeeded(){ return { ok:true, disabled:true }; }
async function importBackupObject(backup, options){
const opts=Object.assign({
importCustomers: true,
importProducts: true,
importPriceLists: true,
importSales: true,
importReps: true,
importPromotions: true,
importSettings: true,
importDispatchNotes: true,
importStockEntries: true,
importNotifications: true
}, options||{});
if (!db) { console.warn('Firestore غير جاهز'); return { ok:false, reason:'no-db' }; }
const counts={ customers:0, products:0, priceLists:0, sales:0, reps:0, promotions:0, settings:0, dispatchNotes:0, stockEntries:0, notifications:0 };
let batch=db.batch();
let pending=0;
async function commitIfNeeded(force){ if (force || pending >=450) { await batch.commit(); batch=db.batch(); pending=0; } }
try {
if (opts.importCustomers && Array.isArray(backup.customers)){
for (const c of backup.customers){
const id=c.id || slugId(c.name);
const ref=db.collection('customers').doc(id);
batch.set(ref, {
name: c.name || '',
phone: c.phone || '',
taxNumber: c.taxNumber || '',
requiresTaxFiling: !!c.requiresTaxFiling,
priceListId: c.priceListId || '',
repName: c.repName || '',
address: c.address || '',
createdAt: c.createdAt || serverTs(),
updatedAt: serverTs()
}, { merge:true });
counts.customers++; pending++; await commitIfNeeded(false);
}
}
if (opts.importProducts && Array.isArray(backup.products)){
for (const p of backup.products){
const id=(p.id || slugId(p.name)).toString();
const ref=db.collection('products').doc(id);
batch.set(ref, {
name: p.name || '',
sku: p.sku || id,
price: Number(p.price||0),
cost: Number(p.cost||0),
unit: p.unit || 'وحدة',
active: p.active !==false,
createdAt: p.createdAt || serverTs(),
updatedAt: serverTs()
}, { merge:true });
counts.products++; pending++; await commitIfNeeded(false);
}
}
if (opts.importPriceLists && Array.isArray(backup.priceLists)){
for (const pl of backup.priceLists){
const id=pl.id || slugId(pl.name);
const ref=db.collection('priceLists').doc(id);
batch.set(ref, {
name: pl.name || id,
productPrices: pl.productPrices || pl.prices || {},
createdAt: pl.createdAt || serverTs(),
updatedAt: serverTs()
}, { merge:true });
counts.priceLists++; pending++; await commitIfNeeded(false);
}
}
if (opts.importReps && Array.isArray(backup.reps)){
for (const r of backup.reps){
const id=r.id || slugId(r.name);
const ref=db.collection('reps').doc(id);
batch.set(ref, {
name: r.name || '',
serial: r.serial || '',
target: Number(r.target||0),
nextInvoiceNumber: (r.nextInvoiceNumber==null? null : r.nextInvoiceNumber),
createdAt: r.createdAt || serverTs(),
updatedAt: serverTs()
}, { merge:true });
counts.reps++; pending++; await commitIfNeeded(false);
}
}
if (opts.importSales && Array.isArray(backup.sales)){
for (const s of backup.sales){
const sid=(s.id || '').toString() || undefined;
const ref=sid ? db.collection('sales').doc(sid) : db.collection('sales').doc();
const items=Array.isArray(s.items) ? s.items.map(it=> ({
productId: it.productId || it.code || '',
qty: Number(it.qty!=null ? it.qty : (it.quantity||0)),
price: Number(it.price||0)
})) : [];
batch.set(ref, {
invoiceNumber: s.invoiceNumber || null,
customerId: s.customerId || null,
repName: s.repName || s.repId || '',
items,
total: Number(s.total||0),
paidAmount: Number(s.paidAmount||0),
status: s.status || 'due',
discountPercent: Number(s.discountPercent||s.discount||0),
taxFilingStatus: s.taxFilingStatus || '',
date: s.date || new Date().toISOString(),
notes: s.notes || '',
includeInCash: !!s.includeInCash,
collectionReportCreated: !!s.collectionReportCreated,
paidToSafe: !!s.paidToSafe,
firstPayment: s.firstPayment!=null ? Number(s.firstPayment) : undefined,
secondPayment: s.secondPayment!=null ? Number(s.secondPayment) : undefined,
collectionDiscount: s.collectionDiscount!=null ? Number(s.collectionDiscount) : undefined,
collectionNumber: s.collectionNumber!=null ? s.collectionNumber : undefined,
createdAt: s.createdAt || serverTs(),
updatedAt: serverTs()
}, { merge:true });
counts.sales++; pending++; await commitIfNeeded(false);
}
}
if (opts.importPromotions && Array.isArray(backup.promotions)){
for (const pr of backup.promotions){
const id=pr.id || slugId(pr.name);
const ref=db.collection('promotions').doc(id);
batch.set(ref, Object.assign({}, pr, { updatedAt: serverTs() }), { merge:true });
counts.promotions++; pending++; await commitIfNeeded(false);
}
}
if (opts.importSettings && backup.settings){
const sid=backup.settings.id || 'global-settings';
const ref=db.collection('settings').doc(sid);
batch.set(ref, Object.assign({}, backup.settings, { updatedAt: serverTs() }), { merge:true });
counts.settings++; pending++; await commitIfNeeded(false);
}
if (opts.importDispatchNotes && Array.isArray(backup.dispatchNotes)){
for (const dn of backup.dispatchNotes){
const did=(dn.id || '').toString() || undefined;
const ref=did ? db.collection('dispatchNotes').doc(did) : db.collection('dispatchNotes').doc();
batch.set(ref, Object.assign({}, dn, { updatedAt: serverTs() }), { merge:true });
counts.dispatchNotes++; pending++; await commitIfNeeded(false);
}
}
if (opts.importStockEntries && backup.stockEntries && typeof backup.stockEntries==='object'){
for (const d of Object.keys(backup.stockEntries)){
const ref=db.collection('stockEntries').doc(d);
batch.set(ref, { date: d, entries: backup.stockEntries[d], updatedAt: serverTs() }, { merge:true });
counts.stockEntries++; pending++; await commitIfNeeded(false);
}
}
if (opts.importNotifications && Array.isArray(backup.notifications)){
for (const n of backup.notifications){
const idn=n.id || (Date.now()+Math.random()).toString(36);
const ref=db.collection('notifications').doc(idn);
batch.set(ref, Object.assign({}, n), { merge:true });
counts.notifications++; pending++; await commitIfNeeded(false);
}
}
await commitIfNeeded(true);
} catch(e){ console.warn('importBackupObject error', e); return { ok:false, error:e, counts }; }
try { if (typeof renderCustomerList==='function') renderCustomerList(''); } catch(e){}
try { if (typeof renderProductList==='function') renderProductList(''); } catch(e){}
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
try { updateAllPriceListDropdowns(); } catch(e){}
try { if (typeof renderReps==='function') renderReps(); } catch(e){}
return { ok:true, counts };
}
function parseBackupText(text){
try { return JSON.parse(text); } catch(e){
try { return tryParseJsonLoose(text); } catch(e2){ return null; }
}
}
window.importBackupJson=async function(input, options){
try {
const backup=(typeof input==='string') ? parseBackupText(input) : input;
if (!backup || typeof backup !=='object') { alert('تعذر قراءة النسخة الاحتياطية'); return false; }
const res=await importBackupObject(backup, options);
if (res && res.ok) { alert('تم الاستيراد بنجاح'); return true; }
alert('فشل الاستيراد'); return false;
} catch(e){ console.warn('importBackupJson failed', e); alert('حدث خطأ أثناء الاستيراد'); return false; }
};
window.importBackupFromLocalFile=function(){
try {
const input=document.createElement('input');
input.type='file'; input.accept='.json,.txt,.html';
input.onchange=async function(){
const f=this.files && this.files[0]; if (!f) return;
const reader=new FileReader();
reader.onload=async function(){
const txt=reader.result;
const ok=await window.importBackupJson(txt);
if (ok) console.log('Backup imported successfully');
};
reader.readAsText(f, 'utf-8');
};
input.click();
} catch(e){ console.warn('importBackupFromLocalFile failed', e); }
};
async function importFromSharedAppState(options){
const opts=Object.assign({ force: true, cleanupDefaults: true }, options||{});
if (!db) { console.warn('Firestore غير جاهز'); return false; }
const doc=await db.collection('shared').doc('public_app_state').get().catch(()=>null);
if (!doc || !doc.exists) { console.log('shared/public_app_state غير موجود'); return false; }
const data=doc.data() || {}; const as=data.appState || {};
const custArr=Array.isArray(as.customers) ? as.customers : [];
const plArr=Array.isArray(as.priceLists) ? as.priceLists : [];
const repsArr=Array.isArray(as.reps) ? as.reps : [];
if (custArr.length===0 && plArr.length===0 && repsArr.length===0) { console.log('لا يوجد customers/priceLists/reps داخل appState'); return false; }
const [currCustSnap, currPlSnap, currRepsSnap]=await Promise.all([
db.collection('customers').get(), db.collection('priceLists').get(), db.collection('reps').get()
]);
const existingCustIds=new Set(currCustSnap.docs.map(d=>d.id));
const existingPlIds=new Set(currPlSnap.docs.map(d=>d.id));
const existingRepIds=new Set(currRepsSnap.docs.map(d=>d.id));
const batch=db.batch();
const targetCustIds=new Set();
const targetPlIds=new Set();
const targetRepIds=new Set();
custArr.forEach(c=> {
const id=c.id || c._id || slugId(c.name, undefined);
if (!id) return;
targetCustIds.add(id);
batch.set(db.collection('customers').doc(id), {
name: c.name || '',
phone: c.phone || '',
taxNumber: c.taxNumber || '',
requiresTaxFiling: !!c.requiresTaxFiling,
priceListId: c.priceListId || '',
balance: Number(c.balance||0),
createdAt: serverTs(),
updatedAt: serverTs()
}, { merge: true });
});
plArr.forEach(pl=> {
const id=pl.id || slugId(pl.name, undefined);
if (!id) return;
targetPlIds.add(id);
batch.set(db.collection('priceLists').doc(id), {
name: pl.name || 'قائمة',
productPrices: pl.productPrices || {},
createdAt: serverTs(),
updatedAt: serverTs()
}, { merge: true });
});
repsArr.forEach(r=> {
const id=r.id || slugId(r.name, undefined);
if (!id) return;
targetRepIds.add(id);
batch.set(db.collection('reps').doc(id), {
name: r.name || '',
serial: r.serial || r.code || '',
target: Number(r.target||0),
nextInvoice: Number(r.nextInvoice||r.next_invoice||0),
active: r.active !==false,
createdAt: serverTs(),
updatedAt: serverTs()
}, { merge: true });
});
if (opts.cleanupDefaults) {
const defaultCustIds=['CUST001','CUST002','CUST003'];
defaultCustIds.forEach(id=> { if (existingCustIds.has(id) && !targetCustIds.has(id)) batch.delete(db.collection('customers').doc(id)); });
const defaultPlIds=['retail','wholesale'];
defaultPlIds.forEach(id=> { if (existingPlIds.has(id) && !targetPlIds.has(id)) batch.delete(db.collection('priceLists').doc(id)); });
['REP1','REP2','REP3'].forEach(id=> { if (existingRepIds.has(id) && !targetRepIds.has(id)) batch.delete(db.collection('reps').doc(id)); });
}
await batch.commit();
state.customers=custArr.map(c=> ({...c, _id: c.id || c._id || slugId(c.name)}));
state.priceLists=plArr.map(pl=> ({...pl, id: pl.id || slugId(pl.name)}));
state.reps=repsArr.map(r=> ({...r, id: r.id || slugId(r.name)}));
try { if (typeof renderCustomerList==='function') renderCustomerList(''); } catch(e){}
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
try { updateAllPriceListDropdowns(); } catch(e){}
try { if (typeof renderReps==='function') renderReps(); } catch(e){}
console.log('استيراد appState -> المجموعات اكتمل');
return true;
}
window.importFromSharedAppState=importFromSharedAppState;
async function migrateLegacyCollections(){
if (!db) { console.warn('Firestore غير جاهز'); return; }
const role=getUserRole();
if (role !=='admin') { alert('هذه العملية للمشرف فقط'); return; }
console.log('بدء هجرة البيانات القديمة إلى المجموعات القياسية');
const legacySets=[
{ src: 'Customers', dest: 'customers', map: d=> ({
name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
priceListId: d.priceListId || d.pricelist || d.price_list_id || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
})},
{ src: 'customers_old', dest: 'customers', map: d=> ({
name: d.name||'', phone: d.phone||'', taxNumber: d.taxNumber||'', requiresTaxFiling: !!d.requiresTaxFiling,
priceListId: d.priceListId || '', balance: Number(d.balance||0), createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
})},
{ src: 'PriceLists', dest: 'priceLists', map: d=> ({
name: d.name||d.title||'قائمة', productPrices: d.productPrices || d.prices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
})},
{ src: 'price_lists', dest: 'priceLists', map: d=> ({
name: d.name||'قائمة', productPrices: d.productPrices || {}, createdAt: d.createdAt || serverTs(), updatedAt: serverTs()
})}
];
let migratedCustomers=0, migratedPriceLists=0;
for (const set of legacySets) {
try {
const snap=await db.collection(set.src).get();
if (snap.empty) continue;
for (const doc of snap.docs) {
const data=doc.data() || {};
const destRef=db.collection(set.dest).doc(doc.id);
const exists=await destRef.get();
if (exists.exists) continue; 
await destRef.set(set.map(data), { merge: true });
if (set.dest==='customers') migratedCustomers++; else if (set.dest==='priceLists') migratedPriceLists++;
}
} catch(e){ console.warn('فشل قراءة المجموعة القديمة', set.src, e); }
}
console.log(`انتهت الهجرة: عملاء +=${migratedCustomers}, قوائم أسعار +=${migratedPriceLists}`);
alert(`انتهت الهجرة بنجاح\nعملاء تمت إضافتهم: ${migratedCustomers}\nقوائم أسعار تمت إضافتها: ${migratedPriceLists}`);
try { if (typeof renderCustomerList==='function') renderCustomerList(''); } catch(e){}
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
}
window.migrateLegacyCollections=migrateLegacyCollections; 
function setPresenceOnline(){
try {
if (!db || !auth || !auth.currentUser) return;
try { if (isReadOnly()) return; } catch(_){ }
const u=auth.currentUser;
db.collection('presence').doc(u.uid).set({
uid: u.uid,
email: (u.email||'').toLowerCase(),
online: true,
lastActive: serverTs()
}, { merge: true }).catch(e=>console.warn('presence set error', e));
} catch(e){ console.warn('setPresenceOnline failed', e); }
}
function setPresenceOffline(){
try {
if (!db || !auth || !auth.currentUser) return;
try { if (isReadOnly()) return; } catch(_){ }
const u=auth.currentUser;
db.collection('presence').doc(u.uid).set({
online: false,
lastActive: serverTs()
}, { merge: true }).catch(e=>console.warn('presence unset error', e));
} catch(e){ console.warn('setPresenceOffline failed', e); }
}
window.addEventListener('beforeunload', function(){ try { setPresenceOffline(); } catch(e){} });

function lsGet(key) {
try {
if (window.CLOUD_ONLY) return null;
return localStorage.getItem(key);
} catch (e) { return null; }
}
function lsSet(key, value) {
try {
if (window.CLOUD_ONLY) {
console.debug('CLOUD_ONLY: suppressed localStorage.setItem', key);
return;
}
localStorage.setItem(key, value);
} catch (e) { }
}
function lsRemove(key) {
try {
if (window.CLOUD_ONLY) {
console.debug('CLOUD_ONLY: suppressed localStorage.removeItem', key);
return;
}
localStorage.removeItem(key);
} catch (e) { }
}
document.addEventListener('DOMContentLoaded', function () {
// Load grid states from localStorage
try { window._rawGridState=JSON.parse(localStorage.getItem('raw_materials_grid') || '{}'); } catch (e) { window._rawGridState={}; }
try { window._packGridState=JSON.parse(localStorage.getItem('packaging_grid') || '{}'); } catch (e) { window._packGridState={}; }
try { window._finishedGridState=JSON.parse(localStorage.getItem('finished_products_grid') || '{}'); } catch (e) { window._finishedGridState={}; }
try { if (!window.state) window.state={}; window.state.stockEntries=JSON.parse(localStorage.getItem('stock_entries') || '{}'); } catch (e) { if (!window.state) window.state={}; window.state.stockEntries={}; }

// ✅ All demo data and state loading now happens BEFORE DOMContentLoaded
// State should already be populated from lines 881-900

console.log('🎯 DOMContentLoaded: State already loaded with', window.state.customers?.length || 0, 'customers');


try {
  const s = window.state || {};
  console.log('📦 Loaded core data from localStorage:', {
    customers: (s.customers || []).length,
    products: (s.products || []).length,
    sales: (s.sales || []).length,
    reps: (s.reps || []).length,
    promotions: (s.promotions || []).length
  });
} catch (_) { console.log('📦 Loaded core data from localStorage: (log skipped)'); }

console.log('Loaded State:', window._rawGridState);
console.log('Loaded Packaging State:', window._packGridState);
console.log('Loaded Finished State:', window._finishedGridState);
console.log('Loaded Stock Entries:', window.state.stockEntries);
if (!window._gridHelpersInstalled) {
window._gridHelpersInstalled=true;
window._rawGridSaveTimer=null;
window._packGridSaveTimer=null;
window._finishedGridSaveTimer=null;
window.isUpdatingFromCloud=false;
window._lastSavedCostListsJson='';
(function(){
try {
var ind=document.getElementById('cloud-save-indicator');
if (!ind) {
ind=document.createElement('div');
ind.id='cloud-save-indicator';
ind.style.position='fixed';
ind.style.bottom='12px';
ind.style.left='12px';
ind.style.background='rgba(0,0,0,0.75)';
ind.style.color='#fff';
ind.style.padding='6px 10px';
ind.style.borderRadius='6px';
ind.style.zIndex=99999;
ind.style.fontFamily='Cairo, sans-serif';
ind.style.display='none';
ind.textContent='جاري الحفظ...';
document.body.appendChild(ind);
}
window._toggleSaveIndicator=function(on){ try { ind.style.display=on ? 'block' : 'none'; } catch(e){} };
} catch(e){ window._toggleSaveIndicator=function(){}; }
})();
function sanitizeForSave(obj){
try {
if (obj==null) return obj;
if (Array.isArray(obj)) return obj.map(sanitizeForSave);
if (typeof obj==='object'){
var out={};
for (var k in obj){
if (!Object.prototype.hasOwnProperty.call(obj,k)) continue;
if (k && k.charAt(0)==='_' ) continue; 
if (k==='ui' || k==='editing') continue;
var v=obj[k];
if (typeof v==='string'){
var n=v.trim();
if (/^-?\d+(?:\.\d+)?$/.test(n)) out[k]=Number(n);
else out[k]=n;
} else if (typeof v==='object') out[k]=sanitizeForSave(v);
else out[k]=v;
}
return out;
}
if (typeof obj==='string' && /^-?\d+(?:\.\d+)?$/.test(obj.trim())) return Number(obj.trim());
return obj;
} catch(e){ console.warn('sanitizeForSave failed', e); return obj; }
}
async function saveCostListsPayload(payload){
try {
window._toggleSaveIndicator(true);
if (!window.db) {
try { localStorage.setItem('costLists_local', JSON.stringify(payload)); } catch(e){ console.warn('local backup failed', e); }
return;
}
var s=JSON.stringify(payload);
if (s===window._lastSavedCostListsJson) return;
try {
await db.collection('settings').doc('costLists').set(payload, { merge: true });
window._lastSavedCostListsJson=s;
} catch(e){ console.error('saveCostListsPayload write failed', e); }
} catch(e){ console.error('saveCostListsPayload failed', e); }
finally { try { window._toggleSaveIndicator(false); } catch(_){} }
}
window.saveRawGridStateNow=async function(){
try {
try { localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState || {})); } catch(e){ console.warn('localStorage raw save failed', e); }
var payload={ rawMaterials: sanitizeForSave(window._rawGridState || {}), timestamp: new Date().toISOString() };
await saveCostListsPayload(payload);
} catch(e){ console.error('saveRawGridStateNow failed', e); }
};
window.debouncedRawSave=function(){ clearTimeout(window._rawGridSaveTimer); window._rawGridSaveTimer=setTimeout(window.saveRawGridStateNow, 1500); };
window.savePackGridStateNow=async function(){
try {
try { localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState || {})); } catch(e){ console.warn('localStorage pack save failed', e); }
var payload={ packaging: sanitizeForSave(window._packGridState || {}), timestamp: new Date().toISOString() };
await saveCostListsPayload(payload);
} catch(e){ console.error('savePackGridStateNow failed', e); }
};
window.debouncedPackSave=function(){ clearTimeout(window._packGridSaveTimer); window._packGridSaveTimer=setTimeout(window.savePackGridStateNow, 1500); };
window.saveFinishedGridStateNow=async function(){
try {
try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState || {})); } catch(e){ console.warn('localStorage finished save failed', e); }
try { localStorage.setItem('stock_entries', JSON.stringify(window.state?.stockEntries || {})); } catch(e){ console.warn('localStorage stock_entries save failed', e); }
var payload={ 
finished: window.costFinished || [], 
finishedProducts: sanitizeForSave(window._finishedGridState || {}),
stockEntries: sanitizeForSave(window.state?.stockEntries || {}),
timestamp: new Date().toISOString() 
};
await saveCostListsPayload(payload);
} catch(e){ console.error('saveFinishedGridStateNow failed', e); }
};
window.debouncedFinishedSave=function(){ clearTimeout(window._finishedGridSaveTimer); window._finishedGridSaveTimer=setTimeout(window.saveFinishedGridStateNow, 1500); };
}
window.forceFullCloudSync=async function(){
try {
if (!window.firebase || !window.firebase.firestore) { alert('❌ Firebase غير جاهز'); return; }
if (!window.db) { alert('❌ Database غير متصل'); return; }
if (!confirm('هل تريد رفع كل البيانات المحلية للسحابة الآن؟')) return;
const payload={
costRaw: window.costLists?.costRaw || [],
costPack: window.costLists?.costPack || [],
rawGridState: window._rawGridState || {},
packGridState: window._packGridState || {},
finishedProducts: window._finishedGridState || {}, 
stockEntries: window.state?.stockEntries || {}, 
timestamp: new Date().toISOString()
};
await db.collection('settings').doc('costLists').set(payload, { merge: true });
alert('✅ تم رفع البيانات للسحابة بنجاح! يمكنك الآن فتحها من أي جهاز آخر.');
} catch (e) {
console.error('forceFullCloudSync error:', e);
alert('❌ فشل الرفع: ' + (e && e.message ? e.message : e));
}
};
});
window.__costDocUnsub=window.__costDocUnsub || null;
window.installCostListsListener=function(){
try {
if (!window.db || window.__costDocUnsub) return;
var ref=db.collection('settings').doc('costLists');
window.__costDocUnsub=ref.onSnapshot(function(snap){
try {
if (!snap || !snap.exists) return;
window.isUpdatingFromCloud=true;
var data=snap.data() || {};
try { if (data.rawMaterials) { window._rawGridState=data.rawMaterials; localStorage.setItem('raw_materials_grid', JSON.stringify(window._rawGridState||{})); } } catch(e){ console.warn('apply raw failed', e); }
try { if (data.packaging) { window._packGridState=data.packaging; localStorage.setItem('packaging_grid', JSON.stringify(window._packGridState||{})); } } catch(e){ console.warn('apply pack failed', e); }
try { if (data.finishedProducts) { window._finishedGridState=data.finishedProducts; localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState||{})); } } catch(e){ console.warn('apply finished failed', e); }
try {
if (data.stockEntries && typeof data.stockEntries==='object' && Object.keys(data.stockEntries||{}).length > 0 && window.state) {
window.state.stockEntries=data.stockEntries;
try { localStorage.setItem('stock_entries', JSON.stringify(data.stockEntries||{})); } catch(_){ }
} else {
console.log('⏭️ costLists RT: skipped stockEntries overlay (cloud empty)');
}
} catch(e){ console.warn('apply stockEntries failed', e); }
try { if (data.costRaw) { window.costLists=window.costLists || {}; window.costLists.costRaw=data.costRaw; } } catch(e){ console.warn('apply costRaw failed', e); }
try { if (data.costPack) { window.costLists=window.costLists || {}; window.costLists.costPack=data.costPack; } } catch(e){ console.warn('apply costPack failed', e); }
try { if (data.costFinished) { window.costLists=window.costLists || {}; window.costLists.costFinished=data.costFinished; } } catch(e){ console.warn('apply costFinished failed', e); }
try {
window._lastSavedCostListsJson=JSON.stringify({ rawMaterials: window._rawGridState, packaging: window._packGridState, finishedProducts: window._finishedGridState, costRaw: (window.costLists&&window.costLists.costRaw)||[], costPack: (window.costLists&&window.costLists.costPack)||[], costFinished: (window.costLists&&window.costLists.costFinished)||[] });
} catch(e){}
} catch(e){ console.warn('costLists snapshot handler failed', e); }
finally { setTimeout(function(){ window.isUpdatingFromCloud=false; }, 50); }
});
} catch(e){ console.warn('installCostListsListener failed', e); }
};
document.addEventListener('DOMContentLoaded', function(){ setTimeout(function(){ try { if (typeof window.installCostListsListener==='function') window.installCostListsListener(); } catch(e){} }, 1200); });
window.addEventListener('load', function(){
  try {
    const nav=document.getElementById('main-nav-bar');
    if (nav) {
      nav.style.display='flex';
      nav.style.visibility='visible';
      nav.style.zIndex='10000';
      nav.style.position='fixed';
      nav.style.left='0'; nav.style.right='0'; nav.style.bottom='0';
      nav.style.width='100vw'; nav.style.maxWidth='100vw';
      document.body.style.paddingBottom='96px';
    }
    if (!window.auth || !window.auth.currentUser) {
      try { UIController.showLoginPage(); } catch(_){ }
    }
  } catch(e){ console.warn('forceShowNav on load failed', e); }
});
function getCachedSales(){
try { const raw=localStorage.getItem('cache_sales'); return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
}
function setCachedSales(arr){
try { localStorage.setItem('cache_sales', JSON.stringify(Array.isArray(arr)? arr : [])); } catch(e){}
}
function upsertCachedSale(sale){
try {
if (!sale || !sale.id) return;
const list=getCachedSales();
const idx=list.findIndex(s=> s && (s.id===sale.id || s._id===sale.id));
if (idx >=0) list[idx]=sale; else list.unshift(sale);
if (list.length > 500) list.length=500;
setCachedSales(list);
} catch(e){}
}
function removeCachedSale(id){
try {
const list=getCachedSales().filter(s=> s && s.id !==id && s._id !==id);
setCachedSales(list);
} catch(e){}
}
window.__permissionErrorCounts=window.__permissionErrorCounts || {};
function handlePermissionDenied(coll){
try {
const c=window.__permissionErrorCounts;
c[coll]=(c[coll] || 0) + 1;
const core=['sales','customers','products','priceLists'];
const coreFailures=core.filter(x=> c[x] && c[x] > 0).length;
if (coreFailures===core.length) {
ensureCachedDataRendered();
showPermissionBanner();
} else if (c[coll] >=2) {
showPermissionBanner();
}
} catch(e){ }
}
function preloadCachedCollections(){
try {
if (!window.state) window.state={};
if (!state.customers || !state.customers.length){
const raw=localStorage.getItem('cache_customers');
if (raw){ try { state.customers=JSON.parse(raw)||[]; } catch(e){} }
}
if (!state.products || !state.products.length){
const raw=localStorage.getItem('cache_products');
if (raw){ try { state.products=JSON.parse(raw)||[]; } catch(e){} }
}
if (!state.priceLists || !state.priceLists.length){
const raw=localStorage.getItem('cache_priceLists');
if (raw){ try { state.priceLists=JSON.parse(raw)||[]; } catch(e){} }
}
if (!state.sales || !state.sales.length){
const s=getCachedSales();
if (s && s.length) state.sales=s;
}
try { if (typeof renderCustomerList==='function') renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
try { if (typeof renderProductList==='function') renderProductList(''); } catch(e){}
try { if (typeof renderPriceListsPage==='function') renderPriceListsPage(); } catch(e){}
try {
const textFilter=document.getElementById('search-sales-text')?.value || '';
const dateFilter=document.getElementById('search-sales-date')?.value || '';
const taxStatusFilter=document.getElementById('tax-status-filter')?.value || 'all';
if (typeof renderAllSales==='function') renderAllSales(textFilter, dateFilter, taxStatusFilter);
} catch(e){}
} catch(e){ }
}
function ensureCachedDataRendered(){
preloadCachedCollections();
// *** عرض البيانات المحملة ***
console.log('📊 Rendering loaded data...');

// تحميل فوري من localStorage
if (!window.state) window.state = {};
try { window.state.customers = JSON.parse(localStorage.getItem('customers') || '[]'); } catch(e) { window.state.customers = []; }
try { window.state.products = JSON.parse(localStorage.getItem('products') || '[]'); } catch(e) { window.state.products = []; }
try { window.state.sales = JSON.parse(localStorage.getItem('sales') || '[]'); } catch(e) { window.state.sales = []; }
try { window.state.reps = JSON.parse(localStorage.getItem('reps') || '[]'); } catch(e) { window.state.reps = []; }

console.log('📦 Loaded:', window.state.customers.length, 'customers,', window.state.products.length, 'products');

// ✅ إظهار الأيقونات والصفحات
setTimeout(() => {
  try {
    const nav = document.getElementById('main-nav-bar');
    if (nav) {
      try { nav.classList.remove('hidden'); } catch(_){}
      nav.style.display = 'flex';
      nav.style.visibility = 'visible';
      nav.style.zIndex = '1000';
        document.body.style.paddingBottom = '96px';
      console.log('✅ Bottom navigation shown');
    }
    // إظهار جميع الصفحات
    const pages = ['dashboard-page', 'sales-page', 'customers-page', 'products-page'];
    pages.forEach(pageId => {
      const page = document.getElementById(pageId);
      if (page) { try { page.classList.remove('hidden'); } catch(_){}; page.style.display = 'block'; }
    });
    // إظهار dashboard بشكل افتراضي
    if (typeof showDashboard === 'function') showDashboard();
  } catch(e) { console.warn('Error showing UI:', e); }
}, 100);

 // Force icon visibility and stroke colors in bottom nav
 try {
   const svgs = document.querySelectorAll('#main-nav-bar .bottom-nav-item svg');
   svgs.forEach(svg => {
     try {
       svg.style.visibility = 'visible';
       svg.style.opacity = '1';
       svg.style.display = 'inline-block';
       svg.setAttribute('fill', 'none');
       const parent = svg.closest('.bottom-nav-item');
       const isActive = parent && parent.classList.contains('active');
       const color = isActive ? '#2563eb' : '#6b7280';
       svg.style.color = color; // for currentColor
       svg.setAttribute('stroke', color);
       svg.setAttribute('stroke-width', '2');
     } catch(_) {}
   });
 } catch(_) {}

if (typeof renderAll === 'function') {
  try {
    renderAll();
    console.log('✅ Initial data rendered successfully');
  } catch (e) {
    console.warn('❌ renderAll failed:', e);
  }
}
}
function showPermissionBanner(){
try {
let bn=document.getElementById('permission-banner');
if (!bn){
bn=document.createElement('div');
bn.id='permission-banner';
bn.style.cssText='position:fixed;top:72px;left:0;right:0;z-index:120;background:#fee;border:1px solid #f99;padding:6px 10px;font-size:14px;text-align:center;font-weight:600;color:#b00000';
bn.innerHTML='⚠️ مشكلة صلاحيات Firestore: يتم عرض البيانات من النسخة المحلية فقط. حدث القواعد ثم أعد التحميل.';
document.body.appendChild(bn);
}
} catch(e){ }
}
function updateAllPriceListDropdowns(){
try {
const els=[
document.getElementById('customer-price-list')
].filter(Boolean);
els.forEach(el=> { if (typeof populatePriceListDropdown==='function') populatePriceListDropdown(el, el.value || ''); });
} catch(e){ }
}
function updateAllCustomerDropdowns(){
try {
const els=[
document.getElementById('sale-customer'),
document.getElementById('spreadsheet-customer') || document.getElementById('spreadsheet-customer-select') || document.getElementById('spreadsheetCustomerSelect')
].filter(Boolean);
els.forEach(el=> {
const current=el.value || '';
if (typeof populateCustomerDropdown==='function') populateCustomerDropdown(el, current);
});
} catch(e){ }
}
function populateChainsDropdown(el){
try {
  if (!el) return;
  const s = window.state || {};
  let chains = [];
  if (Array.isArray(s.chains) && s.chains.length) chains = s.chains;
  else {
    const customers = Array.isArray(s.customers) ? s.customers : [];
    const set = new Set();
    customers.forEach(c => { try { if (c && c.chain) set.add(String(c.chain)); } catch(_){} });
    chains = Array.from(set);
  }
  el.innerHTML = '';
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.textContent = 'الكل';
  el.appendChild(defaultOpt);
  chains.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    el.appendChild(opt);
  });
} catch(e){ console.warn('populateChainsDropdown failed', e); }
}
function __formatPeriod(dateObj){
const y=dateObj.getFullYear();
const m=(dateObj.getMonth()+1).toString().padStart(2,'0');
return `${y}-${m}`;
}
function defaultPrevMonthPeriod(){
const d=new Date(); d.setDate(1); d.setMonth(d.getMonth()-1);
return __formatPeriod(d);
}
function periodToRange(period){
try {
const [y,m]=period.split('-').map(Number);
const start=new Date(y, m-1, 1, 0,0,0,0);
const end=new Date(y, m, 0, 23,59,59,999); 
return { startISO: start.toISOString(), endISO: end.toISOString() };
} catch(e){
const d=new Date();
return { startISO: new Date(d.getFullYear(), d.getMonth(), 1).toISOString(), endISO: new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999).toISOString() };
}
}
function nextPeriod(period){
try {
const [y,m]=period.split('-').map(Number);
const d=new Date(y, m-1, 1); d.setMonth(d.getMonth()+1);
return __formatPeriod(d);
} catch(e){ return defaultPrevMonthPeriod(); }
}
async function computeClosingBalances(period){
if (!db) throw new Error('Firestore غير جاهز');
const { endISO }=periodToRange(period);
const snap=await db.collection('sales').where('date','<=', endISO).get();
const byCustomer=new Map();
snap.forEach(doc=> {
const s=doc.data() || {};
const cid=s.customerId || 'UNKNOWN';
if (s.status==='return') return;
const total=Number(s.total||0);
const paid=Number(s.paidAmount||0);
const out=Math.max(total - paid, 0);
if (!byCustomer.has(cid)) byCustomer.set(cid, 0);
byCustomer.set(cid, byCustomer.get(cid) + out);
});
const result=[];
let totalOutstanding=0;
byCustomer.forEach((amt, cid)=> {
const rounded=Math.round(amt*100)/100;
totalOutstanding +=rounded;
const cu=(state.customers||[]).find(c=> (c.id||c._id)===cid) || {};
result.push({ customerId: cid, customerName: cu.name || cid, closing: rounded });
});
result.sort((a,b)=> (b.closing - a.closing));
return { period, endISO, customers: result, totalOutstanding: Math.round(totalOutstanding*100)/100 };
}
async function lockMonthSales(period){
const { startISO, endISO }=periodToRange(period);
const snap=await db.collection('sales').where('date','>=', startISO).where('date','<=', endISO).get();
let batch=db.batch(); let pending=0; const BATCH_LIMIT=450;
for (const doc of snap.docs){
batch.set(doc.ref, { locked: true, lockPeriod: period, lockedAt: serverTs(), lockedBy: (auth&&auth.currentUser)?auth.currentUser.uid:null }, { merge:true });
pending++; if (pending >=BATCH_LIMIT){ await batch.commit(); batch=db.batch(); pending=0; }
}
if (pending>0) await batch.commit();
}
async function performMonthClose(period){
const role=getUserRole();
if (role !=='admin') { alert('إقفال الشهر متاح للمشرف فقط'); return { ok:false, reason:'not-admin' }; }
const summary=await computeClosingBalances(period);
const next=nextPeriod(period);
const existing=await db.collection('monthlyClosings').doc(period).get().catch(()=>null);
if (existing && existing.exists) { alert('تم إقفال هذا الشهر مسبقاً'); return { ok:false, reason:'already-closed' }; }
await db.collection('monthlyClosings').doc(period).set({
period,
closedAt: serverTs(),
closedBy: (auth&&auth.currentUser)? auth.currentUser.uid : null,
totalCustomers: summary.customers.length,
totalOutstanding: summary.totalOutstanding
}, { merge:true });
{
let batch=db.batch(); let pending=0; const LIM=450;
for (const row of summary.customers){
const ref=db.collection('monthlyClosings').doc(period).collection('customers').doc(row.customerId || slugId(row.customerName));
batch.set(ref, { customerId: row.customerId, customerName: row.customerName, closing: row.closing }, { merge:true });
pending++; if (pending>=LIM){ await batch.commit(); batch=db.batch(); pending=0; }
}
if (pending>0) await batch.commit();
}
{
let batch=db.batch(); let pending=0; const LIM=450;
for (const row of summary.customers){
const amount=Math.round(Number(row.closing||0)*100)/100;
if (!amount) continue;
const oid=`${row.customerId||slugId(row.customerName)}_${next}`;
const ref=db.collection('openingBalances').doc(oid);
batch.set(ref, {
customerId: row.customerId,
customerName: row.customerName,
period: next,
sourcePeriod: period,
amount,
createdAt: serverTs(),
createdBy: (auth&&auth.currentUser)?auth.currentUser.uid:null
}, { merge:true });
pending++; if (pending>=LIM){ await batch.commit(); batch=db.batch(); pending=0; }
}
if (pending>0) await batch.commit();
}
await lockMonthSales(period);
if (!arguments[1] || !arguments[1].silent) {
alert('تم إقفال الشهر وترحيل الأرصدة الافتتاحية للشهر التالي');
}
return { ok:true, summary };
}
async function maybeAutoClosePreviousMonth(){
try {
try {
if (!auth || !auth.currentUser) return;
const uid=auth.currentUser.uid;
let serverRole=null;
try {
const rdoc=await db.collection('roles').doc(uid).get();
if (rdoc.exists && rdoc.data() && rdoc.data().role) serverRole=rdoc.data().role;
} catch(_){ }
if (!serverRole) {
try {
const udoc=await db.collection('users').doc(uid).get();
if (udoc.exists && udoc.data() && udoc.data().role) serverRole=udoc.data().role;
} catch(_){ }
}
if (serverRole !=='admin') {
console.warn('maybeAutoClosePreviousMonth: skipping auto-close because server role !=admin', { serverRole });
return;
}
} catch(e){ console.warn('maybeAutoClosePreviousMonth: role check failed, skipping', e); return; }
const now=new Date();
const currentPeriod=__formatPeriod(now);
const prevPeriod=defaultPrevMonthPeriod();
const docRef=db.collection('monthlyClosings').doc(prevPeriod);
const doc=await docRef.get();
if (!doc.exists) {
await performMonthClose(prevPeriod, { silent: true });
}
} catch(e){ console.warn('maybeAutoClosePreviousMonth failed', e); }
}
function setActivePeriod(period){
try {
window.state=window.state || {};
state.activePeriod=period;
try { localStorage.setItem('active_period', String(period)); } catch(e){}
const salesDateInput=document.getElementById('search-sales-date');
if (salesDateInput) {
salesDateInput.value=`${period}-01`;
try { salesDateInput.dispatchEvent(new Event('change')); } catch(e){}
}
try {
const textFilter=document.getElementById('search-sales-text')?.value || '';
const dateFilter=document.getElementById('search-sales-date')?.value || '';
const taxStatusFilter=document.getElementById('tax-status-filter')?.value || 'all';
if (typeof renderAllSales==='function') {
renderAllSales(textFilter, dateFilter, taxStatusFilter);
}
if (typeof renderDashboard==='function') renderDashboard();
if (typeof renderDebts==='function') renderDebts();
if (typeof renderRepDebts==='function') renderRepDebts();
console.log(`Active period changed to: ${period}`);
} catch(e){ 
console.warn('Error while rendering after period change', e);
}
} catch(e){ console.warn('setActivePeriod error', e); }
}
function ensureDefaultActivePeriod(){
try {
const saved=localStorage.getItem('active_period');
const now=new Date();
const current=__formatPeriod(now);
const stateActive=(window.state && state.activePeriod) ? String(state.activePeriod) : '';
if (!saved || saved !==current || stateActive !==current) { 
console.log(`ensureDefaultActivePeriod: Updating from saved=${saved}, stateActive=${stateActive} to ${current}`);
setActivePeriod(current); 
}
} catch(e){ console.warn('ensureDefaultActivePeriod error', e); }
}
window.resetActivePeriod=function() {
try {
const current=__formatPeriod(new Date());
localStorage.setItem('active_period', current);
if (window.state) window.state.activePeriod=current;
console.log(`Reset active period to: ${current}`);
if (typeof ensureDefaultActivePeriod==='function') ensureDefaultActivePeriod();
return current;
} catch(e) {
console.error('resetActivePeriod error', e);
return null;
}
};
(function(){
const CHECK_INTERVAL=3600000; 
setInterval(()=>{
try {
ensureDefaultActivePeriod();
} catch(e){ console.warn('Periodic active period check failed', e); }
}, CHECK_INTERVAL);
try {
ensureDefaultActivePeriod();
console.log('Initial activePeriod check executed');
} catch(e){ console.warn('Initial active period check failed', e); }
})();
(function(){
const REFRESH_INTERVAL=30000; 
setInterval(()=>{
try {
if (typeof updateAllSalePrices==='function') {
updateAllSalePrices();
}
} catch(e){ console.warn('Periodic sale prices refresh failed', e); }
}, REFRESH_INTERVAL);
})();
const PRINTER_CANDIDATES=[
{ 
name: "Standard BLE", 
service: "000018f0-0000-1000-8000-00805f9b34fb", 
char: "00002af1-0000-1000-8000-00805f9b34fb" 
},
{ 
name: "ISSC / Chinese Generic", 
service: "49535343-fe7d-4ae5-8fa9-9fafd205e455", 
char: "49535343-8841-43f4-a8d4-ecbe34729bb3" 
},
{ 
name: "Generic Variant 1 (AF30)", 
service: "0000af30-0000-1000-8000-00805f9b34fb", 
char: "0000af31-0000-1000-8000-00805f9b34fb" 
},
{ 
name: "Generic Variant 2 (FF00)", 
service: "0000ff00-0000-1000-8000-00805f9b34fb", 
char: "0000ff02-0000-1000-8000-00805f9b34fb" 
}
];
let btCharacteristic=null;
let btDevice=null;
async function connectToBluetoothPrinter() {
try {
console.log("Starting Candidate Search...");
const allServices=PRINTER_CANDIDATES.map(c=> c.service);
const device=await navigator.bluetooth.requestDevice({
acceptAllDevices: true, 
optionalServices: allServices 
});
const server=await device.gatt.connect();
console.log("Connected to GATT. Scanning candidates...");
for (const candidate of PRINTER_CANDIDATES) {
try {
const service=await server.getPrimaryService(candidate.service);
const characteristic=await service.getCharacteristic(candidate.char);
btCharacteristic=characteristic;
btDevice=device;
console.log(`✅ MATCH FOUND: ${candidate.name}`);
alert(`تم الاتصال بنجاح! (${candidate.name})`);
device.addEventListener('gattserverdisconnected', ()=> {
alert("⚠️ تم قطع الاتصال بالطابعة");
btCharacteristic=null;
});
return true;
} catch (error) {
console.log(`❌ Failed candidate: ${candidate.name}`);
}
}
throw new Error("لم يتم العثور على أي خدمة طباعة مدعومة (No matching UUID found).");
} catch (error) {
alert("خطأ في الاتصال: " + error.message);
return false;
}
}
async function printInvoiceBluetooth(invoice) {
const processingMsg=document.createElement('div');
processingMsg.style.position='fixed';
processingMsg.style.top='50%';
processingMsg.style.left='50%';
processingMsg.style.transform='translate(-50%, -50%)';
processingMsg.style.background='#fff';
processingMsg.style.padding='30px';
processingMsg.style.borderRadius='10px';
processingMsg.style.zIndex='50001';
processingMsg.style.boxShadow='0 4px 6px rgba(0,0,0,0.2)';
processingMsg.style.textAlign='center';
processingMsg.innerHTML=`
<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">جاري الاتصال بالبرينتر...</div>
<div style="font-size:14px;color:#666;margin-bottom:15px;">يرجى التأكد من تشغيل البرينتر والبلوتوث</div>
<div style="animation:spin 1s linear infinite;font-size:24px;" id="spinner">⏳</div>
`;
const backdrop=document.createElement('div');
backdrop.style.position='fixed';
backdrop.style.inset='0';
backdrop.style.background='rgba(0,0,0,0.3)';
backdrop.style.zIndex='50000';
document.body.appendChild(backdrop);
document.body.appendChild(processingMsg);
const style=document.createElement('style');
style.textContent='@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
document.head.appendChild(style);
try {
if (!btCharacteristic) {
const success=await connectToBluetoothPrinter();
if (!success) {
backdrop.remove();
processingMsg.remove();
alert('فشل الاتصال بجهاز البلوتوث');
return;
}
}
processingMsg.innerHTML=`
<div style="font-size:18px;font-weight:bold;margin-bottom:15px;">جاري إرسال الفاتورة للطابعة...</div>
<div style="font-size:14px;color:#666;">يرجى الانتظار</div>
`;
try {
const encoder=new TextEncoder();
const ESC=0x1B;
const GS=0x1D;
const customer=findCustomer(invoice.customerId);
const customerName=customer ? customer.name : (invoice.customerName || 'عميل');
const taxNumber=customer ? (customer.taxNumber || '') : '';
let commands=[];
commands.push(ESC, 0x40);
commands.push(ESC, 0x61, 0x01); 
commands.push(ESC, 0x21, 0x30); 
commands.push(...encoder.encode("فاتورة مبيعات\n"));
commands.push(ESC, 0x21, 0x00); 
commands.push(...encoder.encode("================================\n"));
commands.push(ESC, 0x61, 0x00);
const now=new Date();
const dateStr=`${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
const timeStr=`${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
commands.push(...encoder.encode(`التاريخ: ${dateStr} ${timeStr}\n`));
commands.push(...encoder.encode(`رقم الفاتورة: ${invoice.invoiceNumber || invoice.id}\n`));
commands.push(...encoder.encode(`العميل: ${customerName}\n`));
if (taxNumber) {
commands.push(...encoder.encode(`الرقم الضريبي: ${taxNumber}\n`));
}
commands.push(...encoder.encode(`المندوب: ${invoice.repName || 'غير محدد'}\n`));
commands.push(...encoder.encode("--------------------------------\n"));
commands.push(ESC, 0x45, 0x01); 
const header=String("الصنف").padEnd(16) + 
String("الكمية").padStart(6) + 
String("السعر").padStart(8) + 
String("الاجمالي").padStart(10);
commands.push(...encoder.encode(header + "\n"));
commands.push(ESC, 0x45, 0x00); 
commands.push(...encoder.encode("--------------------------------\n"));
let subtotal=0;
if (invoice.items && Array.isArray(invoice.items)) {
invoice.items.forEach(item=> {
const product=findProduct(item.productId);
const itemName=(product?.name || item.name || item.productName || 'منتج').substring(0, 15);
const qty=item.quantity || 0;
const price=item.price || 0;
const itemTotal=qty * price;
subtotal +=itemTotal;
commands.push(...encoder.encode(itemName + "\n"));
const itemLine=String(qty).padStart(6) + 
String(price.toFixed(2)).padStart(14) + 
String(itemTotal.toFixed(2)).padStart(10);
commands.push(...encoder.encode(itemLine + "\n"));
});
}
commands.push(...encoder.encode("================================\n"));
commands.push(ESC, 0x45, 0x01); 
commands.push(ESC, 0x21, 0x10); 
const totalLine=String("الاجمالي:").padEnd(20) + String((invoice.total || 0).toFixed(2)).padStart(12) + " ج.م";
commands.push(...encoder.encode(totalLine + "\n"));
commands.push(ESC, 0x21, 0x00); 
commands.push(ESC, 0x45, 0x00); 
commands.push(...encoder.encode("================================\n"));
commands.push(ESC, 0x61, 0x01);
commands.push(...encoder.encode("شكرا لتعاملكم معنا\n"));
commands.push(ESC, 0x61, 0x00);
commands.push(0x0A, 0x0A, 0x0A, 0x0A);
commands.push(GS, 0x56, 0x00);
const data=new Uint8Array(commands);
const CHUNK_SIZE=20;
for (let i=0; i < data.length; i +=CHUNK_SIZE) {
const chunk=data.slice(i, i + CHUNK_SIZE);
await btCharacteristic.writeValue(chunk);
await new Promise(resolve=> setTimeout(resolve, 100));
}
await new Promise(r=> setTimeout(r, 2000));
processingMsg.innerHTML=`
<div style="font-size:18px;font-weight:bold;margin-bottom:15px;color:#059669;">✅ تم إرسال الفاتورة بنجاح</div>
<div style="font-size:14px;color:#666;">تحقق من البرينتر لخروج الورقة</div>
<div style="font-size:12px;color:#999;margin-top:10px;">الاتصال سيبقى مفتوح للطابعة</div>
`;
setTimeout(()=> {
backdrop.remove();
processingMsg.remove();
}, 4000);
} catch (error) {
throw new Error('خطأ في الإرسال: ' + error.message);
}
} catch (error) {
console.error('Bluetooth print error:', error);
processingMsg.innerHTML=`
<div style="font-size:18px;font-weight:bold;margin-bottom:15px;color:#dc2626;">❌ خطأ في الطباعة</div>
<div style="font-size:14px;color:#666;margin-bottom:15px;">${error.message}</div>
<button id="close-error-msg" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">إغلاق</button>
`;
document.getElementById('close-error-msg').onclick=()=> {
backdrop.remove();
processingMsg.remove();
};
}
}
window.printInvoiceBluetooth=printInvoiceBluetooth;
function printViaRawBT(invoice) {
let text="";
text +="[C]<b><font size='big'>فاتورة مبيعات</font></b>\n";
text +="[C]================================\n";
text +=`[L]<b>رقم الفاتورة:</b>[R]${invoice.id || 'N/A'}\n`;
text +=`[L]<b>التاريخ:</b>[R]${invoice.date ? new Date(invoice.date).toLocaleDateString('ar-EG') : 'اليوم'}\n`;
text +="[C]--------------------------------\n";
if (invoice.items && Array.isArray(invoice.items)) {
invoice.items.forEach(item=> {
const itemName=item.name || item.productId || 'منتج';
const qty=item.quantity || item.qty || 0;
const price=item.price || 0;
const total=item.total || (qty * price);
text +=`[L]<b>${itemName}</b>\n`;
text +=`[L]${qty} x ${formatCurrency(price)}[R]${formatCurrency(total)}\n`;
});
}
text +="[C]--------------------------------\n";
text +=`[R]<b><font size='big'>الإجمالي: ${formatCurrency(invoice.total || 0)}</font></b>\n`;
text +="[C]================================\n";
text +="[C]شكرا لتعاملكم معنا\n";
text +="\n\n"; 
const encodedData=encodeURIComponent(text);
window.location.href="rawbt:" + encodedData;
}
window.printViaRawBT=printViaRawBT;
</script>
<script>
window.printViaUSB=async function(sale) {
try {
if (!sale) {
return alert("❌ لا توجد فاتورة للطباعة");
}
const invoiceHTML=`
<div style="width: 80mm; font-family: Arial, sans-serif; direction: rtl; padding: 4mm; color: black; background: white;">
<div style="text-align: center; border: 1px solid black; padding: 4mm;">
<div style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">Delente ERP</div>
<div style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">فاتورة مبيعات</div>
<div style="border-top: 1px dashed black; border-bottom: 1px dashed black; padding: 4px 0; margin: 4px 0; font-size: 11px;">
<div style="display: flex; justify-content: space-between; margin: 2px 0;">
<span>رقم:</span><span>${sale.invoiceNumber || sale.id || ''}</span>
</div>
<div style="display: flex; justify-content: space-between; margin: 2px 0;">
<span>التاريخ:</span><span>${sale.date ? new Date(sale.date).toLocaleDateString('ar-EG') : ''}</span>
</div>
<div style="display: flex; justify-content: space-between; margin: 2px 0;">
<span>العميل:</span><span>${sale.customerName || 'عميل'}</span>
</div>
</div>
${sale.items && Array.isArray(sale.items) ? `
<table style="width: 100%; font-size: 10px; border-collapse: collapse; margin: 4px 0;">
<thead>
<tr style="border-bottom: 1px solid black;">
<th style="text-align: right; padding: 2px;">الصنف</th>
<th style="text-align: center; padding: 2px;">الكمية</th>
<th style="text-align: center; padding: 2px;">السعر</th>
<th style="text-align: left; padding: 2px;">الإجمالي</th>
</tr>
</thead>
<tbody>
${sale.items.map(item=> {
const qty=item.quantity || item.qty || 0;
const price=item.price || 0;
const total=qty * price;
return `<tr style="border-bottom: 1px dotted #ccc;">
<td style="text-align: right; padding: 2px;">${item.productName || item.name || ''}</td>
<td style="text-align: center; padding: 2px;">${qty}</td>
<td style="text-align: center; padding: 2px;">${price.toFixed(2)}</td>
<td style="text-align: left; padding: 2px;">${total.toFixed(2)}</td>
</tr>`;
}).join('')}
</tbody>
</table>
` : ''}
<div style="border-top: 1px solid black; border-bottom: 1px solid black; padding: 4px 0; margin: 4px 0; font-size: 12px; font-weight: bold;">
<div style="display: flex; justify-content: space-between;">
<span>الإجمالي:</span><span>${(sale.total || 0).toFixed(2)} ج.م</span>
</div>
</div>
<div style="font-size: 10px; margin: 4px 0;">
<div style="display: flex; justify-content: space-between; margin: 2px 0;">
<span>المدفوع:</span><span>${((((sale.paidAmount !==undefined && sale.paidAmount !==null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0)).toFixed(2)} ج.م</span>
</div>
<div style="display: flex; justify-content: space-between;">
<span>المتبقي:</span><span>${(((sale.total || 0) - (((sale.paidAmount !==undefined && sale.paidAmount !==null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0))).toFixed(2)} ج.م</span>
</div>
</div>
<div style="border-top: 1px dashed black; padding: 4px 0; margin: 4px 0; font-size: 10px; text-align: center;">
شكراً لتعاملكم معنا
</div>
</div>
</div>
`;
const printContainer=document.createElement('div');
printContainer.id='usb-print-container';
printContainer.innerHTML=invoiceHTML;
printContainer.style.display='none';
document.body.appendChild(printContainer);
const styleId='usb-thermal-print-style';
let style=document.getElementById(styleId);
if (!style) {
style=document.createElement('style');
style.id=styleId;
style.innerHTML=`
@media print {
body * { visibility: hidden; }
#usb-print-container, #usb-print-container * { visibility: visible; }
#usb-print-container { 
position: absolute; 
left: 0; 
top: 0; 
width: 100%;
}
@page { size: 80mm auto; margin: 0; }
}
`;
document.head.appendChild(style);
}
setTimeout(()=> {
window.print();
setTimeout(()=> {
if (printContainer && printContainer.parentNode) {
printContainer.parentNode.removeChild(printContainer);
}
}, 500);
}, 100);
} catch(e) {
console.error('USB Print Error:', e);
alert('❌ خطأ في الطباعة: ' + (e && e.message ? e.message : e));
}
};
</script>
<style>
html, body {
  width: 100vw !important;
  max-width: 100vw !important;
  overflow-x: hidden !important;
  margin: 0 !important;
  padding: 0 !important;
}
#app-container {
background-color: #ffffff !important; 
padding-bottom: 120px; 
padding-top: 72px;
width: 100vw !important;
max-width: 100vw !important;
margin: 0 !important;
position: relative !important;
left: 0 !important;
right: 0 !important;
}
.page { padding-top: 8px; }
header {
position: fixed !important;
top: 0;
left: 0;
right: 0;
z-index: 70;
}
.page { display: none; }
.page.active { display: block; }
.bottom-nav {
position: fixed !important;
left: 0;
right: 0;
bottom: 0;
z-index: 10000 !important; 
background: #ffffff !important;
height: auto !important;
min-height: 56px !important;
display: flex !important;
visibility: visible !important;
pointer-events: auto !important;
width: 100vw !important;
max-width: 100vw !important;
padding: 10px 4px !important;
}
.bottom-nav-item { 
width: 7.69%; 
transition: all 0.2s ease;
color: #6b7280; 
padding: 8px 0; 
display: flex;
flex-direction: column;
align-items: center;
} 
.bottom-nav-item.active {
color: #2563eb; 
font-weight: 600;
}
.lucide-icon {
display: inline-block !important;
width: 24px !important;
height: 24px !important;
stroke-width: 2 !important;
stroke: currentColor !important;
fill: none !important;
pointer-events: none !important;
vertical-align: middle !important;
}
.bottom-nav-item svg {
display: inline-block !important;
width: 24px !important;
height: 24px !important;
stroke-width: 2 !important;
stroke: currentColor !important;
fill: none !important;
pointer-events: none !important;
vertical-align: middle !important;
margin: 0 auto !important;
 visibility: visible !important;
 opacity: 1 !important;
}
.bottom-nav-item.active svg {
color: #2563eb !important; 
}
[data-lucide] {
display: inline-block !important;
vertical-align: middle !important;
width: 24px !important;
height: 24px !important;
stroke-width: 2 !important;
stroke: currentColor !important;
fill: none !important;
pointer-events: none !important;
}
[data-lucide].icon-sm {
width: 16px !important;
height: 16px !important;
}
#debts-detail-table {
width: 100% !important;
border-collapse: collapse !important;
font-family: Arial, sans-serif !important;
direction: rtl !important;
}
#debts-detail-table th {
background: #5c3317 !important;
color: white !important;
font-weight: bold !important;
padding: 8px !important;
border: 1px solid #3e2211 !important;
text-align: center !important;
}
#debts-detail-table td {
padding: 8px !important;
border: 1px solid #ddd !important;
background: linear-gradient(180deg, #ffd700, #daa520) !important;
text-align: center !important;
color: black !important;
font-weight: bold !important;
}
#debts-detail-table td:first-child {
text-align: right !important;
}
#debts-detail-table, #debts-detail-table thead, #debts-detail-table tbody,
#debts-detail-table tr, #debts-detail-table th, #debts-detail-table td {
display: revert !important;
visibility: visible !important;
opacity: 1 !important;
}
[data-lucide].icon-lg {
width: 32px !important;
height: 32px !important;
}
[data-lucide].w-4 { width: 16px; height: 16px; }
[data-lucide].w-5 { width: 20px; height: 20px; }
[data-lucide].w-6 { width: 24px; height: 24px; }
.recon-export-scale { width:1800px !important; }
.recon-export-scale table { width:100% !important; }
.recon-export-scale th, .recon-export-scale td { padding:10px !important; font-size:16px !important; }
#inq-report-table th { background:#041635;color:#fff;padding:6px 8px;text-align:center;font-weight:700; }
#inq-report-table td { padding:5px 6px;text-align:center;border-bottom:1px solid #e0e7ef; }
#inq-report-table td.prod-name { text-align:right;font-weight:600;background:#f8fafc; }
#inq-report-table tr:nth-child(even) td { background:#ffffff; }
#inq-report-table tr:nth-child(odd) td { background:#f3f6fa; }
#inq-report-table .qty-cell { font-weight:600;color:#0b3d91; }
#inq-report-table .total-cell { font-weight:600;color:#064e3b; }
#inq-summary .card { background:#041a3f;color:#fff;padding:12px 10px;border-radius:8px;display:flex;flex-direction:column;gap:4px; }
#inq-summary .card span.val { font-size:16px;font-weight:700; }
.price-sheet { width:100%; border-collapse:collapse; direction:rtl; font-size:12px; }
.price-sheet thead th { background:#efefef; border:1px solid #c1c1d0; padding:6px 8px; text-align:center; font-weight:800; }
.price-sheet tbody td { border:1px solid #d4d4e0; padding:6px 8px; text-align:center; }
.price-sheet tbody tr:nth-child(odd) td { background:#f9f9fb; }
.price-sheet tbody tr:nth-child(even) td { background:#ffffff; }
.price-sheet td.name { text-align:right; font-weight:600; }
.sheet-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.sheet-title { font-weight:800; font-size:16px; border:2px solid #888; padding:4px 10px; border-radius:4px; }
.sheet-meta { display:flex; gap:12px; color:#374151; font-size:12px; }
.pl-controls .label { font-weight:700; font-size:12px; }
.column-filter-menu { position:absolute; background:#ffffff; border:1px solid #c4a300; box-shadow:0 4px 10px rgba(0,0,0,0.12); border-radius:6px; padding:8px; width:220px; max-height:340px; overflow:auto; font-size:12px; z-index:9999; direction:rtl; }
.column-filter-menu .filter-search { width:100%; padding:4px 6px; border:1px solid #ddd; border-radius:4px; margin-bottom:6px; font-size:12px; }
.column-filter-menu .filter-list label { cursor:pointer; line-height:1.4; }
.column-filter-menu .filter-list input { vertical-align:middle; }
.column-filter-menu .filter-actions { display:flex; gap:6px; margin-top:8px; }
.column-filter-menu .filter-actions button { flex:1; background:linear-gradient(180deg,#ffd700,#daa520); color:#000; font-weight:600; padding:6px 4px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
.column-filter-menu .filter-actions button:hover { filter:brightness(1.05); }
.column-filter-btn { position:relative; }
.column-filter-btn.filtered { color:#1d4ed8 !important; font-weight:700; }
.column-filter-btn.filtered::after { content:''; position:absolute; top:2px; inset-inline-end:2px; width:7px; height:7px; background:#1d4ed8; border-radius:50%; box-shadow:0 0 0 1px #ffffff; }
#reports-subnav {
position: fixed;
left: 0;
right: 0;
bottom: -64px; 
height: 64px; 
background-color: #f3f4f6; 
border-top: 1px solid #e5e7eb;
box-shadow: 0 -1px 8px rgba(0,0,0,0.04);
display: none;
justify-content: space-around;
align-items: center;
padding: 0 6px;
z-index: 50; 
transition: bottom 0.3s ease;
}
#reports-subnav.active {
display: flex !important;
bottom: 56px !important; 
}
.reports-subnav-item {
width: 25%; 
padding: 0.5rem 0.25rem; 
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
color: #4b5563; 
font-size: 0.75rem; 
border: none;
background: none;
cursor: pointer;
transition: all 0.2s ease;
}
.reports-subnav-item svg {
color: #4b5563; 
width: 16px;
height: 16px;
}
.reports-subnav-item.active svg,
.reports-subnav-item.active span {
color: #dc2626; 
font-weight: 600; 
}
.progress-bar-fill { transition: width 0.5s ease-in-out; }
.modal {
transition: opacity 0.3s ease, transform 0.3s ease;
}
.modal-hidden {
opacity: 0;
transform: scale(0.95);
pointer-events: none;
visibility: hidden;
}
.modal-visible {
opacity: 1;
transform: scale(1);
pointer-events: auto;
visibility: visible;
}
.hidden {
display: none !important;
}
.modal-body {
max-height: 70vh;
overflow-y: auto;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
.loader {
border: 4px solid rgba(0, 0, 0, 0.1);
border-left-color: #2563eb;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
}
#backup-data-textarea, #restore-data-textarea {
resize: none;
height: 150px;
font-family: monospace;
font-size: 12px;
direction: ltr;
text-align: left;
}
.only-print {
display: none;
}
#sale-modal.modal-visible {
transform: none; 
}
#spreadsheet-entry-table input,
#spreadsheet-entry-table select {
width: 100%;
padding: 4px;
font-size: 0.875rem; 
border: 1px solid #d1d5db; 
border-radius: 0.375rem; 
min-width: 60px; 
text-align: center;
transition: background-color 0.1s ease;
}
#spreadsheet-entry-table input[readonly], 
#spreadsheet-entry-table .spreadsheet-product-name {
background-color: #f3f4f6; 
cursor: default;
}
.spreadsheet-invoice-number {
background-color: #e0f2fe; 
font-weight: 600;
}
.spreadsheet-product-code, 
.spreadsheet-product-name {
background-color: #d1fae5; 
font-weight: 500;
}
.spreadsheet-collection {
background-color: #e5e7eb; 
}
.spreadsheet-total {
background-color: #fce7f3; 
font-weight: 700;
color: #9d174d; 
}
#spreadsheet-entry-table .spreadsheet-product-name,
#spreadsheet-entry-table .spreadsheet-collection {
text-align: right;
padding-right: 8px; 
}
#spreadsheet-entry-table th,
#spreadsheet-entry-table td {
padding: 4px 6px;
vertical-align: middle;
white-space: nowrap;
}
#spreadsheet-entry-table .spreadsheet-price.promotion-price-applied {
background-color: #fef3c7 !important; 
color: #b91c1c !important; 
font-weight: 800;
border: 2px solid #f59e0b; 
}
.spreadsheet-tax-status-input {
background-color: #fef2f2; 
text-align: center;
}
.tax-not-filed-badge {
background-color: #fef2f2; 
color: #991b1b; 
font-weight: 700;
border: 2px solid #dc2626; 
padding: 2px 8px;
}
.sale-detail-grid {
grid-template-columns: 1fr 3fr 1fr; 
padding: 16px;
border-bottom: 1px solid #e5e7eb;
}
.sale-items-table {
width: 100%;
border-collapse: collapse;
font-size: 0.875rem;
margin-top: 10px;
}
.sale-items-table thead tr,
.sale-items-table tbody tr {
display: grid;
grid-template-columns: 2fr 0.5fr 0.5fr 0.5fr auto;
align-items: center;
}
.sale-items-table th,
.sale-items-table td {
display: block; 
padding-left: .75rem; padding-right: .75rem; padding-top: .5rem; padding-bottom: .5rem;
text-align: right;
border-bottom: 1px solid #f3f4f6;
}
.sale-item-quantity, .sale-item-price {
width: 100%;
max-width: 4.5rem;
margin: 0 auto;
text-align: center;
}
#sale-modal main {
margin-top: 80px !important; 
}
.sale-items-table,
.sale-items-table thead,
.sale-items-table tbody {
display: block;
width: 100%;
}
.sale-items-table th, .sale-items-table td {
text-align: right;
border-bottom: 1px solid #f3f4f6;
}
.sale-items-table th {
font-weight: 600;
color: #4b5563;
background-color: #f9fafb;
}
.sale-item-name-cell, .sale-item-code-cell {
background-color: #d1fae5; 
}
.sale-item-total-cell {
background-color: #fce7f3; 
color: #9d174d; 
}
.sale-item-qty-cell, .sale-item-price-cell {
background-color: #e0f2fe; 
}
@media print {
body * {
visibility: hidden;
}
.printable-content, .printable-content * {
visibility: visible;
}
.printable-content {
position: absolute;
left: 0;
top: 0;
width: 100%;
}
.no-print {
display: none !important;
}
}
#page-sales #invoice-quick-search {
display: block !important;
position: fixed;
left: 12px; 
top: 96px; 
width: 190px;
height: calc(100vh - 120px);
overflow: auto;
z-index: 9; 
box-shadow: 0 6px 20px rgba(0,0,0,0.08);
background: #ffffff;
}
#dispatch-items-table input {
padding: 2px 4px !important;
font-size: 0.75rem !important;
}
.stock-col-initial { background-color: #e0f2fe; } 
.stock-col-inward { background-color: #dcfce7; } 
.stock-col-production { background-color: #f3e8ff; } 
.stock-col-outbound { background-color: #fef9c3; } 
.stock-col-book { background-color: #e5e7eb; } 
.stock-col-actual { background-color: #fee2e2; } 
.stock-col-diff { background-color: #ffedd5; } 
.invoice-cell {
cursor: pointer;
border-radius: 4px;
padding: 2px 8px;
display: inline-block;
transition: background-color 0.2s ease, color 0.2s ease;
font-weight: 700;
}
.invoice-cell.highlight-blue {
background-color: #93c5fd !important; 
color: #1e3a8a !important; 
}
.invoice-cell.highlight-green {
background-color: #86efac !important; 
color: #14532d !important; 
}
.invoice-cell.highlight-purple {
background-color: #c4b5fd !important; 
color: #4c1d95 !important; 
}
.invoice-cell.highlight-orange {
background-color: #fed7aa !important; 
color: #7c2d12 !important; 
}
.invoice-cell.highlight-teal {
background-color: #99f6e4 !important; 
color: #0f766e !important; 
}
#debts-detail-table th {
background: linear-gradient(180deg,#ffd700,#daa520) !important;
color: black !important;
font-weight: bold !important;
padding: 8px !important;
border: 1px solid #c4a300 !important;
text-align: center !important;
}
.debts-container {
display: flex;
gap: 24px;
align-items: flex-start;
}
.debts-sidebar {
width: 320px; 
display: flex;
flex-direction: column;
gap: 16px;
}
.debts-actions {
display: flex;
gap: 8px;
margin-bottom: 4px;
}
.debt-card {
border-radius: 10px;
padding: 22px 16px;
margin-bottom: 12px;
text-align: center;
box-shadow: 0 4px 10px rgba(0,0,0,0.04);
background: linear-gradient(180deg, #fff7ed, #fef3c7);
}
.debt-card .title {
font-weight: 700;
color: #7c4a00;
margin-bottom: 6px;
}
.debt-card .value {
font-size: 28px;
font-weight: 800;
color: #3b2a0d;
}
.debt-card.big {
background: linear-gradient(180deg,#7a4300,#3b2300);
color: #fff;
padding: 26px 18px;
}
.gold-header th {
background: linear-gradient(180deg,#f6d06a,#d59d00);
color: #3b2a04;
font-weight: 800;
padding: 14px;
border-right: 1px solid rgba(255,255,255,0.15);
}
.debts-main {
flex: 1 1 auto;
}
.filter-input { height:44px; padding:10px 12px; }
#debts-detail-table { display: table !important; width: 100% !important; table-layout: auto !important; position: relative !important; z-index: 5 !important; }
#debts-detail-table thead { display: table-header-group !important; }
#debts-detail-table tbody { display: table-row-group !important; }
#debts-detail-table tr { display: table-row !important; visibility: visible !important; opacity: 1 !important; }
#debts-detail-table td, #debts-detail-table th { display: table-cell !important; color: inherit !important; }
.debts-main .overflow-x-auto { overflow: auto !important; }
#debts-detail-table tbody tr td {
color: #111 !important;
background: transparent !important;
opacity: 1 !important;
visibility: visible !important;
display: table-cell !important;
font-size: 14px !important;
}
#debts-detail-table tbody {
min-height: 120px !important;
}
#debts-detail-table tr.hidden-by-filter { display: none !important; }
.debts-main { position: relative !important; z-index: 6 !important; }
.column-filter-btn {
display:inline-block;
background:transparent;
border:0;
cursor:pointer;
padding:2px 6px;
margin-inline-start:6px;
border-radius:4px;
font-size:14px;
}
.column-filter-btn:hover { background: rgba(0,0,0,0.04); }
.column-filter-menu {
position: absolute;
z-index: 99999;
background: #fff;
border: 1px solid #e5e7eb;
box-shadow: 0 6px 18px rgba(0,0,0,0.08);
padding: 8px;
width: 260px;
max-height: 340px;
overflow: hidden;
direction: rtl;
display: none;
border-radius: 6px;
}
.column-filter-menu .filter-search { width:100%; padding:8px; border:1px solid #e5e7eb; margin-bottom:6px; border-radius:4px; }
.column-filter-menu .filter-list { max-height:200px; overflow:auto; padding-right:6px; }
.column-filter-menu .filter-list label { display:block; padding:4px 2px; font-size:13px; }
.column-filter-menu .filter-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
.column-filter-menu .filter-actions button { padding:6px 10px; border-radius:6px; border:0; cursor:pointer; }
.column-filter-menu .apply-btn { background:#f97316; color:white; }
.column-filter-menu .clear-btn { background:#f3f4f6; color:#111; }
#debts-detail-table tbody tr:nth-child(even) td {
background: linear-gradient(180deg, #fff5d5, #ffd868) !important;
border: 1px solid #e6c200 !important;
color: black !important;
font-weight: normal !important;
padding: 8px !important;
}
#debts-detail-table tbody tr:nth-child(odd) td {
background: linear-gradient(180deg, #ffd700, #ffb700) !important;
border: 1px solid #e6c200 !important;
color: black !important;
font-weight: normal !important;
padding: 8px !important;
}
#debts-detail-table tbody tr td.total,
#debts-detail-table tbody tr td.paid,
#debts-detail-table tbody tr td.remaining {
text-align: center !important;
}
#debts-detail-table tbody tr td {
text-align: center !important;
}
#debts-detail-table tbody tr td.customer-name {
text-align: right !important;
}
#debts-detail-table thead th {
background: linear-gradient(180deg, #ffd700, #ffb700) !important;
border: 1px solid #e6c200 !important;
color: black !important;
font-weight: bold !important;
padding: 8px !important;
text-align: center !important;
}
#debts-detail-table {
width: 100% !important;
border-collapse: collapse !important;
font-family: Arial, sans-serif !important;
direction: rtl !important;
border: 1px solid #a5b4fc !important; 
color: #0f172a !important;
}
#debts-detail-table thead th {
background: linear-gradient(to left, #2c0f5b 0%, #2b6cb0 50%, #06b6d4 100%) !important;
color: #ffffff !important;
font-weight: 800 !important;
padding: 10px 12px !important;
text-align: center !important;
border-bottom: 1px solid rgba(0,0,0,0.12) !important;
border-top: 2px solid rgba(255,255,255,0.35) !important; 
box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
}
#debts-detail-table tbody td:first-child,
#debts-detail-table tbody th:first-child {
background: #2c0f5b !important; 
color: #ffffff !important;
font-weight: 700 !important;
text-align: right !important;
border-right: 1px solid #a5b4fc !important;
}
#debts-detail-table tbody td:nth-child(3n+1) {
background: rgba(230,240,255,0.85) !important; 
border: 1px solid #a5b4fc !important;
color: #0b1a2b !important;
}
#debts-detail-table tbody td:nth-child(3n+2) {
background: rgba(243,229,255,0.88) !important; 
border: 1px solid #a5b4fc !important;
color: #0b1a2b !important;
}
#debts-detail-table tbody td:nth-child(3n+3) {
background: rgba(224,247,250,0.88) !important; 
border: 1px solid #a5b4fc !important;
color: #0b1a2b !important;
}
#debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+1) { background: rgba(216,230,255,0.9) !important; }
#debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+2) { background: rgba(236,228,255,0.9) !important; }
#debts-detail-table tbody tr:nth-child(even) td:nth-child(3n+3) { background: rgba(206,244,246,0.9) !important; }
#debts-detail-table tbody tr td.total,
#debts-detail-table tbody tr td.paid,
#debts-detail-table tbody tr td.remaining {
background: #06b6d4 !important; 
color: #ffffff !important;
font-weight: 800 !important;
border: 1px solid #7dd3fc !important;
}
#debts-detail-table tbody tr:hover td {
transform: translateY(0);
box-shadow: inset 0 0 0 9999px rgba(255,255,255,0.02);
transition: background-color 120ms ease;
}
#debts-detail-table tfoot td {
background: linear-gradient(to left, #0f172a, #1e293b) !important; 
color: #ffffff !important;
font-weight: 700 !important;
padding: 10px !important;
border-top: 2px solid #a5b4fc !important;
}
#debts-detail-table td, #debts-detail-table th {
border: 1px solid #a5b4fc !important;
padding: 8px !important;
}
#debts-detail-table tbody tr td.customer-name { text-align: right !important; }
.debts-main .overflow-x-auto { overflow-x: auto !important; }
.debt-card {
padding: 20px !important;
border-radius: 8px !important;
margin: 8px !important;
}
.debt-card:nth-child(1) {
background: linear-gradient(180deg, #ffd700, #daa520) !important;
color: black !important;
}
.debt-card:nth-child(2) {
background: linear-gradient(180deg, #f0c233, #cc9900) !important;
color: black !important;
}
.debt-card:nth-child(3) {
background: linear-gradient(180deg, #ffdb4d, #e6b800) !important;
color: black !important;
}
.debt-card.big {
background: linear-gradient(180deg, #8b6914, #654b0f) !important;
color: #ffffff !important;
text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
}
#debts-detail-table tbody tr:hover td {
background: linear-gradient(180deg, #fff7e6, #ffe180) !important;
}
</style>
</head>
<body class="bg-gray-100">
<!-- بانر تسجيل الدخول (معطل حالياً لإزالة الشريط الأحمر) -->
<div id="login-banner" style="display:none;"></div>
<script>
if (!window.updateIcons) {
window.updateIcons=function(){
try {
if (window.lucide && typeof window.lucide.replace==='function') {
window.lucide.replace();
return;
}
if (window.Lucide && typeof window.Lucide.replace==='function') {
window.Lucide.replace();
return;
}
} catch(e) {
}
};
}
window.showInvoiceQuickSearch=function(){
try {
var el=document.getElementById('invoice-quick-search-panel') || document.getElementById('invoice-quick-search-global');
if (el) el.style.display='';
return !!el;
} catch(e){ return false; }
};
</script>
<style>
.targets-table { border-collapse: separate; border-spacing: 0; width: 100%; }
.targets-table th, .targets-table td { padding: 6px 8px; font-size: 12px; text-align: center; }
.targets-table tbody td { border-bottom: 1px solid rgba(17,24,39,0.06); }
.targets-table td + td, .targets-table th + th { border-left: 2px solid rgba(59,130,246,0.25); }
.targets-col-day { background:#e8f2ff; color:#0b1b34; }
.targets-col-total { background:#ffe4e6; color:#0b1b34; font-weight:700; }
.customer-targets-table { border-collapse: separate; border-spacing:0; width:100%; font-size:12px; }
.customer-targets-table th { padding:6px 6px; font-weight:700; color:#fff; text-align:center; }
.cth-name { background:#2f2f34; }
.cth-multi-target, .cth-dairy-target { background:#b66a00; }
.cth-multi-ach, .cth-dairy-ach { background:#0f2d64; }
.cth-total-target { background:#004d40; }
.cth-total-ach { background:#003366; }
.cth-rem, .cth-rem-total { background:#5a3d00; }
.cth-pct, .cth-pct-total { background:#2c3e50; }
.customer-targets-table tbody tr:nth-child(even) td { background:#f9fafb; }
.customer-targets-table tbody tr:nth-child(odd) td { background:#fff; }
.customer-targets-table td { padding:5px 6px; text-align:center; border-bottom:1px solid #e5e7eb; }
.customer-targets-table td.name { text-align:right; font-weight:600; }
.customer-targets-table input.cust-target-input { background:#fff; font-size:11px; }
.customer-targets-table .ach-cell { font-weight:600; color:#0d47a1; }
.customer-targets-table .rem-pos { color:#b45309; font-weight:600; }
.customer-targets-table .rem-zero { color:#059669; font-weight:600; }
.customer-targets-table .pct-ok { color:#047857; font-weight:600; }
.customer-targets-table .pct-low { color:#374151; font-weight:600; }
.ghost-zero::before { content:'0'; opacity:0.35; }
</style>
<style>
body > pre, body > code, .top-debug-text { display: none !important; }
</style>
<!-- Removed duplicate global quick-search; using page-local panel inside #page-sales -->
<script>
function showDashboardPage() {
var pages=document.getElementsByClassName('page');
for (var i=0; i < pages.length; i++) {
pages[i].classList.remove('active');
pages[i].style.display='none';
}
var dashboard=document.getElementById('page-dashboard');
if (dashboard) {
dashboard.classList.add('active');
dashboard.style.display='block';
}
var navItems=document.getElementsByClassName('bottom-nav-item');
for (var i=0; i < navItems.length; i++) {
navItems[i].classList.remove('active');
if (navItems[i].getAttribute('data-page')==='dashboard') {
navItems[i].classList.add('active');
}
}
var statementCustomerListEl=document.getElementById('statement-customer-list');
var statementCustomerSearchEl=document.getElementById('statement-customer-search');
if (statementCustomerListEl && statementCustomerSearchEl) {
statementCustomerSearchEl.value='';
try { updateCustomerList(''); } catch (e) { console.warn('updateCustomerList failed during dashboard init', e); }
}
try { updateIcons(); } catch (e) { console.warn('updateIcons failed', e); }
try { if (typeof renderCash==='function') renderCash(); } catch (e) { console.warn('renderCash failed from renderAll', e); }
}
document.addEventListener('DOMContentLoaded', showDashboardPage);
window.addEventListener('load', showDashboardPage);
showDashboardPage();
</script>
<!-- UI Navigation & Authentication Handler -->
<script>
const UIController={
showLoginPage() {
const loginEl=document.getElementById('login-page');
const registerEl=document.getElementById('register-page');
const appEl=document.getElementById('app-container');
if (loginEl) loginEl.classList.remove('hidden');
if (registerEl) registerEl.classList.add('hidden');
if (appEl) appEl.classList.add('hidden');
},
showRegisterPage() {
const loginEl=document.getElementById('login-page');
const registerEl=document.getElementById('register-page');
if (loginEl) loginEl.classList.add('hidden');
if (registerEl) registerEl.classList.remove('hidden');
document.getElementById('app-container').classList.add('hidden');
},
showApp() {
console.log('🚀 UIController.showApp() called - showing application');
const loginPage = document.getElementById('login-page');
const registerPage = document.getElementById('register-page');
const appContainer = document.getElementById('app-container');
if (loginPage) {
  loginPage.classList.add('hidden');
  loginPage.style.display = 'none';
}
if (registerPage) {
  registerPage.classList.add('hidden');
  registerPage.style.display = 'none';
}
if (appContainer) {
  appContainer.classList.remove('hidden');
  appContainer.style.display = 'block';
  console.log('✅ App container displayed:', {
    classList: appContainer.classList.toString(),
    display: appContainer.style.display,
    width: window.getComputedStyle(appContainer).width
  });
} else {
  console.error('❌ app-container element not found!');
}
this.updateCurrentUserDisplay();
},
updateCurrentUserDisplay() {
const user=AuthSystem.getCurrentUser();
const userDisplay=document.getElementById('current-user-display');
if (user && userDisplay) {
const role=getUserRole();
userDisplay.textContent=`مرحباً، ${user.name} (${role})`;
try {
const mapBtn=document.getElementById('open-map-btn');
if (mapBtn) mapBtn.classList.toggle('hidden', role !=='admin');
} catch(e){}
}
},
showPage(pageId) {
const pages=document.querySelectorAll('.page');
pages.forEach(p=> {
p.classList.remove('active');
p.style.display='none';
});
const page=document.getElementById(pageId);
if (page) {
page.classList.add('active');
page.style.display='block';
}
}
};
document.addEventListener('DOMContentLoaded', ()=> {
try {
document.querySelectorAll('.toggle-password').forEach(btn=> {
btn.addEventListener('click', ()=> {
const id=btn.getAttribute('data-target');
const input=document.getElementById(id);
if (!input) return;
input.type=input.type==='password' ? 'text' : 'password';
btn.textContent=input.type==='password' ? '👁️' : '🙈';
});
});
} catch(e) { }
const loginForm=document.getElementById('login-form');
if (loginForm) {
loginForm.addEventListener('submit', async (e)=> {
e.preventDefault();
const email=document.getElementById('login-email').value;
const password=document.getElementById('login-password').value;
const rememberEl=document.getElementById('login-remember');
const remember=rememberEl ? rememberEl.checked : false;
const result=await (typeof window.loginUsingServices==='function'
? window.loginUsingServices(email, password, { showAlertOnError: false })
: AuthSystem.login(email, password));
if (result.ok || result.success) {
if (remember) {
localStorage.setItem('app_remember_email', email);
}
loginForm.reset();
} else {
alert('❌ خطأ: ' + (result.error || result.message));
}
});
}
const loginFormModal=document.getElementById('login-modal-form');
if (loginFormModal) {
loginFormModal.addEventListener('submit', async (e)=> {
e.preventDefault();
const emailEl=document.getElementById('login-email-modal');
const passEl=document.getElementById('login-password-modal');
const email=emailEl ? emailEl.value : '';
const password=passEl ? passEl.value : '';
const result=await (typeof window.loginUsingServices==='function'
? window.loginUsingServices(email, password, { showAlertOnError: false })
: AuthSystem.login(email, password));
if (result.ok || result.success) {
loginFormModal.reset();
try { closeModal(document.getElementById('login-modal')); } catch(_){}
} else {
alert('❌ خطأ: ' + (result.error || result.message));
}
});
}
const registerForm=document.getElementById('register-form');
if (registerForm) {
registerForm.addEventListener('submit', async (e)=> {
e.preventDefault();
const name=document.getElementById('register-name').value;
const email=document.getElementById('register-email').value;
const password=document.getElementById('register-password').value;
const confirmPassword=document.getElementById('register-password-confirm').value;
if (password !==confirmPassword) {
alert('❌ كلمات المرور غير متطابقة');
return;
}
if (password.length < 6) {
alert('❌ كلمة المرور يجب أن تكون 6 أحرف على الأقل');
return;
}
const result=await AuthSystem.register(email, password, name);
if (result.success) {
alert('✅ ' + result.message + '\n\nيمكنك الآن تسجيل الدخول');
registerForm.reset();
UIController.showLoginPage();
} else {
alert('❌ خطأ: ' + result.message);
}
});
}
const goToRegisterBtn=document.getElementById('go-to-register-btn');
if (goToRegisterBtn) {
goToRegisterBtn.addEventListener('click', (e)=> {
e.preventDefault();
UIController.showRegisterPage();
});
}
const goToLoginBtn=document.getElementById('go-to-login-btn');
if (goToLoginBtn) {
goToLoginBtn.addEventListener('click', (e)=> {
e.preventDefault();
UIController.showLoginPage();
});
}
const logoutBtn=document.getElementById('logout-btn');
if (logoutBtn) {
logoutBtn.addEventListener('click', async ()=> {
if (!confirm('هل تريد تسجيل الخروج؟')) return;
try { if (window.auth && typeof auth.signOut==='function') await auth.signOut(); } catch(_){}
try { await (typeof window.logoutUsingServices==='function'
? window.logoutUsingServices({ showAlertOnError: false })
: AuthSystem.logout()); } catch(_){ try { AuthSystem.logout(); } catch(__){} }
localStorage.removeItem('app_remember_email');
UIController.showLoginPage();
});
}
const rememberEmail=localStorage.getItem('app_remember_email');
if (rememberEmail) {
const pageEmail=document.getElementById('login-email');
if (pageEmail) pageEmail.value=rememberEmail;
const modalEmail=document.getElementById('login-email-modal');
if (modalEmail) modalEmail.value=rememberEmail;
}
UIController.showLoginPage();
});
async function initializeAppForUser() {
const currentPeriod=__formatPeriod(new Date());
if (!window.state) {
window.state={ customers: [], products: [], sales: [], reps: [], promotions: [], productions: [], settings: { salesTarget: 10000 }, stockEntries: {}, activePeriod: currentPeriod, chains: [] };
try {
const saved=localStorage.getItem('stock_entries');
if (saved) window.state.stockEntries=JSON.parse(saved);
} catch(e){ console.warn('Failed to restore stockEntries during init', e); }
}
else {
window.state.activePeriod=currentPeriod;
if (!Array.isArray(window.state.productions)) window.state.productions=[];
try {
if (!window.state.stockEntries || Object.keys(window.state.stockEntries).length===0) {
const saved=localStorage.getItem('stock_entries');
if (saved) window.state.stockEntries=JSON.parse(saved);
}
} catch(e){ console.warn('Failed to restore stockEntries during re-init', e); }
}
try { localStorage.setItem('active_period', currentPeriod); } catch(e){}
console.log(`initializeAppForUser: Set activePeriod to ${currentPeriod}`);
try { UIController.updateCurrentUserDisplay(); } catch(e){}
try {
if (typeof window.ProductsService==='object' && typeof window.ProductsService.getProducts==='function') {
console.log('Loading products with Cache-First strategy...');
const products=await window.ProductsService.getProducts({ maxAgeMs: 6 * 60 * 60 * 1000 });
if (Array.isArray(products) && products.length > 0) {
window.state.products=products;
console.log(`✅ Loaded ${products.length} products from cache/server`);
} else {
console.warn('No products loaded, using empty array');
window.state.products=[];
}
} else {
console.warn('ProductsService not available, using empty products array');
window.state.products=[];
}
} catch(e) {
console.error('Failed to load products:', e);
window.state.products=[];
}
try {
if (typeof window.CustomersService==='object' && typeof window.CustomersService.getCustomers==='function') {
console.log('Loading customers with Cache-First strategy...');
const customers=await window.CustomersService.getCustomers({ maxAgeMs: 6 * 60 * 60 * 1000 });
if (Array.isArray(customers) && customers.length > 0) {
window.state.customers=customers;
console.log(`✅ Loaded ${customers.length} customers from cache/server`);
} else {
console.warn('No customers loaded, using empty array');
window.state.customers=[];
}
} else {
console.warn('CustomersService not available, using empty customers array');
window.state.customers=[];
}
} catch(e) {
console.error('Failed to load customers:', e);
window.state.customers=[];
}
setTimeout(()=>{
try { 
ensureDefaultActivePeriod();
console.log(`Forced activePeriod check: current=${currentPeriod}, saved=${localStorage.getItem('active_period')}`);
} catch(e){}
}, 500);
}
const DataManager={
saveAppState(stateObj) {
const user=AuthSystem.getCurrentUser();
if (!user) {
console.warn('Cannot save state: no current user logged in');
return false;
}
try {
localStorage.setItem('app_state', JSON.stringify(stateObj));
user.data.lastAppState=stateObj;
AuthSystem.setCurrentUser(user);
try {
if (typeof saveStateToFirebase==='function') {
saveStateToFirebase(stateObj).then(ok=> {
if (ok) console.log('✅ saved state to Firebase');
}).catch(e=> console.warn('Failed to save state to Firebase', e));
}
} catch(e) { console.warn('saveStateToFirebase error', e); }
return true;
} catch (e) {
console.error('Error saving app state:', e);
return false;
}
},
loadAppState() {
const user=AuthSystem.getCurrentUser();
try {
const localData=localStorage.getItem('app_state');
if (localData) {
return JSON.parse(localData);
}
if (user && user.data && user.data.lastAppState) {
return user.data.lastAppState;
}
return null;
} catch (e) {
console.error('Error loading app state:', e);
return null;
}
},
clearUserData() {
const user=AuthSystem.getCurrentUser();
if (!user) return false;
try {
user.data={};
AuthSystem.setCurrentUser(user);
localStorage.removeItem('app_state');
return true;
} catch (e) {
console.error('Error clearing user data:', e);
return false;
}
}
};
function canManageUsers(){ try { return getUserRole()==='admin'; } catch(e){ return false; } }
function updateUserManagementVisibility(){
const sec=document.getElementById('user-management-section');
if (!sec) return;
if (canManageUsers()) {
sec.classList.remove('hidden');
try { renderUsersTable(); } catch(e){}
} else {
sec.classList.add('hidden');
}
}
function renderUsersTable(){
const tbody=document.getElementById('users-table-body');
const warn=document.getElementById('user-role-warning');
if (!tbody) return;
if (!canManageUsers()) { if (warn){ warn.textContent='هذه الميزة مخصصة للمشرفين فقط.'; warn.classList.remove('hidden'); } return; }
if (warn) warn.classList.add('hidden');
const list=Array.isArray(window.state && state.users) ? state.users : [];
if (list.length===0) { tbody.innerHTML='<tr><td colspan="4" class="px-2 py-3 text-center text-gray-500">لا يوجد مستخدمون بعد.</td></tr>'; return; }
const current=AuthSystem.getCurrentUser();
tbody.innerHTML=list.map(u=> {
const role=(u.role || 'user');
const disabled=(current && current.id===u._id) ? 'data-self="1"' : '';
const pres=(window.state && Array.isArray(state.presence)) ? state.presence.find(p=> (p._id===u._id) || (p.uid===u._id) || ((p.email||'').toLowerCase()===(u.email||'').toLowerCase())) : null;
const online=(typeof u.online !=='undefined') ? !!u.online : !!(pres && pres.online===true); 
const emailStr=((u.email||'').toLowerCase()) || ((pres && pres.email) ? (pres.email||'').toLowerCase() : '');
return `<tr>
<td class="px-2 py-2">${u.name || '-'}</td>
<td class="px-2 py-2 flex items-center gap-2">
<span class="inline-block w-2.5 h-2.5 rounded-full ${online ? 'bg-green-500' : 'bg-gray-400'}" title="${online ? 'متصل الآن' : 'غير متصل'}"></span>
<span>${emailStr}</span>
</td>
<td class="px-2 py-2 text-center">
<select class="user-role-select p-1 border rounded" data-uid="${u._id}" ${disabled}>
<option value="admin" ${role==='admin'?'selected':''}>admin</option>
<option value="rep" ${role==='rep'?'selected':''}>rep</option>
<option value="viewer" ${role==='viewer'?'selected':''}>viewer</option>
<option value="user" ${role==='user'?'selected':''}>user</option>
</select>
</td>
<td class="px-2 py-2 text-center">
<div class="flex items-center justify-center gap-2">
<button class="apply-role-btn bg-blue-600 text-white px-3 py-1 rounded text-xs" data-uid="${u._id}">تطبيق</button>
${emailStr ? '' : `<button class="set-user-email-btn bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs" title="إضافة بريد" data-uid="${u._id}">إضافة بريد</button>`}
</div>
</td>
</tr>`;
}).join('');
}
document.addEventListener('click', async function(e){
const btn=e.target && e.target.closest ? e.target.closest('.apply-role-btn') : null;
if (!btn) return;
if (!canManageUsers()) { alert('ليست لديك صلاحية التعديل'); return; }
const uid=btn.getAttribute('data-uid');
const sel=document.querySelector(`select.user-role-select[data-uid="${uid}"]`);
if (!uid || !sel) return;
const role=sel.value;
const current=AuthSystem.getCurrentUser();
if (current && current.id===uid && role !=='admin') {
if (!confirm('أنت تحاول إزالة صلاحية المشرف عن نفسك، قد تفقد إمكانية الإدارة. هل أنت متأكد؟')) return;
}
try {
await db.collection('users').doc(uid).set({ role: role }, { merge: true });
try { await db.collection('roles').doc(uid).set({ role: role }, { merge: true }); } catch(_e){}
alert('تم تحديث الدور بنجاح');
} catch (err) {
console.warn('فشل تحديث الدور', err);
alert('تعذر تحديث الدور، تحقق من اتصالك والصلاحيات');
}
});
document.addEventListener('click', function(e){
const r=e.target && e.target.id==='refresh-users-btn';
if (!r) return;
try { renderUsersTable(); } catch(e){}
});
document.addEventListener('change', function(e){
const inp=e.target && e.target.classList && e.target.classList.contains('unified-new-price') ? e.target : null;
if(!inp) return;
const id=inp.getAttribute('data-id');
const typeLabel=inp.getAttribute('data-type');
const rawVal=(inp.value||'').trim(); if(rawVal==='' ) return;
const num=parseFloat(rawVal); if(isNaN(num)) { alert('سعر غير صالح'); return; }
const mapType=t=> t==='خامة'?'raw': (t==='تغليف'?'pack': (t==='تشغيل'?'ops': (t==='منتج نهائي'?'finished':'raw')));
const tKey=mapType(typeLabel);
const list=getListByType(tKey) || [];
const it=list.find(x=> String(x.id)===String(id)); if(!it){ alert('العنصر غير موجود'); return; }
const now=new Date().toISOString();
it.lastPrice=num; it.lastPriceDate=now; it.priceHistory=Array.isArray(it.priceHistory)? it.priceHistory : []; it.priceHistory.unshift({ price: num, date: now, note: 'شبكة موحدة' });
saveLists();
const currentSpan=document.querySelector(`.unified-current-price[data-id="${CSS.escape(id)}"][data-type="${CSS.escape(typeLabel)}"]`);
if(currentSpan) currentSpan.textContent=Number(num).toFixed(2);
showSavedIndicator(inp);
inp.value='';
console.log('✅ unified-new-price change saved');
});
document.addEventListener('click', async function(e){
const btn=e.target && e.target.closest ? e.target.closest('.set-user-email-btn') : null;
if (!btn) return;
if (!canManageUsers()) { alert('ليست لديك صلاحية التعديل'); return; }
const uid=btn.getAttribute('data-uid');
const currentEmail=(state.users||[]).find(u=>String(u._id)===String(uid))?.email || '';
const val=prompt('أدخل بريد المستخدم', currentEmail || '');
if (!val) return;
const email=String(val).trim().toLowerCase();
if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('صيغة بريد غير صحيحة'); return; }
try {
await db.collection('users').doc(uid).set({ email }, { merge: true });
try {
const i=(state.users||[]).findIndex(u=>String(u._id)===String(uid));
if (i>=0) { state.users[i]=Object.assign({}, state.users[i], { email }); }
} catch(_){ }
renderUsersTable();
} catch(err){
alert('تعذر حفظ البريد');
console.warn('set email failed', err);
}
});
document.addEventListener('click', function(e){
const openBtn=e.target && (e.target.id==='open-user-management-btn' || (e.target.closest && e.target.closest('#open-user-management-btn')));
if (!openBtn) return;
if (!canManageUsers()) { alert('هذه الميزة للمشرفين فقط'); return; }
const sec=document.getElementById('user-management-section');
if (sec) {
sec.classList.remove('hidden');
try { sec.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e){}
}
});
document.addEventListener('DOMContentLoaded', updateUserManagementVisibility);
try { UIController.updateCurrentUserDisplay=(function(orig){ return function(){ try { orig.call(UIController); } catch(e){}; try { updateUserManagementVisibility(); } catch(e){}; }; })(UIController.updateCurrentUserDisplay); } catch(e){}
</script>
<!-- LOGIN PAGE -->
<div id="login-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
<div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
<div class="text-center mb-8">
<h1 class="text-3xl font-bold text-gray-800">مرحباً</h1>
<p class="text-gray-600 mt-2">نظام إدارة المبيعات</p>
</div>
<form id="login-form" class="space-y-4">
<div>
<label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
<input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل بريدك الإلكتروني" required>
</div>
<div>
<label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
<div class="relative">
<input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10" placeholder="أدخل كلمة المرور" required>
<button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password" title="إظهار/إخفاء">
👁️
</button>
</div>
</div>
<div class="flex items-center">
<input type="checkbox" id="login-remember" class="h-4 w-4 text-blue-600 rounded">
<label for="login-remember" class="mr-2 text-sm text-gray-600">تذكرني</label>
</div>
<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">دخول</button>
<div class="text-center text-sm text-gray-600">
<p>لا تملك حساب؟ <button type="button" id="go-to-register-btn" class="text-blue-600 hover:underline font-semibold">إنشاء حساب جديد</button></p>
</div>
</form>
<div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
<p><strong>للاختبار السريع:</strong></p>
<p>البريد: test@example.com</p>
<p>كلمة المرور: test123</p>
</div>
</div>
</div>
<!-- REGISTER PAGE -->
<div id="register-page" class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4 hidden">
<div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
<div class="text-center mb-8">
<h1 class="text-3xl font-bold text-gray-800">إنشاء حساب جديد</h1>
<p class="text-gray-600 mt-2">نظام إدارة المبيعات</p>
</div>
<form id="register-form" class="space-y-4">
<div>
<label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل</label>
<input type="text" id="register-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل اسمك الكامل" required>
</div>
<div>
<label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
<input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل بريدك الإلكتروني" required>
</div>
<div>
<label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
<input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل كلمة مرور قوية" required>
</div>
<div>
<label for="register-password-confirm" class="block text-sm font-medium text-gray-700 mb-1">تأكيد كلمة المرور</label>
<input type="password" id="register-password-confirm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أعد كتابة كلمة المرور" required>
</div>
<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold transition">إنشاء الحساب</button>
<div class="text-center text-sm text-gray-600">
<p>لديك حساب بالفعل؟ <button type="button" id="go-to-login-btn" class="text-blue-600 hover:underline font-semibold">دخول</button></p>
</div>
</form>
</div>
</div>
<div id="app-container" class="bg-white min-h-screen hidden">
<header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 no-print flex justify-between items-center">
<div class="flex items-center">
<img id="company-logo-img" src="" alt="شعار" style="height:40px;display:none;margin-left:10px;border-radius:6px;background:white;padding:2px;" />
<h1 id="header-title" class="text-xl font-bold">لوحة المعلومات</h1>
</div>
<!-- الساعة الرقمية في منتصف الهيدر -->
<div class="flex-1 flex justify-center">
<div id="digital-clock" class="text-2xl font-mono font-bold text-white tracking-widest" style="letter-spacing:0.1em;">00:00:00</div>
</div>
<div class="flex items-center gap-4">
<!-- GPS quick toggle for reps (no need to open settings) -->
<button id="gps-toggle-btn" class="px-2 py-1 rounded text-xs font-semibold bg-red-500 text-white hover:bg-red-600" title="تشغيل/إيقاف مشاركة الموقع">GPS OFF</button>
<!-- Admin-only: open interactive map modal for all reps -->
<button id="open-map-btn" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-xs font-semibold flex items-center gap-1" title="عرض خريطة المناديب">
<span>الخريطة</span>
</button>
<span id="reviewer-badge" class="hidden bg-amber-500 text-white px-2 py-1 rounded text-xs font-semibold" title="وضع المراجعة (قراءة فقط)">وضع المراجعة</span>
<span id="current-user-display" class="text-white text-sm"></span>
<!-- Logout button -->
<button id="logout-btn" class="text-white underline text-sm font-semibold" title="تسجيل الخروج">تسجيل الخروج</button>
</div>
</header>
<main class="p-4">
<!-- Admin Map Modal -->
<div id="reps-map-modal" class="hidden fixed inset-0 z-40 bg-black bg-opacity-50 items-center justify-center" style="display:none;">
<div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 overflow-hidden">
<div class="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
<h3 class="font-bold text-gray-800">خريطة المناديب</h3>
<button id="close-map-btn" class="text-gray-600 hover:text-black">إغلاق</button>
</div>
<div class="p-0">
<div id="reps-map" style="height:70vh; width:100%;"></div>
</div>
</div>
</div>
<div id="page-dashboard" class="page active">
<div class="mb-4 grid grid-cols-1 md:grid-cols-1 gap-4">
<div>
<label for="dashboard-rep-filter" class="block text-sm font-medium text-gray-700">عرض إحصائيات المندوب:</label>
<select id="dashboard-rep-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
</div>
</div>
<!-- Metrics Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
<div class="bg-green-100 p-4 rounded-lg shadow">
<h3 class="text-sm text-green-800 font-semibold">إجمالي المبيعات (الشهر)</h3>
<p id="total-sales" class="text-2xl font-bold text-green-900 mt-1">0 ج.م</p>
</div>
<div class="bg-blue-100 p-4 rounded-lg shadow">
<h3 class="text-sm text-blue-800 font-semibold">المبالغ المحصلة</h3>
<p id="total-collected" class="text-2xl font-bold text-blue-900 mt-1">0 ج.م</p>
</div>
<div class="bg-orange-100 p-4 rounded-lg shadow">
<h3 class="text-sm text-orange-800 font-semibold">المبالغ المستحقة</h3>
<p id="total-due" class="text-2xl font-bold text-orange-900 mt-1">0 ج.م</p>
</div>
<div class="bg-purple-100 p-4 rounded-lg shadow">
<h3 class="text-sm text-purple-800 font-semibold">عدد الفواتير</h3>
<p id="sales-count" class="text-2xl font-bold text-purple-900 mt-1">0</p>
</div>
</div>
<!-- Target Progress -->
<div class="mb-6">
<h3 id="target-title" class="font-bold text-gray-800 mb-2">الهدف الشهري:</h3>
<h4 id="target-amount-display" class="text-blue-600 font-bold text-lg mb-2"></h4>
<div class="bg-gray-200 rounded-full h-4">
<div id="target-progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill text-xs text-white text-center" style="width: 0%;">
<span id="target-progress-text">0%</span>
</div>
</div>
</div>
<!-- CHART / GRAPHS SECTION (Kept charts in Dashboard for dual purpose) -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
<!-- Daily Sales Chart -->
<div class="bg-white p-4 rounded-lg shadow border">
<h3 class="font-bold text-gray-800 mb-4">المبيعات اليومية للشهر الحالي</h3>
<div class="h-64">
<canvas id="sales-7-days-chart"></canvas>
</div>
</div>
<!-- Top Reps Chart -->
<div class="bg-white p-4 rounded-lg shadow border">
<h3 class="font-bold text-gray-800 mb-4">أفضل المناديب (مبيعات)</h3>
<div class="h-64">
<canvas id="top-reps-chart"></canvas>
</div>
</div>
<!-- Top Products (Quantity/Value) -->
<div class="bg-white p-4 rounded-lg shadow border">
<h3 class="font-bold text-gray-800 mb-4">أفضل المنتجات (كمية)</h3>
<div class="h-64">
<canvas id="top-products-chart"></canvas>
</div>
</div>
<!-- Top Customers (Value) -->
<div class="bg-white p-4 rounded-lg shadow border">
<h3 class="font-bold text-gray-800 mb-4">أفضل العملاء (قيمة)</h3>
<div class="h-64">
<canvas id="top-customers-chart"></canvas>
</div>
</div>
</div>
<!-- END CHART / GRAPHS SECTION -->
<!-- The Reports button is no longer needed in the Dashboard -->
<div class="mb-6 hidden">
<button id="view-reports-btn" class="w-full bg-blue-700 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-blue-800 flex items-center justify-center gap-2 font-bold">
<i data-lucide="bar-chart-2" class="w-5 h-5"></i>
<span>عرض التقارير والرسوم البيانية</span>
</button>
</div>
<div class="mb-6">
<button id="manual-statement-btn" class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-gray-700 flex items-center justify-center gap-2 font-bold">
<i data-lucide="file-text"></i>
<span>كشف حساب يدوي</span>
</button>
</div>
<div>
<h3 class="font-bold text-gray-800 mb-3">أحدث عمليات البيع</h3>
<div id="recent-sales-list" class="space-y-3">
<p class="text-gray-500 text-center">لا توجد عمليات بيع بعد.</p>
</div>
</div>
</div>
<div id="page-sales" class="page">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold flex items-center gap-2">
<i data-lucide="receipt" class="w-6 h-6 text-blue-600"></i>
<span>جميع المبيعات</span>
</h2>
<!-- سهم التمرير السريع للأسفل -->
<button id="scroll-to-bottom-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center gap-1 transition" title="انزل لآخر الفواتير">
<i data-lucide="arrow-down" class="w-5 h-5"></i>
</button>
<div class="flex items-center gap-2">
<button id="sales-quick-print-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة حرارية (صورة)">
<i data-lucide="printer" class="w-4 h-4"></i>
<span>طباعة حرارية</span>
</button>
<button id="sales-bt-print-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة بلوتوث (تجريبية)">
<i data-lucide="bluetooth" class="w-4 h-4"></i>
<span class="hidden sm:inline">بلوتوث</span>
</button>
<button id="sales-bt-test-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="اختبار بلوتوث بسيط">
<i data-lucide="zap" class="w-4 h-4"></i>
<span class="hidden sm:inline">اختبار</span>
</button>
<button id="sales-html-print-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm flex items-center gap-1" title="طباعة عادية">
<i data-lucide="file" class="w-4 h-4"></i>
<span class="hidden sm:inline">طباعة عادية</span>
</button>
</div>
<!-- FAB is used for adding sales now -->
</div>
<!-- Sales filters bar (restored) -->
<div id="sales-filters-bar" class="flex flex-col sm:flex-row gap-2 mb-4" style="position:sticky; top:72px; z-index:20; background:#ffffff; padding:8px 0;">
<input id="search-sales-text" type="text" placeholder="ابحث باسم العميل أو رقم الفاتورة أو الإجمالي..." class="w-full p-2 border rounded-md">
<div class="flex items-center w-full sm:w-auto relative">
<input id="search-sales-date" type="date" class="w-full p-2 border border-gray-300 rounded-md appearance-none">
<button id="clear-sales-date-btn" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-600 hidden font-bold text-xl leading-none p-1">&times;</button>
</div>
<input type="month" id="sales-month-selector" class="w-full sm:w-auto p-2 border rounded-md">
<select id="tax-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
<option value="all">فلترة بحالة الرفع</option>
<option value="filed">تم الرفع</option>
<option value="not-filed">لم يتم الرفع</option>
</select>
<select id="review-status-filter" class="w-full sm:w-auto p-2 border rounded-md">
<option value="all">كل الفواتير</option>
<option value="pending">قيد المراجعة فقط</option>
<option value="reviewed">المعتمدة فقط</option>
</select>
</div>
<div class="grid grid-cols-1 gap-4 mb-4">
<div id="daily-total-container" class="bg-blue-100 border-r-4 border-blue-500 p-3 rounded-lg text-center hidden shadow-md">
<span class="font-semibold">إجمالي مبيعات اليوم المحدد:</span>
<span id="daily-total-amount" class="font-bold text-blue-800">0 ج.م</span>
</div>
<!-- Right column: filtered total only (quick-search moved to side drawer) -->
<div style="display:flex;gap:12px;align-items:flex-start;">
<div id="filtered-total-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg text-center shadow-md" style="flex:1;">
<div>
<span class="font-semibold">إجمالي الفواتير المعروضة:</span>
<span id="filtered-total-amount" class="font-bold text-green-800">0 ج.م</span>
</div>
<div class="mt-1 text-sm text-green-900">
<span class="font-semibold">عدد الفواتير:</span>
<span id="filtered-total-count" class="font-bold">0</span>
</div>
</div>
</div>
</div>
<!-- Left slide-in drawer for Invoice Quick Search -->
<div id="invoice-quick-search-wrap" class="fixed z-40 left-0" style="top:120px;width:220px;">
<div id="invoice-quick-search-content" class="relative transition-transform duration-200 ease-out">
<div id="invoice-quick-search-panel" class="bg-white p-2 rounded-r-lg shadow-lg border border-gray-200" style="width:220px;">
<div style="display:flex;flex-direction:column;gap:6px;align-items:stretch;">
<div style="background:#111027;color:#fff;padding:6px 8px;border-radius:4px;text-align:center;font-weight:700;">Number<br><div id="invoice-val-number" style="font-size:14px;margin-top:4px;">--</div></div>
<div style="background:#f6d8bf;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Total<br><div id="invoice-val-total" style="font-weight:700;">--</div></div>
<div style="background:#f4cfa9;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Return<br><div id="invoice-val-return">--</div></div>
<div style="background:#eee2d6;color:#6b3b12;padding:6px 6px;border-radius:4px;text-align:center;">Net amount<br><div id="invoice-val-net">--</div></div>
<div style="background:#e6f3e9;color:#0b6b2d;padding:6px 6px;border-radius:4px;text-align:center;">C - Name<br><div id="invoice-val-cname">--</div></div>
<div style="background:#2b2b2b;color:#fff;padding:6px 6px;border-radius:4px;text-align:center;">Date<br><div id="invoice-val-date" style="font-size:14px;margin-top:4px;" dir="ltr" lang="ar">--</div></div>
<div style="text-align:center;margin-top:6px;">
<input id="invoice-search-input" type="text" inputmode="numeric" placeholder="رقم" class="w-full p-1 border rounded-md text-center text-sm" />
</div>
<div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">
<button id="invoice-search-btn" class="bg-blue-600 text-white px-2 py-1 rounded-md text-sm">بحث</button>
<button id="invoice-clear-btn" class="bg-gray-200 text-gray-700 px-2 py-1 rounded-md text-sm">مسح</button>
</div>
</div>
</div>
</div>
<!-- Lens handle (outside the sliding content so it remains visible) -->
<button id="invoice-quick-search-toggle" class="fixed left-0 bg-white border border-gray-300 rounded-full w-9 h-9 shadow flex items-center justify-center z-50" style="top:220px" title="بحث">
<i data-lucide="search" class="w-5 h-5 text-gray-700"></i>
</button>
</div>
<!-- Hidden thermal print root -->
<div id="thermal-print-root" style="display:none"></div>
<div id="sales-list" class="space-y-3"></div>
</div>
<!-- تمت إزالة شريط التصدير الضريبي حسب الطلب -->
<!-- Inquiry / استعلام عن مبيعات العملاء (فترة محددة + عملاء متعددين) -->
<div id="page-inquiry" class="page">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold flex items-center gap-2">
<i data-lucide="search" class="w-6 h-6 text-blue-600"></i>
<span>استعلام عن مبيعات العملاء</span>
</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4 text-sm items-start">
<div>
<label class="block font-semibold mb-1">من تاريخ</label>
<input id="inq-date-from" type="date" class="w-full p-2 border rounded" />
</div>
<div>
<label class="block font-semibold mb-1">إلى تاريخ</label>
<input id="inq-date-to" type="date" class="w-full p-2 border rounded" />
</div>
<div class="md:col-span-2">
<label class="block font-semibold mb-1">بحث عن عميل</label>
<input id="inq-customer-filter" type="text" placeholder="اكتب جزء من الاسم" class="w-full p-2 border rounded" />
<p class="text-[11px] text-gray-500 mt-1">استخدم Ctrl أو Shift للاختيار المتعدد في القائمة.</p>
</div>
<div class="md:col-span-2">
<label class="block font-semibold mb-1">العملاء المختارون</label>
<select id="inq-customers" multiple size="8" class="w-full p-2 border rounded"></select>
</div>
</div>
<div class="flex flex-wrap gap-3 mb-4">
<button id="inq-generate-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2 text-sm"><i data-lucide="play"></i> تنفيذ الاستعلام</button>
<button id="inq-print-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 flex items-center gap-2 text-sm"><i data-lucide="printer"></i> طباعة</button>
<button id="inq-image-btn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2 text-sm"><i data-lucide="image"></i> صورة</button>
</div>
<div id="inq-summary" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 text-sm"></div>
<div id="inq-report-wrapper" class="bg-white rounded-lg shadow p-3 overflow-auto">
<table id="inq-report-table" class="w-full text-xs border-collapse" style="direction:rtl;min-width:820px;">
<thead id="inq-report-head"></thead>
<tbody id="inq-report-body"></tbody>
</table>
<div class="mt-6" id="inq-customers-breakdown"></div>
</div>
</div>
<!-- Price Lists / قوائم الأسعار: صفحة مخصصة لعرض قائمة واحدة حسب الاختيار -->
<div id="page-price-lists" class="page">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold flex items-center gap-2">
<i data-lucide="badge-dollar-sign" class="w-6 h-6 text-amber-600"></i>
<span>قوائم الأسعار</span>
</h2>
</div>
<div class="bg-white rounded-lg shadow-sm p-3">
<div class="pl-controls grid grid-cols-1 md:grid-cols-7 gap-3 mb-4 text-sm items-end">
<div>
<label class="label block mb-1">طريقة الاختيار</label>
<select id="pl-filter-mode" class="w-full p-2 border rounded">
<option value="customer">حسب العميل</option>
<option value="priceList">حسب القائمة</option>
</select>
</div>
<div class="md:col-span-3">
<label class="label block mb-1">اختر العميل/القائمة</label>
<select id="pl-selector" class="w-full p-2 border rounded"></select>
</div>
<div>
<label class="label block mb-1">خصم % للقائمة</label>
<input id="pl-global-discount" type="number" min="0" max="100" step="0.01" value="0" class="w-full p-2 border rounded" />
</div>
<div class="flex items-end gap-2">
<button id="pl-print" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">طباعة</button>
<button id="pl-image" class="bg-indigo-600 text-white px-3 py-2 rounded text-sm">صورة</button>
</div>
</div>
<div class="sheet-header">
<div class="sheet-meta">
<span id="pl-date"></span>
</div>
<div class="sheet-title">قائمة أسعار المحلات</div>
<div class="sheet-meta">
<span id="pl-customer-name"></span>
</div>
</div>
<div id="pl-sheet-container" class="overflow-auto"></div>
<!-- قديمة: عرض جميع القوائم (لم يعد يستخدم، أبقيته للرجوع عند الحاجة) -->
<div id="all-price-lists-container" class="grid md:grid-cols-2 gap-4" style="display:none"></div>
</div>
</div>
<script>
(function(){
const CSS_ID='thermal-print-style';
function ensurePrintCss(){
if (document.getElementById(CSS_ID)) return;
const style=document.createElement('style');
style.id=CSS_ID;
style.textContent=`@media print {
body * { visibility: hidden !important; }
#thermal-print-root, #thermal-print-root * { visibility: visible !important; }
#thermal-print-root { position: absolute; left:0; top:0; width:80mm; padding:4px 2px; font-family: 'Cairo', Arial, sans-serif; font-size:12px; line-height:1.25; direction:rtl; }
#thermal-print-root .row { display:flex; justify-content:space-between; }
#thermal-print-root .center { text-align:center; }
#thermal-print-root hr { border:0; border-top:1px dashed #000; margin:4px 0; }
}
@page { margin:2mm; size:80mm auto; }`;
document.head.appendChild(style);
}
async function printAsImageForThermal(saleArg){ try {
let sale=saleArg;
if (!sale) {
sale=(window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
}
if (!sale) throw new Error('لا توجد فواتير للطباعة');
const tempDiv=document.createElement('div');
tempDiv.style.cssText='position:fixed;left:-9999px;top:0;width:280px;background:white;padding:8px;font-family:Cairo,Arial;direction:rtl;';
const customer=findCustomer(sale.customerId);
const dateStr=formatArabicDate(sale.date);
const custName=customer ? customer.name : 'عميل';
let itemsHtml='';
(sale.items||[]).forEach(it=> {
const p=findProduct(it.productId);
const name=(p ? p.name : (it.name || 'منتج')).substring(0, 20);
const qty=it.quantity || it.qty || 0;
const price=Number(it.price||0);
const total=qty * price * (1 - (it.discountPercent||0)/100);
itemsHtml +=`<div style="display:flex;justify-content:space-between;padding:1px 0;font-size:10px;"><span style="flex:1;">${name}</span><span style="width:30px;text-align:center;">${qty}</span><span style="width:60px;text-align:left;">${formatCurrency(total)}</span></div>`;
});
tempDiv.innerHTML=`<div style="text-align:center;border:2px solid #000;padding:6px;background:white;">
<div style="font-size:16px;font-weight:800;margin-bottom:2px;">Delente</div>
<div style="font-size:12px;font-weight:700;margin-bottom:6px;">فاتورة مبيعات</div>
<div style="border-top:1px dashed #000;margin:4px 0;"></div>
<div style="font-size:10px;text-align:right;line-height:1.4;">
<div style="display:flex;justify-content:space-between;"><span style="font-weight:600;">${sale.invoiceNumber || sale.id}</span><span>: رقم</span></div>
<div style="display:flex;justify-content:space-between;"><span>${dateStr}</span><span>: التاريخ</span></div>
<div style="display:flex;justify-content:space-between;"><span>${custName.substring(0,20)}</span><span>: العميل</span></div>
</div>
<div style="border-top:1px dashed #000;margin:4px 0;"></div>
${itemsHtml}
<div style="border-top:2px solid #000;margin:6px 0;"></div>
<div style="font-size:13px;font-weight:800;display:flex;justify-content:space-between;">
<span>${formatCurrency(sale.total||0)} ج.م</span><span>: الإجمالي</span>
</div>
<div style="font-size:10px;display:flex;justify-content:space-between;margin:2px 0;">
<span>${formatCurrency((((sale.paidAmount !==undefined && sale.paidAmount !==null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0))} ج.م</span><span>: المدفوع</span>
</div>
<div style="font-size:10px;display:flex;justify-content:space-between;">
<span>${formatCurrency(((sale.total||0) - (((sale.paidAmount !==undefined && sale.paidAmount !==null) ? sale.paidAmount : ((sale.firstPayment || 0) + (sale.secondPayment || 0))) || 0)))} ج.م</span><span>: المتبقي</span>
</div>
<div style="border-top:1px dashed #000;margin:6px 0;"></div>
<div style="font-size:9px;text-align:center;">شكراً لتعاملكم معنا</div>
</div>`;
document.body.appendChild(tempDiv);
if (typeof html2canvas==='undefined') {
document.body.removeChild(tempDiv);
throw new Error('مكتبة html2canvas غير محملة');
}
const canvas=await html2canvas(tempDiv, {
backgroundColor: '#ffffff',
scale: 2,
logging: false,
width: 280
});
document.body.removeChild(tempDiv);
const w=window.open('', '', 'width=300,height=500');
if (!w) throw new Error('يرجى السماح بالنوافذ المنبثقة');
w.document.open();
w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>طباعة</title><style>@page{size:80mm auto;margin:0;}body{margin:0;padding:0;}img{width:100%;display:block;}</style></head><body><img src="${canvas.toDataURL('image/png')}"/></body></html>`);
w.document.close();
setTimeout(()=> { try{w.focus();w.print();}catch(_){} }, 300);
if('onafterprint' in w) w.onafterprint=()=> { try{w.close();}catch(_){} };
} catch(e) { 
console.error('Print failed:', e);
alert('فشل الطباعة: '+ (e.message || e)); 
}
}
async function printHtmlReceiptLatest(){
try {
const sale=(window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
if (!sale) throw new Error('لا توجد فواتير للطباعة');
const html=(typeof buildReceiptHtml58mm==='function') ? buildReceiptHtml58mm(sale) : '';
const w=window.open('', '', 'width=500,height=700');
if (!w) { alert('يرجى السماح بالنوافذ المنبثقة للطباعة'); return; }
w.document.open();
w.document.write(html);
w.document.close();
const doPrint=()=>{ try{ w.focus(); }catch(_){} try{ w.print(); }catch(_){} };
if ('onload' in w) { w.onload=()=> setTimeout(doPrint, 100); } else { setTimeout(doPrint, 300); }
if ('onafterprint' in w) { w.onafterprint=()=>{ try{ w.close(); }catch(_){} }; }
} catch(e){ alert('فشل الطباعة العادية: '+ e.message); }
}
window.printAsImageForThermal=printAsImageForThermal;
window.printHtmlReceiptLatest=printHtmlReceiptLatest;
})();
(function(){
window.smartMobilePrintInvoice=async function(sale){
try {
const isAndroid=/Android/i.test(navigator.userAgent || '');
const hasArabic=/[\u0600-\u06FF]/.test(JSON.stringify(sale||{}));
if (isAndroid && typeof window.printViaRawBT==='function') {
try { window.printViaRawBT(sale); return; } catch(_){}
}
if (hasArabic && typeof window.printAsImageForThermal==='function') {
try { await window.printAsImageForThermal(sale); return; } catch(_){}
}
if (typeof window.printHtmlReceiptLatest==='function') {
try { window.printHtmlReceiptLatest(); return; } catch(_){}
}
if (typeof window.printInvoiceViaBluetooth==='function') {
try { await window.printInvoiceViaBluetooth(sale); return; } catch(_){}
}
if (typeof window.printInvoiceBluetooth==='function') {
try { await window.printInvoiceBluetooth(sale); return; } catch(_){}
}
alert('لا توجد طريقة طباعة متاحة حالياً');
} catch(e){ console.warn('smartMobilePrintInvoice failed', e); }
};
})();
function buildEscPosReceipt(sale){
const enc=new TextEncoder();
const lines=[];
const center=(t)=>"\x1B\x61\x01"+t+"\n"; 
const left=(t)=>"\x1B\x61\x00"+t+"\n"; 
lines.push(center("*** فاتورة بيع ***"));
if (sale && sale.invoiceNumber) lines.push(center("رقم: "+sale.invoiceNumber));
if (sale && sale.date) lines.push(left("التاريخ: "+(sale.date.split('T')[0])));
if (sale && sale.customerName) lines.push(left("العميل: "+sale.customerName));
lines.push(left("------------------------------"));
if (sale && Array.isArray(sale.items)){
sale.items.forEach(it=>{
const name=(it.name||it.productName||it.productId||"صنف").slice(0,12);
const qty=it.qty || it.quantity || 0;
const price=it.price || it.unitPrice || 0;
const total=(qty*price).toFixed(2);
lines.push(left(name+" "+qty+"x"+price+"="+total));
});
}
lines.push(left("------------------------------"));
const totalAmt=sale ? (sale.total || sale.net || sale.amount || 0) : 0;
lines.push(center("الإجمالي: "+Number(totalAmt).toFixed(2)+" ج.م"));
lines.push(center("شكراً لكم"));
lines.push("\n\n\x1D\x56\x00");
const all=lines.join("");
return enc.encode(all);
}
async function bluetoothPrintLatest(){
if (!('bluetooth' in navigator)){
alert('المتصفح لا يدعم Web Bluetooth (جرب Chrome أو Edge على أندرويد).');
return;
}
const sale=(window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
const payload=buildEscPosReceipt(sale);
const SERVICE_UUIDS=[0xFFE0,'0000ffe0-0000-1000-8000-00805f9b34fb','0000ff00-0000-1000-8000-00805f9b34fb'];
const CHAR_UUIDS=['ffe1','0000ffe1-0000-1000-8000-00805f9b34fb','0000ff01-0000-1000-8000-00805f9b34fb'];
let device;
try {
device=await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices: SERVICE_UUIDS });
} catch(e){
alert('تعذر اختيار جهاز بلوتوث: '+ e.message);
return;
}
let gatt;
try { gatt=await device.gatt.connect(); } catch(e){ alert('فشل الاتصال بالطابعة: '+e.message); return; }
let characteristic=null;
for (const su of SERVICE_UUIDS){
try {
const service=await gatt.getPrimaryService(su);
for (const cu of CHAR_UUIDS){
try {
characteristic=await service.getCharacteristic(cu);
if (characteristic) break;
} catch(_){ }
}
if (characteristic) break;
} catch(_){ }
}
if (!characteristic){
alert('لم يتم العثور على خاصية الكتابة للطابعة (جرب تحديث قائمة UUID أو تأكد أن الطابعة BLE).');
try { gatt.disconnect(); } catch(_){ }
return;
}
try {
const CHUNK=20;
for (let i=0;i<payload.length;i+=CHUNK){
const slice=payload.slice(i,i+CHUNK);
await characteristic.writeValue(slice);
await new Promise(r=>setTimeout(r,12));
}
alert('تم إرسال الفاتورة للطابعة (بلوتوث).');
} catch(e){
console.error('Bluetooth write failed', e);
alert('فشل إرسال البيانات للطابعة: '+ e.message);
} finally {
try { gatt.disconnect(); } catch(_){ }
}
}
document.addEventListener('DOMContentLoaded', ()=>{
const btBtn=document.getElementById('sales-bt-print-btn');
if (btBtn) btBtn.addEventListener('click', bluetoothPrintLatest);
const quickPrintBtn=document.getElementById('sales-quick-print-btn');
if (quickPrintBtn) quickPrintBtn.addEventListener('click', async ()=> {
const latestSale=(window.state && Array.isArray(state.sales) && state.sales[0]) ? state.sales[0] : null;
if (!latestSale) {
alert('لا توجد فاتورة للطباعة');
return;
}
if (typeof window.printAsImageForThermal==='function') {
try { await window.printAsImageForThermal(latestSale); } catch(e){ alert('تعذر الطباعة كصورة: '+(e&&e.message)); }
} else if (typeof window.printHtmlReceiptLatest==='function') {
window.printHtmlReceiptLatest();
} else if (typeof printInvoiceViaBluetooth==='function') {
await printInvoiceViaBluetooth(latestSale);
} else {
alert('دالة الطباعة غير متوفرة');
}
});
const htmlBtn=document.getElementById('sales-html-print-btn');
if (htmlBtn) htmlBtn.addEventListener('click', window.printHtmlReceiptLatest);
const scrollBtn=document.getElementById('scroll-to-bottom-btn');
if (scrollBtn) {
scrollBtn.addEventListener('click', ()=> {
const salesList=document.getElementById('sales-list');
if (salesList) {
window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
}
});
}
});
document.addEventListener('DOMContentLoaded', function(){
const wrap=document.getElementById('invoice-quick-search-wrap');
const content=document.getElementById('invoice-quick-search-content');
const toggle=document.getElementById('invoice-quick-search-toggle');
if (!wrap || !content || !toggle) return;
let open=false; 
function apply(){
content.style.transform=open ? 'translateX(0%)' : 'translateX(-100%)';
}
toggle.addEventListener('click', function(){ open=!open; apply(); try { updateIcons(); } catch(_){} });
apply();
try { wrap.style.zIndex='50'; } catch(_){}
});
document.addEventListener('DOMContentLoaded', function(){
const input=document.getElementById('invoice-search-input');
const btn=document.getElementById('invoice-search-btn');
const clearBtn=document.getElementById('invoice-clear-btn');
function formatMoney(n){
try{ if (typeof formatCurrency==='function') return formatCurrency(n); }catch(e){}
if (n==null) return '0';
return (Number(n) || 0).toLocaleString();
}
function formatShortDate(val){
if (!val && val !==0) return '';
try {
if (typeof val==='string'){
if (val.indexOf('T') !==-1) return val.split('T')[0];
if (/^\d{4}-\d{2}-\d{2}/.test(val)) return val.slice(0,10);
if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
const parts=val.split('/').map(p=>Number(p));
const d=new Date(parts[2], parts[1]-1, parts[0]);
if (!isNaN(d)) return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
}
if (val instanceof Date) {
const d=val;
return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
const dd=new Date(val);
if (!isNaN(dd) && dd.getFullYear() > 1900) return dd.getFullYear() + '-' + String(dd.getMonth()+1).padStart(2,'0') + '-' + String(dd.getDate()).padStart(2,'0');
} catch(e) {}
return String(val);
}
function findInvoice(num){
if (!num) return null;
if (!window.state || !Array.isArray(state.sales)) return null;
const s=state.sales.find(item=> {
const candidates=[
item.invoiceNumber,
(item.invoice && item.invoice.number),
(item.invoice && item.invoice.id),
item.invoice,
item.id,
item.number,
item.ref,
item.invoice_no,
item.invoiceNumberString
];
return candidates.some(c=> c !=null && String(c)===String(num));
});
return s || null;
}
function renderResult(sale){
const dateEl=document.getElementById('invoice-result-date');
const custEl=document.getElementById('invoice-result-customer');
const totalEl=document.getElementById('invoice-result-total');
const typeEl=document.getElementById('invoice-result-type');
const noData=document.getElementById('invoice-no-data');
const vNumber=document.getElementById('invoice-val-number');
const vTotal=document.getElementById('invoice-val-total');
const vReturn=document.getElementById('invoice-val-return');
const vNet=document.getElementById('invoice-val-net');
const vCname=document.getElementById('invoice-val-cname');
const vDate=document.getElementById('invoice-val-date');
if(!sale){
if (dateEl) dateEl.textContent='--';
if (custEl) custEl.textContent='--';
if (totalEl) totalEl.textContent='--';
if (typeEl) typeEl.textContent='--';
if (vNumber) vNumber.textContent='--';
if (vTotal) vTotal.textContent='--';
if (vReturn) vReturn.textContent='--';
if (vNet) vNet.textContent='--';
if (vCname) vCname.textContent='--';
if (vDate) vDate.textContent='--';
return;
}
var cname='--';
try {
cname=sale.customerName || sale.clientName || sale.cname || sale.customer_name || sale.customer_fullname || sale.customerNameAr || sale.customer_name_ar || sale.partyName || sale.contactName || sale.contact_name || sale.buyerName || sale.customerDisplay || sale.customer || sale.client || sale.client_name || sale.clientName || cname;
if (cname && typeof cname==='object') {
var co=cname;
cname=co.name || co.fullName || co.displayName || co.title || (co.company && co.company.name) || co.customerName || co.customer_name || co.label || co.customerDisplay || '--';
}
if ((cname==='--' || cname==null || typeof cname==='number')) {
if (sale.customerObj && typeof sale.customerObj==='object') cname=sale.customerObj.name || sale.customerObj.fullName || sale.customerObj.displayName || cname;
if ((cname==='--' || cname==null || typeof cname==='number') && sale.client && typeof sale.client==='object') cname=sale.client.name || sale.client.displayName || cname;
if ((cname==='--' || cname==null || typeof cname==='number') && sale.account && typeof sale.account==='object') cname=sale.account.name || sale.account.title || cname;
}
if ((cname==='--' || cname==null || typeof cname==='number') && window.state && Array.isArray(window.state.customers)) {
var possibleIds=[sale.customerId, sale.customer_id, sale.clientId, sale.client_id, sale.customer_ref, sale.customerRef, sale.accountId, sale.account_id, sale.partyId, sale.party_id, sale.customerCode, sale.clientCode, sale.ref, sale.customerMobile, sale.customerPhone, sale.mobile, sale.phone, sale.taxNumber, sale.tax_number];
possibleIds=possibleIds.filter(x=> x !=null && x !=='');
var found=null;
if (possibleIds.length > 0) {
found=window.state.customers.find(function(c){
var keys=[c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode, c.mobile, c.phone, c.taxNumber, c.tax_number, c.phoneNumber, c.msisdn];
return possibleIds.some(function(pid){
return keys.some(function(k){ return k !=null && String(k)===String(pid); });
});
});
}
if (!found && sale.customerPhone) {
found=window.state.customers.find(function(c){ return String(c.mobile)===String(sale.customerPhone) || String(c.phone)===String(sale.customerPhone); });
}
if (!found && sale.customerMobile) {
found=window.state.customers.find(function(c){ return String(c.mobile)===String(sale.customerMobile) || String(c.phone)===String(sale.customerMobile); });
}
if (!found && sale.taxNumber) {
found=window.state.customers.find(function(c){ return String(c.taxNumber)===String(sale.taxNumber) || String(c.tax_number)===String(sale.taxNumber); });
}
if (found) {
cname=found.name || found.customerName || found.fullName || found.displayName || found.title || (found.company && found.company.name) || found.customer_name || cname;
}
}
try {
if ((cname==='--' || cname==null || typeof cname==='number' || cname==='غير معروف') && sale && (sale.customerId || sale.customer_id)) {
var cidVal=sale.customerId || sale.customer_id;
try {
if (typeof findCustomer==='function') {
var f=findCustomer(cidVal);
if (f && (f.name || f.customerName || f.displayName)) {
cname=f.name || f.customerName || f.fullName || f.displayName || cname;
}
}
} catch(e) { }
if ((cname==='--' || cname==null || cname==='غير معروف' || typeof cname==='number') && window.state && Array.isArray(window.state.customers)) {
var found2=window.state.customers.find(function(c){
return [c.id, c._id, c.customerId, c.customer_id, c.code, c.customerCode].some(function(k){ return k !=null && String(k)===String(cidVal); });
});
if (found2) cname=found2.name || found2.customerName || found2.displayName || found2.fullName || cname;
}
}
} catch (e) { }
if (cname && typeof cname==='object') {
cname=cname.name || cname.displayName || JSON.stringify(cname).slice(0,60) || 'غير معروف';
}
if (!cname || cname==='--') cname='غير معروف';
} catch (e) { cname='غير معروف'; }
vCname.textContent=(cname==null ? 'غير معروف' : cname);
if (vDate) {
var rawDate=sale.date || sale.createdAt || sale.timestamp || '';
vDate.textContent=rawDate ? formatShortDate(rawDate) : '--';
}
}
if (btn) btn.addEventListener('click', function(){
const v=input ? input.value.trim() : '';
if (!v) { renderResult(null); return; }
const res=findInvoice(v);
renderResult(res);
});
if (input) input.addEventListener('keydown', function(e){ if (e.key==='Enter') { e.preventDefault(); btn && btn.click(); } });
if (clearBtn) clearBtn.addEventListener('click', function(){ if (input) input.value=''; renderResult(null); });
renderResult(null);
try {
if (!window.state) window.state={};
if (!Array.isArray(window.state.sales)) window.state.sales=[];
if (window.state.sales.length===0) {
window.state.sales.push({
id: '148556',
invoiceNumber: '148556',
customerName: 'ماركت سفير',
total: 21252,
net: 21252,
isReturn: false,
date: '12/11/2025'
});
}
} catch (e) { console.warn('sample sale init failed', e); }
try {
const exportBtn=document.getElementById('invoice-export-btn');
const exportModal=document.getElementById('invoice-export-modal');
const exportTextarea=document.getElementById('invoice-export-textarea');
const exportClose=document.getElementById('invoice-export-close-btn');
const exportCopy=document.getElementById('invoice-export-copy-btn');
function showSaleObjectForCurrentInput(){
try{
const user=AuthSystem.getCurrentUser(); if (!user) return 'guest';
if (!num) {
exportTextarea.value='لم يتم تحديد رقم الفاتورة.';
} else {
(function(){
function bumpAndSave(){
try {
if (window.isUpdatingFromCloud) return; 
} catch(_){}
try {
if (!window.costLists) window.costLists={};
window.costLists.timestamp=new Date().toISOString();
} catch(_){ }
try {
if (typeof window.saveCostListsToFirebase==='function') {
window.saveCostListsToFirebase(window.costLists);
} else if (typeof window.saveCostListsDebounced==='function') {
window.saveCostListsDebounced();
}
} catch(e){ console.warn('bumpAndSave failed', e); }
}
try {
if (typeof window.updateRawGridState==='function' && !window.__patched_updateRawGridState){
const __orig=window.updateRawGridState;
window.updateRawGridState=function(){
try { __orig.apply(this, arguments); } catch(e){ console.warn('updateRawGridState orig failed', e); }
bumpAndSave();
};
window.__patched_updateRawGridState=true;
}
} catch(e){ }
try {
if (typeof window.updatePackagingGridState==='function' && !window.__patched_updatePackagingGridState){
const __orig=window.updatePackagingGridState;
window.updatePackagingGridState=function(){
try { __orig.apply(this, arguments); } catch(e){ console.warn('updatePackagingGridState orig failed', e); }
bumpAndSave();
};
window.__patched_updatePackagingGridState=true;
}
} catch(e){ }
})();
(function(){
try {
if (typeof window.tryLoadCostListsFromCloud==='function' && !window.__patched_tryLoadCostListsFromCloud){
const __origLoadCloud=window.tryLoadCostListsFromCloud;
window.tryLoadCostListsFromCloud=async function(){
const localTs=(window.costLists && window.costLists.timestamp) || null;
try {
const res=await __origLoadCloud.apply(this, arguments);
const justLoggedIn=!!(window.auth && auth.currentUser); 
const localEmpty=!window.costLists || (!Array.isArray(window.costLists.raw) && !Array.isArray(window.costLists.pack));
if (localEmpty || !localTs || justLoggedIn) {
try {
if (!window.__DISABLE_AUTO_SEED_COST_LISTS && typeof window.ensureRawAndPackFromState==='function') {
window.ensureRawAndPackFromState();
} else {
console.log('⏭️ Skipped ensureRawAndPackFromState (auto-seed disabled)');
}
} catch(_){ }
}
return res;
} catch(e){
console.warn('tryLoadCostListsFromCloud patched load failed; falling back to original behavior', e);
return __origLoadCloud.apply(this, arguments);
}
};
window.__patched_tryLoadCostListsFromCloud=true;
}
} catch(e){ }
})();
(function(){
try {
if (typeof window.renderFinishedProducts==='function' && !window.__patched_renderFinishedProducts){
const __origRenderFinished=window.renderFinishedProducts;
window.renderFinishedProducts=function(){
try { window._finishedGridState=JSON.parse(localStorage.getItem('finished_products_grid')||'{}') || {}; } catch(e){ if (!window._finishedGridState) window._finishedGridState={}; }
const result=__origRenderFinished.apply(this, arguments);
try {
const container=document.getElementById('finished-products-grid') || document;
container.removeEventListener && container.removeEventListener('__fp_input_dummy', function(){});
container.addEventListener('input', function(e){
const el=e.target;
if (!el || !el.dataset) return;
if (el.dataset.grid==='finished' && el.dataset.id && el.dataset.field){
const productId=el.dataset.id;
const field=el.dataset.field;
const value=parseFloat(el.value) || 0;
if (!window._finishedGridState[productId]) window._finishedGridState[productId]={};
window._finishedGridState[productId][field]=value;
try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){ }
try { if (typeof window.saveFinishedProductsDebounced==='function') window.saveFinishedProductsDebounced(); } catch(_){ }
}
});
} catch(e){ }
return result;
};
window.__patched_renderFinishedProducts=true;
}
} catch(e){ }
})();
(function(){
function forcePriceSave(itemName, value, listKey){
try {
if (!window.costLists) window.costLists={};
const arr=(listKey==='pack') ? (window.costLists.costPack || []) : (window.costLists.costRaw || []);
const costItem=Array.isArray(arr) ? arr.find(i=> i && i.name===itemName) : null;
if (costItem){
costItem.price=parseFloat(value) || 0;
costItem.lastPriceDate=new Date().toISOString();
window.costLists.timestamp=costItem.lastPriceDate;
try {
if (typeof window.forceFullCloudSync==='function') window.forceFullCloudSync();
else if (typeof window.saveCostListsToFirebase==='function') window.saveCostListsToFirebase(window.costLists);
} catch(_){ }
try { console.log('💰 Forced Price Save for:', itemName); } catch(_){ }
}
} catch(e){ console.warn('forcePriceSave failed', e); }
}
try {
if (typeof window.renderRawMaterials==='function' && !window.__patched_renderRawMaterials){
const __origRenderRaw=window.renderRawMaterials;
window.renderRawMaterials=function(){
const res=__origRenderRaw.apply(this, arguments);
try {
const container=document.getElementById('raw-materials-grid') || document;
container.addEventListener('input', function(e){
const el=e.target;
if (!el || !el.dataset) return;
if (el.dataset.grid==='raw' && el.dataset.field==='unitPrice' && el.dataset.name){
forcePriceSave(el.dataset.name, el.value, 'raw');
}
});
} catch(_){}
return res;
};
window.__patched_renderRawMaterials=true;
}
} catch(e){ }
try {
if (typeof window.renderPackaging==='function' && !window.__patched_renderPackaging){
const __origRenderPack=window.renderPackaging;
window.renderPackaging=function(){
const res=__origRenderPack.apply(this, arguments);
try {
const container=document.getElementById('packaging-grid') || document;
container.addEventListener('input', function(e){
const el=e.target;
if (!el || !el.dataset) return;
if (el.dataset.grid==='pack' && el.dataset.field==='unitPrice' && el.dataset.name){
forcePriceSave(el.dataset.name, el.value, 'pack');
}
});
} catch(_){}
return res;
};
window.__patched_renderPackaging=true;
}
} catch(e){ }
})();
(function(){
try {
if (typeof window.saveFinishedProductsDebounced !=='function'){
let __fpTimer=null; const DEBOUNCE_MS=800;
window.saveFinishedProductsDebounced=function(){
try { if (__fpTimer) clearTimeout(__fpTimer); } catch(_){ }
__fpTimer=setTimeout(async function(){
try {
if (window.db && typeof window.syncFinishedProductsToCloud==='function') {
await window.syncFinishedProductsToCloud(window._finishedGridState || {});
}
} catch(e){ console.warn('saveFinishedProductsDebounced sync failed', e); }
}, DEBOUNCE_MS);
};
}
document.addEventListener('input', function(e){
try {
const el=e.target;
if (!el || !el.dataset) return;
if (el.dataset.grid==='finished' && el.dataset.id && el.dataset.field){
const productId=el.dataset.id;
const field=el.dataset.field;
const val=parseFloat(el.value) || 0;
if (!window._finishedGridState) window._finishedGridState={};
if (!window._finishedGridState[productId]) window._finishedGridState[productId]={};
window._finishedGridState[productId][field]=val;
try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){ }
try { if (typeof window.saveFinishedProductsDebounced==='function') window.saveFinishedProductsDebounced(); } catch(_){ }
}
} catch(err){ }
});
} catch(e){ }
})();
const sale=findInvoice(num) || null;
exportTextarea.value=sale ? JSON.stringify(sale, null, 2) : 'لم يتم العثور على فاتورة برقم: ' + num;
}
exportModal.style.display='block';
exportTextarea.select();
}catch(e){ exportTextarea.value='خطأ أثناء تجهيز الكائن:\n'+String(e); exportModal.style.display='block'; }
}
if (exportBtn) exportBtn.addEventListener('click', function(){ showSaleObjectForCurrentInput(); });
if (exportClose) exportClose.addEventListener('click', function(){ exportModal.style.display='none'; });
if (exportCopy) exportCopy.addEventListener('click', function(){ try{ exportTextarea.select(); document.execCommand('copy'); exportCopy.textContent='تم النسخ'; setTimeout(()=> exportCopy.textContent='نسخ', 1200); }catch(e){ alert('نسخ لم ينجح، انسخ النص يدوياً.'); } });
} catch (e) { console.warn('invoice export wiring failed', e); }
});
</script>
<script>
(function(){
if (typeof window.INVOICE_PANEL_OFFSET_TOP==='undefined') {
window.INVOICE_PANEL_OFFSET_TOP=48; 
}
function positionInvoicePanel(){
try{
const totalEl=document.getElementById('invoice-result-total');
const panel=document.getElementById('invoice-quick-search-panel') || document.getElementById('invoice-quick-search-global') || document.getElementById('invoice-quick-search-wrap');
if (!totalEl || !panel) return;
let rect=null;
try { rect=totalEl.getBoundingClientRect(); } catch(e){ rect=null; }
panel.style.position='fixed';
panel.style.zIndex='2147483646';
panel.style.maxHeight='calc(100vh - 120px)';
try {
var headerEl=document.querySelector('header');
var headerBottom=headerEl ? headerEl.getBoundingClientRect().bottom : 56;
var topFromTotals=rect ? rect.top : (headerBottom + 8);
var topVal=Math.max((headerBottom + 8), topFromTotals + 0) + (window.INVOICE_PANEL_OFFSET_TOP||0);
panel.style.top=(Math.round(topVal) || 64) + 'px';
} catch(e) { panel.style.top='64px'; }
try {
panel.style.left='12px';
panel.style.right='auto';
} catch(e) {
try { panel.style.left='12px'; } catch(_){}
}
}catch(e){ console.warn('positionInvoicePanel failed', e); }
}
window.addEventListener('load', function(){ setTimeout(positionInvoicePanel, 50); });
window.addEventListener('resize', function(){ setTimeout(positionInvoicePanel, 60); });
window.addEventListener('scroll', function(){ setTimeout(positionInvoicePanel, 120); });
window.positionInvoicePanel=positionInvoicePanel;
})();
</script>
<div id="page-dispatch" class="page">
<!-- Local tabs inside dispatch page -->
<div class="mb-4 flex gap-2 no-print" style="display:flex;gap:8px;margin-bottom:16px;">
<button id="dispatch-notes-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#3b82f6;color:white;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">الأذونات</button>
<button id="receipt-local-tab-btn" class="dispatch-local-tab-btn" style="padding:8px 16px;background-color:#d1d5db;color:#374151;border-radius:6px 6px 0 0;cursor:pointer;font-weight:600;border:none;">كشف التحصيل</button>
</div>
<!-- Tab content: الأذونات -->
<div id="dispatch-notes-tab-content" class="dispatch-local-tab-content" style="display:block;">
<div id="new-dispatch-note-section" class="bg-gray-100 p-4 rounded-lg border mb-6">
<h3 class="text-lg font-bold mb-3">إضافة إذن استلام جديد</h3>
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
<div>
<label for="new-dispatch-note-number" class="block text-sm font-medium text-gray-700">رقم الإذن (يدوي)</label>
<input type="number" id="new-dispatch-note-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
<div>
<label for="new-dispatch-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
<select id="new-dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
</div>
<div>
<label for="new-dispatch-date" class="block text-sm font-medium text-gray-700">تاريخ الإذن</label>
<input type="date" id="new-dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
</div>
<div class="overflow-x-auto bg-white rounded-lg shadow mt-4 border">
<table id="new-dispatch-items-table" class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">المنتج</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مستلم (كمية)</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع سليم</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع تالف</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مجاني</th>
<th class="px-2 py-2"></th>
</tr>
</thead>
<tbody id="new-dispatch-items-container" class="divide-y divide-gray-200">
<!-- New item rows will be injected here -->
</tbody>
</table>
</div>
<div class="mt-3 flex justify-between items-center">
<button type="button" id="add-new-dispatch-item-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
<i data-lucide="plus-circle" class="w-4 h-4"></i>
إضافة صنف
</button>
<button type="button" id="save-new-dispatch-note-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
<i data-lucide="save" class="w-5 h-5"></i>
حفظ الإذن الجديد
</button>
</div>
</div>
<!-- Divider -->
<hr class="my-6 border-t-2 border-dashed">
<!-- Existing Dispatch Notes List -->
<h3 class="text-lg font-bold mb-3">الأذونات السابقة</h3>
<div id="dispatch-notes-list" class="space-y-4"></div>
<!-- ملخص أصناف المندوب (عرض فقط) -->
<div id="rep-dispatch-summary" class="hidden mt-8 bg-white border rounded-lg p-4">
<h4 class="font-bold mb-3 flex items-center gap-2 text-indigo-700"><i data-lucide="clipboard-list" class="w-5 h-5"></i> ملخص البضاعة الحالية</h4>
<div id="rep-dispatch-summary-content" class="text-sm"></div>
</div>
</div> <!-- end dispatch-notes-tab-content -->
<!-- Tab content: كشف التحصيل -->
<div id="receipt-local-tab-content" class="dispatch-local-tab-content" style="display:none;">
<h2 class="text-xl font-bold mb-4">كشف التحصيل</h2>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
<!-- Left: Receipt List -->
<div class="lg:col-span-2">
<div class="bg-white p-4 rounded shadow-md">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<div>
<label class="block text-sm font-medium mb-2">من تاريخ:</label>
<input type="date" id="receipt-from-date-local" class="w-full p-2 border rounded">
</div>
<div>
<label class="block text-sm font-medium mb-2">إلى تاريخ:</label>
<input type="date" id="receipt-to-date-local" class="w-full p-2 border rounded">
</div>
<div>
<label class="block text-sm font-medium mb-2"></label>
<button id="receipt-filter-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">تطبيق الفلاتر</button>
</div>
</div>
<div class="overflow-x-auto bg-white rounded-lg shadow">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border p-2 text-right">التاريخ</th>
<th class="border p-2 text-right">رقم الفاتورة</th>
<th class="border p-2 text-right">العميل</th>
<th class="border p-2 text-right">نوع التحصيل</th>
<th class="border p-2 text-right">المبلغ</th>
<th class="border p-2 text-right">الحالة</th>
</tr>
</thead>
<tbody id="receipt-table-body-local" class="text-sm"></tbody>
</table>
</div>
<div class="mt-4 p-4 bg-gray-50 rounded border">
<div class="grid grid-cols-3 gap-4 text-lg font-bold">
<div>الإجمالي: <span id="receipt-total-local" class="text-green-600">0</span></div>
<div>العدد: <span id="receipt-count-local" class="text-blue-600">0</span></div>
<div>المتوسط: <span id="receipt-avg-local" class="text-purple-600">0</span></div>
</div>
</div>
</div>
</div>
<!-- Right: Rep Receipt Form -->
<div class="lg:col-span-1">
<div class="bg-white p-4 rounded shadow-md sticky top-20">
<h3 class="text-lg font-bold mb-4 text-right">النسريات والمصروفات</h3>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">اختر المندوب:</label>
<select id="receipt-rep-dropdown-local" class="w-full p-2 border rounded text-right">
<option value="">-- اختر المندوب --</option>
</select>
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">النسريات:</label>
<input type="number" id="rep-credit-transactions-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">المصروفات:</label>
<input type="number" id="rep-expenses-local" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">ملاحظات:</label>
<textarea id="rep-notes-local" class="w-full p-2 border rounded text-right" rows="4" placeholder="ملاحظات إضافية..."></textarea>
</div>
<div class="flex flex-col gap-2">
<button id="receipt-print-btn-local" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold">طباعة كشف التحصيل</button>
<button id="receipt-save-btn-local" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">حفظ البيانات</button>
</div>
</div>
</div>
</div>
</div> <!-- end receipt-local-tab-content -->
</div>
<!-- RE-ACTIVATED REPORTS PAGE -->
<div id="page-reports" class="page" style="padding-bottom: 50px;">
<h2 class="text-xl font-bold mb-4 no-print">التقارير التفصيلية</h2>
<div id="report-filter-container" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
<!-- Daily Report Content -->
<div data-report-content="daily" class="space-y-4 active">
<h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير المبيعات اليومي</h3>
<div class="grid grid-cols-2 md:grid-cols-3 gap-4">
<div>
<label for="daily-report-date" class="block text-sm font-medium text-gray-700">التاريخ:</label>
<input type="date" id="daily-report-date" class="mt-1 block w-full p-2 border rounded-md">
</div>
<div>
<label for="daily-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
<select id="daily-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
</div>
<div>
<label for="daily-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
<select id="daily-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
</div>
</div>
<button id="generate-daily-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض التقرير اليومي</button>
</div>
<!-- Date Range Report Content (Hidden by default) -->
<div data-report-content="range" class="space-y-4 hidden">
<h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير مبيعات فترة زمنية</h3>
<!-- Reuse date range form logic but simplified -->
<div class="grid grid-cols-2 md:grid-cols-3 gap-4">
<div>
<label for="range-start-date" class="block text-sm font-medium text-gray-700">من تاريخ:</label>
<input type="date" id="range-start-date" class="mt-1 block w-full p-2 border rounded-md">
</div>
<div>
<label for="range-end-date" class="block text-sm font-medium text-gray-700">إلى تاريخ:</label>
<input type="date" id="range-end-date" class="mt-1 block w-full p-2 border rounded-md">
</div>
<div>
<label for="range-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
<select id="range-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
</div>
</div>
<div>
<label for="range-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
<select id="range-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
</div>
<button id="generate-range-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض تقرير الفترة</button>
</div>
<!-- Monthly Report Content (Hidden by default) -->
<div data-report-content="monthly" class="space-y-4 hidden">
<h3 class="font-bold text-lg text-red-600 border-b pb-2">ملخص المبيعات الشهري</h3>
<div class="grid grid-cols-2 md:grid-cols-3 gap-4">
<div>
<label for="monthly-report-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
<input type="month" id="monthly-report-month" class="mt-1 block w-full p-2 border rounded-md">
</div>
<div>
<label for="monthly-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
<select id="monthly-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
</div>
<div>
<label for="monthly-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
<select id="monthly-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
</div>
</div>
<button id="generate-monthly-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض التقرير الشهري</button>
</div>
<!-- Reconciliation Report Content (Hidden by default) -->
<div data-report-content="reconciliation" class="space-y-4 hidden">
<h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير التسوية (العجز والزيادة)</h3>
<div class="grid grid-cols-2 md:grid-cols-3 gap-4">
<div>
<label for="recon-report-date" class="block text-sm font-medium text-gray-700">تاريخ إذن الاستلام:</label>
<input type="date" id="recon-report-date" class="mt-1 block w-full p-2 border rounded-md">
</div>
<div>
<label for="recon-report-rep" class="block text-sm font-medium text-gray-700">المندوب:</label>
<select id="recon-report-rep" class="mt-1 block w-full p-2 border rounded-md"></select>
</div>
<div>
<label for="recon-report-chain" class="block text-sm font-medium text-gray-700">السلسلة:</label>
<select id="recon-report-chain" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
</div>
</div>
<button id="generate-recon-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">إنشاء تقرير التسوية</button>
</div>
<div data-report-content="targets" class="space-y-4 hidden">
<h3 class="font-bold text-lg text-red-600 border-b pb-2">تقرير تحقيق التارجت الشهري لكل مندوب</h3>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div>
<label for="targets-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
<input type="month" id="targets-month" class="mt-1 block w-full p-2 border rounded-md" />
</div>
<div>
<label for="targets-rep-filter" class="block text-sm font-medium text-gray-700">بحث مندوب (اختياري):</label>
<select id="targets-rep-filter" class="mt-1 block w-full p-2 border rounded-md">
<option value="all">عرض كل المناديب</option>
</select>
</div>
<div>
<label for="targets-chain-filter" class="block text-sm font-medium text-gray-700">السلسلة:</label>
<select id="targets-chain-filter" class="mt-1 block w-full p-2 border rounded-md"><option value="">جميع السلاسل</option></select>
</div>
</div>
<button id="generate-targets-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">عرض تقرير التارجت</button>
<p class="text-xs text-gray-600">يعرض الجدول صافي المبيعات اليومية لكل مندوب، ومقارنة الشهر بالتارجت مع النسبة المفترضة حتى تاريخ اليوم والنسبة المحققة الفعلية.</p>
</div>
<div data-report-content="customer-targets" class="space-y-4 hidden">
<h3 class="font-bold text-lg text-red-600 border-b pb-2">تارجت العملاء (اكسبشن / سفير / الضحى)</h3>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div>
<label for="customer-targets-month" class="block text-sm font-medium text-gray-700">الشهر:</label>
<input type="month" id="customer-targets-month" class="mt-1 block w-full p-2 border rounded-md" />
</div>
<div>
<label for="customer-targets-category" class="block text-sm font-medium text-gray-700">الفئة:</label>
<select id="customer-targets-category" class="mt-1 block w-full p-2 border rounded-md">
<option value="multi">مالتي</option>
<option value="dairy">البان</option>
<option value="both" selected>الاثنين معاً</option>
</select>
</div>
</div>
<button id="generate-customer-targets-report-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold mb-4">عرض تقرير التارجت</button>
<div class="flex gap-3">
<button id="save-customer-targets-btn" type="button" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">حفظ التارجت</button>
<button id="refresh-customer-targets-btn" type="button" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">تحديث التقرير</button>
</div>
<p class="text-xs text-gray-600">عدل قيم التارجت في الخلايا ثم اضغط حفظ. التقرير يحسب المحقق والمتبقي ونسبة الإنجاز لكل عميل حسب الفئة المختارة.</p>
<div id="customer-targets-report-output" class="mt-2"></div>
</div>
</div>
<div id="report-output-area" class="mt-6">
<p class="text-center text-gray-500 mt-8">اختر نوع التقرير واضغط "عرض" للبدء.</p>
</div>
</div>
<!-- END RE-ACTIVATED REPORTS PAGE -->
<!-- ########## PROMOTIONS PAGE ########## -->
<div id="page-promotions" class="page">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold">العروض الترويجية</h2>
<div class="flex items-center gap-2">
<!-- Notify dropdown (اخطار) -->
<div class="relative" id="promotions-notify-root">
<button id="promotions-notify-btn" class="bg-white border px-3 py-1 rounded-md text-sm flex items-center gap-2" aria-haspopup="true" aria-expanded="false">
<span class="text-sm font-semibold">اخطار</span>
<svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
</button>
<div id="promotions-notify-menu" class="hidden absolute right-0 mt-2 w-52 bg-white border rounded shadow-lg z-50">
<button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="prices">اخطار باسعار اصناف</button>
<button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="new-item">اخطار بصنف جديد</button>
<button class="w-full text-right px-3 py-2 hover:bg-gray-50 notify-option" data-notify-type="promotions">اخطار بعروض</button>
</div>
</div>
<button id="add-promotion-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 flex items-center gap-2">
<i data-lucide="percent"></i>
<span>إضافة عرض جديد</span>
</button>
</div>
</div>
<div class="flex items-center gap-3 mb-3">
<button id="promotions-view-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm">العروض</button>
<button id="notifications-view-btn" class="px-3 py-1 bg-white text-gray-700 rounded-md text-sm border">الاخطارات</button>
</div>
<!-- Batch Promotions Editor (Create many rows exactly like screenshot) -->
<div class="bg-white border rounded-md p-3 mb-4">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center gap-3">
<label class="text-sm">العميل</label>
<select id="batch-promo-customer" class="p-2 border rounded-md min-w-[220px]"></select>
<label class="text-sm">من</label>
<input id="batch-promo-from" type="date" class="p-2 border rounded-md">
<label class="text-sm">إلى</label>
<input id="batch-promo-to" type="date" class="p-2 border rounded-md">
</div>
<div class="flex items-center gap-2">
<button id="batch-promo-add-row" class="px-3 py-1 bg-amber-600 text-white rounded-md text-sm">إضافة صف</button>
<button id="batch-promo-save" class="px-3 py-1 bg-green-600 text-white rounded-md text-sm">حفظ العروض</button>
</div>
</div>
<div class="overflow-x-auto">
<table class="min-w-full" id="batch-promo-table" style="border-collapse:separate;border-spacing:0 6px;">
<thead>
<tr>
<th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Price</th>
<th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">To</th>
<th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">From</th>
<th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Item Name</th>
<th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Code</th>
<th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">Customer Name</th>
<th class="px-2 py-2 text-center font-bold" style="background:#000;color:#ffd54f;border-bottom:3px solid #333">حذف</th>
</tr>
</thead>
<tbody id="batch-promo-rows"></tbody>
</table>
</div>
<p class="text-xs text-gray-500 mt-2">أدخل كود الصنف والسعر؛ سيتم تطبيق العرض تلقائياً على الفترة المحددة ثم يعود السعر الطبيعي بعد انتهائها.</p>
</div>
<div id="promotions-list" class="space-y-3">
<p class="text-gray-500 text-center mt-8">لا توجد عروض مسجلة حالياً.</p>
</div>
<div id="notifications-list" class="space-y-3 hidden">
<p class="text-gray-500 text-center mt-8">لا توجد اخطارات بعد. استخدم زر "اخطار" لإنشاء واحد.</p>
</div>
</div>
<!-- ########## END PROMOTIONS PAGE ########## -->
<div id="page-customers" class="page">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold">قائمة العملاء</h2>
<div class="flex items-center gap-2">
<button id="add-chain-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg shadow hover:bg-gray-300 flex items-center gap-2 text-sm">
<i data-lucide="layers"></i>
<span>إضافة سلسلة</span>
</button>
<button id="add-customer-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
<i data-lucide="user-plus"></i>
<span>إضافة عميل</span>
</button>
</div>
</div>
<div id="chains-display" class="mb-4"></div>
<input id="search-customers" type="text" placeholder="ابحث عن عميل..." class="w-full p-2 border rounded-md mb-4">
<div id="customers-list" class="space-y-3"></div>
</div>
<div id="page-reps" class="page">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold">إدارة المناديب</h2>
<button id="add-rep-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
<i data-lucide="user-plus"></i>
<span>إضافة مندوب</span>
</button>
</div>
<div id="reps-list" class="space-y-3"></div>
</div>
<!-- ########## SPREADSHEET ENTRY PAGE (إدخال سريع) ########## -->
<div id="page-spreadsheet-entry" class="page">
<h2 class="text-lg font-bold mb-4">إدخال سريع لعمليات البيع</h2>
<div class="bg-gray-100 p-3 rounded-lg border mb-4">
<!-- Modified grid layout to accommodate the new field -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
<div>
<label for="spreadsheet-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
<select id="spreadsheet-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
</div>
<div>
<label for="spreadsheet-customer" class="block text-sm font-medium text-gray-700">العميل</label>
<select id="spreadsheet-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
</div>
<div>
<label for="spreadsheet-date" class="block text-sm font-medium text-gray-700">تاريخ الفواتير</label>
<input type="date" id="spreadsheet-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
<!-- NEW: Unified Invoice Number Field -->
<div>
<label for="unified-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة (موحد)</label>
<input type="number" id="unified-invoice-number" class="mt-1 block w-full p-2 border border-blue-400 bg-blue-50 rounded-md font-bold" placeholder="تطبيق على كل الصفوف">
</div>
<!-- END NEW -->
</div>
</div>
<div class="overflow-x-auto shadow rounded-lg border">
<table id="spreadsheet-entry-table" class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50 sticky top-0">
<tr>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">رقم الفاتورة</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">الكود</th> <!-- NEW CODE COLUMN -->
<th class="px-2 py-2 text-right text-xs font-medium text-gray-500 uppercase min-w-[150px]">الصنف</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">الكمية</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">السعر</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">سعر معدل</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px]">خصم %</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">القسم</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[100px]">التحصيل</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[70px] spreadsheet-tax-header" style="display: none;">المنظومة</th> <!-- NEW TAX FILING COLUMN -->
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase min-w-[80px]">الإجمالي</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase"></th> <!-- Delete button -->
</tr>
</thead>
<tbody id="spreadsheet-entry-body" class="bg-white divide-y divide-gray-200">
<!-- Rows will be added by JS -->
</tbody>
</table>
</div>
<div class="mt-4 flex justify-between items-center flex-wrap gap-3">
<button id="spreadsheet-add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-1 text-sm">
<i data-lucide="plus" class="w-4 h-4"></i>
<span>إضافة صف جديد</span>
</button>
<button id="spreadsheet-save-all-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold flex items-center gap-2">
<i data-lucide="save" class="w-5 h-5"></i>
<span>حفظ كل المدخلات</span>
</button>
</div>
</div>
<!-- ########## END SPREADSHEET ENTRY PAGE ########## -->
<!-- ########## DEBTS PAGE (المديونيات) ########## -->
<div id="page-debts" class="page" style="display: none;">
<!-- Tabs for Debts and Collection Receipt -->
<div class="mb-4 flex gap-2 no-print" style="display: flex; gap: 8px; margin-bottom: 16px;">
<button id="debts-tab-btn" class="debts-tab-button active" style="padding: 8px 16px; background-color: #3b82f6; color: white; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; border: none;">المديونيات</button>
<button id="receipt-debts-tab-btn" class="debts-tab-button" style="padding: 8px 16px; background-color: #d1d5db; color: #374151; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; border: none;">كشف التحصيل</button>
</div>
<!-- Debts Tab Content -->
<div id="debts-tab-content" class="debts-tab-content active">
<div class="mb-4 flex flex-col items-end">
<h1 class="text-2xl font-bold text-right flex items-center gap-2">
<i data-lucide="file-warning" class="w-7 h-7 text-amber-600"></i>
<span>مديونيات المناديب</span>
</h1>
<p class="text-sm text-gray-600 text-right flex items-center gap-1">
<span>عرض وإدارة المديونيات</span>
</p>
</div>
<!-- debug banner removed -->
<div class="debts-container mb-6">
<!-- Left sidebar: actions + stacked summary cards -->
<aside class="debts-sidebar">
<div class="debts-actions">
<button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-print-btn">
<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
</svg>
<span class="ml-1">طباعة</span>
</button>
<button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50" id="debts-csv-btn">
<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
</svg>
<span class="ml-1">تحميل CSV</span>
</button>
<!-- Quick navigation: show reps/customers directly from debts page -->
<button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-reps-btn" title="عرض جميع المناديب">
<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11c1.657 0 3-1.343 3-3S17.657 5 16 5s-3 1.343-3 3 1.343 3 3 3zM8 11c1.657 0 3-1.343 3-3S9.657 5 8 5 5 6.343 5 8s1.343 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zM16 13c-.29 0-.62.02-.97.05C15.7 13.35 17 14.5 17 16v3h5v-2.5C22 14.17 17.33 13 16 13z"/></svg>
<span class="ml-1">عرض المناديب</span>
</button>
<button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-show-customers-btn" title="عرض جميع العملاء">
<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.62 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0zM19.938 7.124A4 4 0 1116 3a4 4 0 013.938 4.124z"/></svg>
<span class="ml-1">عرض العملاء</span>
</button>
<button class="flex items-center p-2 text-sm bg-white border rounded-md hover:bg-gray-50 mt-2" id="debts-refresh-btn" title="تحديث المديونيات">
<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M20 4v6h-6M4 20v-6h6"/></svg>
<span class="ml-1">تحديث</span>
</button>
</div>
<!-- Debug banner removed as per user request -->
<div class="debt-card">
<div class="title">SUB TOTAL</div>
<div id="debts-subtotal" class="value">91,295 ج.م</div>
</div>
<div class="debt-card">
<div class="title">المسدد</div>
<div id="debts-paid" class="value">76,336 ج.م</div>
</div>
<div class="debt-card">
<div class="title">عدد الفواتير</div>
<div id="debts-invoices-count" class="value">14,959</div>
</div>
<div class="debt-card big">
<div class="title">المديونيات</div>
<div id="debts-total-debt" class="value">2,025 ج.م</div>
</div>
</aside>
<!-- Right main area: filters + table -->
<section class="debts-main">
<!-- Search Filters -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
<div>
<label class="block mb-1 text-sm">بحث باسم العميل</label>
<!-- Show only customers who have invoices (either paid or due) -->
<select id="debt-customer-filter" class="w-full p-2 border rounded-md text-sm filter-input">
<option value="">جميع العملاء</option>
</select>
</div>
<div>
<label class="block mb-1 text-sm">بحث باسم المندوب</label>
<select id="debt-rep-filter" class="w-full p-2 border rounded-md text-sm bg-white filter-input">
<option value="">جميع المناديب</option>
<option value="5/11/25">5/11/25</option>
<option value="7/11/25">7/11/25</option>
<option value="">ترتيب حسب المندوب</option>
</select>
</div>
<div>
<label class="block mb-1 text-sm">من تاريخ</label>
<input type="date" id="debt-start-date" class="w-full p-2 border rounded-md text-sm filter-input">
</div>
<div>
<label class="block mb-1 text-sm">إلى تاريخ</label>
<input type="date" id="debt-end-date" class="w-full p-2 border rounded-md text-sm filter-input">
</div>
</div>
<div class="mb-4 flex items-center gap-4">
<button id="apply-debts-filters-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">تطبيق الفلترة</button>
<label class="flex items-center gap-2 cursor-pointer">
<input type="checkbox" id="hide-paid-debts" class="w-4 h-4 text-blue-600 rounded" checked>
<span class="text-sm font-semibold text-gray-700">عرض غير المسدد فقط</span>
</label>
</div>
<!-- Table -->
<div class="overflow-x-auto bg-white rounded-lg shadow-sm" style="background: #fafafa !important;">
<table class="min-w-full" id="debts-detail-table" style="border-collapse: collapse !important;">
<thead>
<tr>
<th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:right">
<span>اسم العميل</span>
<button class="column-filter-btn" data-col="customer" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
</th>
<th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
<span>التاريخ</span>
<button class="column-filter-btn" data-col="date" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
</th>
<th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
<span>رقم الفاتورة</span>
<button class="column-filter-btn" data-col="invoice" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
</th>
<th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
<span>اجمالى الفاتورة</span>
<button class="column-filter-btn" data-col="total" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
</th>
<th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
<span>المسدد</span>
<button class="column-filter-btn" data-col="paid" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
</th>
<th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
<span>المتبقى</span>
<button class="column-filter-btn" data-col="remaining" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
</th>
<th style="background:linear-gradient(180deg,#ffd700,#daa520);color:black;font-weight:bold;padding:8px;border:1px solid #c4a300;text-align:center">
<span>المندوب</span>
<button class="column-filter-btn" data-col="rep" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button>
</th>
</tr>
</thead>
<tbody id="debts-detail-body" class="divide-y divide-gray-200">
<!-- سيتم إضافة الصفوف ديناميكياً -->
</tbody>
</table>
<div id="debts-empty-message" class="text-center text-gray-500 p-6 hidden">
لا توجد فواتير مطابقة للفلاتر
</div>
</div>
</section>
</div>
</div> <!-- End of debts-tab-content -->
<!-- Collection Receipt Tab Content -->
<div id="receipt-debts-tab-content" class="debts-tab-content" style="display:none;">
<h2 class="text-xl font-bold mb-4">كشف التحصيل</h2>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
<!-- Left: Receipt List -->
<div class="lg:col-span-2">
<div class="bg-white p-4 rounded shadow-md">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<div>
<label class="block text-sm font-medium mb-2">من تاريخ:</label>
<input type="date" id="receipt-from-date" class="w-full p-2 border rounded">
</div>
<div>
<label class="block text-sm font-medium mb-2">إلى تاريخ:</label>
<input type="date" id="receipt-to-date" class="w-full p-2 border rounded">
</div>
<div>
<label class="block text-sm font-medium mb-2"></label>
<button id="receipt-filter-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">تطبيق الفلاتر</button>
</div>
</div>
<div class="overflow-x-auto bg-white rounded-lg shadow">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border p-2 text-right">التاريخ</th>
<th class="border p-2 text-right">رقم الفاتورة</th>
<th class="border p-2 text-right">العميل</th>
<th class="border p-2 text-right">نوع التحصيل</th>
<th class="border p-2 text-right">المبلغ</th>
<th class="border p-2 text-right">الحالة</th>
</tr>
</thead>
<tbody id="receipt-table-body" class="text-sm">
</tbody>
</table>
</div>
<div class="mt-4 p-4 bg-gray-50 rounded border">
<div class="grid grid-cols-3 gap-4 text-lg font-bold">
<div>الإجمالي: <span id="receipt-total" class="text-green-600">0</span></div>
<div>العدد: <span id="receipt-count" class="text-blue-600">0</span></div>
<div>المتوسط: <span id="receipt-avg" class="text-purple-600">0</span></div>
</div>
</div>
</div>
</div>
<!-- Right: Rep Receipt Form -->
<div class="lg:col-span-1">
<div class="bg-white p-4 rounded shadow-md sticky top-20">
<h3 class="text-lg font-bold mb-4 text-right">النسريات والمصروفات</h3>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">اختر المندوب:</label>
<select id="receipt-rep-dropdown" class="w-full p-2 border rounded text-right">
<option value="">-- اختر المندوب --</option>
</select>
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">النسريات:</label>
<input type="number" id="rep-credit-transactions" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">المصروفات:</label>
<input type="number" id="rep-expenses" placeholder="0.00" class="w-full p-2 border rounded text-right" step="0.01">
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-right">ملاحظات:</label>
<textarea id="rep-notes" class="w-full p-2 border rounded text-right" rows="4" placeholder="ملاحظات إضافية..."></textarea>
</div>
<div class="flex flex-col gap-2">
<button id="receipt-print-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold">طباعة كشف التحصيل</button>
<button id="receipt-save-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">حفظ البيانات</button>
</div>
</div>
</div>
</div>
</div> <!-- End of receipt-debts-tab-content -->
</div>
<!-- ########## END DEBTS PAGE ########## -->
<!-- ########## CASH PAGE (الكاش) ########## -->
<div id="page-cash" class="page" style="display:none;">
<div id="cash-content-wrapper">
<h2 class="text-xl font-bold mb-4">الكاش - كشف التحصيل</h2>
<div class="mb-4 flex gap-2 items-center no-print">
<div class="ml-auto text-sm text-gray-600">اختر صف ثم استخدم الأزرار داخل كل صف لإجراءات المندوب</div>
</div>
<!-- Main grid: table (left) + summary (right) -->
<div class="cash-grid flex gap-4 items-start">
<div class="cash-table-area flex-1 overflow-x-auto bg-white rounded-lg shadow">
<table id="cash-table" class="min-w-full divide-y divide-gray-200 text-sm">
<thead class="bg-gray-50">
<tr>
<th class="p-2 text-center">#</th>
<th class="p-2 text-center">التاريخ <button class="cash-column-filter-btn" data-col="date" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
<th class="p-2 text-center">رقم الفاتورة <button class="cash-column-filter-btn" data-col="invoice" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
<th class="p-2 text-right">اسم العميل <button class="cash-column-filter-btn" data-col="customer" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
<th class="p-2 text-right">المندوب <button class="cash-column-filter-btn" data-col="rep" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
<th class="p-2 text-center">إجمالي الفاتورة <button class="cash-column-filter-btn" data-col="total" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
<th class="p-2 text-center">خصم</th>
<th class="p-2 text-center">الدفعة الأولى</th>
<th class="p-2 text-center">الدفعة الثانية</th>
<th class="p-2 text-center">إجمالي المحصل بعد الخصم</th>
<th class="p-2 text-center">المتبقي <button class="cash-column-filter-btn" data-col="remaining" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
<th class="p-2 text-center">كشف التحصيل <button class="cash-column-filter-btn" data-col="collection" aria-label="فلتر" title="فلتر" style="margin-inline-start:6px;background:transparent;border:none;cursor:pointer;font-size:14px">▾</button></th>
<th class="p-2 text-center">رقم كشف التحصيل</th>
<th class="p-2 text-center">الخزينة</th>
<th class="p-2 text-center">إجراءات</th>
</tr>
</thead>
<tbody id="cash-table-body" class="bg-white divide-y divide-gray-200">
<!-- Rows created by renderCash() -->
</tbody>
</table>
</div>
<!-- Cash summary panel (totals) - right column -->
<aside id="cash-summary-panel" class="w-60 p-2 bg-gray-50 rounded-lg shadow-sm text-right">
<table style="width:100%;border-collapse:collapse;font-size:14px;">
<tbody>
<tr>
<td style="padding:6px;color:#6b7280">إجمالي الفواتير</td>
<td id="cash-summary-total" style="padding:6px;font-weight:700;text-align:left">0 ج.م</td>
</tr>
<tr>
<td style="padding:6px;color:#6b7280">عدد الفواتير</td>
<td id="cash-summary-count" style="padding:6px;font-weight:600;text-align:left">0</td>
</tr>
<tr>
<td style="padding:6px;color:#6b7280">الدفعات المسددة</td>
<td id="cash-summary-paid" style="padding:6px;font-weight:600;color:#047857;text-align:left">0 ج.م</td>
</tr>
<tr>
<td style="padding:6px;color:#6b7280">خصم خاص</td>
<td id="cash-summary-discount" style="padding:6px;font-weight:600;color:#b91c1c;text-align:left">0 ج.م</td>
</tr>
<tr>
<td style="padding:6px;color:#6b7280">المتبقي</td>
<td id="cash-summary-remaining" style="padding:6px;font-weight:700;text-align:left">0 ج.م</td>
</tr>
</tbody>
</table>
<div class="pt-2 no-print">
<button id="cash-print-btn" class="w-full bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600">طباعة المحدد</button>
<button id="cash-include-all-btn" class="w-full mt-2 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">شمل كل الفواتير في الكاش</button>
</div>
</aside>
</div>
</div>
</div>
<!-- ########## END CASH PAGE ########## -->
<script>
(function(){
function injectCashStyles(){
if(document.getElementById('cash-page-styles')) return;
const css=`
.cash-row-due { background: rgba(254, 226, 226, 0.6); }
.cash-row-paid { background: rgba(220, 253, 231, 0.9); }
.cash-row-collected { background: rgba(219, 234, 254, 0.95); }
.cash-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; display:inline-block; }
.cash-action-btn { display:inline-block; padding:4px 6px; border-radius:6px; border:none; cursor:pointer; margin:2px 6px; color:#fff; font-size:13px; }
.cash-action-create { background:#2563eb; }
.cash-action-safe { background:#059669; }
.cash-tab-button { transition: all 0.3s ease; }
.cash-tab-button.active { background-color: #3b82f6; color: white; }
.cash-tab-content { display:none; }
.cash-tab-content.active { display:block; }
.cash-grid { display:flex; gap:16px; align-items:flex-start; }
.cash-table-area { flex:1 1 auto; max-width: calc(100% - 300px); }
#cash-summary-panel { width: 220px; min-width: 160px; max-width: 260px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
#cash-summary-panel .text-2xl { line-height:1.1; }
.cash-table-area table { width:100%; border-collapse:collapse; }
@media (max-width: 900px) {
.cash-grid { display:block; }
.cash-table-area { max-width: 100%; }
#cash-summary-panel { width: 100%; margin-top: 12px; }
}
header.sticky { z-index: 9999 !important; }
.debts-tab-button { transition: all 0.3s ease; }
.debts-tab-button.active { background-color: #3b82f6; color: white; }
.debts-tab-content { display:none; }
.debts-tab-content.active { display:block; }
`;
const s=document.createElement('style'); s.id='cash-page-styles'; s.appendChild(document.createTextNode(css)); document.head.appendChild(s);
}
function renderCashSummary(sales){
try{
const total=sales.reduce((sum,s)=> sum + Number(s.total || 0), 0);
const paid=sales.reduce((sum,s)=> sum + (Number(s.paidAmount || 0) || ((Number(s.firstPayment||0)+Number(s.secondPayment||0)) || 0)), 0);
const discount=sales.reduce((sum,s)=> sum + (Number(s.collectionDiscount || 0)), 0);
const remaining=total - paid - discount;
const elTotal=document.getElementById('cash-summary-total');
const elPaid=document.getElementById('cash-summary-paid');
const elDiscount=document.getElementById('cash-summary-discount');
const elRemaining=document.getElementById('cash-summary-remaining');
if(elTotal) elTotal.textContent=formatCurrency(total);
if(elPaid) elPaid.textContent=formatCurrency(paid);
if(elDiscount) elDiscount.textContent=formatCurrency(discount);
if(elRemaining) elRemaining.textContent=formatCurrency(remaining);
const elCount=document.getElementById('cash-summary-count');
if(elCount) elCount.textContent=String(Array.isArray(sales) ? sales.length : 0);
} catch(e){ console.warn('renderCashSummary error', e); }
}
window.saveCashToCloud=async function(){
try {
if (!window.db || typeof db==='undefined') { console.warn('💾 saveCashToCloud: DB not ready'); return; }
if (!window.state || !window.state.sales) { console.warn('💾 saveCashToCloud: no sales'); return; }
const payload={
sales: Array.isArray(window.state.sales) ? window.state.sales : [],
timestamp: new Date().toISOString(),
updatedAt: (typeof serverTs==='function') ? serverTs() : { _type: 'ServerValue', value: 'TIMESTAMP' }
};
await db.collection('settings').doc('cashData').set(payload, { merge: true });
console.log('✅ saveCashToCloud: saved', payload.sales.length, 'sales');
} catch(e) { console.error('❌ saveCashToCloud failed', e); }
};
window.debouncedSaveCash=function(){
clearTimeout(window._cashSaveTimer);
window._cashSaveTimer=setTimeout(window.saveCashToCloud, 1500);
};
window.loadCashFromCloud=async function(){
try {
if (!window.db || typeof db==='undefined') { console.warn('💾 loadCashFromCloud: DB not ready'); return false; }
const doc=await db.collection('settings').doc('cashData').get();
if (!doc.exists) { console.log('💾 loadCashFromCloud: no doc found'); return false; }
const data=doc.data() || {};
if (Array.isArray(data.sales) && data.sales.length > 0) {
window.state=window.state || {};
window.state.sales=data.sales;
try { localStorage.setItem('cache_sales', JSON.stringify(data.sales)); } catch(_){ }
console.log('✅ loadCashFromCloud: restored', data.sales.length, 'sales');
return true;
}
} catch(e) { console.error('❌ loadCashFromCloud failed', e); }
return false;
};
function renderCash(){
try {
injectCashStyles();
const tbody=document.getElementById('cash-table-body');
if(!tbody) return;
try {
console.debug('renderCash called', { stateSalesLength: Array.isArray(state.sales) ? state.sales.length : state.sales, invoiceNumbers: Array.isArray(state.sales) ? state.sales.map(s=> ({id: s.id, invoiceNumber: s.invoiceNumber, includeInCash: s.includeInCash})) : [] });
} catch(e) { }
tbody.innerHTML='';
const sales=Array.isArray(state.sales) ? state.sales.slice() : [];
window._cashFiltersOriginalRenderedSales=sales.slice();
window._lastRenderedCashSales=sales.slice();
renderCashSummary(sales);
if(sales.length===0){
const tr=document.createElement('tr');
tr.innerHTML=`<td colspan="15" class="p-4 text-center text-gray-500">لا توجد صفوف في الكاش.</td>`;
tbody.appendChild(tr);
return;
}
sales.sort((a,b)=> new Date(a.date || a.createdAt) - new Date(b.date || b.createdAt));
sales.forEach((s, idx)=> {
const first=Number(s.firstPayment || 0);
const second=Number(s.secondPayment || 0);
const paidSum=(first + second) || Number(s.paidAmount || 0) || 0;
const total=Number(s.total || 0);
const invoiceDiscount=Number(s.discount || 0);
const collectionDiscount=Number(s.collectionDiscount || 0);
const collectedAfter=Math.max(0, Math.round(((first + second) - collectionDiscount) * 100) / 100);
const remainingAmount=Math.round((total - (first + second) - collectionDiscount) * 100) / 100;
const customerName=(findCustomer(s.customerId) || {}).name || s.customerName || 'غير معروف';
const rep=s.repName || s.rep || '';
const tr=document.createElement('tr');
let rowClass='';
if (typeof remainingAmount !=='undefined' && remainingAmount <=0) rowClass='cash-row-collected';
else if (s.collectionReportCreated) rowClass='cash-row-collected';
else if (s.paidToSafe) rowClass='cash-row-paid';
else if (s.status==='due') rowClass='cash-row-due';
tr.className=rowClass;
if (s.includeInCash===false) {
tr.style.opacity='0.6';
tr.dataset.excludedFromCash='true';
}
tr.dataset.saleId=s.id;
try {
tr.dataset.date=(s.date || s.createdAt || '').split('T')[0] || '';
tr.dataset.invoice=String(s.invoiceNumber || '');
tr.dataset.customer=String(customerName || '');
tr.dataset.rep=String(rep || '');
tr.dataset.total=String(total || 0);
tr.dataset.paid=String(paidSum || Number(s.paidAmount || 0) || 0);
tr.dataset.remaining=String(remainingAmount || 0);
} catch(e) { }
tr.innerHTML=`
<td class="p-2 text-center">${idx + 1}</td>
<td class="p-2 text-center">${formatArabicDate(s.date || s.createdAt || new Date().toISOString())}</td>
<td class="p-2 text-center">${s.invoiceNumber || ''}</td>
<td class="p-2 text-right">${customerName}</td>
<td class="p-2 text-right">${rep}</td>
<td class="p-2 text-center">${formatCurrency(total)}</td>
<td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-discount" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(collectionDiscount))}" placeholder="0.00"></td>
<td class="p-2 text-center"><input data-id="${s.id}" class="cash-first-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(first))}" placeholder="0.00"></td>
<td class="p-2 text-center"><input data-id="${s.id}" class="cash-second-payment" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(second))}" placeholder="0.00"></td>
<td class="p-2 text-center">${formatCurrency(collectedAfter)}</td>
<td class="p-2 text-center"><span class="cash-remaining" data-id="${s.id}" style="${remainingAmount > 0 ? 'background:#fee2e2;color:#991b1b;font-weight:700;padding:6px;border-radius:6px;display:inline-block;' : 'background:#dcfce7;color:#065f46;font-weight:700;padding:6px;border-radius:6px;display:inline-block;'}">${formatCurrency(remainingAmount)}</span></td>
<td class="p-2 text-center">${s.collectionReportCreated ? '<span class="cash-badge" style="background:#dbeafe;color:#1e40af">تم</span>' : '<span class="cash-badge" style="background:#fef3c7;color:#92400e">لم يتم</span>'}</td>
<td class="p-2 text-center"><input data-id="${s.id}" class="cash-collection-number" style="width:90px;padding:4px;border:1px solid #e5e7eb;border-radius:6px;text-align:center;font-size:13px;" value="${escapeHtml(String(s.collectionNumber || ''))}" placeholder="رقم"></td>
<td class="p-2 text-center">${s.paidToSafe ? '<span class="cash-badge" style="background:#dcfce7;color:#065f46">دخل</span>' : '<span class="cash-badge" style="background:#fef2f2;color:#991b1b">لم يدخل</span>'}</td>
<td class="p-2 text-center">
<button class="cash-action-btn cash-action-create" data-id="${s.id}">${s.collectionReportCreated ? 'إلغاء كشف' : 'إنشاء كشف'}</button>
<button class="cash-action-btn cash-action-safe" data-id="${s.id}">${s.paidToSafe ? 'إلغاء خزينة' : 'دخل الخزينة'}</button>
</td>
`;
tbody.appendChild(tr);
});
tbody.querySelectorAll('.cash-collection-number').forEach(input=> {
input.addEventListener('change', (ev)=> {
const id=input.dataset.id;
const sale=state.sales.find(x=> x.id===id);
if(!sale) return;
sale.collectionNumber=input.value.trim();
saveState();
});
});
tbody.querySelectorAll('.cash-collection-discount').forEach(input=> {
input.addEventListener('change', (ev)=> {
const id=input.dataset.id;
const sale=state.sales.find(x=> x.id===id);
if(!sale) return;
const val=parseFloat(input.value.toString().replace(/,/g, '')) || 0;
sale.collectionDiscount=Math.round(val * 100) / 100;
saveState();
try { if (typeof window.debouncedSaveCash==='function') window.debouncedSaveCash(); } catch(e){}
renderCash();
});
});
const spreadsheetEntryBody=document.getElementById('spreadsheet-entry-body');
if (!spreadsheetEntryBody) return;
spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row=> {
const invoiceNumberInput=row.querySelector('.spreadsheet-invoice-number');
const productCodeInput=row.querySelector('.spreadsheet-product-code');
const productNameInput=row.querySelector('.spreadsheet-product-name');
const taxStatusInput=row.querySelector('.spreadsheet-tax-status-input');
const rawInvoiceNumber=invoiceNumberInput.value.trim();
const invoiceNumber=rawInvoiceNumber ? parseInt(rawInvoiceNumber) : null;
const productId=row.dataset.productId;
const productNameValue=productNameInput ? productNameInput.value.trim() : '';
const quantity=parseInt(row.querySelector('.spreadsheet-quantity').value) || 0;
const originalPrice=parseFloat(row.querySelector('.spreadsheet-price').value);
const modifiedPrice=parseFloat(row.querySelector('.spreadsheet-modified-price').value);
const safeOriginalPrice=(!isNaN(originalPrice) ? originalPrice : 0);
const safeModifiedPrice=(!isNaN(modifiedPrice) ? modifiedPrice : 0);
const price=(safeModifiedPrice > 0) ? safeModifiedPrice : safeOriginalPrice;
const discount=parseFloat(row.querySelector('.spreadsheet-discount').value);
const safeDiscount=(!isNaN(discount) ? discount : 0);
const collection=row.querySelector('.spreadsheet-collection').value;
const partialAmount=parseFloat(row.querySelector('.spreadsheet-partial-amount')?.value);
const safePartialAmount=(!isNaN(partialAmount) ? partialAmount : 0);
const taxFilingStatus=taxStatusInput ? taxStatusInput.value.trim() : '';
const rowManual=invoiceNumberInput && invoiceNumberInput.dataset && invoiceNumberInput.dataset.userEntered==='1';
let rowIsValidLocal=true;
[invoiceNumberInput, productCodeInput, row.querySelector('.spreadsheet-quantity'), row.querySelector('.spreadsheet-price'), row.querySelector('.spreadsheet-discount')].forEach(el=> el.classList.remove('border-red-500', 'border-2'));
if (productNameInput) productNameInput.classList.remove('border-red-500', 'border-2');
if (taxStatusInput) taxStatusInput.classList.remove('border-red-500', 'border-2');
const codeValue=(productCodeInput && productCodeInput.value) ? productCodeInput.value.trim() : '';
const isCanceledCode=(codeValue==='100') || (productId==='100');
if (isCanceledCode) {
dataFound=true;
if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <=0) {
invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal=false;
}
if (invoicesToSave.has(invoiceNumber) && invoicesToSave.get(invoiceNumber).collectionStatus !==collection) {
invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal=false;
}
if (!rowIsValidLocal) {
if (rowManual) {
invoiceNumberInput.classList.remove('border-red-500', 'border-2');
rowIsValidLocal=true;
} else {
isValid=false;
return;
}
}
if (!invoicesToSave.has(invoiceNumber)) {
invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection==='partial' ? safePartialAmount : 0, isCanceled: true });
} else {
invoicesToSave.get(invoiceNumber).isCanceled=true;
}
return;
}
if (productId || productNameValue) {
dataFound=true;
const product=getProductDetailsByCode(productId);
if (!product) {
if (productNameInput) {
productNameInput.classList.add('border-red-500', 'border-2');
}
if (productCodeInput) {
productCodeInput.classList.add('border-red-500', 'border-2');
}
rowIsValidLocal=false;
if (!rowManual) { isValid=false; return; } else { rowIsValidLocal=true; invoiceNumberInput.classList.remove('border-red-500','border-2'); }
}
if (!rawInvoiceNumber || isNaN(invoiceNumber) || invoiceNumber <=0) {
invoiceNumberInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal=false;
}
if (!quantity || quantity===0) { row.querySelector('.spreadsheet-quantity').classList.add('border-red-500', 'border-2'); rowIsValidLocal=false; }
if (isNaN(price) || price <=0) { row.querySelector('.spreadsheet-price').classList.add('border-red-500', 'border-2'); rowIsValidLocal=false; }
if (isNaN(discount) || discount < 0 || discount > 100) { row.querySelector('.spreadsheet-discount').classList.add('border-red-500', 'border-2'); rowIsValidLocal=false; }
if (!rowIsValidLocal) {
if (rowManual) {
invoiceNumberInput.classList.remove('border-red-500','border-2');
row.querySelector('.spreadsheet-quantity')?.classList.remove('border-red-500','border-2');
row.querySelector('.spreadsheet-price')?.classList.remove('border-red-500','border-2');
row.querySelector('.spreadsheet-discount')?.classList.remove('border-red-500','border-2');
if (taxStatusInput) taxStatusInput.classList.remove('border-red-500','border-2');
rowIsValidLocal=true;
} else {
isValid=false;
return;
}
}
if (!invoicesToSave.has(invoiceNumber)) {
invoicesToSave.set(invoiceNumber, { items: [], collectionStatus: collection, totalSales: 0, taxFilingStatus: taxFilingStatus, partialAmount: collection==='partial' ? safePartialAmount : 0 });
}
const itemSubtotal=price * quantity;
const itemFinalPrice=itemSubtotal * (1 - safeDiscount / 100);
const invoiceData=invoicesToSave.get(invoiceNumber);
invoiceData.items.push({ productId, quantity, price, discountPercent: safeDiscount, itemFinalPrice });
invoiceData.totalSales +=itemFinalPrice;
invoiceData.taxFilingStatus=taxFilingStatus;
if (collection==='partial') invoiceData.partialAmount=safePartialAmount;
} else if (productCodeInput.value.trim()) {
productCodeInput.classList.add('border-red-500', 'border-2'); rowIsValidLocal=false;
if (!rowManual) { isValid=false; } else { productCodeInput.classList.remove('border-red-500','border-2'); rowIsValidLocal=true; }
}
});
} catch(e) { console.warn('renderCash error', e); }
}
if (typeof window.attachCashListeners !=='function') {
window.attachCashListeners=function(){};
}
document.addEventListener('DOMContentLoaded', ()=>{
try{ if (typeof attachCashListeners==='function') attachCashListeners(); }
catch(e){ console.warn('attachCashListeners error', e); }
});
window.saveCashToCloud=async function(){
try {
if (!window.db || typeof db==='undefined') { console.warn('💾 saveCashToCloud: DB not ready'); return; }
if (!window.state || !window.state.sales) { console.warn('💾 saveCashToCloud: no sales'); return; }
const payload={
sales: Array.isArray(window.state.sales) ? window.state.sales : [],
timestamp: new Date().toISOString(),
updatedAt: (typeof serverTs==='function') ? serverTs() : firebase.firestore.FieldValue.serverTimestamp()
};
await db.collection('settings').doc('cashData').set(payload, { merge: true });
console.log('✅ saveCashToCloud: saved', payload.sales.length, 'sales to cloud');
} catch(e) { console.error('❌ saveCashToCloud failed', e); }
};
window.debouncedSaveCash=function(){
clearTimeout(window._cashSaveTimer);
window._cashSaveTimer=setTimeout(window.saveCashToCloud, 1500);
};
window.loadCashFromCloud=async function(){
try {
if (!window.db || typeof db==='undefined') { console.log('💾 loadCashFromCloud: DB not ready'); return false; }
const doc=await db.collection('settings').doc('cashData').get();
if (!doc.exists) { console.log('💾 loadCashFromCloud: no doc found'); return false; }
const data=doc.data() || {};
if (Array.isArray(data.sales) && data.sales.length > 0) {
window.state=window.state || {};
window.state.sales=data.sales;
try { localStorage.setItem('cache_sales', JSON.stringify(data.sales)); } catch(_){ }
console.log('✅ loadCashFromCloud: restored', data.sales.length, 'sales from cloud');
return true;
}
} catch(e) { console.warn('💾 loadCashFromCloud failed', e); }
return false;
};
window.renderCash=renderCash;
window.renderCollectionReceipt=function() {
try {
const fromDate=document.getElementById('receipt-from-date')?.value;
const toDate=document.getElementById('receipt-to-date')?.value;
const repFilter=document.getElementById('receipt-rep-dropdown')?.value;
const tbody=document.getElementById('receipt-table-body');
if (!tbody) return;
tbody.innerHTML='';
let receipts=[];
let totalAmount=0;
let totalCount=0;
if (Array.isArray(state.sales)) {
state.sales.forEach(sale=> {
const saleDate=sale.date ? new Date(sale.date).toISOString().split('T')[0] : null;
if (!saleDate) return;
if (fromDate && saleDate < fromDate) return;
if (toDate && saleDate > toDate) return;
if (repFilter && sale.repName !==repFilter) return;
if (sale.status==='cash') {
const amount=sale.total || sale.totalAfterDiscount || 0;
receipts.push({
date: saleDate,
invoiceNumber: sale.invoiceNumber,
customer: sale.customerName || findCustomer(sale.customerId)?.name || 'غير معروف',
type: 'كاش',
amount: amount,
status: 'مسددة'
});
totalAmount +=amount;
}
if (sale.status==='partial') {
if (sale.firstPayment && sale.firstPayment > 0) {
receipts.push({
date: saleDate,
invoiceNumber: sale.invoiceNumber + ' (دفعة أولى)',
customer: sale.customerName || findCustomer(sale.customerId)?.name || 'غير معروف',
type: 'دفعة أولى',
amount: sale.firstPayment,
status: 'مسددة'
});
totalAmount +=sale.firstPayment;
}
if (sale.secondPayment && sale.secondPayment > 0) {
receipts.push({
date: saleDate,
invoiceNumber: sale.invoiceNumber + ' (دفعة ثانية)',
customer: sale.customerName || findCustomer(sale.customerId)?.name || 'غير معروف',
type: 'دفعة ثانية',
amount: sale.secondPayment,
status: 'مسددة'
});
totalAmount +=sale.secondPayment;
}
}
});
}
receipts.sort((a, b)=> new Date(a.date) - new Date(b.date));
if (receipts.length===0) {
const tr=document.createElement('tr');
tr.innerHTML='<td colspan="6" class="p-4 text-center text-gray-500">لا توجد تحصيلات</td>';
tbody.appendChild(tr);
} else {
receipts.forEach((receipt, idx)=> {
const tr=document.createElement('tr');
tr.classList.add(idx % 2===0 ? 'bg-white' : 'bg-gray-50');
tr.innerHTML=`
<td class="border p-2 text-right">${receipt.date}</td>
<td class="border p-2 text-right">${receipt.invoiceNumber}</td>
<td class="border p-2 text-right">${receipt.customer}</td>
<td class="border p-2 text-right">${receipt.type}</td>
<td class="border p-2 text-right font-semibold">${formatCurrency(receipt.amount)}</td>
<td class="border p-2 text-right"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${receipt.status}</span></td>
`;
tbody.appendChild(tr);
});
totalCount=receipts.length;
}
const totalEl=document.getElementById('receipt-total');
const countEl=document.getElementById('receipt-count');
const avgEl=document.getElementById('receipt-avg');
if (totalEl) totalEl.textContent=formatCurrency(totalAmount);
if (countEl) countEl.textContent=totalCount;
if (avgEl) avgEl.textContent=formatCurrency(totalCount > 0 ? totalAmount / totalCount : 0);
} catch(e) { console.error('renderCollectionReceipt error', e); }
};
window.populateReceiptRepDropdown=function() {
const select=document.getElementById('receipt-rep-dropdown');
if (!select) return;
const reps=Array.from(new Set((state.sales || []).map(s=> s.repName).filter(Boolean)));
select.innerHTML='<option value="">-- جميع المناديب --</option>';
reps.forEach(rep=> {
const option=document.createElement('option');
option.value=rep;
option.textContent=rep;
select.appendChild(option);
});
};
window.initReceiptPage=function() {
const today=new Date().toISOString().split('T')[0];
const fromInput=document.getElementById('receipt-from-date');
const toInput=document.getElementById('receipt-to-date');
if (fromInput && !fromInput.value) fromInput.value=today;
if (toInput && !toInput.value) toInput.value=today;
window.populateReceiptRepDropdown();
};
document.addEventListener('DOMContentLoaded', function() {
const filterBtn=document.getElementById('receipt-filter-btn');
const printBtn=document.getElementById('receipt-print-btn');
const saveBtn=document.getElementById('receipt-save-btn');
if (filterBtn) {
filterBtn.addEventListener('click', ()=> {
window.renderCollectionReceipt();
});
}
if (printBtn) {
printBtn.addEventListener('click', ()=> {
const printWindow=window.open('', '', 'height=600,width=800');
const repName=document.getElementById('receipt-rep-dropdown')?.value || 'بدون تحديد';
const credits=document.getElementById('rep-credit-transactions')?.value || '0';
const expenses=document.getElementById('rep-expenses')?.value || '0';
const notes=document.getElementById('rep-notes')?.value || '';
const totalEl=document.getElementById('receipt-total');
const total=totalEl?.textContent || '0';
const contentToPrint=`
<html dir="rtl">
<head>
<style>
body { font-family: Arial, sans-serif; text-align: right; margin: 20px; }
h2 { text-align: center; font-size: 18px; margin-bottom: 20px; }
.receipt-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
.receipt-item { margin: 10px 0; padding: 5px 0; border-bottom: 1px solid #ccc; }
.receipt-item label { font-weight: bold; width: 150px; display: inline-block; }
.receipt-item value { margin-right: 10px; }
.receipt-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 16px; }
</style>
</head>
<body>
<h2>كشف التحصيل</h2>
<div class="receipt-header">
<div class="receipt-item"><label>المندوب:</label> <span>${repName}</span></div>
<div class="receipt-item"><label>التاريخ:</label> <span>${new Date().toLocaleDateString('ar-EG')}</span></div>
</div>
<div class="receipt-item"><label>النسريات:</label> <span>${credits}</span></div>
<div class="receipt-item"><label>المصروفات:</label> <span>${expenses}</span></div>
<div class="receipt-item"><label>الملاحظات:</label> <span>${notes}</span></div>
<div class="receipt-total">إجمالي التحصيلات: ${total}</div>
</body>
</html>`;
printWindow.document.write(contentToPrint);
printWindow.document.close();
printWindow.print();
});
}
if (saveBtn) {
saveBtn.addEventListener('click', ()=> {
try {
const repName=document.getElementById('receipt-rep-dropdown')?.value;
const credits=document.getElementById('rep-credit-transactions')?.value;
const expenses=document.getElementById('rep-expenses')?.value;
const notes=document.getElementById('rep-notes')?.value;
if (!repName) {
alert('الرجاء اختيار مندوب أولاً');
return;
}
const receiptData={
repName,
credits: parseFloat(credits) || 0,
expenses: parseFloat(expenses) || 0,
notes,
timestamp: new Date().toISOString(),
date: new Date().toISOString().split('T')[0]
};
localStorage.setItem(`rep_receipt_${repName}_${receiptData.date}`, JSON.stringify(receiptData));
if (window.db && typeof db !=='undefined') {
db.collection('settings').doc('repReceipts').collection(receiptData.date).doc(repName).set(receiptData, { merge: true })
.then(()=> {
alert('تم حفظ البيانات بنجاح');
})
.catch(e=> console.warn('Failed to save to cloud', e));
}
} catch(e) {
console.error('Error saving receipt data', e);
alert('خطأ في حفظ البيانات');
}
});
}
const debtsTabBtn=document.getElementById('debts-tab-btn');
const receiptDebtsTabBtn=document.getElementById('receipt-debts-tab-btn');
const debtsTabContent=document.getElementById('debts-tab-content');
const receiptDebtsTabContent=document.getElementById('receipt-debts-tab-content');
if (debtsTabBtn && receiptDebtsTabBtn && debtsTabContent && receiptDebtsTabContent) {
debtsTabBtn.addEventListener('click', ()=> {
debtsTabBtn.style.backgroundColor='#3b82f6';
debtsTabBtn.style.color='white';
receiptDebtsTabBtn.style.backgroundColor='#d1d5db';
receiptDebtsTabBtn.style.color='#374151';
debtsTabContent.style.display='';
debtsTabContent.classList.add('active');
receiptDebtsTabContent.style.display='none';
receiptDebtsTabContent.classList.remove('active');
});
receiptDebtsTabBtn.addEventListener('click', ()=> {
receiptDebtsTabBtn.style.backgroundColor='#3b82f6';
receiptDebtsTabBtn.style.color='white';
debtsTabBtn.style.backgroundColor='#d1d5db';
debtsTabBtn.style.color='#374151';
receiptDebtsTabContent.style.display='';
receiptDebtsTabContent.classList.add('active');
debtsTabContent.style.display='none';
debtsTabContent.classList.remove('active');
window.initReceiptPage();
window.renderCollectionReceipt();
});
}
const dispatchNotesTabBtn=document.getElementById('dispatch-notes-tab-btn');
const receiptLocalTabBtn=document.getElementById('receipt-local-tab-btn');
const dispatchNotesTabContent=document.getElementById('dispatch-notes-tab-content');
const receiptLocalTabContent=document.getElementById('receipt-local-tab-content');
if (dispatchNotesTabBtn && receiptLocalTabBtn && dispatchNotesTabContent && receiptLocalTabContent) {
dispatchNotesTabBtn.addEventListener('click', ()=> {
dispatchNotesTabBtn.style.backgroundColor='#3b82f6';
dispatchNotesTabBtn.style.color='white';
receiptLocalTabBtn.style.backgroundColor='#d1d5db';
receiptLocalTabBtn.style.color='#374151';
dispatchNotesTabContent.style.display='block';
receiptLocalTabContent.style.display='none';
});
receiptLocalTabBtn.addEventListener('click', ()=> {
receiptLocalTabBtn.style.backgroundColor='#3b82f6';
receiptLocalTabBtn.style.color='white';
dispatchNotesTabBtn.style.backgroundColor='#d1d5db';
dispatchNotesTabBtn.style.color='#374151';
receiptLocalTabContent.style.display='block';
dispatchNotesTabContent.style.display='none';
try {
const today=new Date().toISOString().split('T')[0];
const fromInput=document.getElementById('receipt-from-date-local');
const toInput=document.getElementById('receipt-to-date-local');
if (fromInput && !fromInput.value) fromInput.value=today;
if (toInput && !toInput.value) toInput.value=today;
const repDropdown=document.getElementById('receipt-rep-dropdown-local');
if (repDropdown) {
const reps=Array.from(new Set((state.sales || []).map(s=> s.repName).filter(Boolean)));
repDropdown.innerHTML='<option value="">-- جميع المناديب --</option>';
reps.forEach(rep=> {
const option=document.createElement('option');
option.value=rep;
option.textContent=rep;
repDropdown.appendChild(option);
});
}
if (typeof renderCollectionReceiptLocal==='function') renderCollectionReceiptLocal();
} catch(e) { console.warn('receipt init failed', e); }
});
}
const filterBtnLocal=document.getElementById('receipt-filter-btn-local');
if (filterBtnLocal) {
filterBtnLocal.addEventListener('click', ()=> {
if (typeof renderCollectionReceiptLocal==='function') renderCollectionReceiptLocal();
});
}
const printBtnLocal=document.getElementById('receipt-print-btn-local');
if (printBtnLocal) {
printBtnLocal.addEventListener('click', ()=> {
const repName=document.getElementById('receipt-rep-dropdown-local')?.value || 'بدون تحديد';
const credits=document.getElementById('rep-credit-transactions-local')?.value || '0';
const expenses=document.getElementById('rep-expenses-local')?.value || '0';
const notes=document.getElementById('rep-notes-local')?.value || '';
const totalEl=document.getElementById('receipt-total-local');
const total=totalEl?.textContent || '0';
const contentToPrint=`
<html dir="rtl">
<head>
<style>
body { font-family: Arial, sans-serif; text-align: right; margin: 20px; }
h2 { text-align: center; font-size: 18px; margin-bottom: 20px; }
.receipt-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
.receipt-item { margin: 10px 0; padding: 5px 0; border-bottom: 1px solid #ccc; }
.receipt-item label { font-weight: bold; width: 150px; display: inline-block; }
.receipt-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 16px; }
</style>
</head>
<body>
<h2>كشف التحصيل</h2>
<div class="receipt-header">
<div class="receipt-item"><label>المندوب:</label> <span>${repName}</span></div>
<div class="receipt-item"><label>التاريخ:</label> <span>${new Date().toLocaleDateString('ar-EG')}</span></div>
</div>
<div class="receipt-item"><label>النسريات:</label> <span>${credits}</span></div>
<div class="receipt-item"><label>المصروفات:</label> <span>${expenses}</span></div>
<div class="receipt-item"><label>الملاحظات:</label> <span>${notes}</span></div>
<div class="receipt-total">إجمالي التحصيلات: ${total}</div>
</body>
</html>`;
const printWindow=window.open('', '', 'height=600,width=800');
printWindow.document.write(contentToPrint);
printWindow.document.close();
printWindow.print();
});
}
const saveBtnLocal=document.getElementById('receipt-save-btn-local');
if (saveBtnLocal) {
saveBtnLocal.addEventListener('click', ()=> {
try {
const repName=document.getElementById('receipt-rep-dropdown-local')?.value;
const credits=document.getElementById('rep-credit-transactions-local')?.value;
const expenses=document.getElementById('rep-expenses-local')?.value;
const notes=document.getElementById('rep-notes-local')?.value;
if (!repName) {
alert('الرجاء اختيار مندوب أولاً');
return;
}
const receiptData={
repName,
credits: parseFloat(credits) || 0,
expenses: parseFloat(expenses) || 0,
notes,
timestamp: new Date().toISOString(),
date: new Date().toISOString().split('T')[0]
};
localStorage.setItem(`rep_receipt_${repName}_${receiptData.date}`, JSON.stringify(receiptData));
if (window.db && typeof db !=='undefined') {
db.collection('settings').doc('repReceipts').collection(receiptData.date).doc(repName).set(receiptData, { merge: true })
.then(()=> { alert('تم حفظ البيانات بنجاح'); })
.catch(e=> console.warn('Failed to save to cloud', e));
}
} catch(e) {
console.error('Error saving receipt data', e);
alert('خطأ في حفظ البيانات');
}
});
}
window.renderCollectionReceiptLocal=function() {
try {
const tbody=document.getElementById('receipt-table-body-local');
if (!tbody) return;
tbody.innerHTML='';
const fromDate=document.getElementById('receipt-from-date-local')?.value;
const toDate=document.getElementById('receipt-to-date-local')?.value;
const selectedRep=document.getElementById('receipt-rep-dropdown-local')?.value;
let receipts=[];
let totalAmount=0;
let totalCount=0;
if (Array.isArray(state.sales)) {
state.sales.forEach(sale=> {
const saleDate=(sale.date || sale.createdAt || '').split('T')[0];
if (fromDate && saleDate < fromDate) return;
if (toDate && saleDate > toDate) return;
if (selectedRep && sale.repName !==selectedRep) return;
const customer=(typeof findCustomer==='function' ? findCustomer(sale.customerId) : null) || {};
const customerName=customer.name || sale.customerName || 'غير معروف';
if (sale.firstPayment && sale.firstPayment > 0) {
receipts.push({
date: saleDate,
invoiceNumber: sale.invoiceNumber || '',
customer: customerName,
type: 'دفعة أولى',
amount: sale.firstPayment,
status: 'مسددة'
});
totalAmount +=sale.firstPayment;
}
if (sale.secondPayment && sale.secondPayment > 0) {
receipts.push({
date: saleDate,
invoiceNumber: sale.invoiceNumber || '',
customer: customerName,
type: 'دفعة ثانية',
amount: sale.secondPayment,
status: 'مسددة'
});
totalAmount +=sale.secondPayment;
}
});
}
receipts.sort((a, b)=> new Date(a.date) - new Date(b.date));
if (receipts.length===0) {
const tr=document.createElement('tr');
tr.innerHTML='<td colspan="6" class="p-4 text-center text-gray-500">لا توجد تحصيلات</td>';
tbody.appendChild(tr);
} else {
receipts.forEach((receipt, idx)=> {
const tr=document.createElement('tr');
tr.classList.add(idx % 2===0 ? 'bg-white' : 'bg-gray-50');
tr.innerHTML=`
<td class="border p-2 text-right">${receipt.date}</td>
<td class="border p-2 text-right">${receipt.invoiceNumber}</td>
<td class="border p-2 text-right">${receipt.customer}</td>
<td class="border p-2 text-right">${receipt.type}</td>
<td class="border p-2 text-right font-semibold">${formatCurrency(receipt.amount)}</td>
<td class="border p-2 text-right"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${receipt.status}</span></td>
`;
tbody.appendChild(tr);
});
totalCount=receipts.length;
}
const totalEl=document.getElementById('receipt-total-local');
const countEl=document.getElementById('receipt-count-local');
const avgEl=document.getElementById('receipt-avg-local');
if (totalEl) totalEl.textContent=formatCurrency(totalAmount);
if (countEl) countEl.textContent=totalCount;
if (avgEl) avgEl.textContent=formatCurrency(totalCount > 0 ? totalAmount / totalCount : 0);
} catch(e) { console.error('renderCollectionReceiptLocal error', e); }
}
});
})();
</script>
<!-- Rep Debts Page removed per user request -->
<!-- removed separate sub-pages; their markup is embedded as subviews inside stock-control -->
<div id="page-stock-control" class="page">
<style>
.inv-tab-btn { 
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
border-bottom: 4px solid transparent; 
cursor: pointer;
position: relative;
}
.inv-tab-btn:hover {
background-color: rgba(255, 255, 255, 0.7);
transform: translateY(-2px);
}
.inv-tab-btn.active { 
background-color: #ffffff; 
color: #2563eb; 
border-bottom-color: #2563eb;
box-shadow: 0 -2px 8px rgba(37, 99, 235, 0.1);
}
.fade-in { 
animation: fadeIn 0.4s ease-in-out; 
}
@keyframes fadeIn { 
from { opacity: 0; transform: translateY(10px); } 
to { opacity: 1; transform: translateY(0); } 
}
#itemCardModal { 
display: none; 
position: fixed; 
z-index: 9999; 
left: 0; 
top: 0; 
width: 100%; 
height: 100%; 
overflow: auto; 
background-color: rgba(0,0,0,0.6); 
backdrop-filter: blur(4px);
}
.modal-content-inv { 
margin: 5% auto; 
background: white; 
border-radius: 16px; 
overflow: hidden; 
animation: slideDown 0.3s ease-out; 
max-width: 600px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
@keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
<div id="warehouse-section" class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 mb-8">
<!-- Header -->
<div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-gray-50 to-blue-50">
<div>
<h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
🏭 إدارة المخازن
<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-normal">Cloud Synced ☁️</span>
</h2>
</div>
<div class="flex gap-2">
<button onclick="if(window.migrateInventoryToCloud) window.migrateInventoryToCloud()" class="bg-purple-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow hover:bg-purple-700 transition">☁️ رفع البيانات</button>
<button onclick="if(window.inventorySystem && window.inventorySystem.showAddItemModal) window.inventorySystem.showAddItemModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition">+ صنف جديد</button>
</div>
</div>
<!-- Search & Total Value -->
<div class="p-5 bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
<div class="w-full md:flex-1 md:max-w-lg">
<div class="relative">
<input type="text" id="inventorySearch" onkeyup="filterInventory()" placeholder="🔍 بحث عن صنف..." class="w-full px-4 py-3 pr-10 border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition" dir="rtl">
<div class="absolute left-3 top-3 text-blue-400">🔍</div>
</div>
</div>
<div class="bg-white px-6 py-3 rounded-xl shadow-md border-2 border-blue-200">
<div class="text-xs text-gray-500 mb-1 text-center">إجمالي قيمة المخزون</div>
<div id="total-inventory-value" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-blue-600">0 ج.م</div>
</div>
</div>
<!-- Tabs -->
<div class="flex border-b-2 border-gray-200 bg-gray-50">
<div onclick="switchInvTab('finished')" id="btn-finished" class="inv-tab-btn active flex-1 py-4 text-center font-bold text-gray-600 hover:bg-white cursor-pointer transition-all duration-200">📦 منتج تام</div>
<div onclick="switchInvTab('raw')" id="btn-raw" class="inv-tab-btn flex-1 py-4 text-center font-bold text-gray-600 hover:bg-white cursor-pointer transition-all duration-200">🥛 خامات</div>
<div onclick="switchInvTab('packing')" id="btn-packing" class="inv-tab-btn flex-1 py-4 text-center font-bold text-gray-600 hover:bg-white cursor-pointer transition-all duration-200">🥡 تغليف</div>
</div>
<!-- Tables Container -->
<div class="p-4 min-h-[400px]">
<div id="tab-finished-content" class="fade-in">
<table class="w-full text-right border-collapse table-layout-fixed">
<thead class="bg-gray-50 text-gray-600 text-sm">
<tr><th class="p-3 w-1/4 text-right">الصنف</th><th class="p-3 w-1/4 text-center">الرصيد</th><th class="p-3 w-1/4 text-right">الوحدة</th><th class="p-3 w-1/4 text-center">التكلفة</th></tr>
</thead>
<tbody id="table-finished" class="divide-y text-gray-700"></tbody>
</table>
</div>
<div id="tab-raw-content" class="hidden fade-in">
<table class="w-full text-right border-collapse table-layout-fixed">
<thead class="bg-gray-50 text-gray-600 text-sm">
<tr><th class="p-3 w-1/4 text-right">الصنف</th><th class="p-3 w-1/4 text-center">الرصيد</th><th class="p-3 w-1/4 text-right">الوحدة</th><th class="p-3 w-1/4 text-center">التكلفة</th></tr>
</thead>
<tbody id="table-raw" class="divide-y text-gray-700"></tbody>
</table>
</div>
<div id="tab-packing-content" class="hidden fade-in">
<table class="w-full text-right border-collapse table-layout-fixed">
<thead class="bg-gray-50 text-gray-600 text-sm">
<tr><th class="p-3 w-1/4 text-right">الصنف</th><th class="p-3 w-1/4 text-center">الرصيد</th><th class="p-3 w-1/4 text-right">الوحدة</th><th class="p-3 w-1/4 text-center">التكلفة</th></tr>
</thead>
<tbody id="table-packing" class="divide-y text-gray-700"></tbody>
</table>
</div>
</div>
</div>
<!-- Item Details Modal - Rich Card Design -->
<div id="itemCardModal">
<div class="modal-content-inv w-11/12 md:w-2/3 lg:w-1/2" style="max-width: 700px;">
<!-- Header -->
<div class="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-5 flex justify-between items-center rounded-t-2xl">
<div>
<h3 id="modal-title" class="text-2xl font-bold mb-1">جبنة بيضاء (صفيحة)</h3>
<div class="flex items-center gap-2 mt-1">
<span id="modal-category" class="text-sm text-slate-300">📦 منتج تام</span>
<span class="text-xs text-slate-400">•</span>
<span id="modal-code" class="text-xs text-slate-400">FP-001</span>
</div>
</div>
<button onclick="document.getElementById('itemCardModal').style.display='none'" class="text-3xl hover:text-red-300 transition w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-600">&times;</button>
</div>
<!-- Stats Cards Grid -->
<div class="p-6 bg-gray-50">
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
<!-- Min Stock -->
<div class="bg-gradient-to-br from-pink-50 to-rose-100 p-4 rounded-xl border border-rose-200 text-center">
<div class="text-xs text-rose-600 mb-1 font-semibold">حد الطلب (Min)</div>
<div id="modal-min" class="text-3xl font-bold text-rose-700">10</div>
<div class="text-xs text-rose-500 mt-1">نسبة بالشهر</div>
</div>
<!-- Total Value -->
<div class="bg-gradient-to-br from-amber-50 to-yellow-100 p-4 rounded-xl border border-yellow-200 text-center">
<div class="text-xs text-amber-700 mb-1 font-semibold">القيمة الإجمالية</div>
<div id="modal-total-value" class="text-2xl font-bold text-amber-800">42,500</div>
<div class="text-xs text-amber-600 mt-1">ج.م</div>
</div>
<!-- Unit Cost -->
<div class="bg-gradient-to-br from-emerald-50 to-green-100 p-4 rounded-xl border border-green-200 text-center">
<div class="text-xs text-emerald-700 mb-1 font-semibold">سعر/تكلفة</div>
<div id="modal-cost" class="text-2xl font-bold text-emerald-800">850</div>
<div class="text-xs text-emerald-600 mt-1">ج.م</div>
</div>
<!-- Current Stock -->
<div class="bg-gradient-to-br from-sky-50 to-blue-100 p-4 rounded-xl border border-blue-200 text-center">
<div class="text-xs text-blue-700 mb-1 font-semibold">الرصيد الحالي</div>
<div id="modal-stock" class="text-3xl font-bold text-blue-800">50</div>
<div id="modal-unit" class="text-xs text-blue-600 mt-1">صفيحة</div>
</div>
</div>
<!-- Movement History Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4">
<div class="bg-slate-700 text-white px-4 py-3 flex items-center gap-2">
<span class="text-lg">📋</span>
<h4 class="font-bold">سجل الحركات (آخر 5 حركات)</h4>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm" dir="rtl">
<thead class="bg-gray-100 border-b">
<tr>
<th class="px-4 py-2 text-right text-gray-600 font-semibold">التاريخ</th>
<th class="px-4 py-2 text-center text-gray-600 font-semibold">الكمية</th>
<th class="px-4 py-2 text-center text-gray-600 font-semibold">نوع الحركة</th>
<th class="px-4 py-2 text-right text-gray-600 font-semibold">بواسطة</th>
</tr>
</thead>
<tbody id="modal-movements" class="divide-y divide-gray-100">
<!-- Will be populated dynamically -->
<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">لا توجد حركات مسجلة</td></tr>
</tbody>
</table>
</div>
</div>
<!-- Action Buttons -->
<div class="flex gap-3">
<button onclick="document.getElementById('itemCardModal').style.display='none'" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-bold shadow transition">
إغلاق
</button>
<button onclick="openEditItemModal()" class="bg-gray-400 hover:bg-gray-500 text-white py-3 px-6 rounded-lg font-bold shadow transition">
تعديل الرصيد
</button>
<button onclick="openEditPriceModal()" class="bg-amber-500 hover:bg-amber-600 text-white py-3 px-6 rounded-lg font-bold shadow transition">
تعديل السعر
</button>
</div>
</div>
</div>
</div>
<!-- Add Item Modal - NEW RICH DESIGN -->
<div id="addItemModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); backdrop-filter:blur(3px);">
<div class="bg-white w-11/12 md:w-1/2 mx-auto mt-10 rounded-xl shadow-2xl overflow-hidden animate-slideDown" style="max-width:600px;">
<!-- Header -->
<div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 flex justify-between items-center">
<h2 class="text-xl font-bold flex items-center gap-2">✨ إضافة صنف جديد</h2>
<button onclick="closeAddModal()" class="text-2xl hover:text-red-200 transition">&times;</button>
</div>
<!-- Body -->
<div class="p-6 grid gap-5">
<!-- Name -->
<div>
<label class="block text-gray-700 font-bold mb-2 text-sm">اسم الصنف</label>
<input type="text" id="newItemName" placeholder="مثال: لبن، جردل، جبنة..." class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none transition" dir="rtl">
</div>
<div class="grid grid-cols-2 gap-4">
<!-- Category -->
<div>
<label class="block text-gray-700 font-bold mb-2 text-sm">القسم</label>
<select id="newItemCat" class="w-full border-2 border-gray-200 p-3 rounded-lg bg-gray-50 focus:border-blue-500 focus:outline-none" dir="rtl">
<option value="raw">🥛 خامات</option>
<option value="packing">🥡 تغليف</option>
<option value="finished">📦 منتج تام</option>
</select>
</div>
<!-- Unit -->
<div>
<label class="block text-gray-700 font-bold mb-2 text-sm">الوحدة</label>
<select id="newItemUnit" class="w-full border-2 border-gray-200 p-3 rounded-lg bg-gray-50 focus:border-blue-500 focus:outline-none" dir="rtl">
<option value="كيلو">كيلو</option>
<option value="قطعة" selected>قطعة</option>
<option value="لتر">لتر</option>
<option value="شيكارة">شيكارة</option>
<option value="كرتونة">كرتونة</option>
<option value="صفيحة">صفيحة</option>
<option value="علبة">علبة</option>
</select>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<!-- Opening Stock -->
<div>
<label class="block text-gray-700 font-bold mb-2 text-sm">رصيد أول المدة</label>
<input type="number" id="newItemStock" value="0" step="0.01" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none">
</div>
<!-- Cost -->
<div>
<label class="block text-gray-700 font-bold mb-2 text-sm">التكلفة / السعر (ج.م)</label>
<input type="number" id="newItemCost" value="0" step="0.01" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none">
</div>
</div>
</div>
<!-- Footer Buttons -->
<div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
<button onclick="closeAddModal()" class="px-6 py-2 rounded-lg font-bold text-gray-600 bg-white border border-gray-300 hover:bg-gray-100 transition">إلغاء ❌</button>
<button onclick="saveNewItemAction()" class="px-8 py-2 rounded-lg font-bold text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 shadow-lg transform hover:scale-105 transition">حفظ ✅</button>
</div>
</div>
</div>
<!-- Edit/Adjust Stock Modal -->
<div id="editItemModal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); backdrop-filter:blur(4px);">
<div class="bg-white w-11/12 md:w-96 mx-auto mt-32 rounded-2xl shadow-2xl overflow-hidden animate-slideDown">
<!-- Header -->
<div class="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-5 text-center">
<h3 class="text-xl font-bold mb-1">تعديل الرصيد</h3>
<p id="edit-item-name" class="text-sm text-slate-300">اسم الصنف</p>
</div>
<!-- Body -->
<div class="p-6">
<div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6 text-center">
<div class="text-sm text-blue-600 mb-2">الرصيد الحالي</div>
<div id="edit-current-stock" class="text-4xl font-bold text-blue-700">0</div>
<div id="edit-unit" class="text-xs text-blue-500 mt-1">قطعة</div>
</div>
<div class="grid grid-cols-2 gap-3">
<!-- Add Stock Button -->
<button onclick="performStockAdjust('add')" class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
<div class="text-3xl mb-1">➕</div>
<div class="text-sm">إضافة رصيد</div>
</button>
<!-- Subtract Stock Button -->
<button onclick="performStockAdjust('subtract')" class="bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
<div class="text-3xl mb-1">➖</div>
<div class="text-sm">صرف من الرصيد</div>
</button>
</div>
</div>
<!-- Footer -->
<div class="p-4 bg-gray-50 border-t text-center">
<button onclick="closeEditModal()" class="px-8 py-2 rounded-lg font-bold text-gray-600 bg-white border border-gray-300 hover:bg-gray-100 transition">
إلغاء
</button>
</div>
</div>
</div>
<!-- Edit Price Modal - NEW -->
<div id="editPriceModal" style="display:none; position:fixed; z-index:10001; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); backdrop-filter:blur(4px);">
<div class="bg-white w-11/12 md:w-96 mx-auto mt-32 rounded-2xl shadow-2xl overflow-hidden animate-slideDown">
<!-- Header -->
<div class="bg-gradient-to-r from-amber-600 to-amber-700 text-white p-5 text-center">
<h3 class="text-xl font-bold mb-1">💰 تعديل السعر/التكلفة</h3>
<p id="price-item-name" class="text-sm text-amber-200">اسم الصنف</p>
</div>
<!-- Body -->
<div class="p-6 space-y-4">
<div>
<label class="block text-gray-700 font-bold mb-2">السعر/التكلفة الحالية (ج.م)</label>
<div class="flex items-center gap-2">
<input type="number" id="editPriceInput" placeholder="0" class="flex-1 border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
<span class="text-2xl font-bold text-amber-600">ج.م</span>
</div>
<p id="price-old-value" class="text-xs text-gray-500 mt-2">السعر القديم: 0</p>
</div>
<div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
<p class="text-sm text-amber-700">
<strong>ملاحظة:</strong> هذا السعر سيُستخدم لحساب القيمة الإجمالية (الرصيد × السعر)
</p>
</div>
</div>
<!-- Footer -->
<div class="p-4 bg-gray-50 border-t flex gap-3">
<button onclick="closeEditPriceModal()" class="flex-1 px-4 py-2 rounded-lg font-bold text-gray-600 bg-white border border-gray-300 hover:bg-gray-100 transition">
إلغاء
</button>
<button onclick="saveEditedPrice()" class="flex-1 px-4 py-2 rounded-lg font-bold text-white bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 shadow transition">
💾 حفظ
</button>
</div>
</div>
</div>
<script>
window.openEditPriceModal=function() {
if (!window.inventorySystem || !window.inventorySystem.currentItem) {
return alert('❌ لم يتم تحديد صنف');
}
const item=window.inventorySystem.currentItem;
const cost=item.cost || item.price || item.avgCost || 0;
document.getElementById('price-item-name').textContent=item.name || 'صنف';
document.getElementById('price-old-value').textContent=`السعر القديم: ${cost} ج.م`;
document.getElementById('editPriceInput').value=cost;
document.getElementById('editPriceModal').style.display='block';
setTimeout(()=> document.getElementById('editPriceInput').focus(), 100);
};
window.closeEditPriceModal=function() {
document.getElementById('editPriceModal').style.display='none';
};
window.saveEditedPrice=async function() {
if (!window.inventorySystem || !window.inventorySystem.currentItem) {
return alert('❌ خطأ: لم يتم تحديد الصنف');
}
const newPrice=Number(document.getElementById('editPriceInput').value);
if (isNaN(newPrice) || newPrice < 0) {
return alert('⚠️ أدخل سعراً صحيحاً');
}
try {
const item=window.inventorySystem.currentItem;
const tab=window.inventorySystem.currentTab;
await db.collection('inventory_items').doc(item.id).set({
cost: newPrice,
price: newPrice,
avgCost: newPrice,
updatedAt: serverTs()
}, { merge: true });
console.log(`✅ سعر محدث في السحابة: ${item.name} → ${newPrice}`);
const array=tab==='raw' ? window.costRaw :
tab==='packing' ? window.costPack :
window.costFinished;
if (Array.isArray(array)) {
const idx=array.findIndex(i=> i && (i.id===item.id || i.name===item.name));
if (idx >=0) {
array[idx].cost=newPrice;
array[idx].price=newPrice;
localStorage.setItem(
tab==='raw' ? 'cost_raw' : tab==='packing' ? 'cost_pack' : 'cost_finished',
JSON.stringify(array)
);
}
}
const payload={};
if (tab==='raw') {
payload.raw=window.costRaw;
} else if (tab==='packing') {
payload.pack=window.costPack;
} else if (tab==='finished') {
payload.finished=window.costFinished;
}
payload.updatedAt=serverTs();
await db.collection('settings').doc('costLists').set(payload, { merge: true });
closeEditPriceModal();
window.inventorySystem.currentItem.cost=newPrice;
window.inventorySystem.currentItem.price=newPrice;
window.inventorySystem.currentItem.avgCost=newPrice;
document.getElementById('modal-cost').textContent=newPrice;
if (typeof window.inventorySystem.loadInventoryData==='function') {
window.inventorySystem.loadInventoryData(tab);
}
if (typeof window.updateTotalValue==='function') {
setTimeout(()=> window.updateTotalValue(), 300);
}
alert(`✅ تم تحديث السعر بنجاح!\n${item.name}: ${newPrice} ج.م`);
} catch(e) {
console.error('Error saving price:', e);
alert(`❌ خطأ في الحفظ: ${e.message}`);
}
};
window.logMovement=async function(itemId, itemName, qty, type, tab) {
try {
if (!window.db || !navigator.onLine) return;
const movementData={
itemId: itemId,
itemName: itemName,
quantity: Math.abs(qty),
type: type, 
category: tab, 
timestamp: serverTs(),
date: new Date().toISOString(),
user: 'نظام' 
};
await db.collection('inventory_items').doc(itemId).collection('movements').add(movementData);
console.log(`📝 حركة مسجلة: ${itemName} → ${qty} (${type})`);
} catch(e) {
console.warn('Could not log movement:', e.message);
}
};
window.loadMovementHistory=async function(itemId) {
try {
if (!window.db || !navigator.onLine) {
console.log('Offline - cannot load movements');
return [];
}
const snapshot=await db.collection('inventory_items')
.doc(itemId)
.collection('movements')
.orderBy('timestamp', 'desc')
.limit(5)
.get();
const movements=[];
snapshot.forEach(doc=> {
movements.push(doc.data());
});
return movements;
} catch(e) {
console.warn('Error loading movements:', e.message);
return [];
}
};
window.displayMovementHistory=function(movements) {
const tbody=document.getElementById('modal-movements');
if (!tbody) return;
if (!movements || movements.length===0) {
tbody.innerHTML='<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">لا توجد حركات مسجلة</td></tr>';
return;
}
tbody.innerHTML=movements.map(m=> {
const date=m.timestamp ? new Date(m.timestamp.toDate()).toLocaleDateString('ar-EG', {
year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
}) : m.date;
const typeLabel=m.type==='add' ? '➕ إضافة' : '➖ صرف';
return `
<tr class="hover:bg-gray-50">
<td class="px-4 py-3 text-right text-sm text-gray-600">${date}</td>
<td class="px-4 py-3 text-center text-sm font-semibold">${m.quantity}</td>
<td class="px-4 py-3 text-center text-sm">${typeLabel}</td>
<td class="px-4 py-3 text-right text-sm text-gray-500">${m.user || 'نظام'}</td>
</tr>
`;
}).join('');
};
function switchInvTab(tab) {
['finished', 'raw', 'packing'].forEach(t=> {
const btn=document.getElementById('btn-'+t);
if (btn) {
btn.classList.remove('active', 'bg-white', 'text-blue-600', 'border-b-4', 'border-blue-600');
btn.classList.add('text-gray-600');
}
document.getElementById('tab-'+t+'-content')?.classList.add('hidden');
});
const activeBtn=document.getElementById('btn-'+tab);
if (activeBtn) {
activeBtn.classList.add('active', 'bg-white', 'text-blue-600', 'border-b-4', 'border-blue-600');
activeBtn.classList.remove('text-gray-600');
}
document.getElementById('tab-'+tab+'-content')?.classList.remove('hidden');
if (window.inventorySystem && window.inventorySystem.loadInventoryData) {
window.inventorySystem.loadInventoryData(tab);
}
if (typeof updateCounters==='function') {
setTimeout(()=> updateCounters(), 100);
}
if (typeof updateTotalValue==='function') {
setTimeout(()=> updateTotalValue(), 200);
}
}
</script>
<!-- Logout binding -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    const btn = document.getElementById('logout-btn');
    if (!btn) return;
    btn.addEventListener('click', async function(){
      try {
        if (!confirm('هل تريد تسجيل الخروج؟')) return;
        try { if (window.auth && typeof auth.signOut==='function') await auth.signOut(); } catch(_){}
        try { AuthSystem.logout(); } catch(_){}
        try { UIController.showLoginPage(); } catch(_){}
      } catch(e){ alert('فشل تسجيل الخروج: ' + (e && e.message ? e.message : e)); }
    });
  } catch(_){}
});
</script>
<script>
(function(){
try { window.inventorySystem=window.inventorySystem || {}; } catch(_){ window.inventorySystem={}; }
window.inventorySystem._syncFromLocalStorage=function(){
try { if (!Array.isArray(window.costFinished)) window.costFinished=JSON.parse(localStorage.getItem('cost_finished')||'[]'); } catch(_){}
try { if (!Array.isArray(window.costRaw)) window.costRaw=JSON.parse(localStorage.getItem('cost_raw')||'[]'); } catch(_){}
try { if (!Array.isArray(window.costPack)) window.costPack=JSON.parse(localStorage.getItem('cost_pack')||'[]'); } catch(_){}
try { window._finishedGridState=Object.assign({}, window._finishedGridState || {}, JSON.parse(localStorage.getItem('finished_products_grid')||'{}')); } catch(_){}
try { window._rawGridState=Object.assign({}, window._rawGridState || {}, JSON.parse(localStorage.getItem('raw_materials_grid')||'{}')); } catch(_){}
try { window._packGridState=Object.assign({}, window._packGridState || {}, JSON.parse(localStorage.getItem('packaging_grid')||'{}')); } catch(_){}
};
window.inventorySystem.loadInventoryData=function(tab){
try { window.inventorySystem.currentTab=tab; } catch(_){}
try { window.inventorySystem._syncFromLocalStorage(); } catch(_){}
const map={
finished: document.getElementById('table-finished'),
raw: document.getElementById('table-raw'),
packing: document.getElementById('table-packing')
};
const body=map[tab];
if (!body) return;
body.innerHTML='';
if (tab==='finished') {
const list=Array.isArray(window.costFinished) ? window.costFinished : [];
if (!list.length) { body.innerHTML='<tr><td colspan="4" class="text-center p-4 text-gray-500">لا توجد منتجات تامة مُسجلة.</td></tr>'; window.updateTotalValue?.(); return; }
list.forEach(item=> {
const id=item.id || item.code || '';
const stObj=(window._finishedGridState||{})[id] || {};
const sItem=Number(item.stock);
const sAct=Number(stObj.actual);
const sBook=Number(stObj.bookBalance);
const sOpen=Number(stObj.opening);
const stock=(!isNaN(sItem) ? sItem : (!isNaN(sAct) ? sAct : (!isNaN(sBook) ? sBook : (!isNaN(sOpen) ? sOpen : 0))));
const unit=item.unit || 'قطعة';
const cAvg=Number(item.avgCost);
const cCost=Number(item.cost);
const cPrice=Number(item.price);
const cost=(!isNaN(cAvg) ? cAvg : (!isNaN(cCost) ? cCost : (!isNaN(cPrice) ? cPrice : 0)));
const tr=document.createElement('tr');
tr.innerHTML=`<td class="p-3 w-1/4 text-right">${item.name||item.code||'-'}</td><td class="p-3 w-1/4 text-center">${isNaN(stock)?0:stock}</td><td class="p-3 w-1/4 text-right">${unit}</td><td class="p-3 w-1/4 text-center">${isNaN(cost)?0:cost}</td>`;
tr.addEventListener('click', function(){
try {
window.inventorySystem.currentItem=Object.assign({}, item, { stock, avgCost: cost });
const modal=document.getElementById('itemCardModal');
const titleEl=document.getElementById('modal-title');
const catEl=document.getElementById('modal-category');
const codeEl=document.getElementById('modal-code');
const stockEl=document.getElementById('modal-stock');
const unitEl=document.getElementById('modal-unit');
const costEl=document.getElementById('modal-cost');
const totalEl=document.getElementById('modal-total-value');
if (titleEl) titleEl.textContent=(item.name||item.code||'صنف');
if (catEl) catEl.textContent='📦 منتج تام';
if (codeEl) codeEl.textContent=String(item.id||item.code||'');
if (stockEl) stockEl.textContent=String(stock||0);
if (unitEl) unitEl.textContent=String(unit||'');
if (costEl) costEl.textContent=String(cost||0);
if (totalEl) totalEl.textContent=String(Math.round((stock||0)*(cost||0)));
if (modal && modal.style) modal.style.display='block';
} catch(_){}
});
body.appendChild(tr);
});
} else if (tab==='raw') {
const list=Array.isArray(window.costRaw) ? window.costRaw : [];
if (!list.length) { body.innerHTML='<tr><td colspan="4" class="text-center p-4 text-gray-500">لا توجد خامات مُسجلة.</td></tr>'; window.updateTotalValue?.(); return; }
list.forEach(item=> {
const name=(item && (item.name||item.code)) ? String(item.name||item.code) : '';
const snap=(window._rawGridState||{})[name] || {};
const sItem=Number(item.stock);
const actual=Number(snap.actual);
const book=Number(snap.bookBalance);
const opening=Number(snap.opening);
const stock=(!isNaN(sItem) ? sItem : (!isNaN(actual) && snap.actual !=='' ? actual : (!isNaN(book) ? book : (!isNaN(opening) ? opening : 0))));
const unit=item.unit || item.unitName || '';
const up=Number(snap.unitPrice);
const cAvg=Number(item.avgCost);
const cCost=Number(item.cost);
const cost=(!isNaN(cAvg) ? cAvg : (!isNaN(cCost) ? cCost : (!isNaN(up) ? up : 0)));
const tr=document.createElement('tr');
tr.innerHTML=`<td class="p-3 w-1/4 text-right">${name||'-'}</td><td class="p-3 w-1/4 text-center">${isNaN(stock)?0:stock}</td><td class="p-3 w-1/4 text-right">${unit}</td><td class="p-3 w-1/4 text-center">${isNaN(cost)?0:cost}</td>`;
tr.addEventListener('click', function(){
try {
window.inventorySystem.currentItem=Object.assign({}, item, { stock, avgCost: cost });
const modal=document.getElementById('itemCardModal');
const titleEl=document.getElementById('modal-title');
const catEl=document.getElementById('modal-category');
const codeEl=document.getElementById('modal-code');
const stockEl=document.getElementById('modal-stock');
const unitEl=document.getElementById('modal-unit');
const costEl=document.getElementById('modal-cost');
const totalEl=document.getElementById('modal-total-value');
if (titleEl) titleEl.textContent=name||'صنف';
if (catEl) catEl.textContent='🥛 خامات';
if (codeEl) codeEl.textContent=String(item.id||item.code||'');
if (stockEl) stockEl.textContent=String(stock||0);
if (unitEl) unitEl.textContent=String(unit||'');
if (costEl) costEl.textContent=String(cost||0);
if (totalEl) totalEl.textContent=String(Math.round((stock||0)*(cost||0)));
if (modal && modal.style) modal.style.display='block';
} catch(_){}
});
body.appendChild(tr);
});
} else if (tab==='packing') {
const list=Array.isArray(window.costPack) ? window.costPack : [];
if (!list.length) { body.innerHTML='<tr><td colspan="4" class="text-center p-4 text-gray-500">لا توجد مواد تغليف مُسجلة.</td></tr>'; window.updateTotalValue?.(); return; }
list.forEach(item=> {
const name=(item && (item.name||item.code)) ? String(item.name||item.code) : '';
const snap=(window._packGridState||{})[name] || {};
const sItem=Number(item.stock);
const actual=Number(snap.actual);
const book=Number(snap.bookBalance);
const opening=Number(snap.opening);
const stock=(!isNaN(sItem) ? sItem : (!isNaN(actual) && snap.actual !=='' ? actual : (!isNaN(book) ? book : (!isNaN(opening) ? opening : 0))));
const unit=item.unit || item.unitName || '';
const up=Number(snap.unitPrice);
const cAvg=Number(item.avgCost);
const cCost=Number(item.cost);
const cost=(!isNaN(cAvg) ? cAvg : (!isNaN(cCost) ? cCost : (!isNaN(up) ? up : 0)));
const tr=document.createElement('tr');
tr.innerHTML=`<td class="p-3 w-1/4 text-right">${name||'-'}</td><td class="p-3 w-1/4 text-center">${isNaN(stock)?0:stock}</td><td class="p-3 w-1/4 text-right">${unit}</td><td class="p-3 w-1/4 text-center">${isNaN(cost)?0:cost}</td>`;
tr.addEventListener('click', function(){
try {
window.inventorySystem.currentItem=Object.assign({}, item, { stock, avgCost: cost });
const modal=document.getElementById('itemCardModal');
const titleEl=document.getElementById('modal-title');
const catEl=document.getElementById('modal-category');
const codeEl=document.getElementById('modal-code');
const stockEl=document.getElementById('modal-stock');
const unitEl=document.getElementById('modal-unit');
const costEl=document.getElementById('modal-cost');
const totalEl=document.getElementById('modal-total-value');
if (titleEl) titleEl.textContent=name||'صنف';
if (catEl) catEl.textContent='🥡 تغليف';
if (codeEl) codeEl.textContent=String(item.id||item.code||'');
if (stockEl) stockEl.textContent=String(stock||0);
if (unitEl) unitEl.textContent=String(unit||'');
if (costEl) costEl.textContent=String(cost||0);
if (totalEl) totalEl.textContent=String(Math.round((stock||0)*(cost||0)));
if (modal && modal.style) modal.style.display='block';
} catch(_){}
});
body.appendChild(tr);
});
}
try { if (typeof window.updateTotalValue==='function') window.updateTotalValue(); } catch(_){}
};
window.filterInventory=function(){
const q=(document.getElementById('inventorySearch')?.value||'').toLowerCase();
const tab=window.inventorySystem?.currentTab || 'finished';
const bodyId=tab==='finished' ? 'table-finished' : tab==='raw' ? 'table-raw' : 'table-packing';
const body=document.getElementById(bodyId);
if (!body) return;
Array.from(body.querySelectorAll('tr')).forEach(tr=> {
const nameCell=tr.children[0];
const name=(nameCell?.textContent||'').toLowerCase();
tr.style.display=(q && !name.includes(q)) ? 'none' : '';
});
try { window.updateTotalValue && window.updateTotalValue(); } catch(_){}
};
window.updateTotalValue=function(){
const tab=window.inventorySystem?.currentTab || 'finished';
const bodyId=tab==='finished' ? 'table-finished' : tab==='raw' ? 'table-raw' : 'table-packing';
const body=document.getElementById(bodyId);
const outEl=document.getElementById('total-inventory-value');
if (!body || !outEl) return;
let total=0;
Array.from(body.querySelectorAll('tr')).forEach(tr=> {
if (tr.style.display==='none') return;
const stock=Number(tr.children[1]?.textContent||0) || 0;
const cost=Number(tr.children[3]?.textContent||0) || 0;
total +=(stock * cost);
});
try { outEl.textContent=`${Math.round(total).toLocaleString('ar-EG')} ج.م`; } catch(_){ outEl.textContent=String(Math.round(total)) + ' ج.م'; }
};
window.inventorySystem.showAddItemModal=function(){ try { document.getElementById('addItemModal').style.display='block'; } catch(_){} };
})();
window.openEditItemModal=function(){
if (!window.inventorySystem || !window.inventorySystem.currentItem) {
alert('❌ لم يتم تحديد صنف');
return;
}
const item=window.inventorySystem.currentItem;
const stock=item.stock || 0;
const unit=item.unit || item.unitName || 'قطعة';
document.getElementById('edit-item-name').textContent=item.name || 'صنف';
document.getElementById('edit-current-stock').textContent=String(stock);
document.getElementById('edit-unit').textContent=String(unit);
document.getElementById('editItemModal').style.display='block';
};
window.closeEditModal=function(){
document.getElementById('editItemModal').style.display='none';
};
window.performStockAdjust=async function(action){
try {
if (!window.inventorySystem || !window.inventorySystem.currentItem) {
alert('❌ لم يتم تحديد صنف');
return;
}
const item=window.inventorySystem.currentItem;
const qtyInput=document.querySelector('input[placeholder*="الكمية"]') || document.querySelector('input[type="number"]');
if (!qtyInput) {
alert('⚠️ لم يتم إدخال كمية');
return;
}
const qty=Number(qtyInput.value);
if (isNaN(qty) || qty <=0) {
alert('⚠️ أدخل كمية صحيحة');
return;
}
const currentStock=Number(item.stock || 0);
const newStock=action==='add' ? currentStock + qty : Math.max(0, currentStock - qty);
item.stock=newStock;
if (window.inventorySystem.loadInventoryData) {
window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab || 'finished');
}
closeEditModal();
alert(`✅ تم تحديث الرصيد: ${item.name} → ${newStock}`);
} catch(e) {
console.warn('performStockAdjust failed:', e);
alert(`❌ خطأ: ${e.message}`);
}
};
</script>
</div>
<!-- PAGE: PRODUCTION RUNS / التشغيلات -->
<div id="page-production" class="page" style="padding-bottom: 80px;">
<div class="mb-6 flex items-center justify-between">
<h3 class="text-xl font-bold flex items-center gap-2">
<i data-lucide="settings" class="w-6 h-6 text-green-600"></i>
إدارة التشغيلات (دفعات الإنتاج)
</h3>
<button id="create-production-btn" onclick="window.openCreateProductionModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
<i data-lucide="plus" class="w-4 h-4"></i> تشغيلة جديدة
</button>
</div>
<div class="p-4 rounded-lg bg-green-50 border border-green-200 text-sm leading-relaxed mb-6">
إنشاء تشغيلات إنتاج جديدة بناءً على الوصفات. كل تشغيلة تُتبع من البدء إلى الانتهاء، مع تحديث المخزون وحساب الأرباح والخسائر تلقائياً.
</div>
<!-- Tabs for viewing productions -->
<div class="flex gap-2 mb-4 border-b">
<button id="tab-active-productions" class="px-4 py-2 font-semibold text-green-600 border-b-2 border-green-600">التشغيلات الجارية</button>
<button id="tab-completed-productions" class="px-4 py-2 font-semibold text-gray-600 hover:text-gray-800">التشغيلات المنتهية</button>
</div>
<!-- Active Productions Table -->
<div id="active-productions-section" class="mb-6">
<div class="overflow-x-auto bg-white rounded-lg shadow">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-green-50">
<tr>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">رقم التشغيلة</th>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">المنتج</th>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">الوصفة</th>
<th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">تاريخ البدء</th>
<th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الكمية المتوقعة</th>
<th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الحالة</th>
<th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الإجراءات</th>
</tr>
</thead>
<tbody id="active-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
</table>
</div>
<div id="no-active-productions" class="text-center py-6 text-gray-500">لا توجد تشغيلات جارية حالياً</div>
</div>
<!-- Completed Productions Table -->
<div id="completed-productions-section" class="mb-6 hidden">
<div class="overflow-x-auto bg-white rounded-lg shadow">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-blue-50">
<tr>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">رقم التشغيلة</th>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">المنتج</th>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">الكمية النهائية</th>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">التكلفة الإجمالية</th>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">سعر البيع</th>
<th class="px-3 py-3 text-right text-xs font-semibold text-gray-700">الربح/الخسارة</th>
<th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">تاريخ الانتهاء</th>
<th class="px-3 py-3 text-center text-xs font-semibold text-gray-700">الإجراءات</th>
</tr>
</thead>
<tbody id="completed-productions-table-body" class="bg-white divide-y divide-gray-200"></tbody>
</table>
</div>
<div id="no-completed-productions" class="text-center py-6 text-gray-500">لا توجد تشغيلات منتهية حالياً</div>
</div>
</div>
<div id="page-total-bills" class="page">
<div id="total-bills-content-wrapper">
<h2 class="text-xl font-bold mb-4">إجمالي الفواتير</h2>
<!-- Filter Controls -->
<div id="total-bills-filters" class="bg-gray-100 p-4 rounded-lg mb-4 no-print">
<div class="grid grid-cols-1 md:grid-cols-5 gap-4">
<div>
<label for="filter-from-date" class="block text-sm font-medium text-gray-700">من تاريخ</label>
<input type="date" id="filter-from-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
</div>
<div>
<label for="filter-to-date" class="block text-sm font-medium text-gray-700">إلى تاريخ</label>
<input type="date" id="filter-to-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
</div>
<div>
<label for="filter-customer-name" class="block text-sm font-medium text-gray-700">اسم العميل</label>
<input type="text" id="filter-customer-name" placeholder="بحث..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
</div>
<div>
<label for="filter-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة</label>
<input type="number" id="filter-invoice-number" placeholder="بحث..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
</div>
<div class="flex flex-col gap-1">
<button id="reset-to-current-month-btn" class="bg-gray-500 text-white py-1 px-2 rounded-lg hover:bg-gray-600 text-sm">الشهر الحالي</button>
<button id="apply-filters-btn" class="bg-blue-600 text-white py-1 px-2 rounded-lg hover:bg-blue-700">تطبيق الفلترة</button>
</div>
</div>
</div>
<!-- Total Display -->
<div id="total-bills-summary-container" class="bg-green-100 border-r-4 border-green-500 p-3 rounded-lg mb-4 text-center shadow-md flex items-center justify-center gap-4">
<div>
<span class="font-semibold">إجمالي الفواتير المعروضة:</span>
<span id="total-bills-summary-amount" class="font-bold text-green-800">0 ج.م</span>
</div>
<div class="flex items-center border-r-2 border-green-300 pr-4">
<input type="checkbox" id="include-total-in-export" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
<label for="include-total-in-export" class="mr-2 text-sm font-medium text-green-900">تضمين الإجمالي</label>
</div>
</div>
<!-- Bills Table -->
<div class="overflow-x-auto bg-white rounded-lg shadow">
<table id="total-bills-table" class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="p-4"><input type="checkbox" id="select-all-total-bills"></th>
<th data-sort="date" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">التاريخ</th> <th data-sort="invoiceNumber" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">رقم الفاتورة</th>
<th data-sort="customerName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">اسم العميل</th>
<th data-sort="repName" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">اسم المندوب</th>
<th data-sort="total" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">إجمالي الفاتورة</th>
<th data-sort="status" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">النوع/الحالة</th>
<th data-sort="category" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">القسم/الصنف</th>
</tr>
</thead> <tbody id="total-bills-table-body" class="bg-white divide-y divide-gray-200">
<!-- Rows will be injected by JavaScript -->
</tbody>
</table>
</div>
</div>
<!-- Action Buttons -->
<div class="mt-4 flex gap-2 no-print">
<button onclick="printSection('total-bills-content-wrapper')" class="w-1/2 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide='printer'></i> طباعة الكل</button>
<button onclick="generateReportImage('total-bills-content-wrapper')" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide='image'></i> نسخ الكل كصورة</button>
</div>
<div class="mt-2 p-3 border-t-2 border-dashed no-print">
<div class="flex gap-2">
<button onclick="exportSelectedRows('print')" class="w-1/2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> طباعة المحدد</button>
<button onclick="exportSelectedRows('image')" class="w-1/2 bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"><i data-lucide='check-square'></i> نسخ المحدد كصورة</button>
</div>
</div>
</div>
<div id="page-settings" class="page">
<div class="space-y-6">
<!-- شريط تحكم سريع داخل الإعدادات -->
<!-- الزر اليدوي لإصلاح شيكولاتة تم إزالته وجُعل العمل تلقائيًا -->
<div class="flex items-center justify-end gap-2 no-print">
<button id="open-user-management-btn" class="bg-purple-600 text-white px-3 py-2 rounded-md text-sm hover:bg-purple-700 flex items-center gap-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
إدارة المستخدمين
</button>
</div>
<!-- إدارة المستخدمين والأدوار (للمدراء فقط) -->
<div id="user-management-section" class="p-4 border rounded-lg bg-white hidden">
<div class="flex justify-between items-center mb-2">
<h3 class="text-lg font-bold">إدارة المستخدمين</h3>
<button id="refresh-users-btn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-gray-300">تحديث</button>
</div>
<p class="text-xs text-gray-500 mb-2">يمكنك تعديل صلاحية كل مستخدم (admin, rep, viewer). التغييرات تُحفظ فوراً في Firestore.</p>
<div id="user-role-warning" class="p-2 mb-2 rounded border border-yellow-300 bg-yellow-50 text-yellow-800 hidden"></div>
<div class="mb-3 flex flex-wrap gap-2 items-center">
<button id="seed-missing-roles-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 flex items-center gap-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-plus"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M9 12h6"/><path d="M12 9v6"/></svg>
توليد الأدوار الناقصة
</button>
<span id="seed-roles-status" class="text-xs text-gray-600"></span>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200 text-sm">
<thead class="bg-gray-50">
<tr>
<th class="px-2 py-2 text-right">الاسم</th>
<th class="px-2 py-2 text-right">البريد</th>
<th class="px-2 py-2 text-center">الدور</th>
<th class="px-2 py-2 text-center">إجراءات</th>
</tr>
</thead>
<tbody id="users-table-body" class="bg-white divide-y divide-gray-100"></tbody>
</table>
</div>
</div>
<!-- محدد الشهر: اختيار فترة العرض الشهرية -->
<div>
<h3 class="text-lg font-bold mb-1">الفترة الشهرية المعروضة</h3>
<p class="text-xs text-gray-500 mb-2">اختر شهراً لاستعراض بياناته. يبدأ التطبيق تلقائياً بالشهر الحالي، ويمكنك الرجوع لأي شهر سابق من هنا.</p>
<div class="flex items-center gap-2">
<input type="month" id="active-period-input" class="p-2 border rounded-md" />
<button id="active-period-today-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-300">الشهر الحالي</button>
<span id="active-period-indicator" class="text-sm text-gray-600 ml-auto"></span>
</div>
</div>
<!-- تتبع موقع المناديب (GPS) -->
<div id="gps-settings" class="p-4 border rounded-lg bg-white">
<h3 class="text-lg font-bold mb-2">تتبع موقع المناديب (GPS)</h3>
<div class="flex items-center gap-2 mb-1">
<input type="checkbox" id="gps-share-toggle" class="w-4 h-4">
<label for="gps-share-toggle" class="text-sm">مشاركة موقعي من هذا الجهاز</label>
<span id="gps-share-status" class="text-xs text-gray-600 ml-auto"></span>
</div>
<p class="text-xs text-gray-500">عند التفعيل، سيطلب المتصفح إذن الوصول للموقع ويتم تحديث الإحداثيات دورياً في السحابة.</p>
<div id="admin-gps-list" class="mt-3 hidden">
<h4 class="font-semibold mb-1">مواقع المناديب الآن</h4>
<div id="rep-locations-list" class="space-y-2 text-sm"></div>
</div>
</div>
<div>
<h3 class="text-lg font-bold mb-2">الهدف الشهري العام للمبيعات</h3>
<p class="text-xs text-gray-500 mb-2">هذا هو الهدف الافتراضي (يستخدم في حال عدم اختيار مندوب محدد في لوحة المعلومات).</p>
<div class="flex items-center gap-2">
<input type="number" id="sales-target-input" class="w-full p-2 border rounded-md" placeholder="أدخل الهدف الشهري">
<button id="save-target-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">حفظ</button>
</div>
</div>
<div>
<h3 class="text-lg font-bold">شعار الشركة</h3>
<p class="text-xs text-gray-500 mb-2">أدخل رابط الشعار (URL) ليظهر في رأس التطبيق والتقارير. يمكنك استخدام رابط ملف محلي بصيغة file:/
<div class="flex items-center gap-2">
<input type="text" id="company-logo-input" class="w-full p-2 border rounded-md" placeholder="https://example.com/logo.jpg أو file:/
<button id="save-company-logo-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
</div>
<p class="text-xs text-gray-500 mt-2">نصيحة: لتحميل الصورة على الويب بسرعة استخدم خدمات مثل imgur.com أو GitHub (repo أو gist) أو أي استضافة صور لديك.</p>
</div>
<div>
<div class="flex justify-between items-center mb-2">
<h3 class="text-lg font-bold">كتالوج المنتجات</h3>
<button id="add-product-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">إضافة منتج</button>
</div>
<input id="search-products" type="text" placeholder="ابحث عن منتج..." class="w-full p-2 border rounded-md mb-2">
<div id="products-list" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
</div>
<!-- قوائم الأسعار (مُرتجعة هنا في الإعدادات كما كانت قبل التعديل) -->
<div>
<div class="flex justify-between items-center mb-2">
<h3 class="text-lg font-bold">قوائم الأسعار</h3>
<button id="add-price-list-btn" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700">إضافة قائمة</button>
</div>
<div id="price-lists-container" class="space-y-2 bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto"></div>
</div>
<div>
<h3 class="text-lg font-bold mb-2">النسخ الاحتياطي والاستعادة</h3>
<div class="p-4 border rounded-lg bg-gray-50 space-y-4">
<div>
<h4 class="font-semibold mb-2">1. نسخ البيانات (Backup) </h4>
<p class="text-xs text-gray-600 mb-2">اضغط لإنشاء كود يحتوي على كل بياناتك (عملاء، فواتير، منتجات، مناديب). انسخ هذا الكود واحتفظ به في مكان آمن.</p>
<button id="backup-data-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-2">إنشاء نسخة احتياطية الآن</button>
<textarea id="backup-data-textarea" class="w-full p-2 border rounded-md bg-gray-200" readonly placeholder="سيظهر كود النسخة الاحتياطية هنا..."></textarea>
<button id="copy-backup-btn" class="w-full mt-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 hidden">نسخ الكود</button>
</div>
<div class="border-t pt-4">
<h4 class="font-semibold mb-2">2. استعادة البيانات (Restore)</h4>
<p class="text-xs text-gray-600 mb-2">الصق الكود الذي نسخته سابقاً هنا لاستعادة بياناتك. <strong class="text-red-600">تحذير: هذا سيستبدل جميع البيانات الحالية.</strong></p>
<textarea id="restore-data-textarea" class="w-full p-2 border rounded-md" style="height: 100px;" placeholder="الصق كود النسخة الاحتياطية هنا..."></textarea>
<button id="restore-data-btn" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">استعادة البيانات</button>
</div>
</div>
</div>
<!-- أداة استيراد إلى السحابة (Firestore) - للمدير فقط -->
<div id="admin-cloud-import-section" class="p-4 border-2 border-yellow-300 rounded-lg bg-yellow-50 space-y-3 no-print hidden">
<h3 class="text-lg font-bold">استيراد نسخة قديمة إلى السحابة (Firestore)</h3>
<p class="text-xs text-gray-700">هذه الأداة ترفع محتويات ملف النسخة الاحتياطية القديم (JSON أو TXT) مباشرةً إلى جداول Firestore (customers, products, priceLists, reps, sales...). تظهر فقط للمستخدمين ذوي صلاحية admin.</p>
<div class="flex items-center gap-2">
<input id="admin-import-file" type="file" accept=".json,.txt,application/json,text/plain" class="flex-1 p-2 border rounded-md bg-white" />
<button id="admin-start-import-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed">بدء الاستيراد</button>
</div>
<div id="admin-import-status" class="text-sm text-gray-700"></div>
</div>
</div>
<!-- (قوائم الأسعار الآن مُدارة من صفحة الإعدادات - تم إرجاع الواجهة إلى مكانها داخل الإعدادات) -->
<!-- Reports Subnav (Moved functionality to Dashboard, kept hidden nav item for consistency) -->
<nav id="reports-subnav" class="fixed left-0 right-0 mx-auto justify-around p-2 no-print">
<button data-report-section="daily" class="reports-subnav-item active">
<i data-lucide="calendar"></i><span>يومي</span>
</button>
<button data-report-section="range" class="reports-subnav-item">
<i data-lucide="calendar-range"></i><span>فترة</span>
</button>
<button data-report-section="monthly" class="reports-subnav-item">
<i data-lucide="calendar"></i><span>شهري</span>
</button>
<button data-report-section="reconciliation" class="reports-subnav-item">
<i data-lucide="scale"></i><span>التسوية النهائية</span>
</button>
<button data-report-section="targets" class="reports-subnav-item">
<i data-lucide="target"></i><span>تارجت المناديب</span>
</button>
<button data-report-section="customer-targets" class="reports-subnav-item">
<i data-lucide="users"></i><span>تارجت العملاء</span>
</button>
</nav>
<!-- Costs Page: التكاليف (مبسطة) -->
<div id="page-costs" class="page" style="display:none; padding-bottom: 80px;">
<div class="mb-6 flex items-center justify-between">
<h3 class="text-xl font-bold flex items-center gap-2">
<i data-lucide="flask-conical" class="w-6 h-6 text-blue-600"></i>
حساب تكلفة المنتج
</h3>
<div class="flex items-center gap-2">
<button id="add-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
<i data-lucide="plus" class="w-4 h-4"></i> منتج جديد
</button>
<button id="save-and-produce-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1" style="display:none;">
<i data-lucide="check" class="w-4 h-4"></i> حفظ وإنشاء تشغيلة
</button>
<!-- أزلنا أزرار الاستيراد لتقليل الإزدحام. الاستيراد مازال متاحاً عبر الدوال العامة إن لزم. -->
</div>
</div>
<div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm leading-relaxed mb-6">
أدخل مكوّنات (خامات)، مواد تعبئة، ومصاريف تشغيل لكل <span class="font-bold">دفعة إنتاج</span>. يحسب النظام التكلفة الإجمالية وتكلفة الكيلو/الوحدة النهائية.
مثال: منتج "جبنة قريش" يخرج 50 كجم في دفعة؛ تضيف اللبن (كمية كجم وسعر للكجم)، المنفحة، الملح، ثم التغليف (أكياس، صناديق)، ثم مصروف التشغيل (كهرباء، أجور) بالقيمة الإجمالية.
</div>
<!-- Price Manager (Raw, Pack, Ops) -->
<!-- Unified Price Grid (Printable Overview) -->
<details id="unified-price-grid-block" class="mb-6 bg-white rounded-lg border">
<summary class="cursor-pointer select-none px-4 py-3 flex items-center gap-2 text-sm font-semibold">
<i data-lucide="table" class="w-4 h-4 text-indigo-600"></i>
شبكة موحدة لكل الأسعار
<span id="unified-grid-summary" class="ml-auto text-gray-500 text-xs"></span>
</summary>
<div class="px-4 pb-4 pt-2 space-y-3">
<div class="flex flex-wrap gap-2 text-xs">
<button type="button" id="unified-refresh-btn" class="px-3 py-1 rounded bg-indigo-600 text-white">تحديث</button>
<button type="button" id="unified-print-btn" class="px-3 py-1 rounded bg-gray-200 text-gray-800">طباعة</button>
<button type="button" id="unified-export-json-btn" class="px-3 py-1 rounded bg-green-600 text-white">تصدير JSON</button>
<button type="button" id="unified-export-csv-btn" class="px-3 py-1 rounded bg-emerald-500 text-white">تصدير CSV</button>
</div>
<div class="overflow-x-auto border rounded">
<table id="unified-price-grid" class="min-w-full divide-y divide-gray-200 text-xs">
<thead class="bg-gray-50">
<tr>
<th class="text-right px-2 py-1">الاسم</th>
<th class="text-center px-2 py-1">الكود</th>
<th class="text-center px-2 py-1">النوع</th>
<th class="text-center px-2 py-1">الوحدة</th>
<th class="text-center px-2 py-1">السعر الحالي</th>
<th class="text-center px-2 py-1">سعر جديد</th>
<th class="text-center px-2 py-1">آخر تحديث</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="text-[11px] text-gray-500">هذه الشبكة للعرض السريع في المكتب لتقدير التكلفة. أي تعديل للأسعار يتم من خلال قسم إدارة الأسعار أعلاه.</div>
</div>
</details>
<div id="recipes-list" class="space-y-6"></div>
</div>
<!-- Taxes Page -->
<div id="page-taxes" class="page" style="display:none; padding-bottom:80px;">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold flex items-center gap-2">
<i data-lucide="percent" class="w-6 h-6 text-blue-600"></i>
<span>الضرائب</span>
</h2>
</div>
<div class="bg-white p-4 rounded-lg shadow mb-4">
<div class="flex items-center gap-4">
<label class="text-sm font-medium">اختر الشهر</label>
<input id="tax-month-input" type="month" class="p-2 border rounded-md">
<button id="tax-refresh-btn" class="bg-blue-600 text-white px-3 py-2 rounded-md">عرض</button>
</div>
</div>
<div class="bg-white p-4 rounded-lg shadow mb-4">
<div class="flex gap-2 mb-3">
<button id="tax-tab-report" class="px-3 py-2 bg-gray-100 rounded">تقرير القيمة المضافة</button>
<button id="tax-tab-einvoices" class="px-3 py-2 bg-white rounded">سجل الفواتير</button>
</div>
<div id="tax-tab-content">
<!-- Report Tab -->
<div id="tax-report-tab">
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
<div class="p-4 border rounded text-center">
<div class="text-sm text-gray-500">إجمالي المبيعات الخاضعة</div>
<div id="tax-total-sales" class="text-2xl font-bold">0</div>
</div>
<div class="p-4 border rounded text-center">
<div class="text-sm text-gray-500">الضريبة الخارجة (Output VAT)</div>
<div id="tax-output-vat" class="text-2xl font-bold">0</div>
</div>
<div class="p-4 border rounded text-center">
<div class="text-sm text-gray-500">الضريبة الداخلة (Input VAT)</div>
<div id="tax-input-vat" class="text-2xl font-bold">0</div>
</div>
<div class="p-4 border rounded text-center">
<div class="text-sm text-gray-500">الصافي المستحق</div>
<div id="tax-net-payable" class="text-2xl font-bold">0</div>
</div>
</div>
</div>
<!-- E-Invoice Log Tab -->
<div id="tax-einvoices-tab" style="display:none;">
<div class="overflow-x-auto mt-3">
<table class="w-full table-auto border-collapse">
<thead>
<tr class="text-sm text-gray-600">
<th class="p-2 text-left">Invoice #</th>
<th class="p-2 text-left">Date</th>
<th class="p-2 text-left">Customer</th>
<th class="p-2 text-right">Total</th>
<th class="p-2 text-left">UUID</th>
<th class="p-2 text-left">Status</th>
</tr>
</thead>
<tbody id="einvoice-log-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- Main Bottom Nav - Adjusted buttons after moving reports -->
<nav id="main-nav-bar" class="bottom-nav fixed bottom-0 left-0 right-0 mx-auto bg-white border-t shadow-t p-2 flex justify-around no-print" style="display:flex;visibility:visible;z-index:1000;min-height:64px;height:auto;opacity:1;pointer-events:auto;">
<button data-page="dashboard" class="bottom-nav-item active flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
<span class="text-xs">الرئيسية</span>
</button>
<button data-page="spreadsheet-entry" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-table"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
<span class="text-xs">إدخال سريع</span>
</button>
<!-- BUTTON FOR SALES PAGE (Search, view all invoices) -->
<button data-page="sales" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6"/><path d="M16 12h-6"/><path d="M16 16h-6"/></svg>
<span class="text-xs">المبيعات</span>
</button>
<button data-page="dispatch" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>
<span class="text-xs">الاذونات</span>
</button>
<!-- REPORTS BUTTON RETAINED, NOW GOES TO DEDICATED REPORTS PAGE -->
<button data-page="reports" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
<span class="text-xs">التقارير</span>
</button>
<!-- TAXES Button -->
<button data-page="taxes" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><path d="M21 12A9 9 0 1 1 3 12 9 9 0 0 1 21 12z"/><path d="M9 9h.01"/><path d="M15 15h.01"/><path d="M7 17l10-10"/></svg>
<span class="text-xs">الضرائب</span>
</button>
<!-- COSTS / التكاليف Button -->
<button id="costs-nav-btn" data-page="costs" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layers"><path d="M12 2 1 7l11 5 11-5L12 2z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
<span class="text-xs">التكاليف</span>
</button>
<!-- NEW: Production / التشغيلات Button -->
<button id="production-nav-btn" data-page="production" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.08 5.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08-5.08l4.24-4.24"/></svg>
<span class="text-xs">التشغيلات</span>
</button>
<button data-page="promotions" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent"><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
<span class="text-xs">العروض</span>
</button>
<button data-page="customers" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
<span class="text-xs">العملاء</span>
</button>
<button data-page="reps" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2"><path d="M14 19a6 6 0 0 0-12 0"/><circle cx="8" cy="9" r="4"/><path d="M22 19a6 6 0 0 0-6-6 4 4 0 1 0 0-8"/></svg>
<span class="text-xs">المناديب</span>
</button>
<!-- NEW: Cash (الكاش) Button -->
<button id="cash-nav-btn" data-page="cash" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
<span class="text-xs">الكاش</span>
</button>
<!-- NEW: Debts (المديونيات) Button -->
<button id="debts-nav-btn" data-page="debts" class="bottom-nav-item flex flex-col items-center text-gray-600">
<!-- Using a simple wallet/credit icon similar to design -->
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M21 12v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h14"/><path d="M16 3v4"/><path d="M8 12h.01"/></svg>
<span class="text-xs">المديونيات</span>
</button>
<button data-page="stock-control" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
<span class="text-xs">ستوك كنترول</span>
</button>
<button data-page="total-bills" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
<span class="text-xs">إجمالي الفواتير</span>
</button>
<!-- NEW: Inquiry (استعلام) Button -->
<button data-page="inquiry" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
<span class="text-xs">استعلام</span>
</button>
<!-- NEW: Price Lists (قوائم الأسعار) Button -->
<button data-page="price-lists" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-dollar-sign"><path d="M7 21h10"/><path d="M12 17v-6"/><path d="M9 14h6"/><path d="M12 9h.01"/><path d="M12 3 2 9l10 6 10-6Z"/></svg>
<span class="text-xs">قوائم الأسعار</span>
</button>
<button data-page="settings" class="bottom-nav-item flex flex-col items-center text-gray-600">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
<span class="text-xs">الإعدادات</span>
</button>
</nav>
</div>
<!-- ########## MODALS ########## -->
<!-- CUSTOM CONFIRMATION/ALERT DIALOG -->
<div id="custom-confirm-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
<h2 id="dialog-title" class="text-xl font-bold mb-4">إشعار</h2>
<p id="dialog-message" class="text-gray-700 mb-6"></p>
<div id="dialog-actions" class="flex justify-end gap-3">
<button id="dialog-cancel-btn" type="button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 hidden">إلغاء</button>
<button id="dialog-confirm-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">تأكيد</button>
</div>
</div>
</div>
<!-- PRICE HISTORY MODAL -->
<div id="price-history-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
<div class="flex justify-between items-center mb-3">
<h2 id="ph-title" class="text-xl font-bold">سجل الأسعار</h2>
<button id="ph-close-btn" type="button" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
</div>
<div class="overflow-x-auto mb-4">
<table class="min-w-full divide-y divide-gray-200 text-sm">
<thead>
<tr>
<th class="text-center px-2 py-1">السعر</th>
<th class="text-center px-2 py-1">التاريخ</th>
<th class="text-right px-2 py-1">ملاحظة</th>
</tr>
</thead>
<tbody id="ph-body"></tbody>
</table>
</div>
<div class="flex items-end gap-2">
<div class="flex-1">
<label class="block text-xs text-gray-600 mb-1">سعر جديد</label>
<input id="ph-new-price" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="0.00" />
</div>
<div class="flex-[2]">
<label class="block text-xs text-gray-600 mb-1">ملاحظة (اختياري)</label>
<input id="ph-new-note" class="w-full p-2 border rounded" placeholder="مورد/تفاصيل" />
</div>
<button id="ph-add-btn" class="bg-blue-600 text-white px-3 py-2 rounded h-[42px]">إضافة</button>
</div>
</div>
</div>
<!-- LOADING MODAL -->
<div id="loading-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
<div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4">
<div class="loader"></div>
<p id="loading-message" class="text-lg font-semibold text-gray-700">جارٍ التحميل...</p>
</div>
</div>
<!-- LOGIN MODAL -->
<div id="login-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-right">
<h2 class="text-xl font-bold mb-4">تسجيل الدخول</h2>
<form id="login-modal-form">
<div class="mb-4">
<label for="login-email-modal" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
<input type="email" id="login-email-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
<div class="mb-4">
<label for="login-password-modal" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
<div class="relative">
<input type="password" id="login-password-modal" class="mt-1 block w-full p-2 border border-gray-300 rounded-md pr-10" required>
<button type="button" class="absolute inset-y-0 left-2 text-gray-500 hover:text-gray-800 toggle-password" data-target="login-password-modal" title="إظهار/إخفاء">👁️</button>
</div>
</div>
<button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold">تسجيل الدخول</button>
</form>
</div>
</div>
<!-- DEBTS SUMMARY MODAL (المديونيات) -->
<div id="debts-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right" style="display:none !important">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">ملخص المديونيات</h2>
<button type="button" onclick="closeModal(document.getElementById('debts-summary-modal'))" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
</div>
<div id="debts-summary-content" class="space-y-4">
<div>
<h3 class="font-bold">المديونيات حسب العملاء</h3>
<div class="overflow-x-auto mt-2">
<table id="debts-by-customer" class="min-w-full divide-y divide-gray-200 text-sm">
<thead>
<tr>
<th class="text-right px-2 py-1">اسم العميل</th>
<th class="text-center px-2 py-1">إجمالي الفواتير</th>
<th class="text-center px-2 py-1">المسدد</th>
<th class="text-center px-2 py-1">المتبقى</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- MANAGE LISTS MODAL -->
<div id="manage-lists-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body text-right">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">ادارة القوائم</h2>
<button type="button" onclick="closeManageListsModal()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400">إغلاق</button>
</div>
<!-- progress area: updated while chunked rendering proceeds -->
<div id="manage-lists-progress" class="mb-3 text-sm text-gray-600" style="display:none">جارٍ تحميل العناصر...</div>
<div class="space-y-4">
<div>
<h3 class="font-bold">المنتجات التامة</h3>
<div class="overflow-x-auto mt-2">
<table id="manage-finished-table" class="min-w-full divide-y divide-gray-200 text-sm">
<thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">سعر</th><th></th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
<div>
<h3 class="font-bold">الخامات (مواد إنتاج)</h3>
<div class="overflow-x-auto mt-2">
<table id="manage-raw-table" class="min-w-full divide-y divide-gray-200 text-sm">
<thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">تكلفة</th><th></th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
<div>
<h3 class="font-bold">التغليف/التعبئة</h3>
<div class="overflow-x-auto mt-2">
<table id="manage-pack-table" class="min-w-full divide-y divide-gray-200 text-sm">
<thead><tr><th class="text-right px-2 py-1">الاسم</th><th class="text-center px-2 py-1">الوحدة</th><th class="text-center px-2 py-1">تكلفة</th><th></th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="pt-3 border-t flex justify-between items-center">
<div class="text-sm text-gray-600">يمكنك حذف أي عنصر من القوائم أو إغلاق النافذة للعودة.</div>
<div>
<button id="manage-export-btn" class="bg-green-600 text-white px-3 py-1 rounded">تصدير القوائم</button>
</div>
</div>
</div>
</div>
</div>
<div>
<h3 class="font-bold">المديونيات حسب المندوب</h3>
<div class="overflow-x-auto mt-2">
<table id="debts-by-rep" class="min-w-full divide-y divide-gray-200 text-sm">
<thead>
<tr>
<th class="text-right px-2 py-1">اسم المندوب</th>
<th class="text-center px-2 py-1">إجمالي الفواتير</th>
<th class="text-center px-2 py-1">المسدد</th>
<th class="text-center px-2 py-1">المتبقى</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="pt-3 border-t">
<div class="flex justify-between items-center">
<div class="font-bold">إجمالي المديونيات (المتبقي)</div>
<div id="debts-summary-total" class="font-extrabold text-lg">0 ج.م</div>
</div>
</div>
</div>
</div>
</div>
<!-- NEW FULL-SCREEN SALE MODAL (for detailed single entry) -->
<div id="sale-modal" class="modal modal-hidden fixed inset-0 bg-gray-100 z-30 flex flex-col">
<header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center no-print">
<h2 id="sale-modal-title" class="text-xl font-bold">إضافة عملية بيع</h2>
<button id="cancel-sale-btn" class="p-2 hover:bg-blue-700 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
</header>
<main class="flex-grow p-4 overflow-y-auto">
<form id="sale-form">
<input type="hidden" id="sale-id">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<label for="sale-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
<select id="sale-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
<input type="text" id="sale-rep-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
</div>
<div>
<label for="sale-customer" class="block text-sm font-medium text-gray-700">العميل</label>
<select id="sale-customer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
<input type="text" id="sale-customer-display" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly style="display:none;" aria-hidden="true">
</div>
<div>
<label for="sale-date" class="block text-sm font-medium text-gray-700">تاريخ الفاتورة</label>
<input type="date" id="sale-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
<div>
<label for="sale-invoice-number" class="block text-sm font-medium text-gray-700">رقم الفاتورة (يدوي)</label>
<input type="number" id="sale-invoice-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="أدخل رقم الفاتورة من الدفتر">
</div>
</div>
<div class="overflow-x-auto bg-white rounded-lg shadow">
<table class="sale-items-table min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase w-2/5">المنتج</th>
<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الكمية</th>
<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">السعر</th>
<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">الإجمالي</th>
<th class="px-2 py-2"></th>
</tr>
</thead>
<tbody id="sale-items-container" class="bg-white divide-y divide-gray-200">
<!-- Sale item rows will be injected here by JS -->
</tbody>
</table>
</div>
<button type="button" id="add-sale-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
<i data-lucide="plus-circle" class="w-4 h-4"></i>
إضافة منتج آخر
</button>
<div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label for="sale-notes" class="block text-sm font-medium text-gray-700">ملاحظات</label>
<textarea id="sale-notes" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
</div>
<div class="space-y-3">
<div class="grid grid-cols-2 gap-4">
<div>
<label for="sale-status" class="block text-sm font-medium text-gray-700">حالة الدفع</label>
<select id="sale-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
<option value="paid">مدفوع بالكامل</option>
<option value="due">آجل</option>
<option value="partial">مدفوع جزئياً</option>
</select>
</div>
<div id="paid-amount-container" class="hidden">
<label for="sale-paid-amount" class="block text-sm font-medium text-gray-700">المبلغ المدفوع</label>
<input type="number" id="sale-paid-amount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
</div>
</div>
<div>
<label for="sale-discount" class="block text-sm font-medium text-gray-700">خصم على الفاتورة (%)</label>
<input type="number" id="sale-discount" placeholder="مثال: 2 أو 3.5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
</div>
<div>
<label for="sale-addition" class="block text-sm font-medium text-gray-700">إضافة على الفاتورة (%)</label>
<input type="number" id="sale-addition" placeholder="مثال: 14" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="any">
<p class="text-xs text-gray-500 mt-1">يتم حسابها كزيادة على الإجمالي الفرعي (قبل الخصم).</p>
</div>
</div>
</div>
</form>
</main>
<footer class="p-4 bg-white border-t no-print">
<div id="sale-summary" class="max-w-md ml-auto text-lg space-y-2">
<div class="flex justify-between"><span>الإجمالي الفرعي:</span><span id="sale-subtotal-text">0 ج.م</span></div>
<div class="flex justify-between text-red-600"><span>الخصم:</span><span id="sale-discount-text">0 ج.م</span></div>
<div class="flex justify-between"><span>ضريبة القيمة المضافة (VAT):</span><span id="sale-vat-text">0 ج.م</span></div>
<div class="flex justify-between"><span>الاستقطاع (1% إن كان العميل جهة خاضعة للضريبة):</span><span id="sale-withholding-text">0 ج.م</span></div>
<hr class="my-2">
<div class="flex justify-between font-bold text-2xl"><span>إجمالي بعد الضرائب والاقتطاعات:</span><span id="sale-final-text">0 ج.م</span></div>
<div class="flex justify-between font-bold text-2xl"><span style="opacity:0.75">إجمالي (عرض قديم)</span><span id="sale-total-text" style="opacity:0.6">0 ج.م</span></div>
</div>
<div class="flex justify-end gap-3 mt-4">
<button type="button" id="eta-upload-from-modal-btn" class="hidden bg-purple-700 text-white px-6 py-3 rounded-lg hover:bg-purple-800 font-bold text-lg flex items-center gap-2">
<i data-lucide="cloud-upload" class="w-5 h-5"></i>
إرسال للضرائب
</button>
<button type="submit" form="sale-form" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg">حفظ الفاتورة</button>
</div>
</footer>
</div>
<!-- CUSTOMER MODAL -->
<div id="customer-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
<h2 id="customer-modal-title" class="text-xl font-bold mb-4">إضافة عميل جديد</h2>
<form id="customer-form">
<input type="hidden" id="customer-id">
<div class="mb-4">
<label for="customer-name" class="block text-sm font-medium text-gray-700">اسم العميل</label>
<input type="text" id="customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
<!-- NEW: Tax Number Input -->
<div class="mb-4">
<label for="customer-tax-number" class="block text-sm font-medium text-gray-700">الرقم الضريبي</label>
<input type="text" id="customer-tax-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="أدخل الرقم الضريبي">
</div>
<!-- END NEW -->
<div class="mb-4">
<label for="customer-phone" class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
<input type="tel" id="customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
</div>
<div class="mb-4">
<label for="customer-address" class="block text-sm font-medium text-gray-700">العنوان (رابط خرائط جوجل)</label>
<input type="text" id="customer-address" placeholder="الصق رابط خرائط جوجل هنا..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
</div>
<!-- NEW: Requires Tax Filing Checkbox -->
<div class="mb-4 flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
<input type="checkbox" id="customer-requires-tax" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 ml-2">
<label for="customer-requires-tax" class="block text-sm font-medium text-orange-800">العميل يتطلب رفع فواتيره لمنظومة الضرائب</label>
</div>
<!-- END NEW -->
<div class="mb-4">
<label for="customer-price-list" class="block text-sm font-medium text-gray-700">قائمة الأسعار</label>
<select id="customer-price-list" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
</div>
<div class="mb-4">
<label for="customer-rep" class="block text-sm font-medium text-gray-700">المندوب المسؤول</label>
<select id="customer-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
</div>
<div class="flex justify-end gap-3">
<button type="button" id="cancel-customer-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ العميل</button>
</div>
</form>
</div>
</div>
<!-- PLACEHOLDER MODALS -->
<div id="rep-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
<h2 id="rep-modal-title" class="text-xl font-bold mb-4">إدارة مندوب</h2>
<form id="rep-form">
<input type="hidden" id="rep-id">
<div class="mb-4"><label for="rep-name" class="block text-sm font-medium text-gray-700">اسم المندوب</label><input type="text" id="rep-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
<div class="mb-4"><label for="rep-email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني للمندوب</label><input type="email" id="rep-email" class="mt-1 block w-full p-2 border rounded-md" placeholder="example@email.com" required></div>
<div class="mb-4"><label for="rep-serial" class="block text-sm font-medium text-gray-700">كود/سيريال</label><input type="text" id="rep-serial" class="mt-1 block w-full p-2 border rounded-md"></div>
<div class="mb-4"><label for="rep-target" class="block text-sm font-medium text-gray-700">الهدف الشهري</label><input type="number" id="rep-target" class="mt-1 block w-full p-2 border rounded-md" value="0"></div>
<div class="mb-4"><label for="rep-next-invoice" class="block text-sm font-medium text-gray-700">رقم الفاتورة القادمة</label><input type="number" id="rep-next-invoice" class="mt-1 block w-full p-2 border rounded-md"></div>
<div class="flex justify-end gap-3"><button type="button" id="cancel-rep-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ المندوب</button></div>
</form>
</div>
</div>
<div id="product-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
<h2 id="product-modal-title" class="text-xl font-bold mb-4">إدارة منتج</h2>
<form id="product-form">
<input type="hidden" id="product-id">
<div class="mb-4"><label for="product-code" class="block text-sm font-medium text-gray-700">كود المنتج</label><input type="text" id="product-code" class="mt-1 block w-full p-2 border rounded-md" required></div>
<div class="mb-4"><label for="product-name" class="block text-sm font-medium text-gray-700">اسم المنتج</label><input type="text" id="product-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
<div class="mb-4"><label for="product-price" class="block text-sm font-medium text-gray-700">السعر الافتراضي</label><input type="number" id="product-price" class="mt-1 block w-full p-2 border rounded-md" step="any" required></div>
<div class="mb-4"><label for="product-category" class="block text-sm font-medium text-gray-700">الفئة (للتصفية)</label><input type="text" id="product-category" class="mt-1 block w-full p-2 border rounded-md"></div>
<div class="mb-4"><label for="product-vat-rate" class="block text-sm font-medium text-gray-700">نسبة الضريبة لكل وحدة (%)</label><input type="number" id="product-vat-rate" class="mt-1 block w-full p-2 border rounded-md" step="0.01" value="0"></div>
<div class="flex justify-end gap-3"><button type="button" id="cancel-product-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ المنتج</button></div>
</form>
</div>
</div>
<div id="price-list-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-4 modal-body">
<h2 id="price-list-modal-title" class="text-xl font-bold mb-2">إدارة قائمة أسعار</h2>
<!-- Quick discount box (editable) -->
<div class="flex items-center justify-start gap-3 mb-3">
<label for="price-list-discount" class="text-sm text-gray-700">نسبة الخصم السريع</label>
<input id="price-list-discount" type="text" value="5%" class="w-16 p-1 border rounded text-center font-bold bg-white" title="اكتب نسبة الخصم مثل 5% أو 10%" />
<span class="text-xs text-gray-500">(سيتم عرض السعر بعد الخصم في العمود الأخير)</span>
</div>
<form id="price-list-form">
<input type="hidden" id="price-list-id">
<div class="mb-4"><label for="price-list-name" class="block text-sm font-medium text-gray-700">اسم القائمة</label><input type="text" id="price-list-name" class="mt-1 block w-full p-2 border rounded-md" required></div>
<!-- Replaced products list with an Excel-like table view (keeps same id to preserve JS bindings) -->
<div id="price-list-products" class="overflow-x-auto max-h-[60vh] border rounded-lg bg-white">
<table id="price-list-products-table" class="min-w-full divide-y divide-gray-200 text-sm">
<thead class="bg-gray-50 sticky top-0">
<tr>
<th class="px-3 py-2 text-right">م</th>
<th class="px-3 py-2 text-center">الكود</th>
<th class="px-3 py-2 text-right">اسم الصنف</th>
<th class="px-3 py-2 text-center">الوحدة</th>
<th class="px-3 py-2 text-center">الباركود</th>
<th class="px-3 py-2 text-center">السعر</th>
<th class="px-3 py-2 text-center">السعر بعد الخصم</th>
</tr>
</thead>
<tbody id="price-list-products-body" class="bg-white">
<tr>
<td colspan="7" class="text-center text-gray-500 p-6">جاري تحميل المنتجات...</td>
</tr>
</tbody>
</table>
</div>
<div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-price-list-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">حفظ القائمة</button></div>
</form>
</div>
</div>
<!-- NEW PROMOTION MODAL -->
<div id="promotion-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
<h2 id="promotion-modal-title" class="text-xl font-bold mb-4">إضافة عرض جديد</h2>
<form id="promotion-form">
<input type="hidden" id="promotion-id">
<div class="mb-4">
<label for="promotion-name" class="block text-sm font-medium text-gray-700">اسم العرض</label>
<input type="text" id="promotion-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
<div class="mb-4">
<label for="promotion-product" class="block text-sm font-medium text-gray-700">المنتج</label>
<select id="promotion-product" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
</div>
<div id="original-price-display" class="mb-2 text-sm text-gray-600 hidden">
السعر الافتراضي للمنتج: <span id="current-product-price" class="font-bold"></span>
</div>
<div class="mb-4">
<label for="promotion-price" class="block text-sm font-medium text-gray-700">سعر العرض</label>
<input type="number" id="promotion-price" class="mt-1 block w-full p-2 border border-red-400 bg-red-50 rounded-md font-bold" required step="any" placeholder="السعر المخفض">
</div>
<div class="mb-4">
<label for="promotion-customer-id" class="block text-sm font-medium text-gray-700">العميل المستهدف (اختياري)</label>
<select id="promotion-customer-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
<p class="text-xs text-gray-500 mt-1">إذا لم تختر عميلاً، سيتم تطبيق العرض على **جميع** العملاء.</p>
</div>
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<label for="promotion-start-date" class="block text-sm font-medium text-gray-700">تاريخ البداية</label>
<input type="date" id="promotion-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
<div>
<label for="promotion-end-date" class="block text-sm font-medium text-gray-700">تاريخ الانتهاء</label>
<input type="date" id="promotion-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
</div>
<div class="flex justify-end gap-3">
<button type="button" id="cancel-promotion-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
<button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">حفظ العرض</button>
</div>
</form>
</div>
</div>
<!-- END PROMOTION MODAL -->
<!-- NOTIFICATION (اخطار) MODAL -->
<div id="notify-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4" style="display:none;">
<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 text-right">
<div class="flex justify-between items-center mb-3">
<h2 id="notify-modal-title" class="text-xl font-bold">اخطار</h2>
<button type="button" onclick="closeNotifyModal()" class="p-2 hover:bg-gray-100 rounded-md">إغلاق</button>
</div>
<form id="notify-form">
<input type="hidden" id="notify-type" value="">
<div class="grid grid-cols-2 gap-3 mb-3">
<div>
<label class="text-sm font-medium">عنوان الإخطار (كلمتين)</label>
<input id="notify-title" type="text" maxlength="40" placeholder="مثال: تغيير سعر" class="mt-1 block w-full p-2 border rounded-md">
</div>
<div>
<label class="text-sm font-medium">النوع</label>
<select id="notify-type-select" class="mt-1 block w-full p-2 border rounded-md">
<option value="prices">تغيير سعر</option>
<option value="new-item">صنف جديد</option>
<option value="promotions">عرض</option>
</select>
</div>
</div>
<div id="notify-product-container" style="display:none;" class="mb-3">
<label class="text-sm font-medium">اختر صنف</label>
<select class="mt-1 block w-full p-2 border rounded-md" id="notify-product"></select>
</div>
<div id="notify-promo-container" style="display:none;" class="mb-3">
<label class="text-sm font-medium">اختر عرض</label>
<select class="mt-1 block w-full p-2 border rounded-md" id="notify-promo"></select>
</div>
<div id="notify-new-item-container" style="display:none;" class="mb-3">
<label class="text-sm font-medium">اسم الصنف الجديد</label>
<input type="text" id="notify-new-item-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="ادخل اسم الصنف الجديد">
</div>
<div class="mb-3">
<label class="text-sm font-medium">قائمة الأصناف والأسعار (صفوف مثل Excel)</label>
<div class="mt-2 mb-2 grid grid-cols-2 gap-2">
<div>
<label class="text-xs text-gray-500">اختر عميل (اختياري)</label>
<select id="notify-customer" class="mt-1 block w-full p-2 border rounded-md"></select>
</div>
<div>
<label class="text-xs text-gray-500">خصم عام % (تطبيق على كل الصفوف)</label>
<input id="notify-global-discount" type="number" min="0" max="100" step="0.01" placeholder="0" class="mt-1 block w-full p-2 border rounded-md">
</div>
</div>
<div class="mt-2 mb-2 flex gap-2">
<button type="button" id="notify-add-row-btn" class="bg-gray-100 px-3 py-1 rounded-md">إضافة صف</button>
<button type="button" id="notify-paste-btn" class="bg-gray-100 px-3 py-1 rounded-md">لصق من Excel</button>
</div>
<div class="overflow-x-auto border rounded">
<table class="min-w-full text-sm" id="notify-rows-table">
<thead class="bg-gray-50"><tr>
<th class="px-2 py-2 text-right">كود</th>
<th class="px-2 py-2 text-right">صنف</th>
<th class="px-2 py-2 text-center">سعر</th>
<th class="px-2 py-2 text-center">خصم %</th>
<th class="px-2 py-2 text-center">سعر بعد الخصم</th>
<th class="px-2 py-2"></th>
</tr></thead>
<tbody id="notify-rows-body"><tr><td colspan="6" class="text-center text-gray-500 p-4">لا توجد صفوف بعد.</td></tr></tbody>
</table>
</div>
<textarea id="notify-paste-area" placeholder="الصق بيانات Excel هنا (كود\tاسم\tسعر\tخصم%)" class="w-full mt-2 p-2 border rounded-md" style="display:none;min-height:80px"></textarea>
</div>
<div class="mb-3">
<label class="text-sm font-medium">نص موجز (اختياري)</label>
<input id="notify-short-text" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="سطر قصير يظهر مع الإخطار للمستخدم أو العميل">
</div>
<div class="mb-3">
<label class="text-sm font-medium">رابط شعار الشركة (اختياري)</label>
<input id="notify-logo-url" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="https://example.com/logo.png - سيضاف كرابط في الرسالة">
<p class="text-xs text-gray-500 mt-1">ملاحظة: لإرسال صورة فعلياً عبر واتساب تحتاج رفع الصورة على URL متاح ثم استخدام واجهة واتساب لإرسال ميديا. هنا سنضيف رابط الشعار داخل النص.</p>
</div>
<div class="flex justify-between items-center gap-2">
<div class="flex gap-2">
<button type="button" id="notify-share-wa-btn" class="bg-green-600 text-white px-4 py-2 rounded-md">مشاركة على واتساب</button>
<button type="button" onclick="closeNotifyModal()" class="bg-gray-300 px-4 py-2 rounded-md">إلغاء</button>
</div>
<div>
<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">حفظ الإخطار</button>
</div>
</div>
</form>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', ()=> {
try {
setTimeout(()=> {
try {
if (typeof renderDebts==='function') {
try { renderDebts(); } catch (e) { console.warn('renderDebts call failed', e); }
}
const tbody=document.getElementById('debts-detail-body');
if (tbody) {
Array.from(tbody.children).forEach(tr=> {
try {
tr.style.display='table-row';
tr.style.visibility='visible';
tr.style.opacity='1';
Array.from(tr.children).forEach(td=> {
td.style.display='table-cell';
td.style.color='#111';
td.style.opacity='1';
td.style.visibility='visible';
td.style.fontSize='14px';
});
} catch (e) {}
});
console.log('Force-styled debts rows, count=', tbody.children.length);
}
} catch (e) { console.warn('Debts force-render failed', e); }
}, 150);
} catch (e) { console.warn('Debts DOMContentLoaded handler failed', e); }
});
</script>
<!-- Modals for Reports/Dispatch/Statements (Keeping placeholders for compatibility) -->
<div id="statement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4"></div>
<div id="date-range-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
<!-- Date Range Form / Statement Customer List -->
<div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
<h2 class="text-xl font-bold mb-4">كشف حساب يدوي</h2>
<form id="date-range-form">
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<label for="start-date" class="block text-sm font-medium text-gray-700">تاريخ البداية</label>
<input type="date" id="start-date" class="mt-1 block w-full p-2 border rounded-md" required>
</div>
<div>
<label for="end-date" class="block text-sm font-medium text-gray-700">تاريخ الانتهاء</label>
<input type="date" id="end-date" class="mt-1 block w-full p-2 border rounded-md" required>
</div>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">تصفية حسب صنف:</label>
<div class="flex flex-wrap gap-4">
<label class="flex items-center"><input type="radio" name="product-category" value="all" checked class="text-blue-600 focus:ring-blue-500 ml-1"> الكل</label>
<label class="flex items-center"><input type="radio" name="product-category" value="dairy" class="text-blue-600 focus:ring-blue-500 ml-1"> ألبان</label>
<label class="flex items-center"><input type="radio" name="product-category" value="multi" class="text-blue-600 focus:ring-blue-500 ml-1"> مالتي</label>
</div>
</div>
<div class="mb-4">
<label for="supermarket-chain-filter" class="block text-sm font-medium text-gray-700">تصفية حسب السلسلة</label>
<select id="supermarket-chain-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
<option value="all">جميع الفروع</option>
<option value="exception">اكسبشن ماركت</option>
<option value="awladragab">اولاد رجب</option>
<option value="samysalama">سامي سلامه</option>
<option value="gomlamarket">جملة ماركت</option>
<option value="dreams">دريمز</option>
</select>
</div>
<h3 class="text-lg font-bold mb-3 border-t pt-4">اختر العملاء المطلوبين:</h3>
<input type="text" id="statement-customer-search" placeholder="ابحث باسم العميل..." class="w-full p-2 border rounded-md mb-3">
<div id="statement-customer-list" class="space-y-1 max-h-48 overflow-y-auto border p-2 rounded-md bg-gray-50">
<!-- Customers will be injected here -->
</div>
<div class="flex justify-end gap-3 mt-4">
<button type="button" id="cancel-date-range-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
<button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">إنشاء كشف الحساب</button>
</div>
</form>
</div>
</div>
<div id="dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
<h2 id="dispatch-modal-title" class="text-xl font-bold mb-4">إضافة إذن استلام بضاعة</h2>
<form id="dispatch-note-form">
<input type="hidden" id="dispatch-note-id">
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
<div>
<label for="dispatch-rep" class="block text-sm font-medium text-gray-700">المندوب</label>
<select id="dispatch-rep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
</div>
<div>
<label for="dispatch-date" class="block text-sm font-medium text-gray-700">تاريخ الإذن</label>
<input type="date" id="dispatch-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
</div>
</div>
<div class="overflow-x-auto bg-gray-50 rounded-lg shadow mt-4 border">
<table id="dispatch-items-table" class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-2 text-right text-xs font-medium text-gray-600 uppercase w-2/5">المنتج</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مستلم (كمية)</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع سليم</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مرتجع تالف</th>
<th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase">مجاني</th>
<th class="px-2 py-2"></th>
</tr>
</thead>
<tbody id="dispatch-items-container" class="divide-y divide-gray-200">
<!-- Dispatch item rows will be injected here -->
</tbody>
</table>
</div>
<button type="button" id="add-dispatch-item-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
<i data-lucide="plus-circle" class="w-4 h-4"></i>
إضافة صنف آخر للإذن
</button>
<div class="flex justify-end gap-3 mt-6">
<button type="button" id="cancel-dispatch-note-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إلغاء</button>
<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ الإذن</button>
</div>
</form>
</div>
</div>
<div id="view-dispatch-note-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
<!-- Content injected dynamically -->
<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-body">
<div id="dispatch-note-view-content">
<!-- Report details will be injected here -->
</div>
<div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
<button id="close-view-dispatch-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
<button id="print-dispatch-btn" onclick="printSection('dispatch-note-view-content')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
<i data-lucide="printer" class="w-5 h-5"></i>
<span>طباعة (Ctrl+P)</span>
</button>
</div>
</div>
</div>
<div id="settlement-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-40 p-4">
<!-- Adding main content div inside modal placeholder for consistency -->
<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6">
<h2 id="settlement-modal-title" class="text-xl font-bold mb-4">تسوية مرتجعات إذن الاستلام</h2>
<div id="settlement-content">
<!-- Settlement report will be generated here -->
<p class="text-center text-gray-500 mt-2">يتم تحميل بيانات التسوية...</p>
</div>
<div class="flex justify-end mt-4">
<button onclick="closeModal(document.getElementById('settlement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
</div>
</div>
</div>
<div id="reconciliation-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"></div>
<div id="rep-sales-summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 modal-body">
<h2 id="rep-sales-summary-title" class="text-xl font-bold mb-4">كشف حساب المندوب</h2>
<div id="rep-sales-summary-content">
<!-- Rep Statement content injected dynamically -->
</div>
<div class="flex justify-end mt-4">
<button onclick="closeModal(document.getElementById('rep-sales-summary-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
</div>
</div>
</div>
<div id="daily-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
<div id="customer-sales-report-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
<div id="ai-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 p-4"></div>
<!-- NEW: Image Preview Modal -->
<div id="image-preview-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
<h2 class="text-xl font-bold mb-4">معاينة الصورة</h2>
<p class="text-sm text-gray-600 mb-4">يمكنك الآن نسخ الصورة بالضغط عليها بالزر الأيمن (أو الضغط المطول في الجوال) واختيار "نسخ الصورة"، أو تحميلها على جهازك.</p>
<div id="image-preview-container" class="mb-4 border p-2 bg-gray-100 max-h-[60vh] overflow-y-auto"></div>
<div class="flex justify-end gap-3">
<button type="button" onclick="closeModal(document.getElementById('image-preview-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
<button id="download-image-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">تحميل الصورة</button>
</div>
</div>
</div>
<!-- Removed duplicate Firebase SDK (9.6.10) to avoid double init -->
<script>
const ROLE_PAGE_ALLOW={
admin: 'ALL',
reviewer: 'ALL',
manager: 'ALL',
rep: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch']),
user: new Set(['dashboard','spreadsheet-entry','sales','inquiry','dispatch'])
};
let lastRequestedPage=null; 
function canAccessPage(pageName){
try {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='guest') {
return pageName==='dashboard';
}
if (role==='admin') return true;
const set=ROLE_PAGE_ALLOW[role];
if (!set) return false;
if (set==='ALL') return true;
return set.has(pageName);
} catch(_) { return false; }
}
(function(){
try {
const obs=new MutationObserver((mutations)=>{
try {
const actives=Array.from(document.querySelectorAll('.page.active'));
actives.forEach(el=> {
const id=el.id || '';
const page=id.startsWith('page-') ? id.slice(5) : null;
if (!page) return;
if (!canAccessPage(page)) {
el.classList.remove('active');
el.style.display='none';
if (lastRequestedPage===page) {
try { customDialog({ title:'غير مصرح', message:'صلاحياتك لا تسمح بفتح هذه الصفحة.' }); } catch(_) { alert('غير مصرح'); }
}
try { navigateTo('dashboard'); } catch(_) { }
}
});
} catch(e){}
});
obs.observe(document.documentElement, { subtree:true, attributes:true, attributeFilter:['class','style'] });
} catch(e){}
})();
function switchPage(pageName) {
try { lastRequestedPage=pageName; } catch(_){}
if (typeof navigateTo==='function') { navigateTo(pageName); return; }
}
function navigateToPage(pageName) {
switchPage(pageName);
}
function navigateTo(pageName) {
  if (!pageName) return;
  // Hide all pages
  const allPages = document.querySelectorAll('.page');
  allPages.forEach(p => {
    p.classList.remove('active');
    p.style.display = 'none';
  });
  // Show target page with "page-" prefix
  const targetId = pageName.startsWith('page-') ? pageName : `page-${pageName}`;
  const targetPage = document.getElementById(targetId);
  if (targetPage) {
    targetPage.classList.add('active');
    targetPage.style.display = 'block';
    try { targetPage.classList.remove('hidden'); } catch(_){ }
  } else {
    console.warn('navigateTo: page not found:', targetId);
  }
  // Update nav buttons
  document.querySelectorAll('.bottom-nav-item').forEach(btn => {
    if (btn.dataset.page === pageName) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  // Refresh icon colors/visibility
  try {
    const svgs = document.querySelectorAll('#main-nav-bar .bottom-nav-item svg');
    svgs.forEach(svg => {
      const parent = svg.closest('.bottom-nav-item');
      const isActive = parent && parent.classList.contains('active');
      const color = isActive ? '#2563eb' : '#6b7280';
      svg.style.visibility = 'visible';
      svg.style.opacity = '1';
      svg.style.display = 'inline-block';
      svg.style.color = color;
      svg.setAttribute('stroke', color);
      svg.setAttribute('fill', 'none');
      svg.setAttribute('stroke-width', '2');
      svg.style.pointerEvents = 'none';
    });
  } catch(_) {}
  try { lastRequestedPage = pageName; } catch(_) {}
}
window.navigateTo = navigateTo;
document.addEventListener('DOMContentLoaded', function() {
document.querySelectorAll('.bottom-nav-item').forEach(btn=> {
btn.addEventListener('click', function() {
const pageName=this.getAttribute('data-page');
if (pageName) {
if (pageName==='sales' || pageName==='reports' || pageName==='debts') {
try { ensureDefaultActivePeriod(); } catch(e){}
}
switchPage(pageName);
}
});
});
setTimeout(()=>{
try {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role && role !=='admin' && ROLE_PAGE_ALLOW[role] && ROLE_PAGE_ALLOW[role] !=='ALL') {
const allowed=ROLE_PAGE_ALLOW[role];
document.querySelectorAll('.bottom-nav-item').forEach(btn=> {
const pg=btn.getAttribute('data-page');
if (pg && !allowed.has(pg)) {
btn.style.display='none';
}
});
}
} catch(e){}
}, 400);
switchPage('dashboard');
let roleCheckCount=0;
const roleCheckInterval=setInterval(()=>{
roleCheckCount++;
const currentRole=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (currentRole && currentRole !=='guest') {
try {
if (currentRole !=='admin' && ROLE_PAGE_ALLOW[currentRole] && ROLE_PAGE_ALLOW[currentRole] !=='ALL') {
const allowed=ROLE_PAGE_ALLOW[currentRole];
document.querySelectorAll('.bottom-nav-item').forEach(btn=> {
const pg=btn.getAttribute('data-page');
if (pg && !allowed.has(pg)) btn.style.display='none';
});
}
} catch(e){}
clearInterval(roleCheckInterval);
} else if (roleCheckCount > 120) { 
clearInterval(roleCheckInterval);
}
}, 1000);
});
</script>
<!-- Lucide Icons - Direct CDN Link -->
<script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
<script>
console.log('بدء تحميل الكود');
let observer;
const initIcons=()=> {
if (window.lucide && typeof window.lucide.createIcons==='function') {
if (observer) {
observer.disconnect();
}
window.lucide.createIcons();
if (observer) {
observer.observe(document.body, {
childList: true,
subtree: true,
});
}
}
};
observer=new MutationObserver((mutations)=> {
for (const mutation of mutations) {
if (mutation.type==='childList' && mutation.addedNodes.length > 0) {
const hasLucideIcons=Array.from(mutation.addedNodes).some(
(node)=>
node.nodeType===Node.ELEMENT_NODE &&
(node.hasAttribute('data-lucide') || node.querySelector('[data-lucide]'))
);
if (hasLucideIcons) {
initIcons();
break;
}
}
}
});
document.addEventListener('DOMContentLoaded', ()=> {
initIcons();
observer.observe(document.body, {
childList: true,
subtree: true,
});
});
window.addEventListener('load', initIcons);
document.addEventListener('click', function(e){
const btn=e.target.closest('#seed-missing-roles-btn');
if (!btn) return;
try {
const role=(typeof getUserRole==='function')? getUserRole(): 'user';
if (role !=='admin') { alert('هذه العملية للمشرف فقط'); return; }
const statusEl=document.getElementById('seed-roles-status');
if (statusEl) statusEl.textContent='جاري الفحص...';
if (!window.db) { if (statusEl) statusEl.textContent='Firestore غير جاهز'; return; }
const users=(window.state && Array.isArray(state.users)) ? window.state.users : [];
const forcedAdmins=new Set((window.FORCED_ADMINS||[]).map(e=>String(e).toLowerCase()));
const forcedReviewers=new Set((window.FORCED_REVIEWERS||[]).map(e=>String(e).toLowerCase()));
const missing=[];
users.forEach(u=> {
const uid=u._id || u.uid || u.id; const email=(u.email||'').toLowerCase();
if (!uid) return;
if (u.role) return; 
if (forcedAdmins.has(email) || forcedReviewers.has(email)) return; 
missing.push({ uid, email });
});
if (missing.length===0) { if (statusEl) statusEl.textContent='لا توجد أدوار ناقصة.'; return; }
if (statusEl) statusEl.textContent='إنشاء '+missing.length+' مستند دور...';
const ops=missing.map(m=> window.db.collection('roles').doc(m.uid).set({ role: 'rep', email: m.email, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
Promise.allSettled(ops).then(results=> {
const ok=results.filter(r=>r.status==='fulfilled').length;
const fail=results.length - ok;
if (statusEl) statusEl.textContent='تم إنشاء '+ok+' / '+results.length+'؛ فشل '+fail+'.';
document.dispatchEvent(new Event('role-ready'));
}).catch(err=> { if (statusEl) statusEl.textContent='خطأ: '+err.message; });
} catch(err){ console.warn('seed-missing-roles error', err); }
});
const DEFAULT_PRODUCTS=[
{id: '1', name: 'لبن جاموسى', price: 44.00, category: 'dairy'}, {id: '3', name: 'زبادى بلدى', price: 9.00, category: 'multi'}, {id: '4', name: 'ارز باللبن', price: 17.50, category: 'multi'}, {id: '18', name: 'قريش كاملة الدسم', price: 100.00, category: 'dairy'}, {id: '11', name: 'قريش خالية الدسم', price: 95.00, category: 'dairy'}, {id: '14', name: 'ذبدة جاموسي 900 جم', price: 315.00, category: 'multi'}, {id: '13', name: 'ذبدة بقرى 900', price: 280.00, category: 'multi'}, {id: '30', name: 'مش قطع', price: 150.00, category: 'dairy'}, {id: '32', name: 'مش كريمى', price: 120.00, category: 'dairy'}, {id: '200', name: 'صوص شيدر', price: 200.00, category: 'dairy'}, {id: '201', name: 'نستو', price: 190.00, category: 'dairy'}, {id: '56', name: 'فيتا سادة نباتى', price: 110.00, category: 'dairy'}, {id: '57', name: 'فيتا فلفل نباتى', price: 110.00, category: 'dairy'}, {id: '53', name: 'ملح خفيف نباتى', price: 110.00, category: 'dairy'}, {id: '153', name: 'ملح خفيف طبيعى', price: 170.00, category: 'dairy'}, {id: '156', name: 'فيتا سادة طبيعى', price: 170.00, category: 'dairy'}, {id: '157', name: 'فيتا فلفل طبيعى', price: 170.00, category: 'dairy'}, {id: '59', name: 'سمنة جاموسى 200 جم', price: 100.00, category: 'multi'}, {id: '60', name: 'سمنة بقرى 200 جم', price: 90.00, category: 'multi'}, {id: '154', name: 'جبنة كيري طبيعى', price: 150.00, category: 'dairy'}, {id: '12', name: 'قشطة بلدى', price: 200.00, category: 'dairy'}, {id: '42', name: 'مورتة وزن', price: 150.00, category: 'dairy'}, {id: '52', name: 'مورتة 300 جم', price: 65.00, category: 'multi'}, {id: '41', name: 'سمنة جاموسى 800 جم', price: 360.00, category: 'multi'}, {id: '43', name: 'سمنة جاموسى 500 جم', price: 230.00, category: 'multi'}, {id: '44', name: 'سمنة بقرى 800 جم', price: 340.00, category: 'multi'}, {id: '45', name: 'سمنةة بقرى 500 جم', price: 220.00, category: 'multi'}, {id: '20', name: 'موزوريلا 900 جم طبيعى', price: 190.00, category: 'multi'}, {id: '21', name: 'موزوريلا 350 جم طبيعى', price: 80.00, category: 'multi'}, {id: '61', name: 'موزوريلا وزن طبيعى', price: 170.00, category: 'multi'}, {id: '39', name: 'ارز فخار', price: 25.00, category: 'multi'}, {id: '40', name: 'زبادى فخار', price: 17.50, category: 'multi'}, {id: '98', name: 'لبنة تركى', price: 150.00, category: 'dairy'}
];
let state={ 
customers: [], 
products: [], 
sales: [], 
priceLists: [], 
dispatchNotes: [], 
reps: [], 
promotions: [],
settings: { salesTarget: 10000 },
stockEntries: {},
lastSyncTimestamp: null,
invoiceHighlights: {},
highlightCounter: 0 
};
const pages=document.querySelectorAll('.page');
const navItems=document.querySelectorAll('.bottom-nav-item');
const headerTitle=document.getElementById('header-title');
const reportsSubnav=document.getElementById('reports-subnav');
const loadingModal=document.getElementById('loading-modal');
const customConfirmModal=document.getElementById('custom-confirm-modal');
const dialogTitle=document.getElementById('dialog-title');
const dialogMessage=document.getElementById('dialog-message');
const dialogActions=document.getElementById('dialog-actions');
const dialogConfirmBtn=document.getElementById('dialog-confirm-btn');
const dialogCancelBtn=document.getElementById('dialog-cancel-btn');
const saleModal=document.getElementById('sale-modal');
const customerModal=document.getElementById('customer-modal');
const repModal=document.getElementById('rep-modal'); 
const productModal=document.getElementById('product-modal');
const priceListModal=document.getElementById('price-list-modal');
const promotionModal=document.getElementById('promotion-modal');
const dateRangeModal=document.getElementById('date-range-modal');
const dispatchNoteModal=document.getElementById('dispatch-note-modal');
const viewDispatchNoteModal=document.getElementById('view-dispatch-note-modal');
const settlementModal=document.getElementById('settlement-modal'); 
const reconciliationModal=document.getElementById('reconciliation-modal');
const repSalesSummaryModal=document.getElementById('rep-sales-summary-modal');
const dailySalesReportModal=document.getElementById('daily-sales-report-modal');
const customerSalesReportModal=document.getElementById('customer-sales-report-modal');
const aiModal=document.getElementById('ai-modal'); 
const loginModal=document.getElementById('login-modal'); 

// إضافة دالة عرض نافذة تسجيل الدخول
window.showLoginModal = function() {
  const modal = document.getElementById('login-modal');
  if (modal) {
    modal.classList.remove('modal-hidden');
    const emailInput = document.getElementById('login-email-modal');
    if (emailInput) emailInput.focus();
  }
};

const saleForm=document.getElementById('sale-form');
const customerForm=document.getElementById('customer-form');
const repForm=document.getElementById('rep-form'); 
const productForm=document.getElementById('product-form');
const priceListForm=document.getElementById('price-list-form');
const promotionForm=document.getElementById('promotion-form');
const dateRangeForm=document.getElementById('date-range-form');
const dispatchNoteForm=document.getElementById('dispatch-note-form');
const loginForm=document.getElementById('login-form');
const loginEmailInput=document.getElementById('login-email');
const loginPasswordInput=document.getElementById('login-password');
const logoutBtn=document.getElementById('logout-btn');
const spreadsheetRepSelect=document.getElementById('spreadsheet-rep');
const spreadsheetCustomerSelect=document.getElementById('spreadsheet-customer');
const spreadsheetDateInput=document.getElementById('spreadsheet-date');
const spreadsheetEntryBody=document.getElementById('spreadsheet-entry-body');
const spreadsheetAddRowBtn=document.getElementById('spreadsheet-add-row-btn');
const spreadsheetSaveAllBtn=document.getElementById('spreadsheet-save-all-btn');
const unifiedInvoiceNumberInput=document.getElementById('unified-invoice-number'); 
const reportsSubnavItems=document.querySelectorAll('.reports-subnav-item');
const dispatchItemsContainer=document.getElementById('dispatch-items-container');
const reportContentAreas=document.querySelectorAll('#page-reports [data-report-content]');
const dailyReportDateInput=document.getElementById('daily-report-date');
const dailyReportRepSelect=document.getElementById('daily-report-rep');
const rangeStartDateInput=document.getElementById('range-start-date');
const rangeEndDateInput=document.getElementById('range-end-date');
const rangeReportRepSelect=document.getElementById('range-report-rep');
const monthlyReportMonthInput=document.getElementById('monthly-report-month');
const monthlyReportRepSelect=document.getElementById('monthly-report-rep');
const reportOutputArea=document.getElementById('report-output-area');
let sales7DaysChart;
let topRepsChart;
let topProductsChart;
let topCustomersChart;
const arabicMonths=[
"يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
"يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
];
function formatArabicDate(dateString) {
const date=new Date(dateString);
const day=String(date.getDate()).padStart(2, '0');
const month=String(date.getMonth() + 1).padStart(2, '0');
const year=date.getFullYear();
return `${day}/${month}/${year}`;
}
function formatArabicDateTime(dateString) {
const date=new Date(dateString);
const day=String(date.getDate()).padStart(2, '0');
const month=String(date.getMonth() + 1).padStart(2, '0');
const year=date.getFullYear();
const hour=date.getHours().toString().padStart(2, '0');
const minute=date.getMinutes().toString().padStart(2, '0');
return `${day}/${month}/${year} ${hour}:${minute}`;
}
/* moved: formatCurrency, findCustomer, findProduct, findPriceList, findRep to src/utils/helpers-extra.js */
/* moved: openModal/closeModal to src/utils/helpers-extra.js */

function formatNumberEN(num) {
  if (num === null || num === undefined || num === '') return '';
  const n = Number(num);
  if (isNaN(n)) return '';
  return new Intl.NumberFormat('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 0}).format(n);
}
window.formatNumberEN = formatNumberEN;

function initializeChainsDisplay() {
  // Stub: Initialize chains UI elements if needed
  try {
    const chainFilter = document.getElementById('chain-filter');
    if (chainFilter && !chainFilter.hasAttribute('data-initialized')) {
      chainFilter.setAttribute('data-initialized', 'true');
    }
  } catch (e) {
    console.warn('initializeChainsDisplay stub:', e);
  }
}
window.initializeChainsDisplay = initializeChainsDisplay;

function round2(num) {
  if (num === null || num === undefined || num === '') return 0;
  const n = Number(num);
  if (isNaN(n)) return 0;
  return Math.round(n * 100) / 100;
}
window.round2 = round2;

function saveAllSpreadsheetEntries() {
  // Stub: Save spreadsheet entries functionality
  try {
    console.log('حفظ بيانات جدول البيانات...');
    // Implementation would go here - this is a placeholder to prevent errors
  } catch (e) {
    console.warn('saveAllSpreadsheetEntries error:', e);
  }
}
window.saveAllSpreadsheetEntries = saveAllSpreadsheetEntries;

function addSpreadsheetRow() {
  // Stub: Add new row to spreadsheet
  try {
    console.log('إضافة صف جديد لجدول البيانات...');
    const table = document.querySelector('#spreadsheet-entry-table tbody');
    if (table) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="10">صف جديد - قيد التطوير</td>';
      table.appendChild(row);
    }
  } catch (e) {
    console.warn('addSpreadsheetRow error:', e);
  }
}
window.addSpreadsheetRow = addSpreadsheetRow;

function renderSales7DaysChart() {
  try {
    if (typeof createOrUpdateChart !== 'function') return;
    const canvas = document.getElementById('sales-7-days-chart');
    if (!canvas) return;
    const sales = Array.isArray(state.sales) ? state.sales : [];
    const last7Days = [];
    const today = new Date();
    for (let i = 6; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      last7Days.push(d.toISOString().split('T')[0]);
    }
    const salesByDay = {};
    last7Days.forEach(day => salesByDay[day] = 0);
    sales.forEach(sale => {
      const saleDate = (sale.date || '').split('T')[0];
      if (salesByDay.hasOwnProperty(saleDate)) {
        salesByDay[saleDate] += Number(sale.totalAfterDiscount || sale.total || 0);
      }
    });
    const labels = last7Days.map(d => new Date(d).toLocaleDateString('ar-EG', {day: 'numeric', month: 'short'}));
    const data = last7Days.map(d => salesByDay[d]);
    window.sales7DaysChart = createOrUpdateChart(window.sales7DaysChart, 'sales-7-days-chart', 'line', {labels, data}, {
      label: 'المبيعات', backgroundColor: 'rgba(34, 197, 94, 0.2)', borderColor: 'rgba(34, 197, 94, 1)'
    });
  } catch (e) { console.warn('renderSales7DaysChart error:', e); }
}
window.renderSales7DaysChart = renderSales7DaysChart;

function renderTopRepsChart() {
  try {
    if (typeof createOrUpdateChart !== 'function') return;
    const canvas = document.getElementById('top-reps-chart');
    if (!canvas) return;
    const topRepsData = typeof getTopRepsData === 'function' ? getTopRepsData(5) : {labels: [], data: []};
    window.topRepsChart = createOrUpdateChart(window.topRepsChart, 'top-reps-chart', 'bar', topRepsData, {
      label: 'المبيعات', backgroundColor: 'rgba(234, 88, 12, 0.6)', borderColor: 'rgba(234, 88, 12, 1)'
    });
  } catch (e) { console.warn('renderTopRepsChart error:', e); }
}
window.renderTopRepsChart = renderTopRepsChart;

function renderTopProductsChart() {
  try {
    if (typeof createOrUpdateChart !== 'function') return;
    const canvas = document.getElementById('top-products-chart');
    if (!canvas) return;
    const topProductsData = typeof getTopProductsData === 'function' ? getTopProductsData(5) : {labels: [], data: []};
    window.topProductsChart = createOrUpdateChart(window.topProductsChart, 'top-products-chart', 'bar', topProductsData, {
      label: 'الكمية', backgroundColor: 'rgba(147, 51, 234, 0.6)', borderColor: 'rgba(147, 51, 234, 1)'
    });
  } catch (e) { console.warn('renderTopProductsChart error:', e); }
}
window.renderTopProductsChart = renderTopProductsChart;

function renderTopCustomersChart() {
  try {
    if (typeof createOrUpdateChart !== 'function') return;
    const canvas = document.getElementById('top-customers-chart');
    if (!canvas) return;
    const topCustomersData = typeof getTopCustomersData === 'function' ? getTopCustomersData(5) : {labels: [], data: []};
    window.topCustomersChart = createOrUpdateChart(window.topCustomersChart, 'top-customers-chart', 'bar', topCustomersData, {
      label: 'المبيعات', backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)'
    });
  } catch (e) { console.warn('renderTopCustomersChart error:', e); }
}
window.renderTopCustomersChart = renderTopCustomersChart;

// Handler for sales list clicks
function salesListClickHandler(e) {
  try {
    const target = e.target;
    // Handle edit button
    if (target.classList.contains('edit-sale-btn') || target.closest('.edit-sale-btn')) {
      const btn = target.classList.contains('edit-sale-btn') ? target : target.closest('.edit-sale-btn');
      const saleId = btn.getAttribute('data-id');
      if (saleId && typeof openEditSaleModal === 'function') {
        openEditSaleModal(saleId);
      }
    }
    // Handle delete button
    else if (target.classList.contains('delete-sale-btn') || target.closest('.delete-sale-btn')) {
      const btn = target.classList.contains('delete-sale-btn') ? target : target.closest('.delete-sale-btn');
      const saleId = btn.getAttribute('data-id');
      if (saleId && typeof deleteSale === 'function') {
        deleteSale(saleId);
      }
    }
    // Handle print button
    else if (target.classList.contains('print-sale-btn') || target.closest('.print-sale-btn')) {
      const btn = target.classList.contains('print-sale-btn') ? target : target.closest('.print-sale-btn');
      const saleId = btn.getAttribute('data-id');
      if (saleId && typeof printSaleReceipt === 'function') {
        printSaleReceipt(saleId);
      }
    }
  } catch (err) {
    console.warn('salesListClickHandler error:', err);
  }
}
window.salesListClickHandler = salesListClickHandler;

function getCompanyLogoUrl() {
try {
if (state.settings && state.settings.companyLogo) return state.settings.companyLogo;
return window.DEFAULT_COMPANY_LOGO_URL || '';
} catch (e) { return window.DEFAULT_COMPANY_LOGO_URL || ''; }
}
function renderCompanyLogo() {
try {
const url=getCompanyLogoUrl();
const img=document.getElementById('company-logo-img');
if (!img) return;
if (url) {
img.src=url;
img.style.display='';
try { applyWatermark(url); } catch(e) { console.warn('applyWatermark from renderCompanyLogo failed', e); }
} else {
img.src='';
img.style.display='none';
try { applyWatermark(''); } catch(e) { console.warn('remove watermark failed', e); }
}
} catch (e) { console.warn('renderCompanyLogo error', e); }
}
function applyWatermark(url) {
try {
const head=document.head || document.getElementsByTagName('head')[0];
let style=document.getElementById('company-watermark-style');
if (!url) {
if (style && style.parentNode) style.parentNode.removeChild(style);
return;
}
const safeUrl=url.replace(/\)/g, '%29');
const css=`
#app-container { position: relative; }
#app-container::before {
content: "";
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 140vmin;
height: 140vmin;
background-image: url("${safeUrl}");
background-repeat: no-repeat;
background-position: center;
background-size: contain;
opacity: 0.12;
pointer-events: none;
z-index: 0;
filter: saturate(0%) brightness(1.1);
}
#app-container > * { position: relative; z-index: 1; }
@media print {
#app-container::before { opacity: 0.15; width: 220vmin; height: 220vmin; background-size: contain; position: fixed; }
body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
`;
if (!style) {
style=document.createElement('style');
style.id='company-watermark-style';
style.type='text/css';
style.appendChild(document.createTextNode(css));
head.appendChild(style);
} else {
style.textContent=css;
}
} catch (e) {
console.warn('applyWatermark error', e);
}
}
function computeDebtsSummary() {
const rows=[];
if (Array.isArray(state.sales) && state.sales.length) {
state.sales.forEach(s=> {
const total=Number(s.total || 0);
const paid=Number(s.paid || 0);
const remaining=Number(s.remaining !=null ? s.remaining : (total - paid));
rows.push({ customer: s.customerName || s.customer || 'غير معروف', rep: s.repName || s.rep || 'غير معروف', total, paid, remaining });
});
} else {
const tbody=document.getElementById('debts-detail-body');
if (tbody) {
Array.from(tbody.querySelectorAll('tr')).forEach(tr=> {
const tds=tr.querySelectorAll('td');
if (!tds || tds.length < 7) return;
const customer=tds[0].textContent.trim();
const date=tds[1].textContent.trim();
const invoice=tds[2].textContent.trim();
const total=Number((tds[3].textContent || '').replace(/[^0-9.-]+/g, '')) || 0;
const paid=Number((tds[4].textContent || '').replace(/[^0-9.-]+/g, '')) || 0;
const remaining=Number((tds[5].textContent || '').replace(/[^0-9.-]+/g, '')) || (total - paid);
const rep=tds[6].textContent.trim() || 'غير معروف';
rows.push({ customer, rep, total, paid, remaining });
});
}
}
const byCustomer={};
const byRep={};
let totalRemaining=0;
rows.forEach(r=> {
if (!byCustomer[r.customer]) byCustomer[r.customer]={ total:0, paid:0, remaining:0 };
if (!byRep[r.rep]) byRep[r.rep]={ total:0, paid:0, remaining:0 };
byCustomer[r.customer].total +=r.total;
byCustomer[r.customer].paid +=r.paid;
byCustomer[r.customer].remaining +=r.remaining;
byRep[r.rep].total +=r.total;
byRep[r.rep].paid +=r.paid;
byRep[r.rep].remaining +=r.remaining;
totalRemaining +=r.remaining;
});
return { byCustomer, byRep, totalRemaining };
}
function showDebtsSummaryModal(e) {
if (e && e.preventDefault) {
}
const summary=computeDebtsSummary();
const custTbody=document.querySelector('#debts-by-customer tbody');
const repTbody=document.querySelector('#debts-by-rep tbody');
custTbody.innerHTML='';
repTbody.innerHTML='';
Object.keys(summary.byCustomer).sort().forEach(name=> {
const item=summary.byCustomer[name];
const tr=document.createElement('tr');
tr.innerHTML=`<td class="text-right px-2 py-1">${name}</td><td class="text-center px-2 py-1">${formatCurrency(item.total)}</td><td class="text-center px-2 py-1">${formatCurrency(item.paid)}</td><td class="text-center px-2 py-1">${formatCurrency(item.remaining)}</td>`;
custTbody.appendChild(tr);
});
Object.keys(summary.byRep).sort().forEach(name=> {
const item=summary.byRep[name];
const tr=document.createElement('tr');
tr.innerHTML=`<td class="text-right px-2 py-1">${name}</td><td class="text-center px-2 py-1">${formatCurrency(item.total)}</td><td class="text-center px-2 py-1">${formatCurrency(item.paid)}</td><td class="text-center px-2 py-1">${formatCurrency(item.remaining)}</td>`;
repTbody.appendChild(tr);
});
const totalEl=document.getElementById('debts-summary-total');
if (totalEl) totalEl.textContent=formatCurrency(summary.totalRemaining);
openModal(document.getElementById('debts-summary-modal'));
}
document.addEventListener('DOMContentLoaded', ()=> {
const btn=document.getElementById('debts-nav-btn');
if (btn) {
btn.addEventListener('click', function(ev) {
});
}
});
const REVIEW_COLORS=['highlight-blue', 'highlight-green', 'highlight-purple', 'highlight-orange', 'highlight-teal'];
const LOCAL_REVIEW_KEY='mandoobi_review_state';
function loadReviewState() {
try {
const savedState=localStorage.getItem(LOCAL_REVIEW_KEY);
return savedState ? JSON.parse(savedState) : {};
} catch (e) {
console.error("Failed to load review state:", e);
return {};
}
}
function saveReviewState(reviewState) {
try {
localStorage.setItem(LOCAL_REVIEW_KEY, JSON.stringify(reviewState));
} catch (e) {
console.error("Failed to save review state:", e);
}
}
function toggleReviewColor(saleId, element) {
const reviewState=loadReviewState();
const existingColor=reviewState[saleId];
element.classList.remove(...REVIEW_COLORS);
if (existingColor) {
delete reviewState[saleId];
} else {
if (typeof state.highlightCounter !=='number') {
state.highlightCounter=0;
}
const colorIndex=state.highlightCounter % REVIEW_COLORS.length;
const nextColor=REVIEW_COLORS[colorIndex];
reviewState[saleId]=nextColor;
element.classList.add(nextColor);
state.highlightCounter++;
}
saveReviewState(reviewState); 
saveState(); 
}
function updateIcons() {
if (typeof lucide !=='undefined') {
lucide.createIcons();
}
}
function customDialog({ message, title='إشعار', isConfirm=false, confirmText='تأكيد', confirmClass='bg-blue-600 hover:bg-blue-700' }) {
return new Promise(resolve=> {
let confirmBtn=document.getElementById('dialog-confirm-btn');
let cancelBtn=document.getElementById('dialog-cancel-btn');
if (!dialogTitle || !dialogMessage || !confirmBtn || !cancelBtn) {
console.error("Custom dialog elements are missing in the DOM.");
setTimeout(()=> resolve(isConfirm ? false : true), 10);
return;
}
dialogTitle.textContent=title;
dialogMessage.textContent=message;
confirmBtn.textContent=confirmText;
confirmBtn.className=`flex-1 text-white px-4 py-2 rounded-lg font-semibold ${confirmClass}`;
dialogActions.classList.toggle('justify-between', isConfirm);
dialogActions.classList.toggle('justify-center', !isConfirm);
cancelBtn.classList.toggle('hidden', !isConfirm);
cancelBtn.textContent='إلغاء';
const oldConfirmBtn=confirmBtn;
const newConfirmBtn=oldConfirmBtn.cloneNode(true);
if (oldConfirmBtn.parentNode) {
oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
}
const oldCancelBtn=cancelBtn;
const newCancelBtn=oldCancelBtn.cloneNode(true);
if (oldCancelBtn.parentNode) {
oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
}
newConfirmBtn.addEventListener('click', ()=> {
closeModal(customConfirmModal);
resolve(true);
}, { once: true });
if (isConfirm) {
newCancelBtn.addEventListener('click', ()=> {
closeModal(customConfirmModal);
resolve(false);
}, { once: true });
}
openModal(customConfirmModal);
});
}
function populateRepDropdown(selectEl, selectedRepName='') {
if (!selectEl) return;
let repNames=(state.reps||[]).map(r=> r.name).filter(n=> !!n);
const prev=selectedRepName || selectEl.value;
if (selectEl.id==='spreadsheet-rep') {
let role=typeof getUserRole==='function' ? getUserRole() : 'rep';
let currentEmail=(window.auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email.toLowerCase() : null;
if (role==='rep' && currentEmail) {
const currentRep=(state.reps||[]).find(r=> (r.email||'').toLowerCase()===currentEmail);
if (currentRep) {
repNames=[currentRep.name];
} else {
repNames=[];
}
}
}
let html='<option value="">-- جميع المناديب --</option>';
html +=repNames.map(name=> `<option value="${name}" ${name===prev ? 'selected' : ''}>${name}</option>`).join('');
selectEl.innerHTML=html;
if (prev && repNames.includes(prev)) selectEl.value=prev;
}
function populateRepDropdownReports(selectEl, selectedRepName='') {
const repNames=state.reps.map(r=> r.name);
selectEl.innerHTML='<option value="all">-- كل المناديب --</option>' + repNames.map(name=> 
`<option value="${name}" ${name===selectedRepName ? 'selected' : ''}>${name}</option>`
).join('');
}
if (typeof window.findRep !=='function') {
window.findRep=function(name){
try { return (state.reps||[]).find(r=> r.name===name || r.id===name) || null; } catch(e){ return null; }
};
}
window.state=window.state || {};
if (typeof window.DEFAULT_PRODUCTS==='undefined') window.DEFAULT_PRODUCTS=[];
if (typeof window.formatCurrency !=='function') {
window.formatCurrency=function(v){
try { return Number(v||0).toLocaleString('ar-EG', { minimumFractionDigits: 0 }); } catch(e){ return String(v||'0'); }
};
}
if (typeof window.findCustomer !=='function') {
window.findCustomer=function(id){
try { return (state.customers||[]).find(c=> (c.id||c._id)===id) || null; } catch(e){ return null; }
};
}
if (typeof window.updateCustomerList !=='function') {
window.updateCustomerList=function(filter, chain){
try { if (typeof renderCustomerList==='function') renderCustomerList(filter||''); } catch(e){ console.warn('updateCustomerList stub failed', e); }
};
}
function updatePromotionOriginalPriceDisplay(productId) {
const product=findProduct(productId);
const displayEl=document.getElementById('original-price-display');
const priceEl=document.getElementById('current-product-price');
if (product) {
priceEl.textContent=formatCurrency(product.price);
displayEl.classList.remove('hidden');
} else {
displayEl.classList.add('hidden');
}
}
function getActivePromotionPrice(productId, customerId=null) {
const today=new Date();
today.setHours(0, 0, 0, 0);
const relevantOffers=state.promotions.filter(p=> p.productId===productId);
let activeOffer=relevantOffers.find(p=> {
const isTargetingThisCustomer=p.customerId===customerId;
if (!isTargetingThisCustomer) return false;
const startDate=new Date(p.startDate);
startDate.setHours(0, 0, 0, 0);
const endDate=new Date(p.endDate);
endDate.setHours(23, 59, 59, 999);
return today >=startDate && today <=endDate;
});
if (!activeOffer) {
activeOffer=relevantOffers.find(p=> {
const isTargetingAll=!p.customerId;
if (!isTargetingAll) return false;
const startDate=new Date(p.startDate);
startDate.setHours(0, 0, 0, 0);
const endDate=new Date(p.endDate);
endDate.setHours(23, 59, 59, 999);
return today >=startDate && today <=endDate;
});
}
return activeOffer ? activeOffer.price : null;
}
const supermarketChains={
exception: ["اكسبشن ماركت"],
awladragab: ["اولاد رجب"],
samysalama: ["سامي سلامه"],
gomlamarket: ["جملة ماركت"],
dreams: ["دريمز فرع 1", "دريمز فرع 2"]
};
const updateCustomerList=(filter='', chain='all')=> {
const statementCustomerList=document.getElementById('statement-customer-list');
if (!statementCustomerList) return;
statementCustomerList.innerHTML='';
console.log('updateCustomerList called with:', { filter, chain });
console.log('Initial state.customers:', state.customers);
let filteredCustomers=state.customers;
const allChains=loadChains();
if (chain !=='all' && supermarketChains[chain]) {
const branches=supermarketChains[chain];
console.log('Filtering by chain. Branches:', branches);
filteredCustomers=filteredCustomers.filter(c=> {
const match=branches.some(branch=> c.name.toLowerCase().includes(branch.toLowerCase()));
return match;
});
console.log('Customers after chain filter:', filteredCustomers);
}
if (filter) {
filteredCustomers=filteredCustomers.filter(c=> c.name.toLowerCase().includes(filter.toLowerCase()));
console.log('Customers after text filter:', filteredCustomers);
}
if (filteredCustomers.length===0) {
const el=document.createElement('label');
el.className='flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
el.innerHTML=`
<span class="text-sm text-red-500">لا توجد نتائج مطابقة.</span>
`;
statementCustomerList.appendChild(el);
} else {
filteredCustomers.forEach(customer=> {
const el=document.createElement('label');
el.className='flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
el.innerHTML=`
<input type="checkbox" value="${customer.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
<span class="text-sm">${customer.name}</span>
`;
statementCustomerList.appendChild(el);
});
if (allChains.length > 0) {
allChains.forEach(chain=> {
const el=document.createElement('label');
el.className='flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
el.innerHTML=`
<input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
<span class="text-sm font-medium">[سلسلة] ${chain.name}</span>
`;
statementCustomerList.appendChild(el);
});
}
}
};
document.addEventListener('DOMContentLoaded', ()=> {
const supermarketChainFilter=document.getElementById('supermarket-chain-filter');
if(supermarketChainFilter) {
supermarketChainFilter.addEventListener('change', (e)=> {
const chain=e.target.value;
const filter=document.getElementById('statement-customer-search').value;
updateCustomerList(filter, chain);
});
}
const statementCustomerSearch=document.getElementById('statement-customer-search');
if(statementCustomerSearch){
statementCustomerSearch.addEventListener('input', (e)=> {
const filter=e.target.value;
const chain=document.getElementById('supermarket-chain-filter') ? document.getElementById('supermarket-chain-filter').value : 'all';
const statementCustomerList=document.getElementById('statement-customer-list');
if (!statementCustomerList) return;
let filteredCustomers=state.customers;
const allChains=loadChains();
if (chain !=='all' && supermarketChains[chain]) {
const branches=supermarketChains[chain];
filteredCustomers=filteredCustomers.filter(c=> {
const match=branches.some(branch=> c.name.toLowerCase().includes(branch.toLowerCase()));
return match;
});
}
if (filter) {
filteredCustomers=filteredCustomers.filter(c=> c.name.toLowerCase().includes(filter.toLowerCase()));
}
statementCustomerList.innerHTML='';
if (filteredCustomers.length===0 && (!filter || filter.length===0)) {
const el=document.createElement('label');
el.className='flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
el.innerHTML='<span class="text-sm text-red-500">لا توجد نتائج مطابقة.</span>';
statementCustomerList.appendChild(el);
} else {
filteredCustomers.forEach(customer=> {
const el=document.createElement('label');
el.className='flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded-md';
el.innerHTML=`
<input type="checkbox" value="${customer.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
<span class="text-sm">${customer.name}</span>
`;
statementCustomerList.appendChild(el);
});
if (allChains.length > 0 && (!filter || filter.length===0)) {
allChains.forEach(chain=> {
const el=document.createElement('label');
el.className='flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
el.innerHTML=`
<input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
<span class="text-sm font-medium">[سلسلة] ${chain.name}</span>
`;
statementCustomerList.appendChild(el);
});
} else if (allChains.length > 0 && filter) {
const filteredChains=allChains.filter(c=> c.name.toLowerCase().includes(filter.toLowerCase()));
filteredChains.forEach(chain=> {
const el=document.createElement('label');
el.className='flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded-md bg-blue-50';
el.innerHTML=`
<input type="checkbox" value="chain-${chain.id}" class="rounded text-blue-600 focus:ring-blue-500 ml-1">
<span class="text-sm font-medium">[سلسلة] ${chain.name}</span>
`;
statementCustomerList.appendChild(el);
});
}
}
});
}
});
function populateProductDropdown(selectEl, selectedId='') {
selectEl.innerHTML='<option value="">-- اختر منتج --</option>' + state.products.map(p=> 
`<option value="${p.id}" ${p.id===selectedId ? 'selected' : ''}>${p.name} (${p.id})</option>`
).join('');
}
function updateAllSalePrices() {
const container=document.getElementById('sale-items-container');
if (!container) return;
container.querySelectorAll('.sale-item-row').forEach(row=> {
const productSelect=row.querySelector('.sale-item-product');
const quantity=parseInt(row.querySelector('.sale-item-quantity').value) || 0;
const priceInput=row.querySelector('.sale-item-price');
const totalDisplay=row.querySelector('.sale-item-total-display');
const productId=productSelect.value;
const customerId=document.getElementById('sale-customer')?.value || '';
let price=0;
if (productId) {
const product=findProduct(productId);
let basePrice=product ? product.price : 0;
if (customerId) {
const customer=findCustomer(customerId);
if (customer && customer.priceListId) {
const priceList=findPriceList(customer.priceListId);
if (priceList && priceList.productPrices[productId] !==undefined) {
basePrice=priceList.productPrices[productId];
}
}
}
const promotionPrice=getActivePromotionPrice(productId, customerId);
price=(promotionPrice !==null) ? promotionPrice : basePrice;
}
priceInput.value=price.toFixed(2);
const itemTotal=quantity * price;
totalDisplay.textContent=formatCurrency(itemTotal);
});
updateSaleSummary();
}
function addSaleItemRow(item={}) {
const container=document.getElementById('sale-items-container');
const row=document.createElement('tr');
row.className='sale-item-row';
row.innerHTML=`
<td class="px-4 py-2"><select class="sale-item-product w-full p-2 border rounded-md" required>${state.products.length > 0 ? '' : '<option>لا توجد منتجات</option>'}</select></td>
<td class="px-4 py-2"><input class="sale-item-quantity p-2 border rounded-md text-center" type="number" value="${(item.quantity !=null && item.quantity !==undefined && item.quantity !=='') ? item.quantity : ''}" placeholder="0"></td>
<td class="px-4 py-2"><input class="sale-item-price p-2 border rounded-md text-center bg-gray-100" type="number" value="${item.price || 0}" readonly></td>
<td class="px-4 py-2"><span class="sale-item-total-display font-semibold">0 ج.م</span></td>
<td class="px-2 py-2 text-center"><button type="button" class="delete-sale-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
`;
const productSelect=row.querySelector('.sale-item-product');
populateProductDropdown(productSelect, item.productId || '');
container.appendChild(row);
updateIcons();
const updateRow=()=> {
const productId=productSelect.value;
const quantity=parseInt(row.querySelector('.sale-item-quantity').value) || 0;
const priceInput=row.querySelector('.sale-item-price');
const totalDisplay=row.querySelector('.sale-item-total-display');
const customerId=document.getElementById('sale-customer').value;
let price=0;
if (productId) {
const product=findProduct(productId);
let basePrice=product ? product.price : 0;
if (customerId) {
const customer=findCustomer(customerId);
if (customer && customer.priceListId) {
const priceList=findPriceList(customer.priceListId);
if (priceList && priceList.productPrices[productId] !==undefined) {
basePrice=priceList.productPrices[productId];
}
}
}
const promotionPrice=getActivePromotionPrice(productId, customerId);
price=(promotionPrice !==null) ? promotionPrice : basePrice;
try {
if (product && /قريش|قريش/i.test(product.name)) {
const customer=customerId ? findCustomer(customerId) : null;
const priceList=(customer && customer.priceListId) ? findPriceList(customer.priceListId) : null;
const listOverride=priceList ? priceList.productPrices[productId] : undefined;
console.debug('DEBUG Pricing (sale modal row)', {
productId,
productName: product ? product.name : '',
basePrice: (product ? product.price : 0),
priceListId: customer ? customer.priceListId : '',
priceListOverride: listOverride,
promotionPrice,
finalPrice: price
});
}
} catch(_){ }
}
priceInput.value=price.toFixed(2);
const itemTotal=quantity * price;
totalDisplay.textContent=formatCurrency(itemTotal);
updateSaleSummary(); 
};
productSelect.addEventListener('change', updateRow);
row.querySelector('.sale-item-quantity').addEventListener('input', updateRow);
row.querySelector('.delete-sale-item-btn').addEventListener('click', ()=> {
row.remove();
updateSaleSummary();
});
document.getElementById('sale-customer').addEventListener('change', updateRow);
updateRow(); 
}
function updateSaleSummary() {
let subtotal=0;
const rows=Array.from(document.querySelectorAll('#sale-items-container .sale-item-row'));
rows.forEach(row=> {
const quantity=parseFloat(row.querySelector('.sale-item-quantity').value) || 0;
const price=parseFloat(row.querySelector('.sale-item-price').value) || 0;
subtotal +=quantity * price;
});
const discountPercent=parseFloat(document.getElementById('sale-discount').value) || 0;
const discountAmount=subtotal * (discountPercent / 100);
const additionPercent=parseFloat(document.getElementById('sale-addition')?.value) || 0;
const additionAmount=subtotal * (additionPercent / 100);
const taxableSubtotal=subtotal - discountAmount + additionAmount;
let vatTotal=0;
try {
rows.forEach(row=> {
const productId=row.querySelector('.sale-item-product')?.value;
const quantity=parseFloat(row.querySelector('.sale-item-quantity').value) || 0;
const price=parseFloat(row.querySelector('.sale-item-price').value) || 0;
const product=productId ? findProduct(productId) : null;
const vatRate=(product && product.vat_rate) ? Number(product.vat_rate) / 100 : 0;
const lineBaseAfterDiscount=quantity * price * (1 - (discountPercent/100));
const lineVat=lineBaseAfterDiscount * vatRate;
vatTotal +=lineVat;
});
} catch(e){ console.warn('VAT calc error', e); }
let withholding=0;
try {
const customerId=document.getElementById('sale-customer')?.value;
const customer=customerId ? findCustomer(customerId) : null;
if (customer && (customer.taxNumber || customer.taxNumber===0 || customer.taxNumber==='')) {
if (customer.taxNumber && String(customer.taxNumber).trim().length) {
withholding=round2(taxableSubtotal * 0.01);
}
}
} catch(e){ console.warn('withholding calc error', e); }
const totalBeforeWithholding=round2(taxableSubtotal + round2(vatTotal));
const finalPayable=round2(totalBeforeWithholding - withholding);
document.getElementById('sale-subtotal-text').textContent=formatCurrency(round2(subtotal));
document.getElementById('sale-discount-text').textContent=formatCurrency(round2(discountAmount));
let additionLine=document.getElementById('sale-addition-line');
if (!additionLine) {
const summary=document.getElementById('sale-summary');
if (summary) {
additionLine=document.createElement('div');
additionLine.id='sale-addition-line';
additionLine.className='flex justify-between text-green-600';
additionLine.innerHTML='<span>الإضافة:</span><span id="sale-addition-text">0 ج.م</span>';
const discountLine=document.getElementById('sale-discount-text')?.parentElement;
if (discountLine) discountLine.insertAdjacentElement('afterend', additionLine);
else summary.insertBefore(additionLine, summary.querySelector('hr'));
}
}
const additionTextEl=document.getElementById('sale-addition-text');
if (additionTextEl) additionTextEl.textContent=formatCurrency(round2(additionAmount));
const vatEl=document.getElementById('sale-vat-text'); if (vatEl) vatEl.textContent=formatCurrency(round2(vatTotal));
const withEl=document.getElementById('sale-withholding-text'); if (withEl) withEl.textContent=formatCurrency(round2(withholding));
const finalEl=document.getElementById('sale-final-text'); if (finalEl) finalEl.textContent=formatCurrency(finalPayable);
document.getElementById('sale-total-text').textContent=formatCurrency(totalBeforeWithholding);
const statusSelect=document.getElementById('sale-status');
const paidAmountContainer=document.getElementById('paid-amount-container');
const paidAmountInput=document.getElementById('sale-paid-amount');
if (statusSelect.value==='paid') {
paidAmountInput.value=finalPayable.toFixed(2);
paidAmountContainer.classList.add('hidden');
} else if (statusSelect.value==='due') {
paidAmountInput.value=0;
paidAmountContainer.classList.add('hidden');
} else { 
paidAmountContainer.classList.remove('hidden');
}
}
function openSaleModal(id=null) {
saleForm.reset();
document.getElementById('sale-items-container').innerHTML='';
populateRepDropdown(document.getElementById('sale-rep'));
populateCustomerDropdown(document.getElementById('sale-customer'));
const repSelectEl=document.getElementById('sale-rep');
const custSelectEl=document.getElementById('sale-customer');
const repDisplayEl=document.getElementById('sale-rep-display');
const custDisplayEl=document.getElementById('sale-customer-display');
const paidAmountContainer=document.getElementById('paid-amount-container');
const statusSelect=document.getElementById('sale-status');
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (id) {
const sale=state.sales.find(s=> s.id===id);
if (!sale) {
customDialog({ message: 'لم يتم العثور على الفاتورة.', title: 'خطأ' });
return;
}
document.getElementById('sale-modal-title').textContent=`تعديل فاتورة رقم: ${sale.invoiceNumber}`;
document.getElementById('sale-id').value=sale.id;
try { if (repSelectEl) repSelectEl.value=sale.repName; } catch(e){}
try { if (custSelectEl) custSelectEl.value=sale.customerId; } catch(e){}
try { if (repDisplayEl) { repDisplayEl.value=sale.repName || ''; repDisplayEl.style.display='block'; } } catch(e){}
try { if (custDisplayEl) { custDisplayEl.value=(typeof findCustomer==='function' ? (findCustomer(sale.customerId)?.name || '') : (sale.customerName || '')) ; custDisplayEl.style.display='block'; } } catch(e){}
try { if (repSelectEl) repSelectEl.style.display='none'; } catch(e){}
try { if (custSelectEl) custSelectEl.style.display='none'; } catch(e){}
document.getElementById('sale-date').value=new Date(sale.date).toISOString().split('T')[0];
document.getElementById('sale-invoice-number').value=sale.invoiceNumber;
document.getElementById('sale-notes').value=sale.notes || '';
document.getElementById('sale-discount').value=sale.discount || 0;
document.getElementById('sale-addition').value=sale.additionPercent || sale.addition || 0;
statusSelect.value=sale.status;
if (sale.status==='partial') {
paidAmountContainer.classList.remove('hidden');
document.getElementById('sale-paid-amount').value=(((sale.paidAmount !==null && sale.paidAmount !==undefined) ? sale.paidAmount : (((sale.firstPayment ? sale.firstPayment : 0) + (sale.secondPayment ? sale.secondPayment : 0)))));
} else {
paidAmountContainer.classList.add('hidden');
}
sale.items.forEach(item=> addSaleItemRow(item));
try {
const etaBtn=document.getElementById('eta-upload-from-modal-btn');
if (etaBtn) {
if (role==='admin') {
etaBtn.classList.remove('hidden');
etaBtn.dataset.id=sale.id;
const newBtn=etaBtn.cloneNode(true);
etaBtn.parentNode.replaceChild(newBtn, etaBtn);
newBtn.addEventListener('click', async ()=>{
try { await window.uploadSaleToEta(sale.id); } catch(e){ console.warn('modal eta upload failed', e); }
});
updateIcons();
} else {
etaBtn.classList.add('hidden');
}
}
} catch(_){ }
if (role==='rep') {
try {
let createdTime=null;
if (sale && sale.createdAt) {
if (typeof sale.createdAt.toDate==='function') {
createdTime=sale.createdAt.toDate();
} else {
createdTime=new Date(sale.createdAt);
}
}
const ageMs=createdTime ? (Date.now() - createdTime.getTime()) : Infinity;
const EDIT_WINDOW_MS=15 * 60 * 1000; 
const isWithinEditWindow=ageMs <=EDIT_WINDOW_MS;
const form=document.getElementById('sale-form');
const title=document.getElementById('sale-modal-title');
if (isWithinEditWindow) {
const remainingMinutes=Math.ceil((EDIT_WINDOW_MS - ageMs) / 60000);
if (title) {
title.textContent=`${title.textContent} (متبقي: ${remainingMinutes} دقيقة للتعديل)`;
}
form.querySelectorAll('input, select, textarea').forEach(el=> {
el.disabled=false;
el.classList.remove('opacity-70', 'cursor-not-allowed', 'bg-gray-100');
});
form.querySelectorAll('button').forEach(el=> {
if (el.id==='add-sale-item-btn') {
el.style.display='inline-block';
el.disabled=false;
return;
}
if (el.className.includes('remove-item-btn')) {
el.style.display='inline-block';
el.disabled=false;
return;
}
if (el.id==='cancel-sale-btn') {
el.disabled=false;
return;
}
if (el.type==='submit') {
el.disabled=false;
el.classList.remove('opacity-50', 'cursor-not-allowed');
}
});
const submitBtn=document.querySelector('footer [type="submit"][form="sale-form"]');
if (submitBtn) {
submitBtn.disabled=false;
submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
}
} else {
if (title) {
title.textContent=`[عرض فقط - انتهت المهلة] ${title.textContent}`;
}
form.querySelectorAll('input, select, textarea').forEach(el=> {
el.disabled=true;
el.classList.add('opacity-70', 'cursor-not-allowed', 'bg-gray-100');
});
form.querySelectorAll('button').forEach(el=> {
if (el.id==='cancel-sale-btn') {
el.disabled=false;
return;
}
if (el.id==='add-sale-item-btn') {
el.style.display='none';
return;
}
if (el.className.includes('remove-item-btn')) {
el.style.display='none';
return;
}
el.disabled=true;
el.classList.add('opacity-50', 'cursor-not-allowed');
});
const submitBtn=document.querySelector('footer [type="submit"][form="sale-form"]');
if (submitBtn) {
submitBtn.disabled=true;
submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
}
}
} catch(err) {
console.warn('Error handling rep edit window:', err);
}
}
} else {
document.getElementById('sale-modal-title').textContent='إضافة عملية بيع';
document.getElementById('sale-id').value='';
document.getElementById('sale-date').value=new Date().toISOString().split('T')[0];
try { if (repSelectEl) repSelectEl.style.display='block'; } catch(e){}
try { if (custSelectEl) custSelectEl.style.display='block'; } catch(e){}
try { if (repDisplayEl) repDisplayEl.style.display='none'; } catch(e){}
try { if (custDisplayEl) custDisplayEl.style.display='none'; } catch(e){}
statusSelect.value='paid';
paidAmountContainer.classList.add('hidden');
addSaleItemRow(); 
try { const etaBtn=document.getElementById('eta-upload-from-modal-btn'); if (etaBtn) etaBtn.classList.add('hidden'); } catch(_){ }
}
updateSaleSummary();
openModal(saleModal);
}
async function saveSale(e) {
e.preventDefault();
const id=document.getElementById('sale-id').value;
const repName=document.getElementById('sale-rep').value;
const customerId=document.getElementById('sale-customer').value;
const date=document.getElementById('sale-date').value;
const invoiceNumber=document.getElementById('sale-invoice-number').value;
if (!repName || !customerId || !date || !invoiceNumber) {
await customDialog({ message: 'الرجاء ملء بيانات المندوب، العميل، التاريخ، ورقم الفاتورة.', title: 'بيانات ناقصة' });
return;
}
const items=[];
let subtotal=0;
const itemRows=document.querySelectorAll('#sale-items-container .sale-item-row');
if (itemRows.length===0) {
await customDialog({ message: 'الرجاء إضافة منتج واحد على الأقل للفاتورة.', title: 'بيانات ناقصة' });
return;
}
let saleNeedsReview=false;
for (const row of itemRows) {
const productId=row.querySelector('.sale-item-product').value;
const quantity=parseInt(row.querySelector('.sale-item-quantity').value);
const price=parseFloat(row.querySelector('.sale-item-price').value);
if (!productId || isNaN(quantity) || quantity===0 || isNaN(price)) {
await customDialog({ message: 'أحد المنتجات في الفاتورة به بيانات غير صحيحة (الكمية يجب أن تكون رقم غير صفري).', title: 'بيانات ناقصة' });
return;
}
const itemTotal=quantity * price;
try {
const prod=findProduct(productId) || {};
let expectedPrice=(prod.price !=null) ? Number(prod.price) : 0;
try {
const customer=findCustomer(customerId);
if (customer && customer.priceListId) {
const pl=findPriceList(customer.priceListId);
if (pl && pl.productPrices && pl.productPrices[productId] !==undefined) expectedPrice=Number(pl.productPrices[productId]);
}
} catch(_){ }
try {
const promoPrice=getActivePromotionPrice(productId, customerId);
if (promoPrice !==null && promoPrice !==undefined) expectedPrice=Number(promoPrice);
} catch(_){ }
const isAdjusted=Math.abs((Number(price) || 0) - (Number(expectedPrice) || 0)) > 0.005;
if (isAdjusted) saleNeedsReview=true;
items.push({ productId, quantity, price, itemTotal, adjusted: isAdjusted, expectedPrice }); 
} catch(e){
items.push({ productId, quantity, price, itemTotal, adjusted: false });
}
subtotal +=itemTotal;
}
const discountPercent=parseFloat(document.getElementById('sale-discount').value) || 0;
const discountAmount=subtotal * (discountPercent / 100);
const additionPercent=parseFloat(document.getElementById('sale-addition').value) || 0;
const additionAmount=subtotal * (additionPercent / 100);
const finalTotal=subtotal - discountAmount + additionAmount;
const taxableSubtotal=subtotal - discountAmount + additionAmount;
let vatTotal=0;
try {
items.forEach(i=> {
try {
const prod=findProduct(i.productId) || {};
const vatRate=(prod && prod.vat_rate) ? Number(prod.vat_rate) / 100 : 0;
const lineBaseAfterDiscount=(Number(i.quantity) || 0) * (Number(i.price) || 0) * (1 - (discountPercent/100));
vatTotal +=lineBaseAfterDiscount * vatRate;
} catch(e){ }
});
} catch(e){ console.warn('VAT compute failed', e); }
vatTotal=round2(vatTotal);
let withholding=0;
try {
const customer=customerId ? findCustomer(customerId) : null;
if (customer && customer.taxNumber && String(customer.taxNumber).trim().length) {
withholding=round2(taxableSubtotal * 0.01);
}
} catch(e){ console.warn('withholding compute failed', e); }
let status=document.getElementById('sale-status').value;
let paidAmount=0;
if (finalTotal < 0) {
status='due'; 
paidAmount=0;
} else if (status==='paid') {
paidAmount=finalTotal;
} else if (status==='due') {
paidAmount=0;
} else { 
paidAmount=parseFloat(document.getElementById('sale-paid-amount').value) || 0;
if (paidAmount >=finalTotal) {
await customDialog({ message: 'المبلغ المدفوع جزئياً يساوي أو أكبر من الإجمالي. سيتم اعتبار الفاتورة "مدفوعة بالكامل".', title: 'تنبيه' });
status='paid';
paidAmount=finalTotal;
}
}
const saleData={
id: id || db.collection('sales').doc().id, 
date: new Date(date + 'T12:00:00Z').toISOString(),
createdAt: id ? (state.sales.find(s=>s.id===id).createdAt || new Date().toISOString()) : new Date().toISOString(),
updatedAt: new Date().toISOString(),
repName: repName,
customerId: customerId,
invoiceNumber: parseInt(invoiceNumber),
items: items.map(i=> ({...i, discountPercent: 0})), 
subtotal: round2(subtotal),
total: finalTotal,
taxAmount: vatTotal,
withholdingAmount: withholding,
status: status,
paidAmount: paidAmount,
discount: discountPercent,
additionPercent: additionPercent,
notes: document.getElementById('sale-notes').value.trim(),
taxFilingStatus: id ? (state.sales.find(s=>s.id===id).taxFilingStatus || '') : '' 
};
try {
if (saleNeedsReview) {
saleData.reviewStatus='pending';
saleData.reviewReason='adjusted';
try { saleData.reviewRequestedBy=(auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : null; } catch(_){ }
saleData.reviewRequestedAt=new Date().toISOString();
} else {
if (id) {
const existing=state.sales.find(s=>s.id===id);
if (existing && existing.reviewStatus) saleData.reviewStatus=existing.reviewStatus;
}
}
} catch(e){ console.warn('Setting review flag failed', e); }
try {
showLoading('جارٍ حفظ الفاتورة...');
saleData.includeInCash=true;
saleData.collectionReportCreated=saleData.collectionReportCreated || false;
saleData.paidToSafe=saleData.paidToSafe || false;
if (id) {
await updateSale(id, saleData);
} else {
await addSale(saleData);
}
hideLoading();
closeModal(saleModal);
try {
if (typeof window.debouncedSaveCash==='function') {
window.debouncedSaveCash();
}
} catch(e){ console.warn('Cash cloud sync after sale save failed', e); }
await customDialog({ message: 'تم حفظ الفاتورة بنجاح في السحابة.', title: 'نجاح', confirmClass: 'bg-green-600 hover:bg-green-700' });
} catch (error) {
hideLoading(); 
console.error('Error saving sale locally:', error);
await customDialog({ message: 'فشل حفظ الفاتورة: ' + (error && error.message ? error.message : String(error)), title: 'خطأ في الحفظ', confirmClass: 'bg-red-600 hover:bg-red-700' });
}
}
function loadState() {
if (!window.state) {
window.state={ customers: [], products: [], sales: [], priceLists: [], dispatchNotes: [], reps: [], promotions: [], settings: { salesTarget: 10000 }, stockEntries: {}, invoiceHighlights: {}, highlightCounter: 0 };
}
try {
if (!window.state.stockEntries || Object.keys(window.state.stockEntries).length===0) {
const saved=localStorage.getItem('stock_entries');
if (saved) {
window.state.stockEntries=JSON.parse(saved);
console.log('✅ Restored stockEntries from localStorage');
}
}
} catch(e){ console.warn('loadState: failed to restore stockEntries', e); }
return window.state;
}
(function() {
try {
if ((!state.sales || state.sales.length===0)) {
const backupsRaw=localStorage.getItem('mandoobiAppState_backups');
const backups=backupsRaw ? JSON.parse(backupsRaw) : [];
if (backups && backups.length > 0) {
console.info(`Found ${backups.length} local backups; automatic restore prompt suppressed.`);
}
}
} catch (e) {
console.warn('Auto-restore check failed', e);
}
})();
function saveState() {
try {
if (!window.CLOUD_ONLY) {
try {
localStorage.setItem('mandoobiAppState', JSON.stringify(state));
} catch (e) {
console.error('Failed to save main state to localStorage', e);
}
try {
const key='mandoobiAppState_backups';
const raw=localStorage.getItem(key);
const backups=raw ? JSON.parse(raw) : [];
backups.unshift({ ts: new Date().toISOString(), data: state });
while (backups.length > 12) backups.pop();
localStorage.setItem(key, JSON.stringify(backups));
} catch (e) {
console.warn('Failed to save state backup', e);
}
} else {
console.debug('CLOUD_ONLY: skipping local save and scheduling cloud save');
}
} catch (e) {
console.warn('saveState wrapper error', e);
}
try {
if (window.db && window.auth) {
scheduleCloudSave();
} else if (window.CLOUD_ONLY) {
console.warn('CLOUD_ONLY enabled but Firebase not initialized; state will not be persisted to cloud yet.');
}
} catch (e) { console.warn('Failed to schedule cloud save', e); }
}
function scheduleCloudSave(delayMs=900) {
if (!window.db || !window.auth || !auth.currentUser) return;
if (window.__cloudSaveTimer) clearTimeout(window.__cloudSaveTimer);
window.__cloudSaveTimer=setTimeout(async ()=>{
window.__cloudSaveTimer=null;
try { await saveStateToFirebase(); } catch(e){ console.warn('Deprecated cloud save failed', e); }
}, delayMs);
}
async function saveStateToFirebase() {
try {
const currentUser=auth.currentUser;
if (!currentUser) {
console.log('No user logged in, skipping Firebase save');
return;
}
function safeSerialize(val, depth=0){
if (depth > 6) return undefined; 
if (val===null) return null;
const t=typeof val;
if (t==='string' || t==='number' || t==='boolean') return val;
if (Array.isArray(val)) return val.map(v=> safeSerialize(v, depth+1)).filter(v=> v !==undefined);
if (t==='object') {
if (val instanceof Date) return val.toISOString();
if (val.nodeType || (val.ownerDocument && val.defaultView)) return undefined; 
const out={}; Object.keys(val).forEach(k=> {
const v=val[k];
if (typeof v==='function') return;
const sv=safeSerialize(v, depth+1);
if (sv !==undefined) out[k]=sv;
});
return out;
}
return undefined; 
}
const cleanState=safeSerialize(state) || {};
const userData={
appState: cleanState,
lastUpdated: new Date().toISOString(),
email: currentUser.email
};
await db.collection('users').doc(currentUser.uid).set(userData, { merge: true });
console.log('✅ State saved to Firebase successfully');
} catch (error) {
console.warn('⚠️ Failed to save state to Firebase:', error);
}
}
async function loadStateFromFirebase() {
try {
const currentUser=auth.currentUser;
if (!currentUser) {
console.log('No user logged in, skipping Firebase load');
return null;
}
const docSnapshot=await db.collection('users').doc(currentUser.uid).get();
if (docSnapshot.exists && docSnapshot.data().appState) {
console.log('✅ State loaded from Firebase successfully');
return docSnapshot.data().appState;
} else {
console.log('No data found in Firebase for this user');
return null;
}
} catch (error) {
console.warn('⚠️ Failed to load state from Firebase:', error);
return null;
}
}
async function migrateSalesFromUserDocIfFound(){
try {
if (!window.db || !window.auth) return;
const u=auth.currentUser; if (!u) return;
const MIG_KEY='migrated_sales_from_userdoc_v1';
if (localStorage.getItem(MIG_KEY)==='done') return;
if (Array.isArray(window.state?.sales) && window.state.sales.length > 0) return;
const salesSnap=await db.collection('sales').limit(1).get().catch(()=>null);
if (salesSnap && !salesSnap.empty) return;
const userDoc=await db.collection('users').doc(u.uid).get();
const appState=userDoc.exists ? (userDoc.data() || {}).appState : null;
const legacySales=Array.isArray(appState?.sales) ? appState.sales : [];
if (!legacySales.length) return;
console.warn('Migrating sales from users/' + u.uid + '.appState.sales -> sales collection. Count=', legacySales.length);
let batch=db.batch(); let pending=0;
function commitIfNeeded(force){ return force || pending >=450 ? batch.commit().then(()=>{ batch=db.batch(); pending=0; }) : Promise.resolve(); }
for (const s of legacySales){
try {
const sid=String(s.id || s.invoiceNumber || db.collection('sales').doc().id);
const items=Array.isArray(s.items) ? s.items.map(it=> ({
productId: it.productId || it.id || it.code || '',
qty: Number(it.qty || it.quantity || it.q || 0),
price: Number(it.price || it.p || 0)
})) : [];
const total=Number(s.total || s.finalTotal || s.amount || 0);
const paidAmount=Number(s.paidAmount || s.paid || 0);
const discountPercent=Number(s.discountPercent || s.discount || 0);
const dateIso=s.date ? new Date(s.date).toISOString() : new Date().toISOString();
const docRef=db.collection('sales').doc(sid);
batch.set(docRef, {
id: sid,
invoiceNumber: s.invoiceNumber || null,
customerId: s.customerId || (s.customer && (s.customer.id || s.customerId)) || null,
repName: s.repName || s.repId || '',
items,
total,
paidAmount,
status: s.status || 'due',
discountPercent,
taxFilingStatus: s.taxFilingStatus || '',
date: dateIso,
createdAt: serverTs(),
updatedAt: serverTs()
}, { merge: true });
pending++; await commitIfNeeded(false);
} catch(e){ console.warn('migrate sale record failed', e); }
}
await commitIfNeeded(true);
localStorage.setItem(MIG_KEY, 'done');
console.log('✅ Migration of legacy sales complete');
} catch(e){ console.warn('migrateSalesFromUserDocIfFound error', e); }
}
function getStatusBadge(status) {
let text, color; if (status==='paid') { text='مدفوع'; color='bg-green-100 text-green-800'; } else if (status==='due') { text='آجل'; color='bg-red-100 text-red-800'; } else if (status==='partial') { text='جزئي'; color='bg-yellow-100 text-yellow-800'; } else { text='غير محدد'; color='bg-gray-100 text-gray-800'; } return `<span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${color}">${text}</span>`;
}
function getTaxStatusBadge(sale) {
const customer=findCustomer(sale.customerId); 
const requiresFiling=customer?.requiresTaxFiling;
if (!requiresFiling) { return ''; } 
const taxStatus=sale.taxFilingStatus;
const isFiled=taxStatus && taxStatus.trim().toLowerCase()==='تم';
if (isFiled) {
return `
<button 
class="tax-status-toggle-btn text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 flex items-center gap-1"
data-id="${sale.id}"
>
<i data-lucide="check" class="w-3 h-3"></i> تم الرفع
</button>
`;
} else {
const statusText=taxStatus && taxStatus.trim() !=='' ? taxStatus : 'لم يتم الرفع';
return `
<button 
class="tax-status-toggle-btn text-xs font-medium px-2.5 py-0.5 rounded-full tax-not-filed-badge flex items-center gap-1"
data-id="${sale.id}"
>
<i data-lucide="x" class="w-3 h-3"></i> ${statusText}
</button>
`;
}
}
function populatePriceListDropdown(selectEl, selectedPriceListId='') {
selectEl.innerHTML='<option value="">-- بدون قائمة --</option>' + state.priceLists.map(pl=> `<option value="${pl.id}" ${pl.id===selectedPriceListId ? 'selected' : ''}>${pl.name}</option>`).join('');
}
function populateCustomerDropdown(selectEl, selectedCustomerId='') {
selectEl.innerHTML='<option value="">-- اختر عميل --</option>' + state.customers.map(c=> `<option value="${c.id}" ${c.id===selectedCustomerId ? 'selected' : ''}>${c.name}</option>`).join('');
}
function checkAndShowAutoStatement() {
const today=new Date(); const day=today.getDate(); const year=today.getFullYear(); const month=today.getMonth(); const lastDayOfMonth=new Date(year, month + 1, 0).getDate(); const isStatementDay=[10, 20, lastDayOfMonth].includes(day); if (!isStatementDay) return; const periodIdentifier=`${year}-${month}-${day}`; const lastShownIdentifier=localStorage.getItem('lastStatementShown'); if (lastShownIdentifier===periodIdentifier) return; let startDate, endDate; endDate=new Date(year, month, day); if (day <=10) startDate=new Date(year, month, 1); else if (day <=20) startDate=new Date(year, month, 11); else startDate=new Date(year, month, 21); const exceptionCustomerIds=state.customers.filter(c=> c.name.includes("اكسبشن ماركت")).map(c=> c.id); if (exceptionCustomerIds.length===0) return; const endDateForCheck=new Date(endDate); endDateForCheck.setHours(23,59,59,999); const hasRelevantSales=state.sales.some(sale=> { const saleDate=new Date(sale.date); return exceptionCustomerIds.includes(sale.customerId) && saleDate >=startDate && saleDate <=endDateForCheck; }); if (hasRelevantSales) { localStorage.setItem('lastStatementShown', periodIdentifier); generateAndShowStatement(startDate, endDate, exceptionCustomerIds, 'كشف حساب تلقائي', 'اكسبشن ماركت (جميع الفروع)'); }
}
function renderAll() {
state.sales.sort((a, b)=> new Date(b.date).getTime() - new Date(a.date).getTime()); saveState(); const repFilterSelect=document.getElementById('dashboard-rep-filter'); const currentFilter=repFilterSelect.value; populateRepDropdown(repFilterSelect, currentFilter);
const textFilter=document.getElementById('search-sales-text').value; const dateFilter=document.getElementById('search-sales-date').value; const custFilter=document.getElementById('search-customers').value; const prodFilter=document.getElementById('search-products').value;
scheduleRender('dashboard-main', ()=>{ try { renderDashboard(); } catch(e){} try { renderDispatchPage(); } catch(e){} });
scheduleRender('sales-list', ()=>{ try { renderAllSales(textFilter, dateFilter); } catch(e){} });
scheduleRender('customers-list', ()=>{ try { renderCustomers(custFilter); } catch(e){} });
scheduleRender('reps-list', ()=>{ try { renderReps(); } catch(e){} });
scheduleRender('settings-products', ()=>{ try { renderSettings(prodFilter); } catch(e){} });
scheduleRender('promotions', ()=>{ try { renderPromotions(); } catch(e){} });
scheduleRender('debts', ()=>{ try { renderDebts(); } catch(e){} });
scheduleRender('rep-debts', ()=>{ try { renderRepDebts(); } catch(e){} });
scheduleRender('costs', ()=>{ try { renderUnifiedPriceGrid(); } catch(e){} });
const statementCustomerList=document.getElementById('statement-customer-list'); const statementCustomerSearch=document.getElementById('statement-customer-search'); if (statementCustomerList && statementCustomerSearch) { statementCustomerSearch.value=''; updateCustomerList(''); } updateIcons(); 
try { if (typeof renderCash==='function') renderCash(); } catch (e) { console.warn('renderAll: renderCash failed', e); }
}
function initializeReportsPage() {
populateRepDropdownReports(dailyReportRepSelect);
populateRepDropdownReports(rangeReportRepSelect);
populateRepDropdownReports(monthlyReportRepSelect);
populateRepDropdownReports(document.getElementById('recon-report-rep'));
const today=new Date().toISOString().split('T')[0];
dailyReportDateInput.value=today;
rangeStartDateInput.value=today;
rangeEndDateInput.value=today;
const currentMonth=new Date().toISOString().substring(0, 7); 
monthlyReportMonthInput.value=currentMonth;
const targetsMonthInput=document.getElementById('targets-month');
if (targetsMonthInput) targetsMonthInput.value=currentMonth;
const customerTargetsMonthInput=document.getElementById('customer-targets-month');
if (customerTargetsMonthInput) customerTargetsMonthInput.value=currentMonth;
const activeReportSection=reportsSubnav.querySelector('.reports-subnav-item.active')?.dataset.reportSection || 'daily';
showReportContent(activeReportSection);
}
function showReportContent(section) {
reportContentAreas.forEach(area=> {
area.classList.add('hidden');
area.classList.remove('active');
});
const activeArea=document.querySelector(`#page-reports [data-report-content="${section}"]`);
if (activeArea) {
activeArea.classList.remove('hidden');
activeArea.classList.add('active');
}
if (section==='targets') {
try { generateTargetsReport(); return; } catch(e){}
}
if (section==='customer-targets') {
try { generateCustomerTargetsReport(); return; } catch(e){}
}
reportOutputArea.innerHTML='<p class="text-center text-gray-500 mt-8">اضغط على زر "عرض التقرير" لإنشاء التقرير.</p>';
}
function printSection(elementId) {
const printElement=document.getElementById(elementId);
if (!printElement) return;
printElement.classList.add('printable-content');
setTimeout(()=> {
window.print();
setTimeout(()=> {
printElement.classList.remove('printable-content');
}, 500);
}, 50);
}
async function captureElementCanvas(element, scale=2) {
const prev={
boxShadow: element.style.boxShadow,
filter: element.style.filter,
transform: element.style.transform
};
element.style.boxShadow='none';
element.style.filter='none';
element.style.transform='none';
try {
await new Promise(r=> requestAnimationFrame(r));
const canvas=await html2canvas(element, {
scale,
useCORS: true,
backgroundColor: '#ffffff',
ignoreElements: el=> el.classList.contains('no-print')
});
return canvas;
} finally {
element.style.boxShadow=prev.boxShadow;
element.style.filter=prev.filter;
element.style.transform=prev.transform;
}
}
async function uploadImageBlobToStorage(blob, pathPrefix='shares/exports') {
if (location.protocol==='file:') {
console.warn('uploadImageBlobToStorage: تشغيل من file://=> التخطي وإرجاع null');
return null; 
}
if (!window.storage) throw new Error('Firebase Storage غير مهيأ');
try {
const uid=(window.auth && auth.currentUser && auth.currentUser.uid) ? auth.currentUser.uid : 'anon';
const path=`${pathPrefix}/${uid}/${Date.now()}.png`;
const ref=storage.ref().child(path);
const metadata={ contentType: 'image/png', cacheControl: 'public, max-age=31536000' };
const snap=await ref.put(blob, metadata);
const url=await snap.ref.getDownloadURL();
return url;
} catch(e){
console.warn('uploadImageBlobToStorage: فشل الرفع، سيتم استخدام مشاركة بديلة', e);
return null;
}
}
async function generateReportImage(elementId) {
const reportElement=document.getElementById(elementId);
if (!reportElement) {
await customDialog({ title: 'خطأ', message: 'لم يتم العثور على محتوى التقرير لنسخه.' });
return;
}
try {
showLoading('جارٍ تحويل التقرير إلى صورة...');
const isRecon=elementId==='recon-report-output';
let canvas;
if (isRecon){
reportElement.classList.add('recon-export-scale');
canvas=await captureElementCanvas(reportElement, 4);
reportElement.classList.remove('recon-export-scale');
} else {
canvas=await captureElementCanvas(reportElement, 2);
}
hideLoading();
const imageUrl=canvas.toDataURL('image/png');
const previewContainer=document.getElementById('image-preview-container');
const downloadBtn=document.getElementById('download-image-btn');
const imagePreviewModal=document.getElementById('image-preview-modal');
if (!previewContainer || !downloadBtn || !imagePreviewModal) {
await customDialog({title: 'خطأ', message: 'عناصر واجهة معاينة الصورة غير موجودة.'});
return;
}
previewContainer.innerHTML='';
const img=document.createElement('img');
img.src=imageUrl;
if (isRecon) {
img.style.width=canvas.width + 'px';
img.style.maxWidth='100%';
previewContainer.style.maxWidth=canvas.width + 'px';
previewContainer.style.overflow='auto';
} else {
img.className='w-full h-auto';
}
previewContainer.appendChild(img);
downloadBtn.onclick=()=> {
const a=document.createElement('a');
a.href=imageUrl;
a.download=`report-${elementId}.png`;
a.click();
};
openModal(imagePreviewModal);
} catch (err) {
console.error('html2canvas failed:', err);
hideLoading();
await customDialog({ title: 'خطأ', message: 'حدث خطأ أثناء إنشاء صورة التقرير.' });
}
}
async function exportSelectedRows(exportType) {
const checkedBoxes=document.querySelectorAll('#total-bills-table-body input.total-bill-row-checkbox:checked');
if (checkedBoxes.length===0) {
await customDialog({ title: 'لم يتم التحديد', message: 'الرجاء تحديد صف واحد على الأقل لتصديره.' });
return;
}
const selectedIds=Array.from(checkedBoxes).map(cb=> cb.value);
const selectedSales=state.sales.filter(s=> selectedIds.includes(s.id));
const includeTotalCheckbox=document.getElementById('include-total-in-export');
let totalHtml='';
if (includeTotalCheckbox && includeTotalCheckbox.checked) {
const totalContainer=document.getElementById('total-bills-summary-container');
if (totalContainer) {
const clonedTotal=totalContainer.cloneNode(true);
const checkboxDiv=clonedTotal.querySelector('div:last-child');
if (checkboxDiv) checkboxDiv.remove(); 
clonedTotal.classList.add('mb-4');
totalHtml=clonedTotal.outerHTML;
}
}
const originalThead=document.querySelector('#total-bills-table thead');
const clonedThead=originalThead.cloneNode(true);
clonedThead.querySelector('th').remove(); 
const rowsHtml=selectedSales.map(sale=> {
const customer=findCustomer(sale.customerId);
const category=sale.items.length > 0 ? (findProduct(sale.items[0].productId)?.category || 'N/A') : 'N/A';
return `
<tr>
<td class="px-6 py-4 whitespace-nowrap text-center">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
<td class="px-6 py-4 whitespace-nowrap text-center font-bold">${sale.invoiceNumber}</td>
<td class="px-6 py-4 whitespace-nowrap text-right">${customer ? customer.name : 'N/A'}</td>
<td class="px-6 py-4 whitespace-nowrap text-right">${sale.repName}</td>
<td class="px-6 py-4 whitespace-nowrap text-center font-semibold">${formatCurrency(sale.total)}</td>
<td class="px-6 py-4 whitespace-nowrap text-center">${getStatusBadge(sale.status)}</td>
<td class="px-6 py-4 whitespace-nowrap text-right">${category}</td>
</tr>
`;
}).join('');
const tempExportElement=document.createElement('div');
tempExportElement.id='temp-export-area';
tempExportElement.innerHTML=`
<h2 class="text-xl font-bold mb-4 text-center">تقرير الصفوف المحددة</h2>
${totalHtml}
<table class="min-w-full divide-y divide-gray-200" style="direction: rtl;">
${clonedThead.outerHTML}
<tbody class="bg-white divide-y divide-gray-200">${rowsHtml}</tbody>
</table>
`;
tempExportElement.style.position='absolute';
tempExportElement.style.left='-9999px';
document.body.appendChild(tempExportElement);
if (exportType==='print') {
await printSection('temp-export-area');
} else if (exportType==='image') {
await generateReportImage('temp-export-area');
}
document.body.removeChild(tempExportElement);
}
/* moved to src/features/targets.js */
/* moved: generateTargetsReport -> src/features/targets.js */
function generateCustomerTargetsReport(){
const monthVal=document.getElementById('customer-targets-month')?.value || '';
const catVal=document.getElementById('customer-targets-category')?.value || 'both';
const out=document.getElementById('customer-targets-report-output');
if (!out) return;
if (!monthVal){ out.innerHTML='<p class="text-center text-gray-500">اختر شهر.</p>'; return; }
const [yStr, mStr]=monthVal.split('-'); const year=parseInt(yStr,10); const m=parseInt(mStr,10)-1;
const monthStart=new Date(Date.UTC(year,m,1)); const monthEnd=new Date(Date.UTC(year,m+1,1) - 1);
const nameKeys=['اكسبشن','سفير','الضحى'];
const customers=(state.customers||[]).filter(c=> {
const nm=(c.name||'');
const include=nameKeys.some(k=> nm.includes(k));
const isExcluded=/اكسبشن/.test(nm) && /(حلواني|حلوانى)/.test(nm);
return include && !isExcluded;
});
if (customers.length===0){ out.innerHTML='<p class="text-center text-gray-500">لا توجد عملاء مستهدفة.</p>'; return; }
const targetsMonthObj=getCustomerTargetsForMonth(monthVal);
const agg={}; 
(state.sales||[]).forEach(sale=> {
const d=new Date(sale.date);
if (isNaN(d.getTime())) return; 
if (d < monthStart || d > monthEnd) return;
const cid=sale.customerId;
const cust=customers.find(c=> c.id===cid || c._id===cid);
if (!cust) return;
sale.items.forEach(item=> {
const p=findProduct(item.productId); if (!p) return;
const nameLower=(cust.name||'').toLowerCase();
const prodLower=(p.name||'').toLowerCase();
if (nameLower.includes('اكسبشن') && prodLower.includes('شيلي')) return;
const qty=Number(item.quantity||item.qty||0);
const price=Number(p.price||0);
const value=qty * price;
const cat=String(p.category||'').toLowerCase();
const isMulti=cat.includes('مالت') || cat.includes('multi');
const isDairy=cat.includes('بان') || cat.includes('جبن') || cat.includes('cheese') || cat.includes('dairy');
agg[cid]=agg[cid] || { multiAch:0, dairyAch:0 };
if (isMulti) agg[cid].multiAch +=value; else if (isDairy) agg[cid].dairyAch +=value;
});
});
function fmt(v){ return formatCurrency(v||0); }
const rows=customers.map(c=> {
const cid=c.id || c._id; const a=agg[cid] || { multiAch:0, dairyAch:0 };
const targetData=targetsMonthObj[cid] || {}; 
const hasMultiSaved=Object.prototype.hasOwnProperty.call(targetData,'multi');
const hasDairySaved=Object.prototype.hasOwnProperty.call(targetData,'dairy');
const multiTarget=hasMultiSaved ? Number(targetData.multi||0) : 0;
const dairyTarget=hasDairySaved ? Number(targetData.dairy||0) : 0;
const multiRem=multiTarget - a.multiAch; const dairyRem=dairyTarget - a.dairyAch;
const multiPct=multiTarget? (a.multiAch/multiTarget)*100:0; const dairyPct=dairyTarget? (a.dairyAch/dairyTarget)*100:0;
const multiInputVal=hasMultiSaved ? multiTarget : '';
const dairyInputVal=hasDairySaved ? dairyTarget : '';
const multiInput=`<input type='number' step='any' class='cust-target-input w-20 p-1 border rounded text-center text-xs' data-category='multi' data-customer-id='${cid}' value='${multiInputVal}' placeholder='0'/>`;
const dairyInput=`<input type='number' step='any' class='cust-target-input w-20 p-1 border rounded text-center text-xs' data-category='dairy' data-customer-id='${cid}' value='${dairyInputVal}' placeholder='0'/>`;
if (catVal==='multi'){
return `<tr>
<td class='name'>${escapeHtml(c.name)}</td>
<td>${multiInput}</td>
<td class='ach-cell'>${fmt(a.multiAch)}</td>
<td class='${multiRem>0?'rem-pos':'rem-zero'}'>${fmt(multiRem)}</td>
<td class='${multiPct>=50?'pct-ok':'pct-low'}'>${multiPct.toFixed(1)}%</td>
</tr>`;
} else if (catVal==='dairy'){
return `<tr>
<td class='name'>${escapeHtml(c.name)}</td>
<td>${dairyInput}</td>
<td class='ach-cell'>${fmt(a.dairyAch)}</td>
<td class='${dairyRem>0?'rem-pos':'rem-zero'}'>${fmt(dairyRem)}</td>
<td class='${dairyPct>=50?'pct-ok':'pct-low'}'>${dairyPct.toFixed(1)}%</td>
</tr>`;
} else { 
const totalTarget=multiTarget + dairyTarget;
const totalAch=a.multiAch + a.dairyAch;
const totalRem=totalTarget - totalAch;
const totalPct=totalTarget? (totalAch/totalTarget)*100:0;
return `<tr>
<td class='name'>${escapeHtml(c.name)}</td>
<td>${multiInput}</td>
<td class='ach-cell'>${fmt(a.multiAch)}</td>
<td>${dairyInput}</td>
<td class='ach-cell'>${fmt(a.dairyAch)}</td>
<td class='ach-cell'>${fmt(totalTarget)}</td>
<td class='ach-cell'>${fmt(totalAch)}</td>
<td class='${totalRem>0?'rem-pos':'rem-zero'}'>${fmt(totalRem)}</td>
<td class='${totalPct>=50?'pct-ok':'pct-low'}'>${totalPct.toFixed(1)}%</td>
</tr>`;
}
}).join('');
let thead;
if (catVal==='multi'){
thead=`<tr>
<th class='cth-name'>العميل</th>
<th class='cth-multi-target'>تارجت مالتي</th>
<th class='cth-multi-ach'>محقق مالتي</th>
<th class='cth-rem'>متبقي</th>
<th class='cth-pct'>% محقق</th>
</tr>`;
} else if (catVal==='dairy'){
thead=`<tr>
<th class='cth-name'>العميل</th>
<th class='cth-dairy-target'>تارجت البان</th>
<th class='cth-dairy-ach'>محقق البان</th>
<th class='cth-rem'>متبقي</th>
<th class='cth-pct'>% محقق</th>
</tr>`;
} else {
thead=`<tr>
<th class='cth-name'>العميل</th>
<th class='cth-multi-target'>تارجت مالتي</th>
<th class='cth-multi-ach'>محقق مالتي</th>
<th class='cth-dairy-target'>تارجت البان</th>
<th class='cth-dairy-ach'>محقق البان</th>
<th class='cth-total-target'>إجمالي التارجت</th>
<th class='cth-total-ach'>إجمالي المحقق</th>
<th class='cth-rem-total'>المتبقي الإجمالي</th>
<th class='cth-pct-total'>% إجمالي</th>
</tr>`;
}
out.innerHTML=`<div id='customer-targets-report-wrapper' class='bg-white p-3 rounded-lg shadow'>
<table class='customer-targets-table'>
<thead>${thead}</thead>
<tbody>${rows}</tbody>
</table>
<div class='flex gap-2 mt-3 no-print'>
<button onclick="printSection('customer-targets-report-wrapper')" class='bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm flex items-center gap-1'><i data-lucide='printer'></i> طباعة</button>
<button onclick="generateReportImage('customer-targets-report-wrapper')" class='bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm flex items-center gap-1'><i data-lucide='image'></i> صورة</button>
</div>
</div>`;
updateIcons();
}
function generateSettlementReport(){
const dateInput=document.getElementById('settlement-report-date');
const repSelect=document.getElementById('settlement-report-rep');
const date=(dateInput && dateInput.value) ? dateInput.value : (dailyReportDateInput ? dailyReportDateInput.value : '');
const repName=(repSelect && repSelect.value) ? repSelect.value : (dailyReportRepSelect ? dailyReportRepSelect.value : '');
if (!date) { customDialog({ message:'اختر تاريخاً للتسوية.', title:'بيانات ناقصة' }); return; }
if (!repName || repName==='all') { customDialog({ message:'اختر مندوب واحد للتسوية.', title:'تنبيه' }); return; }
const dispatchNote=state.dispatchNotes.find(n=> n.repName===repName && new Date(n.date).toISOString().split('T')[0]===date);
const productIds=state.products.map(p=> p.id);
const salesForDay=state.sales.filter(s=> s.repName===repName && new Date(s.date).toISOString().split('T')[0]===date);
const agg={}; 
function ensure(id){ if(!agg[id]) agg[id]={ productId:id, name: (findProduct(id)?.name)||id, dispatched:0, goodReturn:0, damagedReturn:0, freebie:0, sold:0, invoiceReturn:0 }; }
if (dispatchNote && Array.isArray(dispatchNote.items)) {
dispatchNote.items.forEach(it=>{
ensure(it.productId);
agg[it.productId].dispatched +=Number(it.quantity||0);
agg[it.productId].goodReturn +=Number(it.actualReturn||it.goodReturn||0);
agg[it.productId].damagedReturn +=Number(it.damagedReturn||0);
agg[it.productId].freebie +=Number(it.freebie||0);
});
}
salesForDay.forEach(sale=> {
sale.items.forEach(item=> {
ensure(item.productId);
const q=Number(item.quantity||item.qty||0);
if (sale.total < 0 || q < 0) { agg[item.productId].invoiceReturn +=Math.abs(q); }
else { agg[item.productId].sold +=q; }
});
});
Object.keys(agg).forEach(id=>{ if(!productIds.includes(id)) productIds.push(id); });
const rowsHtml=productIds.map(pid=> {
ensure(pid);
const m=agg[pid];
const used=m.sold + m.freebie + m.goodReturn + m.damagedReturn + m.invoiceReturn;
const diff=m.dispatched - used;
return `<tr style="background:#0b2d5e;color:#fff;font-size:12px;">
<td style='text-align:center;background:#1f3f79'>${formatCurrency(0)}</td>
<td style='text-align:center;background:#111'>${diff}</td>
<td style='text-align:center;background:#062c5c'>${m.dispatched}</td>
<td style='text-align:center;background:#094b2e'>${m.goodReturn}</td>
<td style='text-align:center;background:#062c5c'>${m.invoiceReturn}</td>
<td style='text-align:center;background:#051c44'>${m.sold}</td>
<td style='text-align:center;background:#062c5c'>${m.damagedReturn}</td>
<td style='text-align:center;background:#094b2e'>${m.freebie}</td>
<td style='text-align:center;background:#051c44'>${m.dispatched - m.goodReturn - m.damagedReturn}</td>
<td style='text-align:center;background:#041635'>${m.name}</td>
</tr>`;
}).join('');
const billNumber=salesForDay.length ? (salesForDay[0].invoiceNumber||'') : (dispatchNote?.serial||'');
const dayNum=date.split('-')[2];
const yearNum=date.split('-')[0];
const monthNum=date.split('-')[1];
reportOutputArea.innerHTML=`
<div id='settlement-report-output' style='direction:rtl;font-family:Cairo;'>
<table style='width:100%;border:4px solid #001a3d;font-size:12px;border-collapse:separate;'>
<thead>
<tr style='background:#0b2d5e;color:#fff;'>
<th style='width:60px;background:#331b6d'>قيمة</th>
<th style='background:#0b0b0b'>العجز / الفائض</th>
<th style='background:#041a3f'>الفرق بين اذن السيارة وبيع الفواتير</th>
<th style='background:#094b2e'>هالك واكراميات</th>
<th style='background:#041a3f'>صافي فواتير للمندوب</th>
<th style='background:#051c44'>مرتجع فواتير للمندوب</th>
<th style='background:#041a3f'>صافي بيع الفواتير</th>
<th style='background:#051c44'>مرتجع اذن السيارة</th>
<th style='background:#094b2e'>اذن خروج السيارة</th>
<th style='background:#0b0b0b'>اسم الصنف</th>
</tr>
<tr style='background:#062c5c;color:#fff;'>
<th style='background:#331b6d'>0.00</th>
<th style='background:#111'>${yearNum}</th>
<th style='background:#062c5c'>${monthNum}</th>
<th style='background:#fff;color:#000;font-weight:bold'><img src='' alt='' style='height:20px'></th>
<th style='background:#d49c3b;color:#000;font-weight:bold'>${date.split('-').reverse().join('/')}</th>
<th style='background:#1f3f79'>${repName}</th>
<th style='background:#8d0000;color:#fff'>${billNumber||''}</th>
<th style='background:#b46900;color:#fff'>${dayNum}</th>
<th style='background:#041a3f'>${repName}</th>
<th style='background:#041635'>اسم الصنف</th>
</tr>
</thead>
<tbody>${rowsHtml}</tbody>
</table>
<div style='display:flex;gap:16px;margin-top:12px;'>
<div style='background:#331b6d;color:#fff;padding:8px 24px;font-weight:bold;'>Total</div>
<div style='background:#271056;color:#fff;padding:8px 24px;font-weight:bold;'>0.0</div>
<div style='flex:1;background:linear-gradient(90deg,#008a00,#006400);color:#fff;text-align:center;font-weight:bold;padding:12px 8px;border:2px solid #004c00;'>لا توجد عجوزات وزيادات</div>
</div>
<div class='mt-4 grid grid-cols-3 gap-2 no-print'>
<button onclick="printSection('settlement-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> طباعة</button>
<button onclick="generateReportImage('settlement-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> نسخ كصورة</button>
<button onclick="shareSettlementWhatsApp('settlement-report-output')" class='bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2'><i data-lucide='send'></i> مشاركة واتساب</button>
</div>
</div>`;
updateIcons();
}
async function generateReconciliationReport() {
const date=document.getElementById('recon-report-date').value;
const repName=document.getElementById('recon-report-rep').value;
const chainId=document.getElementById('recon-report-chain').value;
const reportOutputArea=document.getElementById('report-output-area');
if (!date || !repName) {
await customDialog({ message: 'الرجاء تحديد التاريخ والمندوب.', title: 'بيانات ناقصة' });
return;
}
let allowedCustomerIds=null;
if (chainId) {
const chains=loadChains();
const chain=chains.find(c=> c.id===chainId);
if (chain) allowedCustomerIds=chain.customerIds || [];
}
const dispatchNote=state.dispatchNotes.find(n=> {
const d=new Date(n.date);
if (isNaN(d.getTime())) return false;
return n.repName===repName && d.toISOString().split('T')[0]===date;
});
if (!dispatchNote) {
reportOutputArea.innerHTML='<p class="text-center text-red-500 p-4">لم يتم العثور على إذن استلام لهذا المندوب في التاريخ المحدد.</p>';
return;
}
const sales=state.sales.filter(s=> {
const d=new Date(s.date);
if (isNaN(d.getTime())) return false; 
return s.repName===repName && d.toISOString().split('T')[0]===date && 
(!allowedCustomerIds || allowedCustomerIds.includes(s.customerId));
});
const salesByProduct={};
sales.forEach(sale=> {
sale.items.forEach(item=> {
salesByProduct[item.productId]=(salesByProduct[item.productId] || 0) + item.quantity;
});
});
const allProductIds=new Set([
...dispatchNote.items.map(i=> i.productId),
...Object.keys(salesByProduct)
]);
let reportRowsHtml='';
let totalDeficitValue=0;
let totalSurplusValue=0;
allProductIds.forEach(productId=> {
const product=findProduct(productId);
if (!product) return;
const dispatchItem=dispatchNote.items.find(i=> i.productId===productId) || {};
const takenOut=dispatchItem.quantity || 0;
const goodReturn=dispatchItem.goodReturn || 0;
const damagedReturn=dispatchItem.damagedReturn || 0;
const freebie=dispatchItem.freebie || 0;
const sold=salesByProduct[productId] || 0;
const expectedReturn=takenOut - sold - freebie;
const actualReturn=goodReturn + damagedReturn;
const difference=actualReturn - expectedReturn;
const differenceValue=difference * (product.price || 0);
let diffClass='text-gray-700';
if (difference < 0) {
diffClass='text-red-600 font-bold';
totalDeficitValue +=differenceValue; 
} else if (difference > 0) {
diffClass='text-green-600 font-bold';
totalSurplusValue +=differenceValue;
}
reportRowsHtml +=`
<tr style="border-bottom:1px solid #112b57;">
<td style="background:#041635;color:#fff;padding:6px 4px;text-align:right;font-weight:600">${escapeHtml(product.name)}</td>
<td style="background:#d49c3b;color:#000;padding:6px 4px;text-align:center;font-weight:600">${takenOut}</td>
<td style="background:#0b0b0b;color:#fff;padding:6px 4px;text-align:center">${sold}</td>
<td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center">${freebie}</td>
<td style="background:#041a3f;color:#fff;padding:6px 4px;text-align:center;font-weight:600">${expectedReturn}</td>
<td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center">${goodReturn}</td>
<td style="background:#041a3f;color:#fff;padding:6px 4px;text-align:center">${damagedReturn}</td>
<td style="background:#062c5c;color:#fff;padding:6px 4px;text-align:center;font-weight:600">${actualReturn}</td>
<td style="background:#041a3f;color:${difference<0?'#ff2e2e':(difference>0?'#25d366':'#fff')};padding:6px 4px;text-align:center;font-weight:${difference!==0?'700':'400'}">${difference}</td>
<td style="background:#062c5c;color:${differenceValue<0?'#ff2e2e':(differenceValue>0?'#25d366':'#fff')};padding:6px 4px;text-align:center;font-weight:${differenceValue!==0?'700':'400'}">${formatCurrency(differenceValue)}</td>
</tr>`;
});
const finalHtml=`
<div id='recon-report-output' style='direction:rtl;font-family:Cairo;'>
<div style='display:grid;grid-template-columns:120px 1fr 120px;align-items:center;margin-bottom:4px;'>
<div style='background:#3b0d00;color:#fff;padding:12px 8px;text-align:center;font-weight:bold;font-size:20px;border:2px solid #210600;'>${date.split('-')[2]}</div>
<div style='background:linear-gradient(90deg,#002aa8,#004dff);color:#fff;text-align:center;padding:12px 8px;font-size:24px;font-weight:bold;border:2px solid #001a3d;'>بيان بعجوزات وزيادات الموزعين</div>
<div style='background:#041a3f;color:#fff;padding:12px 8px;text-align:center;font-weight:bold;font-size:20px;border:2px solid #001a3d;'>${repName}</div>
</div>
<table style='width:100%;border:4px solid #001a3d;font-size:13px;border-collapse:separate;'>
<thead>
<tr style='color:#fff;'>
<th style='background:#041635;text-align:center;font-weight:bold'>الصنف</th>
<th style='background:#d49c3b;color:#000;font-weight:bold;width:70px;text-align:center'>المستلم</th>
<th style='background:#0b0b0b;text-align:center;font-weight:bold'>المباع</th>
<th style='background:#062c5c;text-align:center;font-weight:bold'>المجاني</th>
<th style='background:#041a3f;text-align:center;font-weight:bold'>المرتجع المتوقع</th>
<th style='background:#062c5c;text-align:center;font-weight:bold'>مرتجع سليم</th>
<th style='background:#041a3f;text-align:center;font-weight:bold'>مرتجع تالف</th>
<th style='background:#062c5c;text-align:center;font-weight:bold'>المرتجع الفعلي</th>
<th style='background:#041a3f;text-align:center;font-weight:bold'>الفرق كمية</th>
<th style='background:#062c5c;text-align:center;font-weight:bold'>الفرق قيمة</th>
</tr>
</thead>
<tbody>${reportRowsHtml}</tbody>
</table>
<div style='display:flex;gap:16px;margin-top:12px;'>
<div style='background:#3b0d00;color:#fff;padding:8px 24px;font-weight:bold;'>إجمالي عجز</div>
<div style='background:#5c1a00;color:#fff;padding:8px 24px;font-weight:bold;'>${formatCurrency(totalDeficitValue)}</div>
<div style='background:#d49c3b;color:#000;padding:8px 24px;font-weight:bold;'>إجمالي زيادة</div>
<div style='background:#094b2e;color:#fff;padding:8px 24px;font-weight:bold;'>${formatCurrency(totalSurplusValue)}</div>
<div style='flex:1;background:linear-gradient(90deg,#007a00,#00b300);color:#fff;text-align:center;font-weight:bold;padding:12px 8px;border:2px solid #004c00;'>${(totalDeficitValue===0 && totalSurplusValue===0)?'لا توجد عجوزات وزيادات':'مراجعة القيم أعلاه'}</div>
</div>
<div class='mt-4 grid grid-cols-3 gap-2 no-print'>
<button onclick="printSection('recon-report-output')" class='bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2'><i data-lucide='printer'></i> طباعة</button>
<button onclick="generateReportImage('recon-report-output')" class='bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2'><i data-lucide='image'></i> صورة HD</button>
<button onclick="shareReconciliationWhatsApp('recon-report-output')" class='bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2'><i data-lucide='send'></i> مشاركة واتساب</button>
</div>
</div>`;
reportOutputArea.innerHTML=finalHtml;
}
async function shareReconciliationWhatsApp(elementId){
const el=document.getElementById(elementId);
const date=document.getElementById('recon-report-date')?.value || '';
const rep=document.getElementById('recon-report-rep')?.value || '';
if (!el){ await customDialog({title:'خطأ', message:'تعذر العثور على التقرير.'}); return; }
try {
showLoading('جارٍ تجهيز مشاركة واتساب...');
el.classList.add('recon-export-scale');
const canvas=await captureElementCanvas(el, 4);
el.classList.remove('recon-export-scale');
const blob=await new Promise(r=> canvas.toBlob(r,'image/png'));
if (!blob) throw new Error('فشل إنشاء الصورة');
const url=await uploadImageBlobToStorage(blob, 'shares/final_settlements');
hideLoading(); 
const msg=`التسوية النهائية للمندوب ${rep} - ${date}\n${url}`;
const desktopUrl=`https://web.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
let popup=window.open(desktopUrl, '_blank');
setTimeout(()=> {
try {
if (!popup || popup.closed) {
window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
}
} catch(_) {
window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
}
}, 1800);
} catch(e){
console.warn('shareReconciliationWhatsApp failed', e);
hideLoading();
try {
const el2=document.getElementById(elementId);
if (el2){
el2.classList.add('recon-export-scale');
const cnv=await captureElementCanvas(el2, 2);
el2.classList.remove('recon-export-scale');
const dataUrl=cnv.toDataURL('image/png');
const w=window.open('about:blank','_blank');
if (w) {
w.document.write('<title>صورة التسوية النهائية</title><p style="font-family:sans-serif">احفظ الصورة ثم أرفقها في واتساب.</p><img style="max-width:100%;" src="'+dataUrl+'" />');
}
const altMsg=`التسوية النهائية للمندوب ${rep} - ${date} (مرفق صورة يدوياً)`;
try { navigator.clipboard.writeText(altMsg); } catch(_){}
await customDialog({title:'مشاركة بديلة', message:'تم تجهيز الصورة. تم فتح نافذة للحفظ، والرسالة نُسخت (إن سمح المتصفح). لتعمل المشاركة التلقائية: شغل الصفحة عبر http:// (خادم محلي) وراجع قواعد Storage.'});
return; 
}
} catch(_) { }
await customDialog({title:'خطأ', message:'تعذر مشاركة أو تجهيز مشاركة بديلة للصورة.'});
}
}
function openCustomerModal(id=null) {
customerForm.reset();
document.getElementById('customer-id').value='';
populatePriceListDropdown(document.getElementById('customer-price-list'));
populateRepDropdown(document.getElementById('customer-rep'));
if (id) {
const sid=String(id);
const customer=state.customers.find(c=> String(c.id)===sid || String(c._id)===sid);
if (customer) {
document.getElementById('customer-modal-title').textContent='تعديل بيانات العميل';
document.getElementById('customer-id').value=customer.id || customer._id || '';
document.getElementById('customer-name').value=customer.name;
document.getElementById('customer-tax-number').value=customer.taxNumber || '';
document.getElementById('customer-phone').value=customer.phone || '';
document.getElementById('customer-address').value=customer.address || '';
document.getElementById('customer-requires-tax').checked=customer.requiresTaxFiling || false;
document.getElementById('customer-price-list').value=customer.priceListId || '';
document.getElementById('customer-rep').value=customer.repName || '';
}
} else {
document.getElementById('customer-modal-title').textContent='إضافة عميل جديد';
try {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='rep') {
const current=AuthSystem.getCurrentUser();
if (current) {
const myRep=(state.reps||[]).find(r=> r.id===current.id);
if (myRep && myRep.name) {
const repSel=document.getElementById('customer-rep');
if (repSel) repSel.value=myRep.name;
}
}
}
} catch(e) { }
}
openModal(customerModal);
}
function openRepModal(id=null) {
repForm.reset();
document.getElementById('rep-id').value='';
if (id) {
const rep=state.reps.find(r=> r.id===id);
if (rep) {
document.getElementById('rep-modal-title').textContent='تعديل بيانات المندوب';
document.getElementById('rep-id').value=rep.id;
document.getElementById('rep-name').value=rep.name;
document.getElementById('rep-serial').value=rep.serial || '';
document.getElementById('rep-target').value=rep.target || 0;
document.getElementById('rep-next-invoice').value=rep.nextInvoiceNumber || '';
}
} else {
document.getElementById('rep-modal-title').textContent='إضافة مندوب جديد';
}
openModal(repModal);
}
function openProductModal(id=null) {
productForm.reset();
document.getElementById('product-id').value='';
if (id) {
const product=state.products.find(p=> p.id===id);
if (product) {
document.getElementById('product-modal-title').textContent='تعديل المنتج';
document.getElementById('product-id').value=product.id;
document.getElementById('product-code').value=product.id;
document.getElementById('product-name').value=product.name;
document.getElementById('product-price').value=product.price || 0;
document.getElementById('product-category').value=product.category || '';
document.getElementById('product-vat-rate').value=(product.vat_rate !==undefined && product.vat_rate !==null) ? Number(product.vat_rate) : 0;
}
} else {
document.getElementById('product-modal-title').textContent='إضافة منتج جديد';
}
openModal(productModal);
}
function openPriceListModal(id=null) {
priceListForm.reset();
document.getElementById('price-list-id').value='';
document.getElementById('price-list-name').value='';
const container=document.getElementById('price-list-products');
const tbody=document.getElementById('price-list-products-body');
const discountInput=document.getElementById('price-list-discount');
if (!tbody) {
container.innerHTML='<div class="p-4 text-center text-gray-500">خطأ في عرض الجدول</div>';
} else {
tbody.innerHTML='';
function parseDiscount(str){
if (!str) return 0;
const n=parseFloat(String(str).replace('%','').trim());
return isNaN(n) ? 0 : n;
}
function updateAllPricesAfterDiscount(){
const d=parseDiscount(discountInput.value);
Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
const priceInp=tr.querySelector('.price-list-product-input');
const afterInp=tr.querySelector('.price-after-discount');
if (!priceInp || !afterInp) return;
const v=parseFloat(priceInp.value);
if (!isNaN(v)) {
const newVal=v * (1 - d/100);
afterInp.value=formatNumberEN(newVal);
} else {
afterInp.value='';
}
});
}
state.products.forEach((p, idx)=> {
const tr=document.createElement('tr');
tr.dataset.pid=p.id;
tr.innerHTML=`
<td class="px-3 py-2 text-right">${idx+1}</td>
<td class="px-3 py-2 text-center">${escapeHtml(String(p.id||''))}</td>
<td class="px-3 py-2 text-right">${escapeHtml(String(p.name||''))}</td>
<td class="px-3 py-2 text-center">${escapeHtml(String(p.unit||'قطعة'))}</td>
<td class="px-3 py-2 text-center">${escapeHtml(String(p.barcode||''))}</td>
<td class="px-3 py-2 text-center"><input type="number" step="any" class="price-list-product-input p-1 border rounded w-28 text-center" data-product-id="${p.id}" placeholder="" /></td>
<td class="px-3 py-2 text-center"><input type="text" readonly class="price-after-discount p-1 border rounded w-28 text-center bg-gray-50" data-product-id="${p.id}" placeholder="" /></td>
`;
tbody.appendChild(tr);
});
tbody.addEventListener('input', (ev)=> {
const target=ev.target;
if (target && target.classList && target.classList.contains('price-list-product-input')) {
const d=parseDiscount(discountInput.value);
const v=parseFloat(target.value);
const row=target.closest('tr');
const afterInp=row ? row.querySelector('.price-after-discount') : null;
if (afterInp) {
if (!isNaN(v)) {
afterInp.value=formatNumberEN(v * (1 - d/100));
} else {
afterInp.value='';
}
}
}
});
discountInput.addEventListener('input', ()=> updateAllPricesAfterDiscount());
}
if (id) {
const pl=state.priceLists.find(x=> x.id===id);
if (pl) {
document.getElementById('price-list-modal-title').textContent='تعديل قائمة أسعار';
document.getElementById('price-list-id').value=pl.id;
document.getElementById('price-list-name').value=pl.name;
Object.keys(pl.productPrices || {}).forEach(pid=> {
const inp=container.querySelector(`.price-list-product-input[data-product-id="${pid}"]`);
if (inp) inp.value=pl.productPrices[pid];
});
}
} else {
document.getElementById('price-list-modal-title').textContent='إضافة قائمة أسعار';
}
openModal(priceListModal);
}
async function saveProduct(e) {
e.preventDefault();
const id=document.getElementById('product-id').value || document.getElementById('product-code').value.trim();
const code=document.getElementById('product-code').value.trim();
const name=document.getElementById('product-name').value.trim();
const price=parseFloat(document.getElementById('product-price').value) || 0;
const vat_rate=parseFloat(document.getElementById('product-vat-rate')?.value) || 0;
const category=document.getElementById('product-category').value.trim();
if (!code || !name) {
await customDialog({ title: 'خطأ', message: 'الرجاء إدخال كود واسم المنتج.' });
return;
}
try {
await updateProduct(code, { name, price, category, vat_rate: vat_rate, active: true });
closeModal(productModal);
await customDialog({ title: 'نجاح', message: 'تم حفظ المنتج في السحابة.' });
} catch (err) {
console.warn('saveProduct cloud failed', err);
await customDialog({ title: 'خطأ', message: 'تعذر حفظ المنتج في السحابة. تحقق من الاتصال والصلاحيات.' });
}
}
async function savePriceList(e) {
e.preventDefault();
const id=document.getElementById('price-list-id').value || Date.now().toString();
const name=document.getElementById('price-list-name').value.trim();
if (!name) { await customDialog({ title: 'خطأ', message: 'الرجاء إدخال اسم قائمة الأسعار.' }); return; }
const container=document.getElementById('price-list-products');
const inputs=Array.from(container.querySelectorAll('.price-list-product-input'));
const productPrices={};
inputs.forEach(inp=> {
const pid=inp.dataset.productId;
const val=parseFloat(inp.value);
if (!isNaN(val)) productPrices[pid]=val;
});
try {
const exists=(state.priceLists||[]).some(pl=> pl.id===id);
if (exists) {
await updatePriceListDoc(id, { name, productPrices });
} else {
await addPriceListDoc(id, { name, productPrices });
}
closeModal(priceListModal);
await customDialog({ title: 'نجاح', message: 'تم حفظ قائمة الأسعار في السحابة.' });
} catch (err) {
console.warn('savePriceList cloud failed', err);
await customDialog({ title: 'خطأ', message: 'تعذر حفظ قائمة الأسعار في السحابة. تحقق من الاتصال والصلاحيات.' });
}
}
function renderUnifiedPriceGrid() {
try {
const tbody=document.querySelector('#unified-price-grid tbody');
if (!tbody) return;
const tableEl=document.getElementById('unified-price-grid');
if (tableEl) {
let controls=document.getElementById('unified-grid-controls');
if (!controls) {
controls=document.createElement('div');
controls.id='unified-grid-controls';
controls.className='mb-3 flex gap-2 items-center';
tableEl.parentNode.insertBefore(controls, tableEl);
controls.innerHTML=`
<label class="text-sm">الفئة:</label>
<select id="unified-category-filter" class="p-1 border rounded text-sm">
<option value="all">الكل</option>
<option value="raw">الخامات</option>
<option value="packaging">التغليف</option>
<option value="finished">المنتجات</option>
<option value="operation">التشغيل</option>
</select>
<button id="unified-filter-apply" class="p-1 bg-gray-100 border rounded text-sm">تطبيق</button>
`;
controls.querySelector('#unified-filter-apply').addEventListener('click', ()=> renderUnifiedPriceGrid());
controls.querySelector('#unified-category-filter').addEventListener('change', ()=> renderUnifiedPriceGrid());
}
}
tbody.innerHTML='';
const selectedCategory=(document.getElementById('unified-category-filter')?.value) || 'all';
const products=Array.isArray(state.products) ? state.products.slice().sort((a,b)=> String(a.name||'').localeCompare(String(b.name||''), 'ar')) : [];
const filtered=products.filter(p=> {
if (selectedCategory==='all') return true;
if (selectedCategory==='raw') return String(p.category||'').toLowerCase()==='raw' || String(p.category||'').toLowerCase().includes('raw') || (p.category==='raw' );
if (selectedCategory==='packaging') return String(p.category||'').toLowerCase().includes('packag') || String(p.category||'').toLowerCase()==='packaging';
if (selectedCategory==='finished') return !(String(p.category||'').toLowerCase()==='raw' || String(p.category||'').toLowerCase().includes('packag'));
if (selectedCategory==='operation') return (p.operationCost !==undefined || p.operationCost !==null);
return true;
});
if (filtered.length===0) {
tbody.innerHTML='<tr><td colspan="6" class="p-4 text-center text-gray-500">لا توجد أصناف في هذه الفئة.</td></tr>';
return;
}
filtered.forEach((p)=> {
const tr=document.createElement('tr');
tr.className='hover:bg-orange-50';
let fieldKey='price';
let fieldLabel='السعر';
if (String(p.category||'').toLowerCase().includes('raw') || String(p.category||'').toLowerCase()==='raw') { fieldKey='cost'; fieldLabel='تكلفة'; }
else if (String(p.category||'').toLowerCase().includes('packag') || String(p.category||'').toLowerCase()==='packaging') { fieldKey='cost'; fieldLabel='تكلفة'; }
else if (selectedCategory==='operation' || p.operationCost !==undefined) { fieldKey='operationCost'; fieldLabel='تكلفة تشغيل'; }
const currentVal=(p[fieldKey] !==undefined && p[fieldKey] !==null) ? Number(p[fieldKey]) : '';
tr.innerHTML=`
<td class="px-3 py-2 text-right font-medium">${escapeHtml(p.name || '')}</td>
<td class="px-3 py-2 text-center text-sm">${escapeHtml(String(p.id || ''))}</td>
<td class="px-3 py-2 text-center text-sm">${escapeHtml(String(p.category || ''))}</td>
<td class="px-3 py-2 text-center text-sm">${formatNumberEN(currentVal)}</td>
<td class="px-3 py-2 text-center"><input type="number" step="any" inputmode="decimal" class="unified-price-input p-1 border rounded w-28 text-center" data-product-id="${escapeHtml(p.id||'')}" data-field-key="${escapeHtml(fieldKey)}" value="${currentVal==='' ? '' : currentVal}" placeholder="${escapeHtml(fieldLabel)}" /></td>
<td class="px-3 py-2 text-center flex items-center gap-2"><span class="unified-save-indicator text-xs text-gray-500">&nbsp;</span><button class="unified-history-btn p-1 text-xs bg-white border rounded" data-product-id="${escapeHtml(p.id||'')}">تاريخ</button></td>
`;
tbody.appendChild(tr);
});
const inputs=tbody.querySelectorAll('.unified-price-input');
inputs.forEach(inp=> {
const pid=inp.dataset.productId;
const fkey=inp.dataset.fieldKey || 'price';
const newInp=inp.cloneNode(true);
inp.parentNode.replaceChild(newInp, inp);
const indicator=newInp.closest('tr').querySelector('.unified-save-indicator');
let timer=null;
newInp.addEventListener('input', (e)=> {
if (indicator) indicator.textContent='تحرير...';
if (timer) clearTimeout(timer);
timer=setTimeout(async ()=> {
const raw=newInp.value.trim();
if (raw==='') { if (indicator) indicator.textContent=''; return; }
const num=Number(raw);
if (isNaN(num)) { if (indicator) indicator.textContent='قيمة غير صالحة'; return; }
newInp.disabled=true;
if (indicator) indicator.textContent='حفظ...';
try {
const payload={};
payload[fkey]=num;
payload.updatedAt=serverTs();
await updateProduct(pid, payload);
const prod=state.products.find(x=> String(x.id)===String(pid));
if (prod) { prod[fkey]=num; prod.updatedAt=new Date().toISOString(); }
saveState();
if (indicator) indicator.textContent='تم الحفظ';
setTimeout(()=>{ if (indicator) indicator.textContent=''; }, 1200);
} catch (err) {
console.warn('Failed to save unified field for', pid, err);
if (indicator) indicator.textContent='خطأ في الحفظ';
if (err && err.code==='permission-denied') customDialog({ title: 'صلاحيات', message: 'ليس لديك صلاحية لحفظ هذه القيم.' });
} finally { newInp.disabled=false; }
}, 650);
});
});
tbody.querySelectorAll('.unified-history-btn').forEach(btn=> {
btn.addEventListener('click', (e)=> {
const pid=e.currentTarget.dataset.productId;
openPriceHistory(pid);
});
});
updateIcons();
} catch (e) {
console.warn('renderUnifiedPriceGrid failed', e);
}
}
function openPriceHistory(productId) {
try {
const modal=document.getElementById('price-history-modal');
const body=document.getElementById('ph-body');
const addBtn=document.getElementById('ph-add-btn');
if (!modal || !body || !addBtn) return;
const prod=state.products.find(p=> String(p.id)===String(productId));
const hist=Array.isArray(prod && prod.priceHistory) ? prod.priceHistory.slice().sort((a,b)=> new Date(b.at) - new Date(a.at)) : [];
let html=`<div class="space-y-2">`;
if (!hist.length) html +=`<p class="text-sm text-gray-500">لا توجد مدخلات تاريخية.</p>`;
hist.forEach(h=> {
const v=h.value !==undefined ? formatNumberEN(h.value) : '';
const who=h.by || (h.uid || 'نظام');
const when=h.at ? new Date(h.at).toLocaleString('ar-EG') : '';
html +=`<div class="p-2 border rounded bg-white"><div class="text-sm font-medium">${v}</div><div class="text-xs text-gray-500">${who} — ${when}</div></div>`;
});
html +=`</div>`;
body.innerHTML=html;
addBtn.onclick=async ()=> {
try {
const prod=state.products.find(p=> String(p.id)===String(productId));
if (!prod) return;
const current=prod.price !==undefined ? prod.price : (prod.cost !==undefined ? prod.cost : null);
if (current===null) { await customDialog({ title: 'خطأ', message: 'لا توجد قيمة حالية ليتم إضافتها.' }); return; }
const entry={ value: current, at: new Date().toISOString(), by: (auth && auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)) ? (auth.currentUser.email || auth.currentUser.uid) : 'unknown' };
prod.priceHistory=prod.priceHistory || [];
prod.priceHistory.push(entry);
await updateProduct(productId, { priceHistory: prod.priceHistory, updatedAt: serverTs() });
saveState();
await customDialog({ title: 'نجاح', message: 'تم إضافة السجل إلى تاريخ السعر.' });
openPriceHistory(productId);
} catch (err) {
console.warn('add price history failed', err);
await customDialog({ title: 'خطأ', message: 'تعذر إضافة سجل التاريخ.' });
}
};
openModal(modal);
} catch (e) { console.warn('openPriceHistory failed', e); }
}
async function saveFinishedProductFromStock(e) {
e.preventDefault();
const code=document.getElementById('finished-product-code').value.trim();
const name=document.getElementById('finished-product-name').value.trim();
const unit=document.getElementById('finished-product-unit').value.trim() || 'قطعة';
const price=parseFloat(document.getElementById('finished-product-price').value) || 0;
if (!code || !name) {
await customDialog({ title: 'خطأ', message: 'الرجاء إدخال كود واسم المنتج.' });
return;
}
if (state.products && state.products.some(p=> p.id===code)) {
await customDialog({ title: 'خطأ', message: 'هذا الكود موجود بالفعل. استخدم كود مختلف.' });
return;
}
try {
if (!state.products) state.products=[];
const chocoRe=/chocolate|شوكولاتة|شيكولاتة/i;
const vatRate=chocoRe.test(name) ? 14 : 0;
state.products.push({
id: code,
name: name,
unit: unit,
price: price,
vat_rate: vatRate,
category: 'finished',
active: true,
createdAt: new Date().toISOString(),
updatedAt: new Date().toISOString()
});
saveState();
if (!window.costFinished) window.costFinished=[];
if (!window.costFinished.some(p=> p.id===code)) {
window.costFinished.push({ id: code, code: code, name: name, unit: unit, price: price });
}
try {
await updateProduct(code, { name, unit, price, vat_rate: vatRate, category: 'finished', active: true });
} catch(err) {
console.warn('Failed to sync to Firestore:', err);
}
document.getElementById('modal-add-finished-product').classList.add('hidden');
document.getElementById('form-add-finished-product').reset();
await customDialog({ title: 'نجاح', message: `تم إضافة المنتج "${name}" بنجاح.` });
const dateEl=document.getElementById('finished-products-date');
if (dateEl) dateEl.dispatchEvent(new Event('change'));
} catch (err) {
console.warn('saveFinishedProductFromStock error:', err);
await customDialog({ title: 'خطأ', message: 'حدث خطأ أثناء حفظ المنتج.' });
}
}
async function saveRawMaterialFromStock(e) {
e.preventDefault();
const code=document.getElementById('raw-material-code').value.trim();
const name=document.getElementById('raw-material-name').value.trim();
const unit=document.getElementById('raw-material-unit').value.trim() || 'كجم';
const unitPrice=parseFloat(document.getElementById('raw-material-unit_price').value) || 0;
const qty=parseFloat(document.getElementById('raw-material-qty').value) || 1;
const totalCost=Math.round((unitPrice * qty) * 100) / 100;
if (!code || !name) {
await customDialog({ title: 'خطأ', message: 'الرجاء إدخال كود واسم الخامة.' });
return;
}
if (state.products && state.products.some(p=> p.id===code)) {
await customDialog({ title: 'خطأ', message: 'هذا الكود موجود بالفعل. استخدم كود مختلف.' });
return;
}
try {
if (!state.products) state.products=[];
const chocoReRaw=/chocolate|شوكولاتة|شيكولاتة/i;
const vatRateRaw=chocoReRaw.test(name) ? 14 : 0;
const taxInvoiceEl=document.getElementById('raw-material-is_tax_invoice');
const hasTaxInvoice=!!(taxInvoiceEl && taxInvoiceEl.checked);
const explicitVat=parseFloat(document.getElementById('raw-material-vat_value')?.value) || 0;
let input_vat=0;
if (explicitVat && explicitVat > 0) input_vat=round2(explicitVat);
else if (hasTaxInvoice && totalCost > 0) input_vat=round2(totalCost * 0.14);
const vendorTaxId=document.getElementById('raw-material-vendor_tax_id')?.value.trim() || null;
const invoiceNumber=document.getElementById('raw-material-invoice_number')?.value.trim() || null;
const invoiceDate=document.getElementById('raw-material-invoice_date')?.value || null;
const invoiceFileEl=document.getElementById('raw-material-invoice_image');
const invoiceFile=(invoiceFileEl && invoiceFileEl.files && invoiceFileEl.files[0]) ? invoiceFileEl.files[0] : null;
let invoiceImageUrl=null;
if (invoiceFile && window.storage) {
try {
const path=`invoices/raw/${code}/${Date.now()}_${invoiceFile.name}`;
const snap=await window.storage.ref().child(path).put(invoiceFile);
invoiceImageUrl=await snap.ref.getDownloadURL();
} catch(uerr) { console.warn('upload invoice image failed', uerr); }
}
state.products.push({
id: code,
name: name,
unit: unit,
cost: unitPrice,
vat_rate: vatRateRaw,
category: 'raw',
active: true,
createdAt: new Date().toISOString(),
updatedAt: new Date().toISOString()
});
saveState();
if (!window.costRaw) window.costRaw=[];
if (!window.costRaw.some(p=> p.id===code)) {
window.costRaw.push({ id: code, code: code, name: name, unit: unit, cost: unitPrice, lastPrice: unitPrice, lastPriceDate: new Date().toISOString(), priceHistory: [], lastPaidVat: input_vat, lastInvoiceNumber: invoiceNumber, lastInvoiceDate: invoiceDate, lastVendorTaxId: vendorTaxId, lastInvoiceImageUrl: invoiceImageUrl });
}
try {
await updateProduct(code, { name, unit, cost: unitPrice, vat_rate: vatRateRaw, lastPaidVat: input_vat, lastInvoiceNumber: invoiceNumber, lastInvoiceDate: invoiceDate, lastVendorTaxId: vendorTaxId, lastInvoiceImageUrl: invoiceImageUrl, category: 'raw', active: true });
} catch(err) {
console.warn('Failed to sync to Firestore:', err);
}
try {
if (window.db) {
await db.collection('transactions').add({
type: 'supply',
productId: code,
productCode: code,
name: name,
date: new Date().toISOString(),
qty: Number(qty || 0),
unitPrice: Number(unitPrice || 0),
total_cost: Number(totalCost || 0),
input_vat: Number(input_vat || 0),
vendor_tax_id: vendorTaxId,
invoice_number: invoiceNumber,
invoice_date: invoiceDate,
vat_value_reported: explicitVat || null,
invoice_image_url: invoiceImageUrl,
createdAt: serverTs()
});
}
} catch(e) {
console.warn('Failed to write transaction record:', e);
}
document.getElementById('modal-add-raw-material').classList.add('hidden');
document.getElementById('form-add-raw-material').reset();
await customDialog({ title: 'نجاح', message: `تم إضافة الخامة "${name}" بنجاح.` });
const dateEl=document.getElementById('raw-materials-date');
if (dateEl) dateEl.dispatchEvent(new Event('change'));
} catch (err) {
console.warn('saveRawMaterialFromStock error:', err);
await customDialog({ title: 'خطأ', message: 'حدث خطأ أثناء حفظ الخامة.' });
}
}
async function savePackagingFromStock(e) {
e.preventDefault();
const code=document.getElementById('packaging-code').value.trim();
const name=document.getElementById('packaging-name').value.trim();
const unit=document.getElementById('packaging-unit').value.trim() || 'قطعة';
const cost=parseFloat(document.getElementById('packaging-cost').value) || 0;
if (!code || !name) {
await customDialog({ title: 'خطأ', message: 'الرجاء إدخال كود واسم مادة التعبئة.' });
return;
}
if (state.products && state.products.some(p=> p.id===code)) {
await customDialog({ title: 'خطأ', message: 'هذا الكود موجود بالفعل. استخدم كود مختلف.' });
return;
}
try {
if (!state.products) state.products=[];
const chocoRePack=/chocolate|شوكولاتة|شيكولاتة/i;
const vatRatePack=chocoRePack.test(name) ? 14 : 0;
state.products.push({
id: code,
name: name,
unit: unit,
cost: cost,
vat_rate: vatRatePack,
category: 'packaging',
active: true,
createdAt: new Date().toISOString(),
updatedAt: new Date().toISOString()
});
saveState();
if (!window.costPack) window.costPack=[];
if (!window.costPack.some(p=> p.id===code)) {
window.costPack.push({ id: code, code: code, name: name, unit: unit, cost: cost, lastPrice: 0, lastPriceDate: null, priceHistory: [], vat_rate: vatRatePack });
}
const vendorTaxId=document.getElementById('packaging-vendor_tax_id')?.value.trim() || null;
const invoiceNumber=document.getElementById('packaging-invoice_number')?.value.trim() || null;
const invoiceDate=document.getElementById('packaging-invoice_date')?.value || null;
const explicitVat=parseFloat(document.getElementById('packaging-vat_value')?.value) || 0;
let input_vat=explicitVat && explicitVat > 0 ? round2(explicitVat) : 0;
const invoiceFileEl=document.getElementById('packaging-invoice_image');
const invoiceFile=(invoiceFileEl && invoiceFileEl.files && invoiceFileEl.files[0]) ? invoiceFileEl.files[0] : null;
let invoiceImageUrl=null;
if (invoiceFile && window.storage) {
try {
const path=`invoices/packaging/${code}/${Date.now()}_${invoiceFile.name}`;
const snap=await window.storage.ref().child(path).put(invoiceFile);
invoiceImageUrl=await snap.ref.getDownloadURL();
} catch(uerr) { console.warn('upload packaging invoice image failed', uerr); }
}
try {
await updateProduct(code, { name, unit, cost, vat_rate: vatRatePack, category: 'packaging', active: true, lastPaidVat: input_vat, lastInvoiceNumber: invoiceNumber, lastInvoiceDate: invoiceDate, lastVendorTaxId: vendorTaxId, lastInvoiceImageUrl: invoiceImageUrl });
} catch(err) {
console.warn('Failed to sync to Firestore:', err);
}
try {
if (window.db) {
await db.collection('transactions').add({
type: 'supply',
productId: code,
productCode: code,
name: name,
date: new Date().toISOString(),
qty: 1,
unitPrice: Number(cost || 0),
total_cost: Number(cost || 0),
input_vat: Number(input_vat || 0),
vendor_tax_id: vendorTaxId,
invoice_number: invoiceNumber,
invoice_date: invoiceDate,
vat_value_reported: explicitVat || null,
invoice_image_url: invoiceImageUrl,
createdAt: serverTs()
});
}
} catch(e) { console.warn('Failed to write packaging transaction record:', e); }
document.getElementById('modal-add-packaging').classList.add('hidden');
document.getElementById('form-add-packaging').reset();
await customDialog({ title: 'نجاح', message: `تم إضافة مادة التعبئة "${name}" بنجاح.` });
const dateEl=document.getElementById('packaging-date');
if (dateEl) dateEl.dispatchEvent(new Event('change'));
} catch (err) {
console.warn('savePackagingFromStock error:', err);
await customDialog({ title: 'خطأ', message: 'حدث خطأ أثناء حفظ مادة التعبئة.' });
}
}
async function saveSalesTarget(e) {
if (e && e.preventDefault) e.preventDefault();
const input=document.getElementById('sales-target-input');
if (!input) return;
const raw=String(input.value || '').replace(/,/g, '').trim();
const val=parseFloat(raw);
if (isNaN(val) || val < 0) {
await customDialog({ title: 'خطأ', message: 'الرجاء إدخال قيمة صحيحة للهدف الشهري (رقم موجب).' });
return;
}
state.settings=state.settings || {};
state.settings.salesTarget=Number(val);
saveState();
try {
if (window.db) {
await db.collection('settings').doc('global-settings').set({
salesTarget: Number(val),
updatedAt: firebase.firestore.FieldValue.serverTimestamp()
}, { merge: true });
console.log('تم حفظ الهدف الشهري في السحابة:', val);
}
} catch(err) {
console.warn('فشل حفظ الهدف الشهري في السحابة:', err);
}
renderDashboard();
await customDialog({ title: 'نجاح', message: 'تم حفظ الهدف الشهري بنجاح في السحابة وعرضه في الصفحة الرئيسية.' });
}
function updateDigitalClock() {
const clockEl=document.getElementById('digital-clock');
if (!clockEl) return;
const now=new Date();
const hours=String(now.getHours()).padStart(2, '0');
const minutes=String(now.getMinutes()).padStart(2, '0');
const seconds=String(now.getSeconds()).padStart(2, '0');
clockEl.textContent=`${hours}:${minutes}:${seconds}`;
}
updateDigitalClock();
setInterval(updateDigitalClock, 1000);
function setupNavigationHandlers() {
const mainNavBar=document.getElementById('main-nav-bar');
if (mainNavBar) {
mainNavBar.addEventListener('click', (e)=> {
const button=e.target.closest('.bottom-nav-item');
if (button && button.dataset.page) {
const pageId=button.dataset.page;
navigateTo(pageId);
}
});
}
const _reportsSubnavItems=document.querySelectorAll('.reports-subnav-item');
_reportsSubnavItems.forEach(button=> {
button.addEventListener('click', (e)=> {
document.querySelectorAll('.reports-subnav-item').forEach(btn=> btn.classList.remove('active'));
e.currentTarget.classList.add('active');
const section=e.currentTarget.dataset.reportSection;
showReportContent(section);
if (section==='targets') { try { generateTargetsReport(); } catch(e){} }
});
});
updateIcons(); 
}
function generateAndShowDispatchNoteView(noteId) { } 
function openSettlementModal(noteId) { } 
function generateAndShowStatement(startDate, endDate, customerIds, title, customerNames, category='all') {
const statementModal=document.getElementById('statement-modal');
endDate.setHours(23, 59, 59, 999); 
const salesInRange=state.sales.filter(sale=> {
const saleDate=new Date(sale.date);
return saleDate >=startDate && saleDate <=endDate && customerIds.includes(sale.customerId);
});
let filteredSales=salesInRange;
if (category !=='all') {
filteredSales=salesInRange.filter(sale=> {
return sale.items.some(item=> {
const product=findProduct(item.productId);
return product && product.category===category;
});
});
}
filteredSales.sort((a, b)=> new Date(a.date) - new Date(b.date));
const salesBeforeStart=state.sales.filter(sale=> {
const saleDate=new Date(sale.date);
return saleDate < startDate && customerIds.includes(sale.customerId);
});
let openingBalance=0;
salesBeforeStart.forEach(sale=> {
openingBalance +=(sale.total - sale.paidAmount);
});
let html=`<div class="bg-white rounded-lg shadow-xl w-full max-w-6xl p-6 modal-body">
<div class="printable-statement-content">
<h2 class="text-2xl font-bold mb-2">${title}</h2>
<p class="text-sm text-gray-600 mb-2">الفترة من: ${startDate.toLocaleDateString('ar-EG')} إلى: ${endDate.toLocaleDateString('ar-EG')}</p>
<p class="text-sm text-gray-600 mb-4">العملاء: ${customerNames}</p>`;
if (filteredSales.length===0) {
html +='<p class="text-center text-gray-500 p-4">لا توجد فواتير في هذه الفترة.</p>';
} else {
html +='<div class="overflow-x-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200 text-sm">';
html +=`<thead class="bg-gray-100"><tr>
<th class="px-4 py-2 text-right font-semibold">التاريخ</th>
<th class="px-4 py-2 text-center font-semibold">رقم الفاتورة</th>
<th class="px-4 py-2 text-right font-semibold">العميل</th>
<th class="px-4 py-2 text-center font-semibold">مدين (Sales)</th>
<th class="px-4 py-2 text-center font-semibold">دائن (Payments)</th>
<th class="px-4 py-2 text-center font-semibold">الرصيد</th>
<th class="px-4 py-2 text-center font-semibold">الحالة</th>
</tr></thead>`;
html +='<tbody class="bg-white divide-y divide-gray-100">';
html +=`<tr class="bg-yellow-50 font-bold">
<td class="px-4 py-2 text-right">---</td>
<td class="px-4 py-2 text-center">---</td>
<td class="px-4 py-2 text-right">رصيد ما قبل الفترة</td>
<td class="px-4 py-2 text-center">---</td>
<td class="px-4 py-2 text-center">---</td>
<td class="px-4 py-2 text-center font-bold text-blue-700">${formatCurrency(openingBalance)}</td>
<td class="px-4 py-2 text-center">---</td>
</tr>`;
let runningBalance=openingBalance;
filteredSales.forEach(sale=> {
const customer=findCustomer(sale.customerId);
const debit=sale.total; 
const credit=sale.paidAmount; 
runningBalance +=(debit - credit);
html +=`<tr class="${sale.total < 0 ? 'bg-red-50' : ''}">
<td class="px-4 py-2 whitespace-nowrap">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
<td class="px-4 py-2 text-center">${sale.invoiceNumber}</td>
<td class="px-4 py-2 text-right">${customer ? customer.name : 'عميل محذوف'}</td>
<td class="px-4 py-2 text-center font-semibold text-green-700">${formatCurrency(debit)}</td>
<td class="px-4 py-2 text-center font-semibold text-red-600">${formatCurrency(credit)}</td>
<td class="px-4 py-2 text-center font-bold ${runningBalance < 0 ? 'text-red-600' : 'text-blue-700'}">${formatCurrency(runningBalance)}</td>
<td class="px-4 py-2 text-center">${getStatusBadge(sale.status)}</td>
</tr>`;
});
let totalDebit=0;
let totalCredit=0;
filteredSales.forEach(sale=> {
totalDebit +=sale.total;
totalCredit +=sale.paidAmount;
});
html +=`<tr class="bg-gray-200 font-bold border-t-2 border-gray-400">
<td class="px-4 py-2 text-right">---</td>
<td class="px-4 py-2 text-center">---</td>
<td class="px-4 py-2 text-right">الإجمالي</td>
<td class="px-4 py-2 text-center text-green-700">${formatCurrency(totalDebit)}</td>
<td class="px-4 py-2 text-center text-red-700">${formatCurrency(totalCredit)}</td>
<td class="px-4 py-2 text-center text-blue-900 text-lg">${formatCurrency(runningBalance)}</td>
<td class="px-4 py-2 text-center">---</td>
</tr>`;
html +='</tbody></table></div>';
html +=`<div class="mt-6 grid grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
<div class="text-center">
<p class="text-gray-600 text-sm">إجمالي المبيعات (مدين)</p>
<p class="text-2xl font-bold text-green-700">${formatCurrency(totalDebit)}</p>
</div>
<div class="text-center">
<p class="text-gray-600 text-sm">إجمالي المدفوعات (دائن)</p>
<p class="text-2xl font-bold text-red-700">${formatCurrency(totalCredit)}</p>
</div>
<div class="text-center">
<p class="text-gray-600 text-sm">الرصيد النهائي</p>
<p class="text-2xl font-bold ${runningBalance < 0 ? 'text-red-600' : 'text-blue-700'}">${formatCurrency(runningBalance)}</p>
</div>
</div>`;
}
html +=`</div>`; 
html +=`<div class="flex justify-between items-center pt-4 border-t mt-4 no-print">
<button onclick="closeModal(document.getElementById('statement-modal'))" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">إغلاق</button>
<button id="print-statement-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
<i data-lucide="printer" class="w-5 h-5"></i>
<span>طباعة</span>
</button>
</div>`;
html +='</div>';
statementModal.innerHTML=html;
const printBtn=statementModal.querySelector('#print-statement-btn');
if(printBtn) {
printBtn.addEventListener('click', ()=> {
const contentToPrint=statementModal.querySelector('.printable-statement-content').innerHTML;
const w=window.open('', '', 'height=600,width=1000');
if (!w) { alert('يرجى السماح بالنوافذ المنبثقة للطباعة'); return; }
w.document.open();
w.document.write('<html><head><title>كشف حساب</title>');
w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
w.document.write('<style>body { font-family: \'Cairo\', sans-serif; direction: rtl; } @media print { .no-print { display: none; } }</style>');
w.document.write('</head><body>');
w.document.write(contentToPrint);
w.document.write('</body></html>');
w.document.close();
const doPrint=()=> { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
const closeBack=()=> { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
if ('onafterprint' in w) { w.onafterprint=closeBack; } else { setTimeout(closeBack, 1200); }
if ('onload' in w) { w.onload=()=> setTimeout(doPrint, 100); } else { setTimeout(doPrint, 300); }
});
}
openModal(statementModal);
updateIcons();
}
function buildReceiptHtml58mm(sale){
try {
const customer=findCustomer(sale.customerId);
const company=(state.settings && state.settings.companyName) ? state.settings.companyName : 'اسم الشركة';
const logo=(state.settings && state.settings.companyLogo) ? state.settings.companyLogo : 'https://i.ibb.co/YT4114YW/image.jpg';
const registry=(state.settings && (state.settings.companyRegistry||state.settings.commercialRegistry)) || '134175';
const taxId=(state.settings && (state.settings.companyTaxId||state.settings.taxCard)) || '762878835';
const phone=(state.settings && state.settings.companyPhone) || '01011121457';
const email=(state.settings && state.settings.companyEmail) || 'delentemilks@gmail.com';
const repName=sale.repName || '';
const dateStr=formatArabicDate(sale.date);
const inv=sale.invoiceNumber || sale.id || '';
const rows=(sale.items||[]).map(it=> {
const p=findProduct(it.productId);
const name=p ? p.name : (it.name || 'منتج');
const qty=it.quantity || it.qty || 0;
const price=Number(it.price||0);
const total=qty * price * (1 - (it.discountPercent||0)/100);
return `<tr><td class="n">${escapeHtml(name)}</td><td class="q">${qty}</td><td class="t">${formatCurrency(total)}</td></tr>`;
}).join('');
const total=formatCurrency(sale.total||0);
const paid=formatCurrency(sale.paidAmount||0);
const remain=formatCurrency((sale.total||0) - (sale.paidAmount||0));
const custName=customer ? customer.name : 'عميل';
const custPhone=customer ? (customer.phone||'') : '';
const custTax=customer ? (customer.taxNumber||'') : '';
const nowStr=new Date().toLocaleString('ar-EG', { hour12: true });
return `<!doctype html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<title>طباعة فاتورة</title>
<style>
@page { size: 80mm auto; margin: 2mm; }
body { 
font-family: 'Cairo', sans-serif; 
direction: rtl; 
margin:0; 
padding:0; 
background:#fff;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
text-rendering: optimizeLegibility;
}
.r { 
width: 80mm; 
max-width: 80mm; 
position: relative; 
padding: 3mm; 
border: 2px solid #222; 
box-sizing: border-box;
font-family: 'Cairo', sans-serif;
}
.center { text-align:center }
.h1 { font-weight:800; font-size:16px; }
.h2 { font-weight:700; font-size:14px; }
.row { display:flex; justify-content:space-between; font-size:12px }
table { width:100%; border-collapse:collapse; font-size:12px }
th { background:#f3f4f6; border:1px solid #e5e7eb; padding:3px; font-weight:700; font-size:12px }
td { padding:3px; border:1px solid #f1f5f9; font-size:12px; text-align:center }
td.n{ text-align:right; font-weight:600 }
td.q{ width:20%; }
td.t{ width:28%; text-align:left }
hr { border:none; border-top:1px dashed #000; margin:8px 0 }
.sep { border-top:1px dashed #000; height:0; margin:8px 0 }
.bold { font-weight:700 }
.small { font-size:12px }
.hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px }
.hdr .brand { display:flex; align-items:center; gap:8px; }
.hdr img { width: 12mm; height:auto }
.tag { font-size:11px; font-weight:600; line-height:1; opacity:.9; margin-top:-2px; }
.wm { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none }
.wm img { width:60mm; opacity:.06; }
.footer { font-size:11px; line-height:1.5; text-align:right }
.kv { display:flex; gap:10px; justify-content:space-between; font-size:12px; }
.kv .label{ color:#111; font-weight:600 }
.kv .value{ color:#111; }
.money-row{ display:flex; justify-content:space-between; align-items:center; font-size:13px }
.money-row .amt{ text-align:left; min-width:38mm }
.cur{ font-size:11px; margin-right:2px }
</style>
</head><body>
<div class="r">
<div class="wm">${logo ? `<img src="${logo}" />` : ''}</div>
<div class="hdr">
<div class="brand"><div><div class="h1">Delente</div><div class="tag">it is just milk</div></div></div>
${logo ? `<img src="${logo}" alt="logo"/>` : ''}
</div>
<div class="center h2">فاتورة مبيعات</div>
<div class="center small">${nowStr}</div>
<hr />
<div class="kv"><div class="value">${inv}</div><div class="label">: رقم الفاتورة</div></div>
<div class="kv"><div class="value"><bdo dir="rtl">${dateStr}</bdo></div><div class="label">: التاريخ</div></div>
<div class="kv"><div class="value">${escapeHtml(custName)}</div><div class="label">: العميل</div></div>
${repName?`<div class="kv"><div class="value">${escapeHtml(repName)}</div><div class="label">: المندوب</div></div>`:''}
${custPhone?`<div class="kv"><div class="value">${escapeHtml(custPhone)}</div><div class="label">: هاتف</div></div>`:''}
${custTax?`<div class="kv"><div class="value">${escapeHtml(custTax)}</div><div class="label">: رقم ضريبي</div></div>`:''}
<hr />
<table><thead><tr><th>الصنف</th><th>الكمية</th><th>الإجمالي</th></tr></thead><tbody>${rows}</tbody></table>
<hr />
<div class="money-row bold"><span>الإجمالي</span><span class="amt">${total} <span class="cur">ج.م</span></span></div>
<div class="money-row"><span>المدفوع</span><span class="amt">${paid} <span class="cur">ج.م</span></span></div>
<div class="money-row"><span>المتبقي</span><span class="amt">${remain} <span class="cur">ج.م</span></span></div>
<hr />
<div class="footer">
<div>سجل تجاري: ${escapeHtml(String(registry))}</div>
<div>بطاقة ضريبية: ${escapeHtml(String(taxId))}</div>
<div>هاتف: ${escapeHtml(String(phone))}</div>
<div>E: ${escapeHtml(String(email))}</div>
</div>
<div class="center small" style="margin-top:4px">شكراً لتعاملكم معنا</div>
</div>
</body></html>`;
} catch(e){ return '<html><body>خطأ في تجهيز الفاتورة</body></html>'; }
}
function printInvoice(invoice) {
try {
const printWindow=window.open('', '_blank', 'width=400,height=600');
if (!printWindow) { alert('Please allow popups for printing'); return; }
const doc=printWindow.document;
doc.open();
doc.write('<!DOCTYPE html>');
doc.write('<html lang="ar" dir="rtl">');
doc.write('<head>');
doc.write('<meta charset="utf-8" />');
doc.write('<title>Invoice #' + (invoice.id || 'N/A') + '</title>');
doc.write('<style>');
doc.write('body { font-family: Tahoma, sans-serif; margin: 0; padding: 5px; width: 100%; max-width: 80mm; color: #000; direction: rtl; }');
doc.write('.header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 5px; }');
doc.write('.meta { text-align: center; font-size: 12px; margin-bottom: 10px; }');
doc.write('.divider { border-top: 1px dashed #000; margin: 5px 0; }');
doc.write('table { width: 100%; font-size: 12px; border-collapse: collapse; }');
doc.write('th { text-align: right; border-bottom: 1px solid #000; padding: 3px 0; font-weight: bold; }');
doc.write('td { text-align: right; padding: 2px 0; }');
doc.write('td.qty { text-align: center; }');
doc.write('td.total { text-align: left; }');
doc.write('.total-box { border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 18px; margin-top: 10px; }');
doc.write('.footer { text-align: center; margin-top: 15px; font-size: 10px; line-height: 1.6; }');
doc.write('.small-text { font-size: 10px; }');
doc.write('@media print { @page { margin: 0; size: auto; width: 80mm; } body { margin: 0; padding: 2px; } }');
doc.write('</style>');
doc.write('</head><body>');
doc.write('<div class="header">Invoice #' + (invoice.id || 'N/A') + '</div>');
doc.write('<div class="meta">');
doc.write('<div class="small-text">Date: ' + (invoice.date || 'Today') + '</div>');
doc.write('<div class="small-text">Customer: <strong>' + (invoice.customerName || 'Cash') + '</strong></div>');
doc.write('</div>');
doc.write('<div class="divider"></div>');
doc.write('<table>');
doc.write('<thead><tr><th style="width: 50%;">Item</th><th style="width: 20%;" class="qty">Qty</th><th style="width: 30%;" class="total">Total</th></tr></thead>');
doc.write('<tbody>');
if (Array.isArray(invoice.items)) {
invoice.items.forEach(function(item) {
const total=formatCurrency ? formatCurrency(item.total || 0) : (item.total || 0);
doc.write('<tr>');
doc.write('<td>' + (item.name || 'Product') + '</td>');
doc.write('<td class="qty">' + (item.quantity || item.qty || 0) + '</td>');
doc.write('<td class="total">' + total + '</td>');
doc.write('</tr>');
});
}
doc.write('</tbody></table>');
doc.write('<div class="divider"></div>');
const totalAmount=formatCurrency ? formatCurrency(invoice.total || 0) : (invoice.total || 0);
doc.write('<div class="total-box">TOTAL: ' + totalAmount + '</div>');
doc.write('<div class="footer">');
doc.write('<div>Thank you for your business</div>');
doc.write('<div class="small-text">Generated by Smart System</div>');
doc.write('</div>');
doc.write('</body></html>');
doc.close();
setTimeout(function() {
try { printWindow.focus(); } catch(_){}
try { printWindow.print(); } catch(_){}
}, 300);
} catch(e) {
console.warn('printInvoice error', e);
alert('Error opening print preview: ' + (e && e.message || 'Unknown error'));
}
}
window.printInvoice=printInvoice;
window.printSaleById=async function(saleId){
try {
const sale=(state.sales||[]).find(s=> String(s.id)===String(saleId));
if (!sale) { alert('تعذر العثور على الفاتورة'); return; }
await new Promise(resolve=> {
showPrintPreviewModal(sale, ()=> resolve());
});
const html=buildReceiptHtml58mm(sale);
const w=window.open('', '', 'width=420,height=640');
if (!w) { alert('يرجى السماح بالنوافذ المنبثقة للطباعة'); return; }
w.document.open();
w.document.write(html);
w.document.close();
const doPrint=()=> {
try { w.focus(); } catch(_){}
try { w.print(); } catch(_){}
};
const closeAndReturn=()=> {
try { w.close(); } catch(_){}
try { window.focus(); } catch(_){}
try { document.body.style.pointerEvents='auto'; document.body.style.opacity='1'; } catch(_){}
};
if ('onafterprint' in w) {
w.onafterprint=closeAndReturn;
} else {
setTimeout(closeAndReturn, 1200);
}
if ('onload' in w) {
w.onload=()=> setTimeout(doPrint, 100);
} else {
setTimeout(doPrint, 300);
}
} catch(e){ console.warn('printSaleById error', e); try { alert('تعذر بدء الطباعة'); } catch(_){} }
}
function showPrintPreviewModal(sale, callback) {
if (!document.getElementById('print-preview-modal')) {
const modal=document.createElement('div');
modal.id='print-preview-modal';
modal.style.position='fixed';
modal.style.inset='0';
modal.style.zIndex='50000';
modal.style.display='none';
modal.style.background='rgba(0,0,0,0.5)';
const content=document.createElement('div');
content.style.position='absolute';
content.style.top='50%';
content.style.left='50%';
content.style.transform='translate(-50%, -50%)';
content.style.background='#fff';
content.style.borderRadius='10px';
content.style.padding='20px';
content.style.maxHeight='90vh';
content.style.overflow='auto';
content.style.maxWidth='600px';
content.style.width='90%';
content.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';
content.innerHTML=`
<h2 style="text-align:center;margin-bottom:20px;font-size:20px;font-weight:bold;">معاينة قبل الطباعة</h2>
<div style="margin-bottom:20px;">
<label style="display:block;margin-bottom:8px;font-weight:bold;">حجم الورقة:</label>
<select id="paper-size-select" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
<option value="80mm" selected>80mm (حراري - افتراضي)</option>
<option value="58mm">58mm</option>
<option value="A4">A4 (21 سم)</option>
</select>
</div>
<div style="margin-bottom:20px;">
<label style="display:block;margin-bottom:8px;font-weight:bold;">اتجاه الورقة:</label>
<select id="paper-orientation-select" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
<option value="portrait">عمودي</option>
<option value="landscape">أفقي</option>
</select>
</div>
<div id="print-preview-container" style="border:2px solid #3b82f6;padding:15px;margin-bottom:20px;background:#f9f9f9;max-height:420px;overflow:auto;border-radius:6px;">
<!-- سيتم إدراج معاينة الفاتورة هنا -->
</div>
<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
<button id="print-confirm-btn" style="background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:15px;">طباعة الآن</button>
<button id="print-cancel-btn" style="background:#e5e7eb;color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:15px;">إلغاء</button>
</div>
`;
modal.appendChild(content);
document.body.appendChild(modal);
}
const modal=document.getElementById('print-preview-modal');
const previewContainer=document.getElementById('print-preview-container');
try {
const htmlDoc=(typeof buildReceiptHtml58mm==='function') ? buildReceiptHtml58mm(sale) : '';
const temp=document.createElement('div');
temp.innerHTML=htmlDoc;
const styleFromDoc=temp.querySelector('style');
if (styleFromDoc) {
const s=document.createElement('style');
s.textContent=styleFromDoc.textContent;
previewContainer.appendChild(s);
}
const r=temp.querySelector('.r');
if (r) {
r.style.margin='0 auto';
r.style.transformOrigin='top center';
r.style.transform='scale(0.75)';
previewContainer.appendChild(r);
} else {
previewContainer.innerHTML='<div style="text-align:center;color:#dc2626">تعذر إنشاء المعاينة</div>';
}
} catch(e){
previewContainer.innerHTML='<div style="text-align:center;color:#dc2626">خطأ في المعاينة</div>';
}
document.getElementById('print-confirm-btn').onclick=()=> {
modal.style.display='none';
if (callback) callback();
};
document.getElementById('print-cancel-btn').onclick=()=> {
modal.style.display='none';
};
modal.style.display='block';
}
window.shareSaleReceiptImage=async function(saleId){
try {
const sale=(state.sales||[]).find(s=> String(s.id)===String(saleId));
if (!sale) return alert('لم يتم العثور على الفاتورة');
const temp=document.createElement('div');
temp.style.position='fixed';
temp.style.left='-10000px';
temp.style.top='0';
temp.style.width='384px'; 
temp.style.background='#ffffff';
temp.style.padding='0';
temp.style.margin='0';
temp.innerHTML=buildReceiptHtml58mm(sale);
const root=temp.querySelector('.r');
if (root) {
root.style.width='384px';
root.style.maxWidth='384px';
}
document.body.appendChild(temp);
const target=root || temp;
const canvas=await html2canvas(target, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
const blob=await new Promise(res=> canvas.toBlob(res, 'image/png'));
const file=new File([blob], `invoice-${sale.invoiceNumber||sale.id}.png`, { type: 'image/png' });
if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
const confirmed=await (typeof customDialog==='function'
? customDialog({ title: 'الصورة جاهزة', message: 'اضغط "مشاركة الآن" لفتح قائمة المشاركة.', isConfirm: true, confirmText: 'مشاركة الآن', confirmClass: 'bg-indigo-600 hover:bg-indigo-700' })
: Promise.resolve(true));
if (confirmed) {
try {
await navigator.share({ files:[file] });
} catch(shareErr) {
console.warn('navigator.share failed, falling back', shareErr);
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url);
alert('تم حفظ صورة الفاتورة على جهازك.');
}
}
} else {
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url);
alert('تم حفظ صورة الفاتورة. افتحها في تطبيق الطابعة للطباعة.');
}
try { temp.remove(); } catch(_){}
} catch(e){ console.warn('shareSaleReceiptImage failed', e); alert('تعذر مشاركة الفاتورة'); }
}
window.uploadSaleToEta=async function(saleId){
try {
const sale=(state.sales||[]).find(s=> String(s.id)===String(saleId));
if (!sale) return alert('لم يتم العثور على الفاتورة');
if (sale.taxUploadStatus==='uploaded') {
if (!confirm('هذه الفاتورة مرفوعة بالفعل. إعادة الرفع؟')) return;
}
const invoice=transformSaleToEtaInvoice(sale);
const resp=await fetch('/.netlify/functions/eta-upload', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ invoice })
});
let data=null;
try { data=await resp.json(); } catch(_) { }
if (resp.ok && data && data.accepted) {
sale.taxUploadStatus='uploaded';
sale.taxSubmissionUUID=data.submissionUUID || null;
sale.etaStatus='submitted';
sale.etaLastCheckAt=new Date().toISOString();
sale.etaErrors=[];
try { saveState(); } catch(_){ }
renderAllSales();
try {
if (window.db) {
await db.collection('einvoice_logs').add({
invoice_number: sale.invoiceNumber || sale.invoice_number || null,
uuid: data.submissionUUID || data.submissionUUID || null,
status: 'Valid',
submission_date: new Date().toISOString(),
total: Number(sale.total || 0),
createdAt: serverTs()
});
}
} catch(logErr) { console.warn('Failed to write einvoice_logs:', logErr); }
alert('تم إرسال الفاتورة وقبولها أولياً (202). تم تسجيلها في سجل الفواتير الإلكترونية.');
} else {
const txt=(data && data.raw) ? JSON.stringify(data.raw) : await resp.text();
sale.taxUploadStatus='error';
sale.etaStatus='error';
sale.etaErrors=[txt.slice(0,300)];
sale.etaLastCheckAt=new Date().toISOString();
try { saveState(); } catch(_){ }
renderAllSales();
alert('فشل رفع الفاتورة: ' + txt);
}
} catch(e){ console.warn('uploadSaleToEta error', e); alert('تعذر رفع الفاتورة للمنظومة.'); }
}
function escapeHtml(str){
if (!str && str !==0) return '';
return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}
async function loadEinvoiceLogs(){
try {
if (!window.db) return;
const body=document.getElementById('einvoice-log-table-body');
if (!body) return;
body.innerHTML='';
const snap=await db.collection('einvoice_logs').orderBy('submission_date','desc').limit(200).get();
snap.forEach(doc=> {
const d=doc.data() || {};
const invoiceNo=escapeHtml(d.invoice_number || '');
const date=d.submission_date ? (new Date(d.submission_date)).toLocaleString() : '';
const customer=escapeHtml(d.customerName || '');
const total=Number(d.total || 0).toFixed(2);
const uuid=escapeHtml(d.uuid || '');
const status=escapeHtml(d.status || '');
const row=`<tr class="text-sm text-gray-700"><td class="p-2">${invoiceNo}</td><td class="p-2">${date}</td><td class="p-2">${customer}</td><td class="p-2 text-right">${total}</td><td class="p-2">${uuid}</td><td class="p-2">${status}</td></tr>`;
body.insertAdjacentHTML('beforeend', row);
});
} catch(e) { console.warn('loadEinvoiceLogs failed', e); }
}
document.addEventListener('DOMContentLoaded', function(){
try {
const rptBtn=document.getElementById('tax-tab-report');
const einBtn=document.getElementById('tax-tab-einvoices');
if (rptBtn && einBtn) {
rptBtn.addEventListener('click', function(){
document.getElementById('tax-report-tab').style.display='';
document.getElementById('tax-einvoices-tab').style.display='none';
rptBtn.classList.add('bg-gray-100'); einBtn.classList.remove('bg-gray-100');
});
einBtn.addEventListener('click', async function(){
document.getElementById('tax-report-tab').style.display='none';
document.getElementById('tax-einvoices-tab').style.display='';
rptBtn.classList.remove('bg-gray-100'); einBtn.classList.add('bg-gray-100');
await loadEinvoiceLogs();
});
}
} catch(e){ console.warn('tax tabs wiring failed', e); }
});
function openPromotionModal(id=null) {
promotionForm.reset();
document.getElementById('promotion-id').value='';
populateProductDropdown(document.getElementById('promotion-product'));
const customerSelect=document.getElementById('promotion-customer-id');
customerSelect.innerHTML='<option value="">-- جميع العملاء --</option>' + state.customers.map(c=> `<option value="${c.id}">${c.name}</option>`).join('');
document.getElementById('original-price-display').classList.add('hidden');
if (id) {
const promotion=state.promotions.find(p=> p.id===id);
if (promotion) {
document.getElementById('promotion-modal-title').textContent='تعديل العرض';
document.getElementById('promotion-id').value=promotion.id;
document.getElementById('promotion-name').value=promotion.name;
document.getElementById('promotion-product').value=promotion.productId;
document.getElementById('promotion-price').value=promotion.price;
customerSelect.value=promotion.customerId || '';
document.getElementById('promotion-start-date').value=promotion.startDate;
document.getElementById('promotion-end-date').value=promotion.endDate;
updatePromotionOriginalPriceDisplay(promotion.productId);
}
} else {
document.getElementById('promotion-modal-title').textContent='إضافة عرض جديد';
document.getElementById('promotion-start-date').value=new Date().toISOString().split('T')[0];
const nextMonth=new Date();
nextMonth.setMonth(nextMonth.getMonth() + 1);
document.getElementById('promotion-end-date').value=nextMonth.toISOString().split('T')[0];
}
openModal(promotionModal);
}
function copyTextToClipboard(text) {
if (!text) return;
if (navigator.clipboard && navigator.clipboard.writeText) {
navigator.clipboard.writeText(text).then(()=> {
customDialog({ title: 'نسخ', message: 'تم نسخ الكود إلى الحافظة.' });
}).catch(()=> {
const ta=document.createElement('textarea');
ta.value=text;
document.body.appendChild(ta);
ta.select();
try { document.execCommand('copy'); customDialog({ title: 'نسخ', message: 'تم نسخ الكود إلى الحافظة.' }); } catch (e) { customDialog({ title: 'خطأ', message: 'فشل نسخ الكود.' }); }
ta.remove();
});
} else {
const ta=document.createElement('textarea');
ta.value=text;
document.body.appendChild(ta);
ta.select();
try { document.execCommand('copy'); customDialog({ title: 'نسخ', message: 'تم نسخ الكود إلى الحافظة.' }); } catch (e) { customDialog({ title: 'خطأ', message: 'فشل نسخ الكود.' }); }
ta.remove();
}
}
function createBackup() {
try {
const backupTextarea=document.getElementById('backup-data-textarea');
const copyBtn=document.getElementById('copy-backup-btn');
const payload=JSON.stringify(state);
if (backupTextarea) backupTextarea.value=payload;
if (copyBtn) copyBtn.classList.remove('hidden');
try {
const backupsRaw=localStorage.getItem('mandoobiAppState_backups');
const backups=backupsRaw ? JSON.parse(backupsRaw) : [];
backups.unshift({ ts: new Date().toISOString(), data: state });
while (backups.length > 12) backups.pop();
localStorage.setItem('mandoobiAppState_backups', JSON.stringify(backups));
} catch (e) {
console.warn('Failed to save local backup list', e);
}
customDialog({ title: 'نسخة احتياطية', message: 'تم إنشاء النسخة الاحتياطية محلياً ويمكنك نسخ الكود أو تحميله يدوياً.' });
} catch (e) {
console.error('createBackup failed', e);
customDialog({ title: 'خطأ', message: 'فشل إنشاء النسخة الاحتياطية.' });
}
}
function showLocalStateDebug() {
if (document.getElementById('app-local-debug')) return; 
try {
const panel=document.createElement('div');
panel.id='app-local-debug';
panel.style.position='fixed';
panel.style.right='18px';
panel.style.bottom='18px';
panel.style.width='360px';
panel.style.maxHeight='60vh';
panel.style.overflow='auto';
panel.style.zIndex='99999';
panel.style.background='linear-gradient(180deg,#fff, #fbfaf8)';
panel.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)';
panel.style.borderRadius='8px';
panel.style.padding='12px';
panel.style.fontSize='13px';
panel.style.direction='rtl';
panel.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<strong style="font-size:14px">تشخيص واسترداد الحالة المحلية</strong>
<button id="close-local-debug" style="background:#eee;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">إغلاق</button>
</div>
<div style="font-size:12px;color:#444;margin-bottom:8px">ملاحظة: عند فتح الملف عبر <code>file://</code>، فإن الـlocalStorage مرتبط بمسار الملف؛ نقل الملف قد يجعل البيانات غير مرئية. إذا كانت لديك نسخة احتياطية، الصقها في الحقل أدناه ثم اضغط استرجاع.</div>
<div style="margin-bottom:8px">
<div id="local-state-keys" style="background:#fff;padding:8px;border:1px solid #eee;border-radius:6px;max-height:120px;overflow:auto"></div>
</div>
<div style="margin-bottom:8px">
<textarea id="local-state-restore" placeholder="الصق هنا JSON كامل للحالة (مثال: محتوى mandoobiAppState)" style="width:100%;height:120px;border:1px solid #ddd;padding:8px;border-radius:6px;font-size:12px"></textarea>
</div>
<div style="display:flex;gap:8px;justify-content:flex-start">
<button id="restore-state-btn" style="background:#1f7bd7;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">استرجاع الحالة</button>
<button id="download-backups-btn" style="background:#6b7280;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">تنزيل النسخ الاحتياطية</button>
<button id="open-storage-btn" style="background:#10b981;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">عرض في Console</button>
</div>
<div id="local-state-msg" style="margin-top:8px;font-size:12px;color:#444"></div>
`;
document.body.appendChild(panel);
const keysEl=document.getElementById('local-state-keys');
try {
const keys=Object.keys(localStorage).filter(k=> k.includes('mandoobiAppState') || k.includes('mandoobi'));
if (keys.length===0) {
keysEl.textContent='لا توجد مفاتيح محلية متعلقة بالتطبيق في localStorage لهذه الصفحة.';
} else {
keys.forEach(k=> {
const raw=localStorage.getItem(k);
let preview='';
try { const parsed=JSON.parse(raw); if (Array.isArray(parsed.sales)) { preview=`sales:${parsed.sales.length}`; } else if (parsed && parsed.sales) { preview=`sales:${(parsed.sales && parsed.sales.length) || '؟'}`; } else preview=raw ? raw.toString().slice(0,200) : 'empty'; } catch (e) { preview=raw ? raw.toString().slice(0,200) : 'empty'; }
const row=document.createElement('div');
row.style.padding='6px 0';
row.style.borderBottom='1px dashed #f0f0f0';
row.innerHTML=`<div style="font-weight:600;margin-bottom:4px">${k}</div><div style='font-size:12px;color:#666'>${preview}</div>`;
keysEl.appendChild(row);
});
}
} catch (e) { keysEl.textContent='فشل قراءة localStorage: ' + (e.message || e); }
document.getElementById('close-local-debug').addEventListener('click', ()=> panel.remove());
document.getElementById('open-storage-btn').addEventListener('click', ()=> {
console.log('LocalStorage keys for this origin:');
Object.keys(localStorage).forEach(k=> console.log(k, localStorage.getItem(k)));
const msg=document.getElementById('local-state-msg'); if (msg) msg.textContent='تم طباعة المحتوى في Console. افتح DevTools -> Console.';
});
document.getElementById('download-backups-btn').addEventListener('click', ()=> {
try {
const raw=localStorage.getItem('mandoobiAppState_backups');
if (!raw) { document.getElementById('local-state-msg').textContent='لا توجد نسخ احتياطية محفوظة.'; return; }
const a=document.createElement('a');
const blob=new Blob([raw], { type: 'application/json' });
a.href=URL.createObjectURL(blob);
a.download='mandoobiAppState_backups.json';
a.click();
document.getElementById('local-state-msg').textContent='تم تنزيل النسخ الاحتياطية.';
} catch (e) { document.getElementById('local-state-msg').textContent='فشل تنزيل النسخ الاحتياطية: ' + (e.message || e); }
});
document.getElementById('restore-state-btn').addEventListener('click', ()=> {
const ta=document.getElementById('local-state-restore');
const msg=document.getElementById('local-state-msg');
if (!ta || !ta.value.trim()) { if (msg) msg.textContent='الرجاء لصق JSON صالح في الحقل أعلاه.'; return; }
try {
const parsed=JSON.parse(ta.value);
localStorage.setItem('mandoobiAppState', JSON.stringify(parsed));
if (msg) msg.textContent='تم حفظ الحالة المحلية. سيتم إعادة تحميل الصفحة.';
setTimeout(()=> location.reload(), 800);
} catch (e) {
if (msg) msg.textContent='خطأ في قراءة JSON: ' + (e.message || e);
}
});
} catch (e) {
console.warn('showLocalStateDebug failed', e);
}
}
async function restoreBackup() {
try {
const raw=document.getElementById('restore-data-textarea')?.value || '';
if (!raw) {
await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء لصق كود النسخة الاحتياطية في الحقل المخصص.' });
return;
}
let parsed;
try { parsed=JSON.parse(raw); } catch (e) { parsed=null; }
if (!parsed) {
await customDialog({ title: 'خطأ', message: 'كود النسخة غير صالح. تأكد أنك قمت بلصق الكود كاملاً.' });
return;
}
const confirmed=await customDialog({ title: 'تأكيد الاستعادة', message: 'ستُستبدل جميع البيانات الحالية بالنسخة التي ألصقتها. هل تريد المتابعة؟', isConfirm: true, confirmText: 'نعم، استعد الآن', confirmClass: 'bg-red-600 hover:bg-red-700' });
if (!confirmed) return;
state=parsed;
saveState();
renderAll();
await customDialog({ title: 'استعادة', message: 'تم استعادة البيانات من النسخة الملصوقة.' });
} catch (e) {
console.error('restoreBackup failed', e);
await customDialog({ title: 'خطأ', message: 'فشل استعادة النسخة. تأكد من صحة الكود وحاول مرة أخرى.' });
}
}
document.addEventListener('DOMContentLoaded', ()=> {
try {
document.querySelectorAll('.modal').forEach(m=> {
try {
m.classList.remove('modal-visible');
m.classList.add('modal-hidden');
} catch (e) {}
});
const lm=document.getElementById('loading-modal');
if (lm) { lm.classList.remove('modal-visible'); lm.classList.add('modal-hidden'); }
const app=document.getElementById('app-container');
if (app) app.style.pointerEvents='auto';
try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed on DOMContentLoaded', e); }
try {
const refreshBtn=document.getElementById('unified-refresh-btn');
if (refreshBtn) refreshBtn.addEventListener('click', ()=> { try { renderUnifiedPriceGrid(); } catch(e){} });
const exportJsonBtn=document.getElementById('unified-export-json-btn');
if (exportJsonBtn) exportJsonBtn.addEventListener('click', async ()=> {
try {
const payload=JSON.stringify(state.products || [], null, 2);
const blob=new Blob([payload], { type: 'application/json' });
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download='products-prices.json'; a.click(); URL.revokeObjectURL(url);
} catch (e) { console.warn('export unified json failed', e); }
});
const exportCsvBtn=document.getElementById('unified-export-csv-btn');
if (exportCsvBtn) exportCsvBtn.addEventListener('click', ()=> {
try {
const category=document.getElementById('unified-category-filter')?.value || 'all';
const products=Array.isArray(state.products) ? state.products.slice() : [];
const rows=products.filter(p=> {
if (category==='all') return true;
if (category==='raw') return String(p.category||'').toLowerCase().includes('raw');
if (category==='packaging') return String(p.category||'').toLowerCase().includes('packag');
if (category==='finished') return !(String(p.category||'').toLowerCase().includes('raw') || String(p.category||'').toLowerCase().includes('packag'));
if (category==='operation') return (p.operationCost !==undefined);
return true;
}).map(p=> ({ id: p.id||'', name: p.name||'', category: p.category||'', price: p.price||'', cost: p.cost||'', operationCost: p.operationCost||'' }));
const headers=['id','name','category','price','cost','operationCost'];
const csv=[headers.join(',')].concat(rows.map(r=> headers.map(h=> '"' + String(r[h]||'').replace(/"/g,'""') + '"').join(','))).join('\n');
const blob=new Blob([csv], { type: 'text/csv' });
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download='products-prices.csv'; a.click(); URL.revokeObjectURL(url);
} catch (e) { console.warn('export unified csv failed', e); }
});
} catch (e) { console.warn('unified grid controls bind failed', e); }
setTimeout(()=> {
try { if (document.getElementById('page-debts')?.classList.contains('active')) renderDebts(); } catch (e) {}
}, 80);
} catch (e) { console.warn('Startup cleanup failed', e); }
});
function showLoading(message="جارٍ التحميل...") {
document.getElementById('loading-message').textContent=message;
openModal(loadingModal);
}
function hideLoading() {
closeModal(loadingModal);
}
let eventListenersAttached=false;
function setupAllEventListeners() {
if (eventListenersAttached) return;
console.log("🔗 Attaching all event listeners...");
eventListenersAttached = true;
try {
setupNavigationHandlers();
document.getElementById('dashboard-rep-filter').addEventListener('change', renderDashboard);
const salesMonthSelector=document.getElementById('sales-month-selector');
function updateMonthDisplay(){
if(!state.activePeriod) return;
}
if(salesMonthSelector){
const now=new Date();
const currentMonth=now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
salesMonthSelector.value=currentMonth;
salesMonthSelector.addEventListener('change', ()=> {
if(!state) state={};
state.activePeriod=salesMonthSelector.value ? salesMonthSelector.value : null;
salesSearchHandler();
});
}
const searchSalesDateInput=document.getElementById('search-sales-date');
const clearSalesDateBtn=document.getElementById('clear-sales-date-btn');
const salesSearchHandler=()=> {
const textFilter=document.getElementById('search-sales-text').value;
const dateFilter=searchSalesDateInput.value;
const taxStatusFilter=document.getElementById('tax-status-filter').value;
const reviewFilter=document.getElementById('review-status-filter')?.value || 'all';
clearSalesDateBtn.classList.toggle('hidden', !dateFilter);
renderAllSales(textFilter, dateFilter, taxStatusFilter, reviewFilter);
};
document.getElementById('search-sales-text').addEventListener('input', salesSearchHandler);
searchSalesDateInput.addEventListener('input', salesSearchHandler);
document.getElementById('tax-status-filter').addEventListener('change', salesSearchHandler);
document.getElementById('review-status-filter').addEventListener('change', salesSearchHandler);
clearSalesDateBtn.addEventListener('click', ()=> {
searchSalesDateInput.value='';
salesSearchHandler();
});
document.getElementById('apply-filters-btn').addEventListener('click', ()=> renderTotalBills());
const resetToCurrentMonthBtn=document.getElementById('reset-to-current-month-btn');
if (resetToCurrentMonthBtn) {
resetToCurrentMonthBtn.addEventListener('click', ()=> {
setCurrentMonthDates();
renderTotalBills();
});
}
const applyDebtsBtn=document.getElementById('apply-debts-filters-btn');
if (applyDebtsBtn) applyDebtsBtn.addEventListener('click', ()=> renderDebts());
const hidePaidCheckbox=document.getElementById('hide-paid-debts');
if (hidePaidCheckbox) {
hidePaidCheckbox.addEventListener('change', ()=> {
localStorage.setItem('debts_hidePaid', hidePaidCheckbox.checked);
renderDebts();
});
const savedState=localStorage.getItem('debts_hidePaid');
if (savedState !==null) {
hidePaidCheckbox.checked=savedState==='true';
}
}
let currentSort={ key: 'date', direction: 'desc' };
document.getElementById('total-bills-table-body').addEventListener('click', (e)=> {
const cell=e.target.closest('.invoice-cell');
if (cell) {
const saleId=cell.dataset.id;
if (saleId) {
toggleReviewColor(saleId, cell);
}
}
});
document.getElementById('total-bills-table').querySelector('thead').addEventListener('click', (e)=> {
const header=e.target.closest('th[data-sort]');
if (!header) return;
const sortKey=header.dataset.sort;
if (currentSort.key===sortKey) {
currentSort.direction=currentSort.direction==='asc' ? 'desc' : 'asc';
} else {
currentSort.key=sortKey;
currentSort.direction='desc';
}
renderTotalBills(currentSort.key, currentSort.direction);
});
const selectAllCheckbox=document.getElementById('select-all-total-bills');
if (selectAllCheckbox) {
selectAllCheckbox.addEventListener('change', (e)=> {
const isChecked=e.target.checked;
document.querySelectorAll('#total-bills-table-body input.total-bill-row-checkbox').forEach(checkbox=> {
checkbox.checked=isChecked;
});
});
}
const stockControlDateEl=document.getElementById('stock-control-date');
if (stockControlDateEl) stockControlDateEl.addEventListener('change', renderStockLedger);
const saveStockControlBtnEl=document.getElementById('save-stock-control-btn');
if (saveStockControlBtnEl) saveStockControlBtnEl.addEventListener('click', saveStockBalances);
const finishedProductsDateEl=document.getElementById('finished-products-date');
if (finishedProductsDateEl) {
finishedProductsDateEl.addEventListener('change', ()=> {
try { if (typeof window.installStockEntriesListenerForDate==='function') window.installStockEntriesListenerForDate(finishedProductsDateEl.value); } catch(_){}
renderStockLedgerForFinishedProducts();
});
try { if (typeof window.installStockEntriesListenerForDate==='function') window.installStockEntriesListenerForDate(finishedProductsDateEl.value); } catch(_){}
renderStockLedgerForFinishedProducts();
}
const saveFinishedProductsBtn=document.getElementById('save-finished-products-btn');
if (saveFinishedProductsBtn) {
saveFinishedProductsBtn.addEventListener('click', saveStockBalancesForFinishedProducts);
}
saleForm.addEventListener('submit', saveSale);
document.getElementById('cancel-sale-btn').addEventListener('click', ()=> closeModal(saleModal));
document.getElementById('add-sale-item-btn').addEventListener('click', ()=> addSaleItemRow());
document.getElementById('sale-status').addEventListener('change', updateSaleSummary);
document.getElementById('sale-discount').addEventListener('input', updateSaleSummary);
document.getElementById('search-customers').addEventListener('input', (e)=> renderCustomers(e.target.value));
if (typeof initializeChainsDisplay === 'function') {
  initializeChainsDisplay();
}
document.getElementById('search-products').addEventListener('input', (e)=> renderSettings(e.target.value));
document.getElementById('spreadsheet-save-all-btn').addEventListener('click', saveAllSpreadsheetEntries);
document.getElementById('spreadsheet-add-row-btn').addEventListener('click', addSpreadsheetRow);
async function getNextInvoiceNumber(repId){
try {
if (!repId) return null;
if (window.db && typeof db !=='undefined') {
try {
const q=await db.collection('invoices')
.where('repId', '==', String(repId))
.orderBy('invoiceNumber', 'desc')
.limit(1)
.get();
if (!q.empty) {
const d=q.docs[0].data();
const inv=Number(d && d.invoiceNumber) || 0;
if (inv > 0) return inv + 1;
}
} catch (e) {
console.warn('getNextInvoiceNumber: firestore query failed', e);
}
} else {
console.warn('getNextInvoiceNumber: no db available');
}
} catch (e) { console.warn('getNextInvoiceNumber failed', e); }
return 1;
}
unifiedInvoiceNumberInput.addEventListener('input', (e)=> {
const unifiedNumber=e.target.value.trim();
spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row=> {
const invoiceInput=row.querySelector('.spreadsheet-invoice-number');
if (invoiceInput) invoiceInput.value=unifiedNumber;
});
});
try {
if (spreadsheetRepSelect) {
spreadsheetRepSelect.addEventListener('change', async (ev)=> {
try {
const repNameOrId=ev.target.value;
if (!repNameOrId) { unifiedInvoiceNumberInput.value=''; return; }
const rep=(state.reps||[]).find(r=> r.id===repNameOrId || r.name===repNameOrId);
if (!rep || !rep.id) {
unifiedInvoiceNumberInput.value='';
return;
}
if (rep.nextInvoiceNumber !=null && rep.nextInvoiceNumber !=='') {
unifiedInvoiceNumberInput.value=String(rep.nextInvoiceNumber);
let offset=0;
spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row=> {
const invoiceInput=row.querySelector('.spreadsheet-invoice-number');
if (invoiceInput && !invoiceInput.value) {
invoiceInput.value=String(Number(rep.nextInvoiceNumber) + offset);
offset++;
}
});
return;
}
const next=await getNextInvoiceNumber(rep.id);
if (next !=null) {
unifiedInvoiceNumberInput.value=String(next);
let offset=0;
spreadsheetEntryBody.querySelectorAll('.spreadsheet-row').forEach(row=> {
const invoiceInput=row.querySelector('.spreadsheet-invoice-number');
if (invoiceInput && !invoiceInput.value) {
invoiceInput.value=String(next + offset);
offset++;
}
});
}
} catch(e){ console.warn('spreadsheet rep change handler failed', e); }
});
(async function(){
try {
const cur=spreadsheetRepSelect.value;
if (cur) {
const rep=(state.reps||[]).find(r=> r.id===cur || r.name===cur);
if (rep && rep.id) {
if (rep.nextInvoiceNumber !=null && rep.nextInvoiceNumber !=='') {
unifiedInvoiceNumberInput.value=String(rep.nextInvoiceNumber);
} else {
const n=await getNextInvoiceNumber(rep.id);
if (n !=null) unifiedInvoiceNumberInput.value=String(n);
}
}
}
} catch(_){ }
})();
}
} catch(e){ console.warn('bind spreadsheetRepSelect failed', e); }
const addProductBtn=document.getElementById('add-product-btn');
if (addProductBtn) addProductBtn.addEventListener('click', ()=> openProductModal());
const addPriceListBtn=document.getElementById('add-price-list-btn');
if (addPriceListBtn) addPriceListBtn.addEventListener('click', ()=> openPriceListModal());
if (productForm) productForm.addEventListener('submit', saveProduct);
const cancelProductBtn=document.getElementById('cancel-product-btn');
if (cancelProductBtn) cancelProductBtn.addEventListener('click', ()=> closeModal(productModal));
if (priceListForm) priceListForm.addEventListener('submit', savePriceList);
const cancelPriceListBtn=document.getElementById('cancel-price-list-btn');
if (cancelPriceListBtn) cancelPriceListBtn.addEventListener('click', ()=> closeModal(priceListModal));
const addFinishedProductBtn=document.getElementById('add-finished-product-btn');
if (addFinishedProductBtn) {
addFinishedProductBtn.addEventListener('click', ()=> {
document.getElementById('modal-add-finished-product').classList.remove('hidden');
});
}
const addRawMaterialBtn=document.getElementById('add-raw-material-btn');
if (addRawMaterialBtn) {
addRawMaterialBtn.addEventListener('click', ()=> {
document.getElementById('modal-add-raw-material').classList.remove('hidden');
});
}
const addPackagingBtn=document.getElementById('add-packaging-item-btn');
if (addPackagingBtn) {
addPackagingBtn.addEventListener('click', ()=> {
document.getElementById('modal-add-packaging').classList.remove('hidden');
});
}
const formAddFinishedProduct=document.getElementById('form-add-finished-product');
if (formAddFinishedProduct) {
formAddFinishedProduct.addEventListener('submit', saveFinishedProductFromStock);
}
const formAddRawMaterial=document.getElementById('form-add-raw-material');
if (formAddRawMaterial) {
formAddRawMaterial.addEventListener('submit', saveRawMaterialFromStock);
}
const formAddPackaging=document.getElementById('form-add-packaging');
if (formAddPackaging) {
formAddPackaging.addEventListener('submit', savePackagingFromStock);
}
document.addEventListener('click', (e)=> {
if (e.target.closest('#add-finished-product-btn')) {
console.log('Clicked add finished product btn');
document.getElementById('modal-add-finished-product').classList.remove('hidden');
}
if (e.target.closest('#add-raw-material-btn')) {
console.log('Clicked add raw material btn');
document.getElementById('modal-add-raw-material').classList.remove('hidden');
}
if (e.target.closest('#add-packaging-item-btn')) {
console.log('Clicked add packaging btn');
document.getElementById('modal-add-packaging').classList.remove('hidden');
}
});
document.addEventListener('click', async (e)=> {
const editProd=e.target.closest('.edit-product-btn');
if (editProd) {
const id=editProd.dataset.id;
if (id) openProductModal(id);
return;
}
const delProd=e.target.closest('.delete-product-btn');
if (delProd) {
const id=delProd.dataset.id;
if (!id) return;
const confirmed=await customDialog({ isConfirm: true, message: 'هل متأكد أنك تريد حذف هذا المنتج؟', title: 'تأكيد الحذف', confirmText: 'حذف', confirmClass: 'bg-red-600 hover:bg-red-700' });
if (confirmed) {
try {
await deleteProduct(id);
await customDialog({ title: 'تم', message: 'تم حذف المنتج نهائياً.' });
} catch (err) {
console.warn('deleteProduct failed', err);
await customDialog({ title: 'خطأ', message: 'تعذر حذف المنتج من السحابة.' });
}
}
return;
}
const editPl=e.target.closest('.edit-price-list-btn');
if (editPl) {
const id=editPl.dataset.id;
if (id) openPriceListModal(id);
return;
}
const delPl=e.target.closest('.delete-price-list-btn');
if (delPl) {
const id=delPl.dataset.id;
if (!id) return;
const confirmed=await customDialog({ isConfirm: true, message: 'هل متأكد أنك تريد حذف هذه القائمة؟', title: 'تأكيد الحذف', confirmText: 'حذف', confirmClass: 'bg-red-600 hover:bg-red-700' });
if (confirmed) {
try {
await deletePriceListDoc(id);
await customDialog({ title: 'تم', message: 'تم حذف القائمة نهائياً.' });
} catch (err) {
console.warn('deletePriceList failed', err);
await customDialog({ title: 'خطأ', message: 'تعذر حذف قائمة الأسعار من السحابة.' });
}
}
return;
}
});
const addCustomerBtn=document.getElementById('add-customer-btn');
if (addCustomerBtn) {
addCustomerBtn.addEventListener('click', ()=> {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='rep') { customDialog({ title: 'صلاحيات', message: 'المندوب لا يملك صلاحية إضافة عميل.' }); return; }
openCustomerModal();
});
try { if ((typeof getUserRole==='function') && getUserRole()==='rep') addCustomerBtn.style.display='none'; } catch(_){}
}
document.getElementById('cancel-customer-btn').addEventListener('click', ()=> closeModal(customerModal));
customerForm.addEventListener('submit', async (e)=> {
e.preventDefault();
const id=document.getElementById('customer-id').value;
const payload={
name: document.getElementById('customer-name').value.trim(),
taxNumber: document.getElementById('customer-tax-number').value.trim(),
phone: document.getElementById('customer-phone').value.trim(),
address: document.getElementById('customer-address').value.trim(),
requiresTaxFiling: document.getElementById('customer-requires-tax').checked,
priceListId: document.getElementById('customer-price-list').value || '',
repName: document.getElementById('customer-rep').value || '',
assignedRepId: (function(){
const repField=document.getElementById('customer-rep').value || '';
if (!repField) return '';
try { const repObj=window.findRep ? window.findRep(repField) : null; return repObj ? repObj.id : ''; } catch(e){ return ''; }
})()
};
if (!payload.name) {
await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء إدخال اسم العميل.' });
return;
}
const isDuplicate=Array.isArray(state.customers)
? state.customers.some(c=> (c.name||'').trim()===payload.name && (c.id||c._id) !==id)
: false;
if (isDuplicate) {
await customDialog({ title: 'اسم مكرر', message: 'يوجد عميل آخر بنفس الاسم. الرجاء استخدام اسم مختلف.' });
return;
}
try {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='rep') { await customDialog({ title:'صلاحيات', message:'المندوب لا يملك صلاحية إضافة/تعديل العملاء.' }); return; }
if (id) {
await updateCustomer(id, payload);
} else {
await addCustomer(payload);
}
closeModal(customerModal);
await customDialog({ message: 'تم حفظ بيانات العميل بنجاح.', title: 'نجاح' });
} catch (err) {
const msg=(err && err.code==='permission-denied') ? 'ليست لديك صلاحية تعديل العملاء' : 'فشل حفظ بيانات العميل';
await customDialog({ title: 'خطأ', message: msg });
}
});
document.getElementById('customers-list').addEventListener('click', async (e)=> {
const editBtn=e.target.closest('.edit-customer-btn');
const deleteBtn=e.target.closest('.delete-customer-btn');
const claimBtn=e.target.closest('.claim-customer-btn');
if (claimBtn) {
try {
const customerId=claimBtn.getAttribute('data-id');
const current=AuthSystem.getCurrentUser();
if (!current) { await customDialog({ title:'غير مسجل', message:'سجل الدخول أولاً.' }); return; }
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role !=='rep') { await customDialog({ title:'ممنوع', message:'هذه الميزة للمندوبين فقط.' }); return; }
const customer=(state.customers||[]).find(c=> (c.id||c._id)===customerId);
if (!customer) return;
if (customer.assignedRepId) { await customDialog({ title:'تم التعيين', message:'هذا العميل أصبح مخصصاً بالفعل.' }); return; }
const repNameGuess=current.name || (current.email ? current.email.split('@')[0] : 'مندوب');
await updateCustomer(customerId, { assignedRepId: current.id, repName: customer.repName || repNameGuess });
await customDialog({ title:'تم', message:'تم تعيين العميل لك.' });
try { renderCustomerList(document.getElementById('search-customers')?.value || ''); } catch(e){}
} catch(err){ console.warn('claim customer failed', err); }
return; 
}
if (editBtn) {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='rep') { await customDialog({ title:'صلاحيات', message:'المندوب لا يملك صلاحية تعديل العملاء.' }); return; }
const customerId=editBtn.dataset.id;
const customer=(state.customers||[]).find(c=> (c.id||c._id)===customerId);
if (!canManageCustomer(customer)) {
await customDialog({ title:'صلاحيات', message:'لا يمكنك تعديل هذا العميل لأنه ليس مخصصاً لك.' });
return;
}
openCustomerModal(customerId);
}
if (deleteBtn) {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='rep') { await customDialog({ title:'صلاحيات', message:'المندوب لا يملك صلاحية حذف العملاء.' }); return; }
const customerId=deleteBtn.dataset.id;
const customer=Array.isArray(state.customers)
? state.customers.find(c=> (c.id||c._id)===customerId)
: null;
if (!customer) return;
if (!canManageCustomer(customer)) {
await customDialog({ title:'صلاحيات', message:'لا يمكنك حذف هذا العميل لأنه ليس مخصصاً لك.' });
return;
}
const customerHasSales=Array.isArray(state.sales)
? state.sales.some(s=> s.customerId===customerId)
: false;
if (customerHasSales) {
await customDialog({
title: 'لا يمكن الحذف',
message: `لا يمكن حذف العميل "${customer.name}" لأن لديه فواتير مسجلة.`
});
return;
}
const confirmed=await customDialog({
title: 'تأكيد الحذف',
message: `هل أنت متأكد أنك تريد حذف العميل "${customer.name}"؟`,
isConfirm: true,
confirmText: 'نعم، احذف',
confirmClass: 'bg-red-600 hover:bg-red-700'
});
if (confirmed) {
try {
await deleteCustomer(customerId);
await customDialog({ message: 'تم حذف العميل بنجاح.' });
} catch (err) {
const msg=(err && err.code==='permission-denied') ? 'ليست لديك صلاحية حذف العملاء' : 'فشل حذف العميل';
await customDialog({ title: 'خطأ', message: msg });
}
}
}
});
document.getElementById('add-rep-btn').addEventListener('click', ()=> openRepModal());
document.getElementById('cancel-rep-btn').addEventListener('click', ()=> closeModal(repModal));
repForm.addEventListener('submit', async (e)=> {
e.preventDefault();
const id=document.getElementById('rep-id').value;
const name=document.getElementById('rep-name').value.trim();
const serial=document.getElementById('rep-serial').value.trim();
const target=parseFloat(document.getElementById('rep-target').value) || 0;
const nextInvoiceNumber=parseInt(document.getElementById('rep-next-invoice').value) || null;
if (!name) {
await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء إدخال اسم المندوب.' });
return;
}
const isDuplicate=(state.reps||[]).some(r=> r.name===name && r.id !==id);
if (isDuplicate) {
await customDialog({ title: 'اسم مكرر', message: 'يوجد مندوب آخر بنفس الاسم. الرجاء استخدام اسم مختلف.' });
return;
}
try {
if (id) {
await updateRepDoc(id, { name, serial, target, nextInvoiceNumber });
} else {
await addRepDoc(undefined, { name, serial, target, nextInvoiceNumber });
}
closeModal(repModal);
await customDialog({ message: 'تم حفظ بيانات المندوب في السحابة.', title: 'نجاح' });
} catch (err) {
console.warn('saveRep cloud failed', err);
await customDialog({ title: 'خطأ', message: 'تعذر حفظ بيانات المندوب. تحقق من الاتصال والصلاحيات.' });
}
});
document.getElementById('reps-list').addEventListener('click', async (e)=> {
const editBtn=e.target.closest('.edit-rep-btn');
const deleteBtn=e.target.closest('.delete-rep-btn');
if (editBtn) {
const repId=editBtn.dataset.id;
openRepModal(repId);
}
if (deleteBtn) {
const repId=deleteBtn.dataset.id;
const rep=(state.reps||[]).find(r=> r.id===repId);
if (!rep) return;
const repHasSales=(state.sales||[]).some(s=> s.repName===rep.name);
if (repHasSales) {
await customDialog({
title: 'لا يمكن الحذف',
message: `لا يمكن حذف المندوب "${rep.name}" لأن لديه فواتير مسجلة. يمكنك تعديل بياناته بدلاً من ذلك.`
});
return;
}
const confirmed=await customDialog({
title: 'تأكيد الحذف',
message: `هل أنت متأكد أنك تريد حذف المندوب "${rep.name}"؟`,
isConfirm: true,
confirmText: 'نعم، احذف',
confirmClass: 'bg-red-600 hover:bg-red-700'
});
if (confirmed) {
try {
await deleteRepDoc(repId);
await customDialog({ message: 'تم حذف المندوب نهائياً.' });
} catch (err) {
console.warn('deleteRep failed', err);
await customDialog({ title: 'خطأ', message: 'تعذر حذف المندوب من السحابة.' });
}
}
}
});
document.getElementById('cancel-customer-btn').addEventListener('click', ()=> closeModal(customerModal));
document.getElementById('add-promotion-btn').addEventListener('click', ()=> openPromotionModal());
document.getElementById('cancel-promotion-btn').addEventListener('click', ()=> closeModal(promotionModal));
const bpAdd=document.getElementById('batch-promo-add-row');
const bpSave=document.getElementById('batch-promo-save');
if (bpAdd) bpAdd.addEventListener('click', ()=> addBatchPromoRow());
if (bpSave) bpSave.addEventListener('click', saveBatchPromotions);
promotionForm.addEventListener('submit', async (e)=> {
e.preventDefault();
const id=document.getElementById('promotion-id').value;
const promotionData={
id: id || Date.now().toString(),
updatedAt: new Date().toISOString(),
name: document.getElementById('promotion-name').value,
productId: document.getElementById('promotion-product').value,
price: parseFloat(document.getElementById('promotion-price').value),
customerId: document.getElementById('promotion-customer-id').value || null,
startDate: document.getElementById('promotion-start-date').value,
endDate: document.getElementById('promotion-end-date').value,
};
if (!promotionData.name || !promotionData.productId || isNaN(promotionData.price) || !promotionData.startDate || !promotionData.endDate) {
await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء ملء جميع الحقول المطلوبة (الاسم، المنتج، السعر، التواريخ).' });
return;
}
try {
if (window.db) {
if (id) {
await db.collection('promotions').doc(id).set({
name: promotionData.name,
productId: promotionData.productId,
price: Number(promotionData.price||0),
customerId: promotionData.customerId || null,
startDate: promotionData.startDate,
endDate: promotionData.endDate,
updatedAt: new Date().toISOString()
}, { merge: true });
} else {
const ref=db.collection('promotions').doc();
promotionData.id=ref.id;
await ref.set({
id: promotionData.id,
name: promotionData.name,
productId: promotionData.productId,
price: Number(promotionData.price||0),
customerId: promotionData.customerId || null,
startDate: promotionData.startDate,
endDate: promotionData.endDate,
createdAt: new Date().toISOString(),
updatedAt: new Date().toISOString()
}, { merge: false });
}
} else {
if (id) {
const index=state.promotions.findIndex(p=> p.id===id);
if (index >=0) state.promotions[index]=promotionData; else state.promotions.push(promotionData);
} else {
state.promotions.push(promotionData);
}
}
} catch (err) {
console.warn('حفظ العرض في Firestore فشل، سيتم الحفظ محلياً فقط', err);
if (id) {
const index=state.promotions.findIndex(p=> p.id===id);
if (index >=0) state.promotions[index]=promotionData; else state.promotions.push(promotionData);
} else {
state.promotions.push(promotionData);
}
}
closeModal(promotionModal);
renderAll();
await customDialog({ message: 'تم حفظ العرض بنجاح.', title: 'نجاح' });
});
document.getElementById('promotion-product').addEventListener('change', (e)=> {
updatePromotionOriginalPriceDisplay(e.target.value);
});
document.getElementById('promotions-list').addEventListener('click', async (e)=> {
const editBtn=e.target.closest('.edit-promotion-btn');
const deleteBtn=e.target.closest('.delete-promotion-btn');
if (editBtn) {
const promoId=editBtn.dataset.id;
openPromotionModal(promoId);
}
if (deleteBtn) {
const promoId=deleteBtn.dataset.id;
const confirmed=await customDialog({
title: 'تأكيد الحذف',
message: 'هل أنت متأكد أنك تريد حذف هذا العرض؟',
isConfirm: true,
confirmText: 'نعم، احذف',
confirmClass: 'bg-red-600 hover:bg-red-700'
});
if (confirmed) {
try {
if (window.db) {
await db.collection('promotions').doc(promoId).delete();
}
} catch (err) {
console.warn('فشل حذف العرض من Firestore، سيُحذف محلياً فقط', err);
}
state.promotions=state.promotions.filter(p=> p.id !==promoId);
renderAll();
await customDialog({ message: 'تم حذف العرض بنجاح.' });
}
}
});
document.getElementById('sales-list').addEventListener('click', salesListClickHandler);
const saveTargetBtn=document.getElementById('save-target-btn');
if (saveTargetBtn) saveTargetBtn.addEventListener('click', saveSalesTarget);
document.getElementById('backup-data-btn').addEventListener('click', createBackup);
document.getElementById('copy-backup-btn').addEventListener('click', ()=> copyTextToClipboard(document.getElementById('backup-data-textarea').value));
document.getElementById('restore-data-btn').addEventListener('click', restoreBackup);
function showHideAdminImportTool(){
try {
const sec=document.getElementById('admin-cloud-import-section');
if (!sec) return;
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='admin') sec.classList.remove('hidden'); else sec.classList.add('hidden');
} catch(e) { }
}
async function handleAdminStartImport(){
const statusEl=document.getElementById('admin-import-status');
const btn=document.getElementById('admin-start-import-btn');
const fileInput=document.getElementById('admin-import-file');
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role !=='admin') { alert('هذه الأداة متاحة للمشرف فقط'); return; }
if (!window.db) { alert('Firestore غير جاهز. تأكد من تسجيل الدخول.'); return; }
if (!fileInput || !fileInput.files || fileInput.files.length===0) { alert('من فضلك اختر ملف النسخة أولاً'); return; }
const file=fileInput.files[0];
btn.disabled=true;
if (statusEl) statusEl.textContent='جاري قراءة الملف وتحليله...';
try {
const text=await new Promise((resolve, reject)=> { const rdr=new FileReader(); rdr.onload=()=> resolve(rdr.result); rdr.onerror=reject; rdr.readAsText(file, 'utf-8'); });
const backup=(typeof parseBackupText==='function') ? parseBackupText(text) : JSON.parse(text);
if (!backup || typeof backup !=='object') { throw new Error('صيغة الملف غير صالحة'); }
if (statusEl) statusEl.textContent='جاري الاستيراد إلى Firestore (قد يستغرق دقائق للملفات الكبيرة)...';
const options={
importCustomers: true,
importProducts: true,
importPriceLists: true,
importSales: true,
importReps: true,
importPromotions: true,
importSettings: true,
importDispatchNotes: !!backup.dispatchNotes,
importStockEntries: !!backup.stockEntries,
importNotifications: !!backup.notifications
};
const res=await importBackupObject(backup, options);
if (!res || res.ok !==true) {
throw new Error('فشل الاستيراد: ' + (res && res.error ? (res.error.message || String(res.error)) : 'خطأ غير معروف'));
}
if (statusEl) {
const c=res.counts || {};
statusEl.textContent=`تم الاستيراد بنجاح ✅ — عملاء: ${c.customers||0}, منتجات: ${c.products||0}, قوائم أسعار: ${c.priceLists||0}, مناديب: ${c.reps||0}, مبيعات: ${c.sales||0}`;
}
try { scheduleEnsureCoreData(); } catch(e) {}
} catch (e) {
console.warn('Admin cloud import failed', e);
alert('فشل الاستيراد: ' + (e && e.message ? e.message : 'خطأ غير معروف'));
} finally {
btn.disabled=false;
}
}
showHideAdminImportTool();
setTimeout(showHideAdminImportTool, 1200);
setTimeout(showHideAdminImportTool, 4000);
const adminStartBtn=document.getElementById('admin-start-import-btn');
if (adminStartBtn) adminStartBtn.addEventListener('click', handleAdminStartImport);
document.getElementById('add-new-dispatch-item-btn').addEventListener('click', ()=> addRowToNewDispatchGrid());
const saveDispatchBtn = document.getElementById('save-new-dispatch-note-btn');
if (saveDispatchBtn && typeof saveNewDispatchNoteFromGrid === 'function') {
    saveDispatchBtn.addEventListener('click', saveNewDispatchNoteFromGrid);
}
document.getElementById('page-dispatch').addEventListener('click', async (e)=> {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
const header=e.target.closest('.dispatch-note-header');
if (header) {
const card=header.closest('.dispatch-note-card');
if (!card) return; 
const details=card.querySelector('.dispatch-note-details');
const icon=header.querySelector('i[data-lucide="chevron-down"]');
if (!details) return; 
const noteId=card.dataset.noteId;
const isHidden=details.classList.contains('hidden');
if (isHidden) {
if (role==='rep') {
try { renderReadonlyDispatchGrid(noteId, details); } catch(_) { renderEditableDispatchGrid(noteId, details); }
} else {
renderEditableDispatchGrid(noteId, details);
}
details.classList.remove('hidden');
if (icon) icon.style.transform='rotate(180deg)';
} else {
details.classList.add('hidden');
details.innerHTML='';
if (icon) icon.style.transform='rotate(0deg)';
}
return;
}
const updateBtn=e.target.closest('.update-dispatch-note-btn');
if (updateBtn && role !=='rep') {
const noteId=updateBtn.dataset.noteId;
const table=updateBtn.closest('.dispatch-note-details').querySelector('.editable-dispatch-table');
await updateDispatchNote(noteId, table);
return;
}
const printBtn=e.target.closest('.print-dispatch-note-btn');
if (printBtn) {
const noteId=printBtn.dataset.noteId;
printDispatchNote(noteId);
return;
}
const copyBtn=e.target.closest('.copy-dispatch-note-btn');
if (copyBtn) {
const noteId=copyBtn.dataset.noteId;
await copyDispatchNoteAsImage(noteId);
return;
}
const deleteNoteBtn=e.target.closest('.delete-dispatch-note-btn');
if (deleteNoteBtn && role !=='rep') {
const noteId=deleteNoteBtn.dataset.noteId;
await deleteDispatchNote(noteId);
return;
}
const addRowBtn=e.target.closest('.add-editable-dispatch-item-btn');
if (addRowBtn && role !=='rep') {
const tableBody=addRowBtn.closest('.dispatch-note-details').querySelector('tbody');
const newRow=document.createElement('tr');
newRow.className='dispatch-item-row';
const productOptions=state.products.map(p=> `<option value="${p.id}">${p.name}</option>`).join('');
newRow.innerHTML=`
<td class="px-2 py-1"><select class="dispatch-item-product w-full p-1 border rounded-md text-sm" required><option value="">اختر منتج...</option>${productOptions}</select></td>
<td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="quantity" placeholder="0" min="0"></td>
<td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="goodReturn" placeholder="0" min="0"></td>
<td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="damagedReturn" placeholder="0" min="0"></td>
<td><input class="w-full p-1 border rounded-md text-center text-sm" type="number" data-field="freebie" placeholder="0" min="0"></td>
<td class="px-2 py-1 text-center"><button type="button" class="delete-dispatch-item-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
`;
tableBody.appendChild(newRow);
updateIcons();
return;
}
const deleteRowBtn=e.target.closest('.delete-dispatch-item-btn');
if (deleteRowBtn && role !=='rep') {
const row=deleteRowBtn.closest('tr');
if (row) row.remove();
return;
}
});
populateChainsDropdown(document.getElementById('daily-report-chain'));
populateChainsDropdown(document.getElementById('range-report-chain'));
populateChainsDropdown(document.getElementById('monthly-report-chain'));
populateChainsDropdown(document.getElementById('recon-report-chain'));
populateChainsDropdown(document.getElementById('targets-chain-filter'));
document.getElementById('generate-daily-report-btn').addEventListener('click', generateDailyReport);
document.getElementById('generate-recon-report-btn').addEventListener('click', generateReconciliationReport);
try { document.getElementById('generate-range-report-btn').addEventListener('click', generateRangeReport); } catch(e){}
try { document.getElementById('generate-monthly-report-btn').addEventListener('click', generateMonthlyReport); } catch(e){}
try { document.getElementById('generate-targets-report-btn').addEventListener('click', generateTargetsReport); } catch(e){}
try { document.getElementById('generate-customer-targets-report-btn').addEventListener('click', generateCustomerTargetsReport); } catch(e){}
try {
const tMonth=document.getElementById('targets-month');
if (tMonth) tMonth.addEventListener('change', generateTargetsReport);
const tRep=document.getElementById('targets-rep-filter');
if (tRep) tRep.addEventListener('change', generateTargetsReport);
const tChain=document.getElementById('targets-chain-filter');
if (tChain) tChain.addEventListener('change', generateTargetsReport);
} catch(e){}
try {
const dChain=document.getElementById('daily-report-chain');
if (dChain) dChain.addEventListener('change', generateDailyReport);
const rChain=document.getElementById('range-report-chain');
if (rChain) rChain.addEventListener('change', generateRangeReport);
const mChain=document.getElementById('monthly-report-chain');
if (mChain) mChain.addEventListener('change', generateMonthlyReport);
const rcChain=document.getElementById('recon-report-chain');
if (rcChain) rcChain.addEventListener('change', generateReconciliationReport);
} catch(e){}
try {
const cMonth=document.getElementById('customer-targets-month');
if (cMonth) cMonth.addEventListener('change', generateCustomerTargetsReport);
const cCat=document.getElementById('customer-targets-category');
if (cCat) cCat.addEventListener('change', generateCustomerTargetsReport);
const cRefresh=document.getElementById('refresh-customer-targets-btn');
if (cRefresh) cRefresh.addEventListener('click', generateCustomerTargetsReport);
const cSave=document.getElementById('save-customer-targets-btn');
if (cSave) cSave.addEventListener('click', saveCustomerTargetsFromInputs);
} catch(e){ console.warn('customer targets handlers failed', e); }
document.getElementById('manual-statement-btn').addEventListener('click', ()=> {
document.getElementById('end-date').value=new Date().toISOString().split('T')[0];
const thirtyDaysAgo=new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
document.getElementById('start-date').value=thirtyDaysAgo;
openModal(dateRangeModal);
updateCustomerList();
});
document.getElementById('date-range-form').addEventListener('submit', async (e)=> {
e.preventDefault();
const startDate=document.getElementById('start-date').value;
const endDate=document.getElementById('end-date').value;
const category=document.querySelector('input[name="product-category"]:checked').value;
const selectedCustomerNodes=document.querySelectorAll('#statement-customer-list input[type="checkbox"]:checked');
if (!startDate || !endDate) {
await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء تحديد تاريخ البداية والنهاية.' });
return;
}
if (selectedCustomerNodes.length===0) {
await customDialog({ title: 'بيانات ناقصة', message: 'الرجاء اختيار عميل واحد على الأقل.' });
return;
}
let expandedIds=[];
const chains=loadChains();
Array.from(selectedCustomerNodes).forEach(node=> {
const val=node.value;
if (val.startsWith('chain-')) {
const chainId=val.substring(6);
const chain=chains.find(c=> c.id===chainId);
if (chain) expandedIds.push(...(chain.customerIds || []));
} else {
expandedIds.push(val);
}
});
const customerNames=expandedIds.map(id=> findCustomer(id)?.name).filter(n=> n).join(', ');
const title=`كشف حساب يدوي`;
generateAndShowStatement(new Date(startDate), new Date(endDate), expandedIds, title, customerNames, category);
closeModal(dateRangeModal);
});
document.getElementById('cancel-date-range-btn').addEventListener('click', ()=> {
closeModal(dateRangeModal);
});
document.getElementById('statement-customer-search').addEventListener('input', (e)=> {
updateCustomerList(e.target.value);
});
if (logoutBtn) {
  logoutBtn.addEventListener('click', async ()=> {
    try {
      if (!confirm('هل تريد تسجيل الخروج؟')) return;
      if (auth && typeof auth.signOut==='function') await auth.signOut();
      try { AuthSystem.logout(); } catch(_){ }
      UIController.showLoginPage();
    } catch (error) {
      alert('فشل تسجيل الخروج: ' + (error && error.message ? error.message : error));
    }
  });
}
try {
const debtCustomerInput=document.getElementById('debt-customer-filter');
const debtRepSelect=document.getElementById('debt-rep-filter');
const debtStartDate=document.getElementById('debt-start-date');
const debtEndDate=document.getElementById('debt-end-date');
const debtStatusSelect=document.getElementById('debt-status-filter');
const debtsCsvBtn=document.getElementById('debts-csv-btn');
const debtsPrintBtn=document.getElementById('debts-print-btn');
if (debtRepSelect) populateRepDropdown(debtRepSelect);
const debtsRerender=()=> renderDebts();
if (debtCustomerInput) debtCustomerInput.addEventListener('change', debtsRerender);
if (debtRepSelect) debtRepSelect.addEventListener('change', debtsRerender);
if (debtStartDate) debtStartDate.addEventListener('change', debtsRerender);
if (debtEndDate) debtEndDate.addEventListener('change', debtsRerender);
if (debtStatusSelect) debtStatusSelect.addEventListener('change', debtsRerender);
if (debtsCsvBtn) {
debtsCsvBtn.addEventListener('click', ()=> {
const rows=(window._lastRenderedDebtsSales || []);
if (!rows.length) {
customDialog({ title: 'تنبيه', message: 'لا توجد بيانات لتصديرها.' });
return;
}
const headers=['اسم العميل', 'التاريخ', 'رقم الفاتورة', 'إجمالي الفاتورة', 'المسدد', 'المتبقي', 'المندوب'];
const csv=[headers.join(',')].concat(rows.map(sale=> {
const cust=findCustomer(sale.customerId)?.name || 'عميل محذوف';
const date=formatArabicDate(sale.date);
const inv=sale.invoiceNumber || '';
const total=(sale.total || 0).toFixed(2);
const paid=(sale.paidAmount || 0).toFixed(2);
const remaining=( (sale.total || 0) - (sale.paidAmount || 0) ).toFixed(2);
const rep=sale.repName || '';
return [`"${cust}"`,`"${date}"`,`"${inv}"`,`"${total}"`,`"${paid}"`,`"${remaining}"`,`"${rep}"`].join(',');
})).join('\n');
const blob=new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`debts_export_${new Date().toISOString().slice(0,10)}.csv`;
document.body.appendChild(a);
a.click();
a.remove();
URL.revokeObjectURL(url);
});
}
if (debtsPrintBtn) {
debtsPrintBtn.addEventListener('click', ()=> {
const rows=(window._lastRenderedDebtsSales || []);
const totalStats=window._lastRenderedDebtsStats || {};
const w=window.open('', '', 'height=700,width=1000');
if (!w) { alert('يرجى السماح بالنوافذ المنبثقة للطباعة'); return; }
w.document.open();
w.document.write('<html><head><title>طباعة مديونيات</title>');
w.document.write('<link rel="stylesheet" href="https://cdn.tailwindcss.com">');
w.document.write('<style>body{font-family: Cairo, sans-serif; direction: rtl; padding:20px;} table{width:100%;border-collapse:collapse;} th, td{padding:8px;border:1px solid #e5e7eb;text-align:center;} th{background:#fff7ed;color:#c2410c;}</style>');
w.document.write('</head><body>');
w.document.write('<h3 style="text-align:right">ملخص المديونيات</h3>');
w.document.write(`<p style="text-align:right">إجمالي الفواتير: ${formatCurrency(totalStats.subtotal || 0)}</p>`);
w.document.write(`<p style="text-align:right">المسدد: ${formatCurrency(totalStats.paid || 0)}</p>`);
w.document.write(`<p style="text-align:right">عدد الفواتير: ${totalStats.count || 0}</p>`);
w.document.write(`<p style="text-align:right">المديونيات: ${formatCurrency(totalStats.debts || 0)}</p>`);
w.document.write('<hr/>');
w.document.write('<table><thead><tr><th>اسم العميل</th><th>التاريخ</th><th>رقم الفاتورة</th><th>الإجمالي</th><th>المسدد</th><th>المتبقي</th><th>المندوب</th></tr></thead><tbody>');
rows.forEach(sale=> {
const cust=findCustomer(sale.customerId)?.name || 'عميل محذوف';
const date=formatArabicDate(sale.date);
const inv=sale.invoiceNumber || '';
const total=formatCurrency(sale.total || 0);
const paid=formatCurrency(sale.paidAmount || 0);
const remaining=formatCurrency((sale.total || 0) - (sale.paidAmount || 0));
const rep=sale.repName || '';
w.document.write(`<tr><td>${cust}</td><td>${date}</td><td>${inv}</td><td>${total}</td><td>${paid}</td><td>${remaining}</td><td>${rep}</td></tr>`);
});
w.document.write('</tbody></table>');
w.document.write('</body></html>');
w.document.close();
const doPrint=()=> { try { w.focus(); } catch(_){} try { w.print(); } catch(_){} };
const closeBack=()=> { try { w.close(); } catch(_){} try { window.focus(); } catch(_){} };
if ('onafterprint' in w) { w.onafterprint=closeBack; } else { setTimeout(closeBack, 1200); }
if ('onload' in w) { w.onload=()=> setTimeout(doPrint, 120); } else { setTimeout(doPrint, 300); }
});
}
} catch (e) {
console.warn('Debts event listeners setup failed', e);
}
const tabActive=document.getElementById('tab-active-productions');
const tabCompleted=document.getElementById('tab-completed-productions');
const sectionActive=document.getElementById('active-productions-section');
const sectionCompleted=document.getElementById('completed-productions-section');
if (tabActive && tabCompleted && sectionActive && sectionCompleted) {
tabActive.addEventListener('click', function(e) {
e.preventDefault();
console.log('🟢 Switched to Active Productions');
sectionActive.classList.remove('hidden');
sectionCompleted.classList.add('hidden');
tabActive.classList.add('text-green-600', 'border-b-2', 'border-green-600');
tabActive.classList.remove('text-gray-600', 'hover:text-gray-800');
tabCompleted.classList.remove('text-green-600', 'border-b-2', 'border-green-600');
tabCompleted.classList.add('text-gray-600', 'hover:text-gray-800');
});
tabCompleted.addEventListener('click', function(e) {
e.preventDefault();
console.log('🔵 Switched to Completed Productions');
sectionCompleted.classList.remove('hidden');
sectionActive.classList.add('hidden');
tabCompleted.classList.add('text-green-600', 'border-b-2', 'border-green-600');
tabCompleted.classList.remove('text-gray-600', 'hover:text-gray-800');
tabActive.classList.remove('text-green-600', 'border-b-2', 'border-green-600');
tabActive.classList.add('text-gray-600', 'hover:text-gray-800');
});
} else {
if (!tabActive) console.warn('⚠️ tab-active-productions not found');
if (!tabCompleted) console.warn('⚠️ tab-completed-productions not found');
if (!sectionActive) console.warn('⚠️ active-productions-section not found');
if (!sectionCompleted) console.warn('⚠️ completed-productions-section not found');
}
eventListenersAttached=true;
console.log("✅ Event listeners attached successfully");
} catch (e) {
console.error("❌ Error attaching event listeners:", e);
eventListenersAttached = true; // Mark as attempted even on error
}
}
const internalAuthHandler=async (user)=> {
if (user) {
console.log('User logged in:', user.email);
// Show the app container
try { UIController.showApp(); } catch(e) { console.warn('UIController.showApp failed:', e); }
showLoading("جاري تحميل البيانات المحلية...");
if (!window.state) window.state={ customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
try { preloadCachedCollections(); } catch(e){ console.warn('preloadCachedCollections (login) failed', e); }
try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed during startup', e); }
try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed during startup', e); }
try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed during startup:', e); }
try { renderAll(); } catch (e) { console.warn('renderAll failed during startup:', e); }
try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed during startup:', e); }
setTimeout(()=> {
scheduleRender('charts', ()=>{ try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { } });
}, 60);
hideLoading(); 
try { applyRoleUIRestrictions(); } catch(_){}
try {
if (!window.__RT_LISTENERS_ATTACHED) {
setupRealtimeListeners();
window.__RT_LISTENERS_ATTACHED=true;
}
} catch(e) { console.warn('setupRealtimeListeners (auth handler) failed', e); }
try { await importEmbeddedBackupIfNeeded(); } catch(e){ console.warn('importEmbeddedBackupIfNeeded (auth handler) failed', e); }
try { scheduleEnsureCoreData(); } catch(e){ console.warn('scheduleEnsureCoreData (auth handler) failed', e); }
} else {
console.log('No authenticated user detected — starting offline/local mode');
// Show the app container even in offline mode
try { UIController.showApp(); } catch(e) { console.warn('UIController.showApp (offline) failed:', e); }
// logoutBtn removed
try {
if (!window.state) window.state={ customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
try { preloadCachedCollections(); } catch(e){ console.warn('preloadCachedCollections (offline) failed', e); }
try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed during offline startup', e); }
try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed during offline startup', e); }
try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed during offline startup:', e); }
try { renderAll(); } catch (e) { console.warn('renderAll failed during offline startup:', e); }
try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed during offline startup:', e); }
setTimeout(()=> {
scheduleRender('charts', ()=>{ try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { } });
}, 60);
} catch (e) {
console.warn('Offline startup failed, falling back to cleared state:', e);
state={ customers: [], products: [], sales: [], priceLists: [], dispatchNotes: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
renderAll();
}
try { applyRoleUIRestrictions(); } catch(_){}
}
};
function applyRoleUIRestrictions(){
try {
const role=(typeof getUserRole==='function') ? getUserRole() : 'user';
if (role==='rep') {
const newDispatchSection=document.getElementById('new-dispatch-note-section');
if (newDispatchSection) newDispatchSection.style.display='none';
document.querySelectorAll('.update-dispatch-note-btn,.delete-dispatch-note-btn,.add-editable-dispatch-item-btn,.delete-dispatch-item-btn,#save-new-dispatch-note-btn,#add-new-dispatch-item-btn').forEach(el=>{
el.classList.add('pointer-events-none','opacity-50');
if (el.tagName==='BUTTON' || el.tagName==='INPUT') el.disabled=true;
});
}
} catch(e){ console.warn('applyRoleUIRestrictions failed', e); }
}
if (typeof auth !=='undefined' && auth && typeof auth.onAuthStateChanged==='function') {
try {
auth.onAuthStateChanged(internalAuthHandler);
} catch (e) {
console.warn('auth.onAuthStateChanged failed, falling back to safe handler:', e);
internalAuthHandler(null);
}
} else if (typeof onAuthStateChanged==='function' && window.auth) {
try {
onAuthStateChanged(window.auth, internalAuthHandler);
} catch (e) {
console.warn('onAuthStateChanged(window.auth) failed, falling back:', e);
internalAuthHandler(null);
}
} else {
console.warn('No Firebase auth available; loading local data for offline mode.');
try {
if (!window.state) window.state={ customers: [], products: [], sales: [], reps: [], promotions: [], settings: { salesTarget: 10000 } };
try { renderCompanyLogo(); } catch(e) { console.warn('renderCompanyLogo failed in fallback startup', e); }
try { applyWatermark(getCompanyLogoUrl()); } catch(e) { console.warn('applyWatermark failed in fallback startup', e); }
try { setupAllEventListeners(); } catch (e) { console.warn('setupAllEventListeners failed in fallback:', e); }
try { renderAll(); } catch (e) { console.warn('renderAll failed in fallback:', e); }
try { navigateTo('dashboard'); } catch (e) { console.warn('navigateTo failed in fallback:', e); }
setTimeout(()=> {
try { renderDashboard(); renderSales7DaysChart(); renderTopRepsChart(); renderTopProductsChart(); renderTopCustomersChart(); updateIcons(); } catch (e) { }
}, 60);
} catch (e) {
console.error('Fallback UI initialization failed:', e);
}
}
async function syncWithFirestore() {
try {
const lastSyncTimestamp=state.lastSyncTimestamp;
console.log(`Starting incremental sync. Fetching changes since: ${lastSyncTimestamp || 'the beginning of time'}`);
const collections=['customers', 'products', 'sales', 'priceLists', 'dispatchNotes', 'reps', 'promotions', 'settings'];
const queries=collections.map(col=> {
let query=db.collection(col);
if (lastSyncTimestamp && col !=='settings' && col !=='sales') {
query=query.where('updatedAt', '>', lastSyncTimestamp);
}
return query.get();
});
const snapshots=await Promise.all(queries);
const newSyncTimestamp=new Date().toISOString();
let hasChanges=false;
snapshots.forEach((snapshot, index)=> {
const collectionName=collections[index];
if (!snapshot.empty) {
hasChanges=true;
console.log(`Found ${snapshot.size} updated document(s) in ${collectionName}.`);
snapshot.docs.forEach(doc=> {
const data={ id: doc.id, ...doc.data() };
const collectionState=state[collectionName];
if (Array.isArray(collectionState)) {
const existingIndex=collectionState.findIndex(item=> item.id===data.id);
if (existingIndex > -1) {
collectionState[existingIndex]=data; 
} else {
collectionState.push(data); 
}
}
});
} else if (collectionName==='settings' && !snapshot.empty) {
hasChanges=true;
state.settings={ id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
}
});
if (hasChanges) {
console.log('Changes found, state will be updated and saved.');
} else {
console.log('No new changes found from Firestore.');
}
state.lastSyncTimestamp=newSyncTimestamp;
saveState();
console.log('Firestore sync process finished and state saved locally.');
} catch (error) {
console.error('syncWithFirestore failed:', error);
throw error; 
}
}
loginForm.addEventListener('submit', async (e)=> {
e.preventDefault();
const email=loginEmailInput.value;
const password=loginPasswordInput.value;
const loginButton=e.submitter;
loginButton.disabled=true;
loginButton.textContent='جارٍ تسجيل الدخول...';
try {
const result=await (typeof window.loginUsingServices==='function'
? window.loginUsingServices(email, password, { showAlertOnError: false })
: auth.signInWithEmailAndPassword(email, password).then(()=> ({ ok: true })));
if (!result.ok) throw new Error(result.error || 'فشل تسجيل الدخول');
closeModal(loginModal);
} catch (error) {
alert('فشل تسجيل الدخول: ' + error.message);
} finally {
loginButton.disabled=false;
loginButton.textContent='تسجيل الدخول';
}
});
</script>
<!-- لا يوجد كود auto-start offline هنا في النسخة الأصلية -->
<script>
(function(){
const LS_FIN='cost_finished';
const LS_RAW='cost_raw';
const LS_PACK='cost_pack';
const LS_OPS='cost_ops';
const LS_BOM_PREFIX='bom_';
let costFinished=[];
let costRaw=[];
let costPack=[];
let costOps=[];
function loadLists(){
const safeGetLS=(key)=> {
const val=localStorage.getItem(key);
if (!val || val==='undefined' || val==='null') return '[]';
return val;
};
try { costFinished=JSON.parse(safeGetLS(LS_FIN)); } catch(e){ costFinished=[]; }
try { costRaw=JSON.parse(safeGetLS(LS_RAW)); } catch(e){ costRaw=[]; }
try { costPack=JSON.parse(safeGetLS(LS_PACK)); } catch(e){ costPack=[]; }
try { costOps=JSON.parse(safeGetLS(LS_OPS)); } catch(e){ costOps=[]; }
try {
const rawFromLS=localStorage.getItem(LS_RAW);
const rawParsed=(rawFromLS && rawFromLS !=='undefined' && rawFromLS !=='null') ? JSON.parse(rawFromLS) : [];
console.log('🔍 loadLists DEBUG: loaded cost_raw from localStorage', { itemCount: rawParsed.length, firstItem: rawParsed[0], timestamp: localStorage.getItem('costLists_local_ts'), rawStorageKey: LS_RAW });
} catch(e) { console.warn('🔍 loadLists DEBUG: error reading cost_raw', e); }
try { window.costFinished=costFinished; window.costRaw=costRaw; window.costPack=costPack; window.costOps=costOps; } catch(_){ }
console.log('loadLists: loaded from localStorage', { costRaw: costRaw.length, costPack: costPack.length, costFinished: costFinished.length });
try {
if (!window.__DISABLE_AUTO_SEED_COST_LISTS) {
ensureFinishedFromState();
} else {
console.log('⏭️ Auto-seed finished list disabled; skipping ensureFinishedFromState');
}
} catch(_){ }
try {
if (!window.__DISABLE_AUTO_SEED_COST_LISTS) {
ensureRawAndPackFromState();
} else {
console.log('⏭️ Auto-seed raw/pack disabled; skipping ensureRawAndPackFromState');
}
} catch(_){ }
console.log('loadLists: after ensure', { costRaw: costRaw.length, costPack: costPack.length, costFinished: costFinished.length });
renderListsSummary(); renderProductSelect(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable();
console.log('loadLists: about to call tryLoadCostListsFromCloud...');
try { tryLoadCostListsFromCloud(); } catch(e){ console.warn('loadLists: tryLoadCostListsFromCloud failed', e); }
}
function saveLists(suppressCloud){
try { 
costFinished=window.costFinished || costFinished; 
costRaw=window.costRaw || costRaw; 
costPack=window.costPack || costPack; 
costOps=window.costOps || costOps; 
} catch(_){ }
renderListsSummary(); renderProductSelect(); renderRawPriceTable();
try {
try {
if (Array.isArray(window.costFinished) && window.costFinished.length > 0) {
localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished));
} else {
const existingFin=JSON.parse(localStorage.getItem(LS_FIN) || '[]');
if (Array.isArray(existingFin) && existingFin.length > 0) {
} else {
localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished));
}
}
} catch(_){ localStorage.setItem(LS_FIN, JSON.stringify(window.costFinished)); }
localStorage.setItem(LS_RAW, JSON.stringify(window.costRaw));
localStorage.setItem(LS_PACK, JSON.stringify(window.costPack));
localStorage.setItem(LS_OPS, JSON.stringify(window.costOps));
const timestamp=new Date().toISOString();
console.log('💾 saveLists: cached locally (cache only)', { finished: (window.costFinished||[]).length, raw: (window.costRaw||[]).length, pack: (window.costPack||[]).length, ops: (window.costOps||[]).length, timestamp });
} catch(e){ console.warn('⚠️ saveLists: failed to write local cache', e); }
if (!suppressCloud) {
try {
window.costLists=window.costLists || {};
window.costLists.costRaw=window.costRaw;
window.costLists.costPack=window.costPack;
window.costLists.costFinished=window.costFinished;
if (typeof window.saveCostListsToFirebase==='function') {
window.saveCostListsToFirebase(true).then(ok=> {
if (ok) {
document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { raw: (window.costRaw||[]).length, pack: (window.costPack||[]).length, finished: (window.costFinished||[]).length } }));
}
}).catch(e=> console.warn('⚠️ saveLists: saveCostListsToFirebase failed', e));
} else {
console.warn('⚠️ saveLists: saveCostListsToFirebase not available');
}
} catch(e) { console.warn('⚠️ saveLists: cloud write failed', e); }
}
}
try { window.saveLists=saveLists; } catch(_){ }
let __costDocUnsub=null;
let renderDebounceTimer=null;
window.safeRenderUI=function() {
clearTimeout(renderDebounceTimer);
renderDebounceTimer=setTimeout(()=> {
console.log("🛑 Debounce: Executing Single Render...");
try {
if (window.inventorySystem && typeof window.inventorySystem._syncFromLocalStorage==='function') {
window.inventorySystem._syncFromLocalStorage();
}
} catch(e) { console.warn('_syncFromLocalStorage failed:', e); }
try {
window.isUpdatingFromCloud=true; 
if (typeof renderRawMaterials==='function') renderRawMaterials();
if (typeof renderPackaging==='function') renderPackaging();
if (typeof renderFinishedProducts==='function') renderFinishedProducts();
console.log("✅ UI Rendered (debounced, safe)");
if (typeof updateCounters==='function') updateCounters();
if (typeof updateTotalValue==='function') updateTotalValue();
} catch(e) {
console.warn('UI re-render failed:', e);
} finally {
setTimeout(()=> { window.isUpdatingFromCloud=false; }, 1000);
}
}, 500); 
};
window.syncCloudDataToUI=function(cloudData) {
console.log("🔄 Syncing Cloud Numbers to UI...");
const updateStock=(localList, cloudList)=> {
if (!localList || !cloudList) return;
localList.forEach(item=> {
const cloudItem=cloudList.find(c=> c.name===item.name || (c.id && c.id===item.id));
if (cloudItem) {
item.stock=Number(cloudItem.stock) || 0; 
item.avgCost=Number(cloudItem.avgCost || cloudItem.cost) || 0; 
item.cost=Number(cloudItem.cost || cloudItem.avgCost) || 0; 
}
});
};
if (window.costRaw && cloudData.raw) {
updateStock(window.costRaw, cloudData.raw);
console.log(`✅ Updated ${window.costRaw.length} raw materials with cloud stock`);
}
if (window.costPack && cloudData.pack) {
updateStock(window.costPack, cloudData.pack);
console.log(`✅ Updated ${window.costPack.length} packaging items with cloud stock`);
}
if (window.costFinished && cloudData.finished) {
updateStock(window.costFinished, cloudData.finished);
console.log(`✅ Updated ${window.costFinished.length} finished products with cloud stock`);
}
window.safeRenderUI();
};
let __realtimeSyncInitialized=false;
function initRealtimeSync() {
try {
if (__realtimeSyncInitialized) {
console.log('ℹ️ Realtime sync ALREADY INITIALIZED - skipping duplicate call');
return;
}
console.log('🔌 Connecting to Real-time Data Stream (onSnapshot - Safe)...');
if (!window.firebase || !window.firebase.firestore) {
console.warn('Firebase not ready for realtime sync');
return;
}
if (__costDocUnsub) {
console.log('ℹ️ Realtime sync already active (unsub exists)');
__realtimeSyncInitialized=true;
return;
}
__realtimeSyncInitialized=true;
__costDocUnsub=firebase.firestore().collection('settings').doc('costLists')
.onSnapshot((doc)=> {
if (!doc.exists) {
console.log('ℹ️ No costLists doc in cloud yet');
return;
}
const source=doc.metadata.hasPendingWrites ? "Local" : "Server";
if (source==="Local") {
return;
}
const data=doc.data();
console.log(`📥 Received update from ${source}`, { hasRaw: !!data.raw, hasPack: !!data.pack, hasFinished: !!data.finished });
if (source==="Server" || !window.dataLoaded) {
window.isUpdatingFromCloud=true;
window.costLists=window.costLists || {};
if (data.raw) window.costLists.costRaw=data.raw;
if (data.pack) window.costLists.costPack=data.pack;
if (data.finished) window.costLists.costFinished=data.finished;
if (data.timestamp) window.costLists.timestamp=data.timestamp;
if (Array.isArray(data.raw)) {
window.costRaw=data.raw; 
console.log(`✅ Updated window.costRaw with ${data.raw.length} items from cloud`);
}
if (Array.isArray(data.pack)) {
window.costPack=data.pack;
console.log(`✅ Updated window.costPack with ${data.pack.length} items from cloud`);
}
if (Array.isArray(data.finished)) {
window.costFinished=data.finished; 
window.finishedProducts=data.finished; 
console.log(`✅ Updated window.costFinished with ${data.finished.length} items from cloud`);
}
try {
if (data.raw) localStorage.setItem('cost_raw', JSON.stringify(data.raw));
if (data.pack) localStorage.setItem('cost_pack', JSON.stringify(data.pack));
if (data.finished) localStorage.setItem('cost_finished', JSON.stringify(data.finished));
} catch(e) { console.warn('localStorage sync failed:', e); }
try {
if (typeof window.syncCloudDataToUI==='function') {
window.syncCloudDataToUI(data);
}
if (window.inventorySystem && window.inventorySystem.currentTab) {
console.log(`🔄 Cloud data arrived, will refresh ${window.inventorySystem.currentTab} tab UI after debounce...`);
}
} catch(e) { console.warn('UI refresh failed:', e); }
window.dataLoaded=true;
try {
window.__costSnapshotLoaded=true;
window.__hasCloudCostDoc=true;
} catch(_){ }
console.log('✅ Real-time sync update applied (safe, no loops)');
setTimeout(()=> { window.isUpdatingFromCloud=false; }, 1000);
}
}, (error)=> {
console.error('❌ Realtime sync error:', error);
if (error.code==='permission-denied') {
console.warn('⚠️ Permission denied - check Firestore rules or re-login');
}
});
window.addEventListener('costListsSavedToCloud', ()=> {
try {
if (window.inventorySystem && window.inventorySystem.currentTab) {
console.log('🔄 Cloud update detected, refreshing UI...');
setTimeout(()=> window.inventorySystem.loadInventoryData(window.inventorySystem.currentTab), 100);
}
} catch(e){ console.warn('UI refresh on cloud update failed:', e); }
});
} catch(e) {
console.error('initRealtimeSync failed:', e);
}
}
setTimeout(()=> {
try { if (typeof initRealtimeSync==='function') initRealtimeSync(); } catch(e){ console.error('initRealtimeSync error:', e); }
}, 500);
async function tryLoadCostListsFromCloud(){
try {
console.log("☁️ Attempting to load and RESTORE data from Cloud...");
if (!window.firebase || !window.firebase.firestore) {
console.warn('⚠️ Firebase not initialized');
return false;
}
const doc=await firebase.firestore().collection('settings').doc('costLists').get();
if (doc.exists) {
try { window.__hasCloudCostDoc=true; } catch(_){}
const data=doc.data();
console.log("📋 Cloud doc found:", { hasRaw: !!data.raw, hasPack: !!data.pack, hasFinished: !!data.finished, hasRawGridState: !!data.rawGridState, hasPackGridState: !!data.packGridState, hasFinishedProducts: !!data.finishedProducts, hasStockEntries: !!data.stockEntries });
if (data.raw && Array.isArray(data.raw) && data.raw.length > 0) {
window.costLists=window.costLists || {};
window.costLists.costRaw=data.raw;
console.log("✅ Restored costRaw:", data.raw.length, "items");
}
if (data.pack && Array.isArray(data.pack) && data.pack.length > 0) {
window.costLists=window.costLists || {};
window.costLists.costPack=data.pack;
console.log("✅ Restored costPack:", data.pack.length, "items");
}
if (data.finished && Array.isArray(data.finished)) {
window.costLists=window.costLists || {};
window.costLists.costFinished=data.finished;
window.costFinished=data.finished; 
window.finishedProducts=data.finished; 
try { localStorage.setItem('cost_finished', JSON.stringify(data.finished)); } catch(_){}
console.log("✅ Restored costFinished:", data.finished.length, "items");
}
if (data.timestamp) {
window.costLists=window.costLists || {};
window.costLists.timestamp=data.timestamp;
}
if ((data.rawGridState && typeof data.rawGridState==='object') || (data.rawMaterials && typeof data.rawMaterials==='object')) {
const rawState=(data.rawGridState && typeof data.rawGridState==='object') ? data.rawGridState : data.rawMaterials;
window._rawGridState=data.rawGridState;
try { localStorage.setItem('raw_materials_grid', JSON.stringify(rawState)); } catch(_){}
console.log("✅ Restored raw grid state to window and localStorage", { keys: Object.keys(rawState||{}).length });
try { if (!data.rawGridState && window.db) await db.collection('settings').doc('costLists').set({ rawGridState: rawState, updatedAt: serverTs() }, { merge:true }); } catch(_){}
}
if ((data.packGridState && typeof data.packGridState==='object') || (data.packaging && typeof data.packaging==='object')) {
const packState=(data.packGridState && typeof data.packGridState==='object') ? data.packGridState : data.packaging;
window._packGridState=packState;
try { localStorage.setItem('packaging_grid', JSON.stringify(packState)); } catch(_){}
console.log("✅ Restored pack grid state to window and localStorage", { keys: Object.keys(packState||{}).length });
try { if (!data.packGridState && window.db) await db.collection('settings').doc('costLists').set({ packGridState: packState, updatedAt: serverTs() }, { merge:true }); } catch(_){}
}
if (data.finishedProducts && typeof data.finishedProducts==='object') {
window._finishedGridState=data.finishedProducts;
localStorage.setItem('finished_products_grid', JSON.stringify(data.finishedProducts));
console.log("✅ Restored finishedProducts to window and localStorage:", Object.keys(data.finishedProducts).length, "products");
}
if (data.stockEntries && typeof data.stockEntries==='object' && Object.keys(data.stockEntries||{}).length > 0) {
if (!window.state) window.state={};
window.state.stockEntries=data.stockEntries;
try { localStorage.setItem('stock_entries', JSON.stringify(data.stockEntries)); } catch(_){ }
console.log("✅ Restored stockEntries to window and localStorage:", Object.keys(data.stockEntries).length, "dates");
} else {
console.log('⏭️ Skipped restoring stockEntries (cloud empty)');
}
try {
if (typeof renderRawMaterials==='function') {
console.log("🎨 Re-rendering Raw Materials...");
renderRawMaterials();
}
} catch(e){ console.warn('renderRawMaterials re-render failed:', e); }
try {
if (typeof renderPackaging==='function') {
console.log("🎨 Re-rendering Packaging...");
renderPackaging();
}
} catch(e){ console.warn('renderPackaging re-render failed:', e); }
try {
if (typeof renderFinishedProducts==='function') {
console.log("🎨 Re-rendering Finished Products...");
renderFinishedProducts();
}
} catch(e){ console.warn('renderFinishedProducts re-render failed:', e); }
console.log("✅ Data restored from Cloud successfully!");
try { setTimeout(()=> { if (typeof window.normalizeInventoryNow==='function') window.normalizeInventoryNow(); }, 800); } catch(_){ }
return true;
} else {
try { window.__hasCloudCostDoc=false; } catch(_){}
console.log('ℹ️ No cloud doc found; using local data');
return false;
}
} catch (e) {
console.error("❌ Failed to load from cloud:", e);
return false;
}
}
async function restoreFinishedFromDaily(maxDays=14){
try {
const now=new Date();
let restored=false;
for (let i=0; i < maxDays; i++) {
const d=new Date(now);
d.setDate(now.getDate() - i);
const dateId=d.toISOString().split('T')[0];
let snap;
try {
const ref=(window.db ? window.db : firebase.firestore());
snap=await ref.collection('daily_cost_lists').doc(String(dateId)).get();
} catch(e){ console.warn('restoreFinishedFromDaily: fetch failed', e); continue; }
if (snap && snap.exists) {
const data=snap.data() || {};
const arr=Array.isArray(data.finished_products) ? data.finished_products : [];
if (arr.length > 0) {
window._finishedGridState=window._finishedGridState || {};
arr.forEach(fp=> {
const id=String(fp.id || fp.code || fp.name || '').trim();
if (!id) return;
const count=Number(fp.count || fp.actual || fp.opening || 0);
window._finishedGridState[id]=Object.assign({}, window._finishedGridState[id] || {}, { actual: count, updatedAt: new Date().toISOString() });
});
try { localStorage.setItem('finished_products_grid', JSON.stringify(window._finishedGridState)); } catch(_){}
console.log('✅ تمت استعادة رصيد المنتجات التامة من اليوم:', dateId, ' — عناصر:', arr.length);
restored=true;
break; 
}
}
}
if (!restored) console.warn('⚠️ لم يتم العثور على رصيد منتجات تامة في الأيام الماضية');
return restored;
} catch(e){ console.warn('restoreFinishedFromDaily failed', e); return false; }
}
try {
window.restoreBalancesFromCloud=async function(){
try {
console.log('♻️ بدء استعادة الأرصدة من السحابة...');
await tryLoadCostListsFromCloud();
const ok=await restoreFinishedFromDaily(30);
try { if (typeof renderFinishedProducts==='function') renderFinishedProducts(); } catch(_){}
try { if (typeof renderPackaging==='function') renderPackaging(); } catch(_){}
try { if (typeof renderRawMaterials==='function') renderRawMaterials(); } catch(_){}
try { if (typeof window.saveCostListsToFirebase==='function') await window.saveCostListsToFirebase(); } catch(_){}
console.log(ok ? '✅ تم الاستعادة بنجاح' : 'ℹ️ لم يتم العثور على أرصدة محفوظة مؤخرًا');
return ok;
} catch(e){ console.warn('restoreBalancesFromCloud failed', e); return false; }
};
} catch(_){}
function queueCloudSave(){
if (!window.db) { console.warn('⚠️ queueCloudSave: Firebase not initialized'); return; }
if (__costCloudTimer) clearTimeout(__costCloudTimer);
__costCloudTimer=setTimeout(async ()=>{ try {
console.log('🔥 Attempting to save cost lists to Firebase (settings/costLists)...');
const qpayload={ ops: costOps || [], updatedAt: serverTs() };
if (Array.isArray(costFinished) && costFinished.length>0) qpayload.finished=costFinished;
if (Array.isArray(costRaw) && costRaw.length>0) qpayload.raw=costRaw;
if (Array.isArray(costPack) && costPack.length>0) qpayload.pack=costPack;
await db.collection('settings').doc('costLists').set(qpayload, { merge: true });
console.log('✅ Cost lists saved to Firebase (settings/costLists)', { finished: (costFinished||[]).length, raw: (costRaw||[]).length, pack: (costPack||[]).length, ops: (costOps||[]).length });
try{ document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { path: 'settings/costLists' } })); }catch(_){ }
} catch(e){
console.warn('⚠️ Failed to save to settings/costLists:', e);
try {
const uid=(auth && auth.currentUser) ? (auth.currentUser.uid || auth.currentUser.email) : null;
if (!uid) { console.warn('❌ queueCloudSave fallback: no authenticated user available'); return; }
console.log('🔄 Falling back to save at users/{uid}.costLists...');
await db.collection('users').doc(uid).set({
costLists: {
finished: costFinished || [],
raw: costRaw || [],
pack: costPack || [],
ops: costOps || [],
updatedAt: serverTs()
}
}, { merge: true });
console.log('✅ Cost lists saved to Firebase (users/' + uid + '.costLists)');
try{ document.dispatchEvent(new CustomEvent('costListsSavedToCloud', { detail: { path: 'users/' + uid + '.costLists' } })); }catch(_){ }
} catch(e2){
console.warn('❌ Fallback save to users/{uid}.costLists also failed:', e2);
}
}
}, 800);
}
window.saveCostListsToFirebase=async function(immediate){
if (!window.db) {
console.warn('⚠️ saveCostListsToFirebase: Firebase not ready, waiting...');
try { await waitForDbReady(5000); } catch(e) { console.warn('⚠️ saveCostListsToFirebase: DB wait timed out', e); }
if (!window.db) { console.warn('⚠️ saveCostListsToFirebase: Firebase still not ready'); return false; }
}
window.costLists=window.costLists || {};
if (window.costRaw) window.costLists.costRaw=window.costRaw;
if (window.costPack) window.costLists.costPack=window.costPack;
if (window.costFinished) window.costLists.costFinished=window.costFinished;
if (window.costOps) window.costLists.costOps=window.costOps;
const statusEl=document.getElementById('sync-status');
const setStatus=(txt, visible=true)=> {
try { if (statusEl) { statusEl.textContent=txt; statusEl.classList.toggle('hidden', !visible); } } catch(_){}
};
const includeRaw=true; 
const includePack=true; 
const includeFinished=true; 
console.log('🔍 saveCostListsToFirebase DEBUG:', {
'window.costRaw length': (window.costRaw||[]).length,
'window.costPack length': (window.costPack||[]).length,
'window.costFinished length': (window.costFinished||[]).length,
'window.costLists.costRaw length': (window.costLists?.costRaw||[]).length,
'window.costLists.costPack length': (window.costLists?.costPack||[]).length,
'window.costLists.costFinished length': (window.costLists?.costFinished||[]).length
});
const payload={
ops: window.costLists?.costOps || [],
rawGridState: window._rawGridState || {},
packGridState: window._packGridState || {},
finishedProducts: window._finishedGridState || {},
stockEntries: window.state?.stockEntries || {},
timestamp: new Date().toISOString(),
updatedAt: serverTs()
};
if (includeRaw) {
payload.raw=window.costRaw || window.costLists?.costRaw || [];
}
if (includePack) {
payload.pack=window.costPack || window.costLists?.costPack || [];
}
if (includeFinished) {
payload.finished=window.costFinished || window.costLists?.costFinished || [];
}
try {
const rawCount=Array.isArray(payload.raw) ? payload.raw.length : 0;
const packCount=Array.isArray(payload.pack) ? payload.pack.length : 0;
const finishedCount=Array.isArray(payload.finished) ? payload.finished.length : 0;
const allZero=(rawCount===0 && packCount===0 && finishedCount===0);
const hasCloudDoc=!!window.__hasCloudCostDoc;
const ready=!!window.__costListsReady;
const force=(immediate==='force') || (immediate && typeof immediate==='object' && immediate.force===true) || !!window.__allowZeroCloudSave;
if (allZero && hasCloudDoc && !force) {
console.warn('🛑 saveCostListsToFirebase: Skip zero-save to protect cloud data (doc exists, arrays empty).');
return false;
}
if (allZero && !ready && !force) {
console.warn('🛑 saveCostListsToFirebase: Startup not ready; skipping zero-save.');
return false;
}
} catch(_){ }
let attempts=0; const MAX_ATTEMPTS=3; const BASE_DELAY=800;
while (attempts < MAX_ATTEMPTS) {
attempts++;
try {
setStatus('جارٍ المزامنة...');
try { if (window.firebase && firebase.auth && firebase.auth().currentUser) await firebase.auth().currentUser.getIdToken(true); } catch(e){ }
await db.collection('settings').doc('costLists').set(payload, { merge: true });
const rawCount=Array.isArray(payload.raw) ? payload.raw.length : 0;
const packCount=Array.isArray(payload.pack) ? payload.pack.length : 0;
const finishedCount=Array.isArray(payload.finished) ? payload.finished.length : 0;
const stockEntriesCount=payload.stockEntries ? Object.keys(payload.stockEntries).length : 0;
console.log('✅ Cost lists saved to Firebase', { raw: rawCount, pack: packCount, finished: finishedCount, stockEntries: stockEntriesCount });
try { localStorage.setItem('costLists_local_ts', payload.timestamp); } catch(_){ }
try { if (payload.rawGridState && Object.keys(payload.rawGridState||{}).length>0) localStorage.setItem('raw_materials_grid', JSON.stringify(payload.rawGridState||{})); } catch(_){ }
try { if (payload.finishedProducts && Object.keys(payload.finishedProducts||{}).length>0) localStorage.setItem('finished_products_grid', JSON.stringify(payload.finishedProducts||{})); } catch(_){ }
try { if (payload.stockEntries && Object.keys(payload.stockEntries||{}).length>0) localStorage.setItem('stock_entries', JSON.stringify(payload.stockEntries||{})); } catch(_){ }
try { if (payload.packGridState && Object.keys(payload.packGridState||{}).length>0) localStorage.setItem('packaging_grid', JSON.stringify(payload.packGridState||{})); } catch(_){ }
try {
const finishedProductsArray=[];
try {
const fps=window._finishedGridState || {};
for (const k in fps) {
if (!Object.prototype.hasOwnProperty.call(fps, k)) continue;
const it=fps[k] || {};
finishedProductsArray.push({
id: k,
name: it.name || ((Array.isArray(window.costFinished) && window.costFinished.find(x=>String(x.id)===String(k))) ? (window.costFinished.find(x=>String(x.id)===String(k)).name) : ''),
count: (it.actual !=null ? it.actual : (it.opening !=null ? it.opening : 0)),
updatedAt: it.updatedAt || new Date().toISOString()
});
}
} catch(e){ console.warn('build finishedProductsArray failed', e); }
try {
const dateEl=document.getElementById('finished-products-date');
const dateId=(dateEl && dateEl.value) ? String(dateEl.value) : (new Date().toISOString().split('T')[0]);
if (dateId && Array.isArray(finishedProductsArray)) {
try { await db.collection('daily_cost_lists').doc(String(dateId)).set({ finished_products: finishedProductsArray, timestamp: payload.timestamp, updatedAt: serverTs() }, { merge:true }); }
catch(e){ console.warn('daily_cost_lists write failed', e); }
}
} catch(e){ console.warn('daily_cost_lists write (dateId) failed', e); }
} catch(e){ console.warn('mirror to daily_cost_lists failed', e); }
setStatus('متزامن ✓', true);
setTimeout(()=> setStatus('', false), 2500);
return true;
} catch (e) {
console.error('❌ saveCostListsToFirebase failed (attempt ' + attempts + '):', e);
if (e && e.code==='permission-denied') {
setStatus('خطأ صلاحيات; أعد تسجيل الدخول', true);
console.warn('⚠️ Permission denied - check Firestore rules or re-login');
try { if (firebase && firebase.auth && firebase.auth().currentUser) await firebase.auth().currentUser.getIdToken(true); } catch(_){}
}
if (attempts < MAX_ATTEMPTS) await new Promise(r=> setTimeout(r, BASE_DELAY * attempts));
}
}
setStatus('فشل المزامنة ❌', true);
return false;
};
function installCostListsListener(){
console.log('⚠️ installCostListsListener deprecated - use initRealtimeSync()');
return;
}
window.forceCostListsFetch=async function(){
try{
try { if (!window.db) { console.warn('forceCostListsFetch: no db available'); return; } } catch(_){ console.warn('forceCostListsFetch: window.db check failed'); return; }
const ref=db.collection('settings').doc('costLists');
const snap=await ref.get();
const localTs=localStorage.getItem('costLists_local_ts') || null;
console.log('forceCostListsFetch: localTs', localTs);
if(!snap.exists){ console.log('forceCostListsFetch: cloud doc not found'); return; }
const d=snap.data() || {};
const cloudTs=d.updatedAt ? (d.updatedAt.toDate ? d.updatedAt.toDate().toISOString() : (new Date(d.updatedAt).toISOString())) : null;
console.log('forceCostListsFetch: cloud summary', { cloudTs, finished: Array.isArray(d.finished) ? d.finished.length : 0, raw: Array.isArray(d.raw) ? d.raw.length : 0, pack: Array.isArray(d.pack) ? d.pack.length : 0, ops: Array.isArray(d.ops) ? d.ops.length : 0, doc: d });
} catch(e){ console.warn('forceCostListsFetch failed', e); }
};
function renderListsSummary(){
const el=document.getElementById('cost-lists-summary');
if(!el) return;
el.textContent=`المنتجات التامة: ${costFinished.length} — الخامات: ${costRaw.length} — تغليف: ${costPack.length}`;
}
function ensureFinishedFromState(){
try{
if(Array.isArray(costFinished) && costFinished.length===0){
const src=(Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
if(src && src.length){
src.forEach(p=> {
const id=p.id || p.code || ('prod-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'قطعة', price: Number(p.price||p.sellPrice||0) });
});
saveLists();
}
}
}catch(e){ console.warn('ensureFinishedFromState failed', e); }
}
function ensureRawAndPackFromState(){
try{
console.log('ensureRawAndPackFromState START: costRaw=' + (costRaw||[]).length + ', costPack=' + (costPack||[]).length);
if(Array.isArray(state && state.products) && state.products.length){
if(Array.isArray(costRaw) && costRaw.length===0){
state.products.forEach(p=> {
const cat=(p && p.category) ? String(p.category).toLowerCase() : '';
if(cat.includes('خام') || cat.includes('مكونات') || cat.includes('مادة')){
const id=p.id || p.code || ('raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
costRaw.push({ id, code: id, name: p.name || p.title || p.code || '', unit: p.unit || p.unitName || '' });
}
});
}
if(Array.isArray(costPack) && costPack.length===0){
state.products.forEach(p=> {
const cat=(p && p.category) ? String(p.category).toLowerCase() : '';
if(cat.includes('تعبئة') || cat.includes('تغليف') || cat.includes('عبوة') || cat.includes('كيس') || cat.includes('ورق')){
const id=p.id || p.code || ('pack-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
costPack.push({ id, code: id, name: p.name || p.title || p.code || '', unit: p.unit || p.unitName || '' });
}
});
}
if((Array.isArray(costRaw) && costRaw.length>0) || (Array.isArray(costPack) && costPack.length>0)){
try{ saveLists(true); }catch(_){ }
}
}
const builtInRaw=[
'لبن بودرة',
'بروتين مركز',
'بديل زبدة',
'هاى كريم 200',
'هاى كريم 100',
'اناتو',
'كلورفيل',
'S20',
'B3',
'نياسين',
'نتاميسين',
'سوربات بوتاسيوم',
'كلوريد كالسيوم',
'منفحة ميكروبية',
'GDL',
'ديرى جيل 121',
'ملح طعام',
'انتى فوم',
'نشا',
'مياه',
'كريمة جاموسى',
'كريمة بقرى',
'CR 15',
'فانيليا',
'مستكة',
'مياه ورد',
'هاى كريم 21',
'لاكته 810',
'ايس كريم بودرة',
'كريم شانتيه بودر',
'سكر',
'ارز',
'طعم الشيدر',
'طعم الرومى',
'طعم جودة',
'طعم النستو',
'ملح ليمون',
'خامات حفظ المش',
'صوص مش',
'صودا كاوية',
'طعم زبدة',
'طعم كريمة',
'لاكتة 815',
'لاكتة 825',
'اكسجين',
'كربونات',
'طعم حليب',
'بادى زبادى',
'هاى كريم 500',
'طعم قشطة',
'لبن خالى الدسم',
'طعم جبنة قديمة',
'حامض',
'سلفات صوديوم',
'طعم امنتال',
'طعم شيدر زبدة',
'بروكسايد',
'شطة حمراء',
'جبنه رومى مبشور',
'كريموس200',
'زيت عباد',
'لاكتة s33',
'طعم سمن بلدى',
'ستريك اسيد',
'معقم يد',
'اسيتون',
'مكسب طعم كريمة',
'لون شيكولاتة غامق'
];
const builtInPack=[
'استيكر قشطة','اطباق شرش','استيكر مش كريمى 3ك','استيكر مش كريمى 8ك','استيكر مش قطع 3ك','استيكر مش قطع 8ك','جردل فارغ 8ك','جردل فارغ 3ك','برطمان 800 جم','برطمان 500 جم','برطمان 300 جم','برطمان 200 جم','اكياس شفاف 27*45','شنط وسط سادة','شنط كبير سادة','شنط صغير سادة','اكياس لبن شفاف 1ك','اكياس لبن شفاف 2ك','اكياس لبن شفاف 500 جم','طبق بلاستيك 1ك','طبق بلاستيك 500 جم','علبة بلاستيك بالغطاء 250 جم','علبة بلاستيك بالغطاء 125 جم','مناديل 40*40','مناديل 70-70','رول استرتش 40سم','رول استرتش 10 سم','كيس معالق','كيس شرنك','علبة شفاف كبير','غطاء شفاف كبير','علبة عاشوراء سادة','غطاء عاشوراء سادة','كرتونة تعبأة','فخار زبادى','فخار ارز','علب زبادى بالغطاء','جوانتى علبة','جوانتى كيس','اوفر شوز','اوفر هيد باكت','كمامه','شراب','سلوتيب عريض','بكر باركود حرارى','باركود صغير للطباعه','باركود كبير للطباعه','فلتر محلب','ايس بوكس'
];
try{
let addedRaw=0;
const existingRawNames=new Set((costRaw||[]).map(x=> String((x && (x.name||x)) || '').trim().toLowerCase()));
builtInRaw.forEach((n,i)=> {
const key=String(n||'').trim().toLowerCase();
if(!key) return;
if(!existingRawNames.has(key)){
const id='builtinraw-' + i + '-' + Date.now().toString(36).slice(4);
costRaw.push({ id, code: id, name: n, unit: '' });
existingRawNames.add(key);
addedRaw++;
}
});
let addedPack=0;
const existingPackNames=new Set((costPack||[]).map(x=> String((x && (x.name||x)) || '').trim().toLowerCase()));
builtInPack.forEach((n,i)=> {
const key=String(n||'').trim().toLowerCase();
if(!key) return;
if(!existingPackNames.has(key)){
const id='builtinpack-' + i + '-' + Date.now().toString(36).slice(4);
costPack.push({ id, code: id, name: n, unit: '' });
existingPackNames.add(key);
addedPack++;
}
});
if(addedRaw>0 || addedPack>0){
try{ saveLists(true); }catch(_){ }
console.log('ensureRawAndPackFromState: added built-in items', { addedRaw, addedPack, totalRaw: (costRaw||[]).length, totalPack: (costPack||[]).length });
}
try { window.costRaw=costRaw; window.costPack=costPack; } catch(_){ }
console.log('Cost lists synced to window. Totals:', 'costRaw=' + (costRaw||[]).length, 'costPack=' + (costPack||[]).length);
try { window.__costListsReady=true; } catch(_){}
try {
const r=(costRaw||[]).length, p=(costPack||[]).length, f=(window.costFinished||[]).length;
if ((r + p + f) > 0) {
setTimeout(()=> { try { if (typeof saveLists==='function') saveLists(false); } catch(_){} }, 400);
}
} catch(_){}
}catch(e){ console.warn('ensureRawAndPackFromState built-in merge failed', e); }
}catch(e){ console.warn('ensureRawAndPackFromState failed', e); }
}
try {
window.importCostListsFromStockControl=function(){
try{
ensureRawAndPackFromState();
console.log('importCostListsFromStockControl: done.');
} catch(e) { console.warn('importCostListsFromStockControl failed', e); }
};
window.clearCostListsAndReimport=function(){
try {
console.log('Clearing cost lists from localStorage and re-importing...');
localStorage.removeItem('cost_raw');
localStorage.removeItem('cost_pack');
costRaw=[];
costPack=[];
window.costRaw=[];
window.costPack=[];
try{ if (typeof loadLists==='function') loadLists(); }catch(_){ }
try{ if (typeof loadLists==='function') loadLists(); }catch(_){ }
try{ ensureRawAndPackFromState(); }catch(_){ }
console.log('Re-import complete. Totals:', 'costRaw=' + (window.costRaw||[]).length, 'costPack=' + (window.costPack||[]).length);
} catch(e) { console.warn('clearCostListsAndReimport failed', e); }
};
} catch(e) {}
function renderProductSelect(){
const sel=document.getElementById('cost-product-select');
if(!sel) return;
const prev=sel.value;
sel.innerHTML='<option value="">اختر منتج تام...</option>' + costFinished.map(p=> `<option value="${escapeHtml(p.id||p.code||p.name)}">${escapeHtml(p.name||p.code)}</option>`).join('');
if(prev) sel.value=prev;
}
function renderProductList(filter){
const container=document.getElementById('cost-product-list'); if(!container) return;
container.innerHTML='';
const q=String(filter || '').trim().toLowerCase();
const items=(costFinished || []).filter(p=> {
if(!q) return true;
return (String(p.name||'').toLowerCase().includes(q) || String(p.code||'').toLowerCase().includes(q));
});
if(items.length===0){ container.innerHTML='<div class="p-2 text-sm text-gray-500">لا توجد منتجات</div>'; return; }
items.forEach(p=> {
const el=document.createElement('div');
el.className='p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center';
el.innerHTML=`<div><div class="font-medium text-sm">${escapeHtml(p.name)}</div><div class="text-xs text-gray-500">${escapeHtml(p.code||'')}</div></div><div><button class="select-product-btn bg-blue-500 text-white px-2 py-1 rounded" data-id="${escapeHtml(p.id)}">اختار</button></div>`;
container.appendChild(el);
});
}
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function openManageListsModal(){
console.log('openManageListsModal: start');
const m=document.getElementById('manage-lists-modal');
if(m){ m.classList.remove('modal-hidden'); m.classList.add('modal-visible'); }
setTimeout(()=>{ try{ console.log('openManageListsModal: calling renderManageListsTables'); renderManageListsTables(); }catch(e){ console.warn('renderManageListsTables failed', e); } }, 40);
}
function closeManageListsModal(){ const m=document.getElementById('manage-lists-modal'); if(m){ m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); } }
try{ window.openManageListsModal=openManageListsModal; window.closeManageListsModal=closeManageListsModal; }catch(e){}
function renderManageListsTables(){
const progressEl=document.getElementById('manage-lists-progress');
const totalItems=(Array.isArray(costFinished)?costFinished.length:0) + (Array.isArray(costRaw)?costRaw.length:0) + (Array.isArray(costPack)?costPack.length:0);
let processed=0;
if(progressEl){
if(totalItems===0){ progressEl.style.display='none'; } else { progressEl.style.display='block'; progressEl.textContent=`جارٍ تحميل العناصر 0 / ${totalItems}`; }
}
function chunkRender(items, tbody, rowRenderer, firstSync=10, batchSize=20){
tbody.innerHTML='';
if(!items || items.length===0) return;
let i=0;
const initial=Math.min(firstSync, items.length);
const t0=Date.now();
for(; i < initial; i++){
const tr=rowRenderer(items[i]);
tbody.appendChild(tr);
processed++;
}
const t1=Date.now();
console.log('chunkRender: initial batch', { initial, timeMs: t1 - t0, processed, totalItems });
if(progressEl) progressEl.textContent=`جارٍ تحميل العناصر ${processed} / ${totalItems}`;
if(i >=items.length) return;
function nextBatch(){
const batchStart=Date.now();
const end=Math.min(i + batchSize, items.length);
let batchCount=0;
for(; i < end; i++){
const tr=rowRenderer(items[i]);
tbody.appendChild(tr);
processed++; batchCount++;
}
const batchEnd=Date.now();
console.log('chunkRender: batch appended', { batchCount, timeMs: batchEnd - batchStart, processed, totalItems });
if(progressEl) progressEl.textContent=`جارٍ تحميل العناصر ${processed} / ${totalItems}`;
if(i < items.length){
setTimeout(nextBatch, 25);
}
}
setTimeout(nextBatch, 25);
}
console.log('renderManageListsTables: starting render', { finished: costFinished.length, raw: costRaw.length, pack: costPack.length });
const tf=document.querySelector('#manage-finished-table tbody');
if(tf){ chunkRender(costFinished, tf, it=> {
const tr=document.createElement('tr');
tr.innerHTML=`<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.price||it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="finished" data-id="${escapeHtml(it.id)}">حذف</button></td>`;
return tr;
}, 10, 20);
}
const trw=document.querySelector('#manage-raw-table tbody');
if(trw){ chunkRender(costRaw, trw, it=> {
const tr=document.createElement('tr');
tr.innerHTML=`<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="raw" data-id="${escapeHtml(it.id)}">حذف</button></td>`;
return tr;
}, 10, 20);
}
const tpk=document.querySelector('#manage-pack-table tbody');
if(tpk){ chunkRender(costPack, tpk, it=> {
const tr=document.createElement('tr');
tr.innerHTML=`<td class="px-2 py-1 text-right">${escapeHtml(it.name||'')}</td><td class="px-2 py-1 text-center">${escapeHtml(it.unit||'')}</td><td class="px-2 py-1 text-center">${Number(it.cost||0).toFixed(2)}</td><td class="px-2 py-1 text-center"><button class="manage-del-btn bg-red-500 text-white px-2 rounded" data-list="pack" data-id="${escapeHtml(it.id)}">حذف</button></td>`;
return tr;
}, 10, 20);
}
const poll=setInterval(()=> {
if(processed >=totalItems){
clearInterval(poll);
if(progressEl) { progressEl.textContent=`اكتمل التحميل (${totalItems} عنصر)`; setTimeout(()=>{ if(progressEl) progressEl.style.display='none'; }, 700); }
console.log('renderManageListsTables: finished rendering all items', { totalItems });
}
}, 200);
}
function deleteListItem(listName, id){
if(!confirm('هل أنت متأكد من حذف هذا العنصر؟')) return;
if(listName==='finished'){ costFinished=costFinished.filter(x=>String(x.id)!==String(id)); }
if(listName==='raw'){ costRaw=costRaw.filter(x=>String(x.id)!==String(id)); }
if(listName==='pack'){ costPack=costPack.filter(x=>String(x.id)!==String(id)); }
saveLists(); renderManageListsTables();
}
function exportLists(){ const payload={ finished: costFinished, raw: costRaw, pack: costPack, exportedAt: new Date().toISOString() }; const dataStr='data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a=document.createElement('a'); a.href=dataStr; a.download='cost-lists-export.json'; document.body.appendChild(a); a.click(); a.remove(); }
document.addEventListener('click', function(e){
if(e.target && e.target.id==='manage-export-btn'){ exportLists(); }
const delBtn=e.target && e.target.closest && e.target.closest('.manage-del-btn');
if(delBtn){ const list=delBtn.getAttribute('data-list'); const id=delBtn.getAttribute('data-id'); if(list && id) deleteListItem(list, id); }
});
function renderRawPriceTable(){
const tbody=document.querySelector('#raw-price-table tbody'); if(!tbody) return;
tbody.innerHTML='';
(costRaw || []).forEach(it=> {
const last=(it.lastPrice !==undefined && it.lastPrice !==null) ? it.lastPrice : (it.cost !==undefined ? it.cost : '');
const date=it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
const tr=document.createElement('tr');
tr.innerHTML=`<td class="px-2 py-1 text-right"><input class="raw-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="raw-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center raw-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="raw-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">حفظ</button></td>`;
tbody.appendChild(tr);
});
}
function renderFinishedPriceTable(){
const tbody=document.querySelector('#finished-price-table tbody'); if(!tbody) return;
tbody.innerHTML='';
(costFinished || []).forEach(it=> {
const last=(it.lastPrice !==undefined && it.lastPrice !==null) ? it.lastPrice : (it.price !==undefined ? it.price : '');
const date=it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
const tr=document.createElement('tr');
tr.innerHTML=`<td class="px-2 py-1 text-right"><input class="finished-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="finished-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center finished-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="finished-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">حفظ</button></td>`;
tbody.appendChild(tr);
});
}
function renderPackPriceTable(){
const tbody=document.querySelector('#pack-price-table tbody'); if(!tbody) return;
tbody.innerHTML='';
(costPack || []).forEach(it=> {
const last=(it.lastPrice !==undefined && it.lastPrice !==null) ? it.lastPrice : (it.cost !==undefined ? it.cost : '');
const date=it.lastPriceDate ? (new Date(it.lastPriceDate)).toLocaleString() : '';
const tr=document.createElement('tr');
tr.innerHTML=`<td class="px-2 py-1 text-right"><input class="pack-name-input w-full p-1" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.name||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-unit-input w-24 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(it.unit||'')}"></td><td class="px-2 py-1 text-center"><input class="pack-price-input w-28 p-1 text-center" data-id="${escapeHtml(it.id)}" value="${escapeHtml(last)}"></td><td class="px-2 py-1 text-center pack-price-date">${escapeHtml(date)}</td><td class="px-2 py-1 text-center"><button class="pack-price-save-btn bg-blue-600 text-white px-2 rounded" data-id="${escapeHtml(it.id)}">حفظ</button></td>`;
tbody.appendChild(tr);
});
}
function pmFormatDate(iso){ try { return iso ? new Date(iso).toLocaleString('ar-EG') : ''; } catch(_){ return ''; } }
function getListByType(t){ return t==='raw'?costRaw : (t==='pack'?costPack : (t==='finished'?costFinished : costOps)); }
function setListByType(t, arr){ if(t==='raw') costRaw=arr; else if(t==='pack') costPack=arr; else if(t==='finished') costFinished=arr; else costOps=arr; }
try { window.getListByType=getListByType; window.setListByType=setListByType; } catch(_){ }
function showTransientMessage(msg, ms){
try{
const id='transient-msg';
let el=document.getElementById(id);
if(!el){
el=document.createElement('div'); el.id=id;
el.style.position='fixed'; el.style.right='16px'; el.style.top='70px'; el.style.zIndex=9999;
el.style.background='rgba(0,0,0,0.8)'; el.style.color='#fff'; el.style.padding='8px 12px'; el.style.borderRadius='6px'; el.style.fontSize='13px';
document.body.appendChild(el);
}
el.textContent=msg;
el.style.display='block';
if(ms && ms>0){ setTimeout(()=>{ try{ el.style.display='none'; }catch(_){ } }, ms); }
}catch(_){ console.log(msg); }
}
document.addEventListener('costListsSavedToCloud', function(ev){
try{
console.log('✅ تم حفظ السعر في السحابة', ev && ev.detail);
showTransientMessage('✅ تم حفظ السعر في السحابة', 2500);
try{
const lastId=window.__lastRawEditedId || null;
if(lastId){
let rawJson=null;
try{ rawJson=localStorage.getItem('cost_raw'); }catch(_){ }
let parsed=null;
try{ parsed=rawJson ? JSON.parse(rawJson) : null; }catch(_){ parsed=null; }
const found=Array.isArray(parsed) ? parsed.find(x=>String(x.id)===String(lastId)) : null;
console.log('🔍 post-cloud-save: lastRawEditedId=', lastId, 'inMemory=', (costRaw||[]).find(x=>String(x.id)===String(lastId)), 'localStorage=', found, 'rawLength=', (parsed||[]).length);
}
}catch(_){ }
}catch(_){ }
});
document.addEventListener('keydown', function(e){
if(!e) return;
const key=e.key || (e.keyCode ? (e.keyCode===13 ? 'Enter' : '') : '');
if(key !=='Enter') return;
const target=e.target || document.activeElement;
if(!target) return;
if(target.classList && target.classList.contains('raw-price-input')){
const id=target.getAttribute('data-id');
if(id){
try{ console.log('⏎ Enter pressed in raw input, saving...', { id }); }catch(_){ }
try{ showTransientMessage('جاري حفظ السعر في السحابة...', 2000); }catch(_){ }
try{ saveRawPriceRow(id); }catch(err){ console.warn('saveRawPriceRow failed', err); }
}
}
});
function openPriceHistory(type, id){
const list=getListByType(type);
const it=list.find(x=> String(x.id)===String(id));
if(!it) return alert('العنصر غير موجود');
const modal=document.getElementById('price-history-modal'); if(!modal) return;
const title=modal.querySelector('#ph-title');
const tbody=modal.querySelector('#ph-body');
if(title) title.textContent=`سجل الأسعار — ${it.name||id}`;
const esc=s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const hist=Array.isArray(it.priceHistory)? it.priceHistory : [];
tbody.innerHTML=hist.length ? hist.map(h=> `<tr><td class="px-2 py-1 text-center">${Number(h.price||0).toFixed(2)}</td><td class="px-2 py-1 text-center">${esc(pmFormatDate(h.date))}</td><td class="px-2 py-1 text-right">${esc(h.note||'')}</td></tr>`).join('') : '<tr><td colspan="3" class="px-2 py-3 text-center text-gray-500">لا يوجد سجل أسعار</td></tr>';
modal.setAttribute('data-type', type);
modal.setAttribute('data-id', id);
modal.classList.remove('modal-hidden');
modal.classList.add('modal-visible');
}
function closePriceHistory(){ const m=document.getElementById('price-history-modal'); if(!m) return; m.classList.add('modal-hidden'); m.classList.remove('modal-visible'); }
function addPriceFromModal(){
const m=document.getElementById('price-history-modal'); if(!m) return;
const type=m.getAttribute('data-type'); const id=m.getAttribute('data-id');
const priceInp=m.querySelector('#ph-new-price'); const noteInp=m.querySelector('#ph-new-note');
const v=parseFloat(priceInp.value||0) || 0; const note=noteInp.value.trim();
const list=getListByType(type); const it=list.find(x=> String(x.id)===String(id)); if(!it) return;
const now=new Date().toISOString();
it.lastPrice=v; it.lastPriceDate=now;
it.priceHistory=Array.isArray(it.priceHistory) ? it.priceHistory : [];
it.priceHistory.unshift({ price: v, date: now, note });
saveLists(); 
openPriceHistory(type, id);
priceInp.value=''; noteInp.value='';
}
document.addEventListener('click', function(e){
const histBtn=e.target && e.target.closest && e.target.closest('.pm-view-history'); if(histBtn){ openPriceHistory(histBtn.getAttribute('data-type'), histBtn.getAttribute('data-id')); }
if(e.target && e.target.id==='ph-close-btn'){ closePriceHistory(); }
if(e.target && e.target.id==='ph-add-btn'){ addPriceFromModal(); }
});
function waitForDbReady(timeoutMs=5000){
return new Promise((resolve, reject)=> {
const start=Date.now();
if (window.db) return resolve(window.db);
const iv=setInterval(()=> {
if (window.db) { clearInterval(iv); return resolve(window.db); }
if (Date.now() - start > timeoutMs) { clearInterval(iv); return reject(new Error('DB ready timeout')); }
}, 150);
});
}
document.addEventListener('DOMContentLoaded', function(){ 
try {
const keysToClean=['cost_raw', 'cost_pack', 'cost_finished', 'cost_ops'];
keysToClean.forEach(key=> {
const val=localStorage.getItem(key);
if (val==='undefined' || val==='null') {
console.log(`🧹 Cleaned corrupted localStorage key: ${key} (was: ${val})`);
localStorage.removeItem(key);
}
});
} catch(e){ console.warn('localStorage cleanup failed', e); }
console.log('📋 DOMContentLoaded: Initializing cost lists (cloud-first realtime listener)...');
try {
waitForDbReady(3000).then(()=> {
try {
initRealtimeSync();
} catch(e){ console.warn('⚠️ DOMContentLoaded: initRealtimeSync() failed', e); }
}).catch(err=> {
console.warn('⚠️ DOMContentLoaded: DB not ready, skipping realtime listener:', err);
try { if (!window.dataLoaded) { console.log('⚠️ No cloud data yet, falling back to local cache for UI rendering'); loadLists(); } } catch(e){ console.warn('⚠️ fallback loadLists failed', e); }
try { tryLoadCostListsFromCloud().catch(()=>{}); } catch(_){ }
});
setTimeout(()=> {
try {
if (!window.dataLoaded) {
console.log('⚠️ No cloud data yet (post-wait), falling back to local cache for UI rendering');
try { loadLists(); } catch(e){ console.warn('⚠️ fallback loadLists failed', e); }
try { tryLoadCostListsFromCloud().catch(()=>{}); } catch(_){ }
}
} catch(_){ }
}, 1200);
} catch(e){ console.warn('⚠️ DOMContentLoaded: cost lists cloud-first init failed', e); }
});
function renderUnifiedPriceGrid(){
const wrap=document.getElementById('unified-price-grid-block'); if(!wrap) return;
const tbody=document.querySelector('#unified-price-grid tbody'); if(!tbody) return;
const esc=s=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const all=[];
(window.costRaw || []).forEach(it=> all.push({type:'خامة', item:it}));
(window.costPack || []).forEach(it=> all.push({type:'تغليف', item:it}));
(window.costOps || []).forEach(it=> all.push({type:'تشغيل', item:it}));
(window.costFinished || []).forEach(it=> all.push({type:'منتج نهائي', item:it}));
all.sort((a,b)=> {
const typeCmp=a.type.localeCompare(b.type,'ar');
if(typeCmp !==0) return typeCmp;
return String(a.item.name||'').localeCompare(String(b.item.name||''),'ar');
});
tbody.innerHTML=all.map(row=> {
const it=row.item;
const last=(it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:''));
const date=it.lastPriceDate ? pmFormatDate(it.lastPriceDate) : '';
return `<tr>
<td class="px-2 py-1 text-right">${esc(it.name||'')}</td>
<td class="px-2 py-1 text-center">
<span class="unified-code inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${esc(it.code||it.id||'')}</span>
</td>
<td class="px-2 py-1 text-center">${esc(row.type)}</td>
<td class="px-2 py-1 text-center">${esc(it.unit||'')}</td>
<td class="px-2 py-1 text-center">
<span class="unified-current-price inline-block min-w-[64px] px-1 py-0.5 border rounded bg-white" contenteditable="true" data-type="${esc(row.type)}" data-id="${esc(it.id)}">${last!==''?Number(last).toFixed(2):''}</span>
</td>
<td class="px-2 py-1 text-center">
<div class="flex items-center justify-center gap-1">
<input class="unified-new-price w-20 p-1 border rounded text-center text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}" placeholder="0.00" />
<button class="unified-save-price bg-blue-600 text-white px-2 py-0.5 rounded text-[11px]" data-type="${esc(row.type)}" data-id="${esc(it.id)}">حفظ</button>
</div>
</td>
<td class="px-2 py-1 text-center">${esc(date)}</td>
</tr>`;
}).join('');
const sumEl=document.getElementById('unified-grid-summary');
if(sumEl) sumEl.textContent=`الإجمالي: ${all.length} عنصر`;
}
function unifiedExportJSON(){
const payload={ raw: costRaw, pack: costPack, ops: costOps, exportedAt: new Date().toISOString() };
const dataStr='data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
const a=document.createElement('a'); a.href=dataStr; a.download='unified-prices.json'; document.body.appendChild(a); a.click(); a.remove();
}
function unifiedExportCSV(){
const rows=[];
rows.push(['type','name','unit','currentPrice','lastDate']);
const pushRows=(arr,type)=> (arr||[]).forEach(it=> rows.push([
type,
(it.name||'').replace(/\n/g,' '),
it.unit||'',
(it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
it.lastPriceDate||''
]));
pushRows(costRaw,'raw'); pushRows(costPack,'pack'); pushRows(costOps,'ops');
const csv=rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download='unified-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
setTimeout(()=> URL.revokeObjectURL(url), 2000);
}
function unifiedPrint(){
const block=document.getElementById('unified-price-grid-block'); if(!block) return window.print();
const wasOpen=block.open; block.open=true; renderUnifiedPriceGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open=false; }, 50);
}
function rawUnifiedExportJSON(){
const payload={ raw: costRaw, exportedAt: new Date().toISOString() };
const dataStr='data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
const a=document.createElement('a'); a.href=dataStr; a.download='raw-prices.json'; document.body.appendChild(a); a.click(); a.remove();
}
function rawUnifiedExportCSV(){
const rows=[];
rows.push(['name','unit','currentPrice','lastDate']);
(costRaw||[]).forEach(it=> rows.push([
(it.name||'').replace(/\n/g,' '),
it.unit||'',
(it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
it.lastPriceDate||''
]));
const csv=rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download='raw-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
setTimeout(()=> URL.revokeObjectURL(url), 2000);
}
function rawUnifiedPrint(){
const block=document.getElementById('raw-unified-grid-block'); if(!block) return window.print();
const wasOpen=block.open; block.open=true; renderRawUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open=false; }, 50);
}
function packUnifiedExportJSON(){
const payload={ pack: costPack, exportedAt: new Date().toISOString() };
const dataStr='data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
const a=document.createElement('a'); a.href=dataStr; a.download='pack-prices.json'; document.body.appendChild(a); a.click(); a.remove();
}
function packUnifiedExportCSV(){
const rows=[];
rows.push(['name','unit','currentPrice','lastDate']);
(costPack||[]).forEach(it=> rows.push([
(it.name||'').replace(/\n/g,' '),
it.unit||'',
(it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
it.lastPriceDate||''
]));
const csv=rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download='pack-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
setTimeout(()=> URL.revokeObjectURL(url), 2000);
}
function packUnifiedPrint(){
const block=document.getElementById('pack-unified-grid-block'); if(!block) return window.print();
const wasOpen=block.open; block.open=true; renderPackUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open=false; }, 50);
}
function opsUnifiedExportJSON(){
const payload={ ops: costOps, exportedAt: new Date().toISOString() };
const dataStr='data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
const a=document.createElement('a'); a.href=dataStr; a.download='ops-prices.json'; document.body.appendChild(a); a.click(); a.remove();
}
function opsUnifiedExportCSV(){
const rows=[];
rows.push(['name','unit','currentPrice','lastDate']);
(costOps||[]).forEach(it=> rows.push([
(it.name||'').replace(/\n/g,' '),
it.unit||'',
(it.lastPrice!=null?it.lastPrice:(it.cost!=null?it.cost:'')),
it.lastPriceDate||''
]));
const csv=rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download='ops-prices.csv'; document.body.appendChild(a); a.click(); a.remove();
setTimeout(()=> URL.revokeObjectURL(url), 2000);
}
function opsUnifiedPrint(){
const block=document.getElementById('ops-unified-grid-block'); if(!block) return window.print();
const wasOpen=block.open; block.open=true; renderOpsUnifiedGrid(); setTimeout(()=>{ window.print(); if(!wasOpen) block.open=false; }, 50);
}
function showSavedIndicator(el, text){
try{
const label=document.createElement('span');
label.className='unified-saved-indicator';
label.style.cssText='display:inline-block;margin-left:8px;color:#16a34a;font-size:12px;font-weight:600;opacity:0;transition:opacity .18s';
label.textContent=text || 'تم الحفظ';
if(el && el.parentNode){
const existing=el.parentNode.querySelector('.unified-saved-indicator');
if(existing) existing.remove();
el.parentNode.appendChild(label);
setTimeout(()=> label.style.opacity='1', 20);
setTimeout(()=> { label.style.opacity='0'; setTimeout(()=> { try{ label.remove(); }catch(_){ } }, 220); }, 1400);
}
}catch(e){ console.warn('showSavedIndicator failed', e); }
}
document.addEventListener('click', function(e){
if(e.target && e.target.id==='unified-refresh-btn'){ renderUnifiedPriceGrid(); }
if(e.target && e.target.id==='unified-export-json-btn'){ unifiedExportJSON(); }
if(e.target && e.target.id==='unified-export-csv-btn'){ unifiedExportCSV(); }
if(e.target && e.target.id==='unified-print-btn'){ unifiedPrint(); }
const inlineBtn=e.target && e.target.closest && e.target.closest('.unified-save-price');
if(inlineBtn){
const typeLabel=inlineBtn.getAttribute('data-type');
const id=inlineBtn.getAttribute('data-id');
const inp=document.querySelector(`.unified-new-price[data-id="${CSS.escape(id)}"][data-type="${CSS.escape(typeLabel)}"]`);
if(!inp) return;
const rawVal=inp.value.trim(); 
if(rawVal==='') { alert('ادخل السعر الجديد'); return; }
const num=parseFloat(rawVal); 
if(isNaN(num)){ alert('سعر غير صالح'); return; }
const mapType=t=> t==='خامة'?'raw': (t==='تغليف'?'pack': (t==='تشغيل'?'ops': (t==='منتج نهائي'?'finished':'raw')));
const tKey=mapType(typeLabel);
const list=getListByType(tKey) || [];
const it=list.find(x=> String(x.id)===String(id)); 
if(!it){ alert('العنصر غير موجود'); return; }
console.log('💾 Inline save price button clicked:', {typeLabel, id, newPrice: num});
const now=new Date().toISOString();
it.lastPrice=num; 
it.lastPriceDate=now; 
it.priceHistory=Array.isArray(it.priceHistory)? it.priceHistory : []; 
it.priceHistory.unshift({ price: num, date: now, note: 'شبكة موحدة' });
saveLists(); 
renderUnifiedPriceGrid();
inp.value='';
console.log('✅ Price saved and grid refreshed');
console.log('✅ Price saved and grid refreshed');
}
});
function __commitUnifiedCode(el){
if(!el) return;
const typeLabel=el.getAttribute('data-type');
const id=el.getAttribute('data-id');
const txt=(el.textContent||'').trim();
console.log('✏️ Editing code:', {typeLabel, id, newCode: txt});
const mapType=t=> t==='خامة'?'raw': (t==='تغليف'?'pack': (t==='تشغيل'?'ops': (t==='منتج نهائي'?'finished':'raw')));
const tKey=mapType(typeLabel);
const list=getListByType(tKey) || [];
const it=list.find(x=> String(x.id)===String(id)); 
if(!it) { console.warn('❌ Item not found for code edit'); return; }
if ((it.code||'')===txt) { console.log('↩️ Code unchanged'); return; }
it.code=txt;
console.log('💾 Committing code change to storage...');
saveLists(); 
renderUnifiedPriceGrid();
}
document.addEventListener('focusin', function(e){
const span=e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
});
document.addEventListener('keydown', function(e){
const span=e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
if(span && e.key==='Enter'){
e.preventDefault(); __commitUnifiedCode(span);
try { span.blur(); } catch(_){}
}
});
document.addEventListener('focusout', function(e){
const span=e.target && e.target.classList && e.target.classList.contains('unified-code') ? e.target : null;
if(span){ __commitUnifiedCode(span); }
});
function __commitUnifiedCurrentPrice(el){
if(!el) return;
const typeLabel=el.getAttribute('data-type');
const id=el.getAttribute('data-id');
const txt=(el.textContent||'').trim(); 
if(txt==='') { console.log('↩️ Price empty, ignoring'); return; } 
const val=parseFloat(txt);
if(isNaN(val)) { 
console.warn('❌ Invalid price value:', txt);
el.textContent=el.getAttribute('data-prev') || el.textContent; 
return; 
}
console.log('💰 Editing price:', {typeLabel, id, newPrice: val});
const mapType=t=> t==='خامة'?'raw': (t==='تغليف'?'pack': (t==='تشغيل'?'ops': (t==='منتج نهائي'?'finished':'raw')));
const tKey=mapType(typeLabel);
const list=getListByType(tKey) || [];
const it=list.find(x=> String(x.id)===String(id)); 
if(!it) { console.warn('❌ Item not found for price edit'); return; }
const prev=(it.lastPrice!=null?Number(it.lastPrice):(it.cost!=null?Number(it.cost):null));
if(prev!=null && Number(prev).toFixed(2)===Number(val).toFixed(2)) { 
console.log('↩️ Price unchanged');
el.textContent=Number(prev).toFixed(2); 
return; 
}
const now=new Date().toISOString();
it.lastPrice=val; 
it.lastPriceDate=now; 
it.priceHistory=Array.isArray(it.priceHistory)? it.priceHistory : []; 
it.priceHistory.unshift({ price: val, date: now, note: 'تعديل مباشر' });
console.log('💾 Committing price change to storage...', {oldPrice: prev, newPrice: val});
saveLists(); 
el.textContent=Number(val).toFixed(2);
showSavedIndicator(el);
}
document.addEventListener('focusin', function(e){
const span=e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
if(span){ span.setAttribute('data-prev', (span.textContent||'').trim()); }
});
document.addEventListener('keydown', function(e){
const span=e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
if(span && e.key==='Enter'){
e.preventDefault(); __commitUnifiedCurrentPrice(span);
try { span.blur(); } catch(_){}
}
});
document.addEventListener('focusout', function(e){
const span=e.target && e.target.classList && e.target.classList.contains('unified-current-price') ? e.target : null;
if(span){ __commitUnifiedCurrentPrice(span); }
});
function saveRawPriceRow(id){
try{
console.log('🔧 saveRawPriceRow: entering', { id });
const safeId=CSS && CSS.escape ? CSS.escape(id) : id;
const inp=document.querySelector(`.raw-price-input[data-id="${safeId}"]`);
if(!inp){ console.warn('saveRawPriceRow: input not found for id', id); return; }
const v=parseFloat(inp.value || 0) || 0;
const itIndex=costRaw.findIndex(x=> String(x.id)===String(id));
const it=itIndex >=0 ? costRaw[itIndex] : null;
if(!it) { console.warn('saveRawPriceRow: item not found in costRaw', id); return alert('العنصر غير موجود'); }
const nameInp=document.querySelector(`.raw-name-input[data-id="${safeId}"]`);
const unitInp=document.querySelector(`.raw-unit-input[data-id="${safeId}"]`);
if(nameInp) it.name=nameInp.value.trim();
if(unitInp) it.unit=unitInp.value.trim();
const prev=it.lastPrice !==undefined ? Number(it.lastPrice) : (it.cost||0);
console.log('🔧 saveRawPriceRow: before change', { id, prev, newValue: v });
if(v !==prev){
it.lastPrice=v; it.lastPriceDate=new Date().toISOString(); it.priceHistory=it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate });
costRaw[itIndex]=it;
try{ window.__lastRawEditedId=id; }catch(_){ }
console.log('🔧 saveRawPriceRow: item updated in memory', it);
} else {
console.log('🔧 saveRawPriceRow: price unchanged for', id);
}
saveLists();
try{ console.log('🔍 saveRawPriceRow: localStorage cost_raw snapshot length', (localStorage.getItem('cost_raw')||'').length); }catch(_){ }
renderRawPriceTable();
renderProductSelect();
try{ updateBomRowsAfterPriceChange(id, 'raw'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
}catch(e){ console.warn('saveRawPriceRow: unexpected error', e); }
}
function saveFinishedPriceRow(id){
const inp=document.querySelector(`.finished-price-input[data-id="${id}"]`);
if(!inp) return;
const v=parseFloat(inp.value || 0) || 0;
const it=costFinished.find(x=> String(x.id)===String(id));
if(!it) return alert('العنصر غير موجود');
const nameInp=document.querySelector(`.finished-name-input[data-id="${id}"]`);
const unitInp=document.querySelector(`.finished-unit-input[data-id="${id}"]`);
if(nameInp) it.name=nameInp.value.trim();
if(unitInp) it.unit=unitInp.value.trim();
const prev=it.lastPrice !==undefined ? Number(it.lastPrice) : (it.price||0);
if(v !==prev){ it.lastPrice=v; it.lastPriceDate=new Date().toISOString(); it.priceHistory=it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
saveLists(); renderFinishedPriceTable(); renderProductSelect();
try{ updateBomRowsAfterPriceChange(id, 'finished'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
}
function savePackPriceRow(id){
const inp=document.querySelector(`.pack-price-input[data-id="${id}"]`);
if(!inp) return;
const v=parseFloat(inp.value || 0) || 0;
const it=costPack.find(x=> String(x.id)===String(id));
if(!it) return alert('العنصر غير موجود');
const nameInp=document.querySelector(`.pack-name-input[data-id="${id}"]`);
const unitInp=document.querySelector(`.pack-unit-input[data-id="${id}"]`);
if(nameInp) it.name=nameInp.value.trim();
if(unitInp) it.unit=unitInp.value.trim();
const prev=it.lastPrice !==undefined ? Number(it.lastPrice) : (it.cost||0);
if(v !==prev){ it.lastPrice=v; it.lastPriceDate=new Date().toISOString(); it.priceHistory=it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); }
saveLists(); renderPackPriceTable(); renderProductSelect();
try{ updateBomRowsAfterPriceChange(id, 'pack'); }catch(e){console.warn('updateBomRowsAfterPriceChange failed', e);}
}
function saveAllPrices(){
let changed=0;
const changedIds=new Set();
Array.from(document.querySelectorAll('.finished-price-input')).forEach(inp=> {
const id=inp.getAttribute('data-id');
const v=parseFloat(inp.value || 0) || 0;
const it=costFinished.find(x=> String(x.id)===String(id));
if(!it) return;
const nameInp=document.querySelector(`.finished-name-input[data-id="${id}"]`);
const unitInp=document.querySelector(`.finished-unit-input[data-id="${id}"]`);
if(nameInp) it.name=nameInp.value.trim();
if(unitInp) it.unit=unitInp.value.trim();
const prev=it.lastPrice !==undefined ? Number(it.lastPrice) : (it.price||0);
if(v !==prev){ it.lastPrice=v; it.lastPriceDate=new Date().toISOString(); it.priceHistory=it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
});
Array.from(document.querySelectorAll('.raw-price-input')).forEach(inp=> {
const id=inp.getAttribute('data-id');
const v=parseFloat(inp.value || 0) || 0;
const it=costRaw.find(x=> String(x.id)===String(id));
if(!it) return;
const nameInp=document.querySelector(`.raw-name-input[data-id="${id}"]`);
const unitInp=document.querySelector(`.raw-unit-input[data-id="${id}"]`);
if(nameInp) it.name=nameInp.value.trim();
if(unitInp) it.unit=unitInp.value.trim();
const prev=it.lastPrice !==undefined ? Number(it.lastPrice) : (it.cost||0);
if(v !==prev){ it.lastPrice=v; it.lastPriceDate=new Date().toISOString(); it.priceHistory=it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
});
Array.from(document.querySelectorAll('.pack-price-input')).forEach(inp=> {
const id=inp.getAttribute('data-id');
const v=parseFloat(inp.value || 0) || 0;
const it=costPack.find(x=> String(x.id)===String(id));
if(!it) return;
const nameInp=document.querySelector(`.pack-name-input[data-id="${id}"]`);
const unitInp=document.querySelector(`.pack-unit-input[data-id="${id}"]`);
if(nameInp) it.name=nameInp.value.trim();
if(unitInp) it.unit=unitInp.value.trim();
const prev=it.lastPrice !==undefined ? Number(it.lastPrice) : (it.cost||0);
if(v !==prev){ it.lastPrice=v; it.lastPriceDate=new Date().toISOString(); it.priceHistory=it.priceHistory || []; it.priceHistory.unshift({ price: v, date: it.lastPriceDate }); changed++; changedIds.add(id); }
});
if(changed > 0){ saveLists(); renderRawPriceTable(); renderFinishedPriceTable(); renderPackPriceTable(); renderProductSelect();
try{ changedIds.forEach(i=> updateBomRowsAfterPriceChange(i)); }catch(e){console.warn('updateBomRowsAfterPriceChange bulk failed', e); }
alert('تم حفظ ' + changed + ' سعراً.');
} else alert('لا تغييرات للحفظ.');
}
function updateBomRowsAfterPriceChange(itemId, listType){
try{
const auto=document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
if(!auto) return;
if(!itemId) return;
const tbody=document.getElementById('cost-bom-body'); if(!tbody) return;
const findPrice=(id)=> {
let found=(costRaw||[]).find(x=>String(x.id)===String(id)) || (costPack||[]).find(x=>String(x.id)===String(id)) || (costFinished||[]).find(x=>String(x.id)===String(id));
if(!found) return 0;
return Number(found.lastPrice !==undefined && found.lastPrice !==null ? found.lastPrice : (found.cost !==undefined ? found.cost : (found.price !==undefined ? found.price : 0)));
};
const newPrice=findPrice(itemId);
Array.from(tbody.querySelectorAll('tr')).forEach(tr=> {
const compSel=tr.querySelector('.cost-comp-select');
if(!compSel) return;
if(String(compSel.value)===String(itemId)){
const unitCostInp=tr.querySelector('.cost-comp-unitcost');
const qtyInp=tr.querySelector('.cost-comp-qty');
const totalSpan=tr.querySelector('.cost-comp-total');
if(unitCostInp){
unitCostInp.value=Number(newPrice || 0).toFixed(2);
}
const q=parseFloat(qtyInp && qtyInp.value || 0) || 0;
const uc=parseFloat(unitCostInp && unitCostInp.value || 0) || 0;
const tot=Math.round(q * uc * 100) / 100;
if(totalSpan) totalSpan.textContent=tot.toFixed(2);
}
});
calculateTotals();
}catch(e){ console.warn('updateBomRowsAfterPriceChange error', e); }
}
function exportPrices(){ const payload={ raw: costRaw || [], exportedAt: new Date().toISOString() }; const dataStr='data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2)); const a=document.createElement('a'); a.href=dataStr; a.download='cost-raw-prices.json'; document.body.appendChild(a); a.click(); a.remove(); }
function importPricesFromJSON(obj){
if(!obj || !Array.isArray(obj.raw)) return alert('الملف لا يحتوي على بيانات خامات صحيحة');
let added=0, updated=0;
obj.raw.forEach(r=> {
const id=r.id || r.code || null; if(!id) return;
const existing=costRaw.find(x=> String(x.id)===String(id));
if(existing){
if(r.lastPrice !==undefined){ existing.lastPrice=r.lastPrice; existing.lastPriceDate=r.lastPriceDate || new Date().toISOString(); existing.priceHistory=existing.priceHistory || []; existing.priceHistory.unshift({ price: existing.lastPrice, date: existing.lastPriceDate }); updated++; }
} else {
const newItem={ id, code: id, name: r.name||r.title||'', unit: r.unit||'', cost: r.cost||0, lastPrice: r.lastPrice||r.cost||0, lastPriceDate: r.lastPriceDate||new Date().toISOString(), priceHistory: r.priceHistory||[] };
costRaw.push(newItem); added++;
}
});
saveLists(); renderRawPriceTable(); renderProductSelect(); alert('تم استيراد: تم إضافة ' + added + ' — تم تحديث ' + updated);
}
document.addEventListener('click', function(e){
if(e.target && e.target.id==='export-prices-btn'){ exportPrices(); }
if(e.target && e.target.id==='import-prices-btn'){ const inp=document.getElementById('import-prices-input'); if(inp) inp.click(); }
if(e.target && e.target.id==='save-all-prices-btn'){ saveAllPrices(); }
const saveBtn=e.target && e.target.closest && e.target.closest('.raw-price-save-btn'); if(saveBtn){ const id=saveBtn.getAttribute('data-id'); if(id) saveRawPriceRow(id); }
});
const importInp=document.getElementById('import-prices-input'); if(importInp) importInp.addEventListener('change', function(e){
const f=e.target.files && e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=function(ev){ try{ const obj=JSON.parse(String(ev.target.result || '{}')); importPricesFromJSON(obj); }catch(err){ alert('فشل قراءة الملف: ' + err.message); } }; reader.readAsText(f); e.target.value='';
});
function addEmptyRawRow(){
const id='raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
costRaw.push({ id, code: id, name: '', unit: '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
saveLists(); renderRawPriceTable();
}
function importRawNamesFromState(){
const src=(Array.isArray(state && state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
if(!src || !src.length) return alert('لا توجد منتجات في حالة التطبيق للاستيراد.');
if(!confirm('هل تريد استيراد أسماء المنتجات من بيانات التطبيق كخامات؟ سيتم إضافة الصفوف دون تغيير الأسعار.')) return;
let added=0;
src.forEach(p=> {
const id=p.id || p.code || ('raw-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
if(!costRaw.some(x=> String(x.id)===String(id) || (x.name && x.name.trim()===(p.name||p.title||'').trim()))) {
costRaw.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || '', cost: 0, lastPrice: 0, lastPriceDate: null, priceHistory: [] });
added++;
}
});
saveLists(); renderRawPriceTable(); renderProductSelect(); alert('تم إضافة ' + added + ' خامة من بيانات التطبيق.');
}
document.addEventListener('click', function(e){
if(e.target && e.target.id==='add-empty-raw-btn'){ addEmptyRawRow(); }
if(e.target && e.target.id==='import-raw-from-state-btn'){ importRawNamesFromState(); }
});
document.addEventListener('DOMContentLoaded', function(){
const mb=document.getElementById('cost-manage-lists-btn'); if(mb) mb.addEventListener('click', openManageListsModal);
});
document.addEventListener('click', function(e){
if(e.target && e.target.id==='add-finished-btn'){
const name=document.getElementById('prod-finished-name').value.trim();
const code=document.getElementById('prod-finished-code').value.trim() || Date.now().toString();
const unit=document.getElementById('prod-finished-unit').value.trim() || 'قطعة';
const price=parseFloat(document.getElementById('prod-finished-price').value || 0) || 0;
if(!name) return alert('ادخل اسم المنتج التام');
costFinished.push({ id: code, code, name, unit, price }); saveLists();
document.getElementById('prod-finished-name').value=''; document.getElementById('prod-finished-code').value=''; document.getElementById('prod-finished-price').value='';
}
if(e.target && e.target.id==='add-raw-btn'){
const name=document.getElementById('prod-raw-name').value.trim();
const code=document.getElementById('prod-raw-code').value.trim() || Date.now().toString();
const unit=document.getElementById('prod-raw-unit').value.trim() || 'كجم';
const cost=parseFloat(document.getElementById('prod-raw-cost').value || 0) || 0;
if(!name) return alert('ادخل اسم الخامة');
costRaw.push({ id: code, code, name, unit, cost }); saveLists();
document.getElementById('prod-raw-name').value=''; document.getElementById('prod-raw-code').value=''; document.getElementById('prod-raw-cost').value='';
}
if(e.target && e.target.id==='add-pack-btn'){
const name=document.getElementById('prod-pack-name').value.trim();
const code=document.getElementById('prod-pack-code').value.trim() || Date.now().toString();
const unit=document.getElementById('prod-pack-unit').value.trim() || 'قطعة';
const cost=parseFloat(document.getElementById('prod-pack-cost').value || 0) || 0;
if(!name) return alert('ادخل اسم التغليف');
costPack.push({ id: code, code, name, unit, cost }); saveLists();
document.getElementById('prod-pack-name').value=''; document.getElementById('prod-pack-code').value=''; document.getElementById('prod-pack-cost').value='';
}
});
function createComponentOptionHTML(list){ return list.map(it=> {
const last=(it.lastPrice !==undefined && it.lastPrice !==null) ? Number(it.lastPrice) : (it.cost !==undefined ? Number(it.cost) : (it.price !==undefined ? Number(it.price) : 0));
return `<option value="${escapeHtml(it.id)}" data-unit="${escapeHtml(it.unit||'')}" data-cost="${Number(it.cost||it.price||0)}" data-lastprice="${last}">${escapeHtml(it.name)} (${escapeHtml(it.unit||'')})</option>`;
}).join(''); }
function addBOMRow(data){
const tbody=document.getElementById('cost-bom-body'); if(!tbody) return;
const tr=document.createElement('tr');
tr.innerHTML=`
<td class="px-2 py-1 text-right">
<select class="cost-comp-type p-1 border rounded"><option value="raw">خامة</option><option value="pack">تغليف</option></select>
</td>
<td class="px-2 py-1 text-right">
<select class="cost-comp-select p-1 border rounded"></select>
</td>
<td class="px-2 py-1 text-center"><input class="cost-comp-qty p-1 border rounded text-center" value="${data && data.qty ? data.qty : 1}" style="width:90px" /></td>
<td class="px-2 py-1 text-center"><span class="cost-comp-unit">${data && data.unit?escapeHtml(data.unit):''}</span></td>
<td class="px-2 py-1 text-center"><input class="cost-comp-unitcost p-1 border rounded text-center" value="${data && data.unitCost?data.unitCost:0}" style="width:110px" /></td>
<td class="px-2 py-1 text-center"><span class="cost-comp-total">0.00</span></td>
<td class="px-2 py-1 text-center"><button class="cost-remove-row bg-red-500 text-white px-2 rounded">حذف</button></td>
`;
tbody.appendChild(tr);
const typeSel=tr.querySelector('.cost-comp-type');
const compSel=tr.querySelector('.cost-comp-select');
try{ tr.style.overflow='visible'; if(typeSel && typeSel.parentElement) typeSel.parentElement.style.overflow='visible'; if(compSel && compSel.parentElement) compSel.parentElement.style.overflow='visible'; }catch(e){}
const qtyInp=tr.querySelector('.cost-comp-qty');
const unitSpan=tr.querySelector('.cost-comp-unit');
const unitCostInp=tr.querySelector('.cost-comp-unitcost');
const totalSpan=tr.querySelector('.cost-comp-total');
function populateOptions(){
const isRaw=typeSel.value==='raw';
compSel.innerHTML=isRaw ? createComponentOptionHTML(costRaw) : createComponentOptionHTML(costPack);
if(data && data.id) compSel.value=data.id;
const opt=compSel.options[compSel.selectedIndex];
if(opt){
unitSpan.textContent=opt.getAttribute('data-unit') || '';
const auto=document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
if(isRaw && auto){ unitCostInp.value=Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0); }
else { unitCostInp.value=Number(opt.getAttribute('data-cost')||0); }
}
recalc();
}
try{
[compSel, typeSel].forEach(s=>{
if(!s) return;
s.style.position='relative';
s.style.zIndex=9999;
s.style.pointerEvents='auto';
s.style.webkitAppearance='menulist';
s.style.MozAppearance='menulist-button';
s.addEventListener('mousedown', function(ev){ ev.stopPropagation(); });
s.addEventListener('click', function(ev){ ev.stopPropagation(); });
s.addEventListener('focus', ()=>{ s.style.zIndex=12000; });
s.addEventListener('blur', ()=>{ s.style.zIndex=9999; });
});
}catch(e){}
function recalc(){
const q=parseFloat(qtyInp.value || 0) || 0;
const uc=parseFloat(unitCostInp.value || 0) || 0;
const tot=Math.round((q * uc) * 100) / 100;
totalSpan.textContent=tot.toFixed(2);
calculateTotals();
}
typeSel.addEventListener('change', populateOptions);
compSel.addEventListener('change', ()=> {
const opt=compSel.options[compSel.selectedIndex];
if(opt){
unitSpan.textContent=opt.getAttribute('data-unit') || '';
const isRaw=typeSel.value==='raw';
const auto=document.getElementById('cost-autofill-lastprice') && document.getElementById('cost-autofill-lastprice').checked;
if(isRaw && auto) unitCostInp.value=Number(opt.getAttribute('data-lastprice')||opt.getAttribute('data-cost')||0);
else unitCostInp.value=Number(opt.getAttribute('data-cost')||0);
}
recalc();
});
qtyInp.addEventListener('input', recalc);
unitCostInp.addEventListener('input', recalc);
tr.querySelector('.cost-remove-row').addEventListener('click', ()=>{ tr.remove(); calculateTotals(); });
populateOptions();
}
function calculateTotals(){
const rows=Array.from(document.querySelectorAll('#cost-bom-body tr'));
let rawSum=0; let packSum=0;
rows.forEach(r=> {
const type=(r.querySelector('.cost-comp-type') && r.querySelector('.cost-comp-type').value) || 'raw';
const q=parseFloat((r.querySelector('.cost-comp-qty') && r.querySelector('.cost-comp-qty').value) || 0) || 0;
const uc=parseFloat((r.querySelector('.cost-comp-unitcost') && r.querySelector('.cost-comp-unitcost').value) || 0) || 0;
const tot=Math.round(q * uc * 100) / 100;
if(type==='raw') rawSum +=tot; else packSum +=tot;
});
const yieldVal=parseFloat(document.getElementById('cost-yield').value || 1) || 1;
const overheadFixed=parseFloat(document.getElementById('cost-overhead-fixed') && document.getElementById('cost-overhead-fixed').value || 0) || 0; 
const overheadPercent=parseFloat(document.getElementById('cost-overhead-percent') && document.getElementById('cost-overhead-percent').value || 0) || 0; 
const overheadPercentAmount=Math.round((rawSum * (overheadPercent / 100)) * 100) / 100;
const overheadFixedPerUnit=yieldVal ? Math.round((overheadFixed / yieldVal) * 100) / 100 : 0;
const perUnit=Math.round(((rawSum + packSum + overheadPercentAmount + overheadFixed) / yieldVal) * 100) / 100;
const rawEl=document.getElementById('cost-raw-total'); if(rawEl) rawEl.textContent=rawSum.toFixed(2);
const packEl=document.getElementById('cost-pack-total'); if(packEl) packEl.textContent=packSum.toFixed(2);
const fixedPerUnitEl=document.getElementById('cost-overhead-fixed-perunit'); if(fixedPerUnitEl) fixedPerUnitEl.textContent=overheadFixedPerUnit.toFixed(2);
const percentAmtEl=document.getElementById('cost-overhead-percent-amount'); if(percentAmtEl) percentAmtEl.textContent=overheadPercentAmount.toFixed(2);
const totalPerUnitEl=document.getElementById('cost-total-per-unit'); if(totalPerUnitEl) totalPerUnitEl.textContent=perUnit.toFixed(2);
}
function saveBOMForSelected(){
const sel=document.getElementById('cost-product-select'); if(!sel) return alert('اختر منتجاً تاماً');
const pid=sel.value; if(!pid) return alert('اختر منتجاً تاماً');
const rows=Array.from(document.querySelectorAll('#cost-bom-body tr')).map(r=> ({ type: r.querySelector('.cost-comp-type').value, id: r.querySelector('.cost-comp-select').value, qty: parseFloat(r.querySelector('.cost-comp-qty').value||0)||0, unit: r.querySelector('.cost-comp-unit').textContent||'', unitCost: parseFloat(r.querySelector('.cost-comp-unitcost').value||0)||0 }));
const payload={ yield: parseFloat(document.getElementById('cost-yield').value||1)||1, items: rows, savedAt: new Date().toISOString() };
localStorage.setItem(LS_BOM_PREFIX + pid, JSON.stringify(payload));
alert('تم حفظ BOM للمنتج');
}
function ensureDefaultBOMRows(){ return; }
function loadBOMForProduct(pid){ return; }
document.addEventListener('click', function(e){
if(e.target && e.target.id==='new-bom-row-btn'){ addBOMRow(); }
if(e.target && e.target.id==='cost-save-bom-btn'){ saveBOMForSelected(); }
if(e.target && e.target.id==='cost-export-btn'){
const summary=`تكلفة وحدة: ${document.getElementById('cost-total-per-unit').textContent} — خامات: ${document.getElementById('cost-raw-total').textContent} — تغليف: ${document.getElementById('cost-pack-total').textContent}`;
navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(summary).then(()=>alert('تم نسخ الملخص')) : prompt('انسخ الملخص يدوياً:', summary);
}
if(e.target && e.target.id==='cost-load-sample'){
costFinished.push({ id: 'P-001', code: 'P-001', name: 'منتج نموذجي', unit: 'قطعة', price: 100 });
costRaw.push({ id: 'R-001', code: 'R-001', name: 'لبن', unit: 'كجم', cost: 20 });
costPack.push({ id: 'K-001', code: 'K-001', name: 'عبوة بلاستيك', unit: 'قطعة', cost: 1.5 });
saveLists(); alert('تم تحميل نموذج بسيط');
}
if(e.target && e.target.id==='cost-save-all-lists'){ saveLists(); alert('تم حفظ القوائم'); }
});
document.addEventListener('change', function(e){
if(e.target && e.target.id==='cost-product-select'){
document.getElementById('cost-bom-body').innerHTML='';
const pid=e.target.value; if(!pid){ ensureDefaultBOMRows(); return; } loadBOMForProduct(pid);
}
if(e.target && (e.target.id==='cost-yield' || e.target.id==='cost-overhead-fixed' || e.target.id==='cost-overhead-percent')) calculateTotals();
});
['cost-overhead-fixed','cost-overhead-percent'].forEach(id=> {
const el=document.getElementById(id);
if(el) el.addEventListener('input', ()=> calculateTotals());
});
const bomObserver=new MutationObserver(()=> calculateTotals());
const bomBody=document.getElementById('cost-bom-body'); if(bomBody) bomObserver.observe(bomBody, { childList:true, subtree:true });
function onShowCostsPage(){
try{ document.getElementById('header-title').textContent='التكاليف'; }catch(e){}
try { 
console.log('📄 onShowCostsPage: reloading lists from localStorage...'); 
loadLists(); 
} catch(e) { 
console.warn('onShowCostsPage: loadLists() failed', e); 
}
if(window.renderRecipes) window.renderRecipes();
try {
if (window.autoImportLegacyRecipesOnce) window.autoImportLegacyRecipesOnce();
if (window.autoRestoreCostListsOnce) window.autoRestoreCostListsOnce();
} catch(_){ }
}
document.addEventListener('click', function(e){
const btn=e.target.closest && e.target.closest('.bottom-nav-item');
if(btn && btn.getAttribute('data-page')==='costs'){ setTimeout(onShowCostsPage, 40); }
});
const pageObserver=new MutationObserver(muts=> {
muts.forEach(m=> {
if(m.target && m.target.id==='page-costs' && m.attributeName==='class'){
if(m.target.classList.contains('active')) onShowCostsPage();
}
});
});
const pageCostsEl=document.getElementById('page-costs'); if(pageCostsEl) pageObserver.observe(pageCostsEl, { attributes: true });
function restoreFromPriceLists(){
try{
costFinished=[];
costRaw=[];
costPack=[];
const src=(Array.isArray(state.products) && state.products.length) ? state.products : (Array.isArray(DEFAULT_PRODUCTS) ? DEFAULT_PRODUCTS : []);
let added=0;
src.forEach(p=>{
const id=p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'قطعة', price: Number(p.price||p.sellPrice||0) });
added++;
});
saveLists();
console.log('restoreFromPriceLists: imported', added, 'products');
alert('تم مسح بيانات الاستيراد السابقة واستعادة المنتجات من قوائم الأسعار (' + added + ' عنصر).');
} catch(e){ console.warn('restoreFromPriceLists failed', e); alert('فشل استعادة قوائم الأسعار: ' + (e && e.message)); }
}
window.restoreFromPriceLists=restoreFromPriceLists;
window.autoRestoreCostListsOnce=(function(){
let done=false;
let retries=0;
const maxRetries=10;
const retryDelayMs=500;
function attempt(){
if (done) return;
try {
try { if (typeof loadLists==='function') loadLists(); } catch(_){ }
const hasAny=(Array.isArray(window.costFinished) && window.costFinished.length)
|| (Array.isArray(window.costRaw) && window.costRaw.length)
|| (Array.isArray(window.costPack) && window.costPack.length);
if (hasAny) { done=true; return; }
const hasProducts=Array.isArray(state.products) && state.products.length;
if (hasProducts) {
restoreFromPriceLists();
done=true; return;
}
if (retries < maxRetries) { retries++; setTimeout(attempt, retryDelayMs); return; }
done=true;
} catch(_){ done=true; }
}
return attempt;
})();
(function addDefaultPackItems(){
const PACK_ITEMS=[
"استيكر قشطة",
"اطباق شرش",
"استيكر مش كريمى 3ك",
"استيكر مش كريمى 8ك",
"استيكر مش قطع 3ك",
"استيكر مش قطع 8ك",
"استيكر ملح خفيف طبيعى 8ك",
"استيكر ملح خفيف نباتى 8ك",
"استيكر قريش خالية الدسم 8 ك",
"استيكر قريش كاملة الدسم 8 ك",
"استيكر فيتا سادة طبيعى 8ك",
"استيكر فيتا فلفل طبيعى 8ك",
"استيكر فيتا فلفل نباتى 8ك",
"استيكر فيتا سادة نباتى 8ك",
"استيكر كيرى طبيعى 3ك",
"استيكر كيرى نباتى 3ك",
"استيكر مورتة 2.5ك",
"استيكر مورتة 300 جم",
"استيكر صوص شيدر 3ك",
"استيكر نستو طبيعى 3ك",
"استيكر شيكولاتة بيضاء 4ك",
"استيكر كيرى بسطرمة",
"استيكر كيرى شيدر",
"استيكر كيرى رومى",
"استيكر كيرى جودة",
"استيكر كيرى زيتون",
"استيكر كيرى قشطة",
"لوجو الربيع ازرق",
"لوجو الربيع اخضر",
"لوجو فيتا فلفل طبيعى",
"اكياس جرادل 8ك",
"مناديل 40*40",
"جوانتى علبة",
"مناديل فيتا سادة نباتى",
"مناديل ملح خفيف نباتى",
"مناديل قريش خالية الدسم",
"مناديل قريش كاملة الدسم",
"مناديل سادة 30-30",
"رول فرش صوانى",
"مناديل صوانى 70-70",
"اكياس شفاف 27*45",
"شنط وسط سادة",
"شنط كبير سادة",
"شنط صغير سادة",
"اكياس لبن شفاف 1ك",
"برطمان 800 جم",
"برطمان 500 جم",
"برطمان 300 جم",
"طبق بلاستيك 1ك",
"جردل فارغ 8ك بالغطاء",
"غطاء جردل 8ك",
"جردل فارغ 3ك بالغطاء",
"غطاء جردل 3ك",
"غطاء زبادى 100 جم",
"علبة حلويات شفاف",
"غطاء زبادى 140 جم",
"استيكر زبدة جاموسى 1ك",
"استيكر زبدة جاموسى 900جم",
"استيكر زبدة جاموسى500جم",
"استيكر زبدة بقرى 1ك",
"استيكر زبدة بقرى 900جم",
"استيكر زبدة بقرى 500جم",
"استيكر سمن جاموسى 800 جم",
"كبسولة امان سمن جاموسى 800 جم",
"استيكر سمن جاموسى 500 جم",
"كبسولة امان سمن جاموسى 500 جم",
"استيكر سمن جاموسى 200 جم",
"كبسولة امان سمن جاموسى 200 جم",
"استيكر سمن بقرى 800 جم",
"كبسولة امان سمن بقرى 800 جم",
"استيكر سمن بقرى 500 جم",
"كبسولة امان سمن بقرى 500 جم",
"استيكر سمن بقرى 200 جم",
"كبسولة امان سمن بقرى 200 جم",
"استيكر مش قطع 10ك",
"استيكر مش كريمى 10ك",
"كرتونة تعبأة ارز",
"كرتونة تعبأة زبادى",
"كرتونة تعبأة سمن 800 جم",
"كرتونة تعبأة سمن 500 جم",
"كرتونة تعبأة سمن-مورتة 200 جم",
"رول استرتش 40سم",
"اكياس مورتة فاكيوم",
"ايس بوكس فل كبير",
"ايس بوكس فل صغير",
"علبة شفاف كبير",
"غطاء شفاف كبير",
"اكياس لبن شفاف 2ك",
"فلتر محلب",
"علبة عاشوراء سادة",
"غطاء عاشوراء سادة",
"مناديل فيتا سادة طبيعى",
"مناديل فيتا فلفل طبيعى",
"مناديل ملح خفيف طبيعى",
"مناديل صوانى مستطيلة",
"استيكر شيكولاتة سوداء 4ك",
"اكياس زبدة فاكيوم",
"علبة فارغ 1ك",
"غطاء ارز باللبن-زبادى 500 جم",
"اكياس قمامة",
"اوفر هيد باكت",
"جردل فارغ 8ك",
"جردل فارغ 3ك",
"افيز كيس",
"مناديل فيتا فلفل نباتى",
"لوجو الربيع فيتا سادة طبيعى",
"لوجو الربيع ملح خفيف طبيعى",
"غطاء برطمان سمن 800 / 500 جم",
"غطاء برطمان سمن 200 جم / 300 جم",
"برطمان 200 جم",
"طبق بلاستيك 500 جم",
"علبة بلاستيك بالغطاء 250 جم",
"كيس شرنك",
"فخار زبادى",
"فخار ارز",
"علبة بلاستيك بالغطاء 125 جم",
"علب زبادى بالغطاء أبو الخير",
"زجاجة لبن فارغة",
"فخار الدوار",
"اطباق 1ك بالغطاء",
"علبة فارغ 4ك بالغطار",
"استيكر ملح خفيف نباتى 4ك",
"استيكر فيتا نباتى 4ك",
"اكياس لبن شفاف 500 جم",
"سلوتيب عريض",
"اوفر شوز",
"كمامه",
"شراب",
"باركود صغير للطباعه",
"باركود كبير للطباعه",
"كيس معالق",
"اكياس شرنك ارز",
"اكياس شرنك زبادى",
"جوانتى كيس",
"كرتونة تعبأة موزريلا",
"بكر باركود حرارى",
"استيكر زبادى فخار",
"استيكر ارز فخار",
"كرتونه موزريلا",
"رول استرتش 10 سم",
"جردل 4ك بالغطاء",
"جردل 4ك",
"غطاء جردل 4ك",
"علبه مفصلي شفاف بالغطاء"
];
try{
let added=0;
PACK_ITEMS.forEach(name=> {
if(!costPack.some(x=> String(x.name).trim()===String(name).trim())){
const id='pack-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
costPack.push({ id, code: id, name: name, unit: 'قطعة', cost: 0 });
added++;
}
});
if(added > 0) saveLists();
console.log('Added packaging items:', added);
} catch(e){ console.warn('addDefaultPackItems error', e); }
})();
function loadSheetJs() {
return new Promise((resolve, reject)=> {
if (window.XLSX) return resolve(window.XLSX);
const s=document.createElement('script');
s.src='https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
s.onload=()=> resolve(window.XLSX);
s.onerror=reject;
document.head.appendChild(s);
});
}
function detectKey(keys, candidates){
const norm=k=> String(k||'').trim().toLowerCase();
for(const k of keys){
const n=norm(k);
for(const c of candidates){ if(n.indexOf(c) !==-1) return k; }
}
return null;
}
async function handleExcelFile(file) {
try{
await loadSheetJs();
const data=await file.arrayBuffer();
const wb=XLSX.read(data, {type:'array'});
const first=wb.SheetNames[0];
const sheet=wb.Sheets[first];
const rows=XLSX.utils.sheet_to_json(sheet, {defval: ''});
if(!rows || !rows.length) return alert('الملف لا يحتوي على بيانات قابلة للاستيراد');
const sampleKeys=Object.keys(rows[0]);
const codeKey=detectKey(sampleKeys, ['code','كود']);
const nameKey=detectKey(sampleKeys, ['name','item','البيان','اسم']);
const unitKey=detectKey(sampleKeys, ['unit','الوحدة','وحدة']);
const costKey=detectKey(sampleKeys, ['تكلف','cost']);
const priceKey=detectKey(sampleKeys, ['سعر','price','بيع']);
const sectionKey=detectKey(sampleKeys, ['قسم','القسم','category','type']);
let addedFinished=0, addedRaw=0, addedPack=0;
rows.forEach(r=> {
const code=String(r[codeKey] || r['Code'] || r['code'] || '').trim() || Date.now().toString() + Math.random().toString(36).slice(2,6);
const name=String(r[nameKey] || r['Item Name'] || r['item name'] || '').trim() || '';
const unit=String(r[unitKey] || '').trim() || '';
const cost=parseFloat(String(r[costKey] || r['سعر التكلفة'] || r['Cost'] || '') || 0) || 0;
const price=parseFloat(String(r[priceKey] || r['سعر البيع'] || r['Price'] || '') || 0) || 0;
const section=String(r[sectionKey] || r['اسم المخزن'] || r['القسم'] || '').trim().toLowerCase();
const item={ id: code, code, name, unit, cost, price };
if(section.includes('انتاج') || section.includes('تام') || section.includes('product') || (name && (name.toLowerCase().indexOf('جبنة')>-1 || name.toLowerCase().indexOf('لبن')>-1))) {
costFinished.push(item); addedFinished++;
} else if(section.includes('خامات') || section.includes('خام') || section.includes('مواد') || section.includes('raw')){
costRaw.push(item); addedRaw++;
} else if(section.includes('تعب') || section.includes('تغليف') || section.includes('pack') || section.includes('عبوة')){
costPack.push(item); addedPack++;
} else {
costFinished.push(item); addedFinished++;
}
});
saveLists();
alert(`تم الاستيراد: المنتجات التامة ${addedFinished} — الخامات ${addedRaw} — التغليف ${addedPack}`);
} catch(e){ console.error('Excel import failed', e); alert('فشل استيراد الملف: ' + (e && e.message)); }
}
document.addEventListener('click', function(e){
if(e.target && e.target.id==='cost-import-xlsx-btn'){
const inp=document.getElementById('cost-excel-input'); if(inp) inp.click();
}
if(e.target && e.target.id==='cost-import-from-state-btn'){
const src=(Array.isArray(state.products) && state.products.length) ? state.products : DEFAULT_PRODUCTS || [];
let added=0;
src.forEach(p=>{
const id=p.id || p.code || Date.now().toString() + Math.random().toString(36).slice(2,6);
const existing=costFinished.find(x=> String(x.id)===String(id));
if(!existing){ costFinished.push({ id, code: id, name: p.name || p.title || '', unit: p.unit || p.unitName || 'قطعة', price: Number(p.price||p.sellPrice||0) }); added++; }
});
saveLists();
alert('تم استيراد ' + added + ' منتج من بيانات التطبيق.');
}
});
document.getElementById('cost-excel-input') && document.getElementById('cost-excel-input').addEventListener('change', function(e){
const f=e.target.files && e.target.files[0]; if(f) handleExcelFile(f);
e.target.value='';
});
})();
</script>
<!-- Claude client helper: call Netlify proxy at /api/claude -->
<script>
(function(){
if (window.ClaudeAPI) return; 
window.ClaudeAPI={
async chat(opts){
const payload={
model: (opts && opts.model) || 'claude-3-5-sonnet-20241022',
max_tokens: (opts && opts.max_tokens) || 512,
system: opts && opts.system,
messages: (opts && opts.messages) || [],
stream: !!(opts && opts.stream)
};
const res=await fetch('/api/claude', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});
if (!res.ok) {
const text=await res.text().catch(()=> '');
throw new Error('Claude proxy error: HTTP ' + res.status + (text ? ('\n' + text) : ''));
}
const ct=res.headers.get('content-type')||'';
if (ct.includes('application/json')) return res.json();
return res.text();
},
async simple(prompt, extra){
const messages=[{ role: 'user', content: prompt }];
const data=await this.chat({ ...(extra||{}), messages });
try {
const parts=Array.isArray(data && data.content) ? data.content : [];
const txt=parts.find(p=> p && p.type==='text');
return txt ? txt.text : JSON.stringify(data);
} catch(e){ return JSON.stringify(data||{}); }
}
};
window.testClaude=async function(){
try {
console.time('claude');
const out=await window.ClaudeAPI.simple('قل مرحباً بك!');
console.timeEnd('claude');
alert(out);
} catch(err){
console.error(err);
alert('فشل الاتصال بـ Claude: ' + (err && err.message));
}
};
})();
(function(){
const LS_SIMPLE_RECIPES='simple_cost_recipes';
let simpleRecipes=[];
let lastFocusedRecipeId=null;
const recipeInputTimers=new Map();
function loadSimpleRecipes(){
try { const raw=localStorage.getItem(LS_SIMPLE_RECIPES); simpleRecipes=raw ? JSON.parse(raw) : []; if(!Array.isArray(simpleRecipes)) simpleRecipes=[]; } catch(e){ simpleRecipes=[]; }
try { const draftRaw=localStorage.getItem('costDrafts'); if (draftRaw) state.costDrafts=JSON.parse(draftRaw); } catch(e){}
window.simpleRecipes=simpleRecipes;
}
function saveSimpleRecipes(){ try { localStorage.setItem(LS_SIMPLE_RECIPES, JSON.stringify(simpleRecipes)); window.simpleRecipes=simpleRecipes; } catch(e){} }
function toNum(v){ return parseFloat(v||0) || 0; }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function computeRecipe(r){
const ingredientsCost=(r.ingredients||[]).reduce((a,x)=> a + (toNum(x.qtyKg) * toNum(x.unitCost)), 0);
const packagingCost=(r.packaging||[]).reduce((a,x)=> a + toNum(x.cost), 0);
const operationsCost=(r.operations||[]).reduce((a,x)=> a + toNum(x.cost), 0);
const totalBatchCost=ingredientsCost + packagingCost + operationsCost;
const costPerKg=toNum(r.batchSizeKg) > 0 ? totalBatchCost / toNum(r.batchSizeKg) : 0;
return { ingredientsCost, packagingCost, operationsCost, totalBatchCost, costPerKg };
}
function ingredientRow(idx, ing){
return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="ing">\n<input class="ing-name flex-1 p-1 border rounded text-xs" placeholder="اسم" value="${esc(ing.name)}" />\n<input class="ing-qty w-20 p-1 border rounded text-xs text-center" placeholder="كمية" value="${esc(ing.qtyKg)}" />\n<input class="ing-cost w-20 p-1 border rounded text-xs text-center" placeholder="سعر/كجم" value="${esc(ing.unitCost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>\n</div>`;
}
function packagingRow(idx, pk){
return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="pack">\n<input class="pack-name flex-1 p-1 border rounded text-xs" placeholder="اسم" value="${esc(pk.name)}" />\n<input class="pack-cost w-24 p-1 border rounded text-xs text-center" placeholder="قيمة" value="${esc(pk.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>\n</div>`;
}
function operationRow(idx, op){
return `<div class="flex gap-2 items-center" data-row="${idx}" data-type="op">\n<input class="op-name flex-1 p-1 border rounded text-xs" placeholder="وصف" value="${esc(op.name)}" />\n<input class="op-cost w-24 p-1 border rounded text-xs text-center" placeholder="قيمة" value="${esc(op.cost)}" />\n<button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>\n</div>`;
}
function computeAndCardHTML(r){
const c=computeRecipe(r);
if (!state.costDrafts) state.costDrafts={};
const draft=state.costDrafts[r.id] || {};
const name=draft.name || r.name || '';
const batchSizeKg=draft.batchSizeKg || r.batchSizeKg || '';
const notes=draft.notes || r.notes || '';
const ingredients=(draft.ingredients && Array.isArray(draft.ingredients) && draft.ingredients.length > 0) ? draft.ingredients : r.ingredients;
const packaging=(draft.packaging && Array.isArray(draft.packaging) && draft.packaging.length > 0) ? draft.packaging : r.packaging;
const operations=(draft.operations && Array.isArray(draft.operations) && draft.operations.length > 0) ? draft.operations : r.operations;
return `<div class="flex items-center gap-2 mb-2">\n<input class="recipe-name w-full p-2 border rounded" placeholder="اسم المنتج" value="${esc(name)}" />\n<input class="recipe-batch w-28 p-2 border rounded" placeholder="دفعة كجم" value="${esc(batchSizeKg)}" />\n<button class="delete-recipe bg-red-600 text-white px-2 py-1 rounded text-sm">حذف</button>\n<button class="save-produce-card bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-sm" data-recipe-id="${esc(r.id)}">حفظ وإنتاج</button>\n</div>\n<div class="grid md:grid-cols-3 gap-4">\n<div>\n<h4 class="font-semibold text-sm mb-1">الخامات</h4>\n<div class="ingredients space-y-2">${ingredients.map((ing,i)=> ingredientRow(i, ing)).join('')}</div>\n<button class="add-ingredient bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ خامة</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">التعبئة</h4>\n<div class="packaging space-y-2">${packaging.map((pk,i)=> packagingRow(i, pk)).join('')}</div>\n<button class="add-packaging bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ تغليف</button>\n</div>\n<div>\n<h4 class="font-semibold text-sm mb-1">التشغيل</h4>\n<div class="operations space-y-2">${operations.map((op,i)=> operationRow(i, op)).join('')}</div>\n<button class="add-operation bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">+ تشغيل</button>\n</div>\n</div>\n<div class="text-sm bg-gray-50 border rounded p-3 grid grid-cols-2 md:grid-cols-5 gap-2">\n<div><span class="text-gray-600">خامات:</span> <span class="font-bold">${c.ingredientsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">تغليف:</span> <span class="font-bold">${c.packagingCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">تشغيل:</span> <span class="font-bold">${c.operationsCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">إجمالي الدفعة:</span> <span class="font-bold">${c.totalBatchCost.toFixed(2)}</span></div>\n<div><span class="text-gray-600">التكلفة / كجم:</span> <span class="font-bold">${c.costPerKg.toFixed(2)}</span></div>\n</div>\n<textarea class="recipe-notes w-full p-2 border rounded text-sm" placeholder="ملاحظات">${esc(notes)}</textarea>`;
}
function renderRecipes(){
const listEl=document.getElementById('recipes-list'); if(!listEl) return;
listEl.innerHTML='';
if(simpleRecipes.length===0){
listEl.innerHTML='<div class="p-4 bg-white rounded shadow text-sm text-gray-600">لا توجد منتجات بعد. اضغط "منتج جديد".</div>';
return;
}
simpleRecipes.forEach(r=> {
const card=document.createElement('div');
card.className='bg-white rounded-lg shadow border p-4 space-y-3';
card.setAttribute('data-id', r.id);
card.innerHTML=computeAndCardHTML(r);
listEl.appendChild(card);
try {
const inputs=card.querySelectorAll('input, textarea');
inputs.forEach(input=> {
input.addEventListener('input', ()=> {
saveCostCardDraft(card);
});
input.addEventListener('blur', ()=> {
saveCostCardDraft(card);
});
input.addEventListener('keydown', (ev)=> {
if (ev.key==='Tab') {
saveCostCardDraft(card);
}
if (ev.key==='Enter') {
ev.preventDefault();
saveCostCardDraft(card);
const focusables=Array.from(card.querySelectorAll('input, textarea, button')).filter(el=> !el.disabled && el.offsetParent !==null);
const idx=focusables.indexOf(ev.target);
if (idx >=0 && idx < focusables.length - 1) {
focusables[idx + 1].focus();
}
}
});
});
const ingNameInputs=card.querySelectorAll('.ingredients .ing-name');
const packNameInputs=card.querySelectorAll('.packaging .pack-name');
const opNameInputs=card.querySelectorAll('.operations .op-name');
ingNameInputs.forEach(inp=> {
inp.addEventListener('focus', (e)=> {
showCostAutocomplete(e.target, 'ingredient');
});
inp.addEventListener('input', (e)=> {
if (e.target.value.trim().length > 0) {
showCostAutocomplete(e.target, 'ingredient');
}
});
inp.addEventListener('blur', ()=> {
setTimeout(()=> hideCostAutocomplete(inp), 150);
});
});
packNameInputs.forEach(inp=> {
inp.addEventListener('focus', (e)=> {
showCostAutocomplete(e.target, 'packaging');
});
inp.addEventListener('input', (e)=> {
if (e.target.value.trim().length > 0) {
showCostAutocomplete(e.target, 'packaging');
}
});
inp.addEventListener('blur', ()=> {
setTimeout(()=> hideCostAutocomplete(inp), 150);
});
});
opNameInputs.forEach(inp=> {
inp.addEventListener('focus', (e)=> {
showCostAutocomplete(e.target, 'operation');
});
inp.addEventListener('input', (e)=> {
if (e.target.value.trim().length > 0) {
showCostAutocomplete(e.target, 'operation');
}
});
inp.addEventListener('blur', ()=> {
setTimeout(()=> hideCostAutocomplete(inp), 150);
});
});
} catch (err) {
console.warn('attach card handlers failed', err);
}
});
}
function addRecipe(){
const r={ id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name: '', batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' };
simpleRecipes.push(r); 
saveSimpleRecipes(); 
renderRecipes();
lastFocusedRecipeId=r.id;
const saveBtn=document.getElementById('save-and-produce-btn');
if (saveBtn) saveBtn.style.display='inline-flex';
try {
const startDate=new Date().toISOString().split('T')[0]; 
window.createProductionRun(r.id, startDate, null, 'تم إنشاؤها تلقائياً من صفحة التكاليف');
} catch(err) {
console.warn('Failed to auto-create production run:', err);
}
}
function saveAndProduceRecipe() {
if (!lastFocusedRecipeId) {
alert('الرجاء اختيار وصفة أولاً');
return;
}
const recipe=(window.simpleRecipes || []).find(r=> r.id===lastFocusedRecipeId);
if (!recipe || !recipe.name) {
alert('الرجاء إدخال اسم المنتج أولاً');
return;
}
saveSimpleRecipes();
alert(`✅ تم حفظ الوصفة: ${recipe.name}`);
try {
const startDate=new Date().toISOString().split('T')[0];
const success=window.createProductionRun(recipe.id, startDate, null, `تم إنشاؤها من صفحة التكاليف - ${recipe.name}`);
if (success) {
setTimeout(()=> {
window.navigateTo('production');
}, 300);
} else {
alert('حدث خطأ في إنشاء التشغيلة');
}
} catch(err) {
console.warn('Failed to create production run:', err);
alert('حدث خطأ في إنشاء التشغيلة');
}
}
function importFromOld(){
try{ if(typeof loadLists==='function'){ loadLists(); } }catch(e){}
const fins=Array.isArray(window.costFinished)? window.costFinished : [];
const raws=Array.isArray(window.costRaw)? window.costRaw : [];
const packs=Array.isArray(window.costPack)? window.costPack : [];
let created=0, updated=0;
const byId=(arr,id)=> arr.find(x=> String(x.id)===String(id));
const unitCostOfRaw=r=> (r && (r.lastPrice!=null?r.lastPrice:r.cost)) || 0;
const unitCostOfPack=p=> (p && (p.lastPrice!=null?p.lastPrice:p.cost)) || 0;
fins.forEach(p=> {
const name=(p && (p.name||p.code||'')).toString(); if(!name) return;
let existing=simpleRecipes.find(r=> (r.name||'')===name);
if(!existing){ existing={ id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg: '', ingredients: [], packaging: [], operations: [], notes: '' }; simpleRecipes.push(existing); created++; }
const keys=[ p.id, p.code, p.name ].filter(Boolean).map(v=> 'bom_' + v);
let bomObj=null;
for(const k of keys){ try{ const raw=localStorage.getItem(k); if(raw){ bomObj=JSON.parse(raw); break; } }catch(e){} }
if(!bomObj || !Array.isArray(bomObj.items)){ updated +=0; return; }
const ings=[]; const pkgs=[];
bomObj.items.forEach(it=> {
const qty=parseFloat(it.qty||0) || 0;
if((it.type||'').toLowerCase()==='raw'){
const r=byId(raws, it.id);
ings.push({ name: (r && r.name) || (it.name||'مكوّن'), qtyKg: qty || '', unitCost: unitCostOfRaw(r) });
} else if((it.type||'').toLowerCase()==='pack'){
const pk=byId(packs, it.id);
const uc=unitCostOfPack(pk);
pkgs.push({ name: (pk && pk.name) || (it.name||'تغليف'), cost: (qty * uc) || 0 });
}
});
const batch=ings.reduce((a,x)=> a + (parseFloat(x.qtyKg||0)||0), 0);
if(batch > 0 && !existing.batchSizeKg) existing.batchSizeKg=batch;
if(existing.ingredients.length===0) existing.ingredients=ings;
if(existing.packaging.length===0) existing.packaging=pkgs;
updated++;
});
saveSimpleRecipes(); renderRecipes();
alert(`تم الاستيراد: أنشئت ${created} وصفات، وتم تحديث ${updated}.`);
}
function silentImportIfEmpty(){
try{ if(typeof loadLists==='function'){ loadLists(); } }catch(e){}
if (simpleRecipes.length > 0) return; 
const fins=Array.isArray(window.costFinished)? window.costFinished : [];
const raws=Array.isArray(window.costRaw)? window.costRaw : [];
const packs=Array.isArray(window.costPack)? window.costPack : [];
if (!fins.length && !raws.length && !packs.length) return; 
let created=0;
fins.forEach(p=> {
const name=(p && (p.name||p.code||'')); if(!name) return;
if(!simpleRecipes.some(r=> r.name===name)){
simpleRecipes.push({ id: 'rec-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6), name, batchSizeKg:'', ingredients:[], packaging:[], operations:[], notes:'' });
created++;
}
});
if (created){ saveSimpleRecipes(); renderRecipes(); }
}
window.autoImportLegacyRecipesOnce=(function(){
let done=false;
return function(){ if(done) return; try { silentImportIfEmpty(); } catch(_){} done=true; };
})();
window.importOldCosts=importFromOld;
window.importOldCostsSilent=silentImportIfEmpty;
function syncCard(card){
const id=card.getAttribute('data-id'); const r=simpleRecipes.find(x=>x.id===id); if(!r) return;
r.name=card.querySelector('.recipe-name')?.value.trim() || '';
r.batchSizeKg=card.querySelector('.recipe-batch')?.value.trim() || '';
r.notes=card.querySelector('.recipe-notes')?.value || '';
r.ingredients=Array.from(card.querySelectorAll('.ingredients > div')).map(d=> ({ name: d.querySelector('.ing-name')?.value.trim() || '', qtyKg: d.querySelector('.ing-qty')?.value.trim() || '', unitCost: d.querySelector('.ing-cost')?.value.trim() || '' }));
r.packaging=Array.from(card.querySelectorAll('.packaging > div')).map(d=> ({ name: d.querySelector('.pack-name')?.value.trim() || '', cost: d.querySelector('.pack-cost')?.value.trim() || '' }));
r.operations=Array.from(card.querySelectorAll('.operations > div')).map(d=> ({ name: d.querySelector('.op-name')?.value.trim() || '', cost: d.querySelector('.op-cost')?.value.trim() || '' }));
saveSimpleRecipes(); 
}
function saveCostCardDraft(card) {
try {
const id=card.getAttribute('data-id');
if (!id) return;
if (!state.costDrafts) state.costDrafts={};
const draft={
name: card.querySelector('.recipe-name')?.value.trim() || '',
batchSizeKg: card.querySelector('.recipe-batch')?.value.trim() || '',
notes: card.querySelector('.recipe-notes')?.value || '',
ingredients: Array.from(card.querySelectorAll('.ingredients > div')).map(d=> ({
name: d.querySelector('.ing-name')?.value.trim() || '',
qtyKg: d.querySelector('.ing-qty')?.value.trim() || '',
unitCost: d.querySelector('.ing-cost')?.value.trim() || ''
})),
packaging: Array.from(card.querySelectorAll('.packaging > div')).map(d=> ({
name: d.querySelector('.pack-name')?.value.trim() || '',
cost: d.querySelector('.pack-cost')?.value.trim() || ''
})),
operations: Array.from(card.querySelectorAll('.operations > div')).map(d=> ({
name: d.querySelector('.op-name')?.value.trim() || '',
cost: d.querySelector('.op-cost')?.value.trim() || ''
}))
};
state.costDrafts[id]=draft;
try { localStorage.setItem('costDrafts', JSON.stringify(state.costDrafts)); } catch (e) {}
} catch (e) {
console.warn('saveCostCardDraft failed', e);
}
}
function showCostAutocomplete(input, type) {
try {
const searchTerm=input.value.trim().toLowerCase();
const container=input.parentElement;
let suggestionsList=container.querySelector('.cost-suggestions');
if (!suggestionsList) {
suggestionsList=document.createElement('div');
suggestionsList.className='cost-suggestions absolute bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-60 overflow-y-auto';
suggestionsList.style.display='none';
suggestionsList.style.direction='rtl';
suggestionsList.style.top='100%';
suggestionsList.style.right='0';
suggestionsList.style.minWidth='250px';
suggestionsList.style.zIndex='9999';
container.style.position='relative';
container.appendChild(suggestionsList);
}
let predefinedNames=[];
try {
if (type==='ingredient' && Array.isArray(window.costRaw)) {
window.costRaw.forEach(it=> {
const n=(typeof it==='string') ? it : (it && (it.name || it.code)) ? (it.name || it.code) : '';
if (n) predefinedNames.push(String(n).trim());
});
}
if (type==='packaging' && Array.isArray(window.costPack)) {
window.costPack.forEach(it=> {
const n=(typeof it==='string') ? it : (it && (it.name || it.code)) ? (it.name || it.code) : '';
if (n) predefinedNames.push(String(n).trim());
});
}
if (Array.isArray(state.products)) {
state.products.forEach(p=> {
const name=(p && (p.name || p.title || p.code)) ? String(p.name || p.title || p.code).trim() : '';
const cat=(p && p.category) ? String(p.category).toLowerCase() : '';
if (!name) return;
if (type==='ingredient') {
if (cat.includes('خام') || cat.includes('مادة') || cat.includes('مكونات')) predefinedNames.push(name);
} else if (type==='packaging') {
if (cat.includes('تعبئة') || cat.includes('تغليف') || cat.includes('عبوة') || cat.includes('ورق') || cat.includes('كيس')) predefinedNames.push(name);
} else {
predefinedNames.push(name);
}
});
}
} catch (e) {
}
if (predefinedNames.length===0) {
if (type==='ingredient') {
predefinedNames=['لبن بودرة','سكر','مياه','ملح طعام'];
} else if (type==='packaging') {
predefinedNames=['استيكر قشطة','برطمان 500 جم','جردل فارغ 3ك'];
}
}
const seen=new Set();
const uniqueNames=[];
predefinedNames.forEach(n=> {
const key=String(n || '').trim();
if (!key) return;
const lk=key.toLowerCase();
if (!seen.has(lk)) { seen.add(lk); uniqueNames.push(key); }
});
let matches=[];
if (!searchTerm) {
matches=uniqueNames;
} else {
matches=uniqueNames.filter(name=> name.toLowerCase().includes(searchTerm)).slice(0, 200);
}
if (matches.length===0) {
suggestionsList.innerHTML='<div class="p-2 text-gray-500 text-sm">لا توجد مقترحات</div>';
suggestionsList.style.display='block';
return;
}
suggestionsList.innerHTML=matches.map(name=> `
<div class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm" data-product-name="${name}">
${name}
</div>
`).join('');
suggestionsList.style.display='block';
suggestionsList.removeEventListener('click', ()=> {});
suggestionsList.addEventListener('click', (e)=> {
const item=e.target.closest('[data-product-name]');
if (item) {
input.value=item.getAttribute('data-product-name');
suggestionsList.style.display='none';
input.dispatchEvent(new Event('input', { bubbles: true }));
saveCostCardDraft(input.closest('[data-id]'));
}
});
} catch (err) {
console.warn('showCostAutocomplete failed', err);
}
}
function hideCostAutocomplete(input) {
try {
const suggestionsList=input.parentElement?.querySelector('.cost-suggestions');
if (suggestionsList) suggestionsList.style.display='none';
} catch (e) {}
}
document.addEventListener('click', function(e){
if(e.target && e.target.id==='add-recipe-btn'){ addRecipe(); }
if(e.target && e.target.id==='save-and-produce-btn'){ try { saveAndProduceRecipe(); } catch(_){ } }
if(e.target && e.target.classList.contains('save-produce-card')){ 
const recipeId=e.target.getAttribute('data-recipe-id');
if(recipeId && window.simpleRecipes && Array.isArray(window.simpleRecipes)) {
const recipe=window.simpleRecipes.find(r=> r.id===recipeId);
if (recipe && recipe.name) {
saveSimpleRecipes();
const startDate=new Date().toISOString().split('T')[0];
const success=window.createProductionRun(recipeId, startDate, null, `من صفحة التكاليف - ${recipe.name}`);
if (success) {
alert(`✅ تم حفظ الوصفة وإنشاء تشغيلة: ${recipe.name}`);
setTimeout(()=> window.navigateTo('production'), 300);
} else {
alert('حدث خطأ في إنشاء التشغيلة');
}
} else {
alert('الرجاء إدخال اسم المنتج أولاً');
}
}
}
if(e.target && e.target.id==='import-old-costs-btn'){ importFromOld(); }
if(e.target && e.target.id==='restore-costs-from-products-btn'){ try { if (window.restoreFromPriceLists) window.restoreFromPriceLists(); if (window.renderRecipes) window.renderRecipes(); } catch(_){} }
const card=e.target && e.target.closest && e.target.closest('[data-id]');
if(card){
if(e.target.classList.contains('add-ingredient')){ 
const id=card.getAttribute('data-id'); 
const r=simpleRecipes.find(x=>x.id===id); 
if(r){ 
r.ingredients.push({ name:'', qtyKg:'', unitCost:'' }); 
saveSimpleRecipes(); 
const ingDiv=card.querySelector('.ingredients');
if(ingDiv) {
const idx=r.ingredients.length - 1;
const newRow=document.createElement('div');
newRow.className='flex gap-2 items-center';
newRow.setAttribute('data-row', idx);
newRow.setAttribute('data-type', 'ing');
newRow.innerHTML=`<input class="ing-name flex-1 p-1 border rounded text-xs" placeholder="اسم" value="" /><input class="ing-qty w-20 p-1 border rounded text-xs text-center" placeholder="كمية" value="" /><input class="ing-cost w-20 p-1 border rounded text-xs text-center" placeholder="سعر/كجم" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>`;
ingDiv.appendChild(newRow);
const newIng=newRow.querySelector('.ing-name');
if(newIng){
newIng.addEventListener('focus', function(){ showCostAutocomplete(this, 'ingredient'); });
newIng.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'ingredient'); });
newIng.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
newIng.focus();
}
}
} 
}
if(e.target.classList.contains('add-packaging')){ 
const id=card.getAttribute('data-id'); 
const r=simpleRecipes.find(x=>x.id===id); 
if(r){ 
r.packaging.push({ name:'', cost:'' }); 
saveSimpleRecipes(); 
const packDiv=card.querySelector('.packaging');
if(packDiv) {
const idx=r.packaging.length - 1;
const newRow=document.createElement('div');
newRow.className='flex gap-2 items-center';
newRow.setAttribute('data-row', idx);
newRow.setAttribute('data-type', 'pack');
newRow.innerHTML=`<input class="pack-name flex-1 p-1 border rounded text-xs" placeholder="اسم" value="" /><input class="pack-cost w-24 p-1 border rounded text-xs text-center" placeholder="قيمة" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>`;
packDiv.appendChild(newRow);
const newPack=newRow.querySelector('.pack-name');
if(newPack){
newPack.addEventListener('focus', function(){ showCostAutocomplete(this, 'packaging'); });
newPack.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'packaging'); });
newPack.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
newPack.focus();
}
}
} 
}
if(e.target.classList.contains('add-operation')){ 
const id=card.getAttribute('data-id'); 
const r=simpleRecipes.find(x=>x.id===id); 
if(r){ 
r.operations.push({ name:'', cost:'' }); 
saveSimpleRecipes(); 
const opsDiv=card.querySelector('.operations');
if(opsDiv) {
const idx=r.operations.length - 1;
const newRow=document.createElement('div');
newRow.className='flex gap-2 items-center';
newRow.setAttribute('data-row', idx);
newRow.setAttribute('data-type', 'op');
newRow.innerHTML=`<input class="op-name flex-1 p-1 border rounded text-xs" placeholder="وصف" value="" /><input class="op-cost w-24 p-1 border rounded text-xs text-center" placeholder="قيمة" value="" /><button class="row-del bg-red-500 text-white px-2 py-1 rounded text-xs">×</button>`;
opsDiv.appendChild(newRow);
const newOp=newRow.querySelector('.op-name');
if(newOp){
newOp.addEventListener('focus', function(){ showCostAutocomplete(this, 'operation'); });
newOp.addEventListener('input', function(){ if(this.value.trim().length>0) showCostAutocomplete(this, 'operation'); });
newOp.addEventListener('blur', function(){ setTimeout(()=> hideCostAutocomplete(this), 150); });
newOp.focus();
}
}
} 
}
if(e.target.classList.contains('delete-recipe')){ 
if(confirm('حذف المنتج؟')){ 
const id=card.getAttribute('data-id'); 
simpleRecipes=simpleRecipes.filter(x=>x.id!==id); 
saveSimpleRecipes(); 
card.remove(); 
} 
}
if(e.target.classList.contains('row-del')){ 
const row=e.target.closest('div[data-row]'); 
const type=row.getAttribute('data-type'); 
const idx=parseInt(row.getAttribute('data-row')); 
const id=card.getAttribute('data-id'); 
const r=simpleRecipes.find(x=>x.id===id); 
if(r){ 
if(type==='ing'){ r.ingredients.splice(idx,1); } 
else if(type==='pack'){ r.packaging.splice(idx,1); } 
else if(type==='op'){ r.operations.splice(idx,1); } 
saveSimpleRecipes(); 
row.remove(); 
} 
}
}
});
document.addEventListener('input', function(e){
const card=e.target && e.target.closest && e.target.closest('[data-id]');
if(!card) return;
const interesting=e.target.classList && (
e.target.classList.contains('recipe-name') ||
e.target.classList.contains('recipe-batch') ||
e.target.classList.contains('recipe-notes') ||
e.target.classList.contains('ing-name') ||
e.target.classList.contains('ing-qty') ||
e.target.classList.contains('ing-cost') ||
e.target.classList.contains('pack-name') ||
e.target.classList.contains('pack-cost') ||
e.target.classList.contains('op-name') ||
e.target.classList.contains('op-cost')
);
if(!interesting) return;
});
document.addEventListener('focusin', function(e){
const card=e.target && e.target.closest && e.target.closest('[data-id]');
if(card) lastFocusedRecipeId=card.getAttribute('data-id');
});
let renderScheduled=false;
function scheduleRender() {
if (renderScheduled) return;
renderScheduled=true;
setTimeout(()=> {
renderRecipes();
renderScheduled=false;
}, 100);
}
document.addEventListener('click', function(e){
if(e.target && e.target.getAttribute && e.target.getAttribute('data-page')==='costs'){ 
scheduleRender();
}
if(e.target && e.target.classList.contains('quick-add-item')){
const name=e.target.getAttribute('data-name')||''; const type=e.target.getAttribute('data-add-type');
if(!name) return;
let target=simpleRecipes.find(r=>r.id===lastFocusedRecipeId);
if(!target){ target=simpleRecipes.length===1 ? simpleRecipes[0] : null; }
if(!target){ addRecipe(); target=simpleRecipes[simpleRecipes.length-1]; lastFocusedRecipeId=target.id; }
if(type==='ing'){ target.ingredients.push({ name, qtyKg:'', unitCost:'' }); }
else if(type==='pack'){ target.packaging.push({ name, cost:'' }); }
saveSimpleRecipes(); 
scheduleRender();
}
});
window.renderRecipes=renderRecipes;
loadSimpleRecipes(); 
})();
function generateProductionId() {
const today=new Date();
const dateStr=today.getFullYear().toString() + String(today.getMonth() + 1).padStart(2, '0') + String(today.getDate()).padStart(2, '0');
const count=(window.state.productions || []).filter(p=> p.id && p.id.startsWith('PROD-' + dateStr)).length + 1;
return 'PROD-' + dateStr + '-' + String(count).padStart(3, '0');
}
function calculateProductionCost(recipe) {
if (!recipe) return 0;
let total=0;
(recipe.ingredients || []).forEach(ing=> { total +=parseFloat(ing.cost) || 0; });
(recipe.packaging || []).forEach(pkg=> { total +=parseFloat(pkg.cost) || 0; });
(recipe.operations || []).forEach(op=> { total +=parseFloat(op.cost) || 0; });
return total;
}
window.renderProductionRuns=function() {
if (window.renderProductionsList) {
window.renderProductionsList();
}
};
window.openCreateProductionModal=function() {
const recipeSelect=document.getElementById('production-recipe-select');
const dateInput=document.getElementById('production-start-date');
if (recipeSelect) {
recipeSelect.innerHTML='<option value="">-- اختر وصفة --</option>';
const recipes=window.simpleRecipes || [];
console.log('Available recipes:', recipes);
if (recipes.length===0) {
recipeSelect.innerHTML +='<option disabled>لا توجد وصفات متاحة</option>';
} else {
recipes.forEach(recipe=> {
const option=document.createElement('option');
option.value=recipe.id;
option.textContent=recipe.name || 'بدون اسم';
recipeSelect.appendChild(option);
});
}
}
if (dateInput) {
dateInput.valueAsDate=new Date();
}
const modal=document.getElementById('modal-create-production');
if (modal) {
modal.classList.remove('modal-hidden');
modal.classList.add('modal-visible');
}
console.log('Opened create production modal');
};
function attachProductionButtonListeners() {
const activeTable=document.getElementById('active-productions-table-body');
const completedTable=document.getElementById('completed-productions-table-body');
if (activeTable) {
activeTable.addEventListener('click', function(e) {
const btn=e.target.closest('.btn-edit-production');
if (btn) {
const productionId=btn.dataset.id;
console.log('📋 تحديث التشغيلة:', productionId);
window.openEditProductionModal(productionId);
}
});
}
if (completedTable) {
completedTable.addEventListener('click', function(e) {
const btn=e.target.closest('.btn-edit-production');
if (btn) {
const productionId=btn.dataset.id;
console.log('📋 عرض التشغيلة المنتهية:', productionId);
window.openEditProductionModal(productionId);
}
});
}
}
window.renderProductionsList=function() {
try {
const activeBody=document.getElementById('active-productions-table-body');
const completedBody=document.getElementById('completed-productions-table-body');
if (!activeBody || !completedBody) return;
const productions=window.state.productions || [];
activeBody.innerHTML='';
completedBody.innerHTML='';
const activeProds=productions.filter(p=> p.status==='in-progress');
const completedProds=productions.filter(p=> p.status !=='in-progress');
activeProds.forEach(prod=> {
const tr=document.createElement('tr');
tr.innerHTML=`
<td class="px-3 py-3 text-right font-semibold text-blue-600">${escapeHtml(prod.id)}</td>
<td class="px-3 py-3 text-right">${escapeHtml(prod.productName || prod.recipeName)}</td>
<td class="px-3 py-3 text-right">${escapeHtml(prod.recipeName)}</td>
<td class="px-3 py-3 text-center text-sm">${prod.startDate || '-'}</td>
<td class="px-3 py-3 text-center">${prod.expectedQty || '-'}</td>
<td class="px-3 py-3 text-center"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">قيد الإنتاج</span></td>
<td class="px-3 py-3 text-center">
<button class="btn-edit-production bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" data-id="${escapeHtml(prod.id)}">تحديث</button>
</td>
`;
activeBody.appendChild(tr);
});
completedProds.forEach(prod=> {
const tr=document.createElement('tr');
const profit=(prod.totalRevenue || 0) - (prod.totalCost || 0);
const profitClass=profit >=0 ? 'text-green-600' : 'text-red-600';
tr.innerHTML=`
<td class="px-3 py-3 text-right font-semibold text-gray-600">${escapeHtml(prod.id)}</td>
<td class="px-3 py-3 text-right">${escapeHtml(prod.productName || prod.recipeName)}</td>
<td class="px-3 py-3 text-center">${prod.actualQty || prod.finalQty || '-'}</td>
<td class="px-3 py-3 text-right">${(prod.totalCost || 0).toFixed(2)}</td>
<td class="px-3 py-3 text-right">${(prod.totalRevenue || 0).toFixed(2)}</td>
<td class="px-3 py-3 text-right ${profitClass}"><strong>${profit.toFixed(2)}</strong></td>
<td class="px-3 py-3 text-center text-sm">${prod.completedDate || '-'}</td>
<td class="px-3 py-3 text-center">
<button class="btn-edit-production bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600" data-id="${escapeHtml(prod.id)}">عرض</button>
</td>
`;
completedBody.appendChild(tr);
});
document.getElementById('no-active-productions').style.display=activeProds.length ? 'none' : 'block';
document.getElementById('no-completed-productions').style.display=completedProds.length ? 'none' : 'block';
attachProductionButtonListeners();
} catch(err) {
console.warn('renderProductionsList error:', err);
}
};
window.loadProductionsFromFirebase=async function() {
if (!window.db || !window.auth?.currentUser) {
console.warn('Firebase not ready, using local productions only');
return;
}
try {
const uid=window.auth.currentUser.uid;
try {
const udoc=await db.collection('users').doc(uid).get();
if (udoc.exists) {
const appState=udoc.data() && udoc.data().appState ? udoc.data().appState : null;
if (appState && Array.isArray(appState.productions) && appState.productions.length > 0) {
window.state.productions=appState.productions;
console.log('✅ Loaded', appState.productions.length, 'productions from users/' + uid + '.appState');
saveState();
return;
}
}
} catch(err) {
console.warn('Failed to read users/{uid}.appState for productions:', err);
}
} catch(e){ console.warn('loadProductionsFromFirebase failed early', e); }
try {
const globalProdsSnap=await db.collection('productions').get();
if (globalProdsSnap.size > 0) {
const productions=[];
globalProdsSnap.forEach(doc=> {
productions.push(doc.data());
});
if (!Array.isArray(window.state.productions)) window.state.productions=[];
window.state.productions=productions;
console.log('✅ Loaded', productions.length, 'productions from Firebase (global collection)');
saveState();
return;
}
} catch(err) {
console.error('Failed to load productions from Firebase (global):', err);
}
};
try { window.renderProductionsList(); } catch(e) { console.warn('Initial renderProductionsList failed:', e); }
(function(){
try {
if (window.db && window.auth && window.auth.currentUser) {
window.loadProductionsFromFirebase();
return;
}
if (window.auth && typeof window.auth.onAuthStateChanged==='function') {
const unsub=window.auth.onAuthStateChanged(function(u){
if (u) {
try { window.loadProductionsFromFirebase(); } catch(e){ console.warn('Firebase load failed on auth event:', e); }
try { if (typeof unsub==='function') unsub(); } catch(_){ }
}
});
return;
}
setTimeout(()=>{ try { window.loadProductionsFromFirebase(); } catch(e){ console.warn('Firebase load failed (delayed):', e); } }, 1500);
} catch(e){ console.warn('Firebase load scheduling failed:', e); }
})();
window.createProductionRun=function(recipeId, startDate, expectedQty, notes) {
try {
if (!recipeId) {
console.error('No recipeId provided');
return false;
}
const recipe=(window.simpleRecipes || []).find(r=> r.id===recipeId);
if (!recipe) {
console.error('Recipe not found:', recipeId);
return false;
}
const today=new Date();
const dateStr=`${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
const existingToday=(window.state.productions || []).filter(p=> p.id && p.id.includes(dateStr));
const runNumber=String(existingToday.length + 1).padStart(3, '0');
const productionId=`PROD-${dateStr}-${runNumber}`;
let totalCost=0;
(recipe.ingredients || []).forEach(ing=> {
totalCost +=parseFloat(ing.cost || 0);
});
(recipe.packaging || []).forEach(pkg=> {
totalCost +=parseFloat(pkg.cost || 0);
});
(recipe.operations || []).forEach(op=> {
totalCost +=parseFloat(op.cost || 0);
});
const production={
id: productionId,
recipeId: recipeId,
recipeName: recipe.name,
productName: recipe.name,
startDate: startDate,
createdAt: new Date().toISOString(),
expectedQty: parseFloat(expectedQty) || null,
actualQty: null,
status: 'in-progress',
totalCost: totalCost,
sellPrice: 0,
totalRevenue: 0,
profit: 0,
notes: notes,
completedDate: null
};
if (!Array.isArray(window.state.productions)) window.state.productions=[];
window.state.productions.push(production);
try {
saveState(); 
} catch(err) {
console.error('Failed to save state locally:', err);
}
console.log('✅ Production created locally:', productionId);
window.saveProductionToFirebase(production);
return true;
} catch(err) {
console.error('Error in createProductionRun:', err);
return false;
}
};
window.saveProductionToFirebase=async function(production) {
if (!production || !production.id) {
console.warn('Invalid production object');
return;
}
if (!window.db || !window.auth || !auth.currentUser) {
console.warn('Firebase not initialized or no auth, production will only be saved locally');
return;
}
try {
const uid=auth.currentUser.uid;
const userRef=db.collection('users').doc(uid);
let existing=null;
try {
const snap=await userRef.get();
if (snap.exists) existing=snap.data() && snap.data().appState ? snap.data().appState : null;
} catch(_){ }
const prods=Array.isArray(existing?.productions) ? existing.productions.slice() : (Array.isArray(window.state.productions) ? window.state.productions.slice() : []);
const idx=prods.findIndex(p=> p && p.id===production.id);
if (idx===-1) prods.push(production); else prods[idx]=production;
try {
await userRef.set({ appState: { productions: prods }, lastUpdatedBy: uid, updatedAt: serverTs() }, { merge: true });
console.log('✅ Production saved to Firebase (users/' + uid + '.appState.productions):', production.id);
return;
} catch(e){
console.warn('Failed to save production into users/{uid}.appState, will try global collection:', e);
}
try {
await db.collection('productions').doc(production.id).set(production);
console.log('✅ Production saved to Firebase (global collection):', production.id);
return;
} catch(e2){
console.error('Failed to save production to Firebase (global):', e2);
}
} catch(err) {
console.error('Error in saveProductionToFirebase:', err);
}
};
window.openEditProductionModal=function(productionId) {
const production=(window.state.productions || []).find(p=> p.id===productionId);
if (!production) {
alert('التشغيلة غير موجودة');
return;
}
document.getElementById('edit-production-id').value=productionId;
document.getElementById('edit-production-final-qty').value=production.actualQty || production.finalQty || '';
document.getElementById('edit-production-status').value=production.status || 'in-progress';
document.getElementById('edit-production-sell-price').value=production.sellPrice || '';
document.getElementById('edit-production-notes').value=production.notes || '';
const totalCost=production.totalCost || 0;
const finalQty=parseFloat(production.actualQty || production.finalQty || 1);
const sellPrice=parseFloat(production.sellPrice || 0);
const totalRevenue=finalQty * sellPrice;
const profit=totalRevenue - totalCost;
document.getElementById('summary-total-cost').textContent=totalCost.toFixed(2);
document.getElementById('summary-total-revenue').textContent=totalRevenue.toFixed(2);
document.getElementById('summary-profit-loss').textContent=profit.toFixed(2);
document.getElementById('summary-profit-loss').style.color=profit >=0 ? 'green' : 'red';
const modal=document.getElementById('modal-edit-production');
modal.classList.remove('modal-hidden');
modal.classList.add('modal-visible');
};
const createProductionForm=document.getElementById('form-create-production');
if (createProductionForm) {
createProductionForm.addEventListener('submit', function(e) {
e.preventDefault();
try {
const recipeId=document.getElementById('production-recipe-select').value;
const startDate=document.getElementById('production-start-date').value;
const expectedQty=document.getElementById('production-expected-qty').value || null;
const notes=document.getElementById('production-notes').value || '';
if (!recipeId) {
alert('الرجاء اختيار وصفة');
return;
}
if (!startDate) {
alert('الرجاء تحديد تاريخ البدء');
return;
}
const success=window.createProductionRun(recipeId, startDate, expectedQty, notes);
if (success) {
alert('✅ تم إنشاء التشغيلة بنجاح');
document.getElementById('modal-create-production').classList.remove('modal-visible');
document.getElementById('modal-create-production').classList.add('modal-hidden');
createProductionForm.reset();
window.renderProductionsList();
} else {
alert('❌ حدث خطأ في إنشاء التشغيلة');
}
} catch(err) {
console.error('Error in form submit:', err);
alert('❌ خطأ: ' + (err.message || 'فشل إنشاء التشغيلة'));
}
});
}
function attachProductionSaveListener() {
const saveBtn=document.getElementById('btn-save-production-update');
if (!saveBtn) {
console.warn('⚠️ زر الحفظ لم يتم العثور عليه، سيتم المحاولة لاحقاً');
setTimeout(attachProductionSaveListener, 500);
return;
}
console.log('✅ تم العثور على زر الحفظ، جاري ربط المعالج');
saveBtn.addEventListener('click', function(e) {
e.preventDefault();
e.stopPropagation();
console.log('🔵 Save button clicked');
const productionId=document.getElementById('edit-production-id').value;
const finalQty=parseFloat(document.getElementById('edit-production-final-qty').value) || 0;
const status=document.getElementById('edit-production-status').value;
const sellPrice=parseFloat(document.getElementById('edit-production-sell-price').value) || 0;
const notes=document.getElementById('edit-production-notes').value;
console.log('📊 البيانات المدخلة:', { productionId, finalQty, status, sellPrice, notes });
if (!productionId) {
console.error('❌ معرّف التشغيلة فارغ');
alert('خطأ: معرّف التشغيلة فارغ');
return;
}
const production=(window.state.productions || []).find(p=> p.id===productionId);
if (!production) {
console.error('❌ التشغيلة غير موجودة:', productionId);
alert('التشغيلة غير موجودة');
return;
}
console.log('🔧 تحديث بيانات التشغيلة...');
production.actualQty=finalQty;
production.finalQty=finalQty;
production.status=status;
production.sellPrice=sellPrice;
production.notes=notes;
production.totalRevenue=finalQty * sellPrice;
production.profit=production.totalRevenue - production.totalCost;
if (status==='completed' && !production.completedDate) {
production.completedDate=new Date().toISOString().split('T')[0];
}
console.log('✏️ كائن التشغيلة المحدث:', production);
try {
saveState();
console.log('💾 ✅ تم الحفظ محلياً في localStorage');
} catch(err) {
console.error('💾 ❌ فشل الحفظ المحلي:', err);
}
if (window.saveProductionToFirebase) {
try {
window.saveProductionToFirebase(production);
console.log('🔥 ✅ تم الحفظ إلى Firebase');
} catch(err) {
console.error('🔥 ❌ فشل الحفظ إلى Firebase:', err);
}
} else {
console.warn('⚠️ دالة saveProductionToFirebase غير متوفرة');
}
alert('✅ تم حفظ التحديثات بنجاح');
console.log('🚪 إغلاق المودال...');
const modal=document.getElementById('modal-edit-production');
if (modal) {
modal.classList.remove('modal-visible');
modal.classList.add('modal-hidden');
}
if (window.renderProductionsList) {
console.log('🔄 تحديث قائمة الإنتاج...');
window.renderProductionsList();
} else {
console.warn('⚠️ دالة renderProductionsList غير متوفرة');
}
console.log('✅ تم إكمال عملية الحفظ بنجاح');
});
}
if (document.readyState==='loading') {
document.addEventListener('DOMContentLoaded', attachProductionSaveListener);
} else {
attachProductionSaveListener();
}
</script>
<!-- Add Finished Product Modal -->
<div id="modal-add-finished-product" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
<h3 class="text-lg font-bold mb-4">إضافة منتج نهائي</h3>
<form id="form-add-finished-product" class="space-y-4">
<div>
<label class="block text-sm font-medium mb-1">كود المنتج</label>
<input type="text" id="finished-product-code" class="w-full p-2 border rounded-md" placeholder="مثال: P-001" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">اسم المنتج</label>
<input type="text" id="finished-product-name" class="w-full p-2 border rounded-md" placeholder="مثال: لبن زبادي" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">الوحدة</label>
<input type="text" id="finished-product-unit" class="w-full p-2 border rounded-md" placeholder="مثال: قطعة" value="قطعة">
</div>
<div>
<label class="block text-sm font-medium mb-1">السعر (اختياري)</label>
<input type="number" id="finished-product-price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
</div>
<div class="flex gap-2">
<button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
<button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-finished-product').classList.add('hidden')">إلغاء</button>
</div>
</form>
</div>
</div>
<!-- Add Raw Material Modal (force-replaced to include invoice/tax fields) -->
<div id="modal-add-raw-material" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
<h3 class="text-lg font-bold mb-4">إضافة خامة</h3>
<form id="form-add-raw-material" class="space-y-4" enctype="multipart/form-data">
<div>
<label class="block text-sm font-medium mb-1">كود الخامة</label>
<input type="text" id="raw-material-code" name="raw_material_code" class="w-full p-2 border rounded-md" placeholder="مثال: R-001" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">اسم الخامة</label>
<input type="text" id="raw-material-name" name="raw_material_name" class="w-full p-2 border rounded-md" placeholder="مثال: لبن" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">الوحدة</label>
<input type="text" id="raw-material-unit" name="raw_material_unit" class="w-full p-2 border rounded-md" placeholder="مثال: كجم" value="كجم">
</div>
<div>
<label class="block text-sm font-medium mb-1">سعر الوحدة (سعر الشراء الحالي)</label>
<input type="number" id="raw-material-unit_price" name="raw_material_unit_price" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
</div>
<div>
<label class="block text-sm font-medium mb-1">الكمية</label>
<input type="number" id="raw-material-qty" name="raw_material_qty" class="w-full p-2 border rounded-md" placeholder="1" step="any" value="1">
</div>
<div>
<label class="block text-sm font-medium mb-1">إجمالي التكلفة</label>
<input type="text" id="raw-material-total_cost" name="raw_material_total_cost" class="w-full p-2 border rounded-md bg-gray-50" readonly value="0">
</div>
<div>
<label class="inline-flex items-center gap-2">
<input type="checkbox" id="raw-material-is_tax_invoice" name="raw_material_is_tax_invoice" class="h-4 w-4">
<span class="text-sm">فاتورة ضريبية؟ (Tax Invoice?)</span>
</label>
</div>
<div class="pt-2 border-t">
<h4 class="text-sm font-medium">تفاصيل المورد والفاتورة</h4>
<div class="mt-2">
<label class="block text-sm font-medium mb-1">رقم ضريبي للمورد (Vendor Tax ID)</label>
<input type="text" id="raw-material-vendor_tax_id" name="raw_material_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="مثال: 123456789">
</div>
<div>
<label class="block text-sm font-medium mb-1">رقم الفاتورة</label>
<input type="text" id="raw-material-invoice_number" name="raw_material_invoice_number" class="w-full p-2 border rounded-md" placeholder="مثال: INV-001">
</div>
<div>
<label class="block text-sm font-medium mb-1">تاريخ الفاتورة</label>
<input type="date" id="raw-material-invoice_date" name="raw_material_invoice_date" class="w-full p-2 border rounded-md">
</div>
<div>
<label class="block text-sm font-medium mb-1">قيمة الضريبة (VAT/Tax Value)</label>
<input type="number" id="raw-material-vat_value" name="raw_material_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
</div>
<div>
<label class="block text-sm font-medium mb-1">صورة الفاتورة (Invoice Image)</label>
<input type="file" id="raw-material-invoice_image" name="raw_material_invoice_image" accept="image/*,application/pdf" class="w-full">
</div>
</div>
<div class="flex gap-2">
<button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
<button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-raw-material').classList.add('hidden')">إلغاء</button>
</div>
</form>
</div>
</div>
<!-- Add Packaging Modal (force-replaced to include invoice/tax fields) -->
<div id="modal-add-packaging" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
<h3 class="text-lg font-bold mb-4">إضافة مادة تعبئة</h3>
<form id="form-add-packaging" class="space-y-4" enctype="multipart/form-data">
<div>
<label class="block text-sm font-medium mb-1">كود المادة</label>
<input type="text" id="packaging-code" name="packaging_code" class="w-full p-2 border rounded-md" placeholder="مثال: PKG-001" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">اسم المادة</label>
<input type="text" id="packaging-name" name="packaging_name" class="w-full p-2 border rounded-md" placeholder="مثال: علبة بلاستيكية" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">الوحدة</label>
<input type="text" id="packaging-unit" name="packaging_unit" class="w-full p-2 border rounded-md" placeholder="مثال: قطعة" value="قطعة">
</div>
<div>
<label class="block text-sm font-medium mb-1">التكلفة (اختياري)</label>
<input type="number" id="packaging-cost" name="packaging_cost" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="0">
</div>
<div class="pt-2 border-t">
<h4 class="text-sm font-medium">تفاصيل المورد والفاتورة</h4>
<div class="mt-2">
<label class="block text-sm font-medium mb-1">رقم ضريبي للمورد (Vendor Tax ID)</label>
<input type="text" id="packaging-vendor_tax_id" name="packaging_vendor_tax_id" class="w-full p-2 border rounded-md" placeholder="مثال: 123456789">
</div>
<div>
<label class="block text-sm font-medium mb-1">رقم الفاتورة</label>
<input type="text" id="packaging-invoice_number" name="packaging_invoice_number" class="w-full p-2 border rounded-md" placeholder="مثال: INV-001">
</div>
<div>
<label class="block text-sm font-medium mb-1">تاريخ الفاتورة</label>
<input type="date" id="packaging-invoice_date" name="packaging_invoice_date" class="w-full p-2 border rounded-md">
</div>
<div>
<label class="block text-sm font-medium mb-1">قيمة الضريبة (VAT/Tax Value)</label>
<input type="number" id="packaging-vat_value" name="packaging_vat_value" class="w-full p-2 border rounded-md" placeholder="0" step="any" value="">
</div>
<div>
<label class="block text-sm font-medium mb-1">صورة الفاتورة (Invoice Image)</label>
<input type="file" id="packaging-invoice_image" name="packaging_invoice_image" accept="image/*,application/pdf" class="w-full">
</div>
</div>
<div class="flex gap-2">
<button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
<button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-add-packaging').classList.add('hidden')">إلغاء</button>
</div>
</form>
</div>
</div>
<script>
(function(){
function updateRawMaterialTotal(){
try{
const unitEl=document.getElementById('raw-material-unit_price');
const qtyEl=document.getElementById('raw-material-qty');
const totalEl=document.getElementById('raw-material-total_cost');
const unit=parseFloat(unitEl?.value) || 0;
const qty=parseFloat(qtyEl?.value) || 0;
const total=Math.round((unit * qty) * 100) / 100;
if (totalEl) totalEl.value=total.toFixed(2);
return total;
}catch(e){ console.warn('updateRawMaterialTotal failed', e); return 0; }
}
document.addEventListener('DOMContentLoaded', function(){
try{
const unitEl=document.getElementById('raw-material-unit_price');
const qtyEl=document.getElementById('raw-material-qty');
if (unitEl) unitEl.addEventListener('input', updateRawMaterialTotal);
if (qtyEl) qtyEl.addEventListener('input', updateRawMaterialTotal);
updateRawMaterialTotal();
}catch(e){}
});
window.updateRawMaterialTotal=updateRawMaterialTotal;
})();
</script>
<!-- Modal: Create New Production Run -->
<div id="modal-create-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
<h3 class="text-lg font-bold mb-4">إنشاء تشغيلة جديدة</h3>
<form id="form-create-production" class="space-y-4">
<div>
<label class="block text-sm font-medium mb-1">اختر الوصفة</label>
<select id="production-recipe-select" class="w-full p-2 border rounded-md" required>
<option value="">-- اختر وصفة --</option>
</select>
<p class="text-xs text-gray-500 mt-1">سيتم اختيار المنتج تلقائياً من الوصفة</p>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1">تاريخ البدء</label>
<input type="date" id="production-start-date" class="w-full p-2 border rounded-md" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">الكمية المتوقعة (اختياري)</label>
<input type="number" id="production-expected-qty" class="w-full p-2 border rounded-md" placeholder="سيتم تحديثه لاحقاً" step="0.01">
</div>
</div>
<div>
<label class="block text-sm font-medium mb-1">ملاحظات</label>
<textarea id="production-notes" class="w-full p-2 border rounded-md" rows="3" placeholder="مثال: ملاحظات عن الإنتاج..."></textarea>
</div>
<div class="bg-blue-50 border border-blue-200 p-3 rounded-md text-sm text-blue-800">
<strong>ملاحظة:</strong> يمكنك تحديث الكمية النهائية والحالة بعد الانتهاء من الإنتاج (24 ساعة تقريباً).
</div>
<div class="flex gap-2">
<button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">إنشاء التشغيلة</button>
<button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-create-production').classList.remove('modal-visible'); document.getElementById('modal-create-production').classList.add('modal-hidden');">إلغاء</button>
</div>
</form>
</div>
</div>
<!-- Modal: Edit Production Run -->
<div id="modal-edit-production" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto">
<h3 class="text-lg font-bold mb-4">تحديث التشغيلة</h3>
<form id="form-edit-production" class="space-y-4">
<input type="hidden" id="edit-production-id">
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1">الكمية النهائية</label>
<input type="number" id="edit-production-final-qty" class="w-full p-2 border rounded-md" step="0.01" required>
</div>
<div>
<label class="block text-sm font-medium mb-1">حالة التشغيلة</label>
<select id="edit-production-status" class="w-full p-2 border rounded-md" required>
<option value="in-progress">قيد الإنتاج</option>
<option value="completed">منتهية</option>
<option value="cancelled">ملغاة</option>
</select>
</div>
</div>
<div>
<label class="block text-sm font-medium mb-1">سعر البيع للوحدة (اختياري)</label>
<input type="number" id="edit-production-sell-price" class="w-full p-2 border rounded-md" step="0.01" placeholder="0">
</div>
<div>
<label class="block text-sm font-medium mb-1">ملاحظات</label>
<textarea id="edit-production-notes" class="w-full p-2 border rounded-md" rows="3"></textarea>
</div>
<div id="production-summary" class="bg-gray-50 border border-gray-200 p-3 rounded-md text-sm">
<p><strong>التكلفة الإجمالية:</strong> <span id="summary-total-cost">0</span></p>
<p><strong>إجمالي البيع:</strong> <span id="summary-total-revenue">0</span></p>
<p><strong>الربح/الخسارة:</strong> <span id="summary-profit-loss" class="font-bold">0</span></p>
</div>
<div class="flex gap-2">
<button type="button" id="btn-save-production-update" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ التحديثات</button>
<button type="button" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="document.getElementById('modal-edit-production').classList.remove('modal-visible'); document.getElementById('modal-edit-production').classList.add('modal-hidden');">إلغاء</button>
</div>
</form>
</div>
</div>
<script src="assets/app-main.js" charset="UTF-8" defer></script>
<script src="js/main.js" charset="UTF-8" defer></script>
</body>
</html>
