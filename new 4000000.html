<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§ØªÙˆØ±Ø© Ø¯ÙŠÙ„ÙŠÙ†ØªÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</title>
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙ‚Ø· -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø© */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@600;800&family=Montserrat:wght@800&display=swap');
        
        body { font-family: 'Cairo', sans-serif; background: #e2e8f0; padding-bottom: 100px; margin: 0; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .controls {
            background: #fff; padding: 15px; text-align: center; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button {
            padding: 10px 20px; margin: 5px; border: none; border-radius: 8px;
            font-family: 'Cairo', sans-serif; font-weight: bold; cursor: pointer; color: white;
            font-size: 16px;
        }
        .btn-usb { background: #7c3aed; }
        .btn-bt { background: #2563eb; }
        
        #status { font-weight: bold; margin-top: 10px; color: #666; }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ø§Ù„Ø¹Ø±Ø¶ 570 Ø¨ÙƒØ³Ù„ Ù„Ø·Ø§Ø¨Ø¹Ø§Øª 80mm */
        .invoice-wrapper {
            display: flex; justify-content: center; padding: 20px; background: #cbd5e1;
        }

        #invoice {
            width: 570px; min-width: 570px;
            background: white; padding: 15px; color: black;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ */
        .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .title { font-family: 'Montserrat', sans-serif; font-size: 32px; font-weight: 900; margin: 0; }
        .subtitle { font-family: 'Montserrat', sans-serif; font-size: 12px; font-weight: 800; letter-spacing: 2px; }
        
        .info { display: flex; justify-content: space-between; font-weight: 700; font-size: 16px; margin-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th { border-bottom: 2px solid #000; padding: 5px; font-size: 18px; }
        td { border-bottom: 1px dotted #000; padding: 8px 2px; font-size: 18px; font-weight: 700; text-align: center; }
        td:first-child { text-align: right; }

        .totals { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; }
        .row { display: flex; justify-content: space-between; font-size: 20px; font-weight: 700; margin-bottom: 5px; }
        .final { font-size: 28px; font-weight: 900; border: 3px dotted #000; padding: 5px; border-radius: 5px; margin-top: 5px; }

        .footer { text-align: center; font-size: 14px; font-weight: 700; margin-top: 20px; }

        /* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .print-btn-container {
            position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: center;
        }
        .big-btn {
            background: #166534; color: white; width: 90%; padding: 15px;
            font-size: 22px; font-weight: bold; border-radius: 10px;
        }
        .big-btn:disabled { background: #ccc; }
    </style>
</head>
<body>

    <div class="controls">
        <button onclick="connectUSB()" class="btn-usb">ğŸ”Œ USB</button>
        <button onclick="connectBluetooth()" class="btn-bt">ğŸ“¡ Ø¨Ù„ÙˆØªÙˆØ«</button>
        <div id="status">ØºÙŠØ± Ù…ØªØµÙ„</div>
    </div>

    <div class="invoice-wrapper">
        <div id="invoice">
            <div class="header">
                <!-- Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
                <img src="https://i.ibb.co/YT4114YW/image.jpg" style="width: 80px; display: block; margin: 0 auto;">
                <h1 class="title">DELENTE</h1>
                <p class="subtitle">IT'S JUST MILK.</p>
                <p style="margin: 5px 0 0 0; font-size: 14px;">Ø³.Øª: 12345 | Ø¶.Ù‚.Ù…: 98765</p>
            </div>

            <div class="info">
                <div>#10552</div>
                <div id="date"></div>
            </div>
            <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª Ø§Ù„Ø­Ù…Ø¯</div>

            <table>
                <thead>
                    <tr><th style="text-align: right;">Ø§Ù„ØµÙ†Ù</th><th>Ø³Ø¹Ø±</th><th>Ø¹</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
                </thead>
                <tbody>
                    <tr><td>Ù„Ø¨Ù† Ø¬Ø§Ù…ÙˆØ³ÙŠ (Ùƒ)</td><td>35</td><td>10</td><td>350</td></tr>
                    <tr><td>Ø²Ø¨Ø§Ø¯ÙŠ Ø¨Ù„Ø¯ÙŠ</td><td>10</td><td>20</td><td>200</td></tr>
                    <tr><td>Ø¬Ø¨Ù†Ø© Ø±ÙˆÙ…ÙŠ</td><td>240</td><td>2</td><td>480</td></tr>
                    <tr><td>Ø³Ù…Ù†Ø© Ø¨Ù„Ø¯ÙŠ</td><td>280</td><td>1</td><td>280</td></tr>
                </tbody>
            </table>

            <div class="totals">
                <div class="row"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span>1310.00</span></div>
                <div class="row" style="color: red;"><span>Ø®ØµÙ…:</span><span>- 10.00</span></div>
                <div class="row final">
                    <span>Ø§Ù„ØµØ§ÙÙŠ:</span>
                    <span>1300.00</span>
                </div>
            </div>

            <div class="footer">
                <p>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 01000000000</p>
                <p>DELENTE - FRESH & NATURAL</p>
            </div>
        </div>
    </div>

    <div class="print-btn-container">
        <button id="printBtn" onclick="printInvoice()" disabled class="big-btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    </div>

    <script>
        document.getElementById('date').innerText = new Date().toLocaleDateString('en-GB');

        let deviceHandle, characteristic, writer, mode;

        // 1. USB Connection
        async function connectUSB() {
            if (!navigator.serial) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… USB");
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                writer = port.writable.getWriter();
                mode = 'USB';
                document.getElementById('status').innerText = "Ù…ØªØµÙ„ USB âš¡";
                document.getElementById('status').style.color = "green";
                document.getElementById('printBtn').disabled = false;
            } catch (e) { alert("Ø®Ø·Ø£: " + e); }
        }

        // 2. Bluetooth Connection (Classic logic)
        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                
                mode = 'BLE';
                deviceHandle = device;
                document.getElementById('status').innerText = "Ù…ØªØµÙ„ Ø¨Ù„ÙˆØªÙˆØ«: " + device.name;
                document.getElementById('status').style.color = "green";
                document.getElementById('printBtn').disabled = false;
            } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + e); }
        }

        // 3. Print Logic (The Fast One)
        async function printInvoice() {
            const btn = document.getElementById('printBtn');
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...";

            setTimeout(async () => {
                try {
                    const el = document.getElementById('invoice');
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… scale 1.0 (Ù…Ø«Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©)
                    const canvas = await html2canvas(el, { scale: 1.0, useCORS: true });
                    const data = getImageData(canvas);

                    if (mode === 'USB') {
                        await writer.write(data);
                    } else {
                        // Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹ (Classic Chunks)
                        // Ø­Ø²Ù… 100 Ø¨Ø§ÙŠØª Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ 10ms
                        const chunkSize = 100;
                        for (let i = 0; i < data.length; i += chunkSize) {
                            const chunk = data.slice(i, i + chunkSize);
                            await characteristic.writeValue(chunk);
                            await new Promise(r => setTimeout(r, 10)); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹
                        }
                    }
                    
                } catch (e) {
                    alert("Ø®Ø·Ø£: " + e);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
                }
            }, 100);
        }

        function getImageData(c) {
            const w = c.width;
            const h = c.height;
            const ctx = c.getContext('2d');
            const imgData = ctx.getImageData(0, 0, w, h);
            
            let cmds = [0x1B, 0x40, 0x1B, 0x61, 0x01, 0x1D, 0x76, 0x30, 0x00];
            const xb = Math.ceil(w / 8);
            cmds.push(xb % 256, Math.floor(xb / 256));
            cmds.push(h % 256, Math.floor(h / 256));

            for (let y = 0; y < h; y++) {
                for (let xByte = 0; xByte < xb; xByte++) {
                    let byte = 0;
                    for (let bit = 0; bit < 8; bit++) {
                        const px = xByte * 8 + bit;
                        if (px < w) {
                            const i = (y * w + px) * 4;
                            if ((imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3 < 200) {
                                byte |= (1 << (7 - bit));
                            }
                        }
                    }
                    cmds.push(byte);
                }
            }
            
            cmds.push(0x0A, 0x0A, 0x0A); 
            cmds.push(0x1D, 0x56, 0x42, 0x00); 
            
            return new Uint8Array(cmds);
        }
    </script>
</body>
</html>