# ربط صفحة الأذونات بنظام المخزن

## التاريخ: 13 يناير 2026

## نظرة عامة
تم ربط نظام الأذونات (إذن استلام البضاعة للمندوبين) بنظام إدارة المخزن (Stock Control). عند إنشاء إذن استلام جديد، يتم تلقائياً:

1. **خصم الكميات المستلمة من المخزن**: كل صنف يستلمه المندوب يتم خصمه من رصيد المخزن
2. **إضافة المرتجعات السليمة للمخزن**: البضاعة السليمة المرتجعة تضاف تلقائياً للمخزن
3. **تسجيل المرتجعات التالفة**: البضاعة الهالكة/التالفة تسجل فقط (لا تضاف للمخزن)
4. **تسجيل جميع الحركات**: كل عملية تُسجل في سجل حركات المخزن (Transactions)
5. **التحقق من الرصيد**: يتم التأكد من توفر الكمية قبل الخصم

## التعديلات التقنية

### 1. ملف: `js/inline-scripts.js`
**الدالة المعدلة**: `addDispatchNote(data)`

#### ماذا تم إضافته:
```javascript
// معالجة كل صنف في الإذن
for (const item of base.items) {
    const quantity = item.quantity || 0;
    const goodReturn = item.goodReturn || 0;
    const damagedReturn = item.damagedReturn || 0;
    
    // حساب الرصيد الجديد:
    // - نخصم الكمية المستلمة
    // + نضيف المرتجع السليم
    // المرتجع التالف لا يضاف للمخزن
    const netChange = -quantity + goodReturn;
    const newStock = currentStock + netChange;
    
    // تسجيل حركة الخروج (إذن الاستلام)
    if (quantity > 0) {
        batch.set(transRef, {
            type: 'outbound',
            party: `إذن استلام - ${base.repName}`,
            qty: quantity
        });
    }
    
    // تسجيل حركة الدخول (المرتجع السليم)
    if (goodReturn > 0) {
        batch.set(transRef, {
            type: 'inbound',
            party: `مرتجع سليم - ${base.repName}`,
            qty: goodReturn
        });
    }
    
    // تسجيل المرتجع التالف (بدون إضافة للمخزن)
    if (damagedReturn > 0) {
        batch.set(transRef, {
            type: 'damaged',
            party: `مرتجع تالف/هالك - ${base.repName}`,
            qty: damagedReturn
        });
    }
}
```

### 2. ملف: `js/main.js`
تم تحديث رسائل الخطأ والنجاح لتعكس التكامل مع المخزن.

## كيفية الاستخدام

### للمندوب:
1. افتح صفحة "الأذونات" من القائمة الرئيسية
2. اضغط على "إضافة إذن استلام جديد"
3. أدخل:
   - رقم الإذن
   - اسم المندوب
   - التاريخ
   - لكل صنف:
     - **مستلم (كمية)**: الكمية التي يستلمها المندوب من المخزن
     - **مرتجع سليم**: الكمية السليمة التي يرجعها المندوب (تضاف للمخزن)
     - **مرتجع تالف**: الكمية الهالكة/التالفة (تسجل فقط ولا تضاف للمخزن)
     - **مجاني**: الكمية المجانية (للإحصاء فقط)
4. اضغط "حفظ الإذن الجديد"
5. سيتم تلقائياً:
   - خصم الكميات المستلمة من المخزن
   - إضافة المرتجعات السليمة للمخزن
   - تسجيل جميع الحركات في سجل المخزن

### مثال عملي:
المندوب "أحمد" في صباح اليوم:
- **يستلم**: 50 علبة حليب → تُخصم من المخزن
  
في نهاية اليوم:
- **يرجع سليم**: 10 علب → تُضاف للمخزن
- **يرجع تالف**: 2 علبة → تُسجل فقط (لا تضاف للمخزن)

النتيجة النهائية:
- صافي الخصم من المخزن = 50 - 10 = 40 علبة
- المرتجع التالف مسجل في السجلات للمتابعة

### التحقق من الحركة:
1. افتح صفحة "Stock Control V2"
2. اذهب إلى تبويب "السجلات"
3. ستجد سجل الحركات:
   - **حركة خروج (outbound)**: للكمية المستلمة
     - الجهة: "إذن استلام - [اسم المندوب]"
   - **حركة دخول (inbound)**: للمرتجع السليم
     - الجهة: "مرتجع سليم - [اسم المندوب]"
   - **حركة تالف (damaged)**: للمرتجع الهالك
     - الجهة: "مرتجع تالف/هالك - [اسم المندوب]"

## معالجة الأخطاء

### رصيد غير كافٍ:
إذا كان رصيد أي منتج في المخزن أقل من الكمية المطلوبة، سيتم:
- رفض العملية
- عرض رسالة خطأ توضح اسم المنتج والرصيد الحالي
- عدم حفظ الإذن
- عدم خصم أي كمية

### مثال على رسالة الخطأ:
```
رصيد المنتج "حليب كامل الدسم" غير كافٍ. الرصيد الحالي: 50
```

## بيانات Firestore

### مجموعة: `dispatchNotes`
تحتوي على معلومات الأصناف المستلمة والمرتجعة:
```javascript
{
  id: "auto-generated",
  noteNumber: 123,
  repName: "أحمد محمود",
  date: "2026-01-13T12:00:00Z",
  items: [
    { 
      productId: "prod_001", 
      quantity: 50,        // الكمية المستلمة
      goodReturn: 10,      // المرتجع السليم
      damagedReturn: 2,    // المرتجع التالف
      freebie: 0           // الكمية المجانية
    }
  ],
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

### مجموعة: `transactions`
يتم إنشاء سجل منفصل لكل نوع حركة:

**1. حركة الاستلام (خصم من المخزن):**
```javascript
{
  date: Timestamp,
  type: "outbound",
  productId: "prod_001",
  prodName: "حليب كامل الدسم",
  qty: 50,
  party: "إذن استلام - أحمد محمود",
  stockAfter: 450,  // كان 500، أصبح 450
  dispatchNoteId: "dispatch_123",
  dispatchNoteNumber: 123
}
```

**2. حركة المرتجع السليم (إضافة للمخزن):**
```javascript
{
  date: Timestamp,
  type: "inbound",
  productId: "prod_001",
  prodName: "حليب كامل الدسم",
  qty: 10,
  party: "مرتجع سليم - أحمد محمود",
  stockAfter: 460,  // كان 450، أصبح 460 (450 + 10)
  dispatchNoteId: "dispatch_123",
  dispatchNoteNumber: 123
}
```

**3. حركة المرتجع التالف (تسجيل فقط):**
```javascript
{
  date: Timestamp,
  type: "damaged",
  productId: "prod_001",
  prodName: "حليب كامل الدسم",
  qty: 2,
  party: "مرتجع تالف/هالك - أحمد محمود",
  stockAfter: 460,  // لا يتغير لأن التالف لا يضاف
  dispatchNoteId: "dispatch_123",
  dispatchNoteNumber: 123
}
```

### مجموعة: `products`
الرصيد النهائي بعد جميع العمليات:
```javascript
{
  id: "prod_001",
  name: "حليب كامل الدسم",
  currentStock: 460,  // 500 - 50 (استلام) + 10 (مرتجع سليم) = 460
  avgCost: 5.5,
  category: "finished_goods"
}
```

**ملاحظة**: المرتجع التالف (2 علبة) لا يؤثر على الرصيد لكنه مسجل للمتابعة والإحصاء.

## ملاحظات مهمة

1. **العملية ذرية (Atomic)**: يتم استخدام Firestore Batch لضمان أن جميع العمليات تنجح أو تفشل معاً
2. **لا رجعة**: بمجرد حفظ الإذن، يتم تطبيق جميع التغييرات فوراً على المخزن
3. **التتبع الكامل**: كل حركة مرتبطة برقم الإذن واسم المندوب
4. **التوافق العكسي**: الأذونات القديمة لن تتأثر (لم يتم خصم الكميات منها)
5. **المرتجع السليم**: يضاف تلقائياً للمخزن ويمكن إعادة بيعه
6. **المرتجع التالف**: يُسجل فقط للمتابعة ولا يضاف للمخزن (يعتبر خسارة)
7. **حساب صافي الحركة**: النظام يحسب تلقائياً: صافي الخصم = الكمية المستلمة - المرتجع السليم

## التطويرات المستقبلية المقترحة

1. إمكانية إلغاء الإذن مع إرجاع جميع الكميات للمخزن
2. تقرير بالبضاعة الموجودة مع المندوبين (صافي ما تم استلامه)
3. تقرير بالمرتجعات (سليمة وتالفة) لكل مندوب
4. تحليل نسبة التلف لكل منتج
5. إشعارات عند ارتفاع نسبة التلف
6. إمكانية تعديل الإذن قبل نهاية اليوم
7. مطابقة تلقائية بين الإذن والمبيعات الفعلية

## الدعم
في حالة وجود مشاكل أو أسئلة، يرجى التواصل مع فريق الدعم الفني.
